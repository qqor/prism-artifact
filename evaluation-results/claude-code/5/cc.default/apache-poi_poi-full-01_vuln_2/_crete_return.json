{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "sound",
  "diff": "diff --git a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\nindex 96cca3285..cb3179f22 100644\n--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -43,6 +43,51 @@ public final class POIFSDump {\n \n     private POIFSDump() {}\n \n+    /**\n+     * Sanitizes a file name to prevent path traversal attacks.\n+     * Removes any path separator characters and prevents use of \"..\" sequences.\n+     *\n+     * @param fileName the original file name from the OLE2 entry\n+     * @return a sanitized file name safe for use in file operations\n+     */\n+    private static String sanitizeFileName(String fileName) {\n+        if (fileName == null || fileName.isEmpty()) {\n+            return \"unnamed\";\n+        }\n+        // Replace path separators and remove \"..\" to prevent path traversal\n+        String sanitized = fileName.replace('/', '_')\n+                                   .replace('\\\\', '_')\n+                                   .replace(\"..\", \"__\");\n+        // Also trim and handle edge cases\n+        sanitized = sanitized.trim();\n+        if (sanitized.isEmpty() || sanitized.equals(\".\") || sanitized.equals(\"..\")) {\n+            return \"unnamed\";\n+        }\n+        return sanitized;\n+    }\n+\n+    /**\n+     * Creates a safe file within the parent directory, validating that the resulting\n+     * path does not escape the parent directory through path traversal.\n+     *\n+     * @param parent the parent directory\n+     * @param fileName the file name to use (will be sanitized)\n+     * @return a File object guaranteed to be within the parent directory\n+     * @throws IOException if the resulting path would escape the parent directory\n+     */\n+    private static File createSafeFile(File parent, String fileName) throws IOException {\n+        String safeName = sanitizeFileName(fileName);\n+        File file = new File(parent, safeName);\n+        // Verify the canonical path is still within the parent directory\n+        String parentCanonical = parent.getCanonicalPath();\n+        String fileCanonical = file.getCanonicalPath();\n+        if (!fileCanonical.startsWith(parentCanonical + File.separator) &&\n+            !fileCanonical.equals(parentCanonical)) {\n+            throw new IOException(\"Path traversal attempt detected: \" + fileName);\n+        }\n+        return file;\n+    }\n+\n     public static void main(String[] args) throws IOException {\n         if (args.length == 0) {\n             System.err.println(\"Must specify at least one file to dump\");\n@@ -105,12 +150,12 @@ public final class POIFSDump {\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                try (OutputStream out = Files.newOutputStream(createSafeFile(parent, node.getName()).toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                File file = createSafeFile(parent, entry.getName());\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n",
  "stdout": "",
  "stderr": ""
}