diff --git a/src/liblzma/check/treeck.c b/src/liblzma/check/treeck.c
index f54d244e..9304f3d8 100644
--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -78,16 +78,16 @@ static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
     node->state = STATE_VISITED;
     for (size_t i = 0; i < node->edge_count; ++i) {
       TreeNode *child = node->edges[i];
-      if (child) {
+      if (child && child->state == STATE_CLEAR) {
         sum += compute_tree_checksum(child, depth + 1);
       }
     }
     node->state = STATE_HASHED;
-  }
 
-  // Free the node and edges
-  free(node->edges);
-  free(node);
+    // Free the node and edges only after fully processing
+    free(node->edges);
+    free(node);
+  }
 
   return sum;
 }
