diff --git a/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java b/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
index 67beb2120..9e74d5c82 100644
--- a/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
+++ b/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
@@ -1024,10 +1024,14 @@ public final class EscherAggregate extends AbstractEscherHolderRecord {
         }
 
         // Decode the shapes
-        Iterator<EscherRecord> shapeIter = recordFactory.parse(agg).iterator();
+        List<EscherRecord> shapesList = recordFactory.parse(agg);
 
         // Associate the object records with the shapes
-        objectRecords.forEach(or -> agg.shapeToObj.put(shapeIter.next(), or));
+        // Only create mappings for valid pairs to prevent inconsistent state
+        int pairCount = Math.min(shapesList.size(), objectRecords.size());
+        for (int i = 0; i < pairCount; i++) {
+            agg.shapeToObj.put(shapesList.get(i), objectRecords.get(i));
+        }
 
         return agg;
     }
@@ -1110,15 +1114,16 @@ public final class EscherAggregate extends AbstractEscherHolderRecord {
             endOffset = spEndingOffsets.get(i);
 
             byte[] drawingData = Arrays.copyOfRange(buffer, startOffset, endOffset);
-            pos += writeDataIntoDrawingRecord(drawingData, writtenEscherBytes, pos, data, isFirst);
-
-            writtenEscherBytes += drawingData.length;
 
-            // Write the matching OBJ record
-            Record obj = shapeToObj.get(shapes.get(i));
-            pos += obj.serialize(pos, data);
-
-            isFirst = false;
+            // Only write shape data if we have a corresponding object record
+            EscherRecord shape = shapes.get(i);
+            Record obj = shapeToObj.get(shape);
+            if (obj != null) {
+                pos += writeDataIntoDrawingRecord(drawingData, writtenEscherBytes, pos, data, isFirst);
+                writtenEscherBytes += drawingData.length;
+                pos += obj.serialize(pos, data);
+                isFirst = false;
+            }
         }
 
         if (endOffset < buffer.length - 1) {
