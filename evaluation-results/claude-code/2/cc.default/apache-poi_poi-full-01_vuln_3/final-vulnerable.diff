diff --git a/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java b/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
index 67beb2120..79f1a0136 100644
--- a/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
+++ b/poi/src/main/java/org/apache/poi/hssf/record/EscherAggregate.java
@@ -1027,7 +1027,12 @@ public final class EscherAggregate extends AbstractEscherHolderRecord {
         Iterator<EscherRecord> shapeIter = recordFactory.parse(agg).iterator();
 
         // Associate the object records with the shapes
-        objectRecords.forEach(or -> agg.shapeToObj.put(shapeIter.next(), or));
+        objectRecords.forEach(or -> {
+            if (shapeIter.hasNext()) {
+                agg.shapeToObj.put(shapeIter.next(), or);
+            }
+            // Skip if no more shapes available to avoid NoSuchElementException
+        });
 
         return agg;
     }
@@ -1115,8 +1120,13 @@ public final class EscherAggregate extends AbstractEscherHolderRecord {
             writtenEscherBytes += drawingData.length;
 
             // Write the matching OBJ record
-            Record obj = shapeToObj.get(shapes.get(i));
-            pos += obj.serialize(pos, data);
+            EscherRecord shape = shapes.get(i);
+            Record obj = shapeToObj.get(shape);
+            if (obj != null) {
+                pos += obj.serialize(pos, data);
+            }
+            // Skip serialization if no matching object record exists
+            // This prevents NullPointerException when processing malformed files
 
             isFirst = false;
         }
