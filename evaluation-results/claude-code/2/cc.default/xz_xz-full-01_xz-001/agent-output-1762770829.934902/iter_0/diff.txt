diff --git a/src/liblzma/check/treeck.c b/src/liblzma/check/treeck.c
index f54d244e..9794721a 100644
--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -62,6 +62,25 @@ static TreeNode* create_tree(const uint8_t *data, size_t len, size_t depth, size
   return node;
 }
 
+// Free the tree structure after checksum computation
+static void free_tree(TreeNode *node)
+{
+  if (!node || node->state != STATE_HASHED) {
+    return;
+  }
+
+  // Mark as freed to avoid double-free
+  node->state = STATE_CLEAR;
+
+  // Free children first
+  for (size_t i = 0; i < node->edge_count; ++i) {
+    free_tree(node->edges[i]);
+  }
+
+  free(node->edges);
+  free(node);
+}
+
 // Walk the tree to calculate the e37vk checksum
 static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
 {
@@ -85,10 +104,6 @@ static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
     node->state = STATE_HASHED;
   }
 
-  // Free the node and edges
-  free(node->edges);
-  free(node);
-
   return sum;
 }
 
@@ -98,6 +113,7 @@ lzma_tree(const uint8_t *buf, size_t size, uint32_t checksum)
   unsigned long seed = hash_data(buf, size);
   TreeNode *root = create_tree(buf, size, 0, 16, seed, NULL);
   checksum ^= compute_tree_checksum(root, 0);
+  free_tree(root);
   return checksum;
 }
 
