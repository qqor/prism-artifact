
================================================================================
Response 1
================================================================================
The crash is related to a regex pattern causing stack overflow in Java's `Pattern.Loop.match`. Let me look at the crash reproducer to understand what fuzzer is involved, and search for problematic regex patterns in the source code.

================================================================================
Response 2
================================================================================
The stack trace suggests the regex issue involves `Pattern$Loop`, `Pattern$Ques`, `Pattern$GroupHead`, and `Pattern$GroupTail`, which are typical for patterns with loops/repetitions like `(a?)*` or similar. Let me look at the specific patterns used in the POI codebase:

================================================================================
Response 3
================================================================================
Let me look at the CellFormatPart.java file which seems to have complex regex patterns for formatting:

================================================================================
Response 4
================================================================================
This file contains complex regex patterns. Looking at the `part` pattern on line 121-138, I can see it has `[^;]` which is a catch-all. The key issue is in the `format` pattern (line 140-145) where `((?:" + part + ")+)` creates a pattern with repetition that causes the stack overflow.

Let me also check the `CellFormat.java` which uses `ONE_PART` pattern:

================================================================================
Response 5
================================================================================
I can see the issue. In `CellFormat.java`, lines 199-206 already handle `StackOverflowError`, but the issue is that the regex pattern itself is causing the stack overflow in lines 185-198 during `m.find()`.

The root cause is in the `FORMAT_PAT` pattern from `CellFormatPart.java`. The pattern has nested repetition which causes catastrophic backtracking. Looking at line 145:
```java
"((?:" + part + ")+)                        # Format spec\n";
```

The `part` pattern (line 121-138) contains alternatives that match single characters like `[^;]`, and this is combined with the `+` repetition in the format pattern, which creates a problematic pattern that can cause exponential backtracking.

Let me check what the exact regex pattern looks like:

================================================================================
Response 6
================================================================================
Let me look at the directory structure to determine the source directory:

================================================================================
Response 7
================================================================================
Now I understand the structure. The issue is in the `CellFormat.java` file's `ONE_PART` regex pattern which uses `CellFormatPart.FORMAT_PAT`. The pattern involves nested quantifiers that can cause catastrophic backtracking (ReDoS vulnerability).

The fix needs to:
1. Add input length validation to prevent extremely long format strings from being processed
2. Add a timeout or limit to prevent the regex from running indefinitely

Let me create the fix. The best approach is to add a maximum input length check before the regex matching is performed:

================================================================================
Response 8
================================================================================
Now I understand the problem clearly. The issue is:
1. The `ONE_PART` pattern (line 98-100) is a complex regex pattern that can cause stack overflow
2. There's already a catch for `StackOverflowError` (lines 199-206), but it doesn't prevent the actual crash - it just re-throws it as an `IllegalStateException`

The fix should add input validation **before** the regex matching to prevent the stack overflow from happening in the first place. The best fix is to add a maximum format string length limit.

Let me apply the fix:

================================================================================
Response 9
================================================================================
Now let me add the validation check in the constructor:

================================================================================
Response 10
================================================================================
Now I need to also add similar protection in `CellFormatPart.java` since it's also using regex matching. Let me check that file again and add the fix:

================================================================================
Response 11
================================================================================
Now let me add the same protection to `CellFormatPart.java`:

================================================================================
Response 12
================================================================================
Now I also need to add protection to the `parseFormat` method and the `formatType` method in `CellFormatPart.java` which also use regex patterns:

================================================================================
Response 13
================================================================================
Now let me add the length check to the `parseFormat` static method:

================================================================================
Response 14
================================================================================
The fix has been applied. Let me verify the changes by reading the modified files:

================================================================================
Response 15
================================================================================
The patch has been successfully applied. Let me provide a summary of the changes made:

## Summary of the Fix

The stack overflow bug was caused by a **ReDoS (Regular Expression Denial of Service)** vulnerability in the `CellFormat` and `CellFormatPart` classes. The complex regex patterns used for parsing Excel cell format strings can cause catastrophic backtracking when processing maliciously crafted or extremely long format strings.

### Files Modified:

1. **`poi/src/main/java/org/apache/poi/ss/format/CellFormat.java`**
   - Added `MAX_FORMAT_LENGTH` constant (4096 characters)
   - Added input length validation in the `CellFormat` constructor to reject format strings that exceed the maximum length

2. **`poi/src/main/java/org/apache/poi/ss/format/CellFormatPart.java`**
   - Added `MAX_FORMAT_LENGTH` constant (4096 characters)
   - Added input length validation in the `CellFormatPart(Locale, String)` constructor
   - Added input length validation in the `parseFormat()` static method

### How the Fix Works:

Before processing format strings with the complex regex patterns (`FORMAT_PAT`, `SPECIFICATION_PAT`, `ONE_PART`), the code now checks if the input string exceeds 4096 characters. If it does, an `IllegalArgumentException` is thrown with a descriptive error message instead of attempting to match the pattern, which prevents the stack overflow from occurring.

The limit of 4096 characters is a reasonable choice because:
- Standard Excel format strings are typically very short (tens of characters)
- Even complex custom formats rarely exceed a few hundred characters
- This limit effectively prevents the exponential backtracking that causes the stack overflow
