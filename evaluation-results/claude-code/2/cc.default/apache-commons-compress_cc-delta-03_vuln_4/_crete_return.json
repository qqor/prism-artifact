{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-03_vuln_4",
  "source_directory": "/home/user/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "vulnerable",
  "diff": "diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java\nindex 3b2b5be88..bad16778e 100644\n--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java\n@@ -47,6 +47,12 @@ public class TarUtils {\n \n     private static final int BYTE_MASK = 255;\n \n+    /**\n+     * Maximum length value for PAX header entries to prevent integer overflow and potential DoS.\n+     * This is a reasonable upper bound for header entry length (100MB).\n+     */\n+    private static final int MAX_PAX_HEADER_ENTRY_LENGTH = 100 * 1024 * 1024;\n+\n     static final ZipEncoding DEFAULT_ENCODING = ZipEncodingHelper.getZipEncoding(Charset.defaultCharset());\n \n     /**\n@@ -645,12 +651,15 @@ protected static Map<String, String> parsePaxHeaders(final InputStream inputStre\n         final Map<String, String> headers = new HashMap<>(globalPaxHeaders);\n         Long offset = null;\n         // Format is \"length keyword=value\\n\";\n-        int totalRead = 0;\n+        long totalRead = 0;\n         while (true) { // get length\n             int ch;\n-            int len = 0;\n-            int read = 0;\n+            long len = 0;\n+            long read = 0;\n             while ((ch = inputStream.read()) != -1) {\n+                if (totalRead < 0 || headerSize >= 0 && totalRead >= headerSize) {\n+                    break;\n+                }\n                 read++;\n                 totalRead++;\n                 if (ch == '\\n') { // blank line in header\n@@ -668,7 +677,14 @@ protected static Map<String, String> parsePaxHeaders(final InputStream inputStre\n                         if (ch == '=') { // end of keyword\n                             final String keyword = coll.toString(StandardCharsets.UTF_8);\n                             // Get rest of entry\n-                            final int restLen = len - read;\n+                            final long restLenLong = len - read;\n+                            if (restLenLong < 0) {\n+                                throw new IOException(\"Failed to read Paxheader. Invalid length calculation\");\n+                            }\n+                            if (restLenLong > Integer.MAX_VALUE) {\n+                                throw new IOException(\"Failed to read Paxheader. Value length \" + restLenLong + \" exceeds maximum\");\n+                            }\n+                            final int restLen = (int) restLenLong;\n                             if (restLen <= 1) { // only NL\n                                 headers.remove(keyword);\n                             } else if (headerSize >= 0 && restLen > headerSize - totalRead) {\n@@ -729,6 +745,12 @@ protected static Map<String, String> parsePaxHeaders(final InputStream inputStre\n                 }\n                 len *= 10;\n                 len += ch - '0';\n+                // Prevent integer overflow and potential DoS from malicious headers\n+                if (len < 0 || len > MAX_PAX_HEADER_ENTRY_LENGTH) {\n+                    throw new IOException(\"Failed to read Paxheader. Length \" + len +\n+                        \" exceeds maximum allowed value of \" + MAX_PAX_HEADER_ENTRY_LENGTH +\n+                        \" or caused overflow\");\n+                }\n             }\n             if (ch == -1) { // EOF\n                 break;\n",
  "stdout": "+ FUZZER=CompressTarFuzzer\r\n+ shift\r\n+ '[' '!' -v TESTCASE ']'\r\n+ TESTCASE=/testcase\r\n+ '[' '!' -f /testcase ']'\r\n+ export RUN_FUZZER_MODE=interactive\r\n+ RUN_FUZZER_MODE=interactive\r\n+ export FUZZING_ENGINE=libfuzzer\r\n+ FUZZING_ENGINE=libfuzzer\r\n+ export SKIP_SEED_CORPUS=1\r\n+ SKIP_SEED_CORPUS=1\r\n+ run_fuzzer CompressTarFuzzer -runs=100 /testcase\r\nvm.mmap_rnd_bits = 28\r\n/out/CompressTarFuzzer -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase < /dev/null\r\nOpenJDK 64-Bit Server VM warning: Option CriticalJNINatives was deprecated in version 16.0 and will likely be removed in a future release.\r\nOpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended\r\nINFO: Loaded 273 hooks from com.code_intelligence.jazzer.runtime.TraceCmpHooks\r\nINFO: Loaded 5 hooks from com.code_intelligence.jazzer.runtime.TraceDivHooks\r\nINFO: Loaded 2 hooks from com.code_intelligence.jazzer.runtime.TraceIndirHooks\r\nINFO: Loaded 4 hooks from com.code_intelligence.jazzer.runtime.NativeLibHooks\r\nINFO: Loaded 2 hooks from com.code_intelligence.jazzer.sanitizers.ClojureLangHooks\r\nINFO: Loaded 5 hooks from com.code_intelligence.jazzer.sanitizers.Deserialization\r\nINFO: Loaded 5 hooks from com.code_intelligence.jazzer.sanitizers.ExpressionLanguageInjection\r\nINFO: Loaded 32 hooks from com.code_intelligence.jazzer.sanitizers.FilePathTraversal\r\nINFO: Loaded 70 hooks from com.code_intelligence.jazzer.sanitizers.LdapInjection\r\nINFO: Loaded 46 hooks from com.code_intelligence.jazzer.sanitizers.NamingContextLookup\r\nINFO: Loaded 1 hooks from com.code_intelligence.jazzer.sanitizers.OsCommandInjection\r\nINFO: Loaded 48 hooks from com.code_intelligence.jazzer.sanitizers.ReflectiveCall\r\nINFO: Loaded 8 hooks from com.code_intelligence.jazzer.sanitizers.RegexInjection\r\nINFO: Loaded 16 hooks from com.code_intelligence.jazzer.sanitizers.RegexRoadblocks\r\nINFO: Loaded 12 hooks from com.code_intelligence.jazzer.sanitizers.ScriptEngineInjection\r\nINFO: Loaded 3 hooks from com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery\r\nINFO: Loaded 19 hooks from com.code_intelligence.jazzer.sanitizers.SqlInjection\r\nINFO: Loaded 6 hooks from com.code_intelligence.jazzer.sanitizers.XPathInjection\r\nINFO: Instrumented CompressTarFuzzer (took 39 ms, size +26%)\r\nINFO: Instrumented BaseTests (took 5 ms, size +11%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.ArchiveInputStream (took 11 ms, size +9%)\r\nINFO: Instrumented org.apache.commons.compress.compressors.CompressorInputStream (took 3 ms, size +23%)\r\nINFO: using inputs from: /testcase\r\nINFO: found LLVMFuzzerCustomMutator (0x7f68be6f3a00). Disabling -len_control by default.\r\nINFO: libFuzzer ignores flags that start with '--'\r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 1019899476\r\nINFO: Loaded 1 modules   (512 inline 8-bit counters): 512 [0x5642f2589900, 0x5642f2589b00), \r\nINFO: Loaded 1 PC tables (512 PCs): 512 [0x5642f25569d0,0x5642f25589d0), \r\njazzer: Running 1 inputs 100 time(s) each.\r\nRunning: /testcase\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarFile (took 26 ms, size +20%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarFile$BoundedTarEntryInputStream (took 4 ms, size +25%)\r\nINFO: Instrumented org.apache.commons.compress.utils.BoundedArchiveInputStream (took 2 ms, size +25%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarArchiveSparseZeroInputStream (took 1 ms, size +19%)\r\nINFO: Instrumented org.apache.commons.compress.utils.SeekableInMemoryByteChannel (took 6 ms, size +23%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.zip.ZipEncodingHelper (took 4 ms, size +21%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.zip.ZipEncoding (took 0 ms, size +0%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.zip.NioZipEncoding (took 6 ms, size +15%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.zip.CharsetAccessor (took 0 ms, size +0%)\r\nINFO: Instrumented org.apache.commons.io.Charsets (took 3 ms, size +8%)\r\nINFO: New number of coverage counters: 1024\r\nINFO: Instrumented org.apache.commons.compress.utils.ArchiveUtils (took 7 ms, size +26%)\r\nINFO: New number of coverage counters: 2048\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarArchiveEntry (took 50 ms, size +32%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.ArchiveEntry (took 1 ms, size +20%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarConstants (took 0 ms, size +0%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.EntryStreamOffsets (took 0 ms, size +0%)\r\nINFO: Instrumented org.apache.commons.compress.utils.IOUtils (took 5 ms, size +18%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarUtils (took 13 ms, size +21%)\r\nINFO: Instrumented org.apache.commons.compress.archivers.tar.TarUtils$1 (took 1 ms, size +21%)\r\nINFO: Instrumented org.apache.commons.io.file.attribute.FileTimes (took 4 ms, size +13%)\r\nINFO: Instrumented org.apache.commons.io.output.ByteArrayOutputStream (took 3 ms, size +14%)\r\nINFO: Instrumented org.apache.commons.io.output.AbstractByteArrayOutputStream (took 4 ms, size +15%)\r\nINFO: Instrumented org.apache.commons.io.input.ClosedInputStream (took 1 ms, size +9%)\r\nINFO: New number of coverage counters: 4096\r\nINFO: Instrumented org.apache.commons.io.IOUtils (took 40 ms, size +13%)\r\nINFO: Instrumented org.apache.commons.io.output.StringBuilderWriter (took 3 ms, size +9%)\r\nINFO: Instrumented org.apache.commons.io.output.AppendableWriter (took 2 ms, size +12%)\r\nINFO: Instrumented org.apache.commons.io.output.ThresholdingOutputStream (took 3 ms, size +11%)\r\nINFO: Instrumented org.apache.commons.io.CloseableURLConnection (took 8 ms, size +11%)\r\nINFO: Instrumented org.apache.commons.io.output.QueueOutputStream (took 1 ms, size +6%)\r\nINFO: Instrumented org.apache.commons.io.output.NullWriter (took 2 ms, size +8%)\r\nINFO: Instrumented org.apache.commons.io.output.NullOutputStream (took 1 ms, size +12%)\r\nINFO: Instrumented org.apache.commons.io.output.UnsynchronizedByteArrayOutputStream (took 4 ms, size +10%)\r\nINFO: Instrumented org.apache.commons.io.input.CharSequenceReader (took 3 ms, size +18%)\r\nINFO: Instrumented org.apache.commons.io.StandardLineSeparator (took 1 ms, size +9%)\r\nALARM: working on the last Unit for 25 seconds\r\n       and the timeout value is 25 (use -timeout=N to change)\r\n==16== ERROR: libFuzzer: timeout after 25 seconds\r\n\r\nStack traces of all JVM threads:\r\nThread[Notification Thread,9,system]\r\n\r\nThread[Common-Cleaner,8,InnocuousThreadGroup]\r\n\tat java.base@17.0.2/java.lang.Object.wait(Native Method)\r\n\tat java.base@17.0.2/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:155)\r\n\tat java.base@17.0.2/jdk.internal.ref.CleanerImpl.run(CleanerImpl.java:140)\r\n\tat java.base@17.0.2/java.lang.Thread.run(Thread.java:833)\r\n\tat java.base@17.0.2/jdk.internal.misc.InnocuousThread.run(InnocuousThread.java:162)\r\n\r\nThread[Attach Listener,9,system]\r\n\r\nThread[Reference Handler,10,system]\r\n\tat java.base@17.0.2/java.lang.ref.Reference.waitForReferencePendingList(Native Method)\r\n\tat java.base@17.0.2/java.lang.ref.Reference.processPendingReferences(Reference.java:253)\r\n\tat java.base@17.0.2/java.lang.ref.Reference$ReferenceHandler.run(Reference.java:215)\r\n\r\nThread[Finalizer,8,system]\r\n\tat java.base@17.0.2/java.lang.Object.wait(Native Method)\r\n\tat java.base@17.0.2/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:155)\r\n\tat java.base@17.0.2/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:176)\r\n\tat java.base@17.0.2/java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:172)\r\n\r\nThread[Signal Dispatcher,9,system]\r\n\r\nThread[process reaper,10,system]\r\n\tat java.base@17.0.2/jdk.internal.misc.Unsafe.park(Native Method)\r\n\tat java.base@17.0.2/java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:252)\r\n\tat java.base@17.0.2/java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:401)\r\n\tat java.base@17.0.2/java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:903)\r\n\tat java.base@17.0.2/java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1061)\r\n\tat java.base@17.0.2/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1122)\r\n\tat java.base@17.0.2/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base@17.0.2/java.lang.Thread.run(Thread.java:833)\r\n\r\nThread[main,5,main]\r\n\tat app//com.code_intelligence.jazzer.driver.FuzzTargetRunner.dumpAllStackTraces(FuzzTargetRunner.java:534)\r\n\r\nGarbage collector stats:\r\n\r\nPS MarkSweep: 0 collections took 0ms\r\nPS Scavenge: 16 collections took 91ms\r\n\r\nSUMMARY: libFuzzer: timeout\r\nsubprocess command returned a non-zero exit status: 70\n",
  "stderr": "INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64 -v /home/user/crete/packages/python_oss_fuzz/.oss_fuzz/build/out/apache-commons-compress:/out -v /tmp/tmpmsihwff1:/testcase -t ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce CompressTarFuzzer -runs=100.\n"
}