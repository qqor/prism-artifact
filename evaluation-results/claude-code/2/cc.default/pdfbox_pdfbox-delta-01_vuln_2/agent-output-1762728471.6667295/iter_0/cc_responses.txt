
================================================================================
Response 1
================================================================================
I'll analyze the crash log and create a patch to fix the OS Command Injection vulnerability in the PDFBox OCR code.

Let me start by exploring the codebase to understand the structure and locate the vulnerable file.

================================================================================
Response 2
================================================================================
Now let me read the vulnerable OCRStreamEngine.java file to understand the issue:

================================================================================
Response 3
================================================================================
Now I can see the issue. The vulnerability is in the `runTesseract` method (lines 157-167) where it gets the tesseract path from PDF document metadata without validation. This allows an attacker to inject malicious commands through the `TESSERACT_PATH_KEY` custom metadata value.

The issue is on lines 158-162:
```java
String actualTessPath = pdDocument.getDocumentInformation()
        .getCustomMetadataValue(TESSERACT_PATH_KEY);
if (actualTessPath == null || actualTessPath.isEmpty()) {
    actualTessPath = tesseractPath;
}
```

This attacker-controlled value is then passed directly to `ProcessBuilder` in the `doOCR` method (line 182), allowing command injection.

Let me create a patch to fix this by validating the tesseract path:

================================================================================
Response 4
================================================================================
Perfect! Now let me verify the fix is correct by reading the updated section:

================================================================================
Response 5
================================================================================
Excellent! The patch has been successfully applied. Let me create a summary of what was fixed:

## Summary

I've successfully created and applied a patch to fix the **OS Command Injection** vulnerability in the PDFBox OCR code.

### Vulnerability Analysis

The vulnerability was in the `runTesseract()` method at lines 158-162 of `OCRStreamEngine.java`. The code was reading the tesseract executable path from PDF document metadata using:

```java
String actualTessPath = pdDocument.getDocumentInformation()
        .getCustomMetadataValue(TESSERACT_PATH_KEY);
```

This allowed an attacker to embed a malicious command in the PDF document's custom metadata field (`tesseract-path`), which would then be executed when `ProcessBuilder` started the process at line 190.

### Fix Applied

The fix removes the dangerous code path that reads from document metadata and only uses the pre-configured `tesseractPath` field:

```java
// Don't use tesseract path from document metadata to prevent command injection
// Only use the configured tesseractPath field
String actualTessPath = tesseractPath;
```

This ensures that:
1. The tesseract path can only be set through the secure `setTesseractPath()` method (line 58-60)
2. Attacker-controlled PDF metadata cannot influence command execution
3. The default value is "tesseract" (line 38), which relies on the system PATH

### File Modified
- `/home/qqor/crete/.cache/official-afc-pdfbox/pdfbox/src/main/java/org/apache/pdfbox/ocr/OCRStreamEngine.java`

The patch successfully prevents OS Command Injection attacks while maintaining the intended functionality of the OCR engine.
