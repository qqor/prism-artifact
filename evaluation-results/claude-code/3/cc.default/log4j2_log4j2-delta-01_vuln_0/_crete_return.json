{
  "project_name": "log4j2",
  "vulnerability_identifier": "log4j2_log4j2-delta-01_vuln_0",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-logging-log4j2",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "sound",
  "diff": "diff --git a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\nindex 90e082a9f..f46a42a79 100644\n--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n@@ -55,6 +55,12 @@ public class JndiLookup implements StrLookup {\n             return null;\n         }\n \n+        // Security fix: Only allow local JNDI lookups (java: protocol)\n+        // Block remote JNDI lookups to prevent RCE vulnerabilities\n+        if (!isAllowedJndiProtocol(key)) {\n+            return null;\n+        }\n+\n         try {\n             InitialContext ctx = new InitialContext();\n             return (String) ctx.lookup(convertJndiName(key));\n@@ -63,6 +69,59 @@ public class JndiLookup implements StrLookup {\n         }\n     }\n \n+    /**\n+     * Validates that the JNDI name uses an allowed protocol.\n+     * Only local java: protocol is allowed to prevent remote code execution.\n+     *\n+     * @param jndiName The JNDI name to validate\n+     * @return true if the protocol is allowed, false otherwise\n+     */\n+    private boolean isAllowedJndiProtocol(String jndiName) {\n+        if (jndiName == null || jndiName.isEmpty()) {\n+            return false;\n+        }\n+\n+        // Convert the name first to see what the actual lookup will be\n+        String convertedName = convertJndiNameForValidation(jndiName);\n+\n+        // Only allow java: protocol (local JNDI lookups)\n+        // Block remote protocols: ldap://, ldaps://, rmi://, dns://, iiop://, corbaname:, etc.\n+        if (convertedName.startsWith(\"java:\")) {\n+            return true;\n+        }\n+\n+        // Check for dangerous remote protocols\n+        String lowerName = convertedName.toLowerCase();\n+        if (lowerName.startsWith(\"ldap:\") || lowerName.startsWith(\"ldaps:\") ||\n+            lowerName.startsWith(\"rmi:\") || lowerName.startsWith(\"dns:\") ||\n+            lowerName.startsWith(\"iiop:\") || lowerName.startsWith(\"corbaname:\") ||\n+            lowerName.startsWith(\"nds:\") || lowerName.startsWith(\"nis:\")) {\n+            return false;\n+        }\n+\n+        // If no protocol is specified and doesn't start with java:comp/env/,\n+        // it will be prefixed with java:comp/env/ which is safe\n+        if (convertedName.indexOf(':') == -1) {\n+            return true;\n+        }\n+\n+        // Block anything else with a protocol that we haven't explicitly allowed\n+        return false;\n+    }\n+\n+    /**\n+     * Convert the given JNDI name to the actual JNDI name to use (for validation).\n+     * This mirrors convertJndiName logic but is used for security validation.\n+     * @param jndiName The name of the resource.\n+     * @return The fully qualified name that will be looked up.\n+     */\n+    private String convertJndiNameForValidation(String jndiName) {\n+        if (!jndiName.startsWith(CONTAINER_JNDI_RESOURCE_PATH_PREFIX) && jndiName.indexOf(':') == -1) {\n+            return CONTAINER_JNDI_RESOURCE_PATH_PREFIX + jndiName;\n+        }\n+        return jndiName;\n+    }\n+\n     /**\n      * Convert the given JNDI name to the actual JNDI name to use.\n      * Default implementation applies the \"java:comp/env/\" prefix\n",
  "stdout": "",
  "stderr": ""
}