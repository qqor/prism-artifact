diff --git a/src/net_builtin.c b/src/net_builtin.c
index 793874f4..15e7ff04 100644
--- a/src/net_builtin.c
+++ b/src/net_builtin.c
@@ -800,6 +800,7 @@ static void rx_ip(struct mg_tcpip_if *ifp, struct pkt *pkt) {
     if (c) mg_error(c, "Received fragmented packet");
   } else if (pkt->ip->proto == 1) {
     pkt->icmp = (struct icmp *) (pkt->ip + 1);
+    if ((char *)(pkt->icmp + 1) > (char *)(pkt->raw.buf + pkt->raw.len)) return;
     if (pkt->pay.len < sizeof(*pkt->icmp)) return;
     mkpay(pkt, pkt->icmp + 1);
     rx_icmp(ifp, pkt);
