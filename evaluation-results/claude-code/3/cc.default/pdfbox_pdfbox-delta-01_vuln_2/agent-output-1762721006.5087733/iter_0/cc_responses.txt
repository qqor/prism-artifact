
================================================================================
Response 1
================================================================================
I'll analyze the crash log and create a patch to fix the OS Command Injection vulnerability in the Apache PDFBox OCR code.

Let me start by exploring the source directory to understand the structure and locate the vulnerable file.

================================================================================
Response 2
================================================================================
Now let me read the vulnerable OCRStreamEngine.java file:

================================================================================
Response 3
================================================================================
Now I can see the vulnerability. The issue is on lines 158-162 and 178-196. The code reads the tesseract path from PDF document metadata (`TESSERACT_PATH_KEY`) without any validation, which allows an attacker to inject arbitrary commands. This value is then directly used in `ProcessBuilder` on line 185, leading to OS command injection.

Let me create a patch to fix this vulnerability:

================================================================================
Response 4
================================================================================
Perfect! Now let me verify the fix is correct by reading the updated section:

================================================================================
Response 5
================================================================================
Excellent! The patch has been successfully applied. Let me create a summary of the changes:

## Summary

I've successfully created and applied a patch to fix the **OS Command Injection** vulnerability in the Apache PDFBox OCR code.

### Vulnerability Details
The vulnerability was located in the `OCRStreamEngine.java` file, specifically in the `runTesseract()` method (lines 157-165). The original code read the tesseract executable path from PDF document metadata without any validation:

```java
String actualTessPath = pdDocument.getDocumentInformation()
        .getCustomMetadataValue(TESSERACT_PATH_KEY);
```

This allowed an attacker to inject malicious commands through crafted PDF metadata, which would then be executed when `ProcessBuilder` started the process.

### Fix Applied
The patch removes the ability to read the tesseract path from document metadata entirely. Now the code only uses the configured `tesseractPath` field, which is controlled by the application and not by untrusted PDF input:

```java
// Only use the configured tesseract path, never from document metadata
// to prevent OS command injection attacks
String actualTessPath = tesseractPath;
```

### Impact
This fix prevents attackers from:
- Injecting arbitrary OS commands through PDF metadata
- Executing malicious code on the system processing PDFs
- Achieving remote code execution via crafted PDF files

The patch maintains the intended functionality while completely eliminating the command injection attack vector by ensuring that only application-controlled paths are used for executing the tesseract OCR tool.
