{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-07_vuln_8",
  "source_directory": "/home/user/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "sound",
  "diff": "diff --git a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\nindex 30649f530..f39ffb814 100644\n--- a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n@@ -471,33 +471,42 @@ public void expand(final ZipFile archive, final Path targetDirectory) throws IOE\n         if (! Files.isDirectory(targetDirectory)) {\n             Files.createDirectories(targetDirectory);\n         }\n+        final Path normalizedTargetDir = targetDirectory.toAbsolutePath().normalize();\n         final Enumeration<ZipArchiveEntry> entries = archive.getEntries();\n         while (entries.hasMoreElements()) {\n             ZipArchiveEntry zae = entries.nextElement();\n             if (zae.isUnixSymlink()) {\n                 String targetName = IOUtils.toString(archive.getInputStream(zae),\n                         StandardCharsets.UTF_8);\n-                Path link = targetDirectory.resolve(zae.getName());\n-                Path target = targetDirectory.resolve(targetName);\n-                Path parent = createParentDirectory(targetDirectory, link);\n-\n-                if (!Files.isSameFile(link.getParent(), parent)) {\n-                    link = parent.relativize(link.getFileName()).normalize();\n+                Path link = targetDirectory.resolve(zae.getName()).normalize();\n+                // Validate symlink location is within target directory\n+                if (!link.toAbsolutePath().normalize().startsWith(normalizedTargetDir)) {\n+                    throw new IOException(String.format(\"Zip slip '%s' + '%s' -> '%s'\",\n+                            targetDirectory, zae.getName(), link));\n                 }\n-                if (!Files.isRegularFile(link) && !Files.isSymbolicLink(link)) {\n-                    Files.createSymbolicLink(link, target);\n+                Path parent = createParentDirectory(normalizedTargetDir, link);\n+\n+                Path finalLink = parent.resolve(link.getFileName());\n+                if (!Files.isRegularFile(finalLink) && !Files.isSymbolicLink(finalLink)) {\n+                    // Create symlink with the target as a relative path (don't resolve against targetDirectory)\n+                    Files.createSymbolicLink(finalLink, java.nio.file.Paths.get(targetName));\n                 }\n             } else if (! zae.isDirectory()) {\n                 Path target = targetDirectory.resolve(zae.getName()).normalize();\n-                if (!target.startsWith(targetDirectory)) {\n+                if (!target.toAbsolutePath().normalize().startsWith(normalizedTargetDir)) {\n                     throw new IOException(String.format(\"Zip slip '%s' + '%s' -> '%s'\",\n                             targetDirectory, zae.getName(), target));\n                 }\n-                Path parent = createParentDirectory(targetDirectory, target);\n+                Path parent = createParentDirectory(normalizedTargetDir, target);\n                 if (! target.getParent().toAbsolutePath().normalize().equals(\n                         parent.toAbsolutePath().normalize())) {\n                     target = parent.normalize().resolve(target.getFileName());\n                 }\n+                // Final validation after parent directory creation\n+                if (!target.toAbsolutePath().normalize().startsWith(normalizedTargetDir)) {\n+                    throw new IOException(String.format(\"Zip slip '%s' + '%s' -> '%s'\",\n+                            targetDirectory, zae.getName(), target));\n+                }\n                 try (InputStream is = archive.getInputStream(zae)) {\n                     Files.copy(is, target);\n                 }\n@@ -506,14 +515,25 @@ public void expand(final ZipFile archive, final Path targetDirectory) throws IOE\n     }\n \n     private static Path createParentDirectory(Path root, Path target) throws IOException {\n+        final Path normalizedRoot = root.toAbsolutePath().normalize();\n         Path relative =\n-                root.relativize(target.getParent());\n-        Path current = root.toAbsolutePath();\n+                normalizedRoot.relativize(target.toAbsolutePath().normalize().getParent());\n+        Path current = normalizedRoot;\n \n         for (Path p : relative) {\n+            // Skip parent directory references\n+            if (p.toString().equals(\"..\")) {\n+                throw new IOException(String.format(\"Path traversal detected in '%s'\", target));\n+            }\n             current = current.resolve(p);\n             if (Files.isSymbolicLink(current)) {\n-                current = Files.readSymbolicLink(current);\n+                Path resolved = current.toRealPath();\n+                // Validate symlink target stays within root directory\n+                if (!resolved.startsWith(normalizedRoot)) {\n+                    throw new IOException(String.format(\"Symlink traversal detected: '%s' points to '%s' outside of '%s'\",\n+                            current, resolved, normalizedRoot));\n+                }\n+                current = resolved;\n             }\n             if (! Files.isDirectory(current)) {\n                 Files.createDirectory(current);\n",
  "stdout": "",
  "stderr": ""
}