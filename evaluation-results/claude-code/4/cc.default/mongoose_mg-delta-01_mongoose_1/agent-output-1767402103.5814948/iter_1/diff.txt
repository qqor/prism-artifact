diff --git a/src/fmt.c b/src/fmt.c
index 8164e1ca..93b66efb 100644
--- a/src/fmt.c
+++ b/src/fmt.c
@@ -315,17 +315,44 @@ size_t mg_vxprintf(void (*out)(char, void *), void *param, const char *fmt,
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
           double d = va_arg(*ap, double);
-          int64_t exponent = (int64_t)log10(my_fabs(d));
-          double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
-          n += scpy(out, param, tmp, k);
-          out(c, param);
-          n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
-          n += scpy(out, param, tmp, k);
-	  } else if (c == '%') {
+          if (pr == ~0U) pr = 6;
+          // Handle special cases: 0, infinity, NaN
+          if (d == 0.0) {
+            n += scpy(out, param, (char *) "0", 1);
+            out('.', param);
+            n++;
+            for (j = 0; j < pr; j++) { out('0', param); n++; }
+            out(c, param);
+            n++;
+            n += scpy(out, param, (char *) "+00", 3);
+          } else if (xisinf(d)) {
+            n += scpy(out, param, d > 0 ? (char *) "inf" : (char *) "-inf", d > 0 ? 3 : 4);
+          } else if (xisnan(d)) {
+            n += scpy(out, param, (char *) "nan", 3);
+          } else {
+            char tmp[40], expbuf[8];
+            int s = 0;
+            double ad = my_fabs(d);
+            int64_t exponent = (int64_t) log10(ad);
+            double mantissa;
+            // Adjust exponent for proper range [1, 10)
+            if (ad < 1.0) exponent--;
+            mantissa = d / power(10, exponent);
+            // Ensure mantissa is in range [1, 10) or [-10, -1)
+            if (my_fabs(mantissa) >= 10.0) { mantissa /= 10.0; exponent++; }
+            if (my_fabs(mantissa) < 1.0 && mantissa != 0.0) { mantissa *= 10.0; exponent--; }
+            k = mg_dtoa(tmp, sizeof(tmp), mantissa, (int) pr + 1, false);
+            n += scpy(out, param, tmp, k);
+            out(c, param);
+            n++;
+            expbuf[s++] = (exponent >= 0) ? '+' : '-';
+            if (exponent < 0) exponent = -exponent;
+            if (exponent < 10) expbuf[s++] = '0';
+            k = mg_lld(expbuf + s, exponent, false, false);
+            n += scpy(out, param, expbuf, s + k);
+          }
+      } else if (c == '%') {
         out('%', param);
         n++;
       } else {
