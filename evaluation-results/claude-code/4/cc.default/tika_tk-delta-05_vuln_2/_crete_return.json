{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "sound",
  "diff": "diff --git a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\nindex 703e21c48..987212cba 100644\n--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -1138,6 +1138,12 @@ public class TikaCLI {\n             //defensively do this so that we don't get an exception\n             //from FilenameUtils.normalize\n             name = name.replaceAll(\"\\u0000\", \" \");\n+            // URL decode BEFORE normalizing to prevent encoded path traversal attacks\n+            try {\n+                name = URLDecoder.decode(name, UTF_8);\n+            } catch (IllegalArgumentException e) {\n+                LOG.warn(\"couldn't url decode name {}\", name);\n+            }\n             String normalizedName = FilenameUtils.normalize(name);\n \n             if (normalizedName == null) {\n@@ -1152,12 +1158,28 @@ public class TikaCLI {\n             if (prefixLength > -1) {\n                 normalizedName = normalizedName.substring(prefixLength);\n             }\n+            File outputFile = new File(extractDir, normalizedName);\n+            // Validate that the output file is within extractDir to prevent path traversal\n             try {\n-                normalizedName = URLDecoder.decode(normalizedName, UTF_8);\n-            } catch (IllegalArgumentException e) {\n-                LOG.warn(\"couldn't url decode name {}\", normalizedName);\n+                String extractDirCanonical = extractDir.getCanonicalPath();\n+                String outputFileCanonical = outputFile.getCanonicalPath();\n+                if (!outputFileCanonical.startsWith(extractDirCanonical + File.separator) &&\n+                        !outputFileCanonical.equals(extractDirCanonical)) {\n+                    // Path traversal detected, use a safe filename\n+                    String safeFileName = FilenameUtils.getName(normalizedName);\n+                    if (safeFileName == null || safeFileName.isEmpty()) {\n+                        safeFileName = \"file\" + count++ + ext;\n+                    }\n+                    outputFile = new File(extractDir, safeFileName);\n+                }\n+            } catch (IOException e) {\n+                // If we can't resolve canonical paths, fall back to safe filename\n+                String safeFileName = FilenameUtils.getName(normalizedName);\n+                if (safeFileName == null || safeFileName.isEmpty()) {\n+                    safeFileName = \"file\" + count++ + ext;\n+                }\n+                outputFile = new File(extractDir, safeFileName);\n             }\n-            File outputFile = new File(extractDir, normalizedName);\n             //if file already exists, prepend uuid\n             if (outputFile.exists()) {\n                 String fileName = FilenameUtils.getName(normalizedName);\n",
  "stdout": "",
  "stderr": ""
}