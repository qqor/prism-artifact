diff --git a/poi/src/main/java/org/apache/poi/hssf/record/aggregates/FormulaRecordAggregate.java b/poi/src/main/java/org/apache/poi/hssf/record/aggregates/FormulaRecordAggregate.java
index 5ce1f62f6..92a3fbe47 100644
--- a/poi/src/main/java/org/apache/poi/hssf/record/aggregates/FormulaRecordAggregate.java
+++ b/poi/src/main/java/org/apache/poi/hssf/record/aggregates/FormulaRecordAggregate.java
@@ -91,7 +91,19 @@ public final class FormulaRecordAggregate extends RecordAggregate implements Cel
      */
     private static void handleMissingSharedFormulaRecord(FormulaRecord formula) {
         // make sure 'unshared' formula is actually available
-        Ptg firstToken = formula.getParsedExpression()[0];
+        Ptg[] parsedExpression;
+        try {
+            parsedExpression = formula.getParsedExpression();
+        } catch (RuntimeException e) {
+            // Malformed formula data - cannot safely parse tokens
+            throw new RecordFormatException(
+                    "Failed to parse formula expression for FormulaRecord with (isSharedFormula=true)", e);
+        }
+        if (parsedExpression == null || parsedExpression.length == 0) {
+            throw new RecordFormatException(
+                    "SharedFormulaRecord not found for FormulaRecord with (isSharedFormula=true) and empty parsed expression");
+        }
+        Ptg firstToken = parsedExpression[0];
         if (firstToken instanceof ExpPtg) {
             throw new RecordFormatException(
                     "SharedFormulaRecord not found for FormulaRecord with (isSharedFormula=true)");
