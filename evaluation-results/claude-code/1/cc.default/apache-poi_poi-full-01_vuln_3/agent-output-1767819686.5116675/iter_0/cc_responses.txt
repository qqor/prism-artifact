
================================================================================
Response 1
================================================================================
Now I have a clear picture of the bugs. Let me read the primary bug file to create a proper patch:

================================================================================
Response 2
================================================================================
Now I can see the bug clearly at line 94. The code accesses `formula.getParsedExpression()[0]` without checking if the array is empty. Let me create a patch file and apply it:

================================================================================
Response 3
================================================================================
Now let me apply the fix directly to the source file:

================================================================================
Response 4
================================================================================
The patch has been successfully applied. Let me verify the fix by reading the updated file:

================================================================================
Response 5
================================================================================
The fix has been successfully applied. Here's a summary of what was done:

## Summary

### Bug Identified
The deadly signal (SIGSEGV) was caused by an **array index out of bounds** vulnerability in `FormulaRecordAggregate.java` at line 94:

```java
Ptg firstToken = formula.getParsedExpression()[0];  // CRASH if array is empty or null
```

When libFuzzer (POIHSSFFuzzer) fed a malformed XLS file containing a formula record marked as "shared formula" but with an empty parsed expression, the code attempted to access index `[0]` of an empty array, causing an `ArrayIndexOutOfBoundsException` that propagated through the JVM and ultimately resulted in a SIGSEGV.

### Fix Applied
The patch adds proper bounds checking before accessing the array:

```java
Ptg[] parsedExpression = formula.getParsedExpression();
if (parsedExpression == null || parsedExpression.length == 0) {
    throw new RecordFormatException(
            "SharedFormulaRecord not found for FormulaRecord with (isSharedFormula=true) and empty parsed expression");
}
Ptg firstToken = parsedExpression[0];
```

### Files Modified
- **Source file**: `/home/user/crete/.cache/official-afc-poi/poi/src/main/java/org/apache/poi/hssf/record/aggregates/FormulaRecordAggregate.java`
- **Patch file created**: `/home/user/crete/.cache/official-afc-poi/poi/src/main/java/org/apache/poi/hssf/record/aggregates/fix_signal_bug.patch`
