{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-01_vuln_9",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.0,
    "prompt_tokens": 0,
    "completion_tokens": 0
  },
  "variant": "sound",
  "diff": "diff --git a/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java b/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\nindex 429258e46..9c124e50f 100644\n--- a/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n+++ b/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n@@ -277,12 +277,80 @@ public class ExternalParser implements Parser {\n         }\n     }\n \n+    /**\n+     * Validates that a command array does not contain shell injection attempts.\n+     * This checks for common shell metacharacters and injection patterns.\n+     *\n+     * @param cmd The command array to validate\n+     * @return true if the command is safe, false otherwise\n+     */\n+    private boolean isCommandSafe(String[] cmd) {\n+        if (cmd == null || cmd.length == 0) {\n+            return false;\n+        }\n+\n+        // Dangerous shell metacharacters and patterns\n+        String[] dangerousPatterns = {\n+            \";\", \"|\", \"&\", \"$\", \"`\", \"\\\\n\", \"\\\\r\",\n+            \"$(\", \"||\", \"&&\", \">\", \"<\", \">>\", \"<<\",\n+            \"\\n\", \"\\r\"\n+        };\n+\n+        for (String cmdPart : cmd) {\n+            if (cmdPart == null) {\n+                continue;\n+            }\n+\n+            // Check for dangerous patterns\n+            for (String pattern : dangerousPatterns) {\n+                if (cmdPart.contains(pattern)) {\n+                    LOG.warn(\"Potentially unsafe command detected: contains '{}' in '{}'\", pattern, cmdPart);\n+                    return false;\n+                }\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    /**\n+     * Validates that a file path does not contain shell injection attempts.\n+     *\n+     * @param path The file path to validate\n+     * @return true if the path is safe, false otherwise\n+     */\n+    private boolean isPathSafe(String path) {\n+        if (path == null) {\n+            return false;\n+        }\n+\n+        // Dangerous characters in file paths\n+        String[] dangerousChars = {\n+            \";\", \"|\", \"&\", \"$\", \"`\", \"\\\\n\", \"\\\\r\",\n+            \"$(\", \"\\n\", \"\\r\", \"||\", \"&&\"\n+        };\n+\n+        for (String dangerous : dangerousChars) {\n+            if (path.contains(dangerous)) {\n+                LOG.warn(\"Potentially unsafe file path detected: contains '{}' in '{}'\", dangerous, path);\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n     private void parse(TikaInputStream stream, XHTMLContentHandler xhtml, Metadata metadata,\n                        TemporaryResources tmp) throws IOException, SAXException, TikaException {\n         boolean inputToStdIn = true;\n         boolean outputFromStdOut = true;\n         boolean hasPatterns = (metadataPatterns != null && !metadataPatterns.isEmpty());\n \n+        // Security validation: Check if the command contains shell metacharacters or suspicious patterns\n+        if (!isCommandSafe(command)) {\n+            throw new TikaException(\"Unsafe command detected: command contains shell metacharacters or suspicious patterns\");\n+        }\n+\n         File output = null;\n \n         // Build our command\n@@ -295,16 +363,31 @@ public class ExternalParser implements Parser {\n         }\n         for (int i = 0; i < cmd.length; i++) {\n             if (cmd[i].contains(INPUT_FILE_TOKEN)) {\n-                cmd[i] = cmd[i].replace(INPUT_FILE_TOKEN, stream.getFile().getPath());\n+                String inputPath = stream.getFile().getPath();\n+                // Validate the file path doesn't contain shell metacharacters\n+                if (!isPathSafe(inputPath)) {\n+                    throw new TikaException(\"Unsafe input file path detected: \" + inputPath);\n+                }\n+                cmd[i] = cmd[i].replace(INPUT_FILE_TOKEN, inputPath);\n                 inputToStdIn = false;\n             }\n             if (cmd[i].contains(OUTPUT_FILE_TOKEN)) {\n                 output = tmp.createTemporaryFile();\n                 outputFromStdOut = false;\n-                cmd[i] = cmd[i].replace(OUTPUT_FILE_TOKEN, output.getPath());\n+                String outputPath = output.getPath();\n+                // Validate the output file path doesn't contain shell metacharacters\n+                if (!isPathSafe(outputPath)) {\n+                    throw new TikaException(\"Unsafe output file path detected: \" + outputPath);\n+                }\n+                cmd[i] = cmd[i].replace(OUTPUT_FILE_TOKEN, outputPath);\n             }\n         }\n \n+        // Final validation of the complete command before execution\n+        if (!isCommandSafe(cmd)) {\n+            throw new TikaException(\"Unsafe command detected after path substitution\");\n+        }\n+\n         // Execute\n         Process process = null;\n         try {\n",
  "stdout": "",
  "stderr": ""
}