{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.20984590000000003,
    "prompt_tokens": 53033,
    "completion_tokens": 34434
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -72,7 +72,12 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                java.nio.file.Path basePath = dumpDir.toPath().normalize();\n+                java.nio.file.Path resolvedPath = basePath.resolve(root.getName()).normalize();\n+                if (!resolvedPath.startsWith(basePath)) {\n+                    throw new IOException(\"Invalid entry name: \" + root.getName());\n+                }\n+                File file = resolvedPath.toFile();\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -105,13 +110,24 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                java.nio.file.Path basePath = parent.toPath().normalize();\n+                java.nio.file.Path resolvedPath = basePath.resolve(node.getName().trim()).normalize();\n+                if (!resolvedPath.startsWith(basePath)) {\n+                    throw new IOException(\"Invalid entry name: \" + node.getName());\n+                }\n+                File outFile = resolvedPath.toFile();\n+                try (OutputStream out = Files.newOutputStream(outFile.toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n+                java.nio.file.Path basePath = parent.toPath().normalize();\n+                java.nio.file.Path resolvedPath = basePath.resolve(entry.getName()).normalize();\n+                if (!resolvedPath.startsWith(basePath)) {\n+                    throw new IOException(\"Invalid entry name: \" + entry.getName());\n+                }\n+                File file = resolvedPath.toFile();\n+                if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n                 dump(dir, file);\n@@ -121,11 +137,16 @@\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n-        if (! Files.isDirectory(file.toPath().getParent())) {\n-            Files.createDirectories(file.toPath().getParent());\n+        java.nio.file.Path basePath = parent.toPath().normalize();\n+        java.nio.file.Path resolvedPath = basePath.resolve(name).normalize();\n+        if (!resolvedPath.startsWith(basePath)) {\n+            throw new IOException(\"Invalid entry name: \" + name);\n         }\n-        try (OutputStream out = Files.newOutputStream(file.toPath())) {\n+        File outFile = resolvedPath.toFile();\n+        if (!Files.isDirectory(outFile.toPath().getParent())) {\n+            Files.createDirectories(outFile.toPath().getParent());\n+        }\n+        try (OutputStream out = Files.newOutputStream(outFile.toPath())) {\n             POIFSStream stream = new POIFSStream(fs, startBlock);\n \n             byte[] b = IOUtils.safelyAllocate(fs.getBigBlockSize(), POIFSFileSystem.getMaxRecordLength());\n",
  "stdout": "",
  "stderr": ""
}