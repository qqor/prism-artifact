{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_6",
  "source_directory": "/home/qqor/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.3443286,
    "prompt_tokens": 196390,
    "completion_tokens": 29159
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n@@ -68,7 +68,12 @@\n     /**\n      * Heuristically chosen max length to buffer a Type1 font\n      */\n-    private static final long MAX_LENGTH = 100_000_000;\n+    public static final long MAX_LENGTH = 100_000_000L;\n+\n+    /**\n+     * Max size of a single PFB segment\n+     */\n+    private static final int MAX_SEGMENT_LENGTH = 20_000_000;\n \n     /**\n      * the parsed pfb-data.\n@@ -92,7 +97,7 @@\n      */\n     public PfbParser(final String filename) throws IOException \n     {\n-        this(Files.readAllBytes(Paths.get(filename)));\n+        this(Files.newInputStream(Paths.get(filename)));\n     }\n \n     /**\n@@ -102,7 +107,11 @@\n      */\n     public PfbParser(final InputStream in) throws IOException \n     {\n-        byte[] pfb = in.readAllBytes();\n+        int cap = (int) MAX_LENGTH + 1;\n+        byte[] pfb = in.readNBytes(cap);\n+        if (pfb.length > MAX_LENGTH) {\n+            throw new IOException(\"PFB data exceeds maximum allowed size of \" + MAX_LENGTH + \" bytes\");\n+        }\n         parsePfb(pfb);\n     }\n \n@@ -157,6 +166,9 @@\n             size += in.read() << 8;\n             size += in.read() << 16;\n             size += in.read() << 24;\n+            if (size < 0 || size > MAX_SEGMENT_LENGTH) {\n+                throw new IOException(\"PFB segment size \" + size + \" exceeds per-segment limit of \" + MAX_SEGMENT_LENGTH);\n+            }\n             LOG.debug(\"record type: {}, segment size: {}\", recordType, size);\n             long newTotal = total + size;\n             if (newTotal > MAX_LENGTH) {\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/PDType1Font.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/PDType1Font.java\n@@ -223,6 +223,9 @@\n \n                     if ((bytes[0] & 0xff) == PFB_START_MARKER)\n                     {\n+                        if (bytes.length > org.apache.fontbox.pfb.PfbParser.MAX_LENGTH) {\n+                            throw new IOException(\"Embedded Type1 font data (\" + bytes.length + \" bytes) exceeds maximum allowed size (\" + org.apache.fontbox.pfb.PfbParser.MAX_LENGTH + \" bytes)\");\n+                        }\n                         // some bad files embed the entire PFB, see PDFBOX-2607\n                         t1 = Type1Font.createWithPFB(bytes);\n                     }\n",
  "stdout": "",
  "stderr": ""
}