{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-02_vuln_9",
  "source_directory": "/home/qqor/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 0.34731400000000007,
    "prompt_tokens": 182140,
    "completion_tokens": 33400
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n+++ b/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n@@ -23,6 +23,8 @@\n import java.nio.ByteOrder;\n \n import org.apache.commons.compress.compressors.lzw.LZWInputStream;\n+import org.apache.commons.compress.compressors.CompressorException;\n+import org.apache.commons.compress.MemoryLimitException;\n \n /**\n  * Input stream that decompresses .Z files.\n@@ -80,8 +82,23 @@\n         }\n         blockMode = (thirdByte & BLOCK_MODE_MASK) != 0;\n         maxCodeSize = thirdByte & MAX_CODE_SIZE_MASK;\n+        // prevent resource exhaustion by capping code size\n+        final int MAX_ALLOWED_CODE_SIZE = 16;\n+        if (maxCodeSize > MAX_ALLOWED_CODE_SIZE) {\n+            throw new CompressorException(\"maxCodeSize \" + maxCodeSize +\n+                                          \" is out of bounds (max: \" + MAX_ALLOWED_CODE_SIZE + \")\");\n+        }\n         if (blockMode) {\n             setClearCode(DEFAULT_CODE_SIZE);\n+        }\n+        // enforce memory limit before table allocation\n+        int maxTableSize = 1 << maxCodeSize;\n+        long memoryUsageBytes = (Integer.BYTES + Byte.BYTES) * (long) maxTableSize;\n+        long memoryUsageKiB = memoryUsageBytes >> 10;\n+        if (memoryLimitInKiB > 0) {\n+            if (memoryUsageKiB > memoryLimitInKiB) {\n+                throw new MemoryLimitException(memoryUsageKiB, memoryLimitInKiB);\n+            }\n         }\n         initializeTables(maxCodeSize, memoryLimitInKiB);\n         clearEntries();\n",
  "stdout": "",
  "stderr": ""
}