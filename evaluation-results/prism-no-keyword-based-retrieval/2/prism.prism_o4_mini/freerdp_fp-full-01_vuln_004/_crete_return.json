{
  "project_name": "freerdp",
  "vulnerability_identifier": "freerdp_fp-full-01_vuln_004",
  "source_directory": "/home/user/crete/.cache/official-afc-freerdp",
  "llm_usage": {
    "total_cost": 1.0077715999999999,
    "prompt_tokens": 548120,
    "completion_tokens": 92009
  },
  "variant": "sound",
  "diff": "--- a/libfreerdp/core/mcs.h\n+++ b/libfreerdp/core/mcs.h\n@@ -144,7 +144,7 @@\n \tBOOL globalChannelJoined;\n \tBOOL messageChannelJoined;\n \n-\tINT8 channelCount;\n+\tUINT8 channelCount;\n \trdpMcsChannel* channels;\n };\n \n\n--- a/libfreerdp/core/gcc.c\n+++ b/libfreerdp/core/gcc.c\n@@ -1847,46 +1847,40 @@\n \n BOOL gcc_read_client_network_data(wStream* s, rdpMcs* mcs)\n {\n-\tWINPR_ASSERT(s);\n-\tWINPR_ASSERT(mcs);\n-\n-\tconst size_t blockLength = Stream_GetRemainingLength(s);\n-\tif (blockLength < 4)\n-\t\treturn FALSE;\n-\n-\tStream_Read_UINT8(s, mcs->channelCount); /* channelCount */\n-\n-\tif (blockLength < 4 + (UINT8)mcs->channelCount * 12)\n-\t\treturn FALSE;\n-\n-\tif (mcs->channelCount > CHANNEL_MAX_COUNT)\n-\t\treturn FALSE;\n-\n-\t/* channelDefArray */\n-\tfor (UINT32 i = 0; i < mcs->channelCount; i++)\n-\t{\n-\t\t/**\n-\t\t * CHANNEL_DEF\n-\t\t * - name: an 8-byte array containing a null-terminated collection\n-\t\t *   of seven ANSI characters that uniquely identify the channel.\n-\t\t * - options: a 32-bit, unsigned integer. Channel option flags\n-\t\t */\n-\t\trdpMcsChannel* channel = &mcs->channels[i];\n-\t\tStream_Read(s, channel->Name, CHANNEL_NAME_LEN + 1); /* name (8 bytes) */\n-\n-\t\tif (!memchr(channel->Name, 0, CHANNEL_NAME_LEN + 1))\n-\t\t{\n-\t\t\tWLog_ERR(\n-\t\t\t    TAG,\n-\t\t\t    \"protocol violation: received a static channel name with missing null-termination\");\n-\t\t\treturn FALSE;\n-\t\t}\n-\n-\t\tStream_Read_UINT32(s, channel->options); /* options (4 bytes) */\n-\t\tchannel->ChannelId = mcs->baseChannelId++;\n-\t}\n-\n-\treturn TRUE;\n+    UINT8 channelCount;\n+    UINT32 i;\n+    rdpMcsChannel* channel;\n+    const size_t blockLength = Stream_GetRemainingLength(s);\n+\n+    WINPR_ASSERT(s);\n+    WINPR_ASSERT(mcs);\n+\n+    if (blockLength < 1)\n+        return FALSE;\n+    Stream_Read_UINT8(s, channelCount);\n+    if (channelCount > CHANNEL_MAX_COUNT)\n+    {\n+        WLog_ERR(TAG, \"Too many client channel definitions: %\" PRIu8, channelCount);\n+        return FALSE;\n+    }\n+    if (blockLength < 1 + (size_t)channelCount * 12)\n+        return FALSE;\n+    mcs->channelCount = channelCount;\n+\n+    for (i = 0; i < channelCount; i++)\n+    {\n+        channel = &mcs->channels[i];\n+        Stream_Read(s, channel->Name, CHANNEL_NAME_LEN + 1); /* name (8 bytes) */\n+        if (!memchr(channel->Name, 0, CHANNEL_NAME_LEN + 1))\n+        {\n+            WLog_ERR(TAG,\n+                     \"protocol violation: received a static channel name with missing null-termination\");\n+            return FALSE;\n+        }\n+        Stream_Read_UINT32(s, channel->options);\n+        channel->ChannelId = mcs->baseChannelId++;\n+    }\n+    return TRUE;\n }\n \n /**\n\n--- a/libfreerdp/core/mcs.c\n+++ b/libfreerdp/core/mcs.c\n@@ -693,12 +693,25 @@\n \tif (!mcs_read_domain_parameters(s, &mcs->maximumParameters))\n \t\treturn FALSE;\n \n-\tif (!ber_read_octet_string_tag(s, &length) ||\n-\t    (!Stream_CheckAndLogRequiredLength(TAG, s, length)))\n-\t\treturn FALSE;\n-\n-\tif (!gcc_read_conference_create_request(s, mcs))\n-\t\treturn FALSE;\n+    UINT8 userChannelCount;\n+    UINT32 j;\n+\n+    if (!ber_read_octet_string_tag(s, &length) ||\n+        !Stream_CheckAndLogRequiredLength(TAG, s, length))\n+        return FALSE;\n+\n+    Stream_Read_UINT8(s, userChannelCount);\n+    if (userChannelCount > CHANNEL_MAX_COUNT)\n+    {\n+        WLog_ERR(TAG, \"Too many user channels to join: %\" PRIu8, userChannelCount);\n+        return FALSE;\n+    }\n+\n+    for (j = 0; j < userChannelCount; j++)\n+    {\n+        if (!gcc_read_conference_create_request(s, mcs))\n+            return FALSE;\n+    }\n \n \tif (!mcs_merge_domain_parameters(&mcs->targetParameters, &mcs->minimumParameters,\n \t                                 &mcs->maximumParameters, &mcs->domainParameters))\n",
  "stdout": "",
  "stderr": ""
}