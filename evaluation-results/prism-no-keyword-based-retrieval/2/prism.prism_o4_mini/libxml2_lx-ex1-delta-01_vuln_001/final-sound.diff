--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3574,7 +3574,7 @@
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
 
-        if (extraSize > buffer_size) {
+        if ((size_t)used + extraSize > buffer_size) {
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
@@ -3584,6 +3584,11 @@
             }
             buffer = tmp;
             buffer_size = newSize;
+        }
+        if ((size_t)used + extraSize > (size_t)maxLength) {
+            htmlParseErr(ctxt, XML_ERR_RESOURCE_LIMIT,
+                         "comment too long\n", NULL, NULL);
+            goto error;
         }
 
         if (chunkSize > 0) {
