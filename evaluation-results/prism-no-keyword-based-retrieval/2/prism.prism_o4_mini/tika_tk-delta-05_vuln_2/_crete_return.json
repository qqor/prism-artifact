{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.7943551000000002,
    "prompt_tokens": 419461,
    "completion_tokens": 75670
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -448,6 +448,11 @@\n                 dirPath = \".\";\n             }\n             extractDir = new File(dirPath);\n+            try {\n+                extractDir = extractDir.getCanonicalFile();\n+            } catch (IOException e) {\n+                throw new IllegalArgumentException(\"Invalid extract directory: \" + dirPath, e);\n+            }\n         } else if (arg.equals(\"-z\") || arg.equals(\"--extract\")) {\n             type = NO_OUTPUT;\n             context.set(EmbeddedDocumentExtractor.class, new FileEmbeddedDocumentExtractor());\n@@ -1157,15 +1162,41 @@\n             } catch (IllegalArgumentException e) {\n                 LOG.warn(\"couldn't url decode name {}\", normalizedName);\n             }\n-            File outputFile = new File(extractDir, normalizedName);\n-            //if file already exists, prepend uuid\n-            if (outputFile.exists()) {\n-                String fileName = FilenameUtils.getName(normalizedName);\n-                outputFile = new File(extractDir, UUID\n-                        .randomUUID()\n-                        .toString() + \"-\" + fileName);\n-            }\n-            return outputFile;\n+            // Resolve base directory to canonical form\n+            File baseDir;\n+            try {\n+                baseDir = extractDir.getCanonicalFile();\n+            } catch (IOException e) {\n+                baseDir = extractDir;\n+                LOG.warn(\"Could not canonicalize extractDir {}; proceeding non-canonical\", extractDir, e);\n+            }\n+            // Build initial candidate under baseDir\n+            File candidate = new File(baseDir, normalizedName);\n+            File safeFile;\n+            try {\n+                File canonicalCandidate = candidate.getCanonicalFile();\n+                String basePath = baseDir.getPath() + File.separator;\n+                if (!canonicalCandidate.getPath().startsWith(basePath)) {\n+                    // Traversal detected: strip path, use only the filename\n+                    String safeName = FilenameUtils.getName(normalizedName);\n+                    safeFile = new File(baseDir, safeName).getCanonicalFile();\n+                } else {\n+                    safeFile = canonicalCandidate;\n+                }\n+            } catch (IOException ioe) {\n+                LOG.warn(\"Could not canonicalize output file {}; using raw path\", candidate, ioe);\n+                safeFile = candidate;\n+            }\n+            if (safeFile.exists()) {\n+                String fileName = safeFile.getName();\n+                try {\n+                    safeFile = new File(baseDir, UUID.randomUUID().toString() + \"-\" + fileName).getCanonicalFile();\n+                } catch (IOException e) {\n+                    safeFile = new File(baseDir, UUID.randomUUID().toString() + \"-\" + fileName);\n+                    LOG.warn(\"Could not canonicalize UUID-prefixed file; using raw path\", e);\n+                }\n+            }\n+            return safeFile;\n         }\n \n         private String getExtension(MediaType contentType) {\n",
  "stdout": "",
  "stderr": ""
}