{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-02_vuln_3",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.3207105,
    "prompt_tokens": 119271,
    "completion_tokens": 43071
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/io/TikaInputStream.java\n+++ b/tika-core/src/main/java/org/apache/tika/io/TikaInputStream.java\n@@ -566,6 +566,8 @@\n      * @return a TikaInputStream instance\n      * @throws IOException if the resource can not be accessed\n      */\n+    // SSRF Protection: context-based flag for allowing HTTP(S) fetches\n+    public static final Class<Boolean> ALLOW_REMOTE_STREAMS = Boolean.class;\n     public static TikaInputStream get(URL url) throws IOException {\n         return get(url, new Metadata());\n     }\n@@ -583,6 +585,27 @@\n      * @throws IOException if the resource can not be accessed\n      */\n     public static TikaInputStream get(URL url, Metadata metadata) throws IOException {\n+        return get(url, metadata, new org.apache.tika.parser.ParseContext());\n+    }\n+\n+    /**\n+     * Creates a TikaInputStream from the resource at the given URL, with ParseContext support.\n+     *\n+     * @param url      resource URL\n+     * @param metadata metadata instance\n+     * @param context  parse context carrying ALLOW_REMOTE_STREAMS flag\n+     * @return a TikaInputStream instance\n+     * @throws IOException if the resource cannot be accessed or SSRF protection triggers\n+     */\n+    public static TikaInputStream get(URL url, Metadata metadata, org.apache.tika.parser.ParseContext context) throws IOException {\n+        // SSRF Protection: block HTTP(S) fetches by default unless allowed in context\n+        String protocol = url.getProtocol();\n+        if (\"http\".equalsIgnoreCase(protocol) || \"https\".equalsIgnoreCase(protocol)) {\n+            Boolean allow = context.get(ALLOW_REMOTE_STREAMS);\n+            if (allow == null || !allow) {\n+                throw new IOException(\"Remote resource fetching disabled for SSRF protection: \" + url);\n+            }\n+        }\n         // Special handling for file:// URLs\n         if (\"file\".equalsIgnoreCase(url.getProtocol())) {\n             try {\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n@@ -167,7 +167,7 @@\n         EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n         Metadata m = new Metadata();\n         if (ex.shouldParseEmbedded(m)) {\n-            try (TikaInputStream tis = TikaInputStream.get(new URL(nextLine))) {\n+            try (TikaInputStream tis = TikaInputStream.get(new URL(nextLine), metadata, context)) {\n                 ex.parseEmbedded(tis, new BodyContentHandler(new EmbeddedContentHandler(xhtml)), m,\n                         true);\n             }\n",
  "stdout": "",
  "stderr": ""
}