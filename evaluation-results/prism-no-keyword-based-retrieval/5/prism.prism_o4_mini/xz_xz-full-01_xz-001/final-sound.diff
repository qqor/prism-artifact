--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -65,27 +65,27 @@
 // Walk the tree to calculate the e37vk checksum
 static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
 {
-  // Skip if already hashed
-  if (!node || node->state == STATE_HASHED) {
+  // Skip if null or not clear
+  if (!node || node->state != STATE_CLEAR) {
     return 0;
   }
 
   // Compute initial checksum from depth and value
   uint32_t sum = node->value * (depth + 1);
 
-  // Traverse the child nodes if not already visited
-  if (node->state == STATE_CLEAR) {
-    node->state = STATE_VISITED;
-    for (size_t i = 0; i < node->edge_count; ++i) {
-      TreeNode *child = node->edges[i];
-      if (child) {
-        sum += compute_tree_checksum(child, depth + 1);
-      }
+  // Mark as visited to avoid cycles
+  node->state = STATE_VISITED;
+
+  // Traverse child nodes
+  for (size_t i = 0; i < node->edge_count; ++i) {
+    TreeNode *child = node->edges[i];
+    if (child) {
+      sum += compute_tree_checksum(child, depth + 1);
     }
-    node->state = STATE_HASHED;
   }
 
-  // Free the node and edges
+  // Mark as hashed and free the node and its edges
+  node->state = STATE_HASHED;
   free(node->edges);
   free(node);
 
