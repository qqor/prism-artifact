{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_7",
  "source_directory": "/home/qqor/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.6991104999999999,
    "prompt_tokens": 430123,
    "completion_tokens": 51358
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BruteForceParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BruteForceParser.java\n@@ -53,6 +53,9 @@\n      * EOF-marker.\n      */\n     private static final char[] EOF_MARKER = { '%', '%', 'E', 'O', 'F' };\n+\n+    private static final long DEFAULT_BF_SEARCH_RANGE = 1_048_576L;\n+    private final long maxSearchRange;\n     /**\n      * obj-marker.\n      */\n@@ -94,6 +97,8 @@\n         document = cosDocument;\n         parser = cosParser;\n         source = parser.source;\n+        this.maxSearchRange = Long.getLong(\"nonSequentialPDFParser.bruteforceSearchRange\",\n+                                           DEFAULT_BF_SEARCH_RANGE);\n     }\n \n     /**\n@@ -133,6 +138,7 @@\n     {\n         long lastEOFMarker = bfSearchForLastEOFMarker();\n         long originOffset = source.getPosition();\n+        long scanLimit = Math.min(lastEOFMarker, MINIMUM_SEARCH_OFFSET + maxSearchRange);\n         long currentOffset = MINIMUM_SEARCH_OFFSET;\n         long lastObjectId = Long.MIN_VALUE;\n         int lastGenID = Integer.MIN_VALUE;\n@@ -204,7 +210,11 @@\n                     endOfObjFound = true;\n                 }\n             }\n-        } while (currentOffset < lastEOFMarker && !parser.isEOF());\n+        } while (currentOffset < scanLimit && !parser.isEOF());\n+        if (currentOffset >= scanLimit)\n+        {\n+            LOG.warn(\"Brute-force search capped at {} bytes, objects may be skipped\", maxSearchRange);\n+        }\n         if ((lastEOFMarker < Long.MAX_VALUE || endOfObjFound) && lastObjOffset > 0)\n         {\n             // if the pdf wasn't cut off in the middle or if the last object ends with a \"endobj\" marker\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -180,9 +180,11 @@\n     private final class PageIterator implements Iterator<PDPage>\n     {\n         private final Queue<COSDictionary> queue = new ArrayDeque<>();\n+        private final Set<COSDictionary> visited = new HashSet<>();\n \n         private PageIterator(COSDictionary node)\n         {\n+            visited.add(node);\n             List<COSDictionary> kids = enqueueKids(node);\n             while (!kids.isEmpty())\n             {\n@@ -205,7 +207,7 @@\n          */\n         private List<COSDictionary> enqueueKids(COSDictionary node)\n         {\n-            if (isPageTreeNode(node))\n+            if (isPageTreeNode(node) && visited.add(node))\n             {\n                 return getKids(node);\n             }\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/text/PDFTextStripper.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/text/PDFTextStripper.java\n@@ -141,6 +141,9 @@\n     private int startBookmarkPageNumber = -1;\n     private int endBookmarkPageNumber = -1;\n \n+    private static final int DEFAULT_MAX_PAGES = 1000;\n+    private final int maxPages = Integer.getInteger(\"pdftextstripper.maxPages\", DEFAULT_MAX_PAGES);\n+\n     private PDOutlineItem endBookmark = null;\n     private boolean suppressDuplicateOverlappingText = true;\n     private boolean shouldSeparateByBeads = true;\n@@ -295,13 +298,20 @@\n             startBookmarkPageNumber = 0;\n             endBookmarkPageNumber = 0;\n         }\n+        int pagesProcessed = 0;\n \n         for (PDPage page : pages)\n         {\n+            if (pagesProcessed >= maxPages)\n+            {\n+                LOG.warn(\"PDFTextStripper: page cap reached ({}), stopping text extraction\", maxPages);\n+                break;\n+            }\n             if (page.hasContents())\n             {\n                 processPage(page);\n             }\n+            pagesProcessed++;\n             currentPageNo++;\n         }\n     }\n",
  "stdout": "",
  "stderr": ""
}