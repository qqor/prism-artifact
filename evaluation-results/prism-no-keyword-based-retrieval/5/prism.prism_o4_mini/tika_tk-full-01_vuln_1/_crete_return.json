{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_1",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 1.1219439,
    "prompt_tokens": 477453,
    "completion_tokens": 135624
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n@@ -25,6 +25,7 @@\n import org.apache.commons.io.FilenameUtils;\n import org.apache.commons.io.IOUtils;\n import org.apache.commons.io.input.UnsynchronizedByteArrayInputStream;\n+import org.apache.tika.parser.ParseContext;\n import org.apache.commons.io.output.UnsynchronizedByteArrayOutputStream;\n import org.xml.sax.ContentHandler;\n import org.xml.sax.SAXException;\n@@ -67,7 +68,7 @@\n     private final EmbeddedDocumentUtil embeddedDocumentUtil;\n     private final UnsynchronizedByteArrayOutputStream os;\n     private final int memoryLimitInKb;\n-\n+    private final ParseContext context;\n     private boolean isPictBitmap = false;\n     //high hex cached for writing hexpair chars (data)\n     private int hi = -1;\n@@ -87,6 +88,7 @@\n         this.embeddedDocumentUtil = new EmbeddedDocumentUtil(context);\n         os = UnsynchronizedByteArrayOutputStream.builder().get();\n         this.memoryLimitInKb = memoryLimitInKb;\n+        this.context = context;\n     }\n \n     protected void startPict() {\n@@ -211,16 +213,24 @@\n             extractObj(bytes, handler, metadata);\n \n         } else if (state == EMB_STATE.JAVA_OBJDATA) {\n-            try {\n-                Object obj = new ObjectInputStream(\n-                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n-                                .get()).readObject();\n-                metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());\n-                metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,\n-                        MediaType.text(\"plain\").toString());\n-                extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);\n-            } catch (ClassNotFoundException e) {\n-                throw new TikaException(\"Not found\", e);\n+            RTFParserConfig cfg = context.get(RTFParserConfig.class);\n+            if (cfg == null || !cfg.isAllowJavaObjects()) {\n+                // Deserialization disabled: treat as raw data\n+                metadata.set(RTFMetadata.EMB_CLASS, \"application/octet-stream\");\n+                extractObj(bytes, handler, metadata);\n+            } else {\n+                try {\n+                    Object obj = new ObjectInputStream(\n+                            UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n+                                    .get()).readObject();\n+                    metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());\n+                    metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,\n+                            MediaType.text(\"plain\").toString());\n+                    extractObj(obj.toString().getBytes(StandardCharsets.UTF_8),\n+                            handler, metadata);\n+                } catch (ClassNotFoundException | IOException e) {\n+                    EmbeddedDocumentUtil.recordException(e, metadata);\n+                }\n             }\n         } else if (state == EMB_STATE.NADA) {\n             //swallow...no start for pict or embed?!\n@@ -283,4 +293,20 @@\n         JAVA_OBJDATA, //recording java obj data\n         NADA\n     }\n+    /**\n+     * Controls whether embedded Java objects are deserialized.\n+     */\n+    public static class RTFParserConfig {\n+        private boolean allowJavaObjects = false;\n+\n+        /** Enable parsing of embedded Java serialized objects. */\n+        public void setAllowJavaObjects(boolean allowJavaObjects) {\n+            this.allowJavaObjects = allowJavaObjects;\n+        }\n+\n+        /** Returns true if embedded Java object deserialization is enabled. */\n+        public boolean isAllowJavaObjects() {\n+            return allowJavaObjects;\n+        }\n+    }\n }\n",
  "stdout": "",
  "stderr": ""
}