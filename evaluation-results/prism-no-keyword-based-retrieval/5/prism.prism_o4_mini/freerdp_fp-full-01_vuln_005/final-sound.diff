--- a/libfreerdp/core/freerdp.c
+++ b/libfreerdp/core/freerdp.c
@@ -1453,7 +1453,14 @@
 	WINPR_ASSERT(s);
 
 	rdpMcs* mcs = test_mcs_new();
-	WINPR_ASSERT(mcs);
+	if (!mcs)
+		return FALSE;
+
+	if (!mcs_client_begin(mcs))
+	{
+		test_mcs_free(mcs);
+		return FALSE;
+	}
 
 	BOOL result = mcs_recv_connect_response(mcs, s);
 	test_mcs_free(mcs);
