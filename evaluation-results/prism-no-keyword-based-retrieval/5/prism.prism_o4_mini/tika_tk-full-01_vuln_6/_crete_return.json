{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_6",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.158532,
    "prompt_tokens": 83120,
    "completion_tokens": 15250
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaUntar.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaUntar.java\n@@ -24,6 +24,7 @@\n \n import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;\n+import org.apache.commons.io.FilenameUtils;\n \n /**\n  * Super simple utility class to untar a tar file\n@@ -33,6 +34,7 @@\n     public static void main(String[] args) throws IOException {\n         Path inputFile = Paths.get(args[0]);\n         Path extractDir = Paths.get(args[1]);\n+        Path baseDir = extractDir.toAbsolutePath().normalize();\n         try (InputStream is = Files.newInputStream(inputFile);\n                 TarArchiveInputStream tais = new TarArchiveInputStream(is)) {\n \n@@ -40,7 +42,19 @@\n \n             while (tae != null) {\n                 if (tae.isFile()) {\n-                    Path target = extractDir.resolve(tae.getName()).normalize();\n+                    String entryName = tae.getName().replace('\\u0000', ' ');\n+                    String normalizedName = FilenameUtils.normalize(entryName, true);\n+                    if (normalizedName == null) {\n+                        normalizedName = FilenameUtils.getName(entryName);\n+                    }\n+                    int prefixLength = FilenameUtils.getPrefixLength(normalizedName);\n+                    if (prefixLength > 0) {\n+                        normalizedName = normalizedName.substring(prefixLength);\n+                    }\n+                    Path target = baseDir.resolve(normalizedName).toAbsolutePath().normalize();\n+                    if (!target.startsWith(baseDir)) {\n+                        throw new IOException(\"Tar entry is outside of the target dir: \" + normalizedName);\n+                    }\n                     if (!Files.isDirectory(target.getParent())) {\n                         Files.createDirectories(target.getParent());\n                     }\n",
  "stdout": "",
  "stderr": ""
}