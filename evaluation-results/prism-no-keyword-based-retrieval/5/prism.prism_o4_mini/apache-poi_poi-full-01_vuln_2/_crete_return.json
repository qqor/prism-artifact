{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.1634402,
    "prompt_tokens": 70926,
    "completion_tokens": 19414
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -97,6 +97,7 @@\n     }\n     \n     public static void dump(DirectoryEntry root, File parent) throws IOException {\n+        String parentCanonical = parent.getCanonicalPath();\n         for(Iterator<Entry> it = root.getEntries(); it.hasNext();){\n             Entry entry = it.next();\n             if(entry instanceof DocumentNode){\n@@ -105,16 +106,49 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                String rawName = node.getName();\n+                String trimmed = rawName.trim();\n+                java.nio.file.Path p = null;\n+                try {\n+                    p = java.nio.file.Paths.get(trimmed).getFileName();\n+                } catch (java.nio.file.InvalidPathException e) {\n+                    // ignore invalid path\n+                }\n+                if (p != null) {\n+                    trimmed = p.toString();\n+                }\n+                String safeName = trimmed.replaceAll(\"[\\\\\\\\/:*?\\\"<>|]+\", \"_\");\n+                File outFile = new File(parent, safeName).getCanonicalFile();\n+                if (!outFile.getPath().equals(parentCanonical)\n+                        && !outFile.getPath().startsWith(parentCanonical + File.separator)) {\n+                    throw new IOException(\"Invalid entry name triggers path traversal: \" + rawName);\n+                }\n+                try (OutputStream out = Files.newOutputStream(outFile.toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n+                String rawDirName = entry.getName();\n+                String trimmedDir = rawDirName.trim();\n+                java.nio.file.Path dp = null;\n+                try {\n+                    dp = java.nio.file.Paths.get(trimmedDir).getFileName();\n+                } catch (java.nio.file.InvalidPathException e) {\n+                    // ignore invalid path\n                 }\n-                dump(dir, file);\n+                if (dp != null) {\n+                    trimmedDir = dp.toString();\n+                }\n+                String safeDirName = trimmedDir.replaceAll(\"[\\\\\\\\/:*?\\\"<>|]+\", \"_\");\n+                File dirFile = new File(parent, safeDirName).getCanonicalFile();\n+                if (!dirFile.getPath().equals(parentCanonical)\n+                        && !dirFile.getPath().startsWith(parentCanonical + File.separator)) {\n+                    throw new IOException(\"Invalid entry name triggers path traversal: \" + rawDirName);\n+                }\n+                if (!dirFile.exists() && !dirFile.mkdirs()) {\n+                    throw new IOException(\"Could not create directory \" + dirFile);\n+                }\n+                dump(dir, dirFile);\n             } else {\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n",
  "stdout": "",
  "stderr": ""
}