{
  "project_name": "lcms",
  "vulnerability_identifier": "lcms_cm-full-01_lcms-001",
  "source_directory": "/home/qqor/crete/.cache/official-afc-little-cms",
  "llm_usage": {
    "total_cost": 1.2277045000000002,
    "prompt_tokens": 893887,
    "completion_tokens": 55552
  },
  "variant": "sound",
  "diff": "--- a/src/cmsps2.c\n+++ b/src/cmsps2.c\n@@ -753,12 +753,22 @@\n static\n int EmitCIEBasedDEF(cmsIOHANDLER* m, cmsPipeline* Pipeline, cmsUInt32Number Intent, cmsCIEXYZ* BlackPoint)\n {\n+    // Validate pipeline structure: at least two stages (curve + CLUT)\n+    if (Pipeline == NULL || Pipeline->Elements == NULL || Pipeline->Elements->Next == NULL)\n+        return FALSE;\n+\n+    cmsStage* mpe0 = Pipeline->Elements;\n+    cmsStage* mpe1 = mpe0->Next;\n+    // Check stage types: first a curve, then a CLUT\n+    if (mpe0->Type != cmsSigCurveSetElemType || mpe1->Type != cmsSigCLutElemType)\n+        return FALSE;\n+\n     const char* PreMaj;\n     const char* PostMaj;\n     const char* PreMin, *PostMin;\n     cmsStage* mpe;\n         \n-    mpe = Pipeline->Elements;\n+    mpe = mpe0;\n \n     switch (cmsStageInputChannels(mpe)) {\n     case 3:\n@@ -902,9 +912,17 @@\n \n             dwFlags |= cmsFLAGS_FORCE_CLUT;\n             _cmsOptimizePipeline(m->ContextID, &DeviceLink, Intent, &InputFormat, &OutFrm, &dwFlags);\n+            \n+            // Validate optimized pipeline before emitting DEF\n+            if (DeviceLink == NULL || DeviceLink->Elements == NULL || DeviceLink->Elements->Next == NULL ||\n+                DeviceLink->Elements->Type != cmsSigCurveSetElemType || DeviceLink->Elements->Next->Type != cmsSigCLutElemType) {\n+                cmsPipelineFree(DeviceLink);\n+                cmsDeleteTransform(xform);\n+                return FALSE;\n+            }\n \n             rc = EmitCIEBasedDEF(m, DeviceLink, Intent, &BlackPointAdaptedToD50);\n-            cmsPipelineFree(DeviceLink);            \n+            cmsPipelineFree(DeviceLink);\n             if (!rc) {\n                 cmsDeleteTransform(xform);\n                 return FALSE;\n",
  "stdout": "",
  "stderr": ""
}