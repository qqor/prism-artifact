{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-04_vuln_5",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.21758440000000004,
    "prompt_tokens": 111148,
    "completion_tokens": 21664
  },
  "variant": "sound",
  "diff": "--- a/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n+++ b/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n@@ -83,11 +83,7 @@\n         if (fileExtension != null && fileExtension.length() > 0) {\n             emitKey += \".\" + fileExtension;\n         }\n-        if (basePath != null) {\n-            output = basePath.resolve(emitKey);\n-        } else {\n-            output = Paths.get(emitKey);\n-        }\n+        output = safeResolve(emitKey);\n \n         if (!Files.isDirectory(output.getParent())) {\n             Files.createDirectories(output.getParent());\n@@ -142,9 +138,28 @@\n         this.prettyPrint = prettyPrint;\n     }\n \n+    /**\n+     * Safely resolve a user-supplied path against basePath (or CWD if basePath is null),\n+     * preventing absolute paths or directory traversal attacks.\n+     */\n+    private Path safeResolve(String userPath) throws TikaEmitterException {\n+        Path relative = Paths.get(userPath);\n+        if (relative.isAbsolute()) {\n+            throw new TikaEmitterException(\"Invalid absolute path: \" + userPath);\n+        }\n+        Path root = (basePath != null\n+                ? basePath.toAbsolutePath().normalize()\n+                : Paths.get(\"\").toAbsolutePath().normalize());\n+        Path combined = root.resolve(relative).normalize();\n+        if (!combined.startsWith(root)) {\n+            throw new TikaEmitterException(\"File path traversal attempt: \" + userPath);\n+        }\n+        return combined;\n+    }\n+\n     @Override\n     public void emit(String path, InputStream inputStream, Metadata userMetadata, ParseContext parseContext) throws IOException, TikaEmitterException {\n-        Path target = basePath.resolve(path);\n+        Path target = safeResolve(path);\n \n         if (!Files.isDirectory(target.getParent())) {\n             Files.createDirectories(target.getParent());\n",
  "stdout": "",
  "stderr": ""
}