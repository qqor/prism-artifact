--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3574,8 +3574,11 @@
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
 
-        if (extraSize > buffer_size) {
-            size_t newSize = (used + extraSize) * 2;
+        if (used + extraSize > buffer_size) {
+            size_t needed = used + extraSize;
+            size_t newSize = buffer_size * 2;
+            if (newSize < needed)
+                newSize = needed * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
             if (tmp == NULL) {
@@ -3585,7 +3588,6 @@
             buffer = tmp;
             buffer_size = newSize;
         }
-
         if (chunkSize > 0) {
             input->cur += chunkSize;
             memcpy(buffer + used, chunk, chunkSize);
