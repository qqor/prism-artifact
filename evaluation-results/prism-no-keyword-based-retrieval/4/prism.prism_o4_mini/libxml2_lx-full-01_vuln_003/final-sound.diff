--- a/parser.c
+++ b/parser.c
@@ -760,6 +760,17 @@
 
 static void
 xmlSBufAddEntitySecure(xmlSBuf *buf, const xmlChar *str, unsigned len) {
+    if (str == NULL) {
+        return;
+    }
+    /* Clamp len to the actual string length to prevent overflow */
+    {
+        unsigned actual = 0;
+        while (actual < len && str[actual] != 0) {
+            actual++;
+        }
+        len = actual;
+    }
     if (buf->max - buf->size < len) {
         if (buf->code == XML_ERR_OK)
             buf->code = XML_ERR_RESOURCE_LIMIT;
