{
  "project_name": "libavif",
  "vulnerability_identifier": "libavif_av-delta-02_avif-002",
  "source_directory": "/home/qqor/crete/.cache/official-afc-libavif",
  "llm_usage": {
    "total_cost": 0.3105861,
    "prompt_tokens": 160231,
    "completion_tokens": 30530
  },
  "variant": "sound",
  "diff": "--- a/src/reformat.c\n+++ b/src/reformat.c\n@@ -796,25 +796,35 @@\n                     total_spill += fabs(spill_Cr);\n                     // if spill too high, dampen\n                     if ((image->height * image->width) >= 0x1000 && total_spill > ((image->height * image->width) * 3.8f)){\n-                        int a, b;\n-                        if (i % 2 == 0){\n-                            a = 1;\n-                        }else{\n-                            a = -1;\n-                        }\n-                        if (j % 2 == 0){\n-                            b = 1;\n-                        }else{\n-                            b = -1;\n-                        }\n+                        // Apply spill to center pixel\n                         uspill_image[i][j] -= pSpillCb;\n-                        vspill_image[i][j] -= pSpillCb;\n-                        uspill_image[i+a][j] -= pSpillCb;\n-                        vspill_image[i+a][j] -= pSpillCr;\n-                        uspill_image[i][j+b] -= pSpillCb;\n-                        vspill_image[i][j+b] -= pSpillCr;\n-                        uspill_image[i+a][j+b] -= pSpillCb;\n-                        vspill_image[i+a][j+b] -= pSpillCr;\n+                        vspill_image[i][j] -= pSpillCr;\n+                        // Determine neighbor offsets\n+                        int a = (i % 2 == 0) ? 1 : -1;\n+                        int b = (j % 2 == 0) ? 1 : -1;\n+                        // Clamp horizontal neighbor offset using unsigned-safe checks\n+                        if ((a < 0 && i == 0) || (a > 0 && i + (uint32_t)a >= image->width)) {\n+                            a = 0;\n+                        }\n+                        // Clamp vertical neighbor offset using unsigned-safe checks\n+                        if ((b < 0 && j == 0) || (b > 0 && j + (uint32_t)b >= image->height)) {\n+                            b = 0;\n+                        }\n+                        // Spill to horizontal neighbor if valid\n+                        if (a != 0) {\n+                            uspill_image[i + a][j] -= pSpillCb;\n+                            vspill_image[i + a][j] -= pSpillCr;\n+                        }\n+                        // Spill to vertical neighbor if valid\n+                        if (b != 0) {\n+                            uspill_image[i][j + b] -= pSpillCb;\n+                            vspill_image[i][j + b] -= pSpillCr;\n+                        }\n+                        // Spill to diagonal neighbor if both valid\n+                        if (a != 0 && b != 0) {\n+                            uspill_image[i + a][j + b] -= pSpillCb;\n+                            vspill_image[i + a][j + b] -= pSpillCr;\n+                        }\n                     }   \n                 }\n             }\n",
  "stdout": "",
  "stderr": ""
}