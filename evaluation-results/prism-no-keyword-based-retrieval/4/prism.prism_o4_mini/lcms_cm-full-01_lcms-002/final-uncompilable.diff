--- a/src/cmsvirt.c
+++ b/src/cmsvirt.c
@@ -1100,8 +1100,9 @@
 
     // Apply the transfor to colorants.
     for (i=0; i < nColors; i++) {
-        cmsDoTransform(xform, &i, nc2 ->List[i].DeviceColorant, 1);
-    }
+    // Per-pixel buffers: support up to cmsMAXCHANNELS channels, each up to 2 bytes
+    cmsUInt8Number In[cmsMAXCHANNELS * 2], Out[cmsMAXCHANNELS * 2];
+    cmsUInt16Number wIn[cmsMAXCHANNELS], wOut[cmsMAXCHANNELS];
 
     if (!cmsWriteTag(hICC, cmsSigNamedColor2Tag, (void*) nc2)) goto Error;
     cmsFreeNamedColorList(nc2);
