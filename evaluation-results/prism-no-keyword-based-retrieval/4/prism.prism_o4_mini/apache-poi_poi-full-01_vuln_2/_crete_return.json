{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.3372182,
    "prompt_tokens": 159082,
    "completion_tokens": 36870
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,6 +22,7 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n \n@@ -43,6 +44,19 @@\n \n     private POIFSDump() {}\n \n+    /**\n+     * Sanitizes a POIFS entry name so it cannot escape the intended dump directory.\n+     * Drops any path components, strips traversal segments, and ensures non-empty valid names.\n+     */\n+    private static String sanitizeEntryName(String rawName) {\n+        String trimmed = rawName.trim();\n+        Path p = Paths.get(trimmed);\n+        String baseName = p.getFileName().toString();\n+        if (baseName.isEmpty() || \".\".equals(baseName) || \"..\".equals(baseName)) {\n+            baseName = \"_\" + baseName;\n+        }\n+        return baseName;\n+    }\n     public static void main(String[] args) throws IOException {\n         if (args.length == 0) {\n             System.err.println(\"Must specify at least one file to dump\");\n@@ -72,7 +86,7 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                File file = new File(dumpDir, sanitizeEntryName(root.getName()));\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -105,12 +119,12 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                try (OutputStream out = Files.newOutputStream(new File(parent, sanitizeEntryName(node.getName())).toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                File file = new File(parent, sanitizeEntryName(entry.getName()));\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -121,7 +135,7 @@\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n+        File file = new File(parent, sanitizeEntryName(name));\n         if (! Files.isDirectory(file.toPath().getParent())) {\n             Files.createDirectories(file.toPath().getParent());\n         }\n",
  "stdout": "",
  "stderr": ""
}