--- a/encoding.c
+++ b/encoding.c
@@ -2846,6 +2846,7 @@
     const unsigned char *instart = in;
     const unsigned char *inend = in + (*inlen & ~1);
     unsigned char *outstart = out;
+    unsigned char *outend   = out + (*outlen);
     unsigned long int b0, b1, b2, b3, c, d;
     int ret = XML_ENC_ERR_SPACE;
 
@@ -2856,57 +2857,63 @@
 
     while (in < inend) {
         b0 = in[0];
-        b1 = in[1];
-        b1 = (b1 << 0x8);
-        b2 = in[2];
-        b2 = (b2 << 0x10);
-        b3 = in[3];
-        b3 = (b3 << 0x18);
+        b1 = (in[1] << 8);
+        b2 = (in[2] << 16);
+        b3 = (in[3] << 24);
         c = b0 | b1 | b2 | b3;
 
         if (c < 0x80) {
+            /* need 1 byte */
+            if (out + 1 > outend) {
+                ret = XML_ENC_ERR_SPACE;
+                break;
+            }
             out[0] = c;
-            in += 4;
-            out += 1;
+            in  += 4; out += 1;
         } else if (c < 0x800) {
+            /* need 2 bytes */
+            if (out + 2 > outend) {
+                ret = XML_ENC_ERR_SPACE;
+                break;
+            }
             out[0] = (c >> 6)   | 0xC0;
             out[1] = (c & 0x3F) | 0x80;
-            in += 4;
-            out += 2;
+            in  += 4; out += 2;
         } else if ((c & 0xF800) != 0xD800) {
+            /* need 3 bytes */
+            if (out + 3 > outend) {
+                ret = XML_ENC_ERR_SPACE;
+                break;
+            }
             out[0] =  (c >> 12)         | 0xE0;
             out[1] = ((c >>  6) & 0x3F) | 0x80;
             out[2] =  (c        & 0x3F) | 0x80;
-            in += 4;
-            out += 3;
+            in  += 4; out += 3;
         } else {
             /* Surrogate pair */
-            if ((c & 0xFC00) != 0xD800) {
+            if ((c & 0xFC00) != 0xD800 || inend - in < 4) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-	        if (inend - in < 4)
-		        break;
             d = in[2] | (in[3] << 8);
             if ((d & 0xFC00) != 0xDC00) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-            /*
-                simplified due to encoding errors encountered with:
-
-                c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);
-                out[0] =  (c >> 18)         | 0xF0;
-                out[1] = ((c >> 12) & 0x3F) | 0x80;
-                out[2] = ((c >>  6) & 0x3F) | 0x80;
-                out[3] =  (c        & 0x3F) | 0x80;
-            */
-            out[0] = c & 0xff;
-            out[1] = (c >> 8) & 0xff;
-            out[2] = (c >> 0x10) & 0xff;
-            out[3] = (c >> 0x18) & 0xff;
-            in += 4;
-            out += 4;
+            /* compute full code point */
+            {
+                unsigned long cp = (((c & 0x03FF) << 10) | (d & 0x03FF)) + 0x10000;
+                /* need 4 bytes */
+                if (out + 4 > outend) {
+                    ret = XML_ENC_ERR_SPACE;
+                    break;
+                }
+                out[0] = 0xF0 | ((cp >> 18) & 0x07);
+                out[1] = 0x80 | ((cp >> 12) & 0x3F);
+                out[2] = 0x80 | ((cp >>  6) & 0x3F);
+                out[3] = 0x80 | ( cp        & 0x3F);
+                in  += 4; out += 4;
+            }
         }
     }
 
