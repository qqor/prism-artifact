{
  "project_name": "libxml2",
  "vulnerability_identifier": "libxml2_lx-delta-03_vuln_004",
  "source_directory": "/home/user/crete/.cache/official-afc-libxml2",
  "llm_usage": {
    "total_cost": 0.5739921,
    "prompt_tokens": 278971,
    "completion_tokens": 60710
  },
  "variant": "sound",
  "diff": "--- a/encoding.c\n+++ b/encoding.c\n@@ -2846,6 +2846,7 @@\n     const unsigned char *instart = in;\n     const unsigned char *inend = in + (*inlen & ~1);\n     unsigned char *outstart = out;\n+    unsigned char *outend   = out + (*outlen);\n     unsigned long int b0, b1, b2, b3, c, d;\n     int ret = XML_ENC_ERR_SPACE;\n \n@@ -2856,57 +2857,63 @@\n \n     while (in < inend) {\n         b0 = in[0];\n-        b1 = in[1];\n-        b1 = (b1 << 0x8);\n-        b2 = in[2];\n-        b2 = (b2 << 0x10);\n-        b3 = in[3];\n-        b3 = (b3 << 0x18);\n+        b1 = (in[1] << 8);\n+        b2 = (in[2] << 16);\n+        b3 = (in[3] << 24);\n         c = b0 | b1 | b2 | b3;\n \n         if (c < 0x80) {\n+            /* need 1 byte */\n+            if (out + 1 > outend) {\n+                ret = XML_ENC_ERR_SPACE;\n+                break;\n+            }\n             out[0] = c;\n-            in += 4;\n-            out += 1;\n+            in  += 4; out += 1;\n         } else if (c < 0x800) {\n+            /* need 2 bytes */\n+            if (out + 2 > outend) {\n+                ret = XML_ENC_ERR_SPACE;\n+                break;\n+            }\n             out[0] = (c >> 6)   | 0xC0;\n             out[1] = (c & 0x3F) | 0x80;\n-            in += 4;\n-            out += 2;\n+            in  += 4; out += 2;\n         } else if ((c & 0xF800) != 0xD800) {\n+            /* need 3 bytes */\n+            if (out + 3 > outend) {\n+                ret = XML_ENC_ERR_SPACE;\n+                break;\n+            }\n             out[0] =  (c >> 12)         | 0xE0;\n             out[1] = ((c >>  6) & 0x3F) | 0x80;\n             out[2] =  (c        & 0x3F) | 0x80;\n-            in += 4;\n-            out += 3;\n+            in  += 4; out += 3;\n         } else {\n             /* Surrogate pair */\n-            if ((c & 0xFC00) != 0xD800) {\n+            if ((c & 0xFC00) != 0xD800 || inend - in < 4) {\n                 ret = XML_ERR_INTERNAL_ERROR;\n                 break;\n             }\n-\t        if (inend - in < 4)\n-\t\t        break;\n             d = in[2] | (in[3] << 8);\n             if ((d & 0xFC00) != 0xDC00) {\n                 ret = XML_ERR_INTERNAL_ERROR;\n                 break;\n             }\n-            /*\n-                simplified due to encoding errors encountered with:\n-\n-                c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);\n-                out[0] =  (c >> 18)         | 0xF0;\n-                out[1] = ((c >> 12) & 0x3F) | 0x80;\n-                out[2] = ((c >>  6) & 0x3F) | 0x80;\n-                out[3] =  (c        & 0x3F) | 0x80;\n-            */\n-            out[0] = c & 0xff;\n-            out[1] = (c >> 8) & 0xff;\n-            out[2] = (c >> 0x10) & 0xff;\n-            out[3] = (c >> 0x18) & 0xff;\n-            in += 4;\n-            out += 4;\n+            /* compute full code point */\n+            {\n+                unsigned long cp = (((c & 0x03FF) << 10) | (d & 0x03FF)) + 0x10000;\n+                /* need 4 bytes */\n+                if (out + 4 > outend) {\n+                    ret = XML_ENC_ERR_SPACE;\n+                    break;\n+                }\n+                out[0] = 0xF0 | ((cp >> 18) & 0x07);\n+                out[1] = 0x80 | ((cp >> 12) & 0x3F);\n+                out[2] = 0x80 | ((cp >>  6) & 0x3F);\n+                out[3] = 0x80 | ( cp        & 0x3F);\n+                in  += 4; out += 4;\n+            }\n         }\n     }\n \n",
  "stdout": "",
  "stderr": ""
}