{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-01_vuln_9",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.1556236,
    "prompt_tokens": 62252,
    "completion_tokens": 19806
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n+++ b/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n@@ -35,6 +35,7 @@\n import java.util.concurrent.TimeoutException;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n+import java.util.Arrays;\n \n import org.apache.commons.io.IOUtils;\n import org.apache.commons.io.output.NullOutputStream;\n@@ -91,6 +92,8 @@\n      * @see Runtime#exec(String[])\n      */\n     private String[] command = new String[]{\"cat\"};\n+    // Pattern to allow only safe command elements: alphanumeric, underscore, dot, slash, dash\n+    private static final Pattern SAFE_CMD = Pattern.compile(\"^[A-Za-z0-9_./\\\\\\\\-]+$\");\n     /**\n      * A consumer for ignored Lines\n      */\n@@ -224,7 +227,12 @@\n      * @see Runtime#exec(String[])\n      */\n     public void setCommand(String... command) {\n-        this.command = command;\n+        for (String c : command) {\n+            if (!SAFE_CMD.matcher(c).matches()) {\n+                throw new IllegalArgumentException(\"Invalid command element: \" + c);\n+            }\n+        }\n+        this.command = Arrays.copyOf(command, command.length);\n     }\n \n     /**\n@@ -306,15 +314,12 @@\n         }\n \n         // Execute\n-        Process process = null;\n-        try {\n-            if (cmd.length == 1) {\n-                process = Runtime.getRuntime().exec(cmd[0]);\n-            } else {\n-                process = Runtime.getRuntime().exec(cmd);\n-            }\n-        } catch (Exception e) {\n-            LOG.warn(\"problem with process exec\", e);\n+        Process process;\n+        try {\n+            process = new ProcessBuilder(cmd).start();\n+        } catch (IOException e) {\n+            LOG.warn(\"problem starting external process\", e);\n+            return;\n         }\n \n         try {\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n@@ -360,9 +360,9 @@\n             return;\n         }\n         int added = 0;\n-        if (metadata.get(\"html_meta:exiftool_path\") != null) {\n-            added = configureExifTool(metadata.get(\"html_meta:exiftool_path\"));\n-        }\n+        // Metadata-based exiftool configuration removed for security\n+        // untrusted HTML metadata cannot override external parser\n+        // added remains 0\n         //do anything with attrs?\n         Metadata m = new Metadata();\n         m.set(TikaCoreProperties.EMBEDDED_RESOURCE_TYPE,\n",
  "stdout": "",
  "stderr": ""
}