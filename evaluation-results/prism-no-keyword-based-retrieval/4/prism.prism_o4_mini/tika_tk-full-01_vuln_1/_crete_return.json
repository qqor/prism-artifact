{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_1",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.7392396,
    "prompt_tokens": 424492,
    "completion_tokens": 61886
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFParser.java\n@@ -55,6 +55,8 @@\n     private int memoryLimitInKb = EMB_OBJ_MAX_BYTES / 1024;\n     @Field\n     private boolean ignoreListMarkup = false;\n+    @Field\n+    private boolean allowEmbeddedJavaObjects = false;\n \n     public Set<MediaType> getSupportedTypes(ParseContext context) {\n         return SUPPORTED_TYPES;\n@@ -90,7 +92,7 @@\n     public void parseInline(InputStream is, ContentHandler handler, Metadata metadata, ParseContext context)\n             throws TikaException, IOException, SAXException {\n         RTFEmbObjHandler embObjHandler =\n-                new RTFEmbObjHandler(handler, metadata, context, getMemoryLimitInKb());\n+                new RTFEmbObjHandler(handler, metadata, context, getMemoryLimitInKb(), allowEmbeddedJavaObjects);\n         final TextExtractor ert = new TextExtractor(handler, metadata, embObjHandler);\n         ert.setIgnoreListMarkup(ignoreListMarkup);\n         ert.extract(is);\n@@ -112,4 +114,13 @@\n         this.memoryLimitInKb = memoryLimitInKb;\n         USE_STATIC = false;\n     }\n+\n+    @Field\n+    public void setAllowEmbeddedJavaObjects(boolean allowEmbeddedJavaObjects) {\n+        this.allowEmbeddedJavaObjects = allowEmbeddedJavaObjects;\n+    }\n+\n+    public boolean getAllowEmbeddedJavaObjects() {\n+        return allowEmbeddedJavaObjects;\n+    }\n }\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n@@ -67,6 +67,7 @@\n     private final EmbeddedDocumentUtil embeddedDocumentUtil;\n     private final UnsynchronizedByteArrayOutputStream os;\n     private final int memoryLimitInKb;\n+    private final boolean allowJavaDeserialization;\n \n     private boolean isPictBitmap = false;\n     //high hex cached for writing hexpair chars (data)\n@@ -82,11 +83,12 @@\n     private EMB_STATE state = EMB_STATE.NADA;\n \n     protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,\n-                               int memoryLimitInKb) {\n+                               int memoryLimitInKb, boolean allowJavaDeserialization) {\n         this.handler = handler;\n         this.embeddedDocumentUtil = new EmbeddedDocumentUtil(context);\n         os = UnsynchronizedByteArrayOutputStream.builder().get();\n         this.memoryLimitInKb = memoryLimitInKb;\n+        this.allowJavaDeserialization = allowJavaDeserialization;\n     }\n \n     protected void startPict() {\n@@ -211,16 +213,22 @@\n             extractObj(bytes, handler, metadata);\n \n         } else if (state == EMB_STATE.JAVA_OBJDATA) {\n-            try {\n-                Object obj = new ObjectInputStream(\n-                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n-                                .get()).readObject();\n-                metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());\n-                metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,\n-                        MediaType.text(\"plain\").toString());\n-                extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);\n-            } catch (ClassNotFoundException e) {\n-                throw new TikaException(\"Not found\", e);\n+            if (!allowJavaDeserialization) {\n+                TikaException e = new TikaException(\n+                        \"Embedded Java object deserialization is disabled for security\");\n+                EmbeddedDocumentUtil.recordException(e, metadata);\n+            } else {\n+                try {\n+                    Object obj = new ObjectInputStream(\n+                            UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n+                                    .get()).readObject();\n+                    metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());\n+                    metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,\n+                            MediaType.text(\"plain\").toString());\n+                    extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);\n+                } catch (ClassNotFoundException e) {\n+                    throw new TikaException(\"Not found\", e);\n+                }\n             }\n         } else if (state == EMB_STATE.NADA) {\n             //swallow...no start for pict or embed?!\n",
  "stdout": "",
  "stderr": ""
}