--- a/libexif/exif-data.c
+++ b/libexif/exif-data.c
@@ -162,76 +162,89 @@
 
 static int
 exif_data_load_data_entry (ExifData *data, ExifEntry *entry,
-			   const unsigned char *d,
-			   unsigned int size, unsigned int offset)
-{
-	unsigned int s, doff;
-
-	entry->tag        = exif_get_short (d + offset + 0, data->priv->order);
-	entry->format     = exif_get_short (d + offset + 2, data->priv->order);
-	entry->components = exif_get_long  (d + offset + 4, data->priv->order);
+                           const unsigned char *d,
+                           unsigned int size, unsigned int offset)
+{
+    unsigned int unit, s, data_offset;
+
+    /* Prevent invalid buffer or header read */
+    if (!d || CHECKOVERFLOW(offset, size, 12))
+        return 0;
 
 	/* FIXME: should use exif_tag_get_name_in_ifd here but entry->parent 
 	 * has not been set yet
 	 */
-	exif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
-		  "Loading entry 0x%x ('%s')...", entry->tag,
-		  exif_tag_get_name (entry->tag));
+    {
+        const char *tag_name = exif_tag_get_name(entry->tag);
+        if (!tag_name) tag_name = "(unknown)";
+        exif_log(data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
+                 "Loading entry 0x%x ('%s')...",
+                 entry->tag, tag_name);
+    }
 
 	/* {0,1,2,4,8} x { 0x00000000 .. 0xffffffff } 
 	 *   -> { 0x000000000 .. 0x7fffffff8 } */
-	s = exif_format_get_size(entry->format) * entry->components;
-	if ((s < entry->components) || (s == 0)){
-		return 0;
-	}
+    unit = exif_format_get_size(entry->format);
+    if (unit == 0)
+        return 0;
+    if (entry->components > 0 && unit > UINT_MAX / entry->components)
+        return 0;
+    s = unit * entry->components;
+    if (s == 0)
+        return 0;
 
 	/*
 	 * Size? If bigger than 4 bytes, the actual data is not
 	 * in the entry but somewhere else (offset).
 	 */
-	if (s > 4)
-		doff = exif_get_long (d + offset + 8, data->priv->order);
-	else
-		doff = offset + 8;
-
-	/* Sanity checks */
-	if (doff >= size) {
-		exif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
-				  "Tag starts past end of buffer (%u > %u)", doff, size);
+    if (s <= 4) {
+        /* Inline data */
+        if (CHECKOVERFLOW(offset + 8, size, s))
+            return 0;
+        data_offset = offset + 8;
+    } else {
+        /* External data pointer */
+        if (CHECKOVERFLOW(offset, size, 12))
+            return 0;
+        data_offset = exif_get_long(d + offset + 8, data->priv->order);
+    }
+
+    /* Ensure data block fits */
+    if (CHECKOVERFLOW(data_offset, size, s)) {
+        exif_log(data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
+                 "Tag data overruns buffer (%u + %u > %u)",
+                 data_offset, s, size);
+        return 0;
+    }
 		return 0;
 	}
 
-	if (s > size - doff) {
-		exif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
-				  "Tag data goes past end of buffer (%u > %u)", doff+s, size);
-		return 0;
-	}
-
-	entry->data = exif_data_alloc (data, s);
-	if (entry->data) {
-		entry->size = s;
-		memcpy (entry->data, d + doff, s);
-	} else {
+    entry->data = exif_data_alloc(data, s);
+    if (!entry->data) {
+        EXIF_LOG_NO_MEMORY(data->priv->log, "ExifData", s);
+        return 0;
+    }
+    entry->size = s;
+    memcpy(entry->data, d + data_offset, s);
 		EXIF_LOG_NO_MEMORY(data->priv->log, "ExifData", s);
 		return 0;
 	}
 
-	/* If this is the MakerNote, remember the offset */
-	if (entry->tag == EXIF_TAG_MAKER_NOTE) {
-		if (!entry->data) {
-			exif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
-					  "MakerNote found with empty data");	
-		} else if (entry->size > 6) {
-			exif_log (data->priv->log,
-					       EXIF_LOG_CODE_DEBUG, "ExifData",
-					       "MakerNote found (%02x %02x %02x %02x "
-					       "%02x %02x %02x...).",
-					       entry->data[0], entry->data[1], entry->data[2],
-					       entry->data[3], entry->data[4], entry->data[5],
-					       entry->data[6]);
-		}
-		data->priv->offset_mnote = doff;
-	}
+    /* If this is the MakerNote, remember the offset */
+    if (entry->tag == EXIF_TAG_MAKER_NOTE) {
+        if (entry->size == 0) {
+            exif_log(data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
+                     "MakerNote found with empty data");
+        } else if (entry->size > 6) {
+            exif_log(data->priv->log, EXIF_LOG_CODE_DEBUG, "ExifData",
+                     "MakerNote found (%02x %02x %02x %02x "
+                     "%02x %02x %02x...).",
+                     entry->data[0], entry->data[1], entry->data[2],
+                     entry->data[3], entry->data[4], entry->data[5],
+                     entry->data[6]);
+        }
+        data->priv->offset_mnote = data_offset;
+    }
 	return 1;
 }
 
@@ -528,9 +541,11 @@
                                           "Could not allocate memory");
 				  return;
 			}
-			if (exif_data_load_data_entry (data, entry, d, ds,
-						   offset + 12 * i))
-				exif_content_add_entry (data->ifd[ifd], entry);
+            if (!exif_data_load_data_entry(data, entry, d, ds, offset + 12 * i)) {
+                exif_entry_unref(entry);
+                break;
+            }
+            exif_content_add_entry(data->ifd[ifd], entry);
 			exif_entry_unref (entry);
 			break;
 		}
