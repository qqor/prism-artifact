{
  "project_name": "wireshark",
  "vulnerability_identifier": "wireshark_ws-delta-04_vuln_007",
  "source_directory": "/home/user/crete/.cache/official-afc-wireshark",
  "llm_usage": {
    "total_cost": 0.5177700000000001,
    "prompt_tokens": 274944,
    "completion_tokens": 48939
  },
  "variant": "sound",
  "diff": "--- a/epan/dissectors/packet-json.c\n+++ b/epan/dissectors/packet-json.c\n@@ -261,155 +261,79 @@\n \t\t\t}\n \t\t\telse if (current_character == 'U')\n \t\t\t{\n+\t\t\t\tsize_t escape_start = read_index;\n+\t\t\t\t// Consume the 'U'\n \t\t\t\tread_index++;\n-\t\t\t\t\n+\n \t\t\t\tuint32_t code_point = 0;\n \t\t\t\tbool is_valid_unicode_character = true;\n-\t\n-\t\t\t\tfor (int i = 0; i < 8; i++)\n-\t\t\t\t{\n-\t\t\t\t\t// Do not overflow input string\n-\t\t\t\t\tif (!(read_index < string_length))\n-\t\t\t\t\t{\n+\n+\t\t\t\t// Parse first 8 hex digits of \\UXXXXXXXX\n+\t\t\t\tfor (int i = 0; i < 8; i++) {\n+\t\t\t\t\tif (read_index >= string_length) {\n \t\t\t\t\t\tis_valid_unicode_character = false;\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n-\t\n-\t\t\t\t\tcurrent_character = string[read_index];\n-\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\tint nibble = ws_xton(current_character);\n-\t\n-\t\t\t\t\tif(nibble < 0)\n-\t\t\t\t\t{\n+\t\t\t\t\tint nibble = ws_xton(string[read_index]);\n+\t\t\t\t\tif (nibble < 0) {\n \t\t\t\t\t\tis_valid_unicode_character = false;\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n-\t\n-\t\t\t\t\tcode_point <<= 4;\n-\t\t\t\t\tcode_point |= nibble;\n+\t\t\t\t\tcode_point = (code_point << 4) | nibble;\n+\t\t\t\t\tread_index++;\n \t\t\t\t}\n-\t\n-\t\t\t\tif ((IS_LEAD_SURROGATE(code_point)))\n-\t\t\t\t{\n-\t\t\t\t\t// Do not overflow input string\n-\t\t\t\t\tif (!(read_index < string_length))\n-\t\t\t\t\t{\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\t}\n-\t\t\t\t\tcurrent_character = string[read_index];\n-\t\n-\t\t\t\t\tif (current_character == '\\\\')\n-\t\t\t\t\t{\n-\t\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\t\t// Do not overflow input string\n-\t\t\t\t\t\tif (!(read_index < string_length))\n-\t\t\t\t\t\t{\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\t\n-\t\t\t\t\t\tcurrent_character = string[read_index];\n-\t\t\t\t\t\tif (current_character == 'u') {\n-\t\t\t\t\t\t\tuint16_t lead_surrogate = code_point;\n-\t\t\t\t\t\t\tuint16_t trail_surrogate = 0;\n-\t\n-\t\t\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\t\t\tfor (int i = 0; i < 4; i++)\n-\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\t// Do not overflow input string\n-\t\t\t\t\t\t\t\tif (!(read_index < string_length))\n-\t\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\t\tis_valid_unicode_character = false;\n+\n+\t\t\t\tif (!is_valid_unicode_character) {\n+\t\t\t\t\t// Roll back on invalid or truncated sequence\n+\t\t\t\t\tread_index = escape_start;\n+\t\t\t\t\twmem_strbuf_append_c(output_string_buffer, '\\\\');\n+\t\t\t\t\twmem_strbuf_append_c(output_string_buffer, 'U');\n+\t\t\t\t} else {\n+\t\t\t\t\t// Handle surrogate pairs if necessary\n+\t\t\t\t\tif (IS_LEAD_SURROGATE(code_point)) {\n+\t\t\t\t\t\t// Expect trailing \\UXXXXXXXX for full surrogate pair\n+\t\t\t\t\t\tif (read_index + 9 < string_length &&\n+\t\t\t\t\t\t    string[read_index] == '\\\\' && string[read_index+1] == 'U') {\n+\t\t\t\t\t\t\tread_index += 2;\n+\t\t\t\t\t\t\tuint32_t trail_cp = 0;\n+\t\t\t\t\t\t\tbool valid_trail = true;\n+\t\t\t\t\t\t\tfor (int j = 0; j < 8; j++) {\n+\t\t\t\t\t\t\t\tif (read_index >= string_length) {\n+\t\t\t\t\t\t\t\t\tvalid_trail = false;\n \t\t\t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\t\t\t}\n-\t\n-\t\t\t\t\t\t\t\tcurrent_character = string[read_index];\n-\t\t\t\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\t\t\t\tint nibble = ws_xton(current_character);\n-\t\n-\t\t\t\t\t\t\t\tif (nibble < 0)\n-\t\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\t\tis_valid_unicode_character = false;\n+\t\t\t\t\t\t\t\tint nib = ws_xton(string[read_index]);\n+\t\t\t\t\t\t\t\tif (nib < 0) {\n+\t\t\t\t\t\t\t\t\tvalid_trail = false;\n \t\t\t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\t\t\t}\n-\t\n-\t\t\t\t\t\t\t\ttrail_surrogate <<= 4;\n-\t\t\t\t\t\t\t\ttrail_surrogate |= nibble;\n+\t\t\t\t\t\t\t\ttrail_cp = (trail_cp << 4) | nib;\n+\t\t\t\t\t\t\t\tread_index++;\n \t\t\t\t\t\t\t}\n-\t\n-\t\t\t\t\t\t\tif ((IS_TRAIL_SURROGATE(trail_surrogate)))\n-\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\tcode_point = SURROGATE_VALUE(lead_surrogate, trail_surrogate);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\telse\n-\t\t\t\t\t\t\t{\n+\t\t\t\t\t\t\tif (valid_trail && IS_TRAIL_SURROGATE(trail_cp)) {\n+\t\t\t\t\t\t\t\tcode_point = SURROGATE_VALUE((uint16_t)code_point, (uint16_t)trail_cp);\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t// Roll back to before trailing sequence\n+\t\t\t\t\t\t\t\tread_index = escape_start + 1;\n \t\t\t\t\t\t\t\tis_valid_unicode_character = false;\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\telse if (current_character == 'U') {\n-\t\t\t\t\t\t\tuint16_t lead_surrogate = code_point;\n-\t\t\t\t\t\t\tuint16_t trail_surrogate = 0;\n-\t\n-\t\t\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\t\t\tfor (int i = 0; i < 8; i++)\n-\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\tcurrent_character = string[read_index];\n-\t\t\t\t\t\t\t\tread_index++;\n-\t\n-\t\t\t\t\t\t\t\tint nibble = ws_xton(current_character);\n-\t\n-\t\t\t\t\t\t\t\ttrail_surrogate <<= 4;\n-\t\t\t\t\t\t\t\ttrail_surrogate |= nibble;\n-\t\t\t\t\t\t\t}\n-\t\n-\t\t\t\t\t\t\tif ((IS_TRAIL_SURROGATE(trail_surrogate)))\n-\t\t\t\t\t\t\t{\t\n-\t\t\t\t\t\t\t\tcode_point = SURROGATE_VALUE(lead_surrogate, trail_surrogate);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\telse\n-\t\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t\tis_valid_unicode_character = false;\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\telse\n-\t\t\t\t\t\t{\n-\t\t\t\t\t\t\tread_index++;\n+\t\t\t\t\t\t} else {\n \t\t\t\t\t\t\tis_valid_unicode_character = false;\n \t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\telse\n-\t\t\t\t\t{\n-\t\t\t\t\t\tread_index++;\n+\t\t\t\t\t} else if (IS_TRAIL_SURROGATE(code_point)) {\n \t\t\t\t\t\tis_valid_unicode_character = false;\n \t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\telse if ((IS_TRAIL_SURROGATE(code_point)))\n-\t\t\t\t{\n-\t\t\t\t\tis_valid_unicode_character = false;\n-\t\t\t\t}\n-\n-\t\t\t\tif (is_valid_unicode_character)\n-\t\t\t\t{\n-\t\t\t\t\tif (g_unichar_validate(code_point) && g_unichar_isprint(code_point))\n-\t\t\t\t\t{\n-\t\t\t\t\t\tchar length_test_buffer[6];\n-\t\t\t\t\t\tint utf8_character_length = (int)g_unichar_to_utf8(code_point, length_test_buffer);\n-\t\n-\t\t\t\t\t\tfor (int i = 0; i < utf8_character_length; i++)\n-\t\t\t\t\t\t{\n-\t\t\t\t\t\t\tcurrent_character = length_test_buffer[i];\n-\t\t\t\t\t\t\twmem_strbuf_append_c(output_string_buffer, current_character);\n+\n+\t\t\t\t\tif (is_valid_unicode_character &&\n+\t\t\t\t\t    g_unichar_validate(code_point) && g_unichar_isprint(code_point)) {\n+\t\t\t\t\t\tchar buf[6];\n+\t\t\t\t\t\tint len = (int)g_unichar_to_utf8(code_point, buf);\n+\t\t\t\t\t\tfor (int k = 0; k < len; k++) {\n+\t\t\t\t\t\t\twmem_strbuf_append_c(output_string_buffer, buf[k]);\n \t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\twmem_strbuf_append_unichar_repl(output_string_buffer);\n \t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\telse\n-\t\t\t\t{\n-\t\t\t\t\twmem_strbuf_append_unichar_repl(output_string_buffer);\n \t\t\t\t}\n \t\t\t}\n \t\t\telse if (current_character == 'u')\n",
  "stdout": "",
  "stderr": ""
}