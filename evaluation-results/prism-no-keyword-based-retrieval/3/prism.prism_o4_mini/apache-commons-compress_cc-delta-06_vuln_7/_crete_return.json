{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-06_vuln_7",
  "source_directory": "/home/user/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 0.5115440000000001,
    "prompt_tokens": 172076,
    "completion_tokens": 73241
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/archivers/ArchiveEntry.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/ArchiveEntry.java\n@@ -20,8 +20,11 @@\n \n import java.io.IOException;\n import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Objects;\n+import java.util.List;\n+import java.util.ArrayList;\n import java.util.Date;\n-\n /**\n  * An entry of an archive.\n  */\n@@ -73,12 +76,66 @@\n      * @since 1.26.0\n      */\n     default Path resolveIn(final Path parentPath) throws IOException {\n+        Objects.requireNonNull(parentPath, \"parentPath must not be null\");\n         final String name = getName();\n-        final Path outputFile = parentPath.resolve(name).normalize();\n-        if (!outputFile.startsWith(parentPath)) {\n-            throw new IOException(String.format(\"Zip slip '%s' + '%s' -> '%s'\", parentPath, name, outputFile));\n+        // Normalize separators and strip leading slashes\n+        String cleaned = name.replace('\\\\', '/').replaceFirst(\"^/+\", \"\");\n+        // Split into segments and validate each\n+        String[] segments = cleaned.split(\"/\");\n+        List<String> safeSegments = new ArrayList<>();\n+        for (int i = 0; i < segments.length; i++) {\n+            String seg = segments[i];\n+            if (seg.isEmpty() || seg.equals(\".\")) {\n+                continue;\n+            }\n+            // Percent-decode segment\n+            StringBuilder sb = new StringBuilder();\n+            for (int idx = 0; idx < seg.length(); idx++) {\n+                char c = seg.charAt(idx);\n+                if (c == '%' && idx + 2 < seg.length()) {\n+                    String hex = seg.substring(idx + 1, idx + 3);\n+                    try {\n+                        int val = Integer.parseInt(hex, 16);\n+                        sb.append((char) val);\n+                        idx += 2;\n+                    } catch (NumberFormatException e) {\n+                        throw new IOException(\"Invalid percent-encoding in entry name: \" + name);\n+                    }\n+                } else if (c == '%') {\n+                    throw new IOException(\"Invalid percent-encoding in entry name: \" + name);\n+                } else {\n+                    sb.append(c);\n+                }\n+            }\n+            String decoded = sb.toString();\n+            if (\"..\".equals(decoded)) {\n+                throw new IOException(\"Zip slip detected: entry name contains '..': \" + name);\n+            }\n+            if (i == 0 && decoded.matches(\"(?i)^[A-Za-z]:$\")) {\n+                throw new IOException(\"Zip slip detected: drive-letter segment in entry name: \" + name);\n+            }\n+            safeSegments.add(decoded);\n         }\n-        return outputFile;\n+        // Reconstruct relative path\n+        Path rel;\n+        if (safeSegments.isEmpty()) {\n+            rel = Paths.get(\"\");\n+        } else {\n+            rel = Paths.get(safeSegments.get(0),\n+                    safeSegments.subList(1, safeSegments.size()).toArray(new String[0]));\n+        }\n+        rel = rel.normalize();\n+        if (rel.isAbsolute() || rel.startsWith(\"..\")) {\n+            throw new IOException(String.format(\n+                    \"Zip slip detected: parent=%s, entry=%s, normalized=%s\",\n+                    parentPath, name, rel));\n+        }\n+        Path resolved = parentPath.resolve(rel).normalize();\n+        if (!resolved.startsWith(parentPath.normalize())) {\n+            throw new IOException(String.format(\n+                    \"Zip slip detected: parent=%s, entry=%s, resolved=%s\",\n+                    parentPath, name, resolved));\n+        }\n+        return resolved;\n     }\n-\n }\n\n--- a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n@@ -83,6 +83,12 @@\n                 if (nullTarget) {\n                     writer.accept(nextEntry, NullOutputStream.INSTANCE);\n                 } else {\n+                    Files.createDirectories(targetPath.getParent());\n+                    // Defense-in-depth: ensure the resolved path stays within the base directory\n+                    Path normalizedTarget = targetPath.normalize();\n+                    if (!normalizedTarget.startsWith(targetDirPath)) {\n+                        throw new IOException(\"Resolved path escapes target directory: \" + normalizedTarget);\n+                    }\n                     try (OutputStream outputStream = Files.newOutputStream(targetPath)) {\n                         writer.accept(nextEntry, outputStream);\n                     }\n",
  "stdout": "",
  "stderr": ""
}