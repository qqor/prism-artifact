{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_3",
  "source_directory": "/home/qqor/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.6125812000000002,
    "prompt_tokens": 372940,
    "completion_tokens": 45988
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java\n@@ -276,6 +276,17 @@\n         }\n         if (rebuildTrailer)\n         {\n+            // fast-fail on clearly non-PDF inputs to avoid expensive brute-force\n+            long savedPos = source.getPosition();\n+            source.seek(0);\n+            byte[] headerBytes = new byte[5];\n+            int read = source.read(headerBytes);\n+            source.seek(savedPos);\n+            String header = new String(headerBytes, java.nio.charset.StandardCharsets.US_ASCII);\n+            if (read == 5 && !header.startsWith(\"%PDF-\"))\n+            {\n+                throw new IOException(\"Invalid PDF header: cannot reconstruct trailer in lenient mode\");\n+            }\n             // reset cross reference table\n             xrefTable.clear();\n             trailer = getBruteForceParser().rebuildTrailer(xrefTable);\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BruteForceParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BruteForceParser.java\n@@ -131,6 +131,9 @@\n      */\n     private void bfSearchForObjects() throws IOException\n     {\n+        // cap brute-force operations to avoid unbounded loops on random data\n+        final long MAX_OPS = Long.getLong(\"pdfbox.bruteforce.maxOps\", 10000000L);\n+        long opCount = 0L;\n         long lastEOFMarker = bfSearchForLastEOFMarker();\n         long originOffset = source.getPosition();\n         long currentOffset = MINIMUM_SEARCH_OFFSET;\n@@ -142,6 +145,11 @@\n         boolean endOfObjFound = false;\n         do\n         {\n+            // increment brute-force op counter and enforce limit\n+            if (++opCount > MAX_OPS)\n+            {\n+                throw new IOException(\"Brute-force search exceeded max operations: \" + opCount);\n+            }\n             source.seek(currentOffset);\n             int nextChar = source.read();\n             currentOffset++;\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n@@ -52,6 +52,8 @@\n     private final ByteBuffer buffer;\n     private Token aheadToken;\n     private int openParens = 0;\n+    private static final long MAX_TOKENS = Long.getLong(\"pdfbox.type1.maxTokens\", 100000L);\n+    private long tokenCount = 0;\n \n     /**\n      * Constructs a new Type1Lexer given a header-less .pfb segment.\n@@ -116,6 +118,10 @@\n      */\n     private Token readToken(Token prevToken) throws IOException\n     {\n+        if (++tokenCount > MAX_TOKENS)\n+        {\n+            throw new IOException(\"Type1 font parsing exceeded max tokens: \" + tokenCount);\n+        }\n         boolean skip;\n         do\n         {\n",
  "stdout": "",
  "stderr": ""
}