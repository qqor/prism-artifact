--- a/src/fmt.c
+++ b/src/fmt.c
@@ -315,16 +315,50 @@
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+          char mantbuf[64];
+          char expbuf[16];
           double d = va_arg(*ap, double);
-          int64_t exponent = (int64_t)log10(my_fabs(d));
+          /* fast path for zero, NaN, and infinity */
+          if (d == 0.0 || xisnan(d) || xisinf(d)) {
+              k = mg_dtoa(mantbuf, sizeof(mantbuf), d, (int)pr, c == 'e');
+              n += scpy(out, param, mantbuf, k);
+              out(c, param); n++;
+              expbuf[0] = '+';
+              expbuf[1] = '0';
+              expbuf[2] = '0';
+              n += scpy(out, param, expbuf, 3);
+              continue;
+          }
+          if (pr == ~0U) pr = 6;
+          int exponent = (int)floor(log10(my_fabs(d)));
           double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
-          n += scpy(out, param, tmp, k);
-          out(c, param);
-          n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
-          n += scpy(out, param, tmp, k);
+          /* format mantissa */
+          k = mg_dtoa(mantbuf, sizeof(mantbuf), mantissa, (int)pr, c == 'e');
+          n += scpy(out, param, mantbuf, k);
+          out(c, param); n++;
+          /* inline, bounded exponent formatting */
+          {
+              char *p = expbuf;
+              int e = exponent;
+              if (e < 0) {
+                  *p++ = '-';
+                  e = -e;
+              } else {
+                  *p++ = '+';
+              }
+              char tmp2[8];
+              int td = 0;
+              unsigned x = (unsigned)e;
+              do {
+                  tmp2[td++] = '0' + (x % 10);
+                  x /= 10;
+              } while (x && td < (int)sizeof(tmp2));
+              if (td < 2) tmp2[td++] = '0';
+              while (td-- > 0) {
+                  *p++ = tmp2[td];
+              }
+              n += scpy(out, param, expbuf, (size_t)(p - expbuf));
+          }
 	  } else if (c == '%') {
         out('%', param);
         n++;
