{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.4003087000000001,
    "prompt_tokens": 161901,
    "completion_tokens": 50504
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,6 +22,7 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n \n@@ -65,13 +66,13 @@\n                 continue;\n             }\n \n-            try (InputStream is = Files.newInputStream(Paths.get(filename));\n+            Path inputPath = Paths.get(filename);\n+            try (InputStream is = Files.newInputStream(inputPath);\n                  POIFSFileSystem fs = new POIFSFileSystem(is)) {\n                 DirectoryEntry root = fs.getRoot();\n-                String filenameWithoutPath = new File(filename).getName();\n-                File dumpDir =\n-                        Paths.get(filename).getParent()\n-                                .resolve(filenameWithoutPath + \"_dump\").toFile();\n+                String filenameWithoutPath = inputPath.getFileName().toString();\n+                Path dumpDirPath = inputPath.getParent().resolve(filenameWithoutPath + \"_dump\");\n+                File dumpDir = dumpDirPath.toFile();\n                 File file = new File(dumpDir, root.getName());\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n@@ -99,33 +100,47 @@\n     public static void dump(DirectoryEntry root, File parent) throws IOException {\n         for(Iterator<Entry> it = root.getEntries(); it.hasNext();){\n             Entry entry = it.next();\n-            if(entry instanceof DocumentNode){\n+            if (entry instanceof DocumentNode) {\n                 final DocumentNode node = (DocumentNode) entry;\n                 final byte[] bytes;\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n-                   bytes = IOUtils.toByteArray(is);\n+                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                String entryName = node.getName().trim();\n+                Path baseDir = parent.toPath();\n+                Path target = baseDir.resolve(entryName).normalize();\n+                if (!target.startsWith(baseDir)) {\n+                    throw new IOException(\"Invalid entry name (traversal detected): \" + entryName);\n+                }\n+                Files.createDirectories(target.getParent());\n+                try (OutputStream out = Files.newOutputStream(target)) {\n                     out.write(bytes);\n                 }\n-            } else if (entry instanceof DirectoryEntry){\n-                DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n+            } else if (entry instanceof DirectoryEntry) {\n+                DirectoryEntry dir = (DirectoryEntry) entry;\n+                String dirName = entry.getName();\n+                Path baseDir = parent.toPath();\n+                Path targetDir = baseDir.resolve(dirName).normalize();\n+                if (!targetDir.startsWith(baseDir)) {\n+                    throw new IOException(\"Invalid directory name (traversal detected): \" + dirName);\n                 }\n-                dump(dir, file);\n+                Files.createDirectories(targetDir);\n+                dump(dir, targetDir.toFile());\n             } else {\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n-        if (! Files.isDirectory(file.toPath().getParent())) {\n-            Files.createDirectories(file.toPath().getParent());\n+        Path baseDir = parent.toPath();\n+        Path target = baseDir.resolve(name).normalize();\n+        if (!target.startsWith(baseDir)) {\n+            throw new IOException(\"Invalid name in POIFS stream (traversal detected): \" + name);\n         }\n-        try (OutputStream out = Files.newOutputStream(file.toPath())) {\n+        if (!Files.isDirectory(target.getParent())) {\n+            Files.createDirectories(target.getParent());\n+        }\n+        try (OutputStream out = Files.newOutputStream(target)) {\n             POIFSStream stream = new POIFSStream(fs, startBlock);\n \n             byte[] b = IOUtils.safelyAllocate(fs.getBigBlockSize(), POIFSFileSystem.getMaxRecordLength());\n\n--- a/poi/src/main/java/org/apache/poi/util/GenericRecordUtil.java\n+++ b/poi/src/main/java/org/apache/poi/util/GenericRecordUtil.java\n@@ -126,10 +126,11 @@\n         for (int i=0; i<vals.length && vals[i] != null; i++) {\n             assert(sups[i] != null);\n             if (\"base\".equals(vals[i])) {\n-                Object baseMap = sups[i].get();\n-                assert(baseMap instanceof Map);\n-                //noinspection unchecked\n-                m.putAll((Map<String,Supplier<?>>)baseMap);\n+                Object baseMapObject = sups[i].get();\n+                assert(baseMapObject instanceof Map);\n+                @SuppressWarnings(\"unchecked\")\n+                Map<String, Supplier<?>> baseMap = (Map<String, Supplier<?>>) baseMapObject;\n+                m.putAll(baseMap);\n             } else {\n                 m.put(vals[i], sups[i]);\n             }\n",
  "stdout": "",
  "stderr": ""
}