--- a/lib/doh.h
+++ b/lib/doh.h
@@ -31,8 +31,8 @@
 #endif
 
 #ifndef CURL_DISABLE_DOH
-
-typedef enum {
+/* Guard for valid DoH context */
+#define DOH_PROBES_MAGIC 0xD0F1FEA5
   DOH_OK,
   DOH_DNS_BAD_LABEL,    /* 1 */
   DOH_DNS_OUT_OF_RANGE, /* 2 */
@@ -87,11 +87,12 @@
   /* AFTER all slot definitions, establish how many we have */
   DOH_SLOT_COUNT
 };
-
+/* per-request DoH context, guarded by magic */
 struct doh_probes {
+  unsigned int magic;             /* must be DOH_PROBES_MAGIC */
   struct curl_slist *req_hds;
   struct doh_probe probe[DOH_SLOT_COUNT];
-  unsigned int pending; /* still outstanding probes */
+  unsigned int pending;           /* still outstanding probes */
   int port;
   const char *host;
 };

--- a/lib/doh.c
+++ b/lib/doh.c
@@ -117,7 +117,7 @@
   size_t expected_len;
   DEBUGASSERT(hostlen);
   expected_len = 12 + 1 + hostlen + 4;
-  if(host[hostlen-1]!='.')
+  if(host[hostlen-1] != '.')
     expected_len++;
 
   if(expected_len > (256 + 16)) /* RFCs 1034, 1035 */
@@ -1402,7 +1402,8 @@
 void Curl_doh_close(struct Curl_easy *data)
 {
   struct doh_probes *doh = data->req.doh;
-  if(doh && data->multi) {
+  if(!doh || doh->magic != DOH_PROBES_MAGIC || !data->multi)
+    return;
     struct Curl_easy *probe_data;
     curl_off_t mid;
     size_t slot;
@@ -1425,17 +1426,22 @@
       curl_multi_remove_handle(data->multi, probe_data);
       Curl_close(&probe_data);
     }
-  }
+/* removed obsolete closing brace */
 }
 
 void Curl_doh_cleanup(struct Curl_easy *data)
 {
   struct doh_probes *doh = data->req.doh;
-  if(doh) {
-    Curl_doh_close(data);
-    curl_slist_free_all(doh->req_hds);
-    data->req.doh->req_hds = NULL;
-    Curl_safefree(data->req.doh);
+  if(!doh || doh->magic != DOH_PROBES_MAGIC)
+    return;
+  /* close any remaining DoH transfers */
+  Curl_doh_close(data);
+  curl_slist_free_all(doh->req_hds);
+  doh->req_hds = NULL;
+  /* clear magic and free context */
+  doh->magic = 0;
+  Curl_safefree(data->req.doh);
+  data->req.doh = NULL;
   }
 }
 
