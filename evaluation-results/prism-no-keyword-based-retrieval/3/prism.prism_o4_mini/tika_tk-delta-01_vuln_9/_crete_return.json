{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-01_vuln_9",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.4849735,
    "prompt_tokens": 227313,
    "completion_tokens": 53393
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n+++ b/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n@@ -22,6 +22,8 @@\n import java.io.File;\n import java.io.FileInputStream;\n import java.io.IOException;\n+import java.util.regex.Pattern;\n+import org.apache.tika.exception.TikaException;\n import java.io.InputStream;\n import java.io.InputStreamReader;\n import java.io.OutputStream;\n@@ -286,22 +288,21 @@\n         File output = null;\n \n         // Build our command\n-        String[] cmd;\n-        if (command.length == 1) {\n-            cmd = command[0].split(\" \");\n-        } else {\n-            cmd = new String[command.length];\n-            System.arraycopy(command, 0, cmd, 0, command.length);\n-        }\n+        String[] cmd = new String[command.length];\n+        System.arraycopy(command, 0, cmd, 0, command.length);\n+        // validate and replace input and output file tokens in one pass\n         for (int i = 0; i < cmd.length; i++) {\n-            if (cmd[i].contains(INPUT_FILE_TOKEN)) {\n-                cmd[i] = cmd[i].replace(INPUT_FILE_TOKEN, stream.getFile().getPath());\n+            String token = cmd[i];\n+            if (token == null || token.length() > 256 || !Pattern.matches(\"[A-Za-z0-9_./\\\\\\\\-]+\", token)) {\n+                throw new TikaException(\"Invalid external command token: \" + token);\n+            }\n+            if (token.contains(INPUT_FILE_TOKEN)) {\n+                cmd[i] = token.replace(INPUT_FILE_TOKEN, stream.getFile().getPath());\n                 inputToStdIn = false;\n-            }\n-            if (cmd[i].contains(OUTPUT_FILE_TOKEN)) {\n+            } else if (token.contains(OUTPUT_FILE_TOKEN)) {\n                 output = tmp.createTemporaryFile();\n                 outputFromStdOut = false;\n-                cmd[i] = cmd[i].replace(OUTPUT_FILE_TOKEN, output.getPath());\n+                cmd[i] = token.replace(OUTPUT_FILE_TOKEN, output.getPath());\n             }\n         }\n \n",
  "stdout": "",
  "stderr": ""
}