--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3574,8 +3574,20 @@
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
 
-        if (extraSize > buffer_size) {
-            size_t newSize = (used + extraSize) * 2;
+        size_t needed = used + extraSize;
+        if (maxLength > 0 && needed > (size_t)maxLength) {
+            xmlCtxtErr(ctxt, NULL,
+                       XML_FROM_HTML,
+                       XML_ERR_COMMENT_NOT_FINISHED,
+                       XML_ERR_ERROR,
+                       NULL, NULL, NULL,
+                       0,
+                       "Comment exceeds maximum allowed length",
+                       NULL);
+            goto error;
+        }
+        if (needed > buffer_size) {
+            size_t newSize = needed * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
             if (tmp == NULL) {
