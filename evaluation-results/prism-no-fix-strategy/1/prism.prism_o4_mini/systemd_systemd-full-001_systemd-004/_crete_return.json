{
  "project_name": "systemd",
  "vulnerability_identifier": "systemd_systemd-full-001_systemd-004",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-systemd",
  "llm_usage": {
    "total_cost": 1.9348758,
    "prompt_tokens": 1404798,
    "completion_tokens": 88545
  },
  "variant": "vulnerable",
  "diff": "--- a/src/shared/condition.c\n+++ b/src/shared/condition.c\n@@ -1264,52 +1264,100 @@\n }\n \n bool condition_test_list(\n-                Condition *first,\n-                char **env,\n-                condition_to_string_t to_string,\n-                condition_test_logger_t logger,\n-                void *userdata) {\n-\n-        int triggered = -1;\n-\n-        /* If the condition list is empty, then it is true */\n-        if (!first)\n-                return true;\n-\n-        /* Otherwise, if all of the non-trigger conditions apply and\n-         * if any of the trigger conditions apply (unless there are\n-         * none) we return true */\n-        LIST_FOREACH(conditions, c, first) {\n-                int r;\n-\n-                r = condition_test(c, env);\n-\n-                if (logger) {\n-                        if (r < 0)\n-                                logger(userdata, LOG_WARNING, r, PROJECT_FILE, __LINE__, __func__,\n-                                       \"Couldn't determine result for %s=%s%s%s, assuming failed: %m\",\n-                                       to_string(c->type),\n-                                       c->trigger ? \"|\" : \"\",\n-                                       c->negate ? \"!\" : \"\",\n-                                       c->parameter);\n-                        else\n-                                logger(userdata, LOG_DEBUG, 0, PROJECT_FILE, __LINE__, __func__,\n-                                       \"%s=%s%s%s %s.\",\n-                                       to_string(c->type),\n-                                       c->trigger ? \"|\" : \"\",\n-                                       c->negate ? \"!\" : \"\",\n-                                       c->parameter,\n-                                       condition_result_to_string(c->result));\n-                }\n-\n-                if (!c->trigger && r <= 0)\n-                        return false;\n-\n-                if (c->trigger && triggered <= 0)\n-                        triggered = r > 0;\n-        }\n-\n-        return triggered != 0;\n+    Condition *first,\n+    char **env,\n+    condition_to_string_t to_string,\n+    condition_test_logger_t logger,\n+    void *userdata)\n+{\n+    int triggered = -1;\n+\n+    /* If the condition list is empty, then it is true */\n+    if (!first)\n+        return true;\n+\n+    /* Deep-clone each condition to prevent frees from invalidating the test list */\n+    size_t count = 0;\n+    LIST_FOREACH(conditions, c, first)\n+        count++;\n+\n+    Condition **clones = malloc(sizeof(Condition*) * count);\n+    if (!clones)\n+        return false;\n+\n+    size_t idx = 0;\n+    LIST_FOREACH(conditions, c, first) {\n+        Condition *d = malloc(sizeof(*d));\n+        if (!d) {\n+            /* cleanup partially built clones */\n+            for (size_t j = 0; j < idx; j++) {\n+                free(clones[j]->parameter);\n+                free(clones[j]);\n+            }\n+            free(clones);\n+            return false;\n+        }\n+        /* copy fields */\n+        d->type = c->type;\n+        d->trigger = c->trigger;\n+        d->negate = c->negate;\n+        d->result = c->result;\n+        /* duplicate parameter string */\n+        d->parameter = strdup(c->parameter);\n+        if (!d->parameter) {\n+            free(d);\n+            for (size_t j = 0; j < idx; j++) {\n+                free(clones[j]->parameter);\n+                free(clones[j]);\n+            }\n+            free(clones);\n+            return false;\n+        }\n+        /* detach clone from any list links */\n+        d->conditions_next = NULL;\n+        d->conditions_prev = NULL;\n+        clones[idx++] = d;\n+    }\n+\n+    bool ret = false;\n+    for (size_t i = 0; i < count; i++) {\n+        Condition *c2 = clones[i];\n+        int r = condition_test(c2, env);\n+\n+        if (logger) {\n+            if (r < 0)\n+                logger(userdata, LOG_WARNING, r, PROJECT_FILE, __LINE__, __func__,\n+                       \"Couldn't determine result for %s=%s%s%s, assuming failed: %m\",\n+                       to_string(c2->type),\n+                       c2->trigger ? \"|\" : \"\",\n+                       c2->negate ? \"!\" : \"\",\n+                       c2->parameter);\n+            else\n+                logger(userdata, LOG_DEBUG, 0, PROJECT_FILE, __LINE__, __func__,\n+                       \"%s=%s%s%s %s.\",\n+                       to_string(c2->type),\n+                       c2->trigger ? \"|\" : \"\",\n+                       c2->negate ? \"!\" : \"\",\n+                       c2->parameter,\n+                       condition_result_to_string(c2->result));\n+        }\n+\n+        if (!c2->trigger && r <= 0) {\n+            ret = false;\n+            goto cleanup;\n+        }\n+        if (c2->trigger && triggered <= 0)\n+            triggered = r > 0;\n+    }\n+    ret = (triggered != 0);\n+\n+cleanup:\n+    for (size_t i = 0; i < count; i++) {\n+        free(clones[i]->parameter);\n+        free(clones[i]);\n+    }\n+    free(clones);\n+    return ret;\n }\n \n void condition_dump(Condition *c, FILE *f, const char *prefix, condition_to_string_t to_string) {\n",
  "stdout": "+ FUZZER=fuzz-link-parser\r\n+ shift\r\n+ '[' '!' -v TESTCASE ']'\r\n+ TESTCASE=/testcase\r\n+ '[' '!' -f /testcase ']'\r\n+ export RUN_FUZZER_MODE=interactive\r\n+ RUN_FUZZER_MODE=interactive\r\n+ export FUZZING_ENGINE=libfuzzer\r\n+ FUZZING_ENGINE=libfuzzer\r\n+ export SKIP_SEED_CORPUS=1\r\n+ SKIP_SEED_CORPUS=1\r\n+ run_fuzzer fuzz-link-parser -runs=100 /testcase\r\nvm.mmap_rnd_bits = 28\r\n/out/fuzz-link-parser -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -timeout_exitcode=0 < /dev/null\r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 1336820688\r\nINFO: Loaded 2 modules   (96997 inline 8-bit counters): 94627 [0x7f3bc0585940, 0x7f3bc059cae3), 2370 [0x5584c675b078, 0x5584c675b9ba), \r\nINFO: Loaded 2 PC tables (96997 PCs): 94627 [0x7f3bc059cae8,0x7f3bc070e518), 2370 [0x5584c675b9c0,0x5584c6764de0), \r\n/out/fuzz-link-parser: Running 1 inputs 100 time(s) each.\r\nRunning: /testcase\r\n=================================================================\r\n==18==ERROR: AddressSanitizer: heap-use-after-free on address 0x503000000200 at pc 0x7f3bbfe7d800 bp 0x7ffc3cc404f0 sp 0x7ffc3cc404e8\r\nREAD of size 8 at 0x503000000200 thread T0\r\nSCARINESS: 51 (8-byte-read-heap-use-after-free)\r\n    #0 0x7f3bbfe7d7ff in condition_test_list /work/build/../../src/systemd/src/shared/condition.c:1281:5\r\n    #1 0x5584c65f7bda in link_load_one /work/build/../../src/systemd/src/udev/net/link-config.c:301:14\r\n    #2 0x5584c65f6b15 in LLVMFuzzerTestOneInput /work/build/../../src/systemd/src/udev/net/fuzz-link-parser.c:25:16\r\n    #3 0x5584c663e3f0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13\r\n    #4 0x5584c6629665 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6\r\n    #5 0x5584c662f0ff in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9\r\n    #6 0x5584c665a3a2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #7 0x7f3bbf619082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)\r\n    #8 0x5584c651e21d in _start (/out/fuzz-link-parser+0x7b21d)\r\n\r\nDEDUP_TOKEN: condition_test_list--link_load_one--LLVMFuzzerTestOneInput\r\n0x503000000200 is located 16 bytes inside of 32-byte region [0x5030000001f0,0x503000000210)\r\nfreed by thread T0 here:\r\n    #0 0x5584c65b6f96 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:52:3\r\n    #1 0x7f3bbfe731be in condition_free /work/build/../../src/systemd/src/shared/condition.c:96:16\r\n    #2 0x7f3bbfe731be in condition_free_list_type /work/build/../../src/systemd/src/shared/condition.c:102:25\r\n    #3 0x7f3bbff8ba46 in config_parse_net_condition /work/build/../../src/systemd/src/shared/net-condition.c:205:25\r\n    #4 0x7f3bbfe80569 in next_assignment /work/build/../../src/systemd/src/shared/conf-parser.c:159:24\r\n    #5 0x7f3bbfe80569 in parse_line /work/build/../../src/systemd/src/shared/conf-parser.c:269:16\r\n    #6 0x7f3bbfe7f7c4 in config_parse /work/build/../../src/systemd/src/shared/conf-parser.c:412:21\r\n    #7 0x7f3bbfe81afa in config_parse_many_files /work/build/../../src/systemd/src/shared/conf-parser.c:564:21\r\n    #8 0x7f3bbfe81afa in config_parse_many /work/build/../../src/systemd/src/shared/conf-parser.c:627:13\r\n    #9 0x5584c65f7a5d in link_load_one /work/build/../../src/systemd/src/udev/net/link-config.c:273:13\r\n    #10 0x5584c65f6b15 in LLVMFuzzerTestOneInput /work/build/../../src/systemd/src/udev/net/fuzz-link-parser.c:25:16\r\n    #11 0x5584c663e3f0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13\r\n    #12 0x5584c6629665 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6\r\n    #13 0x5584c662f0ff in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9\r\n    #14 0x5584c665a3a2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #15 0x7f3bbf619082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)\r\n\r\nDEDUP_TOKEN: __interceptor_free--condition_free--condition_free_list_type\r\npreviously allocated by thread T0 here:\r\n    #0 0x5584c65b722f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3\r\n    #1 0x7f3bbfe72eed in malloc_multiply /work/build/../../src/systemd/src/basic/alloc-util.h:119:16\r\n    #2 0x7f3bbfe72eed in condition_new /work/build/../../src/systemd/src/shared/condition.c:73:13\r\n    #3 0x7f3bbff8ba78 in config_parse_net_condition /work/build/../../src/systemd/src/shared/net-condition.c:213:13\r\n    #4 0x7f3bbfe80569 in next_assignment /work/build/../../src/systemd/src/shared/conf-parser.c:159:24\r\n    #5 0x7f3bbfe80569 in parse_line /work/build/../../src/systemd/src/shared/conf-parser.c:269:16\r\n    #6 0x7f3bbfe7f7c4 in config_parse /work/build/../../src/systemd/src/shared/conf-parser.c:412:21\r\n    #7 0x7f3bbfe81afa in config_parse_many_files /work/build/../../src/systemd/src/shared/conf-parser.c:564:21\r\n    #8 0x7f3bbfe81afa in config_parse_many /work/build/../../src/systemd/src/shared/conf-parser.c:627:13\r\n    #9 0x5584c65f7a5d in link_load_one /work/build/../../src/systemd/src/udev/net/link-config.c:273:13\r\n    #10 0x5584c65f6b15 in LLVMFuzzerTestOneInput /work/build/../../src/systemd/src/udev/net/fuzz-link-parser.c:25:16\r\n    #11 0x5584c663e3f0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13\r\n    #12 0x5584c6629665 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6\r\n    #13 0x5584c662f0ff in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9\r\n    #14 0x5584c665a3a2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #15 0x7f3bbf619082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)\r\n\r\nDEDUP_TOKEN: __interceptor_malloc--malloc_multiply--condition_new\r\nSUMMARY: AddressSanitizer: heap-use-after-free /work/build/../../src/systemd/src/shared/condition.c:1281:5 in condition_test_list\r\nShadow bytes around the buggy address:\r\n  0x502fffffff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x503000000000: fa fa 00 00 00 fa fa fa 00 00 00 fa fa fa 00 00\r\n  0x503000000080: 00 fa fa fa 00 00 00 fa fa fa 00 00 00 00 fa fa\r\n  0x503000000100: 00 00 00 fa fa fa 00 00 00 05 fa fa fd fd fd fd\r\n  0x503000000180: fa fa fd fd fd fd fa fa fd fd fd fd fa fa fd fd\r\n=>0x503000000200:[fd]fd fa fa 00 00 00 00 fa fa 00 00 00 05 fa fa\r\n  0x503000000280: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x503000000300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x503000000380: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x503000000400: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x503000000480: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==18==ABORTING\r\nsubprocess command returned a non-zero exit status: 1\n",
  "stderr": "INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64 -v /home/user/aixcc/crete/packages/python_oss_fuzz/.oss_fuzz/build/out/systemd:/out -v /tmp/tmpwwtdfa1e:/testcase -t ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce fuzz-link-parser -runs=100.\n"
}