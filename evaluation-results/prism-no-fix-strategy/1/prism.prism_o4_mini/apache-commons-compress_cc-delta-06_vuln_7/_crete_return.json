{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-06_vuln_7",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 1.6927944,
    "prompt_tokens": 1411684,
    "completion_tokens": 31805
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n@@ -31,6 +31,9 @@\n import java.nio.file.StandardOpenOption;\n import java.util.Enumeration;\n import java.util.Iterator;\n+import java.util.Objects;\n+import java.nio.file.Path;\n+import java.nio.file.Files;\n \n import org.apache.commons.compress.archivers.ArchiveEntry;\n import org.apache.commons.compress.archivers.ArchiveException;\n@@ -70,25 +73,29 @@\n         final Path targetDirPath = nullTarget ? null : targetDirectory.normalize();\n         T nextEntry = supplier.get();\n         while (nextEntry != null) {\n-            final Path targetPath = nullTarget ? null : nextEntry.resolveIn(targetDirPath);\n-            if (nextEntry.isDirectory()) {\n-                if (!nullTarget && !Files.isDirectory(targetPath) && Files.createDirectories(targetPath) == null) {\n-                    throw new IOException(\"Failed to create directory \" + targetPath);\n-                }\n-            } else {\n-                final Path parent = nullTarget ? null : targetPath.getParent();\n-                if (!nullTarget && !Files.isDirectory(parent) && Files.createDirectories(parent) == null) {\n-                    throw new IOException(\"Failed to create directory \" + parent);\n-                }\n-                if (nullTarget) {\n-                    writer.accept(nextEntry, NullOutputStream.INSTANCE);\n-                } else {\n-                    try (OutputStream outputStream = Files.newOutputStream(targetPath)) {\n-                        writer.accept(nextEntry, outputStream);\n-                    }\n-                }\n-            }\n-            nextEntry = supplier.get();\n+        // Prevent path traversal by normalizing and validating entry paths\n+        Objects.requireNonNull(targetDirectory, \"targetDirectory must not be null\");\n+        Path base = targetDirectory.normalize();\n+        Path entryPath = base.resolve(nextEntry.getName()).normalize();\n+        if (!entryPath.startsWith(base)) {\n+            throw new IOException(\"Entry is outside of the target dir: \" + nextEntry.getName());\n+        }\n+        if (nextEntry.isDirectory()) {\n+            Files.createDirectories(entryPath);\n+        } else {\n+            Path parent = entryPath.getParent();\n+            if (parent != null) {\n+                Files.createDirectories(parent);\n+            }\n+        }\n+        if (nullTarget) {\n+            writer.accept(nextEntry, NullOutputStream.INSTANCE);\n+        } else {\n+            try (OutputStream outputStream = Files.newOutputStream(entryPath)) {\n+                writer.accept(nextEntry, outputStream);\n+            }\n+        }\n+        nextEntry = supplier.get();\n         }\n     }\n \n",
  "stdout": "",
  "stderr": ""
}