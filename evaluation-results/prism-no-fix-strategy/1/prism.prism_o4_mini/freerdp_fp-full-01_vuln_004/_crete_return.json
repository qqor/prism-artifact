{
  "project_name": "freerdp",
  "vulnerability_identifier": "freerdp_fp-full-01_vuln_004",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-freerdp",
  "llm_usage": {
    "total_cost": 1.001506,
    "prompt_tokens": 548128,
    "completion_tokens": 90583
  },
  "variant": "sound",
  "diff": "--- a/winpr/include/winpr/stream.h\n+++ b/winpr/include/winpr/stream.h\n@@ -695,14 +695,14 @@\n \t\t_v = stream_read_i64_be(_s, TRUE); \\\n \t} while (0)\n \n-\tstatic INLINE void Stream_Read(wStream* _s, void* _b, size_t _n)\n-\t{\n-\t\tWINPR_ASSERT(_s);\n-\t\tWINPR_ASSERT(_b || (_n == 0));\n-\t\tWINPR_ASSERT(Stream_GetRemainingCapacity(_s) >= _n);\n-\t\tmemcpy(_b, (_s->pointer), (_n));\n-\t\tStream_Seek(_s, _n);\n-\t}\n+static INLINE void Stream_Read(wStream* _s, void* _b, size_t _n)\n+{\n+    WINPR_ASSERT(_s);\n+    WINPR_ASSERT(_b || (_n == 0));\n+    WINPR_ASSERT(Stream_GetRemainingLength(_s) >= _n);\n+    memcpy(_b, (_s->pointer), (_n));\n+    Stream_Seek(_s, _n);\n+}\n \n #define Stream_Peek_UINT8(_s, _v)       \\\n \tdo                                  \\\n\n--- a/libfreerdp/core/gcc.c\n+++ b/libfreerdp/core/gcc.c\n@@ -1850,17 +1850,17 @@\n \tWINPR_ASSERT(s);\n \tWINPR_ASSERT(mcs);\n \n-\tconst size_t blockLength = Stream_GetRemainingLength(s);\n-\tif (blockLength < 4)\n-\t\treturn FALSE;\n-\n-\tStream_Read_UINT8(s, mcs->channelCount); /* channelCount */\n-\n-\tif (blockLength < 4 + (UINT8)mcs->channelCount * 12)\n-\t\treturn FALSE;\n-\n-\tif (mcs->channelCount > CHANNEL_MAX_COUNT)\n-\t\treturn FALSE;\n+\tsize_t remLen = Stream_GetRemainingLength(s);\n+\tif (remLen < 1)\n+\t\treturn FALSE;\n+\tUINT8 channelCount;\n+\tStream_Read_UINT8(s, channelCount);\n+\tif (channelCount > CHANNEL_MAX_COUNT)\n+\t\treturn FALSE;\n+\t/* ensure enough remaining bytes for all channel definitions */\n+\tif (Stream_GetRemainingLength(s) < (size_t)channelCount * ((CHANNEL_NAME_LEN + 1) + sizeof(UINT32)))\n+\t\treturn FALSE;\n+\tmcs->channelCount = channelCount;\n \n \t/* channelDefArray */\n \tfor (UINT32 i = 0; i < mcs->channelCount; i++)\n@@ -1872,17 +1872,18 @@\n \t\t * - options: a 32-bit, unsigned integer. Channel option flags\n \t\t */\n \t\trdpMcsChannel* channel = &mcs->channels[i];\n-\t\tStream_Read(s, channel->Name, CHANNEL_NAME_LEN + 1); /* name (8 bytes) */\n-\n+\t\tif (Stream_GetRemainingLength(s) < (CHANNEL_NAME_LEN + 1))\n+\t\t\treturn FALSE;\n+\t\tStream_Read(s, channel->Name, CHANNEL_NAME_LEN + 1);\n \t\tif (!memchr(channel->Name, 0, CHANNEL_NAME_LEN + 1))\n \t\t{\n-\t\t\tWLog_ERR(\n-\t\t\t    TAG,\n-\t\t\t    \"protocol violation: received a static channel name with missing null-termination\");\n+\t\t\tWLog_ERR(TAG,\n+\t\t\t\t\"protocol violation: received a static channel name with missing null-termination\");\n \t\t\treturn FALSE;\n \t\t}\n-\n-\t\tStream_Read_UINT32(s, channel->options); /* options (4 bytes) */\n+\t\tif (Stream_GetRemainingLength(s) < sizeof(UINT32))\n+\t\t\treturn FALSE;\n+\t\tStream_Read_UINT32(s, channel->options);\n \t\tchannel->ChannelId = mcs->baseChannelId++;\n \t}\n \n",
  "stdout": "",
  "stderr": ""
}