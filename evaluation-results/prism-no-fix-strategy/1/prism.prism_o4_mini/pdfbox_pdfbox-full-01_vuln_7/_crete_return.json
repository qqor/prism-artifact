{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_7",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 1.1983345000000003,
    "prompt_tokens": 968443,
    "completion_tokens": 30238
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -20,6 +20,8 @@\n import java.util.Collections;\n import java.util.Iterator;\n import java.util.Queue;\n+import java.util.Set;\n+import java.util.HashSet;\n import org.apache.pdfbox.cos.COSArray;\n import org.apache.pdfbox.cos.COSBase;\n import org.apache.pdfbox.cos.COSDictionary;\n@@ -180,21 +182,25 @@\n     private final class PageIterator implements Iterator<PDPage>\n     {\n         private final Queue<COSDictionary> queue = new ArrayDeque<>();\n-\n-        private PageIterator(COSDictionary node)\n-        {\n-            List<COSDictionary> kids = enqueueKids(node);\n-            while (!kids.isEmpty())\n-            {\n-                List<COSDictionary> newKids = new ArrayList<>();\n-\n-                for (COSDictionary kid : kids)\n+        private final Set<COSDictionary> pageSet = new HashSet<>();\n+\n+    private PageIterator(COSDictionary node)\n+    {\n+        List<COSDictionary> kids = enqueueKids(node);\n+        while (!kids.isEmpty())\n+        {\n+            List<COSDictionary> nextKids = new ArrayList<>();\n+            for (COSDictionary kid : kids)\n+            {\n+                if (pageSet.add(kid))\n                 {\n-                    newKids.addAll(enqueueKids(kid));\n+                    queue.add(kid);\n+                    nextKids.addAll(enqueueKids(kid));\n                 }\n-                kids = newKids;\n-            }\n-        }\n+            }\n+            kids = nextKids;\n+        }\n+    }\n \n         /**\n          * This takes a node, and, if it is a page adds it to the queue.\n@@ -203,26 +209,36 @@\n          * @param node\n          * @return\n          */\n-        private List<COSDictionary> enqueueKids(COSDictionary node)\n-        {\n-            if (isPageTreeNode(node))\n-            {\n-                return getKids(node);\n-            }\n-            else\n-            {\n-                if (node != null && COSName.PAGE.equals(node.getCOSName(COSName.TYPE)))\n+    private List<COSDictionary> enqueueKids(COSDictionary node)\n+    {\n+        if (node == null)\n+        {\n+            return Collections.emptyList();\n+        }\n+        COSArray kidsArray = node.getCOSArray(COSName.KIDS);\n+        if (kidsArray == null)\n+        {\n+            return Collections.emptyList();\n+        }\n+        List<COSDictionary> result = new ArrayList<>();\n+        for (COSBase base : kidsArray)\n+        {\n+            if (base instanceof COSDictionary)\n+            {\n+                COSDictionary kidDict = (COSDictionary) base;\n+                COSName type = kidDict.getCOSName(COSName.TYPE);\n+                if (COSName.PAGE.equals(type))\n                 {\n-                    queue.add(node);\n+                    result.add(kidDict);\n                 }\n-                else\n+                else if (COSName.PAGES.equals(type))\n                 {\n-                    LOG.error(\"Page skipped due to an invalid or missing type {}\",\n-                            () -> (node == null ? \"(null)\" : node.getCOSName(COSName.TYPE)));\n+                    result.addAll(enqueueKids(kidDict));\n                 }\n             }\n-            return Collections.EMPTY_LIST;\n-        }\n+        }\n+        return result;\n+    }\n \n         @Override\n         public boolean hasNext()\n",
  "stdout": "",
  "stderr": ""
}