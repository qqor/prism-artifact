{
  "project_name": "wireshark",
  "vulnerability_identifier": "wireshark_ws-full-01_vuln_002",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-wireshark",
  "llm_usage": {
    "total_cost": 3.2352925,
    "prompt_tokens": 2442187,
    "completion_tokens": 124747
  },
  "variant": "sound",
  "diff": "--- a/epan/dissectors/packet-telnet.c\n+++ b/epan/dissectors/packet-telnet.c\n@@ -187,7 +187,8 @@\n #define TN_EOR   239\n #define TN_ABORT 238\n #define TN_SUSP  237\n-#define TN_EOF   236\n+#define TN_EOF                 236\n+#define TN_NAWS                31\n #define TN_ARE     1\n \n static const value_string cmd_vals[] = {\n@@ -633,11 +634,10 @@\n }\n \n static void\n-dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,\n-                    int len _U_, proto_tree *tree _U_, proto_item *item _U_)\n-{\n-  if ( hf_telnet_naws_subopt_set )\n-    wmem_free(pinfo->pool, hf_naws_data);\n+dissect_linemode_subopt(packet_info *pinfo _U_, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,\n+                        int len _U_, proto_tree *tree _U_, proto_item *item _U_)\n+{\n+  /* defer freeing of NAWS data until protocol cleanup */\n \n   return;\n }\n@@ -2090,14 +2090,20 @@\n         break;\n       }\n \n-      /* We have a dissector for this suboption's parameters; call it. */\n-      if (iac_data > 0) {\n-        /* Data is escaped, we have to unescape it. */\n-        unescaped_tvb = unescape_and_tvbuffify_telnet_option(pinfo, tvb, start_offset, subneg_len);\n-        (*opt->dissect)(pinfo, opt->name, unescaped_tvb, 0, subneg_len - iac_data, option_tree, option_item);\n-      } else {\n-        (*opt->dissect)(pinfo, opt->name, tvb, start_offset, subneg_len, option_tree, option_item);\n-      }\n+ /*\n+  We have a dissector for this suboption's parameters; call it.\n+ */\n+  if (opt_byte != TN_NAWS && opt->dissect) {\n+    if (iac_data > 0) {\n+      /* Data is escaped, we have to unescape it. */\n+      unescaped_tvb = unescape_and_tvbuffify_telnet_option(pinfo, tvb, start_offset, subneg_len);\n+      (*opt->dissect)(pinfo, opt->name, unescaped_tvb, 0, subneg_len - iac_data, option_tree, option_item);\n+    } else {\n+      (*opt->dissect)(pinfo, opt->name, tvb, start_offset, subneg_len, option_tree, option_item);\n+    }\n+  } else {\n+    /* defer freeing of NAWS data until protocol cleanup */\n+  }\n     } else {\n       /* We don't have a dissector for them; just show them as data. */\n       if (iac_data > 0) {\n@@ -2206,9 +2212,11 @@\n        If this subopt is set then a method for storing the data in a given window\n        is necessary.\n     */\n-   if ( hf_telnet_naws_subopt_set ) {\n+  if (hf_telnet_naws_subopt_set && hf_naws_data) {\n     int start_offset = hf_telnet_width * hf_telnet_line;\n-    tvb_get_raw_bytes_as_stringz(tvb, offset, (linelen < hf_telnet_width) ? linelen : hf_telnet_width, hf_naws_data + start_offset);\n+    tvb_get_raw_bytes_as_stringz(tvb, offset,\n+                                (linelen < hf_telnet_width) ? linelen : hf_telnet_width,\n+                                hf_naws_data + start_offset);\n     hf_telnet_line = (hf_telnet_line + 1) % hf_telnet_height;\n   }\n \n",
  "stdout": "",
  "stderr": ""
}