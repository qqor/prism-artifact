{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-04_vuln_5",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 2.7594061,
    "prompt_tokens": 2343747,
    "completion_tokens": 41201
  },
  "variant": "sound",
  "diff": "--- a/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n+++ b/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n@@ -83,14 +83,30 @@\n         if (fileExtension != null && fileExtension.length() > 0) {\n             emitKey += \".\" + fileExtension;\n         }\n+        // Sanitize emitKey to prevent traversal\n+        Path keyPath = Paths.get(emitKey);\n+        Path normalizedKey = keyPath.normalize();\n+        if (normalizedKey.startsWith(\"..\")) {\n+            throw new IOException(\"Invalid path traversal attempt: \" + emitKey);\n+        }\n         if (basePath != null) {\n-            output = basePath.resolve(emitKey);\n+            output = basePath.resolve(normalizedKey).toAbsolutePath().normalize();\n+            Path normalizedBase = basePath.toAbsolutePath().normalize();\n+            if (normalizedBase.relativize(output).startsWith(\"..\")) {\n+                throw new IOException(\"Invalid path traversal attempt: \" + emitKey);\n+            }\n         } else {\n-            output = Paths.get(emitKey);\n-        }\n-\n-        if (!Files.isDirectory(output.getParent())) {\n-            Files.createDirectories(output.getParent());\n+            Path cwd = Paths.get(\"\").toAbsolutePath().normalize();\n+            output = cwd.resolve(normalizedKey).toAbsolutePath().normalize();\n+            if (cwd.relativize(output).startsWith(\"..\")) {\n+                throw new IOException(\"Invalid path traversal attempt: \" + emitKey);\n+            }\n+        }\n+\n+        // Create parent directories after normalization\n+        Path parent = output.getParent();\n+        if (parent != null && !Files.isDirectory(parent)) {\n+            Files.createDirectories(parent);\n         }\n         try (Writer writer = Files.newBufferedWriter(output, StandardCharsets.UTF_8)) {\n             JsonMetadataList.toJson(metadataList, writer, prettyPrint);\n@@ -144,10 +160,32 @@\n \n     @Override\n     public void emit(String path, InputStream inputStream, Metadata userMetadata, ParseContext parseContext) throws IOException, TikaEmitterException {\n-        Path target = basePath.resolve(path);\n-\n-        if (!Files.isDirectory(target.getParent())) {\n-            Files.createDirectories(target.getParent());\n+        // Sanitize path to prevent traversal\n+        Path keyPath = Paths.get(path);\n+        Path normalizedKey = keyPath.normalize();\n+        if (normalizedKey.startsWith(\"..\")) {\n+            throw new IOException(\"Invalid path traversal attempt: \" + path);\n+        }\n+        // Declare target after sanitization\n+        Path target;\n+        if (basePath != null) {\n+            target = basePath.resolve(normalizedKey).toAbsolutePath().normalize();\n+            Path normalizedBase = basePath.toAbsolutePath().normalize();\n+            if (normalizedBase.relativize(target).startsWith(\"..\")) {\n+                throw new IOException(\"Invalid path traversal attempt: \" + path);\n+            }\n+        } else {\n+            Path cwd = Paths.get(\"\").toAbsolutePath().normalize();\n+            target = cwd.resolve(normalizedKey).toAbsolutePath().normalize();\n+            if (cwd.relativize(target).startsWith(\"..\")) {\n+                throw new IOException(\"Invalid path traversal attempt: \" + path);\n+            }\n+        }\n+\n+        // Create parent directories after normalization\n+        Path parent = target.getParent();\n+        if (parent != null && !Files.isDirectory(parent)) {\n+            Files.createDirectories(parent);\n         }\n         if (onExists == ON_EXISTS.REPLACE) {\n             Files.copy(inputStream, target, StandardCopyOption.REPLACE_EXISTING);\n",
  "stdout": "",
  "stderr": ""
}