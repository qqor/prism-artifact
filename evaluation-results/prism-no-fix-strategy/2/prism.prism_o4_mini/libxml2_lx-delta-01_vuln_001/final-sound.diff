--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3572,19 +3572,18 @@
         }
 
         chunkSize = in - chunk;
-        extraSize = chunkSize + replSize;
-
-        if (extraSize > buffer_size) {
-            size_t newSize = (used + extraSize) * 2;
-            xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
-
-            if (tmp == NULL) {
-                htmlErrMemory(ctxt);
-                goto error;
-            }
-            buffer = tmp;
-            buffer_size = newSize;
+    extraSize = chunkSize + replSize;
+    /* ensure total used + incoming data fits the buffer */
+    if ((used + extraSize) > buffer_size) {
+        size_t newSize = (used + extraSize) * 2;
+        xmlChar *tmp = (xmlChar *)xmlRealloc(buffer, newSize + 1);
+        if (tmp == NULL) {
+            htmlErrMemory(ctxt);
+            goto error;
         }
+        buffer = tmp;
+        buffer_size = newSize;
+    }
 
         if (chunkSize > 0) {
             input->cur += chunkSize;
