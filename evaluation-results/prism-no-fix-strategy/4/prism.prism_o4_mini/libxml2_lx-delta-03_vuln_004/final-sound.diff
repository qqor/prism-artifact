--- a/xmlIO.c
+++ b/xmlIO.c
@@ -2209,9 +2209,17 @@
             sizeOut = len;
         else
             sizeOut = SIZE_MAX;
-
-	if (xmlCharEncInput(in, &sizeOut) < 0)
-	    return(-1);
+        if (xmlBufGrow(in->raw, len) < 0) {
+            in->error = XML_ERR_NO_MEMORY;
+            return(-1);
+        }
+        if (xmlBufGrow(in->buffer, len) < 0) {
+            in->error = XML_ERR_NO_MEMORY;
+            return(-1);
+        }
+        if (xmlCharEncInput(in, &sizeOut) < 0) {
+            return(-1);
+        }
         res = sizeOut;
     }
     return(res);
