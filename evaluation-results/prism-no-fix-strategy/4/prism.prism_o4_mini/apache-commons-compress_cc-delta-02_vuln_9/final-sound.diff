--- a/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java
@@ -78,9 +78,12 @@
         if (firstByte != MAGIC_1 || secondByte != MAGIC_2 || thirdByte < 0) {
             throw new IOException("Input is not in .Z format");
         }
-        blockMode = (thirdByte & BLOCK_MODE_MASK) != 0;
-        maxCodeSize = thirdByte & MAX_CODE_SIZE_MASK;
-        if (blockMode) {
+    blockMode = (thirdByte & BLOCK_MODE_MASK) != 0;
+    maxCodeSize = thirdByte & MAX_CODE_SIZE_MASK;
+    if (maxCodeSize < DEFAULT_CODE_SIZE || maxCodeSize > 16) {
+        throw new IOException("Invalid LZW max code size: " + maxCodeSize);
+    }
+    if (blockMode) {
             setClearCode(DEFAULT_CODE_SIZE);
         }
         initializeTables(maxCodeSize, memoryLimitInKiB);
