--- a/src/net_builtin.c
+++ b/src/net_builtin.c
@@ -381,9 +381,22 @@
 
 static void rx_icmp(struct mg_tcpip_if *ifp, struct pkt *pkt) {
   // MG_DEBUG(("ICMP %d", (int) len));
-  if (pkt->icmp->type == 8 && pkt->ip != NULL && pkt->ip->dst == ifp->ip) {
-    size_t hlen = sizeof(struct eth) + sizeof(struct ip) + sizeof(struct icmp);
-    size_t space = ifp->tx.len - hlen, plen = pkt->pay.len;
+  /* Ensure raw buffer covers Ethernet + IP + ICMP headers */
+  const size_t eth_len = sizeof(struct eth);
+  if (pkt->raw.len < eth_len + sizeof(struct ip)) return;
+  if (pkt->ip == NULL) return;
+  /* Validate IP header length */
+  const uint8_t ihl = pkt->ip->ver & 0xF;
+  if (ihl < 5) return;
+  const size_t ip_len = ihl * 4;
+  if (pkt->raw.len < eth_len + ip_len + sizeof(struct icmp)) return;
+  if (pkt->icmp->type == 8 && pkt->ip->dst == ifp->ip) {
+    /* Compute TX space after headers */
+    const size_t hlen = eth_len + ip_len + sizeof(struct icmp);
+    if (ifp->tx.len < hlen) return;
+    size_t space = ifp->tx.len - hlen;
+    size_t plen = pkt->pay.len;
+    if (plen > space) plen = space;
     if (plen > space) plen = space;
     struct ip *ip = tx_ip(ifp, pkt->eth->src, 1, ifp->ip, pkt->ip->src,
                           sizeof(struct icmp) + plen);
