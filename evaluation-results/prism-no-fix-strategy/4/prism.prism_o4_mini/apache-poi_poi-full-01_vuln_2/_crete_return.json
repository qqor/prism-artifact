{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 2.7101921000000013,
    "prompt_tokens": 2144075,
    "completion_tokens": 79934
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -23,6 +23,7 @@\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n+import java.nio.file.Path;\n import java.util.Iterator;\n \n import org.apache.poi.poifs.common.POIFSConstants;\n@@ -105,27 +106,55 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n-                    out.write(bytes);\n-                }\n+            // sanitize entry name to prevent path traversal\n+            String rawName = node.getName().trim();\n+            String safeName = rawName.replaceAll(\"\\\\.\\\\.\", \"_\").replaceAll(\"[/\\\\\\\\]+\", \"_\");\n+            File outFile = new File(parent, safeName);\n+            Path outPath = outFile.toPath().normalize();\n+            Path parentPath = parent.toPath().normalize();\n+            if (!outPath.startsWith(parentPath)) {\n+                throw new IOException(\"Invalid entry name: \" + rawName);\n+            }\n+            if (outPath.getParent() != null && !Files.isDirectory(outPath.getParent())) {\n+                Files.createDirectories(outPath.getParent());\n+            }\n+            try (OutputStream out = Files.newOutputStream(outPath)) {\n+                out.write(bytes);\n+            }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n-                }\n-                dump(dir, file);\n+            // sanitize directory name to prevent path traversal\n+            String rawName = entry.getName().trim();\n+            String safeName = rawName.replaceAll(\"\\\\.\\\\.\", \"_\").replaceAll(\"[/\\\\\\\\]+\", \"_\");\n+            File file = new File(parent, safeName);\n+            Path filePath = file.toPath().normalize();\n+            Path parentPath = parent.toPath().normalize();\n+            if (!filePath.startsWith(parentPath)) {\n+                throw new IOException(\"Invalid directory name: \" + rawName);\n+            }\n+            if (!file.exists() && !file.mkdirs()) {\n+                throw new IOException(\"Could not create directory: \" + file);\n+            }\n+            dump(dir, file);\n             } else {\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n-        if (! Files.isDirectory(file.toPath().getParent())) {\n-            Files.createDirectories(file.toPath().getParent());\n+        // sanitize entry name to prevent path traversal\n+        String rawName = name.trim();\n+        String safeName = rawName.replaceAll(\"\\\\.\\\\.\", \"_\").replaceAll(\"[/\\\\\\\\]+\", \"_\");\n+        File file = new File(parent, safeName);\n+        Path filePath = file.toPath().normalize();\n+        Path parentPath = parent.toPath().normalize();\n+        if (!filePath.startsWith(parentPath)) {\n+            throw new IOException(\"Invalid entry name: \" + rawName);\n         }\n-        try (OutputStream out = Files.newOutputStream(file.toPath())) {\n+        if (filePath.getParent() != null && !Files.isDirectory(filePath.getParent())) {\n+            Files.createDirectories(filePath.getParent());\n+        }\n+        try (OutputStream out = Files.newOutputStream(filePath)) {\n             POIFSStream stream = new POIFSStream(fs, startBlock);\n \n             byte[] b = IOUtils.safelyAllocate(fs.getBigBlockSize(), POIFSFileSystem.getMaxRecordLength());\n",
  "stdout": "",
  "stderr": ""
}