--- a/lib/dict.c
+++ b/lib/dict.c
@@ -134,12 +134,18 @@
   CURLcode result = CURLE_OK;
   char *s;
   char *sptr;
-  va_list ap;
+  va_list ap, ap_copy;
   va_start(ap, fmt);
-  s = vaprintf(fmt, ap); /* returns an allocated string */
+  va_copy(ap_copy, ap);
+  size_t needed = vsnprintf(NULL, 0, fmt, ap_copy);
+  va_end(ap_copy);
+  s = malloc(needed + 1);
+  if(!s) {
+    va_end(ap);
+    return CURLE_OUT_OF_MEMORY; /* failure */
+  }
+  vsnprintf(s, needed + 1, fmt, ap);
   va_end(ap);
-  if(!s)
-    return CURLE_OUT_OF_MEMORY; /* failure */
 
   bytes_written = 0;
   write_len = strlen(s);
