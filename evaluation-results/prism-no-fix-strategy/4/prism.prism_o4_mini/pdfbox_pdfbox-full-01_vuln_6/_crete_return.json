{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_6",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 1.1659703000000001,
    "prompt_tokens": 919501,
    "completion_tokens": 35118
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n@@ -153,20 +153,22 @@\n                 throw new IOException(\"Incorrect record type: \" + recordType);\n             }\n \n-            int size = in.read();\n-            size += in.read() << 8;\n-            size += in.read() << 16;\n-            size += in.read() << 24;\n-            LOG.debug(\"record type: {}, segment size: {}\", recordType, size);\n-            long newTotal = total + size;\n+            long sizeLong = ((long)(in.read() & 0xFF)) |\n+                            ((long)(in.read() & 0xFF) << 8) |\n+                            ((long)(in.read() & 0xFF) << 16) |\n+                            ((long)(in.read() & 0xFF) << 24);\n+            if (sizeLong < 0 || sizeLong > MAX_LENGTH) {\n+                throw new IOException(\"Invalid segment size: \" + sizeLong);\n+            }\n+            LOG.debug(\"record type: {}, segment size: {}\", recordType, sizeLong);\n+            long newTotal = total + sizeLong;\n             if (newTotal > MAX_LENGTH) {\n                 throw new IOException(\"record size would be too large: \" + newTotal);\n             }\n-\n+            int size = (int) sizeLong;\n             byte[] ar = new byte[size];\n             int got = in.read(ar);\n-            if (got != size)\n-            {\n+            if (got != size) {\n                 throw new EOFException(\"EOF while reading PFB font\");\n             }\n             total += size;\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Font.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Font.java\n@@ -20,6 +20,7 @@\n import java.awt.geom.GeneralPath;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.ByteArrayOutputStream;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.LinkedHashMap;\n@@ -51,7 +52,21 @@\n      */\n     public static Type1Font createWithPFB(InputStream pfbStream) throws IOException\n     {\n-        PfbParser pfb = new PfbParser(pfbStream);\n+        // Read PFB bytes with limit to avoid out-of-memory\n+        final long PFB_MAX_BYTES = 100_000_000L;\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        byte[] buffer = new byte[8192];\n+        long total = 0;\n+        int bytesRead;\n+        while ((bytesRead = pfbStream.read(buffer)) != -1) {\n+            total += bytesRead;\n+            if (total > PFB_MAX_BYTES) {\n+                throw new IOException(\"PFB stream too large: \" + total);\n+            }\n+            baos.write(buffer, 0, bytesRead);\n+        }\n+        byte[] pfbBytes = baos.toByteArray();\n+        PfbParser pfb = new PfbParser(pfbBytes);\n         Type1Parser parser = new Type1Parser();\n         return parser.parse(pfb.getSegment1(), pfb.getSegment2());\n     }\n@@ -66,6 +81,10 @@\n      */\n     public static Type1Font createWithPFB(byte[] pfbBytes) throws IOException\n     {\n+        final long PFB_MAX_BYTES = 100_000_000L;\n+        if (pfbBytes.length > PFB_MAX_BYTES) {\n+            throw new IOException(\"PFB byte array too large: \" + pfbBytes.length);\n+        }\n         PfbParser pfb = new PfbParser(pfbBytes);\n         Type1Parser parser = new Type1Parser();\n         return parser.parse(pfb.getSegment1(), pfb.getSegment2());\n",
  "stdout": "",
  "stderr": ""
}