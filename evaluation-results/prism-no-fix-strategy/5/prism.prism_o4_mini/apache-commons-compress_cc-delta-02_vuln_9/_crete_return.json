{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-02_vuln_9",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 1.2385054000000002,
    "prompt_tokens": 868498,
    "completion_tokens": 64354
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java\n+++ b/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java\n@@ -40,6 +40,9 @@\n     protected static final int DEFAULT_CODE_SIZE = 9;\n     protected static final int UNUSED_PREFIX = -1;\n \n+    /** Default memory limit in KiB when no limit is specified. */\n+    protected static final int DEFAULT_MEMORY_LIMIT_KiB = 64 * 1024;\n+\n     private final byte[] oneByte = new byte[1];\n \n     protected final BitInputStream in;\n@@ -202,21 +205,22 @@\n      * @throws MemoryLimitException     if estimated memory usage is greater than memoryLimitKiB\n      * @throws IllegalArgumentException if {@code maxCodeSize} is not bigger than 0\n      */\n-    protected void initializeTables(final int maxCodeSize, final int memoryLimiKiB) throws MemoryLimitException {\n+    protected void initializeTables(final int maxCodeSize, final int memoryLimitKiB) throws MemoryLimitException {\n         if (maxCodeSize <= 0) {\n             throw new IllegalArgumentException(\"maxCodeSize is \" + maxCodeSize + \", must be bigger than 0\");\n         }\n \n-        if (memoryLimiKiB > -1) {\n-            final int maxTableSize = 1 << maxCodeSize;\n-            // account for potential overflow\n-            final long memoryUsageBytes = (long) maxTableSize * 6; // (4 (prefixes) + 1 (characters) +1 (outputStack))\n-            final long memoryUsageKiB = memoryUsageBytes >> 10;\n-\n-            if (memoryUsageKiB > memoryLimiKiB) {\n-                throw new MemoryLimitException(memoryUsageKiB, memoryLimiKiB);\n-            }\n-        }\n+        final int effectiveLimitKiB = memoryLimitKiB < 0 ? DEFAULT_MEMORY_LIMIT_KiB : memoryLimitKiB;\n+        final int maxTableSize = 1 << maxCodeSize;\n+\n+        // account for potential overflow\n+        final long memoryUsageBytes = (long) maxTableSize * 6; // (4 (prefixes) + 1 (characters) +1 (outputStack))\n+        final long memoryUsageKiB = memoryUsageBytes >> 10;\n+\n+        if (memoryUsageKiB > effectiveLimitKiB) {\n+            throw new MemoryLimitException(memoryUsageKiB, effectiveLimitKiB);\n+        }\n+\n         initializeTables(maxCodeSize);\n     }\n \n\n--- a/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n+++ b/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n@@ -25,8 +25,9 @@\n import org.apache.commons.compress.compressors.lzw.LZWInputStream;\n \n /**\n- * Input stream that decompresses .Z files.\n- *\n+ import org.apache.commons.compress.utils.InputStreamStatistics;\n+ import static org.apache.commons.compress.compressors.lzw.LZWInputStream.DEFAULT_MEMORY_LIMIT_KiB;\n+\n  * @NotThreadSafe\n  * @since 1.7\n  */\n@@ -60,17 +61,17 @@\n      * @throws IOException if an I/O error occurs.\n      */\n     public ZCompressorInputStream(final InputStream inputStream) throws IOException {\n-        this(inputStream, -1);\n+        this(inputStream, DEFAULT_MEMORY_LIMIT_KiB);\n     }\n \n     /**\n      * Constructs a new instance.\n      *\n      * @param inputStream The underlying input stream.\n-     * @param memoryLimitInKiB maximum allowed estimated memory usage in kibibytes.\n+ * @param memoryLimitKiB maximum allowed estimated memory usage in kibibytes.\n      * @throws IOException if an I/O error occurs.\n      */\n-    public ZCompressorInputStream(final InputStream inputStream, final int memoryLimitInKiB) throws IOException {\n+    public ZCompressorInputStream(final InputStream inputStream, final int memoryLimitKiB) throws IOException {\n         super(inputStream, ByteOrder.LITTLE_ENDIAN);\n         final int firstByte = (int) in.readBits(8);\n         final int secondByte = (int) in.readBits(8);\n@@ -83,7 +84,7 @@\n         if (blockMode) {\n             setClearCode(DEFAULT_CODE_SIZE);\n         }\n-        initializeTables(maxCodeSize, memoryLimitInKiB);\n+        initializeTables(maxCodeSize, memoryLimitKiB);\n         clearEntries();\n     }\n \n",
  "stdout": "",
  "stderr": ""
}