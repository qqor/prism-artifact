{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.8021761000000001,
    "prompt_tokens": 582579,
    "completion_tokens": 36668
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,6 +22,7 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n \n@@ -99,23 +100,32 @@\n     public static void dump(DirectoryEntry root, File parent) throws IOException {\n         for(Iterator<Entry> it = root.getEntries(); it.hasNext();){\n             Entry entry = it.next();\n-            if(entry instanceof DocumentNode){\n-                final DocumentNode node = (DocumentNode) entry;\n-                final byte[] bytes;\n-                try (DocumentInputStream is = new DocumentInputStream(node)) {\n-                   bytes = IOUtils.toByteArray(is);\n-                }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n-                    out.write(bytes);\n-                }\n-            } else if (entry instanceof DirectoryEntry){\n-                DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n-                }\n-                dump(dir, file);\n-            } else {\n+        if (entry instanceof DocumentNode) {\n+            DocumentNode node = (DocumentNode) entry;\n+            byte[] bytes;\n+            try (DocumentInputStream is = new DocumentInputStream(node)) {\n+                bytes = IOUtils.toByteArray(is);\n+            }\n+            Path parentPath = parent.toPath();\n+            String entryName = node.getName().trim();\n+            Path target = parentPath.resolve(entryName).normalize();\n+            if (!target.startsWith(parentPath)) {\n+                throw new IOException(\"Invalid POIFS entry name: \" + entryName);\n+            }\n+            Files.createDirectories(target.getParent());\n+            try (OutputStream out = Files.newOutputStream(target)) {\n+                out.write(bytes);\n+            }\n+        } else if (entry instanceof DirectoryEntry) {\n+            DirectoryEntry dir = (DirectoryEntry) entry;\n+            Path parentPath = parent.toPath();\n+            String entryName = dir.getName().trim();\n+            Path target = parentPath.resolve(entryName).normalize();\n+            if (!target.startsWith(parentPath)) {\n+                throw new IOException(\"Invalid POIFS directory name: \" + entryName);\n+            }\n+            Files.createDirectories(target);\n+            dump(dir, target.toFile());\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n         }\n",
  "stdout": "",
  "stderr": ""
}