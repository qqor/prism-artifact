--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3573,11 +3573,10 @@
 
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
-
-        if (extraSize > buffer_size) {
+        /* ensure buffer can hold existing plus new data */
+        if (used + extraSize > buffer_size) {
             size_t newSize = (used + extraSize) * 2;
-            xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
-
+            xmlChar *tmp = (xmlChar *)xmlRealloc(buffer, newSize + 1);
             if (tmp == NULL) {
                 htmlErrMemory(ctxt);
                 goto error;
