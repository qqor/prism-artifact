{
  "project_name": "libxml2",
  "vulnerability_identifier": "libxml2_lx-delta-03_vuln_004",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-libxml2",
  "llm_usage": {
    "total_cost": 0.4054787000000001,
    "prompt_tokens": 235785,
    "completion_tokens": 33208
  },
  "variant": "sound",
  "diff": "--- a/encoding.c\n+++ b/encoding.c\n@@ -2848,6 +2848,9 @@\n     unsigned char *outstart = out;\n     unsigned long int b0, b1, b2, b3, c, d;\n     int ret = XML_ENC_ERR_SPACE;\n+    /* initialize output boundary for overflow checks */\n+    int outavail = *outlen;\n+    unsigned char *outend = out + outavail;\n \n     if ((in[0] != 0x20) && (in[1] != 0x20) && (in[2] != 0x20) && (in[3] != 0x20)) {\n         /* bom is managed already */\n@@ -2864,22 +2867,37 @@\n         b3 = (b3 << 0x18);\n         c = b0 | b1 | b2 | b3;\n \n-        if (c < 0x80) {\n-            out[0] = c;\n-            in += 4;\n-            out += 1;\n-        } else if (c < 0x800) {\n-            out[0] = (c >> 6)   | 0xC0;\n-            out[1] = (c & 0x3F) | 0x80;\n-            in += 4;\n-            out += 2;\n-        } else if ((c & 0xF800) != 0xD800) {\n-            out[0] =  (c >> 12)         | 0xE0;\n-            out[1] = ((c >>  6) & 0x3F) | 0x80;\n-            out[2] =  (c        & 0x3F) | 0x80;\n-            in += 4;\n-            out += 3;\n-        } else {\n+    if (c < 0x80) {\n+        /* ensure at least 1 byte available */\n+        if (out + 1 > outend) {\n+            ret = XML_ENC_ERR_SPACE;\n+            break;\n+        }\n+        out[0] = c;\n+        in += 4;\n+        out += 1;\n+    } else if (c < 0x800) {\n+        /* ensure at least 2 bytes available */\n+        if (out + 2 > outend) {\n+            ret = XML_ENC_ERR_SPACE;\n+            break;\n+        }\n+        out[0] = (c >> 6)   | 0xC0;\n+        out[1] = (c & 0x3F) | 0x80;\n+        in += 4;\n+        out += 2;\n+    } else if ((c & 0xF800) != 0xD800) {\n+        /* ensure at least 3 bytes available */\n+        if (out + 3 > outend) {\n+            ret = XML_ENC_ERR_SPACE;\n+            break;\n+        }\n+        out[0] = (c >> 12)         | 0xE0;\n+        out[1] = ((c >> 6) & 0x3F) | 0x80;\n+        out[2] = (c & 0x3F)        | 0x80;\n+        in += 4;\n+        out += 3;\n+    } else {\n             /* Surrogate pair */\n             if ((c & 0xFC00) != 0xD800) {\n                 ret = XML_ERR_INTERNAL_ERROR;\n@@ -2901,12 +2919,17 @@\n                 out[2] = ((c >>  6) & 0x3F) | 0x80;\n                 out[3] =  (c        & 0x3F) | 0x80;\n             */\n-            out[0] = c & 0xff;\n-            out[1] = (c >> 8) & 0xff;\n-            out[2] = (c >> 0x10) & 0xff;\n-            out[3] = (c >> 0x18) & 0xff;\n-            in += 4;\n-            out += 4;\n+        /* ensure at least 4 bytes available */\n+        if (out + 4 > outend) {\n+            ret = XML_ENC_ERR_SPACE;\n+            break;\n+        }\n+        out[0] = c & 0xff;\n+        out[1] = (c >> 8) & 0xff;\n+        out[2] = (c >> 0x10) & 0xff;\n+        out[3] = (c >> 0x18) & 0xff;\n+        in += 4;\n+        out += 4;\n         }\n     }\n \n",
  "stdout": "",
  "stderr": ""
}