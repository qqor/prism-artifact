{
  "project_name": "shadowsocks",
  "vulnerability_identifier": "shadowsocks_shadowsocks-full-01_shadowsocks-libev_4",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-shadowsocks-libev",
  "llm_usage": {
    "total_cost": 2.4311958,
    "prompt_tokens": 1768374,
    "completion_tokens": 110451
  },
  "variant": "vulnerable",
  "diff": "--- a/src/json.c\n+++ b/src/json.c\n@@ -266,8 +266,7 @@\n \n    for (state.first_pass = 1; state.first_pass >= 0; -- state.first_pass)\n    {\n-      json_uchar uchar;\n-      unsigned char uc_b1, uc_b2, uc_b3, uc_b4;\n+        /* removed legacy Unicode escape parsing variables */\n       json_char * string = 0;\n       unsigned int string_length = 0;\n \n@@ -302,81 +301,88 @@\n                   case 'r':  string_add ('\\r');  break;\n                   case 't':  string_add ('\\t');  break;\n                   case 'u':\n-\n-                    if (end - state.ptr < 4 || \n-                        (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||\n-                        (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||\n-                        (uc_b3 = hex_value (*++ state.ptr)) == 0xFF ||\n-                        (uc_b4 = hex_value (*++ state.ptr)) == 0xFF)\n+                    \n                     {\n-                        sprintf (error, \"Invalid character value `%c` (at %d:%d)\", b, line_and_col);\n-                        goto e_failed;\n-                    }\n-\n-                    uc_b1 = (uc_b1 << 4) | uc_b2;\n-                    uc_b2 = (uc_b3 << 4) | uc_b4;\n-                    uchar = (uc_b1 << 8) | uc_b2;\n-\n-                    if ((uchar & 0xF800) == 0xD800) {\n-                        json_uchar uchar2;\n-                        \n-                        if (end - state.ptr < 6 || (*++ state.ptr) != '\\\\' || (*++ state.ptr) != 'u' ||\n-                            (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||\n-                            (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||\n-                            (uc_b3 = hex_value (*++ state.ptr)) == 0xFF ||\n-                            (uc_b4 = hex_value (*++ state.ptr)) == 0xFF)\n-                        {\n-                            sprintf (error, \"Invalid character value `%c` (at %d:%d)\", b, line_and_col);\n+                        /* decode Unicode escape (single code unit or surrogate pair) */\n+                        const char *p = state.ptr;\n+                        /* require '\\u' + 4 hex digits */\n+                        if (end - p < 5) {\n+                            sprintf(error, \"Invalid or incomplete '\\\\u' escape at %d:%d\", line_and_col);\n                             goto e_failed;\n                         }\n-\n-                        uc_b1 = (uc_b1 << 4) | uc_b2;\n-                        uc_b2 = (uc_b3 << 4) | uc_b4;\n-                        uchar2 = (uc_b1 << 8) | uc_b2;\n-                        \n-                        uchar = 0x010000 | ((uchar & 0x3FF) << 10) | (uchar2 & 0x3FF);\n-                    }\n-\n-                    if (sizeof (json_char) >= sizeof (json_uchar) || (uchar <= 0x7F))\n-                    {\n-                       string_add ((json_char) uchar);\n-                       break;\n-                    }\n-\n-                    if (uchar <= 0x7FF)\n-                    {\n-                        if (state.first_pass)\n-                           string_length += 2;\n-                        else\n-                        {  string [string_length ++] = 0xC0 | (uchar >> 6);\n-                           string [string_length ++] = 0x80 | (uchar & 0x3F);\n+                        /* parse first code unit */\n+                        unsigned char d1 = hex_value(*(p + 1));\n+                        unsigned char d2 = hex_value(*(p + 2));\n+                        unsigned char d3 = hex_value(*(p + 3));\n+                        unsigned char d4 = hex_value(*(p + 4));\n+                        if (d1 == 0xFF || d2 == 0xFF || d3 == 0xFF || d4 == 0xFF) {\n+                            sprintf(error, \"Invalid character value at %d:%d\", line_and_col);\n+                            goto e_failed;\n                         }\n-\n+                        /* advance past the four hex digits */\n+                        state.ptr = p + 4;\n+                        /* assemble code point */\n+                        json_uchar code = ((json_uchar)d1 << 12) |\n+                                          ((json_uchar)d2 <<  8) |\n+                                          ((json_uchar)d3 <<  4) |\n+                                          (json_uchar)d4;\n+                        /* handle UTF-16 surrogate pair */\n+                        if ((code & 0xF800) == 0xD800) {\n+                            const char *q = state.ptr;\n+                            /* require '\\u' + 4 hex digits */\n+                            if (end - q < 7 || *(q + 1) != '\\\\' || *(q + 2) != 'u') {\n+                                sprintf(error, \"Invalid or incomplete surrogate '\\\\u' at %d:%d\", line_and_col);\n+                                goto e_failed;\n+                            }\n+                            unsigned char e1 = hex_value(*(q + 3));\n+                            unsigned char e2 = hex_value(*(q + 4));\n+                            unsigned char e3 = hex_value(*(q + 5));\n+                            unsigned char e4 = hex_value(*(q + 6));\n+                            if (e1 == 0xFF || e2 == 0xFF || e3 == 0xFF || e4 == 0xFF) {\n+                                sprintf(error, \"Invalid surrogate hex at %d:%d\", line_and_col);\n+                                goto e_failed;\n+                            }\n+                            state.ptr = q + 6;\n+                            json_uchar low = ((json_uchar)e1 << 12) |\n+                                             ((json_uchar)e2 <<  8) |\n+                                             ((json_uchar)e3 <<  4) |\n+                                             (json_uchar)e4;\n+                            code = 0x10000 + (((code & 0x3FF) << 10) | (low & 0x3FF));\n+                        }\n+                        /* UTF-8 emit with two-pass length counting */\n+                        if (code <= 0x7F) {\n+                            if (state.first_pass) {\n+                                string_length++;\n+                            } else {\n+                                string_add((json_char)code);\n+                            }\n+                        } else if (code <= 0x7FF) {\n+                            if (state.first_pass) {\n+                                string_length += 2;\n+                            } else {\n+                                string_add((json_char)(0xC0 | (code >> 6)));\n+                                string_add((json_char)(0x80 | (code & 0x3F)));\n+                            }\n+                        } else if (code <= 0xFFFF) {\n+                            if (state.first_pass) {\n+                                string_length += 3;\n+                            } else {\n+                                string_add((json_char)(0xE0 | (code >> 12)));\n+                                string_add((json_char)(0x80 | ((code >> 6) & 0x3F)));\n+                                string_add((json_char)(0x80 | (code & 0x3F)));\n+                            }\n+                        } else {\n+                            if (state.first_pass) {\n+                                string_length += 4;\n+                            } else {\n+                                string_add((json_char)(0xF0 | (code >> 18)));\n+                                string_add((json_char)(0x80 | ((code >> 12) & 0x3F)));\n+                                string_add((json_char)(0x80 | ((code >> 6) & 0x3F)));\n+                                string_add((json_char)(0x80 | (code & 0x3F)));\n+                            }\n+                        }\n                         break;\n                     }\n-\n-                    if (uchar <= 0xFFFF) {\n-                        if (state.first_pass)\n-                           string_length += 3;\n-                        else\n-                        {  string [string_length ++] = 0xE0 | (uchar >> 12);\n-                           string [string_length ++] = 0x80 | ((uchar >> 6) & 0x3F);\n-                           string [string_length ++] = 0x80 | (uchar & 0x3F);\n-                        }\n-                        \n-                        break;\n-                    }\n-\n-                    if (state.first_pass)\n-                       string_length += 4;\n-                    else\n-                    {  string [string_length ++] = 0xF0 | (uchar >> 18);\n-                       string [string_length ++] = 0x80 | ((uchar >> 12) & 0x3F);\n-                       string [string_length ++] = 0x80 | ((uchar >> 6) & 0x3F);\n-                       string [string_length ++] = 0x80 | (uchar & 0x3F);\n-                    }\n-\n-                    break;\n \n                   default:\n                      string_add (b);\n",
  "stdout": "+ FUZZER=json_fuzz\r\n+ shift\r\n+ '[' '!' -v TESTCASE ']'\r\n+ TESTCASE=/testcase\r\n+ '[' '!' -f /testcase ']'\r\n+ export RUN_FUZZER_MODE=interactive\r\n+ RUN_FUZZER_MODE=interactive\r\n+ export FUZZING_ENGINE=libfuzzer\r\n+ FUZZING_ENGINE=libfuzzer\r\n+ export SKIP_SEED_CORPUS=1\r\n+ SKIP_SEED_CORPUS=1\r\n+ run_fuzzer json_fuzz -runs=100 /testcase\r\nvm.mmap_rnd_bits = 28\r\n/out/json_fuzz -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -timeout_exitcode=0 < /dev/null\r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 3999793940\r\nINFO: Loaded 1 modules   (1928 inline 8-bit counters): 1928 [0x5603b8595ff0, 0x5603b8596778), \r\nINFO: Loaded 1 PC tables (1928 PCs): 1928 [0x5603b8596778,0x5603b859dff8), \r\n/out/json_fuzz: Running 1 inputs 100 time(s) each.\r\nRunning: /testcase\r\n=================================================================\r\n==18==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x5020000000b5 at pc 0x5603b84316c8 bp 0x7ffd9be96550 sp 0x7ffd9be96548\r\nREAD of size 1 at 0x5020000000b5 thread T0\r\nSCARINESS: 12 (1-byte-read-heap-buffer-overflow)\r\n    #0 0x5603b84316c7 in json_parse_ex /src/shadowsocks/src/json.c:626:29\r\n    #1 0x5603b843289c in json_parse /src/shadowsocks/src/json.c:964:11\r\n    #2 0x5603b842bc04 in LLVMFuzzerTestOneInput /src/json_fuzz.c:12:9\r\n    #3 0x5603b82e2a80 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13\r\n    #4 0x5603b82cdcf5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6\r\n    #5 0x5603b82d378f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9\r\n    #6 0x5603b82fea32 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #7 0x7fe4ee8c7082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)\r\n    #8 0x5603b82c5edd in _start (/out/json_fuzz+0x53edd)\r\n\r\nDEDUP_TOKEN: json_parse_ex--json_parse--LLVMFuzzerTestOneInput\r\n0x5020000000b5 is located 0 bytes after 5-byte region [0x5020000000b0,0x5020000000b5)\r\nallocated by thread T0 here:\r\n    #0 0x5603b83ee84f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3\r\n    #1 0x5603b84edda3 in operator new(unsigned long) cxa_noexception.cpp\r\n    #2 0x5603b82cdcf5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6\r\n    #3 0x5603b82d378f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9\r\n    #4 0x5603b82fea32 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #5 0x7fe4ee8c7082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)\r\n\r\nDEDUP_TOKEN: __interceptor_malloc--operator new(unsigned long)--fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)\r\nSUMMARY: AddressSanitizer: heap-buffer-overflow /src/shadowsocks/src/json.c:626:29 in json_parse_ex\r\nShadow bytes around the buggy address:\r\n  0x501ffffffe00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x501ffffffe80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x501fffffff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x501fffffff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x502000000000: fa fa 00 00 fa fa 00 fa fa fa 00 fa fa fa 00 fa\r\n=>0x502000000080: fa fa 05 fa fa fa[05]fa fa fa fa fa fa fa fa fa\r\n  0x502000000100: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x502000000180: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x502000000200: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x502000000280: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x502000000300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==18==ABORTING\r\nsubprocess command returned a non-zero exit status: 1\n",
  "stderr": "INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64 -v /home/user/aixcc/crete/packages/python_oss_fuzz/.oss_fuzz/build/out/shadowsocks:/out -v /tmp/tmp9tkfl15t:/testcase -t ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce json_fuzz -runs=100.\n"
}