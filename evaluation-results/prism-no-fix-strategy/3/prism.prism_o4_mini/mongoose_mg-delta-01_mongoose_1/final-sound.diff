--- a/src/printf.c
+++ b/src/printf.c
@@ -26,11 +26,16 @@
 static void mg_pfn_iobuf_private(char ch, void *param, bool expand) {
   struct mg_iobuf *io = (struct mg_iobuf *) param;
   if (expand && io->len + 2 > io->size) mg_iobuf_resize(io, io->len + 2);
+  if (expand && io->len + 2 > io->size) {
+    /* grow buffer to accommodate char + NUL */
+    mg_iobuf_resize(io, io->len + 2);
+  }
   if (io->len + 2 <= io->size) {
     io->buf[io->len++] = (uint8_t) ch;
-    io->buf[io->len] = 0;
-  } else if (io->len < io->size) {
-    io->buf[io->len++] = 0;  // Guarantee to 0-terminate
+    io->buf[io->len] = '\0';
+  } else if (io->len + 1 <= io->size) {
+    /* only room for NUL terminator */
+    io->buf[io->len++] = '\0';
   }
 }
 

--- a/src/fmt.c
+++ b/src/fmt.c
@@ -272,7 +272,8 @@
       if (c == 'd' || c == 'u' || c == 'x' || c == 'X' || c == 'p' ||
           c == 'g' || c == 'f') {
         bool s = (c == 'd'), h = (c == 'x' || c == 'X' || c == 'p');
-        char tmp[40];
+        /* enlarge buffer to avoid overflow in general formatting */
+        char tmp[128];
         size_t xl = x ? 2 : 0;
         if (c == 'g' || c == 'f') {
           double v = va_arg(*ap, double);
@@ -315,7 +316,8 @@
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+        /* enlarge buffer to avoid overflow in exponential formatting */
+        char tmp[128];
           double d = va_arg(*ap, double);
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);

--- a/mongoose.c
+++ b/mongoose.c
@@ -774,7 +774,8 @@
       if (c == 'd' || c == 'u' || c == 'x' || c == 'X' || c == 'p' ||
           c == 'g' || c == 'f') {
         bool s = (c == 'd'), h = (c == 'x' || c == 'X' || c == 'p');
-        char tmp[40];
+            /* enlarge buffer to avoid overflow in general formatting */
+            char tmp[128];
         size_t xl = x ? 2 : 0;
         if (c == 'g' || c == 'f') {
           double v = va_arg(*ap, double);
@@ -817,7 +818,8 @@
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+            /* enlarge buffer to avoid overflow in exponential formatting */
+            char tmp[128];
           double d = va_arg(*ap, double);
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);
