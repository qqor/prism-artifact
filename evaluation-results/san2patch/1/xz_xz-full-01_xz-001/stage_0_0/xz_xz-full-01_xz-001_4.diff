diff --git a/src/liblzma/check/treeck.c b/src/liblzma/check/treeck.c
index f54d244e..29267d93 100644
--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -70,22 +70,25 @@ static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
     return 0;
   }
 
-  // Compute initial checksum from depth and value
-  uint32_t sum = node->value * (depth + 1);
-
-  // Traverse the child nodes if not already visited
-  if (node->state == STATE_CLEAR) {
-    node->state = STATE_VISITED;
-    for (size_t i = 0; i < node->edge_count; ++i) {
-      TreeNode *child = node->edges[i];
-      if (child) {
-        sum += compute_tree_checksum(child, depth + 1);
+  uint32_t sum;
+  {
+    // Compute initial checksum from depth and value
+    sum = node->value * (depth + 1);
+
+    // Traverse the child nodes if not already visited
+    if (node->state == STATE_CLEAR) {
+      node->state = STATE_VISITED;
+      for (size_t i = 0; i < node->edge_count; ++i) {
+        TreeNode *child = node->edges[i];
+        if (child) {
+          sum += compute_tree_checksum(child, depth + 1);
+        }
       }
+      node->state = STATE_HASHED;
     }
-    node->state = STATE_HASHED;
   }
 
-  // Free the node and edges
+  // Free memory after checksum is fully computed
   free(node->edges);
   free(node);
 
