diff --git a/src/net_builtin.c b/src/net_builtin.c
index 793874f4..b320c51e 100644
--- a/src/net_builtin.c
+++ b/src/net_builtin.c
@@ -380,11 +380,19 @@ static void rx_arp(struct mg_tcpip_if *ifp, struct pkt *pkt) {
 }
 
 static void rx_icmp(struct mg_tcpip_if *ifp, struct pkt *pkt) {
-  // MG_DEBUG(("ICMP %d", (int) len));
+// FIXME: Crash CWE-125: Out-of-bounds Read
+   // MG_DEBUG(("ICMP %d", (int)len));
   if (pkt->icmp->type == 8 && pkt->ip != NULL && pkt->ip->dst == ifp->ip) {
-    size_t hlen = sizeof(struct eth) + sizeof(struct ip) + sizeof(struct icmp);
-    size_t space = ifp->tx.len - hlen, plen = pkt->pay.len;
-    if (plen > space) plen = space;
+    // Reject invalid IP header length
+    if (pkt->ip->ihl < 5) return;
+    size_t ip_hl = pkt->ip->ihl * 4;
+    size_t hlen = sizeof(struct eth) + ip_hl + sizeof(struct icmp);
+    // Check total packet length before proceeding
+    if (pkt->len < hlen) return;
+    size_t available = pkt->len - hlen;
+    size_t plen = pkt->pay.len < available ? pkt->pay.len : available;
+    size_t tx_space = ifp->tx.len - hlen;
+    if (plen > tx_space) plen = tx_space;
     struct ip *ip = tx_ip(ifp, pkt->eth->src, 1, ifp->ip, pkt->ip->src,
                           sizeof(struct icmp) + plen);
     struct icmp *icmp = (struct icmp *) (ip + 1);
