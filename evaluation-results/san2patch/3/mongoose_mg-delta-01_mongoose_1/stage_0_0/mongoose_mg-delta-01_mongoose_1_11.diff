diff --git a/src/fmt.c b/src/fmt.c
index 8164e1ca..12b6858d 100644
--- a/src/fmt.c
+++ b/src/fmt.c
@@ -220,16 +220,25 @@ static size_t mg_lld(char *buf, int64_t val, bool is_signed, bool is_hex) {
   // Reverse a string
   for (i = 0; i < n / 2; i++) {
     char t = buf[s + i];
-    buf[s + i] = buf[s + n - i - 1], buf[s + n - i - 1] = t;
+  buf[s + i] = buf[s + n - i - 1], buf[s + n - i - 1] = t;
   }
   if (val == 0) buf[n++] = '0';  // Handle special case
   return n + s;
 }
 
+/*
+ * Rationale: reserve the last byte of buf for a forced null terminator to
+ * guarantee we never read past the buffer boundary.
+ */
 static size_t scpy(void (*out)(char, void *), void *ptr, char *buf,
                           size_t len) {
+  if (len == 0) return 0;
+  buf[len - 1] = '\0';
   size_t i = 0;
-  while (i < len && buf[i] != '\0') out(buf[i++], ptr);
+  while (buf[i] != '\0') {
+    out(buf[i], ptr);
+    i++;
+  }
   return i;
 }
 
@@ -241,7 +250,6 @@ size_t mg_xprintf(void (*out)(char, void *), void *ptr, const char *fmt, ...) {
   va_end(ap);
   return len;
 }
-
 size_t mg_vxprintf(void (*out)(char, void *), void *param, const char *fmt,
                    va_list *ap) {
   size_t i = 0, n = 0;
@@ -315,17 +323,20 @@ size_t mg_vxprintf(void (*out)(char, void *), void *param, const char *fmt,
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+          size_t buf_size = 32;
+          char *tmp = (char *)malloc(buf_size);
+          if (tmp == NULL) break;
           double d = va_arg(*ap, double);
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
-          n += scpy(out, param, tmp, k);
+          k = mg_dtoa(tmp, buf_size, mantissa, 8, c == 'e');
+          n += scpy(out, param, tmp, k, buf_size);
           out(c, param);
           n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
-          n += scpy(out, param, tmp, k);
-	  } else if (c == '%') {
+          k = mg_lld(tmp, exponent, 1, 0);
+          n += scpy(out, param, tmp, k, buf_size);
+          free(tmp);
+      } else if (c == '%') {
         out('%', param);
         n++;
       } else {
