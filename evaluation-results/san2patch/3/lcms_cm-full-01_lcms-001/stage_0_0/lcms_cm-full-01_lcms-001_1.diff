diff --git a/src/cmsps2.c b/src/cmsps2.c
index cb2db85..1ea4995 100644
--- a/src/cmsps2.c
+++ b/src/cmsps2.c
@@ -1049,7 +1049,6 @@ cmsUInt32Number GenerateCSA(cmsContext ContextID,
     }
     else {
 
-
         // Any profile class are allowed (including devicelink), but
         // output (PCS) colorspace must be XYZ or Lab
         cmsColorSpaceSignature ColorSpace = cmsGetPCS(hProfile);
@@ -1066,16 +1065,20 @@ cmsUInt32Number GenerateCSA(cmsContext ContextID,
         lut = _cmsReadInputLUT(hProfile, Intent);
         if (lut == NULL) goto Error;
 
+        {
+            // Manually fetch and validate stages
+            cmsStage* ShaperStage = cmsStageType(lut, cmsSigCurveSetElemType);
+            cmsStage* MatrixStage = cmsStageType(lut, cmsSigMatrixElemType);
 
-        // Tone curves + matrix can be implemented without any LUT
-        if (cmsPipelineCheckAndRetreiveStages(lut, 2, cmsSigCurveSetElemType, cmsSigMatrixElemType, &Shaper, &Matrix)) {
-
-            if (!WriteInputMatrixShaper(mem, hProfile, Matrix, Shaper)) goto Error;
-
-        }
-        else {
-           // We need a LUT for the rest
-           if (!WriteInputLUT(mem, hProfile, Intent, dwFlags)) goto Error;
+            if (ShaperStage != NULL && MatrixStage != NULL) {
+                if (!WriteInputMatrixShaper(mem, hProfile, MatrixStage, ShaperStage)) goto Error;
+            }
+            else {
+                // Missing stage, fallback to LUT
+                cmsSignalError(ContextID, cmsERROR_RANGE,
+                               "Required stage missing, falling back to LUT");
+                if (!WriteInputLUT(mem, hProfile, Intent, dwFlags)) goto Error;
+            }
         }
     }
 
