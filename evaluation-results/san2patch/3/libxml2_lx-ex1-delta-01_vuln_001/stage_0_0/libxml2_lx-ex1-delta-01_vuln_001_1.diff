diff --git a/HTMLparser.c b/HTMLparser.c
index 9c34e9e8..1c8235b9 100644
--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -2837,15 +2837,13 @@ next_chunk:
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
-            if (tmp == NULL) {
+         // FIXME: Crash CWE-787: Out-of-bounds Write
+         if (chunkSize > 0) {
+            size_t remaining = buffer_size - used;
+            if (chunkSize > remaining) {
                 htmlErrMemory(ctxt);
                 goto error;
             }
-            buffer = tmp;
-            buffer_size = newSize;
-        }
-
-        if (chunkSize > 0) {
             input->cur += chunkSize;
             memcpy(buffer + used, chunk, chunkSize);
             used += chunkSize;
@@ -2853,12 +2851,16 @@ next_chunk:
 
         input->cur += skip;
         if (replSize > 0) {
+            size_t remaining2 = buffer_size - used;
+            if (replSize > remaining2) {
+                htmlErrMemory(ctxt);
+                goto error;
+            }
             memcpy(buffer + used, repl, replSize);
             used += replSize;
         }
 
         SHRINK;
-
         if (termSkip >= 0)
             break;
 
@@ -3578,15 +3580,13 @@ next_chunk:
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
-            if (tmp == NULL) {
+         // FIXME: Crash CWE-787: Out-of-bounds Write
+         if (chunkSize > 0) {
+            size_t remaining = buffer_size - used;
+            if (chunkSize > remaining) {
                 htmlErrMemory(ctxt);
                 goto error;
             }
-            buffer = tmp;
-            buffer_size = newSize;
-        }
-
-        if (chunkSize > 0) {
             input->cur += chunkSize;
             memcpy(buffer + used, chunk, chunkSize);
             used += chunkSize;
@@ -3594,12 +3594,16 @@ next_chunk:
 
         input->cur += skip;
         if (replSize > 0) {
+            size_t remaining2 = buffer_size - used;
+            if (replSize > remaining2) {
+                htmlErrMemory(ctxt);
+                goto error;
+            }
             memcpy(buffer + used, repl, replSize);
             used += replSize;
         }
 
         SHRINK;
-
         if (termSkip >= 0)
             break;
 
