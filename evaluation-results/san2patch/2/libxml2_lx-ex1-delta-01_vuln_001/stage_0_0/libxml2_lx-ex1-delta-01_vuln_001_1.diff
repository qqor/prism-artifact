diff --git a/HTMLparser.c b/HTMLparser.c
index 9c34e9e8..8bd83371 100644
--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -2612,6 +2612,7 @@ htmlParseData(htmlParserCtxtPtr ctxt, htmlAsciiMask mask,
     used = 0;
     buffer_size = ctxt->spaceMax;
     buffer = (xmlChar *) ctxt->spaceTab;
+    // FIXME: Crash CWE-787: Out-of-bounds Write
     if (buffer == NULL) {
         buffer_size = 500;
         buffer = xmlMalloc(buffer_size + 1);
@@ -2620,12 +2621,24 @@ htmlParseData(htmlParserCtxtPtr ctxt, htmlAsciiMask mask,
             return(NULL);
         }
     }
+    // On-demand exact expansion to fit new data
 
     line = input->line;
     col = input->col;
 
     while (!PARSER_STOPPED(ctxt)) {
-        const xmlChar *chunk, *in, *repl;
+        // Expand buffer exactly to fit new data chunk
+        if (used + chunkSize + 1 > buffer_size) {
+            size_t needed = used + chunkSize;
+            xmlChar *tmp = (xmlChar *)xmlRealloc(buffer, needed + 1);
+            if (tmp == NULL) {
+                htmlErrMemory(ctxt);
+                xmlFree(buffer);
+                return(NULL);
+            }
+            buffer = tmp;
+            buffer_size = needed;
+        }        const xmlChar *chunk, *in, *repl;
         size_t avail, chunkSize, extraSize;
         int replSize;
         int skip = 0;
@@ -2837,24 +2850,21 @@ next_chunk:
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
-            if (tmp == NULL) {
-                htmlErrMemory(ctxt);
-                goto error;
-            }
-            buffer = tmp;
-            buffer_size = newSize;
         }
 
+        // FIXME: Crash CWE-787: Out-of-bounds Write
         if (chunkSize > 0) {
             input->cur += chunkSize;
-            memcpy(buffer + used, chunk, chunkSize);
-            used += chunkSize;
+            size_t toCopy = (chunkSize <= buffer_size - used) ? chunkSize : buffer_size - used;
+            memcpy(buffer + used, chunk, toCopy);
+            used += toCopy;
         }
 
         input->cur += skip;
         if (replSize > 0) {
-            memcpy(buffer + used, repl, replSize);
-            used += replSize;
+            size_t toCopy2 = (replSize <= buffer_size - used) ? replSize : buffer_size - used;
+            memcpy(buffer + used, repl, toCopy2);
+            used += toCopy2;
         }
 
         SHRINK;
@@ -3330,6 +3340,7 @@ htmlSecureComment(htmlParserCtxtPtr ctxt, htmlAsciiMask mask,
     used = 0;
     buffer_size = ctxt->spaceMax;
     buffer = (xmlChar *) ctxt->spaceTab;
+    // FIXME: Crash CWE-787: Out-of-bounds Write
     if (buffer == NULL) {
         buffer_size = 500;
         buffer = xmlMalloc(buffer_size + 1);
@@ -3338,12 +3349,24 @@ htmlSecureComment(htmlParserCtxtPtr ctxt, htmlAsciiMask mask,
             return(NULL);
         }
     }
+    // On-demand exact expansion to fit new data
 
     line = input->line;
     col = input->col;
 
     while (!PARSER_STOPPED(ctxt)) {
-        const xmlChar *chunk, *in, *repl;
+        // Expand buffer exactly to fit new data chunk
+        if (used + chunkSize + 1 > buffer_size) {
+            size_t needed = used + chunkSize;
+            xmlChar *tmp = (xmlChar *)xmlRealloc(buffer, needed + 1);
+            if (tmp == NULL) {
+                htmlErrMemory(ctxt);
+                xmlFree(buffer);
+                return(NULL);
+            }
+            buffer = tmp;
+            buffer_size = needed;
+        }        const xmlChar *chunk, *in, *repl;
         size_t avail, chunkSize, extraSize;
         int replSize;
         int skip = 0;
@@ -3578,24 +3601,21 @@ next_chunk:
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
-            if (tmp == NULL) {
-                htmlErrMemory(ctxt);
-                goto error;
-            }
-            buffer = tmp;
-            buffer_size = newSize;
         }
 
+        // FIXME: Crash CWE-787: Out-of-bounds Write
         if (chunkSize > 0) {
             input->cur += chunkSize;
-            memcpy(buffer + used, chunk, chunkSize);
-            used += chunkSize;
+            size_t toCopy = (chunkSize <= buffer_size - used) ? chunkSize : buffer_size - used;
+            memcpy(buffer + used, chunk, toCopy);
+            used += toCopy;
         }
 
         input->cur += skip;
         if (replSize > 0) {
-            memcpy(buffer + used, repl, replSize);
-            used += replSize;
+            size_t toCopy2 = (replSize <= buffer_size - used) ? replSize : buffer_size - used;
+            memcpy(buffer + used, repl, toCopy2);
+            used += toCopy2;
         }
 
         SHRINK;
