diff --git a/src/printf.c b/src/printf.c
index d9998ccf..cbbc135a 100644
--- a/src/printf.c
+++ b/src/printf.c
@@ -3,15 +3,23 @@
 #include "util.h"
 
 size_t mg_queue_vprintf(struct mg_queue *q, const char *fmt, va_list *ap) {
-  size_t len = mg_snprintf(NULL, 0, fmt, ap);
-  char *buf;
-  if (len == 0 || mg_queue_book(q, &buf, len + 1) < len + 1) {
-    len = 0;  // Nah. Not enough space
-  } else {
-    len = mg_vsnprintf((char *) buf, len + 1, fmt, ap);
-    mg_queue_add(q, len);
-  }
-  return len;
+	/* First compute required buffer size */
+	size_t len = mg_snprintf(NULL, 0, fmt, ap);
+	char *buf;
+	/* Reserve an extra byte to detect overflow, then truncate if needed */
+	if (len == 0 || mg_queue_book(q, &buf, len + 2) < len + 2) {
+		len = 0;
+	} else {
+		/* Write into buf, allowing one extra slot */
+		size_t ret = mg_vsnprintf(buf, len + 2, fmt, ap);
+		/* Ensure NUL-termination */
+		buf[len + 1] = '\0';
+		/* Truncate if overflow happened */
+		if (ret > len) ret = len;
+		mg_queue_add(q, ret);
+		len = ret;
+	}
+	return len;
 }
 
 size_t mg_queue_printf(struct mg_queue *q, const char *fmt, ...) {
