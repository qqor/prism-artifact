diff --git a/src/printf.c b/src/printf.c
index d9998ccf..b9e00ba6 100644
--- a/src/printf.c
+++ b/src/printf.c
@@ -3,15 +3,29 @@
 #include "util.h"
 
 size_t mg_queue_vprintf(struct mg_queue *q, const char *fmt, va_list *ap) {
-  size_t len = mg_snprintf(NULL, 0, fmt, ap);
-  char *buf;
-  if (len == 0 || mg_queue_book(q, &buf, len + 1) < len + 1) {
-    len = 0;  // Nah. Not enough space
-  } else {
-    len = mg_vsnprintf((char *) buf, len + 1, fmt, ap);
-    mg_queue_add(q, len);
-  }
-  return len;
+	/* Determine required size and always copy va_list before use */
+	va_list ap_copy;
+	va_copy(ap_copy, *ap);
+	size_t need = mg_snprintf(NULL, 0, fmt, &ap_copy);
+	va_end(ap_copy);
+
+	char *buf;
+	if (need <= 0 || mg_queue_book(q, &buf, (size_t)need + 1) < (size_t)need + 1) {
+		return 0;
+	}
+	/* Second copy for the write phase */
+	va_copy(ap_copy, *ap);
+	size_t written = mg_vsnprintf(buf, (size_t)need + 1, fmt, &ap_copy);
+	va_end(ap_copy);
+
+	/* If the formatter silently overflows its internal buffer, truncate */
+	if (written < 0) {
+		written = 0;
+	} else if ((size_t)written > (size_t)need) {
+		written = need;
+	}
+	mg_queue_add(q, (size_t)written);
+	return (size_t)written;
 }
 
 size_t mg_queue_printf(struct mg_queue *q, const char *fmt, ...) {
