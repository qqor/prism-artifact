diff --git a/src/printf.c b/src/printf.c
index d9998ccf..201c378c 100644
--- a/src/printf.c
+++ b/src/printf.c
@@ -3,15 +3,28 @@
 #include "util.h"
 
 size_t mg_queue_vprintf(struct mg_queue *q, const char *fmt, va_list *ap) {
-  size_t len = mg_snprintf(NULL, 0, fmt, ap);
-  char *buf;
-  if (len == 0 || mg_queue_book(q, &buf, len + 1) < len + 1) {
-    len = 0;  // Nah. Not enough space
-  } else {
-    len = mg_vsnprintf((char *) buf, len + 1, fmt, ap);
-    mg_queue_add(q, len);
-  }
-  return len;
+	/* Copy va_list for use in custom snprintf calls */
+	va_list ap0;
+	va_copy(ap0, *ap);
+	/* Compute required length using our own mg_snprintf */
+	size_t len = mg_snprintf(NULL, 0, fmt, &ap0);
+	va_end(ap0);
+
+	char *buf;
+	if (len == 0 || mg_queue_book(q, &buf, len + 1) < len + 1) {
+		len = 0;  // Not enough space
+	} else {
+		va_list ap1;
+		va_copy(ap1, *ap);
+		/* Write into buffer, but never exceed len+1 bytes */
+		size_t ret = mg_vsnprintf(buf, len + 1, fmt, &ap1);
+		va_end(ap1);
+		/* Clamp in case of unexpectedly large return */
+		if (ret > len) ret = len;
+		mg_queue_add(q, ret);
+		len = ret;
+	}
+	return len;
 }
 
 size_t mg_queue_printf(struct mg_queue *q, const char *fmt, ...) {
