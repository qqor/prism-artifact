diff --git a/src/fmt.c b/src/fmt.c
index 8164e1ca..489af91d 100644
--- a/src/fmt.c
+++ b/src/fmt.c
@@ -306,32 +306,27 @@ size_t mg_vxprintf(void (*out)(char, void *), void *param, const char *fmt,
         int ch = va_arg(*ap, int);
         out((char) ch, param);
         n++;
-      } else if (c == 's') {
-        char *p = va_arg(*ap, char *);
-        if (pr == ~0U) pr = p == NULL ? 0 : strlen(p);
-        for (j = 0; !minus && pr < w && j + pr < w; j++)
-          n += scpy(out, param, &pad, 1);
-        n += scpy(out, param, p, pr);
-        for (j = 0; minus && pr < w && j + pr < w; j++)
-          n += scpy(out, param, &pad, 1);
-      } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+      } else       } else if (c == 'e' || c == 'E') {
+		  char mantbuf[32];
+          char expbuf[16];
           double d = va_arg(*ap, double);
+          /* choose precision or default to 6 */
+          int precision = (pr == ~0U ? 6 : pr);
+          /* compute exponent and mantissa */
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
-          n += scpy(out, param, tmp, k);
-          out(c, param);
-          n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
-          n += scpy(out, param, tmp, k);
-	  } else if (c == '%') {
-        out('%', param);
-        n++;
-      } else {
-        out('%', param);
-        out(c, param);
-        n += 2;
+          /* format mantissa part safely */
+          int mlen = snprintf(mantbuf, sizeof(mantbuf), "%.*f", precision, mantissa);
+          if (mlen < 0) mlen = 0;
+          else if (mlen >= (int)sizeof(mantbuf)) mlen = sizeof(mantbuf) - 1;
+          n += scpy(out, param, mantbuf, mlen);
+          /* output exponent delimiter and sign */
+          n += scpy(out, param, "e", 1);
+          /* format exponent part safely */
+          int elen = snprintf(expbuf, sizeof(expbuf), "%+lld", (long long)exponent);
+          if (elen < 0) elen = 0;
+          else if (elen >= (int)sizeof(expbuf)) elen = sizeof(expbuf) - 1;
+          n += scpy(out, param, expbuf, elen);
       }
       i++;
     } else {
