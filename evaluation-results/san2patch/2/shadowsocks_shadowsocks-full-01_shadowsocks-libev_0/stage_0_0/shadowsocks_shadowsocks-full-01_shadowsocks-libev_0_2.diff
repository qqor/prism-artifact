diff --git a/src/json.c b/src/json.c
index 2a91900..ce9a87f 100644
--- a/src/json.c
+++ b/src/json.c
@@ -264,11 +264,14 @@ json_value * json_parse_ex (json_settings * settings,
    state.uint_max -= 8; /* limit of how much can be added before next check */
    state.ulong_max -= 8;
 
+   /* pre-calculate remaining length to avoid overflow */
    for (state.first_pass = 1; state.first_pass >= 0; -- state.first_pass)
    {
+      size_t rem = (size_t)(end - state.ptr);
+      if (rem < 5)    /* need at least 4 more chars for \uXXXX */
+         goto error;
       json_uchar uchar;
-      unsigned char uc_b1, uc_b2, uc_b3, uc_b4;
-      json_char * string = 0;
+      unsigned char uc_b1, uc_b2, uc_b3, uc_b4;      json_char * string = 0;
       unsigned int string_length = 0;
 
       top = root = 0;
