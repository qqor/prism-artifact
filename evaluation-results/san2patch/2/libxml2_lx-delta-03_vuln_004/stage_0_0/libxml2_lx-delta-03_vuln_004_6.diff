diff --git a/encoding.c b/encoding.c
index adecdcc6..723e4a83 100644
--- a/encoding.c
+++ b/encoding.c
@@ -2865,18 +2865,28 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
         c = b0 | b1 | b2 | b3;
 
         if (c < 0x80) {
-            out[0] = c;
+            /* pack into a small temp buffer and memcpy with bounds check */
+            unsigned char tmp[1];
+            tmp[0] = c;
+            if (outend - out < 1) { ret = XML_ERR_INTERNAL_ERROR; break; }
+            memcpy(out, tmp, 1);
             in += 4;
             out += 1;
         } else if (c < 0x800) {
-            out[0] = (c >> 6)   | 0xC0;
-            out[1] = (c & 0x3F) | 0x80;
+            unsigned char tmp[2];
+            tmp[0] = (c >> 6)   | 0xC0;
+            tmp[1] = (c & 0x3F) | 0x80;
+            if (outend - out < 2) { ret = XML_ERR_INTERNAL_ERROR; break; }
+            memcpy(out, tmp, 2);
             in += 4;
             out += 2;
         } else if ((c & 0xF800) != 0xD800) {
-            out[0] =  (c >> 12)         | 0xE0;
-            out[1] = ((c >>  6) & 0x3F) | 0x80;
-            out[2] =  (c        & 0x3F) | 0x80;
+            unsigned char tmp[3];
+            tmp[0] =  (c >> 12)         | 0xE0;
+            tmp[1] = ((c >>  6) & 0x3F) | 0x80;
+            tmp[2] =  (c        & 0x3F) | 0x80;
+            if (outend - out < 3) { ret = XML_ERR_INTERNAL_ERROR; break; }
+            memcpy(out, tmp, 3);
             in += 4;
             out += 3;
         } else {
@@ -2885,26 +2895,20 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-	        if (inend - in < 4)
-		        break;
+            if (inend - in < 4)
+                break;
+            unsigned char tmp[4];
             d = in[2] | (in[3] << 8);
             if ((d & 0xFC00) != 0xDC00) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-            /*
-                simplified due to encoding errors encountered with:
-
-                c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);
-                out[0] =  (c >> 18)         | 0xF0;
-                out[1] = ((c >> 12) & 0x3F) | 0x80;
-                out[2] = ((c >>  6) & 0x3F) | 0x80;
-                out[3] =  (c        & 0x3F) | 0x80;
-            */
-            out[0] = c & 0xff;
-            out[1] = (c >> 8) & 0xff;
-            out[2] = (c >> 0x10) & 0xff;
-            out[3] = (c >> 0x18) & 0xff;
+            tmp[0] = c & 0xff;
+            tmp[1] = (c >> 8) & 0xff;
+            tmp[2] = (c >> 0x10) & 0xff;
+            tmp[3] = (c >> 0x18) & 0xff;
+            if (outend - out < 4) { ret = XML_ERR_INTERNAL_ERROR; break; }
+            memcpy(out, tmp, 4);
             in += 4;
             out += 4;
         }
