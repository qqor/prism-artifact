diff --git a/libfreerdp/codec/rfx.c b/libfreerdp/codec/rfx.c
index 3b9168ab6..b457a514a 100644
--- a/libfreerdp/codec/rfx.c
+++ b/libfreerdp/codec/rfx.c
@@ -707,9 +707,9 @@ static INLINE BOOL rfx_process_message_frame_end(RFX_CONTEXT* WINPR_RESTRICT con
 }
 
 static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT context,
-												RFX_MESSAGE* WINPR_RESTRICT message,
-												wStream* WINPR_RESTRICT s,
-												UINT16* WINPR_RESTRICT pExpectedBlockType)
+                                                RFX_MESSAGE* WINPR_RESTRICT message,
+                                                wStream* WINPR_RESTRICT s,
+                                                UINT16* WINPR_RESTRICT pExpectedBlockType)
 {
 	UINT32 magic = 0;
 
@@ -731,7 +731,23 @@ static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT cont
 		WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
 		return FALSE;
 	}
-	*(UINT64*)metadataBlock = metadataData;
+
+	/* Candidate 4: safe copy with memmove and check written bytes */
+	{
+		uint8_t* base = context->priv->metadataBlock;
+		size_t bufSize = METADATA_BLOCK_SIZE;
+		size_t off = (size_t)((uint8_t*)metadataBlock - base);
+		size_t toWrite = sizeof(metadataData);
+		if (off + toWrite > bufSize)
+			toWrite = bufSize - off;
+		memmove(metadataBlock, &metadataData, toWrite);
+		if (toWrite < sizeof(metadataData))
+		{
+			WLog_Print(context->priv->log, WLOG_ERROR,
+			           "partial metadata write: wrote %zu of %zu bytes", toWrite, sizeof(metadataData));
+			return FALSE;
+		}
+	}
 	return TRUE;
 }
 
@@ -1273,64 +1289,73 @@ BOOL rfx_process_message(RFX_CONTEXT* WINPR_RESTRICT context, const BYTE* WINPR_
 		Stream_Seek(s, subStreamLen);
 
 		switch (blockType)
-		{
-			/* Header messages:
-			 * The stream MUST start with the header messages and any of these headers can appear
-			 * in the stream at a later stage. The header messages can be repeated.
-			 */
-			case WBT_SYNC:
-				ok = rfx_process_message_sync(context, subStream);
-				break;
-
-			case WBT_CONTEXT:
-				ok = rfx_process_message_context(context, subStream);
-				break;
-
-			case WBT_CODEC_VERSIONS:
-				ok = rfx_process_message_codec_versions(context, subStream);
-				break;
-
-			case WBT_CHANNELS:
-				ok = rfx_process_message_channels(context, subStream);
-				break;
-
-				/* Data messages:
-				 * The data associated with each encoded frame or image is always bracketed by the
-				 * TS_RFX_FRAME_BEGIN (section 2.2.2.3.1) and TS_RFX_FRAME_END (section 2.2.2.3.2)
-				 * messages. There MUST only be one TS_RFX_REGION (section 2.2.2.3.3) message per
-				 * frame and one TS_RFX_TILESET (section 2.2.2.3.4) message per TS_RFX_REGION.
-				 */
-
-			case WBT_FRAME_BEGIN:
-				ok = rfx_process_message_frame_begin(context, message, subStream,
-				                                     &context->expectedDataBlockType);
-				break;
-
-			case WBT_REGION:
-				ok = rfx_process_message_region(context, message, subStream,
-				                                &context->expectedDataBlockType);
-				break;
-
-			case WBT_EXTENSION:
-				ok = rfx_process_message_tileset(context, message, subStream,
-				                                 &context->expectedDataBlockType);
-				break;
-
-			case WBT_METADATA:
-				ok = rfx_process_message_metadata(context, message, subStream,
-				                                 &context->expectedDataBlockType);
-				break;
-
-			case WBT_FRAME_END:
-				ok = rfx_process_message_frame_end(context, message, subStream,
-				                                   &context->expectedDataBlockType);
-				break;
-
-			default:
-				WLog_Print(context->priv->log, WLOG_ERROR, "unknown blockType 0x%" PRIX32 "",
-				           blockType);
-				return FALSE;
-		}
+        {
+            /* Header messages:
+             * The stream MUST start with the header messages and any of these headers can appear
+             * in the stream at a later stage. The header messages can be repeated.
+             */
+            case WBT_SYNC:
+                ok = rfx_process_message_sync(context, subStream);
+                break;
+
+            case WBT_CONTEXT:
+                ok = rfx_process_message_context(context, subStream);
+                break;
+
+            case WBT_CODEC_VERSIONS:
+                ok = rfx_process_message_codec_versions(context, subStream);
+                break;
+
+            case WBT_CHANNELS:
+                ok = rfx_process_message_channels(context, subStream);
+                break;
+
+                /* Data messages:
+                 * The data associated with each encoded frame or image is always bracketed by the
+                 * TS_RFX_FRAME_BEGIN (section 2.2.2.3.1) and TS_RFX_FRAME_END (section 2.2.2.3.2)
+                 * messages. There MUST only be one TS_RFX_REGION (section 2.2.2.3.3) message per
+                 * frame and one TS_RFX_TILESET (section 2.2.2.3.4) message per TS_RFX_REGION.
+                 */
+
+            case WBT_FRAME_BEGIN:
+                ok = rfx_process_message_frame_begin(context, message, subStream,
+                                                     &context->expectedDataBlockType);
+                break;
+
+            case WBT_REGION:
+                ok = rfx_process_message_region(context, message, subStream,
+                                                &context->expectedDataBlockType);
+                break;
+
+            case WBT_EXTENSION:
+                ok = rfx_process_message_tileset(context, message, subStream,
+                                                 &context->expectedDataBlockType);
+                break;
+// FIXME: Crash CWE-787: Out-of-bounds Write
+ 
+            case WBT_METADATA:
+                /* safe wrapper: validate then process */
+                if (rfx_validate_metadata(context, message, subStream))
+                    ok = rfx_process_message_metadata(context, message, subStream,
+                                                     &context->expectedDataBlockType);
+                else
+                {
+                    WLog_Print(context->priv->log, WLOG_ERROR,
+                               "invalid metadata parameters");
+                    ok = FALSE;
+                }
+                break;
+
+            case WBT_FRAME_END:
+                ok = rfx_process_message_frame_end(context, message, subStream,
+                                                   &context->expectedDataBlockType);
+                break;
+
+            default:
+                WLog_Print(context->priv->log, WLOG_ERROR, "unknown blockType 0x%" PRIX32 "",
+                           blockType);
+                return FALSE;
+        }
 	}
 
 	if (ok)
