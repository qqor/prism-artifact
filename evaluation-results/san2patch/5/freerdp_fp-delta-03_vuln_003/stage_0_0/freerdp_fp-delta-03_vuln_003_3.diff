diff --git a/libfreerdp/codec/rfx.c b/libfreerdp/codec/rfx.c
index 3b9168ab6..7749d5cf4 100644
--- a/libfreerdp/codec/rfx.c
+++ b/libfreerdp/codec/rfx.c
@@ -707,32 +707,67 @@ static INLINE BOOL rfx_process_message_frame_end(RFX_CONTEXT* WINPR_RESTRICT con
 }
 
 static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT context,
-												RFX_MESSAGE* WINPR_RESTRICT message,
-												wStream* WINPR_RESTRICT s,
-												UINT16* WINPR_RESTRICT pExpectedBlockType)
-{
-	UINT32 magic = 0;
-
-	WINPR_ASSERT(context);
-	WINPR_ASSERT(context->priv);
-	WINPR_ASSERT(message);
-	WINPR_ASSERT(s);
-	WINPR_ASSERT(pExpectedBlockType);
-
-	if (*pExpectedBlockType != WBT_FRAME_END)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
-		return FALSE;
-	}
-
-	Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
-	if (magic != WF_MAGIC)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
-		return FALSE;
-	}
-	*(UINT64*)metadataBlock = metadataData;
-	return TRUE;
+                                                RFX_MESSAGE* WINPR_RESTRICT message,
+                                                wStream* WINPR_RESTRICT s,
+                                                UINT16* WINPR_RESTRICT pExpectedBlockType)
+{
+    UINT32 magic = 0;
+    UINT16 entries;
+
+    WINPR_ASSERT(context);
+    WINPR_ASSERT(context->priv);
+    WINPR_ASSERT(message);
+    WINPR_ASSERT(s);
+    WINPR_ASSERT(pExpectedBlockType);
+
+    if (*pExpectedBlockType != WBT_FRAME_END)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
+        return FALSE;
+    }
+
+    Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
+    if (magic != WF_MAGIC)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
+        return FALSE;
+    }
+
+    /* minimal safe guard: read number of metadata bytes, ensure it does not overflow */
+    if (Stream_GetRemainingLength(s) < sizeof(entries))
+        return FALSE;
+    Stream_Read_UINT16(s, entries);
+    if (entries == 0 || entries > RFX_MAX_METADATA_ENTRIES)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "bad metadata count %u", entries);
+        return FALSE;
+    }
+
+    /* for each entry, skip invalid ones and safely copy valid ones */
+    for (UINT16 i = 0; i < entries; ++i)
+    {
+        UINT16 idx, len;
+        if (Stream_GetRemainingLength(s) < sizeof(idx) + sizeof(len))
+            return FALSE;
+        Stream_Read_UINT16(s, idx);
+        Stream_Read_UINT16(s, len);
+        if (idx >= RFX_MAX_METADATA_ENTRIES || len != RFX_METADATA_ENTRY_SIZE)
+        {
+            /* skip bytes and log, but continue to avoid overflow */
+            WLog_Print(context->priv->log, WLOG_WARN,
+                       "skipping invalid metadata %u: idx=%u len=%u", i, idx, len);
+            if (Stream_GetRemainingLength(s) < len)
+                return FALSE;
+            Stream_Seek(s, len);
+            continue;
+        }
+        if (Stream_GetRemainingLength(s) < len)
+            return FALSE;
+        memcpy(message->metadataBlock[idx], Stream_Pointer(s), len);
+        Stream_Seek(s, len);
+    }
+
+    return TRUE;
 }
 
 static INLINE BOOL rfx_resize_rects(RFX_MESSAGE* WINPR_RESTRICT message)
