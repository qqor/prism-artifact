diff --git a/libfreerdp/codec/rfx.c b/libfreerdp/codec/rfx.c
index 3b9168ab6..b1938fc8a 100644
--- a/libfreerdp/codec/rfx.c
+++ b/libfreerdp/codec/rfx.c
@@ -707,32 +707,72 @@ static INLINE BOOL rfx_process_message_frame_end(RFX_CONTEXT* WINPR_RESTRICT con
 }
 
 static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT context,
-												RFX_MESSAGE* WINPR_RESTRICT message,
-												wStream* WINPR_RESTRICT s,
-												UINT16* WINPR_RESTRICT pExpectedBlockType)
-{
-	UINT32 magic = 0;
-
-	WINPR_ASSERT(context);
-	WINPR_ASSERT(context->priv);
-	WINPR_ASSERT(message);
-	WINPR_ASSERT(s);
-	WINPR_ASSERT(pExpectedBlockType);
-
-	if (*pExpectedBlockType != WBT_FRAME_END)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
-		return FALSE;
-	}
-
-	Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
-	if (magic != WF_MAGIC)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
-		return FALSE;
-	}
-	*(UINT64*)metadataBlock = metadataData;
-	return TRUE;
+                                                RFX_MESSAGE* WINPR_RESTRICT message,
+                                                wStream* WINPR_RESTRICT s,
+                                                UINT16* WINPR_RESTRICT pExpectedBlockType)
+{
+    UINT32 magic = 0;
+    UINT32 count;
+
+    WINPR_ASSERT(context);
+    WINPR_ASSERT(context->priv);
+    WINPR_ASSERT(message);
+    WINPR_ASSERT(s);
+    WINPR_ASSERT(pExpectedBlockType);
+
+    if (*pExpectedBlockType != WBT_FRAME_END)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
+        return FALSE;
+    }
+
+    Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
+    if (magic != WF_MAGIC)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
+        return FALSE;
+    }
+
+    /* read count and pre-calculate offset pointer */
+    if (Stream_GetRemainingLength(s) < sizeof(count))
+        return FALSE;
+    Stream_Read_UINT32(s, count);
+    if (count > RFX_MAX_METADATA_ENTRIES)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "invalid metadata entry count %u", count);
+        return FALSE;
+    }
+
+    /* ensure the following block won't overflow buffer */
+    {
+        size_t needed = 0;
+        size_t entrySize = sizeof(UINT16) * 2 + RFX_METADATA_ENTRY_SIZE;
+        if (__builtin_mul_overflow_p(count, entrySize, (size_t)0))
+            return FALSE;
+        needed = count * entrySize;
+        if (Stream_GetRemainingLength(s) < needed)
+            return FALSE;
+        /* process in-place pointer arithmetic with bounds */
+        const BYTE* ptr = Stream_Pointer(s);
+        for (UINT32 i = 0; i < count; ++i)
+        {
+            UINT16 idx = *((UINT16*)(ptr));
+            UINT16 len = *((UINT16*)(ptr + sizeof(UINT16)));
+            ptr += sizeof(UINT16) * 2;
+            if (idx >= RFX_MAX_METADATA_ENTRIES || len != RFX_METADATA_ENTRY_SIZE)
+            {
+                WLog_Print(context->priv->log, WLOG_ERROR,
+                           "invalid metadata entry %u: idx=%u len=%u", i, idx, len);
+                return FALSE;
+            }
+            memcpy(message->metadataBlock[idx], ptr, len);
+            ptr += len;
+        }
+        /* advance stream by entire block */
+        Stream_Seek(s, needed);
+    }
+
+    return TRUE;
 }
 
 static INLINE BOOL rfx_resize_rects(RFX_MESSAGE* WINPR_RESTRICT message)
