diff --git a/libfreerdp/codec/rfx.c b/libfreerdp/codec/rfx.c
index 3b9168ab6..7ab73d4f2 100644
--- a/libfreerdp/codec/rfx.c
+++ b/libfreerdp/codec/rfx.c
@@ -707,32 +707,76 @@ static INLINE BOOL rfx_process_message_frame_end(RFX_CONTEXT* WINPR_RESTRICT con
 }
 
 static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT context,
-												RFX_MESSAGE* WINPR_RESTRICT message,
-												wStream* WINPR_RESTRICT s,
-												UINT16* WINPR_RESTRICT pExpectedBlockType)
-{
-	UINT32 magic = 0;
-
-	WINPR_ASSERT(context);
-	WINPR_ASSERT(context->priv);
-	WINPR_ASSERT(message);
-	WINPR_ASSERT(s);
-	WINPR_ASSERT(pExpectedBlockType);
-
-	if (*pExpectedBlockType != WBT_FRAME_END)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
-		return FALSE;
-	}
-
-	Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
-	if (magic != WF_MAGIC)
-	{
-		WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
-		return FALSE;
-	}
-	*(UINT64*)metadataBlock = metadataData;
-	return TRUE;
+                                                RFX_MESSAGE* WINPR_RESTRICT message,
+                                                wStream* WINPR_RESTRICT s,
+                                                UINT16* WINPR_RESTRICT pExpectedBlockType)
+{
+    UINT32 magic = 0;
+    UINT32 entryCount;
+    UINT32 i;
+
+    WINPR_ASSERT(context);
+    WINPR_ASSERT(context->priv);
+    WINPR_ASSERT(message);
+    WINPR_ASSERT(s);
+    WINPR_ASSERT(pExpectedBlockType);
+
+    if (*pExpectedBlockType != WBT_FRAME_END)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "message unexpected wants WBT_FRAME_END (0x%x)", *pExpectedBlockType);
+        return FALSE;
+    }
+
+    Stream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */
+    if (magic != WF_MAGIC)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "invalid magic number 0x%08" PRIX32 "", magic);
+        return FALSE;
+    }
+
+    /* read and validate metadata entry count */
+    if (Stream_GetRemainingLength(s) < sizeof(entryCount))
+        return FALSE;
+    Stream_Read_UINT32(s, entryCount);
+    if (entryCount > RFX_MAX_METADATA_ENTRIES)
+    {
+        WLog_Print(context->priv->log, WLOG_ERROR, "invalid metadata entry count %u", entryCount);
+        return FALSE;
+    }
+
+    /* for each metadata entry, validate and copy with memcpy_s */
+    for (i = 0; i < entryCount; i++)
+    {
+        UINT16 index, length;
+        UINT8 buffer[RFX_METADATA_ENTRY_SIZE];
+
+        if (Stream_GetRemainingLength(s) < sizeof(index) + sizeof(length))
+            return FALSE;
+        Stream_Read_UINT16(s, index);
+        Stream_Read_UINT16(s, length);
+        if (index >= RFX_MAX_METADATA_ENTRIES || length != RFX_METADATA_ENTRY_SIZE)
+        {
+            WLog_Print(context->priv->log, WLOG_ERROR,
+                       "invalid metadata entry %u: index %u, length %u", i, index, length);
+            return FALSE;
+        }
+        if (Stream_GetRemainingLength(s) < length)
+            return FALSE;
+
+        /* safe copy into local buffer then to message block */
+        Stream_Read(s, buffer, length);
+        if (memcpy_s(message->metadataBlock[index],
+                     RFX_METADATA_ENTRY_SIZE,
+                     buffer,
+                     length) != 0)
+        {
+            WLog_Print(context->priv->log, WLOG_ERROR,
+                       "memcpy_s failed for metadata entry %u", i);
+            return FALSE;
+        }
+    }
+
+    return TRUE;
 }
 
 static INLINE BOOL rfx_resize_rects(RFX_MESSAGE* WINPR_RESTRICT message)
