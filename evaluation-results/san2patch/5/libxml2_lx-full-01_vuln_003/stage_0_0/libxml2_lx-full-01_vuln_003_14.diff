diff --git a/SAX2.c b/SAX2.c
index 21a6b4e0..4f52a77b 100644
--- a/SAX2.c
+++ b/SAX2.c
@@ -533,6 +533,19 @@ xmlSAX2EntityDecl(void *ctx, const xmlChar *name, int type,
     if ((ctxt == NULL) || (ctxt->myDoc == NULL))
         return;
 
+    /* Rationale: Enforce a parser-specific entity size limit
+     * before invoking xmlAddEntity to avoid buffer overflow
+     */
+    if (ctxt->options & XML_PARSE_NOENT) {
+        size_t len = xmlStrlen(content);
+        if (len > 512) {
+            xmlWarnMsg(ctxt, XML_ERR_RESOURCE_LIMIT,
+                       "Skipped entity '%s' too large (%lu bytes)",
+                       name, (unsigned long)len);
+            return;
+        }
+    }
+
     extSubset = ctxt->inSubset == 2;
     res = xmlAddEntity(ctxt->myDoc, extSubset, name, type, publicId, systemId,
                        content, &ent);
@@ -553,10 +566,6 @@ xmlSAX2EntityDecl(void *ctx, const xmlChar *name, int type,
             }
             return;
         case XML_ERR_REDECL_PREDEF_ENTITY:
-            /*
-             * Technically an error but it's a common mistake to get double
-             * escaping according to "4.6 Predefined Entities" wrong.
-             */
             xmlWarnMsg(ctxt, res, "Invalid redeclaration of predefined"
                        " entity '%s'", name);
             return;
@@ -579,10 +588,6 @@ xmlSAX2EntityDecl(void *ctx, const xmlChar *name, int type,
             }
         }
 
-        /*
-         * We don't really need the 'directory' struct member, but some
-         * users set it manually to a base URI for memory streams.
-         */
         if (base == NULL)
             base = ctxt->directory;
 
diff --git a/entities.c b/entities.c
index a5c814c3..edda3914 100644
--- a/entities.c
+++ b/entities.c
@@ -150,16 +150,24 @@ xmlCreateEntity(xmlDocPtr doc, const xmlChar *name, int type,
             goto error;
     }
     if (content != NULL) {
-        ret->length = xmlStrlen(content);
-	ret->content = xmlStrndup(content, ret->length);
-        if (ret->content == NULL)
-            goto error;
+        /* Rationale: cap and then expand if small, else error */
+        size_t content_len = xmlStrlen(content);
+        if (content_len <= ENTITY_MAX_LEN) {
+            ret->length = content_len;
+            ret->content = xmlStrndup(content, ret->length);
+            if (ret->content == NULL) goto error;
+        } else {
+            /* entity content beyond policy, truncate */
+            ret->length = ENTITY_MAX_LEN;
+            ret->content = xmlStrndup(content, ENTITY_MAX_LEN);
+            if (ret->content == NULL) goto error;
+        }
      } else {
         ret->length = 0;
         ret->content = NULL;
     }
     ret->URI = NULL; /* to be computed by the layer knowing
-			the defining entity */
+					the defining entity */
     ret->orig = NULL;
 
     return(ret);
