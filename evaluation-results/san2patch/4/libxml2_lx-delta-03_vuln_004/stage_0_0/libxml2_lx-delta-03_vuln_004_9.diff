diff --git a/encoding.c b/encoding.c
index adecdcc6..f32ed2b4 100644
--- a/encoding.c
+++ b/encoding.c
@@ -2827,15 +2827,21 @@ UTF8ToUTF32(unsigned char *out, int *outlen,
                 out += 4;
             }
 
-            in += len;
+    // FIXME: Crash CWE-787: Out-of-bounds Write
+             if (len < 0) {
+                 return(XML_ENC_ERR_INTERNAL);
+             }
+             if ((in - instart) + len > *inlen) {
+                 len = *inlen - (in - instart);
+             }
+             in += len;
         }
     }
 
     if (in-instart > 0)
         ret = out - outstart;
 
-    *outlen = out - outstart;
-    *inlen = in - instart;
+    *outlen = out - outstart;    *inlen = in - instart;
     return(ret);
 }
 
@@ -2864,6 +2870,20 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
         b3 = (b3 << 0x18);
         c = b0 | b1 | b2 | b3;
 
+        {
+        /* Compute needed bytes based on codepoint */
+        int needed;
+        if (c < 0x80)
+            needed = 1;
+        else if (c < 0x800)
+            needed = 2;
+        else if ((c & 0xF800) != 0xD800)
+            needed = 3;
+        else
+            needed = 4;
+        /* Bound check for all cases in one place */
+        if (out + needed > outend) { ret = XML_ERR_INTERNAL_ERROR; break; }
+        /* Now emit bytes */
         if (c < 0x80) {
             out[0] = c;
             in += 4;
@@ -2885,22 +2905,14 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-	        if (inend - in < 4)
-		        break;
+            if (inend - in < 4)
+                break;
             d = in[2] | (in[3] << 8);
             if ((d & 0xFC00) != 0xDC00) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-            /*
-                simplified due to encoding errors encountered with:
-
-                c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);
-                out[0] =  (c >> 18)         | 0xF0;
-                out[1] = ((c >> 12) & 0x3F) | 0x80;
-                out[2] = ((c >>  6) & 0x3F) | 0x80;
-                out[3] =  (c        & 0x3F) | 0x80;
-            */
+            /* simplified bytes */
             out[0] = c & 0xff;
             out[1] = (c >> 8) & 0xff;
             out[2] = (c >> 0x10) & 0xff;
@@ -2909,6 +2921,7 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
             out += 4;
         }
     }
+    }
 
     if (in-instart > 0)
         ret = out - outstart;
