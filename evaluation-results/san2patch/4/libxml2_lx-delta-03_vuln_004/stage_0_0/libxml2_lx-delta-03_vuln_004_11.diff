diff --git a/encoding.c b/encoding.c
index adecdcc6..b9094920 100644
--- a/encoding.c
+++ b/encoding.c
@@ -2092,7 +2092,7 @@ latin1ToUTF8(unsigned char* out, int *outlen,
 done:
     *outlen = out - outstart;
     *inlen = in - instart;
-    return(ret);
+return(ret);
 }
 
 /**
@@ -2106,14 +2106,30 @@ done:
  * block of chars out.
  *
  * Returns the number of bytes written or an XML_ENC_ERR code.
- *
- * The value of @inlen after return is the number of octets consumed
- *     if the return value is positive, else unpredictable.
- * The value of @outlen after return is the number of octets produced.
  */
 int
 isolat1ToUTF8(unsigned char* out, int *outlen,
-              const unsigned char* in, int *inlen) {
+              const unsigned char *in, int inlen) {
+    int i;
+    int rem = *outlen;
+    unsigned char *op = out;
+
+    for (i = 0; i < inlen; i++) {
+        unsigned char c = in[i];
+        if (c < 0x80) {
+            if (rem < 1) return(XML_ENC_ERR);
+            *op++ = c;
+            rem -= 1;
+        } else {
+            if (rem < 2) return(XML_ENC_ERR);
+            *op++ = 0xC0 | (c >> 6);
+            *op++ = 0x80 | (c & 0x3F);
+            rem -= 2;
+        }
+    }
+    *outlen = (*outlen) - rem;
+    return(*outlen);
+}              const unsigned char* in, int *inlen) {
     return(latin1ToUTF8(out, outlen, in, inlen, NULL));
 }
 
diff --git a/parserInternals.c b/parserInternals.c
index 88e34b72..c50cdbc7 100644
--- a/parserInternals.c
+++ b/parserInternals.c
@@ -576,11 +576,19 @@ xmlParserGrow(xmlParserCtxtPtr ctxt) {
         xmlFatalErr(ctxt, XML_ERR_RESOURCE_LIMIT,
                     "Buffer size limit exceeded, try XML_PARSE_HUGE\n");
         xmlHaltParser(ctxt);
-	return(-1);
+        return(-1);
+    }
+
+    /* Check available buffer space before growing */
+    if (xmlBufAvail(buf->buffer) < INPUT_CHUNK) {
+        xmlFatalErr(ctxt, XML_ERR_RESOURCE_LIMIT,
+                    "Insufficient buffer space, try XML_PARSE_HUGE\n");
+        xmlHaltParser(ctxt);
+        return(-1);
     }
 
     if (curEnd >= INPUT_CHUNK)
-        return(0);
+         return(0);
 
     ret = xmlParserInputBufferGrow(buf, INPUT_CHUNK);
     xmlBufUpdateInput(buf->buffer, in, curBase);
