diff --git a/src/fmt.c b/src/fmt.c
index 8164e1ca..d9acdaad 100644
--- a/src/fmt.c
+++ b/src/fmt.c
@@ -310,22 +310,32 @@ size_t mg_vxprintf(void (*out)(char, void *), void *param, const char *fmt,
         char *p = va_arg(*ap, char *);
         if (pr == ~0U) pr = p == NULL ? 0 : strlen(p);
         for (j = 0; !minus && pr < w && j + pr < w; j++)
-          n += scpy(out, param, &pad, 1);
+// FIXME: Crash CWE-787: Out-of-bounds Write
+           n += scpy(out, param, &pad, 1);
         n += scpy(out, param, p, pr);
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+		  /* Rationale: two-phase allocation for exact size */
           double d = va_arg(*ap, double);
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
-          n += scpy(out, param, tmp, k);
+          char stack_tmp[8];
+          int len = mg_dtoa(stack_tmp, 10, mantissa, 8, c == 'e');
+          char *buf = (len < 8 ? stack_tmp : (char *)malloc(len + 1));
+          if (buf != stack_tmp) mg_dtoa(buf, 10, mantissa, len, c == 'e');
+          n += scpy(out, param, buf, len);
           out(c, param);
           n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
-          n += scpy(out, param, tmp, k);
-	  } else if (c == '%') {
+          if (buf != stack_tmp) free(buf);
+		  /* exponent part */
+          char stack_exp[8];
+          len = mg_lld(stack_exp, exponent, 1, 0);
+          buf = (len < 8 ? stack_exp : (char *)malloc(len + 1));
+          if (buf != stack_exp) mg_lld(buf, exponent, len, 0);
+          n += scpy(out, param, buf, len);
+          if (buf != stack_exp) free(buf);
+      } else if (c == '%') {
         out('%', param);
         n++;
       } else {
