diff --git a/mongoose.c b/mongoose.c
index 3508b21e..18e1bdad 100644
--- a/mongoose.c
+++ b/mongoose.c
@@ -2747,6 +2747,8 @@ int mg_json_get(struct mg_str json, const char *path, int *toklen) {
 #define MG_EOO(x)                                            \
   do {                                                       \
     if (depth == ed && ci != ei) return MG_JSON_NOT_FOUND;   \
+    /* enforce valid depth before accessing nesting[] */      \
+    if (depth <= 0 || depth > MG_JSON_MAX_NESTING) return MG_JSON_INVALID; \
     if (c != nesting[depth - 1] + 2) return MG_JSON_INVALID; \
     depth--;                                                 \
     MG_CHECKRET(x);                                          \
@@ -2762,8 +2764,7 @@ int mg_json_get(struct mg_str json, const char *path, int *toklen) {
         if (c == '{') {
           if (depth > MG_JSON_MAX_NESTING) return MG_JSON_TOO_DEEP;
           if (depth == ed && path[pos] == '.' && ci == ei) {
-            // If we start the object, reset array indices
-            ed++, pos++, ci = ei = -1;
+            // If we start the object, reset array indices            ed++, pos++, ci = ei = -1;
           }
           nesting[depth++] = c;
           expecting = S_KEY;
