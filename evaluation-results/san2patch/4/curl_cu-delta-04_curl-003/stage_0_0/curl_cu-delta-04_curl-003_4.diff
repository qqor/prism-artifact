diff --git a/lib/doh.c b/lib/doh.c
index 8769372e0..9c0114bf5 100644
--- a/lib/doh.c
+++ b/lib/doh.c
@@ -344,10 +344,14 @@ static CURLcode doh_run_probe(struct Curl_easy *data,
   }
   if(data->set.ssl.certinfo)
     ERROR_CHECK_SETOPT(CURLOPT_CERTINFO, 1L);
-  if(data->set.ssl.fsslctx)
-    ERROR_CHECK_SETOPT(CURLOPT_SSL_CTX_FUNCTION, data->set.ssl.fsslctx);
-  if(data->set.ssl.fsslctxp)
-    ERROR_CHECK_SETOPT(CURLOPT_SSL_CTX_DATA, data->set.ssl.fsslctxp);
+  /* Macro-guarded setting of SSL_CTX callbacks to prevent UAF */
+#define SAFE_SSL_CTX_SETOPT(opt, param) \
+  do { if((param)) \
+         ERROR_CHECK_SETOPT(opt, param); \
+     } while(0)
+  SAFE_SSL_CTX_SETOPT(CURLOPT_SSL_CTX_FUNCTION, data->set.ssl.fsslctx);
+  SAFE_SSL_CTX_SETOPT(CURLOPT_SSL_CTX_DATA, data->set.ssl.fsslctxp);
+#undef SAFE_SSL_CTX_SETOPT
   if(data->set.fdebug)
     ERROR_CHECK_SETOPT(CURLOPT_DEBUGFUNCTION, data->set.fdebug);
   if(data->set.debugdata)
@@ -357,8 +361,7 @@ static CURLcode doh_run_probe(struct Curl_easy *data,
                        data->set.str[STRING_SSL_EC_CURVES]);
   }
 
-  {
-    long mask =
+  {    long mask =
       (data->set.ssl.enable_beast ?
        CURLSSLOPT_ALLOW_BEAST : 0) |
       (data->set.ssl.no_revoke ?
