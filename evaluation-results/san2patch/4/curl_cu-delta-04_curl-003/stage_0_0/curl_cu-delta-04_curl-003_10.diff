diff --git a/lib/doh.c b/lib/doh.c
index 8769372e0..e6f6c47d9 100644
--- a/lib/doh.c
+++ b/lib/doh.c
@@ -595,6 +595,8 @@ static DOHcode doh_store_cname(const unsigned char *doh, size_t dohlen,
 
   c = &d->cname[d->numcname++];
   do {
+    if(!c)
+      return DOH_OUT_OF_MEM; /* guard against use-after-free */
     if(index >= dohlen)
       return DOH_DNS_OUT_OF_RANGE;
     length = doh[index];
@@ -616,7 +618,7 @@ static DOHcode doh_store_cname(const unsigned char *doh, size_t dohlen,
 
     if(length) {
       if(Curl_dyn_len(c)) {
-        if(Curl_dyn_addn(c, STRCONST(".")))
+         if(Curl_dyn_addn(c, STRCONST(".")))
           return DOH_OUT_OF_MEM;
       }
       if((index + length) > dohlen)
