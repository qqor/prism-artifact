{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/aixcc/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.4808716000000001,
    "prompt_tokens": 177400,
    "completion_tokens": 64939
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,7 +22,9 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n+import java.nio.file.StandardOpenOption;\n import java.util.Iterator;\n \n import org.apache.poi.poifs.common.POIFSConstants;\n@@ -42,6 +44,19 @@\n public final class POIFSDump {\n \n     private POIFSDump() {}\n+\n+    /**\n+     * Resolves childName against parentDir, normalizes the result, and ensures\n+     * the normalized path does not escape parentDir. Throws IOException on traversal.\n+     */\n+    private static File safeChildFile(File parentDir, String childName) throws IOException {\n+        Path parentPath = parentDir.toPath().toAbsolutePath().normalize();\n+        Path childPath  = parentPath.resolve(childName).normalize();\n+        if (!childPath.startsWith(parentPath)) {\n+            throw new IOException(\"Invalid entry name (path traversal): \" + childName);\n+        }\n+        return childPath.toFile();\n+    }\n \n     public static void main(String[] args) throws IOException {\n         if (args.length == 0) {\n@@ -105,13 +120,22 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n-                    out.write(bytes);\n+                String entryName = node.getName().trim();\n+                File file = safeChildFile(parent, entryName);\n+                File fileParent = file.getParentFile();\n+                if (fileParent != null && !fileParent.exists()) {\n+                    if (!fileParent.mkdirs()) {\n+                        throw new IOException(\"Could not create parent directories: \" + fileParent);\n+                    }\n                 }\n+                Files.write(file.toPath(), bytes,\n+                            StandardOpenOption.CREATE,\n+                            StandardOpenOption.WRITE);\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n+                String dirName = entry.getName();\n+                File file = safeChildFile(parent, dirName);\n+                if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n                 dump(dir, file);\n",
  "stdout": "",
  "stderr": ""
}