{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_6",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.39818240000000005,
    "prompt_tokens": 159296,
    "completion_tokens": 50672
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n@@ -20,6 +20,7 @@\n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.io.ByteArrayOutputStream;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n@@ -71,6 +72,29 @@\n     private static final long MAX_LENGTH = 100_000_000;\n \n     /**\n+     * Read all bytes from InputStream with a limit to prevent OOM.\n+     */\n+    private static byte[] readAllBytesWithLimit(InputStream in, long max) throws IOException\n+    {\n+        byte[] buffer = new byte[8192];\n+        long totalRead = 0;\n+        try (ByteArrayOutputStream out = new ByteArrayOutputStream())\n+        {\n+            int read;\n+            while ((read = in.read(buffer)) != -1)\n+            {\n+                totalRead += read;\n+                if (totalRead > max)\n+                {\n+                    throw new IOException(\"PFB data too large: \" + totalRead + \" bytes, exceeds max \" + max);\n+                }\n+                out.write(buffer, 0, read);\n+            }\n+            return out.toByteArray();\n+        }\n+    }\n+\n+    /**\n      * the parsed pfb-data.\n      */\n     private byte[] pfbdata;\n@@ -90,9 +114,13 @@\n      * @param filename  the file name\n      * @throws IOException if an IO-error occurs.\n      */\n-    public PfbParser(final String filename) throws IOException \n-    {\n-        this(Files.readAllBytes(Paths.get(filename)));\n+    public PfbParser(final String filename) throws IOException\n+    {\n+        try (InputStream is = Files.newInputStream(Paths.get(filename)))\n+        {\n+            byte[] pfb = readAllBytesWithLimit(is, MAX_LENGTH);\n+            parsePfb(pfb);\n+        }\n     }\n \n     /**\n@@ -100,9 +128,9 @@\n      * @param in   The input.\n      * @throws IOException if an IO-error occurs.\n      */\n-    public PfbParser(final InputStream in) throws IOException \n-    {\n-        byte[] pfb = in.readAllBytes();\n+    public PfbParser(final InputStream in) throws IOException\n+    {\n+        byte[] pfb = readAllBytesWithLimit(in, MAX_LENGTH);\n         parsePfb(pfb);\n     }\n \n@@ -113,6 +141,10 @@\n      */\n     public PfbParser(final byte[] bytes) throws IOException\n     {\n+        if (bytes.length > MAX_LENGTH)\n+        {\n+            throw new IOException(\"PFB data too large: \" + bytes.length + \" bytes, exceeds max \" + MAX_LENGTH);\n+        }\n         parsePfb(bytes);\n     }\n \n@@ -132,6 +164,7 @@\n         List<byte[]> barrList = new ArrayList<>(3);\n         ByteArrayInputStream in = new ByteArrayInputStream(pfb);\n         int total = 0;\n+        int segmentCount = 0;\n         do\n         {\n             int r = in.read();\n@@ -139,7 +172,7 @@\n             {\n                 break; // EOF\n             }\n-            if (r != START_MARKER) \n+            if (r != START_MARKER)\n             {\n                 throw new IOException(\"Start marker missing\");\n             }\n@@ -147,6 +180,12 @@\n             if (recordType == EOF_MARKER)\n             {\n                 break;\n+            }\n+            // count only actual data segments\n+            segmentCount++;\n+            if (segmentCount > 3)\n+            {\n+                throw new IOException(\"Too many PFB segments: \" + segmentCount);\n             }\n             if (recordType != ASCII_MARKER && recordType != BINARY_MARKER)\n             {\n@@ -158,8 +197,13 @@\n             size += in.read() << 16;\n             size += in.read() << 24;\n             LOG.debug(\"record type: {}, segment size: {}\", recordType, size);\n+            if (size < 0 || size > MAX_LENGTH)\n+            {\n+                throw new IOException(\"PFB segment size invalid or too large: \" + size);\n+            }\n             long newTotal = total + size;\n-            if (newTotal > MAX_LENGTH) {\n+            if (newTotal > MAX_LENGTH)\n+            {\n                 throw new IOException(\"record size would be too large: \" + newTotal);\n             }\n \n@@ -219,6 +263,9 @@\n             System.arraycopy(cleartomarkSegment, 0, pfbdata, dstPos, cleartomarkSegment.length);\n             lengths[2] = cleartomarkSegment.length;\n         }\n+        // release segment buffers to allow GC\n+        typeList.clear();\n+        barrList.clear();\n     }\n \n     /**\n",
  "stdout": "",
  "stderr": ""
}