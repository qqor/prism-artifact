--- a/src/json.c
+++ b/src/json.c
@@ -164,7 +164,7 @@
         // p("V %s [%.*s] %d %d %d %d\n", path, pos, path, depth, ed, ci, ei);
         if (depth == ed) j = i;
         if (c == '{') {
-          if (depth > MG_JSON_MAX_NESTING) return MG_JSON_TOO_DEEP;
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           if (depth == ed && path[pos] == '.' && ci == ei) {
             // If we start the object, reset array indices
             ed++, pos++, ci = ei = -1;
@@ -173,7 +173,7 @@
           expecting = S_KEY;
           break;
         } else if (c == '[') {
-          if (depth > MG_JSON_MAX_NESTING) return MG_JSON_TOO_DEEP;
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           if (depth == ed && path[pos] == '[' && ei == ci) {
             ed++, pos++, ci = 0;
             for (ei = 0; path[pos] != ']' && path[pos] != '\0'; pos++) {
@@ -182,6 +182,7 @@
             }
             if (path[pos] != 0) pos++;
           }
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           nesting[depth++] = c;
           break;
         } else if (c == ']' && depth > 0) {  // Empty array

--- a/mongoose.c
+++ b/mongoose.c
@@ -2760,7 +2760,7 @@
         // p("V %s [%.*s] %d %d %d %d\n", path, pos, path, depth, ed, ci, ei);
         if (depth == ed) j = i;
         if (c == '{') {
-          if (depth > MG_JSON_MAX_NESTING) return MG_JSON_TOO_DEEP;
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           if (depth == ed && path[pos] == '.' && ci == ei) {
             // If we start the object, reset array indices
             ed++, pos++, ci = ei = -1;
@@ -2769,7 +2769,7 @@
           expecting = S_KEY;
           break;
         } else if (c == '[') {
-          if (depth > MG_JSON_MAX_NESTING) return MG_JSON_TOO_DEEP;
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           if (depth == ed && path[pos] == '[' && ei == ci) {
             ed++, pos++, ci = 0;
             for (ei = 0; path[pos] != ']' && path[pos] != '\0'; pos++) {
@@ -2778,6 +2778,7 @@
             }
             if (path[pos] != 0) pos++;
           }
+          if (depth >= MG_JSON_MAX_DEPTH) return MG_JSON_TOO_DEEP;
           nesting[depth++] = c;
           break;
         } else if (c == ']' && depth > 0) {  // Empty array
