--- a/libexif/apple/exif-mnote-data-apple.c
+++ b/libexif/apple/exif-mnote-data-apple.c
@@ -107,21 +107,32 @@
     }
 
     for (i = 0; i < tcount; i++) {
-        d->entries[i].tag = exif_get_short(buf + ofs, d->order);
-        d->entries[i].format = exif_get_short(buf + ofs + 2, d->order);
-        d->entries[i].components = exif_get_long(buf + ofs + 4, d->order);
+        size_t rec_ofs = ofs;
+        if (rec_ofs + 12 > buf_size) {
+            exif_log(md->log, EXIF_LOG_CODE_CORRUPT_DATA,
+                     "ExifMnoteDataApple",
+                     "MakerNote directory entry overflow (%u entries at ofs %u beyond size %u)",
+                     (unsigned)i, (unsigned)rec_ofs, (unsigned)buf_size);
+            break;
+        }
+        d->entries[i].tag = exif_get_short(buf + rec_ofs, d->order);
+        d->entries[i].format = exif_get_short(buf + rec_ofs + 2, d->order);
+        d->entries[i].components = exif_get_long(buf + rec_ofs + 4, d->order);
         d->entries[i].order = d->order;
-        dsize = exif_format_get_size(d->entries[i].format) * d->entries[i].components;
+        dsize = (size_t)exif_format_get_size(d->entries[i].format) *
+                d->entries[i].components;
         if (dsize > 4) {
-            dofs = d->offset + exif_get_long(buf + ofs + 8, d->order);
+            dofs = d->offset + exif_get_long(buf + rec_ofs + 8, d->order);
         } else {
-            dofs = ofs + 8;
-        }
-	if (dofs > buf_size) {
-		exif_log (md->log, EXIF_LOG_CODE_CORRUPT_DATA,
-                                  "ExifMnoteApplet", "Tag size overflow detected (%u vs size %u)", dofs, buf_size);
-		continue;
-	}
+            dofs = rec_ofs + 8;
+        }
+        if (dofs + dsize > buf_size) {
+            exif_log(md->log, EXIF_LOG_CODE_CORRUPT_DATA,
+                     "ExifMnoteDataApple",
+                     "MakerNote tag data overflow (%u bytes at ofs %u beyond size %u)",
+                     (unsigned)dsize, (unsigned)dofs, (unsigned)buf_size);
+            continue;
+        }
         ofs += 12;
         d->entries[i].data = exif_mem_alloc(md->mem, dsize);
         if (!d->entries[i].data) {
