--- a/encoding.c
+++ b/encoding.c
@@ -2841,18 +2841,19 @@
 
 int
 UTF32ToUTF8(unsigned char *out, int *outlen,
-              const unsigned char *in, int *inlen,
-              void *vctxt ATTRIBUTE_UNUSED) {
+            const unsigned char *in, int *inlen,
+            void *vctxt ATTRIBUTE_UNUSED) {
     const unsigned char *instart = in;
     const unsigned char *inend = in + (*inlen & ~1);
     unsigned char *outstart = out;
     unsigned long int b0, b1, b2, b3, c, d;
     int ret = XML_ENC_ERR_SPACE;
+    int available = *outlen;
+    unsigned char *outptr = out;
 
     if ((in[0] != 0x20) && (in[1] != 0x20) && (in[2] != 0x20) && (in[3] != 0x20)) {
         /* bom is managed already */
     }
-
 
     while (in < inend) {
         b0 = in[0];
@@ -2865,55 +2866,62 @@
         c = b0 | b1 | b2 | b3;
 
         if (c < 0x80) {
-            out[0] = c;
+            if (available < 1) { ret = XML_ENC_ERR_SPACE; break; }
+            outptr[0] = c;
             in += 4;
-            out += 1;
+            outptr += 1;
+            available -= 1;
         } else if (c < 0x800) {
-            out[0] = (c >> 6)   | 0xC0;
-            out[1] = (c & 0x3F) | 0x80;
+            if (available < 2) { ret = XML_ENC_ERR_SPACE; break; }
+            outptr[0] = (c >> 6)   | 0xC0;
+            outptr[1] = (c & 0x3F) | 0x80;
             in += 4;
-            out += 2;
+            outptr += 2;
+            available -= 2;
         } else if ((c & 0xF800) != 0xD800) {
-            out[0] =  (c >> 12)         | 0xE0;
-            out[1] = ((c >>  6) & 0x3F) | 0x80;
-            out[2] =  (c        & 0x3F) | 0x80;
+            if (available < 3) { ret = XML_ENC_ERR_SPACE; break; }
+            outptr[0] =  (c >> 12)         | 0xE0;
+            outptr[1] = ((c >>  6) & 0x3F) | 0x80;
+            outptr[2] =  (c        & 0x3F) | 0x80;
             in += 4;
-            out += 3;
+            outptr += 3;
+            available -= 3;
         } else {
             /* Surrogate pair */
             if ((c & 0xFC00) != 0xD800) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
-	        if (inend - in < 4)
-		        break;
+            if (inend - in < 4)
+                break;
             d = in[2] | (in[3] << 8);
             if ((d & 0xFC00) != 0xDC00) {
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
+            if (available < 4) { ret = XML_ENC_ERR_SPACE; break; }
             /*
                 simplified due to encoding errors encountered with:
-
                 c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);
                 out[0] =  (c >> 18)         | 0xF0;
                 out[1] = ((c >> 12) & 0x3F) | 0x80;
                 out[2] = ((c >>  6) & 0x3F) | 0x80;
                 out[3] =  (c        & 0x3F) | 0x80;
             */
-            out[0] = c & 0xff;
-            out[1] = (c >> 8) & 0xff;
-            out[2] = (c >> 0x10) & 0xff;
-            out[3] = (c >> 0x18) & 0xff;
+            outptr[0] = c & 0xff;
+            outptr[1] = (c >> 8) & 0xff;
+            outptr[2] = (c >> 0x10) & 0xff;
+            outptr[3] = (c >> 0x18) & 0xff;
             in += 4;
-            out += 4;
+            outptr += 4;
+            available -= 4;
         }
     }
 
-    if (in-instart > 0)
-        ret = out - outstart;
-
-    *outlen = out - outstart;
+    if (in - instart > 0)
+        ret = outptr - outstart;
+
+    *outlen = outptr - outstart;
     *inlen = in - instart;
     return(ret);
 }
