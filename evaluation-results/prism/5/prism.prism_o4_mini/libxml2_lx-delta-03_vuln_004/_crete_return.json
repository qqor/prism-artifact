{
  "project_name": "libxml2",
  "vulnerability_identifier": "libxml2_lx-delta-03_vuln_004",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-libxml2",
  "llm_usage": {
    "total_cost": 0.19585390000000003,
    "prompt_tokens": 94977,
    "completion_tokens": 20768
  },
  "variant": "sound",
  "diff": "--- a/encoding.c\n+++ b/encoding.c\n@@ -2841,18 +2841,19 @@\n \n int\n UTF32ToUTF8(unsigned char *out, int *outlen,\n-              const unsigned char *in, int *inlen,\n-              void *vctxt ATTRIBUTE_UNUSED) {\n+            const unsigned char *in, int *inlen,\n+            void *vctxt ATTRIBUTE_UNUSED) {\n     const unsigned char *instart = in;\n     const unsigned char *inend = in + (*inlen & ~1);\n     unsigned char *outstart = out;\n     unsigned long int b0, b1, b2, b3, c, d;\n     int ret = XML_ENC_ERR_SPACE;\n+    int available = *outlen;\n+    unsigned char *outptr = out;\n \n     if ((in[0] != 0x20) && (in[1] != 0x20) && (in[2] != 0x20) && (in[3] != 0x20)) {\n         /* bom is managed already */\n     }\n-\n \n     while (in < inend) {\n         b0 = in[0];\n@@ -2865,55 +2866,62 @@\n         c = b0 | b1 | b2 | b3;\n \n         if (c < 0x80) {\n-            out[0] = c;\n+            if (available < 1) { ret = XML_ENC_ERR_SPACE; break; }\n+            outptr[0] = c;\n             in += 4;\n-            out += 1;\n+            outptr += 1;\n+            available -= 1;\n         } else if (c < 0x800) {\n-            out[0] = (c >> 6)   | 0xC0;\n-            out[1] = (c & 0x3F) | 0x80;\n+            if (available < 2) { ret = XML_ENC_ERR_SPACE; break; }\n+            outptr[0] = (c >> 6)   | 0xC0;\n+            outptr[1] = (c & 0x3F) | 0x80;\n             in += 4;\n-            out += 2;\n+            outptr += 2;\n+            available -= 2;\n         } else if ((c & 0xF800) != 0xD800) {\n-            out[0] =  (c >> 12)         | 0xE0;\n-            out[1] = ((c >>  6) & 0x3F) | 0x80;\n-            out[2] =  (c        & 0x3F) | 0x80;\n+            if (available < 3) { ret = XML_ENC_ERR_SPACE; break; }\n+            outptr[0] =  (c >> 12)         | 0xE0;\n+            outptr[1] = ((c >>  6) & 0x3F) | 0x80;\n+            outptr[2] =  (c        & 0x3F) | 0x80;\n             in += 4;\n-            out += 3;\n+            outptr += 3;\n+            available -= 3;\n         } else {\n             /* Surrogate pair */\n             if ((c & 0xFC00) != 0xD800) {\n                 ret = XML_ERR_INTERNAL_ERROR;\n                 break;\n             }\n-\t        if (inend - in < 4)\n-\t\t        break;\n+            if (inend - in < 4)\n+                break;\n             d = in[2] | (in[3] << 8);\n             if ((d & 0xFC00) != 0xDC00) {\n                 ret = XML_ERR_INTERNAL_ERROR;\n                 break;\n             }\n+            if (available < 4) { ret = XML_ENC_ERR_SPACE; break; }\n             /*\n                 simplified due to encoding errors encountered with:\n-\n                 c = (c << 10) + d - ((0xD800 << 10) + 0xDC00 - 0x10000);\n                 out[0] =  (c >> 18)         | 0xF0;\n                 out[1] = ((c >> 12) & 0x3F) | 0x80;\n                 out[2] = ((c >>  6) & 0x3F) | 0x80;\n                 out[3] =  (c        & 0x3F) | 0x80;\n             */\n-            out[0] = c & 0xff;\n-            out[1] = (c >> 8) & 0xff;\n-            out[2] = (c >> 0x10) & 0xff;\n-            out[3] = (c >> 0x18) & 0xff;\n+            outptr[0] = c & 0xff;\n+            outptr[1] = (c >> 8) & 0xff;\n+            outptr[2] = (c >> 0x10) & 0xff;\n+            outptr[3] = (c >> 0x18) & 0xff;\n             in += 4;\n-            out += 4;\n+            outptr += 4;\n+            available -= 4;\n         }\n     }\n \n-    if (in-instart > 0)\n-        ret = out - outstart;\n-\n-    *outlen = out - outstart;\n+    if (in - instart > 0)\n+        ret = outptr - outstart;\n+\n+    *outlen = outptr - outstart;\n     *inlen = in - instart;\n     return(ret);\n }\n",
  "stdout": "",
  "stderr": ""
}