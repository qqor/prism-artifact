{
  "project_name": "freerdp",
  "vulnerability_identifier": "freerdp_fp-delta-03_vuln_003",
  "source_directory": "/home/qqor/aixcc/crete/.cache/official-afc-freerdp",
  "llm_usage": {
    "total_cost": 1.2924098,
    "prompt_tokens": 741646,
    "completion_tokens": 108318
  },
  "variant": "sound",
  "diff": "--- a/include/freerdp/codec/rfx.h\n+++ b/include/freerdp/codec/rfx.h\n@@ -68,11 +68,17 @@\n \t\tBYTE* YData;\n \t\tBYTE* CbData;\n \t\tBYTE* CrData;\n-\t\tBYTE* YCbCrData;\n-\t} RFX_TILE;\n+        BYTE* YCbCrData;\n+    } RFX_TILE;\n \n-\ttypedef struct S_RFX_MESSAGE_LIST RFX_MESSAGE_LIST;\n-\ttypedef struct S_RFX_MESSAGE RFX_MESSAGE;\n+    typedef struct\n+    {\n+        BYTE* data;\n+        UINT32 size;\n+    } RFX_METADATA_BLOCK;\n+\n+    typedef struct S_RFX_MESSAGE_LIST RFX_MESSAGE_LIST;\n+    typedef struct S_RFX_MESSAGE RFX_MESSAGE;\n \ttypedef struct S_RFX_CONTEXT RFX_CONTEXT;\n \n \tFREERDP_API BOOL rfx_process_message(RFX_CONTEXT* context, const BYTE* data, UINT32 length,\n\n--- a/libfreerdp/codec/rfx_types.h\n+++ b/libfreerdp/codec/rfx_types.h\n@@ -123,6 +123,8 @@\n \tUINT32 tilesDataSize;\n \n \tBOOL freeArray;\n+\tUINT32 numMetadataBlocks;\n+\tRFX_METADATA_BLOCK* metadataBlocks;\n };\n \n struct S_RFX_MESSAGE_LIST\n\n--- a/libfreerdp/codec/rfx.c\n+++ b/libfreerdp/codec/rfx.c\n@@ -725,13 +725,45 @@\n \t\treturn FALSE;\n \t}\n \n+\t/* ensure enough data for magic and length */\n+\tif (!Stream_CheckAndLogRequiredLengthWLog(context->priv->log, s, 8))\n+\t\treturn FALSE;\n \tStream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */\n \tif (magic != WF_MAGIC)\n \t{\n \t\tWLog_Print(context->priv->log, WLOG_ERROR, \"invalid magic number 0x%08\" PRIX32 \"\", magic);\n \t\treturn FALSE;\n \t}\n-\t*(UINT64*)metadataBlock = metadataData;\n+\t/* read metadata length */\n+\t{\n+\t\tUINT32 length = 0;\n+\t\tStream_Read_UINT32(s, length);\n+\t\t/* check that we have the full metadata payload */\n+\t\tif (!Stream_CheckAndLogRequiredLengthWLog(context->priv->log, s, length))\n+\t\t\treturn FALSE;\n+\n+\t\t/* grow metadataBlocks array */\n+\t\t{\n+\t\t\tRFX_METADATA_BLOCK* tmp = winpr_aligned_recalloc(message->metadataBlocks,\n+\t\t\t    message->numMetadataBlocks + 1, sizeof(RFX_METADATA_BLOCK), 16);\n+\t\t\tif (!tmp)\n+\t\t\t\treturn FALSE;\n+\t\t\tmessage->metadataBlocks = tmp;\n+\t\t}\n+\n+\t\t/* allocate and read metadata payload */\n+\t\t{\n+\t\t\tBYTE* data = winpr_aligned_malloc(length, 16);\n+\t\t\tif (!data)\n+\t\t\t\treturn FALSE;\n+\t\t\tStream_Read(s, data, length);\n+\n+\t\t\tmessage->metadataBlocks[message->numMetadataBlocks].data = data;\n+\t\t\tmessage->metadataBlocks[message->numMetadataBlocks].size = length;\n+\t\t\tmessage->numMetadataBlocks++;\n+\t\t}\n+\t}\n+\t*pExpectedBlockType = WBT_FRAME_BEGIN;\n \treturn TRUE;\n }\n \n@@ -1472,6 +1504,21 @@\n \n \twinpr_aligned_free(message->rects);\n \n+\tif (message->metadataBlocks)\n+\t{\n+\t\tfor (size_t i = 0; i < message->numMetadataBlocks; ++i)\n+\t\t{\n+\t\t\tif (message->metadataBlocks[i].data)\n+\t\t\t{\n+\t\t\t\twinpr_aligned_free(message->metadataBlocks[i].data);\n+\t\t\t\tmessage->metadataBlocks[i].data = NULL;\n+\t\t\t}\n+\t\t}\n+\t\twinpr_aligned_free(message->metadataBlocks);\n+\t\tmessage->metadataBlocks = NULL;\n+\t\tmessage->numMetadataBlocks = 0;\n+\t}\n+\n \tif (message->tiles)\n \t{\n \t\tfor (size_t i = 0; i < message->numTiles; i++)\n",
  "stdout": "",
  "stderr": ""
}