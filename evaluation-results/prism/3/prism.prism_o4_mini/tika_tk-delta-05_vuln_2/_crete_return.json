{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.19564050000000002,
    "prompt_tokens": 98035,
    "completion_tokens": 19955
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -1093,11 +1093,16 @@\n             MediaType contentType = detector.detect(tis, metadata);\n \n             String name = metadata.get(TikaCoreProperties.RESOURCE_NAME_KEY);\n-            File outputFile = null;\n+            File outputFile;\n             if (name == null) {\n                 name = \"file\" + count++;\n             }\n-            outputFile = getOutputFile(name, metadata, contentType);\n+            try {\n+                outputFile = getOutputFile(name, metadata, contentType);\n+            } catch (IOException e) {\n+                LOG.warn(\"Skipping embedded file {} due to invalid file path: {}\", name, e.getMessage());\n+                return;\n+            }\n \n \n             File parent = outputFile.getParentFile();\n@@ -1125,7 +1130,7 @@\n             }\n         }\n \n-        private File getOutputFile(String name, Metadata metadata, MediaType contentType) {\n+        private File getOutputFile(String name, Metadata metadata, MediaType contentType) throws IOException {\n             String ext = getExtension(contentType);\n             if (name.indexOf('.') == -1 && contentType != null) {\n                 name += ext;\n@@ -1135,8 +1140,8 @@\n             if (relID != null && !name.startsWith(relID)) {\n                 name = relID + \"_\" + name;\n             }\n-            //defensively do this so that we don't get an exception\n-            //from FilenameUtils.normalize\n+            // defensively do this so that we don't get an exception\n+            // from FilenameUtils.normalize\n             name = name.replaceAll(\"\\u0000\", \" \");\n             String normalizedName = FilenameUtils.normalize(name);\n \n@@ -1147,7 +1152,7 @@\n             if (normalizedName == null) {\n                 normalizedName = \"file\" + count++ + ext;\n             }\n-            //strip off initial C:/ or ~/ or /\n+            // strip off initial C:/ or ~/ or /\n             int prefixLength = FilenameUtils.getPrefixLength(normalizedName);\n             if (prefixLength > -1) {\n                 normalizedName = normalizedName.substring(prefixLength);\n@@ -1157,15 +1162,20 @@\n             } catch (IllegalArgumentException e) {\n                 LOG.warn(\"couldn't url decode name {}\", normalizedName);\n             }\n-            File outputFile = new File(extractDir, normalizedName);\n-            //if file already exists, prepend uuid\n-            if (outputFile.exists()) {\n-                String fileName = FilenameUtils.getName(normalizedName);\n-                outputFile = new File(extractDir, UUID\n-                        .randomUUID()\n-                        .toString() + \"-\" + fileName);\n-            }\n-            return outputFile;\n+            // resolve and normalize against extraction directory to prevent traversal\n+            java.nio.file.Path root = extractDir.toPath();\n+            java.nio.file.Path target = root.resolve(normalizedName).normalize();\n+            if (!target.startsWith(root)) {\n+                throw new IOException(\"Invalid embedded file name, potential path traversal: \" + normalizedName);\n+            }\n+            // if file already exists, prepend uuid\n+            if (java.nio.file.Files.exists(target)) {\n+                String baseName = FilenameUtils.getName(normalizedName);\n+                String unique = UUID.randomUUID().toString() + \"-\" + baseName;\n+                java.nio.file.Path alt = root.resolve(unique).normalize();\n+                target = alt;\n+            }\n+            return target.toFile();\n         }\n \n         private String getExtension(MediaType contentType) {\n",
  "stdout": "",
  "stderr": ""
}