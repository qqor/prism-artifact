[10/28/25 00:19:41] INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmpqt_h5ndt                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/tika_tk-full-01_vuln_8/agent-output-1761610781.7166815                                                                              
                             - Detection toml file: /tasks_new/tika_tk-full-01/detection/tika_tk-full-01_vuln_8.toml                                                                                             
                             - Challenge project directory: /tasks_new/tika_tk-full-01/official-afc-tika                                                                                                         
                                                                                                                                                                                                                 
                    INFO     [logging_performance](tika Building Cached for CLEAN environment) Started...                                                                                   context_managers.py:9
[10/28/25 00:21:33] INFO     [logging_performance](tika Building Cached for CLEAN environment) Took 112.15 seconds; exception=False                                                        context_managers.py:23
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Started...                                                                          context_managers.py:9
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                                                 context_managers.py:23
                    INFO     Setting timeouts                                                                                                                                                       default.py:85
                               - build: 600 (original: 112)                                                                                                                                                      
                               - run tests: 600 (original: 0)                                                                                                                                                    
                    INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:21:34] INFO     [logging_performance](tika Setting owner) Took 0.96 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:21:36] INFO     Successfully created Cached for CLEAN environment                                                                                                                    oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                                                            oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                                                 
                    INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:21:37] INFO     [logging_performance](tika Setting owner) Took 1.35 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:21:38] INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:21:39] INFO     [logging_performance](tika Setting owner) Took 0.94 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:21:51] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                                                              
                             ===Evaluator Diff===                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueCritical: OS Command Injection                                                                               
                             Executing OS commands with attacker-controlled data can lead to remote code execution.                                                                                              
                                     at com.code_intelligence.jazzer.sanitizers.OsCommandInjection.processImplStartHook(OsCommandInjection.java:63)                                                              
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1110)                                                                                                       
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1073)                                                                                                       
                                     at org.apache.tika.utils.ProcessUtils.execute(ProcessUtils.java:94)                                                                                                         
                                     at org.apache.tika.detect.ShellCodeDetector.detect(ShellCodeDetector.java:103)                                                                                              
                                     at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:84)                                                                                               
                                     at org.apache.tika.cli.TikaCLI$FileEmbeddedDocumentExtractor.parseEmbedded(TikaCLI.java:1092)                                                                               
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntry(PackageParser.java:481)                                                                                              
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntries(PackageParser.java:386)                                                                                            
                                     at org.apache.tika.parser.pkg.PackageParser._parse(PackageParser.java:336)                                                                                                  
                                     at org.apache.tika.parser.pkg.PackageParser.parse(PackageParser.java:259)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:204)                                                                                                 
                                     at org.apache.tika.cli.TikaCLI$OutputType.process(TikaCLI.java:1056)                                                                                                        
                                     at org.apache.tika.cli.TikaCLI.process(TikaCLI.java:485)                                                                                                                    
                                     at org.apache.tika.cli.TikaCLI.main(TikaCLI.java:237)                                                                                                                       
                                     at com.example.TikaAppUnpackerFuzzer.parseOne(TikaAppUnpackerFuzzer.java:74)                                                                                                
                                     at com.example.TikaAppUnpackerFuzzer.fuzzerTestOneInput(TikaAppUnpackerFuzzer.java:54)                                                                                      
                             DEDUP_TOKEN: d7514645016ef7a8                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueCritical: OS Command Injection                                                                               
                             Executing OS commands with attacker-controlled data can lead to remote code execution.                                                                                              
                                     at com.code_intelligence.jazzer.sanitizers.OsCommandInjection.processImplStartHook(OsCommandInjection.java:63)                                                              
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1110)                                                                                                       
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1073)                                                                                                       
                                     at org.apache.tika.utils.ProcessUtils.execute(ProcessUtils.java:94)                                                                                                         
                                     at org.apache.tika.detect.ShellCodeDetector.detect(ShellCodeDetector.java:103)                                                                                              
                                     at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:84)                                                                                               
                                     at org.apache.tika.cli.TikaCLI$FileEmbeddedDocumentExtractor.parseEmbedded(TikaCLI.java:1092)                                                                               
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntry(PackageParser.java:481)                                                                                              
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntries(PackageParser.java:386)                                                                                            
                                     at org.apache.tika.parser.pkg.PackageParser._parse(PackageParser.java:336)                                                                                                  
                                     at org.apache.tika.parser.pkg.PackageParser.parse(PackageParser.java:259)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:204)                                                                                                 
                                     at org.apache.tika.cli.TikaCLI$OutputType.process(TikaCLI.java:1056)                                                                                                        
                                     at org.apache.tika.cli.TikaCLI.process(TikaCLI.java:485)                                                                                                                    
                                     at org.apache.tika.cli.TikaCLI.main(TikaCLI.java:237)                                                                                                                       
                                     at com.example.TikaAppUnpackerFuzzer.parseOne(TikaAppUnpackerFuzzer.java:74)                                                                                                
                                     at com.example.TikaAppUnpackerFuzzer.fuzzerTestOneInput(TikaAppUnpackerFuzzer.java:54)                                                                                      
                             DEDUP_TOKEN: d7514645016ef7a8                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                                                                                                                                                                                                                 
                             ===Analysis Report===                                                                                                                                                               
                                                                                                                                                                                                                 
                             ===Evaluation End===                                                                                                                                                                
[10/28/25 00:22:00] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                                                  __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/28/25 00:23:41] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                                                     __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/28/25 00:24:44] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
                    INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:24:45] INFO     [logging_performance](tika Setting owner) Took 0.92 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:24:46] INFO     [logging_performance](tika Patching) Started...                                                                                                                context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmpbpq2t4bd                                                                                                                                 default.py:173
[10/28/25 00:26:05] INFO     [logging_performance](tika Patching) Took 78.83 seconds; exception=False                                                                                      context_managers.py:23
                    INFO     [logging_performance](tika Checking build) Started...                                                                                                          context_managers.py:9
[10/28/25 00:26:37] INFO     [logging_performance](tika Checking build) Took 32.61 seconds; exception=False                                                                                context_managers.py:23
                    INFO     [logging_performance](tika Running PoV) Started...                                                                                                             context_managers.py:9
[10/28/25 00:26:49] INFO     [logging_performance](tika Running PoV) Took 11.61 seconds; exception=False                                                                                   context_managers.py:23
                    INFO     [logging_performance](tika Testing) Started...                                                                                                                 context_managers.py:9
                    INFO     [logging_performance](tika Testing) Took 0.00 seconds; exception=False                                                                                        context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:26:50] INFO     [logging_performance](tika Setting owner) Took 0.87 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:26:51] INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:26:52] INFO     [logging_performance](tika Setting owner) Took 0.93 seconds; exception=False                                                                                  context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                                                           context_managers.py:9
[10/28/25 00:26:53] INFO     [logging_performance](tika Setting owner) Took 0.97 seconds; exception=False                                                                                  context_managers.py:23
[10/28/25 00:26:54] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                                                   
                             ===Evaluator Diff===                                                                                                                                                                
                             --- a/tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java                                                                                                         
                             +++ b/tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java                                                                                                         
                             @@ -97,11 +97,15 @@                                                                                                                                                                 
                                      Path tmpDir = Files.createTempDirectory(cwd, "tika-shell-detect-");                                                                                                        
                                      Path tmpFile = tmpDir.resolve(fileName);                                                                                                                                   
                                      Files.copy(tis.getPath(), tmpFile, StandardCopyOption.REPLACE_EXISTING);                                                                                                   
                             -        ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                          
                             +        ProcessBuilder pb = new ProcessBuilder("sh", "-n", fileName);                                                                                                              
                                      pb.directory(tmpDir.toFile());                                                                                                                                             
                             +        FileProcessResult result = null;                                                                                                                                           
                                      try {                                                                                                                                                                      
                             -            FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                            
                             -            if (result.getExitValue() == 0) {                                                                                                                                      
                             +            try {                                                                                                                                                                  
                             +                result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                                          
                             +            } catch (IOException e) {                                                                                                                                              
                             +            }                                                                                                                                                                      
                             +            if (result != null && result.getExitValue() == 0) {                                                                                                                    
                                              metadata.set(SHELL_NO_ARGS, true);                                                                                                                                 
                                          }                                                                                                                                                                      
                                      } finally {                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueCritical: OS Command Injection                                                                               
                             Executing OS commands with attacker-controlled data can lead to remote code execution.                                                                                              
                                     at com.code_intelligence.jazzer.sanitizers.OsCommandInjection.processImplStartHook(OsCommandInjection.java:63)                                                              
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1110)                                                                                                       
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1073)                                                                                                       
                                     at org.apache.tika.utils.ProcessUtils.execute(ProcessUtils.java:94)                                                                                                         
                                     at org.apache.tika.detect.ShellCodeDetector.detect(ShellCodeDetector.java:103)                                                                                              
                                     at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:84)                                                                                               
                                     at org.apache.tika.cli.TikaCLI$FileEmbeddedDocumentExtractor.parseEmbedded(TikaCLI.java:1092)                                                                               
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntry(PackageParser.java:481)                                                                                              
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntries(PackageParser.java:386)                                                                                            
                                     at org.apache.tika.parser.pkg.PackageParser._parse(PackageParser.java:336)                                                                                                  
                                     at org.apache.tika.parser.pkg.PackageParser.parse(PackageParser.java:259)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:204)                                                                                                 
                                     at org.apache.tika.cli.TikaCLI$OutputType.process(TikaCLI.java:1056)                                                                                                        
                                     at org.apache.tika.cli.TikaCLI.process(TikaCLI.java:485)                                                                                                                    
                                     at org.apache.tika.cli.TikaCLI.main(TikaCLI.java:237)                                                                                                                       
                                     at com.example.TikaAppUnpackerFuzzer.parseOne(TikaAppUnpackerFuzzer.java:74)                                                                                                
                                     at com.example.TikaAppUnpackerFuzzer.fuzzerTestOneInput(TikaAppUnpackerFuzzer.java:54)                                                                                      
                             DEDUP_TOKEN: d7514645016ef7a8                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                             # Evaluation Report                                                                                                                                                                 
                                                                                                                                                                                                                 
                             ## Summary                                                                                                                                                                          
                                                                                                                                                                                                                 
                             A Jazzer fuzzing run on the Apache Tika-based application triggered a `FuzzerSecurityIssueCritical: OS Command Injection` exception. The stack trace shows that                     
                             untrusted data ultimately reaches a `ProcessBuilder.start()` invocation within Tika’s `ShellCodeDetector`, indicating that an attacker-controlled input can be used                 
                             to execute arbitrary operating-system commands.                                                                                                                                     
                                                                                                                                                                                                                 
                             ## Description                                                                                                                                                                      
                                                                                                                                                                                                                 
                             - Issue: During fuzz testing, the harness (`TikaAppUnpackerFuzzer`) supplied crafted input that propagated through Tika’s parsing and detection pipeline. This                      
                             input led to the invocation of `ProcessUtils.execute(...)` in `org.apache.tika.utils.ProcessUtils`, which in turn called `ProcessBuilder.start()`. Jazzer flagged                   
                             this as an OS command injection vulnerability (`OsCommandInjection.processImplStartHook`).                                                                                          
                                                                                                                                                                                                                 
                             - Vulnerability Type: OS Command Injection. The fuzzer observed that shell commands are constructed or invoked using data that may originate from                                   
                             attacker-controlled sources, enabling remote code execution.                                                                                                                        
                                                                                                                                                                                                                 
                             - Important Observations:                                                                                                                                                           
                               • The exception originates in `com.code_intelligence.jazzer.sanitizers.OsCommandInjection` as a critical security issue.                                                          
                               • The stack trace shows the flow:                                                                                                                                                 
                                 1. `TikaAppUnpackerFuzzer.fuzzerTestOneInput` (entry point)                                                                                                                     
                                 2. `TikaCLI.main` → `TikaCLI.process` → `TikaCLI$OutputType.process`                                                                                                            
                                 3. `AutoDetectParser.parse` → `CompositeParser.parse` → `PackageParser.parse` → `ShellCodeDetector.detect`                                                                      
                                 4. `ProcessUtils.execute` → `ProcessBuilder.start`                                                                                                                              
                               • The crash indicates that attacker-controlled content influences command arguments or command-line construction without proper sanitization.                                     
                                                                                                                                                                                                                 
                             - Areas for Investigation:                                                                                                                                                          
                               • The `ShellCodeDetector` class, especially the `detect` method where external processes are launched.                                                                            
                               • The `ProcessUtils.execute` helper and any code paths that accept or build command strings from input content.                                                                   
                               • The sequence of parsers in `CompositeParser` and `AutoDetectParser` to understand how input flows to the shell invocation.                                                      
                               • The Tika CLI integration (`TikaCLI` and its nested classes) to see how file contents or embedded documents are handed off to detection code.                                    
                               • The fuzzer harness (`TikaAppUnpackerFuzzer`) only exercises the code and is not the root cause; focus remains on the Tika and utility classes that build and                    
                             run OS commands.                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Initial Issue Log                                                                                                                                                                
                             Here is the initial issue log of the codebase:                                                                                                                                      
                             <issue>                                                                                                                                                                             
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueCritical: OS Command Injection                                                                               
                             Executing OS commands with attacker-controlled data can lead to remote code execution.                                                                                              
                                     at com.code_intelligence.jazzer.sanitizers.OsCommandInjection.processImplStartHook(OsCommandInjection.java:63)                                                              
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1110)                                                                                                       
                                     at java.base/java.lang.ProcessBuilder.start(ProcessBuilder.java:1073)                                                                                                       
                                     at org.apache.tika.utils.ProcessUtils.execute(ProcessUtils.java:94)                                                                                                         
                                     at org.apache.tika.detect.ShellCodeDetector.detect(ShellCodeDetector.java:103)                                                                                              
                                     at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:84)                                                                                               
                                     at org.apache.tika.cli.TikaCLI$FileEmbeddedDocumentExtractor.parseEmbedded(TikaCLI.java:1092)                                                                               
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntry(PackageParser.java:481)                                                                                              
                                     at org.apache.tika.parser.pkg.PackageParser.parseEntries(PackageParser.java:386)                                                                                            
                                     at org.apache.tika.parser.pkg.PackageParser._parse(PackageParser.java:336)                                                                                                  
                                     at org.apache.tika.parser.pkg.PackageParser.parse(PackageParser.java:259)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:298)                                                                                                   
                                     at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:204)                                                                                                 
                                     at org.apache.tika.cli.TikaCLI$OutputType.process(TikaCLI.java:1056)                                                                                                        
                                     at org.apache.tika.cli.TikaCLI.process(TikaCLI.java:485)                                                                                                                    
                                     at org.apache.tika.cli.TikaCLI.main(TikaCLI.java:237)                                                                                                                       
                                     at com.example.TikaAppUnpackerFuzzer.parseOne(TikaAppUnpackerFuzzer.java:74)                                                                                                
                                     at com.example.TikaAppUnpackerFuzzer.fuzzerTestOneInput(TikaAppUnpackerFuzzer.java:54)                                                                                      
                             DEDUP_TOKEN: d7514645016ef7a8                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             </issue>                                                                                                                                                                            
                             ===Analysis Report===                                                                                                                                                               
                             # Analysis Report                                                                                                                                                                   
                                                                                                                                                                                                                 
                             ## Relevant Code Snippets                                                                                                                                                           
                             <code_snippets>                                                                                                                                                                     
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java:1-119                                                                                                         
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:package org.apache.tika.detect;                                                                                                                                                  
                             18:                                                                                                                                                                                 
                             19:import java.io.EOFException;                                                                                                                                                     
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:import java.nio.charset.StandardCharsets;                                                                                                                                        
                             23:import java.nio.file.Files;                                                                                                                                                      
                             24:import java.nio.file.Path;                                                                                                                                                       
                             25:import java.nio.file.Paths;                                                                                                                                                      
                             26:import java.nio.file.StandardCopyOption;                                                                                                                                         
                             27:import java.util.Locale;                                                                                                                                                         
                             28:                                                                                                                                                                                 
                             29:import org.apache.commons.io.FileUtils;                                                                                                                                          
                             30:import org.apache.commons.io.FilenameUtils;                                                                                                                                      
                             31:import org.apache.commons.io.IOUtils;                                                                                                                                            
                             32:import org.apache.commons.io.input.CloseShieldInputStream;                                                                                                                       
                             33:                                                                                                                                                                                 
                             34:import org.apache.tika.io.TikaInputStream;                                                                                                                                       
                             35:import org.apache.tika.metadata.Metadata;                                                                                                                                        
                             36:import org.apache.tika.metadata.Property;                                                                                                                                        
                             37:import org.apache.tika.metadata.TikaCoreProperties;                                                                                                                              
                             38:import org.apache.tika.mime.MediaType;                                                                                                                                           
                             39:import org.apache.tika.utils.FileProcessResult;                                                                                                                                  
                             40:import org.apache.tika.utils.ProcessUtils;                                                                                                                                       
                             41:import org.apache.tika.utils.StringUtils;                                                                                                                                        
                             42:                                                                                                                                                                                 
                             43:/**                                                                                                                                                                              
                             44: * Simple detector to determine if a shell script is no-arg shell script.                                                                                                        
                             45: */                                                                                                                                                                              
                             46:public class ShellCodeDetector implements Detector {                                                                                                                             
                             47:                                                                                                                                                                                 
                             48:    public static final Property SHELL_NO_ARGS = Property.externalBoolean("sh:no_args");                                                                                         
                             49:                                                                                                                                                                                 
                             50:    private static final int MAX_LENGTH = 64;                                                                                                                                    
                             51:    private static final MediaType SHELL_SCRIPT = MediaType.application("x-sh");                                                                                                 
                             52:    private static final int SNIFF_LENGTH = 4;                                                                                                                                   
                             53:    @Override                                                                                                                                                                    
                             54:    public MediaType detect(InputStream input, Metadata metadata) throws IOException {                                                                                           
                             55:        boolean isShell = false;                                                                                                                                                 
                             56:        String name = metadata.get(TikaCoreProperties.RESOURCE_NAME_KEY);                                                                                                        
                             57:        if (name != null) {                                                                                                                                                      
                             58:            name = name.toLowerCase(Locale.ROOT);                                                                                                                                
                             59:            if (name.endsWith(".sh") || name.endsWith(".bash")) {                                                                                                                
                             60:                isShell = true;                                                                                                                                                  
                             61:            }                                                                                                                                                                    
                             62:        }                                                                                                                                                                        
                             63:        if (input == null) {                                                                                                                                                     
                             64:            return isShell(isShell);                                                                                                                                             
                             65:        }                                                                                                                                                                        
                             66:                                                                                                                                                                                 
                             67:        try {                                                                                                                                                                    
                             68:            input.mark(SNIFF_LENGTH);                                                                                                                                            
                             69:            byte[] bytes = IOUtils.readFully(input, SNIFF_LENGTH);                                                                                                               
                             70:            String firstBytes = new String(bytes, StandardCharsets.UTF_8);                                                                                                       
                             71:            if (firstBytes.startsWith("#!/") || firstBytes.startsWith("#!\\ ") ||                                                                                                
                             72:                    firstBytes.startsWith("#!\t")) {                                                                                                                             
                             73:                isShell = true;                                                                                                                                                  
                             74:            }                                                                                                                                                                    
                             75:        } catch (EOFException e) {                                                                                                                                               
                             76:            return isShell(false);                                                                                                                                               
                             77:        } finally {                                                                                                                                                              
                             78:            input.reset();                                                                                                                                                       
                             79:        }                                                                                                                                                                        
                             80:        if (! isShell) {                                                                                                                                                         
                             81:            return MediaType.OCTET_STREAM;                                                                                                                                       
                             82:        }                                                                                                                                                                        
                             83:        String fileName = metadata.get(TikaCoreProperties.RESOURCE_NAME_KEY);                                                                                                    
                             84:        if (StringUtils.isBlank(fileName)) {                                                                                                                                     
                             85:            return isShell(isShell);                                                                                                                                             
                             86:        }                                                                                                                                                                        
                             87:        //now test for no-arg shell script                                                                                                                                       
                             88:        TikaInputStream tis = TikaInputStream.get(CloseShieldInputStream.wrap(input));                                                                                           
                             89:        fileName = FilenameUtils.getName(fileName);                                                                                                                              
                             90:        fileName = fileName.replaceAll("[^-_0-9A-Za-z.]+", "");                                                                                                                  
                             91:        fileName = fileName.replaceAll("\\.\\.", "");                                                                                                                            
                             92:                                                                                                                                                                                 
                             93:        if (fileName.length() > MAX_LENGTH) {                                                                                                                                    
                             94:            fileName = fileName.substring(fileName.length() - MAX_LENGTH);                                                                                                       
                             95:        }                                                                                                                                                                        
                             96:        Path cwd = Paths.get(".").toAbsolutePath().normalize();                                                                                                                  
                             97:        Path tmpDir = Files.createTempDirectory(cwd, "tika-shell-detect-");                                                                                                      
                             98:        Path tmpFile = tmpDir.resolve(fileName);                                                                                                                                 
                             99:        Files.copy(tis.getPath(), tmpFile, StandardCopyOption.REPLACE_EXISTING);                                                                                                 
                             100:        ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                       
                             101:        pb.directory(tmpDir.toFile());                                                                                                                                          
                             102:        try {                                                                                                                                                                   
                             103:            FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                         
                             104:            if (result.getExitValue() == 0) {                                                                                                                                   
                             105:                metadata.set(SHELL_NO_ARGS, true);                                                                                                                              
                             106:            }                                                                                                                                                                   
                             107:        } finally {                                                                                                                                                             
                             108:            FileUtils.deleteDirectory(tmpDir.toFile());                                                                                                                         
                             109:        }                                                                                                                                                                       
                             110:        return SHELL_SCRIPT;                                                                                                                                                    
                             111:    }                                                                                                                                                                           
                             112:                                                                                                                                                                                
                             113:    private MediaType isShell(boolean isShell) {                                                                                                                                
                             114:        if (isShell) {                                                                                                                                                          
                             115:            return SHELL_SCRIPT;                                                                                                                                                
                             116:        }                                                                                                                                                                       
                             117:        return MediaType.OCTET_STREAM;                                                                                                                                          
                             118:    }                                                                                                                                                                           
                             119:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/CompositeDetector.java:1-135                                                                                                         
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:package org.apache.tika.detect;                                                                                                                                                  
                             18:                                                                                                                                                                                 
                             19:import java.io.IOException;                                                                                                                                                      
                             20:import java.io.InputStream;                                                                                                                                                      
                             21:import java.util.ArrayList;                                                                                                                                                      
                             22:import java.util.Arrays;                                                                                                                                                         
                             23:import java.util.Collection;                                                                                                                                                     
                             24:import java.util.Collections;                                                                                                                                                    
                             25:import java.util.List;                                                                                                                                                           
                             26:                                                                                                                                                                                 
                             27:import org.apache.tika.metadata.Metadata;                                                                                                                                        
                             28:import org.apache.tika.metadata.TikaCoreProperties;                                                                                                                              
                             29:import org.apache.tika.mime.MediaType;                                                                                                                                           
                             30:import org.apache.tika.mime.MediaTypeRegistry;                                                                                                                                   
                             31:import org.apache.tika.utils.StringUtils;                                                                                                                                        
                             32:                                                                                                                                                                                 
                             33:/**                                                                                                                                                                              
                             34: * Content type detector that combines multiple different detection mechanisms.                                                                                                  
                             35: */                                                                                                                                                                              
                             36:public class CompositeDetector implements Detector {                                                                                                                             
                             37:                                                                                                                                                                                 
                             38:    /**                                                                                                                                                                          
                             39:     * Serial version UID                                                                                                                                                        
                             40:     */                                                                                                                                                                          
                             41:    private static final long serialVersionUID = 5980683158436430252L;                                                                                                           
                             42:                                                                                                                                                                                 
                             43:    private final MediaTypeRegistry registry;                                                                                                                                    
                             44:                                                                                                                                                                                 
                             45:    private final List<Detector> detectors;                                                                                                                                      
                             46:                                                                                                                                                                                 
                             47:    public CompositeDetector(MediaTypeRegistry registry, List<Detector> detectors,                                                                                               
                             48:                             Collection<Class<? extends Detector>> excludeDetectors) {                                                                                           
                             49:        if (excludeDetectors == null || excludeDetectors.isEmpty()) {                                                                                                            
                             50:            this.detectors = detectors;                                                                                                                                          
                             51:        } else {                                                                                                                                                                 
                             52:            this.detectors = new ArrayList<>();                                                                                                                                  
                             53:            for (Detector d : detectors) {                                                                                                                                       
                             54:                if (!isExcluded(excludeDetectors, d.getClass())) {                                                                                                               
                             55:                    this.detectors.add(d);                                                                                                                                       
                             56:                }                                                                                                                                                                
                             57:            }                                                                                                                                                                    
                             58:        }                                                                                                                                                                        
                             59:        this.registry = registry;                                                                                                                                                
                             60:    }                                                                                                                                                                            
                             61:                                                                                                                                                                                 
                             62:    public CompositeDetector(MediaTypeRegistry registry, List<Detector> detectors) {                                                                                             
                             63:        this(registry, detectors, null);                                                                                                                                         
                             64:    }                                                                                                                                                                            
                             65:                                                                                                                                                                                 
                             66:    public CompositeDetector(List<Detector> detectors) {                                                                                                                         
                             67:        this(new MediaTypeRegistry(), detectors);                                                                                                                                
                             68:    }                                                                                                                                                                            
                             69:                                                                                                                                                                                 
                             70:    public CompositeDetector(Detector... detectors) {                                                                                                                            
                             71:        this(Arrays.asList(detectors));                                                                                                                                          
                             72:    }                                                                                                                                                                            
                             73:                                                                                                                                                                                 
                             74:    public MediaType detect(InputStream input, Metadata metadata) throws IOException {                                                                                           
                             75:        MediaType override = detectOverrides(metadata);                                                                                                                          
                             76:        if (override != null) {                                                                                                                                                  
                             77:            return override;                                                                                                                                                     
                             78:        }                                                                                                                                                                        
                             79:        MediaType type = MediaType.OCTET_STREAM;                                                                                                                                 
                             80:                                                                                                                                                                                 
                             81:        //we have to iterate through all detectors because the override detector may                                                                                             
                             82:        //be within a CompositeDetector                                                                                                                                          
                             83:        for (Detector detector : getDetectors()) {                                                                                                                               
                             84:            MediaType detected = detector.detect(input, metadata);                                                                                                               
                             85:            if (registry.isSpecializationOf(detected, type)) {                                                                                                                   
                             86:                type = detected;                                                                                                                                                 
                             87:            }                                                                                                                                                                    
                             88:        }                                                                                                                                                                        
                             89:        return type;                                                                                                                                                             
                             90:    }                                                                                                                                                                            
                             91:                                                                                                                                                                                 
                             92:    /**                                                                                                                                                                          
                             93:     *                                                                                                                                                                           
                             94:     * @param metadata                                                                                                                                                           
                             95:     * @return mediaType if a parseable mediatype was sent in via user or parser overrides                                                                                       
                             96:     */                                                                                                                                                                          
                             97:    private static MediaType detectOverrides(Metadata metadata) {                                                                                                                
                             98:        String override = metadata.get(TikaCoreProperties.CONTENT_TYPE_USER_OVERRIDE);                                                                                           
                             99:        if (!StringUtils.isBlank(override)) {                                                                                                                                    
                             100:            MediaType mt = MediaType.parse(override);                                                                                                                           
                             101:            if (mt != null) {                                                                                                                                                   
                             102:                return mt;                                                                                                                                                      
                             103:            }                                                                                                                                                                   
                             104:        }                                                                                                                                                                       
                             105:        override = metadata.get(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE);                                                                                               
                             106:        if (!StringUtils.isBlank(override)) {                                                                                                                                   
                             107:            MediaType mt = MediaType.parse(override);                                                                                                                           
                             108:            if (mt != null) {                                                                                                                                                   
                             109:                return mt;                                                                                                                                                      
                             110:            }                                                                                                                                                                   
                             111:        }                                                                                                                                                                       
                             112:        return null;                                                                                                                                                            
                             113:    }                                                                                                                                                                           
                             114:    /**                                                                                                                                                                         
                             115:     * Returns the component detectors.                                                                                                                                         
                             116:     */                                                                                                                                                                         
                             117:    public List<Detector> getDetectors() {                                                                                                                                      
                             118:        return Collections.unmodifiableList(detectors);                                                                                                                         
                             119:    }                                                                                                                                                                           
                             120:                                                                                                                                                                                
                             121:    private boolean isExcluded(Collection<Class<? extends Detector>> excludeDetectors,                                                                                          
                             122:                               Class<? extends Detector> d) {                                                                                                                   
                             123:        return excludeDetectors.contains(d) || assignableFrom(excludeDetectors, d);                                                                                             
                             124:    }                                                                                                                                                                           
                             125:                                                                                                                                                                                
                             126:    private boolean assignableFrom(Collection<Class<? extends Detector>> excludeDetectors,                                                                                      
                             127:                                   Class<? extends Detector> d) {                                                                                                               
                             128:        for (Class<? extends Detector> e : excludeDetectors) {                                                                                                                  
                             129:            if (e.isAssignableFrom(d)) {                                                                                                                                        
                             130:                return true;                                                                                                                                                    
                             131:            }                                                                                                                                                                   
                             132:        }                                                                                                                                                                       
                             133:        return false;                                                                                                                                                           
                             134:    }                                                                                                                                                                           
                             135:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/CompositeDetector.java:1-135                                                                                                         
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:package org.apache.tika.detect;                                                                                                                                                  
                             18:                                                                                                                                                                                 
                             19:import java.io.IOException;                                                                                                                                                      
                             20:import java.io.InputStream;                                                                                                                                                      
                             21:import java.util.ArrayList;                                                                                                                                                      
                             22:import java.util.Arrays;                                                                                                                                                         
                             23:import java.util.Collection;                                                                                                                                                     
                             24:import java.util.Collections;                                                                                                                                                    
                             25:import java.util.List;                                                                                                                                                           
                             26:                                                                                                                                                                                 
                             27:import org.apache.tika.metadata.Metadata;                                                                                                                                        
                             28:import org.apache.tika.metadata.TikaCoreProperties;                                                                                                                              
                             29:import org.apache.tika.mime.MediaType;                                                                                                                                           
                             30:import org.apache.tika.mime.MediaTypeRegistry;                                                                                                                                   
                             31:import org.apache.tika.utils.StringUtils;                                                                                                                                        
                             32:                                                                                                                                                                                 
                             33:/**                                                                                                                                                                              
                             34: * Content type detector that combines multiple different detection mechanisms.                                                                                                  
                             35: */                                                                                                                                                                              
                             36:public class CompositeDetector implements Detector {                                                                                                                             
                             37:                                                                                                                                                                                 
                             38:    /**                                                                                                                                                                          
                             39:     * Serial version UID                                                                                                                                                        
                             40:     */                                                                                                                                                                          
                             41:    private static final long serialVersionUID = 5980683158436430252L;                                                                                                           
                             42:                                                                                                                                                                                 
                             43:    private final MediaTypeRegistry registry;                                                                                                                                    
                             44:                                                                                                                                                                                 
                             45:    private final List<Detector> detectors;                                                                                                                                      
                             46:                                                                                                                                                                                 
                             47:    public CompositeDetector(MediaTypeRegistry registry, List<Detector> detectors,                                                                                               
                             48:                             Collection<Class<? extends Detector>> excludeDetectors) {                                                                                           
                             49:        if (excludeDetectors == null || excludeDetectors.isEmpty()) {                                                                                                            
                             50:            this.detectors = detectors;                                                                                                                                          
                             51:        } else {                                                                                                                                                                 
                             52:            this.detectors = new ArrayList<>();                                                                                                                                  
                             53:            for (Detector d : detectors) {                                                                                                                                       
                             54:                if (!isExcluded(excludeDetectors, d.getClass())) {                                                                                                               
                             55:                    this.detectors.add(d);                                                                                                                                       
                             56:                }                                                                                                                                                                
                             57:            }                                                                                                                                                                    
                             58:        }                                                                                                                                                                        
                             59:        this.registry = registry;                                                                                                                                                
                             60:    }                                                                                                                                                                            
                             61:                                                                                                                                                                                 
                             62:    public CompositeDetector(MediaTypeRegistry registry, List<Detector> detectors) {                                                                                             
                             63:        this(registry, detectors, null);                                                                                                                                         
                             64:    }                                                                                                                                                                            
                             65:                                                                                                                                                                                 
                             66:    public CompositeDetector(List<Detector> detectors) {                                                                                                                         
                             67:        this(new MediaTypeRegistry(), detectors);                                                                                                                                
                             68:    }                                                                                                                                                                            
                             69:                                                                                                                                                                                 
                             70:    public CompositeDetector(Detector... detectors) {                                                                                                                            
                             71:        this(Arrays.asList(detectors));                                                                                                                                          
                             72:    }                                                                                                                                                                            
                             73:                                                                                                                                                                                 
                             74:    public MediaType detect(InputStream input, Metadata metadata) throws IOException {                                                                                           
                             75:        MediaType override = detectOverrides(metadata);                                                                                                                          
                             76:        if (override != null) {                                                                                                                                                  
                             77:            return override;                                                                                                                                                     
                             78:        }                                                                                                                                                                        
                             79:        MediaType type = MediaType.OCTET_STREAM;                                                                                                                                 
                             80:                                                                                                                                                                                 
                             81:        //we have to iterate through all detectors because the override detector may                                                                                             
                             82:        //be within a CompositeDetector                                                                                                                                          
                             83:        for (Detector detector : getDetectors()) {                                                                                                                               
                             84:            MediaType detected = detector.detect(input, metadata);                                                                                                               
                             85:            if (registry.isSpecializationOf(detected, type)) {                                                                                                                   
                             86:                type = detected;                                                                                                                                                 
                             87:            }                                                                                                                                                                    
                             88:        }                                                                                                                                                                        
                             89:        return type;                                                                                                                                                             
                             90:    }                                                                                                                                                                            
                             91:                                                                                                                                                                                 
                             92:    /**                                                                                                                                                                          
                             93:     *                                                                                                                                                                           
                             94:     * @param metadata                                                                                                                                                           
                             95:     * @return mediaType if a parseable mediatype was sent in via user or parser overrides                                                                                       
                             96:     */                                                                                                                                                                          
                             97:    private static MediaType detectOverrides(Metadata metadata) {                                                                                                                
                             98:        String override = metadata.get(TikaCoreProperties.CONTENT_TYPE_USER_OVERRIDE);                                                                                           
                             99:        if (!StringUtils.isBlank(override)) {                                                                                                                                    
                             100:            MediaType mt = MediaType.parse(override);                                                                                                                           
                             101:            if (mt != null) {                                                                                                                                                   
                             102:                return mt;                                                                                                                                                      
                             103:            }                                                                                                                                                                   
                             104:        }                                                                                                                                                                       
                             105:        override = metadata.get(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE);                                                                                               
                             106:        if (!StringUtils.isBlank(override)) {                                                                                                                                   
                             107:            MediaType mt = MediaType.parse(override);                                                                                                                           
                             108:            if (mt != null) {                                                                                                                                                   
                             109:                return mt;                                                                                                                                                      
                             110:            }                                                                                                                                                                   
                             111:        }                                                                                                                                                                       
                             112:        return null;                                                                                                                                                            
                             113:    }                                                                                                                                                                           
                             114:    /**                                                                                                                                                                         
                             115:     * Returns the component detectors.                                                                                                                                         
                             116:     */                                                                                                                                                                         
                             117:    public List<Detector> getDetectors() {                                                                                                                                      
                             118:        return Collections.unmodifiableList(detectors);                                                                                                                         
                             119:    }                                                                                                                                                                           
                             120:                                                                                                                                                                                
                             121:    private boolean isExcluded(Collection<Class<? extends Detector>> excludeDetectors,                                                                                          
                             122:                               Class<? extends Detector> d) {                                                                                                                   
                             123:        return excludeDetectors.contains(d) || assignableFrom(excludeDetectors, d);                                                                                             
                             124:    }                                                                                                                                                                           
                             125:                                                                                                                                                                                
                             126:    private boolean assignableFrom(Collection<Class<? extends Detector>> excludeDetectors,                                                                                      
                             127:                                   Class<? extends Detector> d) {                                                                                                               
                             128:        for (Class<? extends Detector> e : excludeDetectors) {                                                                                                                  
                             129:            if (e.isAssignableFrom(d)) {                                                                                                                                        
                             130:                return true;                                                                                                                                                    
                             131:            }                                                                                                                                                                   
                             132:        }                                                                                                                                                                       
                             133:        return false;                                                                                                                                                           
                             134:    }                                                                                                                                                                           
                             135:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java:80-110                                                                                                        
                             ```                                                                                                                                                                                 
                             80:        if (! isShell) {                                                                                                                                                         
                             81:            return MediaType.OCTET_STREAM;                                                                                                                                       
                             82:        }                                                                                                                                                                        
                             83:        String fileName = metadata.get(TikaCoreProperties.RESOURCE_NAME_KEY);                                                                                                    
                             84:        if (StringUtils.isBlank(fileName)) {                                                                                                                                     
                             85:            return isShell(isShell);                                                                                                                                             
                             86:        }                                                                                                                                                                        
                             87:        //now test for no-arg shell script                                                                                                                                       
                             88:        TikaInputStream tis = TikaInputStream.get(CloseShieldInputStream.wrap(input));                                                                                           
                             89:        fileName = FilenameUtils.getName(fileName);                                                                                                                              
                             90:        fileName = fileName.replaceAll("[^-_0-9A-Za-z.]+", "");                                                                                                                  
                             91:        fileName = fileName.replaceAll("\\.\\.", "");                                                                                                                            
                             92:                                                                                                                                                                                 
                             93:        if (fileName.length() > MAX_LENGTH) {                                                                                                                                    
                             94:            fileName = fileName.substring(fileName.length() - MAX_LENGTH);                                                                                                       
                             95:        }                                                                                                                                                                        
                             96:        Path cwd = Paths.get(".").toAbsolutePath().normalize();                                                                                                                  
                             97:        Path tmpDir = Files.createTempDirectory(cwd, "tika-shell-detect-");                                                                                                      
                             98:        Path tmpFile = tmpDir.resolve(fileName);                                                                                                                                 
                             99:        Files.copy(tis.getPath(), tmpFile, StandardCopyOption.REPLACE_EXISTING);                                                                                                 
                             100:        ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                       
                             101:        pb.directory(tmpDir.toFile());                                                                                                                                          
                             102:        try {                                                                                                                                                                   
                             103:            FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                         
                             104:            if (result.getExitValue() == 0) {                                                                                                                                   
                             105:                metadata.set(SHELL_NO_ARGS, true);                                                                                                                              
                             106:            }                                                                                                                                                                   
                             107:        } finally {                                                                                                                                                             
                             108:            FileUtils.deleteDirectory(tmpDir.toFile());                                                                                                                         
                             109:        }                                                                                                                                                                       
                             110:        return SHELL_SCRIPT;                                                                                                                                                    
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java:80-110                                                                                                        
                             ```                                                                                                                                                                                 
                             80:        if (! isShell) {                                                                                                                                                         
                             81:            return MediaType.OCTET_STREAM;                                                                                                                                       
                             82:        }                                                                                                                                                                        
                             83:        String fileName = metadata.get(TikaCoreProperties.RESOURCE_NAME_KEY);                                                                                                    
                             84:        if (StringUtils.isBlank(fileName)) {                                                                                                                                     
                             85:            return isShell(isShell);                                                                                                                                             
                             86:        }                                                                                                                                                                        
                             87:        //now test for no-arg shell script                                                                                                                                       
                             88:        TikaInputStream tis = TikaInputStream.get(CloseShieldInputStream.wrap(input));                                                                                           
                             89:        fileName = FilenameUtils.getName(fileName);                                                                                                                              
                             90:        fileName = fileName.replaceAll("[^-_0-9A-Za-z.]+", "");                                                                                                                  
                             91:        fileName = fileName.replaceAll("\\.\\.", "");                                                                                                                            
                             92:                                                                                                                                                                                 
                             93:        if (fileName.length() > MAX_LENGTH) {                                                                                                                                    
                             94:            fileName = fileName.substring(fileName.length() - MAX_LENGTH);                                                                                                       
                             95:        }                                                                                                                                                                        
                             96:        Path cwd = Paths.get(".").toAbsolutePath().normalize();                                                                                                                  
                             97:        Path tmpDir = Files.createTempDirectory(cwd, "tika-shell-detect-");                                                                                                      
                             98:        Path tmpFile = tmpDir.resolve(fileName);                                                                                                                                 
                             99:        Files.copy(tis.getPath(), tmpFile, StandardCopyOption.REPLACE_EXISTING);                                                                                                 
                             100:        ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                       
                             101:        pb.directory(tmpDir.toFile());                                                                                                                                          
                             102:        try {                                                                                                                                                                   
                             103:            FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                         
                             104:            if (result.getExitValue() == 0) {                                                                                                                                   
                             105:                metadata.set(SHELL_NO_ARGS, true);                                                                                                                              
                             106:            }                                                                                                                                                                   
                             107:        } finally {                                                                                                                                                             
                             108:            FileUtils.deleteDirectory(tmpDir.toFile());                                                                                                                         
                             109:        }                                                                                                                                                                       
                             110:        return SHELL_SCRIPT;                                                                                                                                                    
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/FileCommandDetector.java:121-130                                                                                                     
                             ```                                                                                                                                                                                 
                             121:        String[] args =                                                                                                                                                         
                             122:                new String[]{ProcessUtils.escapeCommandLine(fileCommandPath), "-b", "--mime-type",                                                                              
                             123:                        ProcessUtils.escapeCommandLine(path.toAbsolutePath().toString())};                                                                                      
                             124:        ProcessBuilder builder = new ProcessBuilder(args);                                                                                                                      
                             125:        FileProcessResult result = ProcessUtils.execute(builder, timeoutMs, 10000, 10000);                                                                                      
                             126:        if (result.isTimeout()) {                                                                                                                                               
                             127:            metadata.set(ExternalProcess.IS_TIMEOUT, true);                                                                                                                     
                             128:            return MediaType.OCTET_STREAM;                                                                                                                                      
                             129:        }                                                                                                                                                                       
                             130:        if (result.getExitValue() != 0) {                                                                                                                                       
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java:98-108                                                                                                        
                             ```                                                                                                                                                                                 
                             98:        Path tmpFile = tmpDir.resolve(fileName);                                                                                                                                 
                             99:        Files.copy(tis.getPath(), tmpFile, StandardCopyOption.REPLACE_EXISTING);                                                                                                 
                             100:        ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                       
                             101:        pb.directory(tmpDir.toFile());                                                                                                                                          
                             102:        try {                                                                                                                                                                   
                             103:            FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                         
                             104:            if (result.getExitValue() == 0) {                                                                                                                                   
                             105:                metadata.set(SHELL_NO_ARGS, true);                                                                                                                              
                             106:            }                                                                                                                                                                   
                             107:        } finally {                                                                                                                                                             
                             108:            FileUtils.deleteDirectory(tmpDir.toFile());                                                                                                                         
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             </code_snippets>                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Fix Strategy                                                                                                                                                                     
                             <fix_strategy>                                                                                                                                                                      
                                                                                                                                                                                                                 
                             1. Issue Analysis and Root Cause                                                                                                                                                    
                                - The `ShellCodeDetector.detect` method writes untrusted script content to a temp file and then invokes it directly via                                                          
                                  ```java                                                                                                                                                                        
                                    ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                            
                                    pb.directory(tmpDir.toFile());                                                                                                                                               
                                    ProcessUtils.execute(pb, …);                                                                                                                                                 
                                  ```                                                                                                                                                                            
                                  This launches the script, allowing any attacker‐supplied code in the script body (shebang or otherwise) to be executed. Jazzer flags this as an OS command                     
                             injection vulnerability.                                                                                                                                                            
                                                                                                                                                                                                                 
                             2. Preserve Core Logic                                                                                                                                                              
                                - We must still detect “no-arg” shell scripts by checking whether invoking the script with no arguments returns exit code zero.                                                  
                                - We must not remove the feature entirely; only change how the external process is invoked to avoid executing arbitrary code.                                                    
                                                                                                                                                                                                                 
                             3. Safe Execution via Shell Syntax Check                                                                                                                                            
                                - POSIX shells provide a “syntax-only” mode (`-n`) that parses a script for errors without running any commands.                                                                 
                                - Replace the direct script execution with a shell syntax check:                                                                                                                 
                                  ```java                                                                                                                                                                        
                                    // Instead of new ProcessBuilder(fileName):                                                                                                                                  
                                    ProcessBuilder pb = new ProcessBuilder("sh", "-n", fileName);                                                                                                                
                                    pb.directory(tmpDir.toFile());                                                                                                                                               
                                    FileProcessResult result = ProcessUtils.execute(pb, timeoutMs, …);                                                                                                           
                                  ```                                                                                                                                                                            
                                - In this arrangement:                                                                                                                                                           
                                  • `sh` is the shell executable (commonly `/bin/sh`).                                                                                                                           
                                  • `-n` tells the shell “read the script and check syntax, do not run any commands.”                                                                                            
                                  • The exit code remains zero if the script is syntactically valid and contains no constructs requiring parameters (e.g., no `getopts`, `read`, etc.),                          
                             preserving the no-arg test.                                                                                                                                                         
                                                                                                                                                                                                                 
                             4. FileName Sanitization and Argument Passing                                                                                                                                       
                                - The existing sanitization steps (`replaceAll("[^-_0-9A-Za-z.]+","")`, dropping “..”, limiting length) already prevent malicious characters in `fileName`.                      
                                - By passing `fileName` as a separate argument to `ProcessBuilder` (rather than constructing a single shell command line), we avoid any further shell                            
                             interpretation or injection vectors.                                                                                                                                                
                                                                                                                                                                                                                 
                             5. Platform Considerations                                                                                                                                                          
                                - On non-POSIX platforms (Windows), the `"sh"` executable may not exist.                                                                                                         
                                - In `ProcessUtils.execute`, a missing command will raise an `IOException` or return non-zero exit code, so metadata will not be set. This is acceptable: it                     
                             simply disables no-arg detection on systems without `sh`.                                                                                                                           
                                - Optionally, wrap the execution block in a try-catch for `IOException` around `ProcessUtils.execute` to avoid surfacing errors; on exception, treat as “not a                   
                             no-arg shell” and continue cleanup.                                                                                                                                                 
                                                                                                                                                                                                                 
                             6. Detailed Patch Steps                                                                                                                                                             
                                a. In `ShellCodeDetector.detect` (lines 98–110):                                                                                                                                 
                                   • Replace                                                                                                                                                                     
                                     ```java                                                                                                                                                                     
                                     ProcessBuilder pb = new ProcessBuilder(fileName);                                                                                                                           
                                     pb.directory(tmpDir.toFile());                                                                                                                                              
                                     FileProcessResult result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                                 
                                     ```                                                                                                                                                                         
                                     with                                                                                                                                                                        
                                     ```java                                                                                                                                                                     
                                     // Run syntax check only to avoid executing attacker-supplied code                                                                                                          
                                     ProcessBuilder pb = new ProcessBuilder("sh", "-n", fileName);                                                                                                               
                                     pb.directory(tmpDir.toFile());                                                                                                                                              
                                     FileProcessResult result = null;                                                                                                                                            
                                     try {                                                                                                                                                                       
                                         result = ProcessUtils.execute(pb, 20000, 100000, 100000);                                                                                                               
                                     } catch (IOException e) {                                                                                                                                                   
                                         // Shell not available or execution error; treat as non-no-arg                                                                                                          
                                     }                                                                                                                                                                           
                                     if (result != null && result.getExitValue() == 0) {                                                                                                                         
                                         metadata.set(SHELL_NO_ARGS, true);                                                                                                                                      
                                     }                                                                                                                                                                           
                                     ```                                                                                                                                                                         
                                   • Ensure the `finally { FileUtils.deleteDirectory(tmpDir.toFile()); }` block remains unchanged.                                                                               
                                                                                                                                                                                                                 
                             7. Justification                                                                                                                                                                    
                                - By invoking `sh -n`, we eliminate any execution of script content, neutralizing the injection vector.                                                                          
                                - Exit‐code logic remains intact, so valid no-arg scripts still get flagged correctly.                                                                                           
                                - No changes are made to external libraries, utility methods, harness or fuzzing logic, or test code.                                                                            
                                - FileName sanitization plus argumentized `ProcessBuilder` ensures no additional injection opportunities.                                                                        
                                                                                                                                                                                                                 
                             8. Side-Effect Mitigation                                                                                                                                                           
                                - Detection on Windows or systems without `sh` will simply not set `SHELL_NO_ARGS`, but still return `SHELL_SCRIPT`, matching original behavior’s best effort.                   
                                - Any `IOException` from a missing shell or execution failure is caught and handled locally, preventing crashes.                                                                 
                                                                                                                                                                                                                 
                             9. Similar Pattern in Codebase                                                                                                                                                      
                                - `FileCommandDetector` already uses `ProcessBuilder` with explicit argument arrays and `escapeCommandLine` to invoke external tools safely. We mirror this                      
                             pattern, but leverage built-in shell syntax-check flags instead of executing the script.                                                                                            
                                                                                                                                                                                                                 
                             10. Summary                                                                                                                                                                         
                                - This targeted change fixes the OS command injection vulnerability by converting full script execution into a harmless syntax check, preserving existing                        
                             functionality with minimal, self‐contained modifications.                                                                                                                           
                                                                                                                                                                                                                 
                             </fix_strategy>                                                                                                                                                                     
                             ===Tests Result===                                                                                                                                                                  
                             No tests found                                                                                                                                                                      
                             ===Evaluation End===                                                                                                                                                                
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                                                      __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                                                       
                    INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmpqt_h5ndt                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/tika_tk-full-01_vuln_8/agent-output-1761611214.3691003                                                                              
                             - Detection toml file: /tasks_new/tika_tk-full-01/detection/tika_tk-full-01_vuln_8.toml                                                                                             
                             - Challenge project directory: /tasks_new/tika_tk-full-01/official-afc-tika                                                                                                         
                                                                                                                                                                                                                 
