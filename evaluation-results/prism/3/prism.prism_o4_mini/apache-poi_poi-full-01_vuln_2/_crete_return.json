{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/tasks_new/apache-poi_poi-full-01/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.1223937,
    "prompt_tokens": 49215,
    "completion_tokens": 15513
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -72,7 +72,14 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                String cleanRootName = root.getName().trim();\n+                cleanRootName = cleanRootName.replaceAll(\"[\\\\\\\\/]\", \"_\");\n+                cleanRootName = cleanRootName.replace(\"..\", \"\");\n+                cleanRootName = cleanRootName.replaceAll(\"[^A-Za-z0-9._-]\", \"_\");\n+                if (cleanRootName.isEmpty()) {\n+                    throw new IOException(\"Entry name invalid after sanitization: '\" + root.getName() + \"'\");\n+                }\n+                File file = new File(dumpDir, cleanRootName);\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -105,16 +112,35 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                String cleanName = node.getName().trim();\n+                cleanName = cleanName.replaceAll(\"[\\\\\\\\/]\", \"_\");\n+                cleanName = cleanName.replace(\"..\", \"\");\n+                cleanName = cleanName.replaceAll(\"[^A-Za-z0-9._-]\", \"_\");\n+                if (cleanName.isEmpty()) {\n+                    throw new IOException(\"Entry name invalid after sanitization: '\" + node.getName() + \"'\");\n+                }\n+                java.nio.file.Path target = parent.toPath().resolve(cleanName).normalize();\n+                if (!target.startsWith(parent.toPath())) {\n+                    throw new IOException(\"Invalid entry path: \" + cleanName);\n+                }\n+                try (OutputStream out = Files.newOutputStream(target)) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n+                String cleanDir = entry.getName().trim();\n+                cleanDir = cleanDir.replaceAll(\"[\\\\\\\\/]\", \"_\");\n+                cleanDir = cleanDir.replace(\"..\", \"\");\n+                cleanDir = cleanDir.replaceAll(\"[^A-Za-z0-9._-]\", \"_\");\n+                if (cleanDir.isEmpty()) {\n+                    throw new IOException(\"Entry name invalid after sanitization: '\" + entry.getName() + \"'\");\n                 }\n-                dump(dir, file);\n+                java.nio.file.Path dirTarget = parent.toPath().resolve(cleanDir).normalize();\n+                if (!dirTarget.startsWith(parent.toPath())) {\n+                    throw new IOException(\"Invalid entry path: \" + cleanDir);\n+                }\n+                Files.createDirectories(dirTarget);\n+                dump(dir, dirTarget.toFile());\n             } else {\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n",
  "stdout": "",
  "stderr": ""
}