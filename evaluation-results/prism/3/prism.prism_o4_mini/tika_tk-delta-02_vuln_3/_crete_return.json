{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-02_vuln_3",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.1466883,
    "prompt_tokens": 64289,
    "completion_tokens": 17266
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n@@ -21,6 +21,7 @@\n import java.io.InputStream;\n import java.io.InputStreamReader;\n import java.net.URL;\n+import java.net.MalformedURLException;\n import java.nio.charset.StandardCharsets;\n import java.text.DecimalFormat;\n import java.text.NumberFormat;\n@@ -47,7 +48,12 @@\n import org.apache.tika.utils.StringUtils;\n \n /**\n- * Basic parser for m3u8 files\n+ * Parser for M3U8 playlists. Remote resource fetching is disabled by default.\n+ * To enable HTTP/HTTPS fetches, add to your ParseContext:\n+ *\n+ *   M3U8ParserConfig cfg = new M3U8ParserConfig();\n+ *   cfg.setFetchRemoteResources(true);\n+ *   context.set(M3U8ParserConfig.class, cfg);\n  */\n public class M3U8Parser implements Parser {\n     public static final String M3U8_PREFIX = \"m3u8:\";\n@@ -63,6 +69,14 @@\n     private static final String EXTVERSION = \"#EXT-X-VERSION:\";\n     private static final String EXTKEY = \"#EXT-X-KEY:\";\n     private static final String EXTPLAYLISTTYPE = \"#EXT-X-PLAYLIST-TYPE:\";\n+    /**\n+     * Configuration for M3U8Parser to control remote resource fetching.\n+     */\n+    public static class M3U8ParserConfig {\n+        private boolean fetchRemoteResources = false;\n+        public boolean isFetchRemoteResources() { return fetchRemoteResources; }\n+        public void setFetchRemoteResources(boolean fetchRemoteResources) { this.fetchRemoteResources = fetchRemoteResources; }\n+    }\n \n     @Override\n     public Set<MediaType> getSupportedTypes(ParseContext context) {\n@@ -157,19 +171,25 @@\n         if (nextLine == null) {\n             return;\n         }\n-        //TODO -- parse contents in EXTINF line\n-        // split on , then the first value is the length (can be -1),\n-        // the last value is the title; intermediate values are key=value format\n         metadata.add(PLAY_LIST_LINK, nextLine);\n-        if (! nextLine.startsWith(\"http\")) {\n+        M3U8ParserConfig cfg = context.get(M3U8ParserConfig.class);\n+        boolean allowRemote = cfg != null && cfg.isFetchRemoteResources();\n+        URL url;\n+        try {\n+            url = new URL(nextLine);\n+        } catch (MalformedURLException e) {\n             return;\n         }\n+        String proto = url.getProtocol().toLowerCase(Locale.ROOT);\n         EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n         Metadata m = new Metadata();\n         if (ex.shouldParseEmbedded(m)) {\n-            try (TikaInputStream tis = TikaInputStream.get(new URL(nextLine))) {\n-                ex.parseEmbedded(tis, new BodyContentHandler(new EmbeddedContentHandler(xhtml)), m,\n-                        true);\n+            if (\"file\".equals(proto)\n+                    || ((\"http\".equals(proto) || \"https\".equals(proto)) && allowRemote)) {\n+                try (TikaInputStream tis = TikaInputStream.get(url)) {\n+                    ex.parseEmbedded(tis, new BodyContentHandler(new EmbeddedContentHandler(xhtml)), m,\n+                            true);\n+                }\n             }\n         }\n     }\n",
  "stdout": "",
  "stderr": ""
}