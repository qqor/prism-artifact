{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_4",
  "source_directory": "/tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.8307761,
    "prompt_tokens": 489671,
    "completion_tokens": 66395
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n@@ -69,7 +69,7 @@\n      * Heuristically chosen max length to buffer a Type1 font\n      */\n     private static final long MAX_LENGTH = 100_000_000;\n-\n+    private static final long MAX_PFB_SEGMENT_LENGTH = 1 * 1024 * 1024; // 1 MB max segment length\n     /**\n      * the parsed pfb-data.\n      */\n@@ -157,6 +157,9 @@\n             size += in.read() << 8;\n             size += in.read() << 16;\n             size += in.read() << 24;\n+            if (size < 0 || size > MAX_PFB_SEGMENT_LENGTH) {\n+                throw new IOException(\"PFB segment size out of bounds: \" + size);\n+            }\n             LOG.debug(\"record type: {}, segment size: {}\", recordType, size);\n             long newTotal = total + size;\n             if (newTotal > MAX_LENGTH) {\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n@@ -21,6 +21,8 @@\n import org.apache.fontbox.encoding.StandardEncoding;\n \n import java.io.IOException;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n@@ -538,6 +540,11 @@\n     /**\n      * Parses the binary portion of a Type 1 font.\n      */\n+    private static final Logger LOG = LogManager.getLogger(Type1Parser.class);\n+    private static final int MAX_CHARSTRINGS = 1_000;\n+    private static final int MAX_SUBRS = 5_000;\n+    private static final int MAX_OTHERSUBRS = 5_000;\n+\n     private void parseBinary(byte[] bytes) throws IOException\n     {\n         byte[] decrypted;\n@@ -549,6 +556,9 @@\n         else\n         {\n             decrypted = decrypt(hexToBinary(bytes), EEXEC_KEY, 4);\n+        }\n+        if (decrypted.length > 1024 * 1024) {\n+            throw new IOException(\"Decrypted font data too large: \" + decrypted.length);\n         }\n         lexer = new Type1Lexer(decrypted);\n \n@@ -707,6 +717,13 @@\n     {\n         // allocate size (array indexes may not be in-order)\n         int length = read(Token.INTEGER).intValue();\n+        if (length < 0) {\n+            throw new IOException(\"Negative Subrs count: \" + length);\n+        }\n+        if (length > MAX_SUBRS) {\n+            LOG.warn(\"Clamping Subrs count {} to {}\", length, MAX_SUBRS);\n+            length = MAX_SUBRS;\n+        }\n         for (int i = 0; i < length; i++)\n         {\n             font.subrs.add(null);\n@@ -757,6 +774,13 @@\n         else\n         {\n             int length = read(Token.INTEGER).intValue();\n+            if (length < 0) {\n+                throw new IOException(\"Negative OtherSubrs count: \" + length);\n+            }\n+            if (length > MAX_OTHERSUBRS) {\n+                LOG.warn(\"Clamping OtherSubrs count {} to {}\", length, MAX_OTHERSUBRS);\n+                length = MAX_OTHERSUBRS;\n+            }\n             read(Token.NAME, \"array\");\n \n             for (int i = 0; i < length; i++)\n@@ -777,6 +801,13 @@\n     private void readCharStrings(int lenIV) throws IOException\n     {\n         int length = read(Token.INTEGER).intValue();\n+        if (length < 0) {\n+            throw new IOException(\"Negative CharStrings count: \" + length);\n+        }\n+        if (length > MAX_CHARSTRINGS) {\n+            LOG.warn(\"Clamping CharStrings count {} to {}\", length, MAX_CHARSTRINGS);\n+            length = MAX_CHARSTRINGS;\n+        }\n         read(Token.NAME, \"dict\");\n         // could actually be a sequence ending in \"CharStrings begin\", too\n         // instead of the \"dup begin\"\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n@@ -48,6 +48,8 @@\n      * Log instance.\n      */\n     private static final Logger LOG = LogManager.getLogger(Type1Lexer.class);\n+    private static final int MAX_TOKEN_SCAN_BYTES = 16 * 1024; // 16 KB max per token\n+    private int scanned;\n     \n     private final ByteBuffer buffer;\n     private Token aheadToken;\n@@ -102,6 +104,10 @@\n     {\n         try\n         {\n+            scanned++;\n+            if (scanned > MAX_TOKEN_SCAN_BYTES) {\n+                throw new DamagedFontException(\"Token exceeds max length at position \" + buffer.position());\n+            }\n             return (char) buffer.get();\n         }\n         catch (BufferUnderflowException exception)\n@@ -116,6 +122,7 @@\n      */\n     private Token readToken(Token prevToken) throws IOException\n     {\n+        scanned = 0;\n         boolean skip;\n         do\n         {\n",
  "stdout": "",
  "stderr": ""
}