--- a/src/udev/udev-rules.c
+++ b/src/udev/udev-rules.c
@@ -1184,13 +1184,20 @@
                  * The return value must be terminated by two subsequent NULs
                  * so it could be safely interpreted as nulstr.
                  */
-                if (is_prefix_match){
+                {
+                    size_t orig_len = strlen(str) + 1;
+                    size_t offset = (size_t)(j - str);
+                    size_t needed = is_prefix_match ? 3 : 2;
+                    if (offset + needed > orig_len)
+                        return -EINVAL;
+                    if (is_prefix_match) {
                         j[0] = '*';
                         j[1] = '\0';
                         j[2] = '\0';
-                } else {
+                    } else {
                         j[0] = '\0';
                         j[1] = '\0';
+                    }
                 }
                 str = m;            
         } else {
@@ -1215,18 +1222,23 @@
                 * The return value must be terminated by two subsequent NULs
                 * so it could be safely interpreted as nulstr.
                 */
-                if (is_prefix_match){
+                {
+                    size_t orig_len = strlen(str) + 1;
+                    size_t needed = is_prefix_match ? 3 : 2;
+                    if ((pos - 1) + (l + needed) > orig_len)
+                        return -EINVAL;
+                    if (is_prefix_match) {
                         /* need more room to make rule glob match */
                         memcpy(str + pos - 1, unescaped, l + 1);
                         str[pos + l - 1] = '*';
-                        str[pos + l] = '\0';
+                        str[pos + l]     = '\0';
                         str[pos + l + 1] = '\0';
                         m = str + pos - 1;
-
-                } else {
+                    } else {
                         memcpy(m, unescaped, l + 1);
-                        m[l] = '\0';
+                        m[l]     = '\0';
                         m[l + 1] = '\0';
+                    }
                 }
                 str = m;
 
