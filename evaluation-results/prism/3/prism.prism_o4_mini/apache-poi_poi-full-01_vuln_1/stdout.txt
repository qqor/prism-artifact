[10/27/25 19:16:51] INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmp_xg748bq                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/apache-poi_poi-full-01_vuln_1/agent-output-1761592611.4709165                                                                       
                             - Detection toml file: /tasks_new/apache-poi_poi-full-01/detection/apache-poi_poi-full-01_vuln_1.toml                                                                               
                             - Challenge project directory: /tasks_new/apache-poi_poi-full-01/official-afc-poi                                                                                                   
                                                                                                                                                                                                                 
                    INFO     [logging_performance](apache-poi Building Cached for CLEAN environment) Started...                                                                             context_managers.py:9
[10/27/25 19:19:10] INFO     [logging_performance](apache-poi Building Cached for CLEAN environment) Took 139.47 seconds; exception=False                                                  context_managers.py:23
                    INFO     [logging_performance](apache-poi Running tests for Cached for CLEAN environment) Started...                                                                    context_managers.py:9
                    INFO     [logging_performance](apache-poi Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                                           context_managers.py:23
                    INFO     Setting timeouts                                                                                                                                                       default.py:85
                               - build: 600 (original: 139)                                                                                                                                                      
                               - run tests: 600 (original: 0)                                                                                                                                                    
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:19:11] INFO     [logging_performance](apache-poi Setting owner) Took 0.90 seconds; exception=False                                                                            context_managers.py:23
[10/27/25 19:19:13] INFO     Successfully created Cached for CLEAN environment                                                                                                                    oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                                                            oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                                                 
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:19:14] INFO     [logging_performance](apache-poi Setting owner) Took 1.11 seconds; exception=False                                                                            context_managers.py:23
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:19:15] INFO     [logging_performance](apache-poi Setting owner) Took 0.84 seconds; exception=False                                                                            context_managers.py:23
[10/27/25 19:19:21] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                                                              
                             ===Evaluator Diff===                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx921m' to reproduce)                                                             
                             Caused by: java.lang.OutOfMemoryError: Java heap space                                                                                                                              
                                     at java.base/java.lang.String.<init>(String.java:657)                                                                                                                       
                                     at org.apache.poi.util.StringUtil.getFromUnicodeLE(StringUtil.java:94)                                                                                                      
                                     at org.apache.poi.hmef.attribute.MAPIAttribute.create(MAPIAttribute.java:175)                                                                                               
                                     at org.apache.poi.hmef.attribute.TNEFMAPIAttribute.<init>(TNEFMAPIAttribute.java:41)                                                                                        
                                     at org.apache.poi.hmef.attribute.TNEFAttribute.create(TNEFAttribute.java:86)                                                                                                
                                     at org.apache.poi.hmef.HMEFMessage.processMessage(HMEFMessage.java:105)                                                                                                     
                                     at org.apache.poi.hmef.HMEFMessage.process(HMEFMessage.java:87)                                                                                                             
                                     at org.apache.poi.hmef.HMEFMessage.<init>(HMEFMessage.java:72)                                                                                                              
                                     at org.apache.poi.POIHMEFFuzzer.fuzzerTestOneInput(POIHMEFFuzzer.java:32)                                                                                                   
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cb8c00.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04800.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04000.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: a36f54a5f0a295bd                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx921m' to reproduce)                                                             
                             Caused by: java.lang.OutOfMemoryError: Java heap space                                                                                                                              
                                     at java.base/java.lang.String.<init>(String.java:657)                                                                                                                       
                                     at org.apache.poi.util.StringUtil.getFromUnicodeLE(StringUtil.java:94)                                                                                                      
                                     at org.apache.poi.hmef.attribute.MAPIAttribute.create(MAPIAttribute.java:175)                                                                                               
                                     at org.apache.poi.hmef.attribute.TNEFMAPIAttribute.<init>(TNEFMAPIAttribute.java:41)                                                                                        
                                     at org.apache.poi.hmef.attribute.TNEFAttribute.create(TNEFAttribute.java:86)                                                                                                
                                     at org.apache.poi.hmef.HMEFMessage.processMessage(HMEFMessage.java:105)                                                                                                     
                                     at org.apache.poi.hmef.HMEFMessage.process(HMEFMessage.java:87)                                                                                                             
                                     at org.apache.poi.hmef.HMEFMessage.<init>(HMEFMessage.java:72)                                                                                                              
                                     at org.apache.poi.POIHMEFFuzzer.fuzzerTestOneInput(POIHMEFFuzzer.java:32)                                                                                                   
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cb8c00.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04800.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04000.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: a36f54a5f0a295bd                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                                                                                                                                                                                                                 
                             ===Analysis Report===                                                                                                                                                               
                                                                                                                                                                                                                 
                             ===Evaluation End===                                                                                                                                                                
[10/27/25 19:19:32] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                                                  __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/27/25 19:21:39] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                                                     __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/27/25 19:22:26] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:22:27] INFO     [logging_performance](apache-poi Setting owner) Took 0.89 seconds; exception=False                                                                            context_managers.py:23
                    INFO     [logging_performance](apache-poi Patching) Started...                                                                                                          context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmp4dqjw_50                                                                                                                                 default.py:173
[10/27/25 19:24:27] INFO     [logging_performance](apache-poi Patching) Took 119.53 seconds; exception=False                                                                               context_managers.py:23
                    INFO     [logging_performance](apache-poi Checking build) Started...                                                                                                    context_managers.py:9
[10/27/25 19:25:03] INFO     [logging_performance](apache-poi Checking build) Took 36.51 seconds; exception=False                                                                          context_managers.py:23
                    INFO     [logging_performance](apache-poi Running PoV) Started...                                                                                                       context_managers.py:9
[10/27/25 19:25:17] INFO     [logging_performance](apache-poi Running PoV) Took 13.96 seconds; exception=False                                                                             context_managers.py:23
                    INFO     [logging_performance](apache-poi Testing) Started...                                                                                                           context_managers.py:9
                    INFO     [logging_performance](apache-poi Testing) Took 0.00 seconds; exception=False                                                                                  context_managers.py:23
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:25:18] INFO     [logging_performance](apache-poi Setting owner) Took 0.88 seconds; exception=False                                                                            context_managers.py:23
[10/27/25 19:25:19] INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:25:20] INFO     [logging_performance](apache-poi Setting owner) Took 0.79 seconds; exception=False                                                                            context_managers.py:23
                    INFO     [logging_performance](apache-poi Setting owner) Started...                                                                                                     context_managers.py:9
[10/27/25 19:25:21] INFO     [logging_performance](apache-poi Setting owner) Took 0.79 seconds; exception=False                                                                            context_managers.py:23
                    INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                                                   
                             ===Evaluator Diff===                                                                                                                                                                
                             --- a/poi/src/main/java/org/apache/poi/util/StringUtil.java                                                                                                                         
                             +++ b/poi/src/main/java/org/apache/poi/util/StringUtil.java                                                                                                                         
                             @@ -90,6 +90,9 @@                                                                                                                                                                   
                                      if ((len < 0) || (((string.length - offset) / 2) < len)) {                                                                                                                 
                                          throw new IllegalArgumentException("Illegal length " + len);                                                                                                           
                                      }                                                                                                                                                                          
                             +        if (len > MAX_RECORD_LENGTH) {                                                                                                                                             
                             +            throw new IllegalArgumentException("Requested Unicode string length " + len + " exceeds max record length " + MAX_RECORD_LENGTH);                                      
                             +        }                                                                                                                                                                          
                                                                                                                                                                                                                 
                                      return new String(string, offset, len * 2, UTF16LE);                                                                                                                       
                                  }                                                                                                                                                                              
                             @@ -108,7 +111,11 @@                                                                                                                                                                
                                      if (string.length == 0) {                                                                                                                                                  
                                          return "";                                                                                                                                                             
                                      }                                                                                                                                                                          
                             -        return getFromUnicodeLE(string, 0, string.length / 2);                                                                                                                     
                             +        int len = string.length / 2;                                                                                                                                               
                             +        if (len > MAX_RECORD_LENGTH) {                                                                                                                                             
                             +            throw new IllegalArgumentException("Requested Unicode string length " + len + " exceeds max record length " + MAX_RECORD_LENGTH);                                      
                             +        }                                                                                                                                                                          
                             +        return getFromUnicodeLE(string, 0, len);                                                                                                                                   
                                  }                                                                                                                                                                              
                                                                                                                                                                                                                 
                                  /**                                                                                                                                                                            
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx921m' to reproduce)                                                             
                             Caused by: java.lang.OutOfMemoryError: Java heap space                                                                                                                              
                                     at java.base/java.lang.String.<init>(String.java:657)                                                                                                                       
                                     at org.apache.poi.util.StringUtil.getFromUnicodeLE(StringUtil.java:94)                                                                                                      
                                     at org.apache.poi.hmef.attribute.MAPIAttribute.create(MAPIAttribute.java:175)                                                                                               
                                     at org.apache.poi.hmef.attribute.TNEFMAPIAttribute.<init>(TNEFMAPIAttribute.java:41)                                                                                        
                                     at org.apache.poi.hmef.attribute.TNEFAttribute.create(TNEFAttribute.java:86)                                                                                                
                                     at org.apache.poi.hmef.HMEFMessage.processMessage(HMEFMessage.java:105)                                                                                                     
                                     at org.apache.poi.hmef.HMEFMessage.process(HMEFMessage.java:87)                                                                                                             
                                     at org.apache.poi.hmef.HMEFMessage.<init>(HMEFMessage.java:72)                                                                                                              
                                     at org.apache.poi.POIHMEFFuzzer.fuzzerTestOneInput(POIHMEFFuzzer.java:32)                                                                                                   
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cb8c00.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04800.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04000.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: a36f54a5f0a295bd                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                             # Evaluation Report                                                                                                                                                                 
                                                                                                                                                                                                                 
                             ## Summary                                                                                                                                                                          
                                                                                                                                                                                                                 
                             The fuzzer triggered a Java `OutOfMemoryError` while processing a TNEF (Transport Neutral Encapsulation Format) message via Apache POI’s HMEF (Hewlett-Packard/MAPI                 
                             Encapsulation Format) support. The exception occurs during Unicode string conversion in `StringUtil.getFromUnicodeLE`, leading to heap exhaustion.                                  
                                                                                                                                                                                                                 
                             ## Description                                                                                                                                                                      
                                                                                                                                                                                                                 
                             - Issue type                                                                                                                                                                        
                               The issue is an out-of-memory condition (Java heap space exhaustion) flagged as a low-severity fuzzer security issue (`FuzzerSecurityIssueLow`).                                  
                                                                                                                                                                                                                 
                             - What happened                                                                                                                                                                     
                               While fuzzing the POI HMEF parser (`POIHMEFFuzzer.fuzzerTestOneInput`), the library attempts to construct a large or malformed Unicode string. This triggers                      
                             repeated or oversized allocations in `java.lang.String.<init>` until the JVM heap is exhausted, causing an `OutOfMemoryError`.                                                      
                                                                                                                                                                                                                 
                             - Key stack trace entries                                                                                                                                                           
                               1. `java.lang.String.<init>(String.java:657)`                                                                                                                                     
                               2. `org.apache.poi.util.StringUtil.getFromUnicodeLE(StringUtil.java:94)`                                                                                                          
                               3. `org.apache.poi.hmef.attribute.MAPIAttribute.create(MAPIAttribute.java:175)`                                                                                                   
                               4. `org.apache.poi.hmef.attribute.TNEFMAPIAttribute.<init>(TNEFMAPIAttribute.java:41)`                                                                                            
                               5. `org.apache.poi.hmef.attribute.TNEFAttribute.create(TNEFAttribute.java:86)`                                                                                                    
                               6. `org.apache.poi.hmef.HMEFMessage.processMessage(HMEFMessage.java:105)`                                                                                                         
                               7. `org.apache.poi.POIHMEFFuzzer.fuzzerTestOneInput(POIHMEFFuzzer.java:32)`                                                                                                       
                                                                                                                                                                                                                 
                             - Important observations                                                                                                                                                            
                               • The failure occurs during bidirectional processing of MAPI attributes embedded in TNEF.                                                                                         
                               • Unicode decoding in `StringUtil.getFromUnicodeLE` appears to drive unbounded memory growth.                                                                                     
                               • The crash is reproducible with a heap size of 921 MB (`-Xmx921m`).                                                                                                              
                                                                                                                                                                                                                 
                             - Areas for further investigation                                                                                                                                                   
                               1. `org.apache.poi.util.StringUtil.getFromUnicodeLE` – how input length and encoding are validated.                                                                               
                               2. `org.apache.poi.hmef.attribute.MAPIAttribute` and `TNEFMAPIAttribute` – how attribute sizes are parsed and limited.                                                            
                               3. `org.apache.poi.hmef.HMEFMessage.processMessage` – overall message parsing logic and boundary checks.                                                                          
                               4. Interaction between TNEF attribute creation (`TNEFAttribute.create`) and downstream string construction.                                                                       
                                                                                                                                                                                                                 
                             These components collectively form the parsing pipeline that should be reviewed to understand how untrusted or malformed input can trigger uncontrolled memory                      
                             consumption.                                                                                                                                                                        
                                                                                                                                                                                                                 
                             ## Initial Issue Log                                                                                                                                                                
                             Here is the initial issue log of the codebase:                                                                                                                                      
                             <issue>                                                                                                                                                                             
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx921m' to reproduce)                                                             
                             Caused by: java.lang.OutOfMemoryError: Java heap space                                                                                                                              
                                     at java.base/java.lang.String.<init>(String.java:657)                                                                                                                       
                                     at org.apache.poi.util.StringUtil.getFromUnicodeLE(StringUtil.java:94)                                                                                                      
                                     at org.apache.poi.hmef.attribute.MAPIAttribute.create(MAPIAttribute.java:175)                                                                                               
                                     at org.apache.poi.hmef.attribute.TNEFMAPIAttribute.<init>(TNEFMAPIAttribute.java:41)                                                                                        
                                     at org.apache.poi.hmef.attribute.TNEFAttribute.create(TNEFAttribute.java:86)                                                                                                
                                     at org.apache.poi.hmef.HMEFMessage.processMessage(HMEFMessage.java:105)                                                                                                     
                                     at org.apache.poi.hmef.HMEFMessage.process(HMEFMessage.java:87)                                                                                                             
                                     at org.apache.poi.hmef.HMEFMessage.<init>(HMEFMessage.java:72)                                                                                                              
                                     at org.apache.poi.POIHMEFFuzzer.fuzzerTestOneInput(POIHMEFFuzzer.java:32)                                                                                                   
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cb8c00.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04800.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800d04000.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: a36f54a5f0a295bd                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             </issue>                                                                                                                                                                            
                             ===Analysis Report===                                                                                                                                                               
                             # Analysis Report                                                                                                                                                                   
                                                                                                                                                                                                                 
                             ## Relevant Code Snippets                                                                                                                                                           
                             <code_snippets>                                                                                                                                                                     
                             <code>                                                                                                                                                                              
                             poi/src/main/java/org/apache/poi/util/StringUtil.java:1-150                                                                                                                         
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.util;                                                                                                                                                     
                             19:                                                                                                                                                                                 
                             20:import static java.nio.charset.StandardCharsets.ISO_8859_1;                                                                                                                      
                             21:import static java.nio.charset.StandardCharsets.UTF_8;                                                                                                                           
                             22:                                                                                                                                                                                 
                             23:import java.nio.charset.Charset;                                                                                                                                                 
                             24:import java.nio.charset.StandardCharsets;                                                                                                                                        
                             25:import java.util.Arrays;                                                                                                                                                         
                             26:import java.util.Locale;                                                                                                                                                         
                             27:                                                                                                                                                                                 
                             28:/**                                                                                                                                                                              
                             29: * Collection of string handling utilities                                                                                                                                       
                             30: */                                                                                                                                                                              
                             31:@Internal                                                                                                                                                                        
                             32:public final class StringUtil {                                                                                                                                                  
                             33:    //arbitrarily selected; may need to increase                                                                                                                                 
                             34:    private static final int DEFAULT_MAX_RECORD_LENGTH = 10000000;                                                                                                               
                             35:    private static int MAX_RECORD_LENGTH = DEFAULT_MAX_RECORD_LENGTH;                                                                                                            
                             36:                                                                                                                                                                                 
                             37:    public static final Charset UTF16LE = StandardCharsets.UTF_16LE;                                                                                                             
                             38:    public static final Charset UTF8 = StandardCharsets.UTF_8;                                                                                                                   
                             39:    public static final Charset WIN_1252 = Charset.forName("cp1252");                                                                                                            
                             40:                                                                                                                                                                                 
                             41:    /**                                                                                                                                                                          
                             42:     * @param length the max record length allowed for StringUtil                                                                                                                
                             43:     */                                                                                                                                                                          
                             44:    public static void setMaxRecordLength(int length) {                                                                                                                          
                             45:        MAX_RECORD_LENGTH = length;                                                                                                                                              
                             46:    }                                                                                                                                                                            
                             47:                                                                                                                                                                                 
                             48:    /**                                                                                                                                                                          
                             49:     * @return the max record length allowed for StringUtil                                                                                                                      
                             50:     */                                                                                                                                                                          
                             51:    public static int getMaxRecordLength() {                                                                                                                                     
                             52:        return MAX_RECORD_LENGTH;                                                                                                                                                
                             53:    }                                                                                                                                                                            
                             54:                                                                                                                                                                                 
                             55:    private StringUtil() {                                                                                                                                                       
                             56:        // no instances of this class                                                                                                                                            
                             57:    }                                                                                                                                                                            
                             58:                                                                                                                                                                                 
                             59:    /**                                                                                                                                                                          
                             60:     * Given a byte array of 16-bit unicode characters in Little Endian                                                                                                          
                             61:     * format (most important byte last), return a Java String representation                                                                                                    
                             62:     * of it.                                                                                                                                                                    
                             63:     * <p>                                                                                                                                                                       
                             64:     * { 0x16, 0x00 } -0x16                                                                                                                                                      
                             65:     *                                                                                                                                                                           
                             66:     * @param string the byte array to be converted                                                                                                                              
                             67:     * @param offset the initial offset into the                                                                                                                                 
                             68:     *               byte array. it is assumed that string[ offset ] and string[ offset +                                                                                        
                             69:     *               1 ] contain the first 16-bit unicode character                                                                                                              
                             70:     * @param len    the length of the final string                                                                                                                              
                             71:     * @return the converted string, never {@code null}.                                                                                                                         
                             72:     * @throws ArrayIndexOutOfBoundsException if offset is out of bounds for                                                                                                     
                             73:     *                                        the byte array (i.e., is negative or is greater than or equal to                                                                   
                             74:     *                                        string.length)                                                                                                                     
                             75:     * @throws IllegalArgumentException       if len is too large (i.e.,                                                                                                         
                             76:     *                                        there is not enough data in string to create a String of that                                                                      
                             77:     *                                        length)                                                                                                                            
                             78:     */                                                                                                                                                                          
                             79:    public static String getFromUnicodeLE(                                                                                                                                       
                             80:            final byte[] string,                                                                                                                                                 
                             81:            final int offset,                                                                                                                                                    
                             82:            final int len)                                                                                                                                                       
                             83:            throws ArrayIndexOutOfBoundsException, IllegalArgumentException {                                                                                                    
                             84:        if (len == 0) {                                                                                                                                                          
                             85:            return "";                                                                                                                                                           
                             86:        }                                                                                                                                                                        
                             87:        if ((offset < 0) || (offset >= string.length)) {                                                                                                                         
                             88:            throw new ArrayIndexOutOfBoundsException("Illegal offset " + offset + " (String data is of length " + string.length + ")");                                          
                             89:        }                                                                                                                                                                        
                             90:        if ((len < 0) || (((string.length - offset) / 2) < len)) {                                                                                                               
                             91:            throw new IllegalArgumentException("Illegal length " + len);                                                                                                         
                             92:        }                                                                                                                                                                        
                             93:                                                                                                                                                                                 
                             94:        return new String(string, offset, len * 2, UTF16LE);                                                                                                                     
                             95:    }                                                                                                                                                                            
                             96:                                                                                                                                                                                 
                             97:    /**                                                                                                                                                                          
                             98:     * Given a byte array of 16-bit unicode characters in little endian                                                                                                          
                             99:     * format (most important byte last), return a Java String representation                                                                                                    
                             100:     * of it.                                                                                                                                                                   
                             101:     * <p>                                                                                                                                                                      
                             102:     * { 0x16, 0x00 } -0x16                                                                                                                                                     
                             103:     *                                                                                                                                                                          
                             104:     * @param string the byte array to be converted                                                                                                                             
                             105:     * @return the converted string, never {@code null}                                                                                                                         
                             106:     */                                                                                                                                                                         
                             107:    public static String getFromUnicodeLE(byte[] string) {                                                                                                                      
                             108:        if (string.length == 0) {                                                                                                                                               
                             109:            return "";                                                                                                                                                          
                             110:        }                                                                                                                                                                       
                             111:        return getFromUnicodeLE(string, 0, string.length / 2);                                                                                                                  
                             112:    }                                                                                                                                                                           
                             113:                                                                                                                                                                                
                             114:    /**                                                                                                                                                                         
                             115:     * Convert String to 16-bit unicode characters in little endian format                                                                                                      
                             116:     *                                                                                                                                                                          
                             117:     * @param string the string                                                                                                                                                 
                             118:     * @return the byte array of 16-bit unicode characters                                                                                                                      
                             119:     */                                                                                                                                                                         
                             120:    public static byte[] getToUnicodeLE(String string) {                                                                                                                        
                             121:        return string.getBytes(UTF16LE);                                                                                                                                        
                             122:    }                                                                                                                                                                           
                             123:                                                                                                                                                                                
                             124:    /**                                                                                                                                                                         
                             125:     * Read 8 bit data (in ISO-8859-1 codepage) into a (unicode) Java                                                                                                           
                             126:     * String and return.                                                                                                                                                       
                             127:     * (In Excel terms, read compressed 8 bit unicode as a string)                                                                                                              
                             128:     *                                                                                                                                                                          
                             129:     * @param string byte array to read                                                                                                                                         
                             130:     * @param offset offset to read byte array                                                                                                                                  
                             131:     * @param len    length to read byte array                                                                                                                                  
                             132:     * @return String generated String instance by reading byte array (ISO-8859-1)                                                                                              
                             133:     */                                                                                                                                                                         
                             134:    public static String getFromCompressedUnicode(                                                                                                                              
                             135:            final byte[] string,                                                                                                                                                
                             136:            final int offset,                                                                                                                                                   
                             137:            final int len) {                                                                                                                                                    
                             138:        int len_to_use = Math.min(len, string.length - offset);                                                                                                                 
                             139:        return new String(string, offset, len_to_use, ISO_8859_1);                                                                                                              
                             140:    }                                                                                                                                                                           
                             141:                                                                                                                                                                                
                             142:    /**                                                                                                                                                                         
                             143:     * Read 8 bit data (in UTF-8 codepage) into a (unicode) Java                                                                                                                
                             144:     * String and return.                                                                                                                                                       
                             145:     * (In Excel terms, read compressed 8 bit unicode as a string)                                                                                                              
                             146:     *                                                                                                                                                                          
                             147:     * @param string byte array to read                                                                                                                                         
                             148:     * @param offset offset to read byte array                                                                                                                                  
                             149:     * @param len    length to read byte array                                                                                                                                  
                             150:     * @return String generated String instance by reading byte array (UTF-8)                                                                                                   
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java:1-200                                                                                                 
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef.attribute;                                                                                                                                           
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:import java.util.ArrayList;                                                                                                                                                      
                             23:import java.util.Arrays;                                                                                                                                                         
                             24:import java.util.List;                                                                                                                                                           
                             25:                                                                                                                                                                                 
                             26:import org.apache.commons.io.input.UnsynchronizedByteArrayInputStream;                                                                                                           
                             27:import org.apache.poi.hmef.Attachment;                                                                                                                                           
                             28:import org.apache.poi.hmef.HMEFMessage;                                                                                                                                          
                             29:import org.apache.poi.hsmf.datatypes.MAPIProperty;                                                                                                                               
                             30:import org.apache.poi.hsmf.datatypes.Types;                                                                                                                                      
                             31:import org.apache.poi.hsmf.datatypes.Types.MAPIType;                                                                                                                             
                             32:import org.apache.poi.util.HexDump;                                                                                                                                              
                             33:import org.apache.poi.util.IOUtils;                                                                                                                                              
                             34:import org.apache.poi.util.LittleEndian;                                                                                                                                         
                             35:import org.apache.poi.util.StringUtil;                                                                                                                                           
                             36:                                                                                                                                                                                 
                             37:/**                                                                                                                                                                              
                             38: * A pure-MAPI attribute which applies to a {@link HMEFMessage}                                                                                                                  
                             39: *  or one of its {@link Attachment}s.                                                                                                                                           
                             40: */                                                                                                                                                                              
                             41:public class MAPIAttribute {                                                                                                                                                     
                             42:                                                                                                                                                                                 
                             43:   //arbitrarily selected; may need to increase                                                                                                                                  
                             44:   private static final int DEFAULT_MAX_RECORD_LENGTH = 1_000_000;                                                                                                               
                             45:   private static int MAX_RECORD_LENGTH = 1_000_000;                                                                                                                             
                             46:   private static int MAX_RECORD_COUNT = 10_000;                                                                                                                                 
                             47:                                                                                                                                                                                 
                             48:   private final MAPIProperty property;                                                                                                                                          
                             49:   private final int type;                                                                                                                                                       
                             50:   private final byte[] data;                                                                                                                                                    
                             51:                                                                                                                                                                                 
                             52:   /**                                                                                                                                                                           
                             53:    * @param length the max record length allowed for MAPIAttribute                                                                                                              
                             54:    */                                                                                                                                                                           
                             55:   public static void setMaxRecordLength(int length) {                                                                                                                           
                             56:      MAX_RECORD_LENGTH = length;                                                                                                                                                
                             57:   }                                                                                                                                                                             
                             58:                                                                                                                                                                                 
                             59:   /**                                                                                                                                                                           
                             60:    * @return the max record length allowed for MAPIAttribute                                                                                                                    
                             61:    */                                                                                                                                                                           
                             62:   public static int getMaxRecordLength() {                                                                                                                                      
                             63:      return MAX_RECORD_LENGTH;                                                                                                                                                  
                             64:   }                                                                                                                                                                             
                             65:                                                                                                                                                                                 
                             66:   /**                                                                                                                                                                           
                             67:    * Constructs a single new attribute from                                                                                                                                     
                             68:    *  the contents of the stream                                                                                                                                                
                             69:    */                                                                                                                                                                           
                             70:   public MAPIAttribute(MAPIProperty property, int type, byte[] data) {                                                                                                          
                             71:      this.property = property;                                                                                                                                                  
                             72:      this.type = type;                                                                                                                                                          
                             73:      this.data = data.clone();                                                                                                                                                  
                             74:   }                                                                                                                                                                             
                             75:                                                                                                                                                                                 
                             76:   public MAPIProperty getProperty() {                                                                                                                                           
                             77:      return property;                                                                                                                                                           
                             78:   }                                                                                                                                                                             
                             79:                                                                                                                                                                                 
                             80:   public int getType() {                                                                                                                                                        
                             81:      return type;                                                                                                                                                               
                             82:   }                                                                                                                                                                             
                             83:                                                                                                                                                                                 
                             84:   public byte[] getData() {                                                                                                                                                     
                             85:      return data;                                                                                                                                                               
                             86:   }                                                                                                                                                                             
                             87:                                                                                                                                                                                 
                             88:   public String toString() {                                                                                                                                                    
                             89:      String hex;                                                                                                                                                                
                             90:      if(data.length <= 16) {                                                                                                                                                    
                             91:         hex = HexDump.toHex(data);                                                                                                                                              
                             92:      } else {                                                                                                                                                                   
                             93:         byte[] d = Arrays.copyOf(data, 16);                                                                                                                                     
                             94:         hex = HexDump.toHex(d);                                                                                                                                                 
                             95:         hex = hex.substring(0, hex.length()-1) + ", ....]";                                                                                                                     
                             96:      }                                                                                                                                                                          
                             97:                                                                                                                                                                                 
                             98:      return property + " " + hex;                                                                                                                                               
                             99:   }                                                                                                                                                                             
                             100:                                                                                                                                                                                
                             101:   /**                                                                                                                                                                          
                             102:    * Parses a MAPI Properties TNEF Attribute, and returns                                                                                                                      
                             103:    *  the list of MAPI Attributes contained within it                                                                                                                          
                             104:    */                                                                                                                                                                          
                             105:   public static List<MAPIAttribute> create(TNEFAttribute parent) throws IOException {                                                                                          
                             106:      if(parent.getProperty() == TNEFProperty.ID_MAPIPROPERTIES) {                                                                                                              
                             107:         // Regular MAPI Properties, normally on the message                                                                                                                    
                             108:      }                                                                                                                                                                         
                             109:      else if(parent.getProperty() == TNEFProperty.ID_ATTACHMENT) {                                                                                                             
                             110:         // MAPI Properties for an attachment                                                                                                                                   
                             111:      }                                                                                                                                                                         
                             112:      else {                                                                                                                                                                    
                             113:         // Something else, oh dear...                                                                                                                                          
                             114:         throw new IllegalArgumentException(                                                                                                                                    
                             115:               "Can only create from a MAPIProperty attribute, " +                                                                                                              
                             116:               "instead received a " + parent.getProperty() + " one"                                                                                                            
                             117:         );                                                                                                                                                                     
                             118:      }                                                                                                                                                                         
                             119:      try(UnsynchronizedByteArrayInputStream inp = UnsynchronizedByteArrayInputStream.builder().setByteArray(parent.getData()).get()) {                                         
                             120:         // First up, get the number of attributes                                                                                                                              
                             121:         int count = LittleEndian.readInt(inp);                                                                                                                                 
                             122:         List<MAPIAttribute> attrs = new ArrayList<>();                                                                                                                         
                             123:                                                                                                                                                                                
                             124:         // Now, read each one in in turn                                                                                                                                       
                             125:         for(int i=0; i<count; i++) {                                                                                                                                           
                             126:            int typeAndMV = LittleEndian.readUShort(inp);                                                                                                                       
                             127:            int id = LittleEndian.readUShort(inp);                                                                                                                              
                             128:                                                                                                                                                                                
                             129:            // Is it either Multi-Valued or Variable-Length?                                                                                                                    
                             130:            boolean isMV = false;                                                                                                                                               
                             131:            boolean isVL = false;                                                                                                                                               
                             132:            int typeId = typeAndMV;                                                                                                                                             
                             133:            if( (typeAndMV & Types.MULTIVALUED_FLAG) != 0 ) {                                                                                                                   
                             134:               isMV = true;                                                                                                                                                     
                             135:               typeId -= Types.MULTIVALUED_FLAG;                                                                                                                                
                             136:            }                                                                                                                                                                   
                             137:            if(typeId == Types.ASCII_STRING.getId() || typeId == Types.UNICODE_STRING.getId() ||                                                                                
                             138:                    typeId == Types.BINARY.getId() || typeId == Types.DIRECTORY.getId()) {                                                                                      
                             139:               isVL = true;                                                                                                                                                     
                             140:            }                                                                                                                                                                   
                             141:                                                                                                                                                                                
                             142:            // Turn the type ID into a strongly typed thing                                                                                                                     
                             143:            MAPIType type = Types.getById(typeId);                                                                                                                              
                             144:            if (type == null) {                                                                                                                                                 
                             145:               type = Types.createCustom(typeId);                                                                                                                               
                             146:            }                                                                                                                                                                   
                             147:                                                                                                                                                                                
                             148:            // If it's a named property, rather than a standard                                                                                                                 
                             149:            //  MAPI property, grab the details of it                                                                                                                           
                             150:            MAPIProperty prop = MAPIProperty.get(id);                                                                                                                           
                             151:            if(id >= 0x8000 && id <= 0xFFFF) {                                                                                                                                  
                             152:               byte[] guid = new byte[16];                                                                                                                                      
                             153:               if (IOUtils.readFully(inp, guid) < 0) {                                                                                                                          
                             154:                  throw new IOException("Not enough data to read guid");                                                                                                        
                             155:               }                                                                                                                                                                
                             156:               int mptype = LittleEndian.readInt(inp);                                                                                                                          
                             157:                                                                                                                                                                                
                             158:               // Get the name of it                                                                                                                                            
                             159:               String name;                                                                                                                                                     
                             160:               if(mptype == 0) {                                                                                                                                                
                             161:                  // It's based on a normal one                                                                                                                                 
                             162:                  int mpid = LittleEndian.readInt(inp);                                                                                                                         
                             163:                  MAPIProperty base = MAPIProperty.get(mpid);                                                                                                                   
                             164:                  name = base.name;                                                                                                                                             
                             165:               } else {                                                                                                                                                         
                             166:                  // Custom name was stored                                                                                                                                     
                             167:                  int mplen = LittleEndian.readInt(inp);                                                                                                                        
                             168:                  if (mplen < 0) {                                                                                                                                              
                             169:                     throw new IOException("Did not expect negative value: " + mplen);                                                                                          
                             170:                  }                                                                                                                                                             
                             171:                  byte[] mpdata = new byte[mplen];                                                                                                                              
                             172:                  if (IOUtils.readFully(inp, mpdata) < 0) {                                                                                                                     
                             173:                     throw new IOException("Not enough data to read " + mplen + " bytes for attribute name");                                                                   
                             174:                  }                                                                                                                                                             
                             175:                  name = StringUtil.getFromUnicodeLE(mpdata, 0, (mplen/2)-1);                                                                                                   
                             176:                  skipToBoundary(mplen, inp);                                                                                                                                   
                             177:               }                                                                                                                                                                
                             178:                                                                                                                                                                                
                             179:               // Now create                                                                                                                                                    
                             180:               prop = MAPIProperty.createCustom(id, type, name);                                                                                                                
                             181:            }                                                                                                                                                                   
                             182:            if(prop == MAPIProperty.UNKNOWN) {                                                                                                                                  
                             183:               prop = MAPIProperty.createCustom(id, type, "(unknown " + Integer.toHexString(id) + ")");                                                                         
                             184:            }                                                                                                                                                                   
                             185:                                                                                                                                                                                
                             186:            // Now read in the value(s)                                                                                                                                         
                             187:            int values = 1;                                                                                                                                                     
                             188:            if(isMV || isVL) {                                                                                                                                                  
                             189:               values = LittleEndian.readInt(inp);                                                                                                                              
                             190:            }                                                                                                                                                                   
                             191:                                                                                                                                                                                
                             192:            if (type == Types.NULL && values > 1) {                                                                                                                             
                             193:               throw new IOException("Placeholder/NULL arrays aren't supported.");                                                                                              
                             194:            }                                                                                                                                                                   
                             195:                                                                                                                                                                                
                             196:            for(int j=0; j<values; j++) {                                                                                                                                       
                             197:               int len = getLength(type, inp);                                                                                                                                  
                             198:               byte[] data = IOUtils.safelyAllocate(len, MAX_RECORD_LENGTH);                                                                                                    
                             199:               inp.read(data);                                                                                                                                                  
                             200:               skipToBoundary(len, inp);                                                                                                                                        
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFMAPIAttribute.java:1-52                                                                                              
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef.attribute;                                                                                                                                           
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:import java.util.List;                                                                                                                                                           
                             23:                                                                                                                                                                                 
                             24:import org.apache.poi.hmef.Attachment;                                                                                                                                           
                             25:import org.apache.poi.hmef.HMEFMessage;                                                                                                                                          
                             26:                                                                                                                                                                                 
                             27:/**                                                                                                                                                                              
                             28: * A TNEF Attribute holding MAPI Attributes, which applies to a                                                                                                                  
                             29: *  {@link HMEFMessage} or one of its {@link Attachment}s.                                                                                                                       
                             30: */                                                                                                                                                                              
                             31:public final class TNEFMAPIAttribute extends TNEFAttribute {                                                                                                                     
                             32:   private final List<MAPIAttribute> attributes;                                                                                                                                 
                             33:                                                                                                                                                                                 
                             34:   /**                                                                                                                                                                           
                             35:    * Constructs a single new mapi containing attribute from the                                                                                                                 
                             36:    *  id, type, and the contents of the stream                                                                                                                                  
                             37:    */                                                                                                                                                                           
                             38:   protected TNEFMAPIAttribute(int id, int type, InputStream inp) throws IOException {                                                                                           
                             39:      super(id, type, inp);                                                                                                                                                      
                             40:                                                                                                                                                                                 
                             41:      attributes = MAPIAttribute.create(this);                                                                                                                                   
                             42:   }                                                                                                                                                                             
                             43:                                                                                                                                                                                 
                             44:   public List<MAPIAttribute> getMAPIAttributes() {                                                                                                                              
                             45:      return attributes;                                                                                                                                                         
                             46:   }                                                                                                                                                                             
                             47:                                                                                                                                                                                 
                             48:   public String toString() {                                                                                                                                                    
                             49:      return "Attribute " + getProperty() + ", type=" + getType() +                                                                                                              
                             50:             ", " + attributes.size() + " MAPI Attributes";                                                                                                                      
                             51:   }                                                                                                                                                                             
                             52:}                                                                                                                                                                                
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFAttribute.java:1-114                                                                                                 
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef.attribute;                                                                                                                                           
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:                                                                                                                                                                                 
                             23:import org.apache.poi.hmef.Attachment;                                                                                                                                           
                             24:import org.apache.poi.hmef.HMEFMessage;                                                                                                                                          
                             25:import org.apache.poi.util.IOUtils;                                                                                                                                              
                             26:import org.apache.poi.util.LittleEndian;                                                                                                                                         
                             27:                                                                                                                                                                                 
                             28:                                                                                                                                                                                 
                             29:/**                                                                                                                                                                              
                             30: * An attribute which applies to a {@link HMEFMessage}                                                                                                                           
                             31: *  or one of its {@link Attachment}s.                                                                                                                                           
                             32: * Note - the types and IDs differ from standard Outlook/MAPI                                                                                                                    
                             33: *  ones, so we can't just re-use the HSMF ones.                                                                                                                                 
                             34: */                                                                                                                                                                              
                             35:public class TNEFAttribute {                                                                                                                                                     
                             36:                                                                                                                                                                                 
                             37:   //arbitrarily selected; may need to increase                                                                                                                                  
                             38:   private static final int DEFAULT_MAX_RECORD_LENGTH = 20_000_000;                                                                                                              
                             39:   private static int MAX_RECORD_LENGTH = DEFAULT_MAX_RECORD_LENGTH;                                                                                                             
                             40:                                                                                                                                                                                 
                             41:   private final TNEFProperty property;                                                                                                                                          
                             42:   private final int type;                                                                                                                                                       
                             43:   private final byte[] data;                                                                                                                                                    
                             44:   private final int checksum;                                                                                                                                                   
                             45:                                                                                                                                                                                 
                             46:   /**                                                                                                                                                                           
                             47:    * @param length the max record length allowed for TNEFAttribute                                                                                                              
                             48:    */                                                                                                                                                                           
                             49:   public static void setMaxRecordLength(int length) {                                                                                                                           
                             50:      MAX_RECORD_LENGTH = length;                                                                                                                                                
                             51:   }                                                                                                                                                                             
                             52:                                                                                                                                                                                 
                             53:   /**                                                                                                                                                                           
                             54:    * @return the max record length allowed for TNEFAttribute                                                                                                                    
                             55:    */                                                                                                                                                                           
                             56:   public static int getMaxRecordLength() {                                                                                                                                      
                             57:      return MAX_RECORD_LENGTH;                                                                                                                                                  
                             58:   }                                                                                                                                                                             
                             59:                                                                                                                                                                                 
                             60:   /**                                                                                                                                                                           
                             61:    * Constructs a single new attribute from the id, type,                                                                                                                       
                             62:    *  and the contents of the stream                                                                                                                                            
                             63:    */                                                                                                                                                                           
                             64:   protected TNEFAttribute(int id, int type, InputStream inp) throws IOException {                                                                                               
                             65:      this.type = type;                                                                                                                                                          
                             66:      int length = LittleEndian.readInt(inp);                                                                                                                                    
                             67:                                                                                                                                                                                 
                             68:      property = TNEFProperty.getBest(id, type);                                                                                                                                 
                             69:      data = IOUtils.safelyAllocate(length, MAX_RECORD_LENGTH);                                                                                                                  
                             70:      IOUtils.readFully(inp, data);                                                                                                                                              
                             71:                                                                                                                                                                                 
                             72:      checksum = LittleEndian.readUShort(inp);                                                                                                                                   
                             73:   }                                                                                                                                                                             
                             74:                                                                                                                                                                                 
                             75:   /**                                                                                                                                                                           
                             76:    * Creates a new TNEF Attribute by reading data from                                                                                                                          
                             77:    *  the stream within a {@link HMEFMessage}                                                                                                                                   
                             78:    */                                                                                                                                                                           
                             79:   public static TNEFAttribute create(InputStream inp) throws IOException {                                                                                                      
                             80:      int id   = LittleEndian.readUShort(inp);                                                                                                                                   
                             81:      int type = LittleEndian.readUShort(inp);                                                                                                                                   
                             82:                                                                                                                                                                                 
                             83:      // Create as appropriate                                                                                                                                                   
                             84:      if(id == TNEFProperty.ID_MAPIPROPERTIES.id ||                                                                                                                              
                             85:            id == TNEFProperty.ID_ATTACHMENT.id) {                                                                                                                               
                             86:         return new TNEFMAPIAttribute(id, type, inp);                                                                                                                            
                             87:      }                                                                                                                                                                          
                             88:      if(type == TNEFProperty.TYPE_STRING ||                                                                                                                                     
                             89:           type == TNEFProperty.TYPE_TEXT) {                                                                                                                                     
                             90:         return new TNEFStringAttribute(id, type, inp);                                                                                                                          
                             91:      }                                                                                                                                                                          
                             92:      if(type == TNEFProperty.TYPE_DATE) {                                                                                                                                       
                             93:         return new TNEFDateAttribute(id, type, inp);                                                                                                                            
                             94:      }                                                                                                                                                                          
                             95:      return new TNEFAttribute(id, type, inp);                                                                                                                                   
                             96:   }                                                                                                                                                                             
                             97:                                                                                                                                                                                 
                             98:   public TNEFProperty getProperty() {                                                                                                                                           
                             99:      return property;                                                                                                                                                           
                             100:   }                                                                                                                                                                            
                             101:                                                                                                                                                                                
                             102:   public int getType() {                                                                                                                                                       
                             103:      return type;                                                                                                                                                              
                             104:   }                                                                                                                                                                            
                             105:                                                                                                                                                                                
                             106:   public byte[] getData() {                                                                                                                                                    
                             107:      return data;                                                                                                                                                              
                             108:   }                                                                                                                                                                            
                             109:                                                                                                                                                                                
                             110:   public String toString() {                                                                                                                                                   
                             111:      return "Attribute " + property + ", type=" + type +                                                                                                                       
                             112:             ", data length=" + data.length;                                                                                                                                    
                             113:   }                                                                                                                                                                            
                             114:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/HMEFMessage.java:1-200                                                                                                             
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef;                                                                                                                                                     
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:import java.util.ArrayList;                                                                                                                                                      
                             23:import java.util.Collections;                                                                                                                                                    
                             24:import java.util.List;                                                                                                                                                           
                             25:                                                                                                                                                                                 
                             26:import org.apache.poi.hmef.attribute.MAPIAttribute;                                                                                                                              
                             27:import org.apache.poi.hmef.attribute.MAPIStringAttribute;                                                                                                                        
                             28:import org.apache.poi.hmef.attribute.TNEFAttribute;                                                                                                                              
                             29:import org.apache.poi.hmef.attribute.TNEFMAPIAttribute;                                                                                                                          
                             30:import org.apache.poi.hmef.attribute.TNEFProperty;                                                                                                                               
                             31:import org.apache.poi.hsmf.datatypes.MAPIProperty;                                                                                                                               
                             32:import org.apache.poi.util.LittleEndian;                                                                                                                                         
                             33:                                                                                                                                                                                 
                             34:/**                                                                                                                                                                              
                             35: * HMEF - Implementation of the Microsoft TNEF message                                                                                                                           
                             36: *  encoding format (aka winmail.dat)                                                                                                                                            
                             37: * See:                                                                                                                                                                          
                             38: *   http://support.microsoft.com/kb/241538                                                                                                                                      
                             39: *   http://en.wikipedia.org/wiki/Transport_Neutral_Encapsulation_Format                                                                                                         
                             40: *   http://search.cpan.org/dist/Convert-TNEF/                                                                                                                                   
                             41: */                                                                                                                                                                              
                             42:public final class HMEFMessage {                                                                                                                                                 
                             43:    public static final int HEADER_SIGNATURE = 0x223e9f78;                                                                                                                       
                             44:                                                                                                                                                                                 
                             45:    @SuppressWarnings("unused")                                                                                                                                                  
                             46:    private int fileId;                                                                                                                                                          
                             47:    private final List<TNEFAttribute> messageAttributes = new ArrayList<>();                                                                                                     
                             48:    private final List<MAPIAttribute> mapiAttributes = new ArrayList<>();                                                                                                        
                             49:    private final List<Attachment> attachments = new ArrayList<>();                                                                                                              
                             50:                                                                                                                                                                                 
                             51:    /**                                                                                                                                                                          
                             52:     * @param inp input stream                                                                                                                                                   
                             53:     * @throws IOException If reading data from the stream fails                                                                                                                 
                             54:     * @throws IllegalStateException a number of runtime exceptions can be thrown, especially if there are problems with the                                                     
                             55:     * input format                                                                                                                                                              
                             56:     */                                                                                                                                                                          
                             57:    public HMEFMessage(InputStream inp) throws IOException {                                                                                                                     
                             58:        try {                                                                                                                                                                    
                             59:            // Check the signature matches                                                                                                                                       
                             60:            int sig = LittleEndian.readInt(inp);                                                                                                                                 
                             61:            if (sig != HEADER_SIGNATURE) {                                                                                                                                       
                             62:                throw new IllegalArgumentException(                                                                                                                              
                             63:                        "TNEF signature not detected in file, " +                                                                                                                
                             64:                        "expected " + HEADER_SIGNATURE + " but got " + sig                                                                                                       
                             65:                );                                                                                                                                                               
                             66:            }                                                                                                                                                                    
                             67:                                                                                                                                                                                 
                             68:            // Read the File ID                                                                                                                                                  
                             69:            fileId = LittleEndian.readUShort(inp);                                                                                                                               
                             70:                                                                                                                                                                                 
                             71:            // Now begin processing the contents                                                                                                                                 
                             72:            process(inp);                                                                                                                                                        
                             73:        } finally {                                                                                                                                                              
                             74:            inp.close();                                                                                                                                                         
                             75:        }                                                                                                                                                                        
                             76:    }                                                                                                                                                                            
                             77:                                                                                                                                                                                 
                             78:    private void process(InputStream inp) throws IOException {                                                                                                                   
                             79:       int level;                                                                                                                                                                
                             80:       do {                                                                                                                                                                      
                             81:           // Fetch the level                                                                                                                                                    
                             82:           level = inp.read();                                                                                                                                                   
                             83:                                                                                                                                                                                 
                             84:           // Decide what to attach it to, based on the levels and IDs                                                                                                           
                             85:           switch (level) {                                                                                                                                                      
                             86:               case TNEFProperty.LEVEL_MESSAGE:                                                                                                                                  
                             87:                   processMessage(inp);                                                                                                                                          
                             88:                   break;                                                                                                                                                        
                             89:                case TNEFProperty.LEVEL_ATTACHMENT:                                                                                                                              
                             90:                   processAttachment(inp);                                                                                                                                       
                             91:                   break;                                                                                                                                                        
                             92:               // ignore trailing newline                                                                                                                                        
                             93:                case '\r':                                                                                                                                                       
                             94:                case '\n':                                                                                                                                                       
                             95:                case TNEFProperty.LEVEL_END_OF_FILE:                                                                                                                             
                             96:                    break;                                                                                                                                                       
                             97:                default:                                                                                                                                                         
                             98:                    throw new IllegalStateException("Unhandled level " + level);                                                                                                 
                             99:            }                                                                                                                                                                    
                             100:        } while (level != TNEFProperty.LEVEL_END_OF_FILE);                                                                                                                      
                             101:    }                                                                                                                                                                           
                             102:                                                                                                                                                                                
                             103:    void processMessage(InputStream inp) throws IOException {                                                                                                                   
                             104:        // Build the attribute                                                                                                                                                  
                             105:        TNEFAttribute attr = TNEFAttribute.create(inp);                                                                                                                         
                             106:                                                                                                                                                                                
                             107:        messageAttributes.add(attr);                                                                                                                                            
                             108:                                                                                                                                                                                
                             109:        if (attr instanceof TNEFMAPIAttribute) {                                                                                                                                
                             110:            TNEFMAPIAttribute tnefMAPI = (TNEFMAPIAttribute) attr;                                                                                                              
                             111:            mapiAttributes.addAll(tnefMAPI.getMAPIAttributes());                                                                                                                
                             112:        }                                                                                                                                                                       
                             113:    }                                                                                                                                                                           
                             114:                                                                                                                                                                                
                             115:    void processAttachment(InputStream inp) throws IOException {                                                                                                                
                             116:        // Build the attribute                                                                                                                                                  
                             117:        TNEFAttribute attr = TNEFAttribute.create(inp);                                                                                                                         
                             118:                                                                                                                                                                                
                             119:        // Previous attachment or a new one?                                                                                                                                    
                             120:        if (attachments.isEmpty()                                                                                                                                               
                             121:                || attr.getProperty() == TNEFProperty.ID_ATTACHRENDERDATA) {                                                                                                    
                             122:            attachments.add(new Attachment());                                                                                                                                  
                             123:        }                                                                                                                                                                       
                             124:                                                                                                                                                                                
                             125:        // Save the attribute for it                                                                                                                                            
                             126:        Attachment attach = attachments.get(attachments.size() - 1);                                                                                                            
                             127:        attach.addAttribute(attr);                                                                                                                                              
                             128:    }                                                                                                                                                                           
                             129:                                                                                                                                                                                
                             130:    /**                                                                                                                                                                         
                             131:     * Returns all HMEF/TNEF attributes of the message.                                                                                                                         
                             132:     * Note - In a typical message, most of the interesting properties                                                                                                          
                             133:     *  are stored as {@link MAPIAttribute}s - see {@link #getMessageMAPIAttributes()}                                                                                          
                             134:     */                                                                                                                                                                         
                             135:    public List<TNEFAttribute> getMessageAttributes() {                                                                                                                         
                             136:        return Collections.unmodifiableList(messageAttributes);                                                                                                                 
                             137:    }                                                                                                                                                                           
                             138:                                                                                                                                                                                
                             139:    /**                                                                                                                                                                         
                             140:     * Returns all MAPI attributes of the message.                                                                                                                              
                             141:     * Note - A small number of HMEF/TNEF specific attributes normally                                                                                                          
                             142:     *  apply to most messages, see {@link #getMessageAttributes()}                                                                                                             
                             143:     */                                                                                                                                                                         
                             144:    public List<MAPIAttribute> getMessageMAPIAttributes() {                                                                                                                     
                             145:        return Collections.unmodifiableList(mapiAttributes);                                                                                                                    
                             146:    }                                                                                                                                                                           
                             147:                                                                                                                                                                                
                             148:    /**                                                                                                                                                                         
                             149:     * Returns all the Attachments of the message.                                                                                                                              
                             150:     */                                                                                                                                                                         
                             151:    public List<Attachment> getAttachments() {                                                                                                                                  
                             152:        return Collections.unmodifiableList(attachments);                                                                                                                       
                             153:    }                                                                                                                                                                           
                             154:                                                                                                                                                                                
                             155:    /**                                                                                                                                                                         
                             156:     * Return the message attribute with the given ID,                                                                                                                          
                             157:     *  or null if there isn't one.                                                                                                                                             
                             158:     */                                                                                                                                                                         
                             159:    public TNEFAttribute getMessageAttribute(TNEFProperty id) {                                                                                                                 
                             160:        for (TNEFAttribute attr : messageAttributes) {                                                                                                                          
                             161:            if (attr.getProperty() == id) {                                                                                                                                     
                             162:                return attr;                                                                                                                                                    
                             163:            }                                                                                                                                                                   
                             164:        }                                                                                                                                                                       
                             165:        return null;                                                                                                                                                            
                             166:    }                                                                                                                                                                           
                             167:                                                                                                                                                                                
                             168:    /**                                                                                                                                                                         
                             169:     * Return the message MAPI Attribute with the given ID,                                                                                                                     
                             170:     *  or null if there isn't one.                                                                                                                                             
                             171:     */                                                                                                                                                                         
                             172:    public MAPIAttribute getMessageMAPIAttribute(MAPIProperty id) {                                                                                                             
                             173:        for (MAPIAttribute attr : mapiAttributes) {                                                                                                                             
                             174:            // Because of custom properties, match on ID not literal property object                                                                                            
                             175:            if (attr.getProperty().id == id.id) {                                                                                                                               
                             176:                return attr;                                                                                                                                                    
                             177:            }                                                                                                                                                                   
                             178:        }                                                                                                                                                                       
                             179:        return null;                                                                                                                                                            
                             180:    }                                                                                                                                                                           
                             181:                                                                                                                                                                                
                             182:    /**                                                                                                                                                                         
                             183:     * Return the string value of the mapi property, or null                                                                                                                    
                             184:     *  if it isn't set                                                                                                                                                         
                             185:     */                                                                                                                                                                         
                             186:    private String getString(MAPIProperty id) {                                                                                                                                 
                             187:        return MAPIStringAttribute.getAsString( getMessageMAPIAttribute(id) );                                                                                                  
                             188:    }                                                                                                                                                                           
                             189:                                                                                                                                                                                
                             190:    /**                                                                                                                                                                         
                             191:     * Returns the Message Subject, or null if the mapi property                                                                                                                
                             192:     *  for this isn't set                                                                                                                                                      
                             193:     */                                                                                                                                                                         
                             194:    public String getSubject() {                                                                                                                                                
                             195:        return getString(MAPIProperty.CONVERSATION_TOPIC);                                                                                                                      
                             196:    }                                                                                                                                                                           
                             197:                                                                                                                                                                                
                             198:    /**                                                                                                                                                                         
                             199:     * Returns the Message Body, as RTF, or null if the mapi property                                                                                                           
                             200:     *  for this isn't set                                                                                                                                                      
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java:100-160                                                                                               
                             ```                                                                                                                                                                                 
                             100:                                                                                                                                                                                
                             101:   /**                                                                                                                                                                          
                             102:    * Parses a MAPI Properties TNEF Attribute, and returns                                                                                                                      
                             103:    *  the list of MAPI Attributes contained within it                                                                                                                          
                             104:    */                                                                                                                                                                          
                             105:   public static List<MAPIAttribute> create(TNEFAttribute parent) throws IOException {                                                                                          
                             106:      if(parent.getProperty() == TNEFProperty.ID_MAPIPROPERTIES) {                                                                                                              
                             107:         // Regular MAPI Properties, normally on the message                                                                                                                    
                             108:      }                                                                                                                                                                         
                             109:      else if(parent.getProperty() == TNEFProperty.ID_ATTACHMENT) {                                                                                                             
                             110:         // MAPI Properties for an attachment                                                                                                                                   
                             111:      }                                                                                                                                                                         
                             112:      else {                                                                                                                                                                    
                             113:         // Something else, oh dear...                                                                                                                                          
                             114:         throw new IllegalArgumentException(                                                                                                                                    
                             115:               "Can only create from a MAPIProperty attribute, " +                                                                                                              
                             116:               "instead received a " + parent.getProperty() + " one"                                                                                                            
                             117:         );                                                                                                                                                                     
                             118:      }                                                                                                                                                                         
                             119:      try(UnsynchronizedByteArrayInputStream inp = UnsynchronizedByteArrayInputStream.builder().setByteArray(parent.getData()).get()) {                                         
                             120:         // First up, get the number of attributes                                                                                                                              
                             121:         int count = LittleEndian.readInt(inp);                                                                                                                                 
                             122:         List<MAPIAttribute> attrs = new ArrayList<>();                                                                                                                         
                             123:                                                                                                                                                                                
                             124:         // Now, read each one in in turn                                                                                                                                       
                             125:         for(int i=0; i<count; i++) {                                                                                                                                           
                             126:            int typeAndMV = LittleEndian.readUShort(inp);                                                                                                                       
                             127:            int id = LittleEndian.readUShort(inp);                                                                                                                              
                             128:                                                                                                                                                                                
                             129:            // Is it either Multi-Valued or Variable-Length?                                                                                                                    
                             130:            boolean isMV = false;                                                                                                                                               
                             131:            boolean isVL = false;                                                                                                                                               
                             132:            int typeId = typeAndMV;                                                                                                                                             
                             133:            if( (typeAndMV & Types.MULTIVALUED_FLAG) != 0 ) {                                                                                                                   
                             134:               isMV = true;                                                                                                                                                     
                             135:               typeId -= Types.MULTIVALUED_FLAG;                                                                                                                                
                             136:            }                                                                                                                                                                   
                             137:            if(typeId == Types.ASCII_STRING.getId() || typeId == Types.UNICODE_STRING.getId() ||                                                                                
                             138:                    typeId == Types.BINARY.getId() || typeId == Types.DIRECTORY.getId()) {                                                                                      
                             139:               isVL = true;                                                                                                                                                     
                             140:            }                                                                                                                                                                   
                             141:                                                                                                                                                                                
                             142:            // Turn the type ID into a strongly typed thing                                                                                                                     
                             143:            MAPIType type = Types.getById(typeId);                                                                                                                              
                             144:            if (type == null) {                                                                                                                                                 
                             145:               type = Types.createCustom(typeId);                                                                                                                               
                             146:            }                                                                                                                                                                   
                             147:                                                                                                                                                                                
                             148:            // If it's a named property, rather than a standard                                                                                                                 
                             149:            //  MAPI property, grab the details of it                                                                                                                           
                             150:            MAPIProperty prop = MAPIProperty.get(id);                                                                                                                           
                             151:            if(id >= 0x8000 && id <= 0xFFFF) {                                                                                                                                  
                             152:               byte[] guid = new byte[16];                                                                                                                                      
                             153:               if (IOUtils.readFully(inp, guid) < 0) {                                                                                                                          
                             154:                  throw new IOException("Not enough data to read guid");                                                                                                        
                             155:               }                                                                                                                                                                
                             156:               int mptype = LittleEndian.readInt(inp);                                                                                                                          
                             157:                                                                                                                                                                                
                             158:               // Get the name of it                                                                                                                                            
                             159:               String name;                                                                                                                                                     
                             160:               if(mptype == 0) {                                                                                                                                                
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFAttribute.java:80-114                                                                                                
                             ```                                                                                                                                                                                 
                             80:      int id   = LittleEndian.readUShort(inp);                                                                                                                                   
                             81:      int type = LittleEndian.readUShort(inp);                                                                                                                                   
                             82:                                                                                                                                                                                 
                             83:      // Create as appropriate                                                                                                                                                   
                             84:      if(id == TNEFProperty.ID_MAPIPROPERTIES.id ||                                                                                                                              
                             85:            id == TNEFProperty.ID_ATTACHMENT.id) {                                                                                                                               
                             86:         return new TNEFMAPIAttribute(id, type, inp);                                                                                                                            
                             87:      }                                                                                                                                                                          
                             88:      if(type == TNEFProperty.TYPE_STRING ||                                                                                                                                     
                             89:           type == TNEFProperty.TYPE_TEXT) {                                                                                                                                     
                             90:         return new TNEFStringAttribute(id, type, inp);                                                                                                                          
                             91:      }                                                                                                                                                                          
                             92:      if(type == TNEFProperty.TYPE_DATE) {                                                                                                                                       
                             93:         return new TNEFDateAttribute(id, type, inp);                                                                                                                            
                             94:      }                                                                                                                                                                          
                             95:      return new TNEFAttribute(id, type, inp);                                                                                                                                   
                             96:   }                                                                                                                                                                             
                             97:                                                                                                                                                                                 
                             98:   public TNEFProperty getProperty() {                                                                                                                                           
                             99:      return property;                                                                                                                                                           
                             100:   }                                                                                                                                                                            
                             101:                                                                                                                                                                                
                             102:   public int getType() {                                                                                                                                                       
                             103:      return type;                                                                                                                                                              
                             104:   }                                                                                                                                                                            
                             105:                                                                                                                                                                                
                             106:   public byte[] getData() {                                                                                                                                                    
                             107:      return data;                                                                                                                                                              
                             108:   }                                                                                                                                                                            
                             109:                                                                                                                                                                                
                             110:   public String toString() {                                                                                                                                                   
                             111:      return "Attribute " + property + ", type=" + type +                                                                                                                       
                             112:             ", data length=" + data.length;                                                                                                                                    
                             113:   }                                                                                                                                                                            
                             114:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFAttribute.java:1-74                                                                                                  
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef.attribute;                                                                                                                                           
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:                                                                                                                                                                                 
                             23:import org.apache.poi.hmef.Attachment;                                                                                                                                           
                             24:import org.apache.poi.hmef.HMEFMessage;                                                                                                                                          
                             25:import org.apache.poi.util.IOUtils;                                                                                                                                              
                             26:import org.apache.poi.util.LittleEndian;                                                                                                                                         
                             27:                                                                                                                                                                                 
                             28:                                                                                                                                                                                 
                             29:/**                                                                                                                                                                              
                             30: * An attribute which applies to a {@link HMEFMessage}                                                                                                                           
                             31: *  or one of its {@link Attachment}s.                                                                                                                                           
                             32: * Note - the types and IDs differ from standard Outlook/MAPI                                                                                                                    
                             33: *  ones, so we can't just re-use the HSMF ones.                                                                                                                                 
                             34: */                                                                                                                                                                              
                             35:public class TNEFAttribute {                                                                                                                                                     
                             36:                                                                                                                                                                                 
                             37:   //arbitrarily selected; may need to increase                                                                                                                                  
                             38:   private static final int DEFAULT_MAX_RECORD_LENGTH = 20_000_000;                                                                                                              
                             39:   private static int MAX_RECORD_LENGTH = DEFAULT_MAX_RECORD_LENGTH;                                                                                                             
                             40:                                                                                                                                                                                 
                             41:   private final TNEFProperty property;                                                                                                                                          
                             42:   private final int type;                                                                                                                                                       
                             43:   private final byte[] data;                                                                                                                                                    
                             44:   private final int checksum;                                                                                                                                                   
                             45:                                                                                                                                                                                 
                             46:   /**                                                                                                                                                                           
                             47:    * @param length the max record length allowed for TNEFAttribute                                                                                                              
                             48:    */                                                                                                                                                                           
                             49:   public static void setMaxRecordLength(int length) {                                                                                                                           
                             50:      MAX_RECORD_LENGTH = length;                                                                                                                                                
                             51:   }                                                                                                                                                                             
                             52:                                                                                                                                                                                 
                             53:   /**                                                                                                                                                                           
                             54:    * @return the max record length allowed for TNEFAttribute                                                                                                                    
                             55:    */                                                                                                                                                                           
                             56:   public static int getMaxRecordLength() {                                                                                                                                      
                             57:      return MAX_RECORD_LENGTH;                                                                                                                                                  
                             58:   }                                                                                                                                                                             
                             59:                                                                                                                                                                                 
                             60:   /**                                                                                                                                                                           
                             61:    * Constructs a single new attribute from the id, type,                                                                                                                       
                             62:    *  and the contents of the stream                                                                                                                                            
                             63:    */                                                                                                                                                                           
                             64:   protected TNEFAttribute(int id, int type, InputStream inp) throws IOException {                                                                                               
                             65:      this.type = type;                                                                                                                                                          
                             66:      int length = LittleEndian.readInt(inp);                                                                                                                                    
                             67:                                                                                                                                                                                 
                             68:      property = TNEFProperty.getBest(id, type);                                                                                                                                 
                             69:      data = IOUtils.safelyAllocate(length, MAX_RECORD_LENGTH);                                                                                                                  
                             70:      IOUtils.readFully(inp, data);                                                                                                                                              
                             71:                                                                                                                                                                                 
                             72:      checksum = LittleEndian.readUShort(inp);                                                                                                                                   
                             73:   }                                                                                                                                                                             
                             74:                                                                                                                                                                                 
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFAttribute.java:1-114                                                                                                 
                             ```                                                                                                                                                                                 
                             1:/* ====================================================================                                                                                                           
                             2:   Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3:   contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4:   this work for additional information regarding copyright ownership.                                                                                                            
                             5:   The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6:   (the "License"); you may not use this file except in compliance with                                                                                                           
                             7:   the License.  You may obtain a copy of the License at                                                                                                                          
                             8:                                                                                                                                                                                  
                             9:       http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                 
                             10:                                                                                                                                                                                 
                             11:   Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12:   distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13:   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14:   See the License for the specific language governing permissions and                                                                                                           
                             15:   limitations under the License.                                                                                                                                                
                             16:==================================================================== */                                                                                                          
                             17:                                                                                                                                                                                 
                             18:package org.apache.poi.hmef.attribute;                                                                                                                                           
                             19:                                                                                                                                                                                 
                             20:import java.io.IOException;                                                                                                                                                      
                             21:import java.io.InputStream;                                                                                                                                                      
                             22:                                                                                                                                                                                 
                             23:import org.apache.poi.hmef.Attachment;                                                                                                                                           
                             24:import org.apache.poi.hmef.HMEFMessage;                                                                                                                                          
                             25:import org.apache.poi.util.IOUtils;                                                                                                                                              
                             26:import org.apache.poi.util.LittleEndian;                                                                                                                                         
                             27:                                                                                                                                                                                 
                             28:                                                                                                                                                                                 
                             29:/**                                                                                                                                                                              
                             30: * An attribute which applies to a {@link HMEFMessage}                                                                                                                           
                             31: *  or one of its {@link Attachment}s.                                                                                                                                           
                             32: * Note - the types and IDs differ from standard Outlook/MAPI                                                                                                                    
                             33: *  ones, so we can't just re-use the HSMF ones.                                                                                                                                 
                             34: */                                                                                                                                                                              
                             35:public class TNEFAttribute {                                                                                                                                                     
                             36:                                                                                                                                                                                 
                             37:   //arbitrarily selected; may need to increase                                                                                                                                  
                             38:   private static final int DEFAULT_MAX_RECORD_LENGTH = 20_000_000;                                                                                                              
                             39:   private static int MAX_RECORD_LENGTH = DEFAULT_MAX_RECORD_LENGTH;                                                                                                             
                             40:                                                                                                                                                                                 
                             41:   private final TNEFProperty property;                                                                                                                                          
                             42:   private final int type;                                                                                                                                                       
                             43:   private final byte[] data;                                                                                                                                                    
                             44:   private final int checksum;                                                                                                                                                   
                             45:                                                                                                                                                                                 
                             46:   /**                                                                                                                                                                           
                             47:    * @param length the max record length allowed for TNEFAttribute                                                                                                              
                             48:    */                                                                                                                                                                           
                             49:   public static void setMaxRecordLength(int length) {                                                                                                                           
                             50:      MAX_RECORD_LENGTH = length;                                                                                                                                                
                             51:   }                                                                                                                                                                             
                             52:                                                                                                                                                                                 
                             53:   /**                                                                                                                                                                           
                             54:    * @return the max record length allowed for TNEFAttribute                                                                                                                    
                             55:    */                                                                                                                                                                           
                             56:   public static int getMaxRecordLength() {                                                                                                                                      
                             57:      return MAX_RECORD_LENGTH;                                                                                                                                                  
                             58:   }                                                                                                                                                                             
                             59:                                                                                                                                                                                 
                             60:   /**                                                                                                                                                                           
                             61:    * Constructs a single new attribute from the id, type,                                                                                                                       
                             62:    *  and the contents of the stream                                                                                                                                            
                             63:    */                                                                                                                                                                           
                             64:   protected TNEFAttribute(int id, int type, InputStream inp) throws IOException {                                                                                               
                             65:      this.type = type;                                                                                                                                                          
                             66:      int length = LittleEndian.readInt(inp);                                                                                                                                    
                             67:                                                                                                                                                                                 
                             68:      property = TNEFProperty.getBest(id, type);                                                                                                                                 
                             69:      data = IOUtils.safelyAllocate(length, MAX_RECORD_LENGTH);                                                                                                                  
                             70:      IOUtils.readFully(inp, data);                                                                                                                                              
                             71:                                                                                                                                                                                 
                             72:      checksum = LittleEndian.readUShort(inp);                                                                                                                                   
                             73:   }                                                                                                                                                                             
                             74:                                                                                                                                                                                 
                             75:   /**                                                                                                                                                                           
                             76:    * Creates a new TNEF Attribute by reading data from                                                                                                                          
                             77:    *  the stream within a {@link HMEFMessage}                                                                                                                                   
                             78:    */                                                                                                                                                                           
                             79:   public static TNEFAttribute create(InputStream inp) throws IOException {                                                                                                      
                             80:      int id   = LittleEndian.readUShort(inp);                                                                                                                                   
                             81:      int type = LittleEndian.readUShort(inp);                                                                                                                                   
                             82:                                                                                                                                                                                 
                             83:      // Create as appropriate                                                                                                                                                   
                             84:      if(id == TNEFProperty.ID_MAPIPROPERTIES.id ||                                                                                                                              
                             85:            id == TNEFProperty.ID_ATTACHMENT.id) {                                                                                                                               
                             86:         return new TNEFMAPIAttribute(id, type, inp);                                                                                                                            
                             87:      }                                                                                                                                                                          
                             88:      if(type == TNEFProperty.TYPE_STRING ||                                                                                                                                     
                             89:           type == TNEFProperty.TYPE_TEXT) {                                                                                                                                     
                             90:         return new TNEFStringAttribute(id, type, inp);                                                                                                                          
                             91:      }                                                                                                                                                                          
                             92:      if(type == TNEFProperty.TYPE_DATE) {                                                                                                                                       
                             93:         return new TNEFDateAttribute(id, type, inp);                                                                                                                            
                             94:      }                                                                                                                                                                          
                             95:      return new TNEFAttribute(id, type, inp);                                                                                                                                   
                             96:   }                                                                                                                                                                             
                             97:                                                                                                                                                                                 
                             98:   public TNEFProperty getProperty() {                                                                                                                                           
                             99:      return property;                                                                                                                                                           
                             100:   }                                                                                                                                                                            
                             101:                                                                                                                                                                                
                             102:   public int getType() {                                                                                                                                                       
                             103:      return type;                                                                                                                                                              
                             104:   }                                                                                                                                                                            
                             105:                                                                                                                                                                                
                             106:   public byte[] getData() {                                                                                                                                                    
                             107:      return data;                                                                                                                                                              
                             108:   }                                                                                                                                                                            
                             109:                                                                                                                                                                                
                             110:   public String toString() {                                                                                                                                                   
                             111:      return "Attribute " + property + ", type=" + type +                                                                                                                       
                             112:             ", data length=" + data.length;                                                                                                                                    
                             113:   }                                                                                                                                                                            
                             114:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi/src/main/java/org/apache/poi/util/StringUtil.java:79-95                                                                                                                         
                             ```                                                                                                                                                                                 
                             79:    public static String getFromUnicodeLE(                                                                                                                                       
                             80:            final byte[] string,                                                                                                                                                 
                             81:            final int offset,                                                                                                                                                    
                             82:            final int len)                                                                                                                                                       
                             83:            throws ArrayIndexOutOfBoundsException, IllegalArgumentException {                                                                                                    
                             84:        if (len == 0) {                                                                                                                                                          
                             85:            return "";                                                                                                                                                           
                             86:        }                                                                                                                                                                        
                             87:        if ((offset < 0) || (offset >= string.length)) {                                                                                                                         
                             88:            throw new ArrayIndexOutOfBoundsException("Illegal offset " + offset + " (String data is of length " + string.length + ")");                                          
                             89:        }                                                                                                                                                                        
                             90:        if ((len < 0) || (((string.length - offset) / 2) < len)) {                                                                                                               
                             91:            throw new IllegalArgumentException("Illegal length " + len);                                                                                                         
                             92:        }                                                                                                                                                                        
                             93:                                                                                                                                                                                 
                             94:        return new String(string, offset, len * 2, UTF16LE);                                                                                                                     
                             95:    }                                                                                                                                                                            
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi/src/main/java/org/apache/poi/util/StringUtil.java:134-140                                                                                                                       
                             ```                                                                                                                                                                                 
                             134:    public static String getFromCompressedUnicode(                                                                                                                              
                             135:            final byte[] string,                                                                                                                                                
                             136:            final int offset,                                                                                                                                                   
                             137:            final int len) {                                                                                                                                                    
                             138:        int len_to_use = Math.min(len, string.length - offset);                                                                                                                 
                             139:        return new String(string, offset, len_to_use, ISO_8859_1);                                                                                                              
                             140:    }                                                                                                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/TNEFAttribute.java:64-72                                                                                                 
                             ```                                                                                                                                                                                 
                             64:   protected TNEFAttribute(int id, int type, InputStream inp) throws IOException {                                                                                               
                             65:      this.type = type;                                                                                                                                                          
                             66:      int length = LittleEndian.readInt(inp);                                                                                                                                    
                             67:                                                                                                                                                                                 
                             68:      property = TNEFProperty.getBest(id, type);                                                                                                                                 
                             69:      data = IOUtils.safelyAllocate(length, MAX_RECORD_LENGTH);                                                                                                                  
                             70:      IOUtils.readFully(inp, data);                                                                                                                                              
                             71:                                                                                                                                                                                 
                             72:      checksum = LittleEndian.readUShort(inp);                                                                                                                                   
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java:196-200                                                                                               
                             ```                                                                                                                                                                                 
                             196:            for(int j=0; j<values; j++) {                                                                                                                                       
                             197:               int len = getLength(type, inp);                                                                                                                                  
                             198:               byte[] data = IOUtils.safelyAllocate(len, MAX_RECORD_LENGTH);                                                                                                    
                             199:               inp.read(data);                                                                                                                                                  
                             200:               skipToBoundary(len, inp);                                                                                                                                        
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             </code_snippets>                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Fix Strategy                                                                                                                                                                     
                             <fix_strategy>                                                                                                                                                                      
                                                                                                                                                                                                                 
                             1. Identify the unchecked string‐decoding path                                                                                                                                      
                                The fuzzer‐triggered heap exhaustion happens in StringUtil.getFromUnicodeLE(…), which blindly calls new String(byte[], offset, len*2, UTF16LE) as long as len                    
                             fits in the raw byte array. Although TNEFAttribute and MAPIAttribute both use IOUtils.safelyAllocate to cap raw byte‐array sizes, the downstream Unicode decoder                    
                             still allocates a Java char[] of size len without any further bounds check. Malicious or malformed length fields in TNEF/MAPI attributes can thus drive len into                    
                             the millions, exhausting the JVM heap.                                                                                                                                              
                                                                                                                                                                                                                 
                             2. Leverage StringUtil’s existing MAX_RECORD_LENGTH                                                                                                                                 
                                StringUtil already defines a configurable MAX_RECORD_LENGTH (default 10 000 000) and provides setters/getters. We must enforce this cap inside getFromUnicodeLE                  
                             so that any len exceeding MAX_RECORD_LENGTH is rejected (or truncated) before the heavy new String() allocation.                                                                    
                                                                                                                                                                                                                 
                             3. Patch StringUtil.getFromUnicodeLE                                                                                                                                                
                                In the three entry points:                                                                                                                                                       
                                a. public static String getFromUnicodeLE(byte[] string)                                                                                                                          
                                b. public static String getFromUnicodeLE(byte[] string, int offset, int len)                                                                                                     
                                Add a check immediately after validating offset and raw‐byte bounds:                                                                                                             
                                  if (len > MAX_RECORD_LENGTH) {                                                                                                                                                 
                                      throw new IllegalArgumentException(                                                                                                                                        
                                          "Requested Unicode string length " + len +                                                                                                                             
                                          " exceeds max record length " + MAX_RECORD_LENGTH);                                                                                                                    
                                  }                                                                                                                                                                              
                                This will prevent unbounded char‐array allocation and turn large len values into fast exceptions.                                                                                
                                                                                                                                                                                                                 
                             4. Preserve existing functionality                                                                                                                                                  
                                - Normal strings (len well under MAX_RECORD_LENGTH) continue to decode without additional overhead.                                                                              
                                - The public API for setting/retrieving MAX_RECORD_LENGTH remains available, so advanced users can tune the threshold if legitimate records demand longer                        
                             strings.                                                                                                                                                                            
                                - No changes are needed to TNEFAttribute, MAPIAttribute, or HMEFMessage: they will simply see an IllegalArgumentException bubbled out of getFromUnicodeLE when                   
                             encountering an over‐length string and handle it as a parsing error rather than OOM.                                                                                                
                                                                                                                                                                                                                 
                             5. Side‐effect analysis & mitigation                                                                                                                                                
                                - Existing callers may see IllegalArgumentException where they previously saw either valid strings or ArrayIndexOutOfBounds. Since getFromUnicodeLE already                      
                             declares IllegalArgumentException for bad lengths, this is a compatible extension.                                                                                                  
                                - Any code catching generic RuntimeExceptions may need to be audited, but most POI code does not catch RuntimeException from string utilities.                                   
                                - Unit tests for very large but valid Unicode strings (over 10 000 000 chars) may now fail; those should explicitly raise MAX_RECORD_LENGTH via                                  
                             StringUtil.setMaxRecordLength(…) in their setup.                                                                                                                                    
                                                                                                                                                                                                                 
                             6. No changes to fuzz harness or external libraries                                                                                                                                 
                                - All patches are confined to StringUtil.java.                                                                                                                                   
                                - Fuzz harness (POIHMEFFuzzer) and tests remain untouched, preserving test coverage and fuzzer entry paths.                                                                      
                                - No modifications to utility functions outside StringUtil or MAPI/TNEF parsing logic are required.                                                                              
                                                                                                                                                                                                                 
                             </fix_strategy>                                                                                                                                                                     
                             ===Tests Result===                                                                                                                                                                  
                             No tests found                                                                                                                                                                      
                             ===Evaluation End===                                                                                                                                                                
[10/27/25 19:25:22] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                                                      __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                                                       
                    INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmp_xg748bq                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/apache-poi_poi-full-01_vuln_1/agent-output-1761593122.1951907                                                                       
                             - Detection toml file: /tasks_new/apache-poi_poi-full-01/detection/apache-poi_poi-full-01_vuln_1.toml                                                                               
                             - Challenge project directory: /tasks_new/apache-poi_poi-full-01/official-afc-poi                                                                                                   
                                                                                                                                                                                                                 
