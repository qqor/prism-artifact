[10/27/25 20:38:35] INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmprvn4wj39                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/pdfbox_pdfbox-full-01_vuln_5/agent-output-1761597515.649206                                                                         
                             - Detection toml file: /tasks_new/pdfbox_pdfbox-full-01/detection/pdfbox_pdfbox-full-01_vuln_5.toml                                                                                 
                             - Challenge project directory: /tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox                                                                                                 
                                                                                                                                                                                                                 
                    INFO     [logging_performance](pdfbox Building Cached for CLEAN environment) Started...                                                                                 context_managers.py:9
[10/27/25 20:39:14] ERROR    Failed to build environment:                                                                                                                                         oss_fuzz.py:379
                    INFO     [logging_performance](pdfbox Building Cached for CLEAN environment) Took 39.14 seconds; exception=False                                                       context_managers.py:23
                    WARNING  Failed to run tests for Cached-CLEAN environment. Not running tests for this environment.                                                                            oss_fuzz.py:307
                    INFO     [logging_performance](pdfbox Building Clean for CLEAN environment) Started...                                                                                  context_managers.py:9
[10/27/25 20:40:29] INFO     [logging_performance](pdfbox Building Clean for CLEAN environment) Took 74.58 seconds; exception=False                                                        context_managers.py:23
                    WARNING  Failed to run tests for Clean-CLEAN environment. Not running tests for this environment.                                                                             oss_fuzz.py:307
                    INFO     Setting timeouts                                                                                                                                                       default.py:85
                               - build: 600 (original: 74)                                                                                                                                                       
                               - run tests: 600 (original: 0)                                                                                                                                                    
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:40:30] INFO     [logging_performance](pdfbox Setting owner) Took 0.83 seconds; exception=False                                                                                context_managers.py:23
[10/27/25 20:40:31] INFO     Successfully created Clean for CLEAN environment                                                                                                                     oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Clean']                                                                                                                             oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                                                 
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:40:32] INFO     [logging_performance](pdfbox Setting owner) Took 1.10 seconds; exception=False                                                                                context_managers.py:23
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:40:33] INFO     [logging_performance](pdfbox Setting owner) Took 0.91 seconds; exception=False                                                                                context_managers.py:23
[10/27/25 20:40:39] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                                                              
                             ===Evaluator Diff===                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd000.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbc800.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd000.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbc800.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                                                                                                                                                                                                                 
                             ===Analysis Report===                                                                                                                                                               
                                                                                                                                                                                                                 
                             ===Evaluation End===                                                                                                                                                                
[10/27/25 20:40:48] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                                                  __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/27/25 20:42:27] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                                                     __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/27/25 20:43:56] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:43:57] INFO     [logging_performance](pdfbox Setting owner) Took 0.94 seconds; exception=False                                                                                context_managers.py:23
                    INFO     [logging_performance](pdfbox Patching) Started...                                                                                                              context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmp208iz7ot                                                                                                                                 default.py:173
[10/27/25 20:45:09] INFO     [logging_performance](pdfbox Patching) Took 71.39 seconds; exception=False                                                                                    context_managers.py:23
                    INFO     [logging_performance](pdfbox Checking build) Started...                                                                                                        context_managers.py:9
[10/27/25 20:45:23] INFO     [logging_performance](pdfbox Checking build) Took 13.94 seconds; exception=False                                                                              context_managers.py:23
                    INFO     [logging_performance](pdfbox Running PoV) Started...                                                                                                           context_managers.py:9
[10/27/25 20:45:29] INFO     [logging_performance](pdfbox Running PoV) Took 6.17 seconds; exception=False                                                                                  context_managers.py:23
                    INFO     [logging_performance](pdfbox Testing) Started...                                                                                                               context_managers.py:9
                    INFO     [logging_performance](pdfbox Testing) Took 0.00 seconds; exception=False                                                                                      context_managers.py:23
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:45:30] INFO     [logging_performance](pdfbox Setting owner) Took 0.90 seconds; exception=False                                                                                context_managers.py:23
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:45:31] INFO     [logging_performance](pdfbox Setting owner) Took 0.86 seconds; exception=False                                                                                context_managers.py:23
[10/27/25 20:45:32] INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/27/25 20:45:33] INFO     [logging_performance](pdfbox Setting owner) Took 0.97 seconds; exception=False                                                                                context_managers.py:23
                    INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                                                   
                             ===Evaluator Diff===                                                                                                                                                                
                             --- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java                                                                                                                
                             +++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java                                                                                                                
                             @@ -503,6 +503,12 @@                                                                                                                                                                
                                  {                                                                                                                                                                              
                                      try                                                                                                                                                                        
                                      {                                                                                                                                                                          
                             +            // validate requested length to prevent malicious OOM                                                                                                                  
                             +            long remaining = buffer.remaining();                                                                                                                                   
                             +            if (length < 0 || length > remaining)                                                                                                                                  
                             +            {                                                                                                                                                                      
                             +                throw new IOException("Invalid charstring length: " + length);                                                                                                     
                             +            }                                                                                                                                                                      
                                          buffer.get(); // space                                                                                                                                                 
                                          byte[] data = new byte[length];                                                                                                                                        
                                          buffer.get(data);                                                                                                                                                      
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd000.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbc800.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                             # Evaluation Report                                                                                                                                                                 
                                                                                                                                                                                                                 
                             ## Summary                                                                                                                                                                          
                                                                                                                                                                                                                 
                             A fuzzing run of the PDF text-extraction path triggered a Java `OutOfMemoryError` within Apache FontBox while parsing a Type 1 font’s charstring data. The error                    
                             arises when the parser attempts to allocate an array larger than the JVM can handle, causing the fuzzer to report a low-severity security issue due to resource                     
                             exhaustion.                                                                                                                                                                         
                                                                                                                                                                                                                 
                             ## Description                                                                                                                                                                      
                                                                                                                                                                                                                 
                             - Issue:                                                                                                                                                                            
                               During fuzz testing of PDF text extraction, an input caused the Type 1 font lexer to request an excessively large array allocation, exceeding the VM’s maximum                    
                             allowable object size. This led to a `java.lang.OutOfMemoryError: Requested array size exceeds VM limit`, surfaced as a `FuzzerSecurityIssueLow` by Jazzer.                         
                                                                                                                                                                                                                 
                             - Vulnerability Type:                                                                                                                                                               
                               Resource exhaustion (out-of-memory) in font parsing logic.                                                                                                                        
                                                                                                                                                                                                                 
                             - Key Observations:                                                                                                                                                                 
                               • The exception originates in `org.apache.fontbox.type1.Type1Lexer.readCharString`, indicating the parser is reading or interpreting malformed/overly large                       
                             charstring data.                                                                                                                                                                    
                               • The error propagates through the Type 1 parser stack into PDFBox’s font-loading routines (`Type1Font.createWithPFB` → `PDType1Font` →                                           
                             `PDFontFactory.createFont`).                                                                                                                                                        
                               • The crash is reported by a fuzzer harness (`com.example.PDFExtractTextFuzzer.fuzzerTestOneInput`) that feeds inputs into PDFBox’s `PDFTextStripper`.                            
                               • Jazzer suggests reproducing with a heap maximum of 1710 MB (`-Xmx1710m`).                                                                                                       
                                                                                                                                                                                                                 
                             - Affected Code Areas for Investigation:                                                                                                                                            
                               • Type1Lexer.readCharString (allocation logic for charstring data)                                                                                                                
                               • Type1Parser.readToken/parseASCII (tokenization of ASCII-encoded font data)                                                                                                      
                               • Type1Font.createWithPFB (initial font instantiation from PFB streams)                                                                                                           
                               • PDType1Font and PDFontFactory (integration of parsed fonts into PD model)                                                                                                       
                               • PDFStreamEngine/PDFTextStripper (entry point for processing font resources during text extraction)                                                                              
                                                                                                                                                                                                                 
                             Examining these components end-to-end will provide a holistic view of how oversized charstring data is handled and where limits or checks may be insufficient.                      
                                                                                                                                                                                                                 
                             ## Initial Issue Log                                                                                                                                                                
                             Here is the initial issue log of the codebase:                                                                                                                                      
                             <issue>                                                                                                                                                                             
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd000.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbc800.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             </issue>                                                                                                                                                                            
                             ===Analysis Report===                                                                                                                                                               
                             # Analysis Report                                                                                                                                                                   
                                                                                                                                                                                                                 
                             ## Relevant Code Snippets                                                                                                                                                           
                             <code_snippets>                                                                                                                                                                     
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:1-120                                                                                                               
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *      http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:                                                                                                                                                                                 
                             18:package org.apache.fontbox.type1;                                                                                                                                                
                             19:                                                                                                                                                                                 
                             20:import org.apache.fontbox.encoding.BuiltInEncoding;                                                                                                                              
                             21:import org.apache.fontbox.encoding.StandardEncoding;                                                                                                                             
                             22:                                                                                                                                                                                 
                             23:import java.io.IOException;                                                                                                                                                      
                             24:import java.util.ArrayList;                                                                                                                                                      
                             25:import java.util.HashMap;                                                                                                                                                        
                             26:import java.util.List;                                                                                                                                                           
                             27:import java.util.Map;                                                                                                                                                            
                             28:                                                                                                                                                                                 
                             29:/**                                                                                                                                                                              
                             30: * Parses an Adobe Type 1 (.pfb) font. It is used exclusively by Type1Font.                                                                                                      
                             31: *                                                                                                                                                                               
                             32: * The Type 1 font format is a free-text format which is somewhat difficult                                                                                                      
                             33: * to parse. This is made worse by the fact that many Type 1 font files do                                                                                                       
                             34: * not conform to the specification, especially those embedded in PDFs. This                                                                                                     
                             35: * parser therefore tries to be as forgiving as possible.                                                                                                                        
                             36: *                                                                                                                                                                               
                             37: * @see "Adobe Type 1 Font Format, Adobe Systems (1999)"                                                                                                                         
                             38: *                                                                                                                                                                               
                             39: * @author John Hewson                                                                                                                                                           
                             40: */                                                                                                                                                                              
                             41:final class Type1Parser                                                                                                                                                          
                             42:{                                                                                                                                                                                
                             43:    // constants for encryption                                                                                                                                                  
                             44:    private static final int EEXEC_KEY = 55665;                                                                                                                                  
                             45:    private static final int CHARSTRING_KEY = 4330;                                                                                                                              
                             46:                                                                                                                                                                                 
                             47:    // state                                                                                                                                                                     
                             48:    private Type1Lexer lexer;                                                                                                                                                    
                             49:    private Type1Font font;                                                                                                                                                      
                             50:                                                                                                                                                                                 
                             51:    /**                                                                                                                                                                          
                             52:     * Parses a Type 1 font and returns a Type1Font class which represents it.                                                                                                   
                             53:     *                                                                                                                                                                           
                             54:     * @param segment1 Segment 1: ASCII                                                                                                                                          
                             55:     * @param segment2 Segment 2: Binary                                                                                                                                         
                             56:     * @throws IOException                                                                                                                                                       
                             57:     */                                                                                                                                                                          
                             58:    public Type1Font parse(byte[] segment1, byte[] segment2) throws IOException                                                                                                  
                             59:    {                                                                                                                                                                            
                             60:        font = new Type1Font(segment1, segment2);                                                                                                                                
                             61:        try                                                                                                                                                                      
                             62:        {                                                                                                                                                                        
                             63:            parseASCII(segment1);                                                                                                                                                
                             64:        }                                                                                                                                                                        
                             65:        catch (NumberFormatException ex)                                                                                                                                         
                             66:        {                                                                                                                                                                        
                             67:            throw new IOException(ex);                                                                                                                                           
                             68:        }                                                                                                                                                                        
                             69:        if (segment2.length > 0)                                                                                                                                                 
                             70:        {                                                                                                                                                                        
                             71:            parseBinary(segment2);                                                                                                                                               
                             72:        }                                                                                                                                                                        
                             73:        return font;                                                                                                                                                             
                             74:    }                                                                                                                                                                            
                             75:                                                                                                                                                                                 
                             76:    /**                                                                                                                                                                          
                             77:     * Parses the ASCII portion of a Type 1 font.                                                                                                                                
                             78:     */                                                                                                                                                                          
                             79:    private void parseASCII(byte[] bytes) throws IOException                                                                                                                     
                             80:    {                                                                                                                                                                            
                             81:        if (bytes.length == 0)                                                                                                                                                   
                             82:        {                                                                                                                                                                        
                             83:            throw new IOException("ASCII segment of type 1 font is empty");                                                                                                      
                             84:        }                                                                                                                                                                        
                             85:                                                                                                                                                                                 
                             86:        // %!FontType1-1.0                                                                                                                                                       
                             87:        // %!PS-AdobeFont-1.0                                                                                                                                                    
                             88:        if (bytes.length < 2 || (bytes[0] != '%' && bytes[1] != '!'))                                                                                                            
                             89:        {                                                                                                                                                                        
                             90:            throw new IOException("Invalid start of ASCII segment of type 1 font");                                                                                              
                             91:        }                                                                                                                                                                        
                             92:                                                                                                                                                                                 
                             93:        lexer = new Type1Lexer(bytes);                                                                                                                                           
                             94:                                                                                                                                                                                 
                             95:        // (corrupt?) synthetic font                                                                                                                                             
                             96:        if ("FontDirectory".equals(lexer.peekToken().getText()))                                                                                                                 
                             97:        {                                                                                                                                                                        
                             98:            read(Token.NAME, "FontDirectory");                                                                                                                                   
                             99:            read(Token.LITERAL); // font name                                                                                                                                    
                             100:            read(Token.NAME, "known");                                                                                                                                          
                             101:            read(Token.START_PROC);                                                                                                                                             
                             102:            readProcVoid();                                                                                                                                                     
                             103:            read(Token.START_PROC);                                                                                                                                             
                             104:            readProcVoid();                                                                                                                                                     
                             105:            read(Token.NAME, "ifelse");                                                                                                                                         
                             106:        }                                                                                                                                                                       
                             107:                                                                                                                                                                                
                             108:        // font dict                                                                                                                                                            
                             109:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             110:        read(Token.NAME, "dict");                                                                                                                                               
                             111:        // found in some TeX fonts                                                                                                                                              
                             112:        readMaybe(Token.NAME, "dup");                                                                                                                                           
                             113:        // if present, the "currentdict" is not required                                                                                                                        
                             114:        read(Token.NAME, "begin");                                                                                                                                              
                             115:                                                                                                                                                                                
                             116:        for (int i = 0; i < length; i++)                                                                                                                                        
                             117:        {                                                                                                                                                                       
                             118:            // premature end                                                                                                                                                    
                             119:            Token token = lexer.peekToken();                                                                                                                                    
                             120:            if (token == null)                                                                                                                                                  
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1CharStringReader.java:1-38                                                                                                      
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *      http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:                                                                                                                                                                                 
                             18:package org.apache.fontbox.type1;                                                                                                                                                
                             19:                                                                                                                                                                                 
                             20:import org.apache.fontbox.cff.Type1CharString;                                                                                                                                   
                             21:import java.io.IOException;                                                                                                                                                      
                             22:                                                                                                                                                                                 
                             23:/**                                                                                                                                                                              
                             24: * Something which can read Type 1 CharStrings, namely Type 1 and CFF fonts.                                                                                                     
                             25: *                                                                                                                                                                               
                             26: * @author John Hewson                                                                                                                                                           
                             27: */                                                                                                                                                                              
                             28:public interface Type1CharStringReader                                                                                                                                           
                             29:{                                                                                                                                                                                
                             30:    /**                                                                                                                                                                          
                             31:     * Returns the Type 1 CharString for the character with the given name.                                                                                                      
                             32:     *                                                                                                                                                                           
                             33:     * @param name the character name of the Type1 charstring                                                                                                                    
                             34:     * @return Type 1 CharString                                                                                                                                                 
                             35:     * @throws IOException if something went wrong                                                                                                                               
                             36:     */                                                                                                                                                                          
                             37:    Type1CharString getType1CharString(String name) throws IOException;                                                                                                          
                             38:}                                                                                                                                                                                
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/cff/Type1CharStringParser.java:1-200                                                                                                       
                             ```                                                                                                                                                                                 
                             1:/*                                                                                                                                                                                
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                                                             
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                                                          
                             4: * this work for additional information regarding copyright ownership.                                                                                                            
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                                                        
                             6: * (the "License"); you may not use this file except in compliance with                                                                                                           
                             7: * the License.  You may obtain a copy of the License at                                                                                                                          
                             8: *                                                                                                                                                                                
                             9: *      http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             10: *                                                                                                                                                                               
                             11: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             14: * See the License for the specific language governing permissions and                                                                                                           
                             15: * limitations under the License.                                                                                                                                                
                             16: */                                                                                                                                                                              
                             17:package org.apache.fontbox.cff;                                                                                                                                                  
                             18:                                                                                                                                                                                 
                             19:import java.io.IOException;                                                                                                                                                      
                             20:import java.util.ArrayDeque;                                                                                                                                                     
                             21:import java.util.ArrayList;                                                                                                                                                      
                             22:import java.util.Deque;                                                                                                                                                          
                             23:import java.util.List;                                                                                                                                                           
                             24:                                                                                                                                                                                 
                             25:import org.apache.logging.log4j.Logger;                                                                                                                                          
                             26:import org.apache.logging.log4j.LogManager;                                                                                                                                      
                             27:                                                                                                                                                                                 
                             28:import org.apache.fontbox.cff.CharStringCommand.Type1KeyWord;                                                                                                                    
                             29:                                                                                                                                                                                 
                             30:/**                                                                                                                                                                              
                             31: * This class represents a converter for a mapping into a Type 1 sequence.                                                                                                       
                             32: *                                                                                                                                                                               
                             33: * @see "Adobe Type 1 Font Format, Adobe Systems (1999)"                                                                                                                         
                             34: *                                                                                                                                                                               
                             35: * @author Villu Ruusmann                                                                                                                                                        
                             36: * @author John Hewson                                                                                                                                                           
                             37: */                                                                                                                                                                              
                             38:public class Type1CharStringParser                                                                                                                                               
                             39:{                                                                                                                                                                                
                             40:    private static final Logger LOG = LogManager.getLogger(Type1CharStringParser.class);                                                                                         
                             41:                                                                                                                                                                                 
                             42:    // 1-byte commands                                                                                                                                                           
                             43:    private static final int CALLSUBR = 10;                                                                                                                                      
                             44:                                                                                                                                                                                 
                             45:    // 2-byte commands                                                                                                                                                           
                             46:    private static final int TWO_BYTE = 12;                                                                                                                                      
                             47:    private static final int CALLOTHERSUBR = 16;                                                                                                                                 
                             48:    private static final int POP = 17;                                                                                                                                           
                             49:                                                                                                                                                                                 
                             50:    private final String fontName;                                                                                                                                               
                             51:    private String currentGlyph;                                                                                                                                                 
                             52:                                                                                                                                                                                 
                             53:    /**                                                                                                                                                                          
                             54:     * Constructs a new Type1CharStringParser object.                                                                                                                            
                             55:     *                                                                                                                                                                           
                             56:     * @param fontName font name                                                                                                                                                 
                             57:     */                                                                                                                                                                          
                             58:    public Type1CharStringParser(String fontName)                                                                                                                                
                             59:    {                                                                                                                                                                            
                             60:        this.fontName = fontName;                                                                                                                                                
                             61:    }                                                                                                                                                                            
                             62:                                                                                                                                                                                 
                             63:    /**                                                                                                                                                                          
                             64:     * The given byte array will be parsed and converted to a Type1 sequence.                                                                                                    
                             65:     *                                                                                                                                                                           
                             66:     * @param bytes the given mapping as byte array                                                                                                                              
                             67:     * @param subrs list of local subroutines                                                                                                                                    
                             68:     * @param glyphName name of the current glyph                                                                                                                                
                             69:     * @return the Type1 sequence                                                                                                                                                
                             70:     * @throws IOException if an error occurs during reading                                                                                                                     
                             71:     */                                                                                                                                                                          
                             72:    public List<Object> parse(byte[] bytes, List<byte[]> subrs, String glyphName) throws IOException                                                                             
                             73:    {                                                                                                                                                                            
                             74:        currentGlyph = glyphName;                                                                                                                                                
                             75:        return parse(bytes, subrs, new ArrayList<>());                                                                                                                           
                             76:    }                                                                                                                                                                            
                             77:                                                                                                                                                                                 
                             78:    private List<Object> parse(byte[] bytes, List<byte[]> subrs, List<Object> sequence)                                                                                          
                             79:            throws IOException                                                                                                                                                   
                             80:    {                                                                                                                                                                            
                             81:        DataInput input = new DataInputByteArray(bytes);                                                                                                                         
                             82:        while (input.hasRemaining())                                                                                                                                             
                             83:        {                                                                                                                                                                        
                             84:            int b0 = input.readUnsignedByte();                                                                                                                                   
                             85:            if (b0 == CALLSUBR)                                                                                                                                                  
                             86:            {                                                                                                                                                                    
                             87:                processCallSubr(subrs, sequence);                                                                                                                                
                             88:            }                                                                                                                                                                    
                             89:            else if (b0 == TWO_BYTE && input.peekUnsignedByte(0) == CALLOTHERSUBR)                                                                                               
                             90:            {                                                                                                                                                                    
                             91:                processCallOtherSubr(input, sequence);                                                                                                                           
                             92:            }                                                                                                                                                                    
                             93:            else if (b0 >= 0 && b0 <= 31)                                                                                                                                        
                             94:            {                                                                                                                                                                    
                             95:                sequence.add(readCommand(input, b0));                                                                                                                            
                             96:            }                                                                                                                                                                    
                             97:            else if (b0 >= 32 && b0 <= 255)                                                                                                                                      
                             98:            {                                                                                                                                                                    
                             99:                sequence.add(readNumber(input, b0));                                                                                                                             
                             100:            }                                                                                                                                                                   
                             101:            else                                                                                                                                                                
                             102:            {                                                                                                                                                                   
                             103:                throw new IllegalArgumentException();                                                                                                                           
                             104:            }                                                                                                                                                                   
                             105:        }                                                                                                                                                                       
                             106:        return sequence;                                                                                                                                                        
                             107:    }                                                                                                                                                                           
                             108:                                                                                                                                                                                
                             109:    private void processCallSubr(List<byte[]> subrs, List<Object> sequence) throws IOException                                                                                  
                             110:    {                                                                                                                                                                           
                             111:        // callsubr command                                                                                                                                                     
                             112:        Object obj = sequence.remove(sequence.size() - 1);                                                                                                                      
                             113:        if (!(obj instanceof Integer))                                                                                                                                          
                             114:        {                                                                                                                                                                       
                             115:            LOG.warn(                                                                                                                                                           
                             116:                    "Parameter {} for CALLSUBR is ignored, integer expected in glyph '{}' of font {}",                                                                          
                             117:                    obj, currentGlyph, fontName);                                                                                                                               
                             118:            return;                                                                                                                                                             
                             119:        }                                                                                                                                                                       
                             120:        int operand = (int) obj;                                                                                                                                                
                             121:                                                                                                                                                                                
                             122:        if (operand >= 0 && operand < subrs.size())                                                                                                                             
                             123:        {                                                                                                                                                                       
                             124:            byte[] subrBytes = subrs.get(operand);                                                                                                                              
                             125:            parse(subrBytes, subrs, sequence);                                                                                                                                  
                             126:            Object lastItem = sequence.get(sequence.size() - 1);                                                                                                                
                             127:            if (lastItem instanceof CharStringCommand                                                                                                                           
                             128:                    && Type1KeyWord.RET == ((CharStringCommand) lastItem).getType1KeyWord())                                                                                    
                             129:            {                                                                                                                                                                   
                             130:                sequence.remove(sequence.size() - 1); // remove "return" command                                                                                                
                             131:            }                                                                                                                                                                   
                             132:        }                                                                                                                                                                       
                             133:        else                                                                                                                                                                    
                             134:        {                                                                                                                                                                       
                             135:            LOG.warn("CALLSUBR is ignored, operand: {}, subrs.size(): {} in glyph '{}' of font {}",                                                                             
                             136:                    operand, subrs.size(), currentGlyph, fontName);                                                                                                             
                             137:            // remove all parameters (there can be more than one)                                                                                                               
                             138:            while (sequence.get(sequence.size() - 1) instanceof Integer)                                                                                                        
                             139:            {                                                                                                                                                                   
                             140:                sequence.remove(sequence.size() - 1);                                                                                                                           
                             141:            }                                                                                                                                                                   
                             142:        }                                                                                                                                                                       
                             143:    }                                                                                                                                                                           
                             144:                                                                                                                                                                                
                             145:    private void processCallOtherSubr(DataInput input, List<Object> sequence) throws IOException                                                                                
                             146:    {                                                                                                                                                                           
                             147:        // callothersubr command (needed in order to expand Subrs)                                                                                                              
                             148:        input.readByte();                                                                                                                                                       
                             149:                                                                                                                                                                                
                             150:        Integer othersubrNum = (Integer) sequence.remove(sequence.size() - 1);                                                                                                  
                             151:        Integer numArgs = (Integer) sequence.remove(sequence.size() - 1);                                                                                                       
                             152:                                                                                                                                                                                
                             153:        // othersubrs 0-3 have their own semantics                                                                                                                              
                             154:        Deque<Integer> results = new ArrayDeque<>();                                                                                                                            
                             155:        switch (othersubrNum)                                                                                                                                                   
                             156:        {                                                                                                                                                                       
                             157:        case 0:                                                                                                                                                                 
                             158:            results.push(removeInteger(sequence));                                                                                                                              
                             159:            results.push(removeInteger(sequence));                                                                                                                              
                             160:            sequence.remove(sequence.size() - 1);                                                                                                                               
                             161:            // end flex                                                                                                                                                         
                             162:            sequence.add(0);                                                                                                                                                    
                             163:            sequence.add(CharStringCommand.CALLOTHERSUBR);                                                                                                                      
                             164:            break;                                                                                                                                                              
                             165:        case 1:                                                                                                                                                                 
                             166:            // begin flex                                                                                                                                                       
                             167:            sequence.add(1);                                                                                                                                                    
                             168:            sequence.add(CharStringCommand.CALLOTHERSUBR);                                                                                                                      
                             169:            break;                                                                                                                                                              
                             170:        case 3:                                                                                                                                                                 
                             171:            // allows hint replacement                                                                                                                                          
                             172:            results.push(removeInteger(sequence));                                                                                                                              
                             173:            break;                                                                                                                                                              
                             174:        default:                                                                                                                                                                
                             175:            // all remaining othersubrs use this fallback mechanism                                                                                                             
                             176:            for (int i = 0; i < numArgs; i++)                                                                                                                                   
                             177:            {                                                                                                                                                                   
                             178:                results.push(removeInteger(sequence));                                                                                                                          
                             179:            }                                                                                                                                                                   
                             180:            break;                                                                                                                                                              
                             181:        }                                                                                                                                                                       
                             182:                                                                                                                                                                                
                             183:        // pop must follow immediately                                                                                                                                          
                             184:        while (input.peekUnsignedByte(0) == TWO_BYTE && input.peekUnsignedByte(1) == POP)                                                                                       
                             185:        {                                                                                                                                                                       
                             186:            input.readByte(); // B0_POP                                                                                                                                         
                             187:            input.readByte(); // B1_POP                                                                                                                                         
                             188:            sequence.add(results.pop());                                                                                                                                        
                             189:        }                                                                                                                                                                       
                             190:                                                                                                                                                                                
                             191:        if (!results.isEmpty())                                                                                                                                                 
                             192:        {                                                                                                                                                                       
                             193:            LOG.warn("Value left on the PostScript stack in glyph {} of font {}", currentGlyph,                                                                                 
                             194:                    fontName);                                                                                                                                                  
                             195:        }                                                                                                                                                                       
                             196:    }                                                                                                                                                                           
                             197:                                                                                                                                                                                
                             198:    // this method is a workaround for the fact that Type1CharStringParser assumes that subrs and                                                                               
                             199:    // othersubrs can be unrolled without executing the 'div' operator, which isn't true                                                                                        
                             200:    private static Integer removeInteger(List<Object> sequence) throws IOException                                                                                              
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:750-820                                                                                                             
                             ```                                                                                                                                                                                 
                             750:            throw new IOException("Missing start token of OtherSubrs procedure");                                                                                               
                             751:        }                                                                                                                                                                       
                             752:        if (lexer.peekKind(Token.START_ARRAY))                                                                                                                                  
                             753:        {                                                                                                                                                                       
                             754:            readValue();                                                                                                                                                        
                             755:            readDef();                                                                                                                                                          
                             756:        }                                                                                                                                                                       
                             757:        else                                                                                                                                                                    
                             758:        {                                                                                                                                                                       
                             759:            int length = read(Token.INTEGER).intValue();                                                                                                                        
                             760:            read(Token.NAME, "array");                                                                                                                                          
                             761:                                                                                                                                                                                
                             762:            for (int i = 0; i < length; i++)                                                                                                                                    
                             763:            {                                                                                                                                                                   
                             764:                read(Token.NAME, "dup");                                                                                                                                        
                             765:                read(Token.INTEGER); // index                                                                                                                                   
                             766:                readValue(); // PostScript                                                                                                                                      
                             767:                readPut();                                                                                                                                                      
                             768:            }                                                                                                                                                                   
                             769:            readDef();                                                                                                                                                          
                             770:        }                                                                                                                                                                       
                             771:    }                                                                                                                                                                           
                             772:                                                                                                                                                                                
                             773:    /**                                                                                                                                                                         
                             774:     * Reads the /CharStrings dictionary.                                                                                                                                       
                             775:     * @param lenIV The number of random bytes used in charstring encryption.                                                                                                   
                             776:     */                                                                                                                                                                         
                             777:    private void readCharStrings(int lenIV) throws IOException                                                                                                                  
                             778:    {                                                                                                                                                                           
                             779:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             780:        read(Token.NAME, "dict");                                                                                                                                               
                             781:        // could actually be a sequence ending in "CharStrings begin", too                                                                                                      
                             782:        // instead of the "dup begin"                                                                                                                                           
                             783:        read(Token.NAME, "dup");                                                                                                                                                
                             784:        read(Token.NAME, "begin");                                                                                                                                              
                             785:                                                                                                                                                                                
                             786:        for (int i = 0; i < length; i++)                                                                                                                                        
                             787:        {                                                                                                                                                                       
                             788:            // premature end                                                                                                                                                    
                             789:            if (lexer.peekToken() == null)                                                                                                                                      
                             790:            {                                                                                                                                                                   
                             791:                break;                                                                                                                                                          
                             792:            }                                                                                                                                                                   
                             793:            if (lexer.peekKind(Token.NAME) &&                                                                                                                                   
                             794:                lexer.peekToken().getText().equals("end"))                                                                                                                      
                             795:            {                                                                                                                                                                   
                             796:                break;                                                                                                                                                          
                             797:            }                                                                                                                                                                   
                             798:            // key/value                                                                                                                                                        
                             799:            String name = read(Token.LITERAL).getText();                                                                                                                        
                             800:                                                                                                                                                                                
                             801:            // RD                                                                                                                                                               
                             802:            read(Token.INTEGER);                                                                                                                                                
                             803:            Token charstring = read(Token.CHARSTRING);                                                                                                                          
                             804:            font.charstrings.put(name, decrypt(charstring.getData(), CHARSTRING_KEY, lenIV));                                                                                   
                             805:            readDef();                                                                                                                                                          
                             806:        }                                                                                                                                                                       
                             807:                                                                                                                                                                                
                             808:        // some fonts have one "end", others two                                                                                                                                
                             809:        read(Token.NAME, "end");                                                                                                                                                
                             810:        // since checking ends here, this does not matter ....                                                                                                                  
                             811:        // more thorough checking would see whether there is "begin" before /Private                                                                                            
                             812:        // and expect a "def" somewhere, otherwise a "put"                                                                                                                      
                             813:    }                                                                                                                                                                           
                             814:                                                                                                                                                                                
                             815:    /**                                                                                                                                                                         
                             816:     * Reads the sequence "noaccess def" or equivalent.                                                                                                                         
                             817:     */                                                                                                                                                                         
                             818:    private void readDef() throws IOException                                                                                                                                   
                             819:    {                                                                                                                                                                           
                             820:        readMaybe(Token.NAME, "readonly");                                                                                                                                      
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:770-805                                                                                                             
                             ```                                                                                                                                                                                 
                             770:        }                                                                                                                                                                       
                             771:    }                                                                                                                                                                           
                             772:                                                                                                                                                                                
                             773:    /**                                                                                                                                                                         
                             774:     * Reads the /CharStrings dictionary.                                                                                                                                       
                             775:     * @param lenIV The number of random bytes used in charstring encryption.                                                                                                   
                             776:     */                                                                                                                                                                         
                             777:    private void readCharStrings(int lenIV) throws IOException                                                                                                                  
                             778:    {                                                                                                                                                                           
                             779:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             780:        read(Token.NAME, "dict");                                                                                                                                               
                             781:        // could actually be a sequence ending in "CharStrings begin", too                                                                                                      
                             782:        // instead of the "dup begin"                                                                                                                                           
                             783:        read(Token.NAME, "dup");                                                                                                                                                
                             784:        read(Token.NAME, "begin");                                                                                                                                              
                             785:                                                                                                                                                                                
                             786:        for (int i = 0; i < length; i++)                                                                                                                                        
                             787:        {                                                                                                                                                                       
                             788:            // premature end                                                                                                                                                    
                             789:            if (lexer.peekToken() == null)                                                                                                                                      
                             790:            {                                                                                                                                                                   
                             791:                break;                                                                                                                                                          
                             792:            }                                                                                                                                                                   
                             793:            if (lexer.peekKind(Token.NAME) &&                                                                                                                                   
                             794:                lexer.peekToken().getText().equals("end"))                                                                                                                      
                             795:            {                                                                                                                                                                   
                             796:                break;                                                                                                                                                          
                             797:            }                                                                                                                                                                   
                             798:            // key/value                                                                                                                                                        
                             799:            String name = read(Token.LITERAL).getText();                                                                                                                        
                             800:                                                                                                                                                                                
                             801:            // RD                                                                                                                                                               
                             802:            read(Token.INTEGER);                                                                                                                                                
                             803:            Token charstring = read(Token.CHARSTRING);                                                                                                                          
                             804:            font.charstrings.put(name, decrypt(charstring.getData(), CHARSTRING_KEY, lenIV));                                                                                   
                             805:            readDef();                                                                                                                                                          
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:650-750                                                                                                             
                             ```                                                                                                                                                                                 
                             650:                                                                                                                                                                                
                             651:    /**                                                                                                                                                                         
                             652:     * Extracts values from the /Private dictionary.                                                                                                                            
                             653:     */                                                                                                                                                                         
                             654:    private void readPrivate(String key, List<Token> value) throws IOException                                                                                                  
                             655:    {                                                                                                                                                                           
                             656:        switch (key)                                                                                                                                                            
                             657:        {                                                                                                                                                                       
                             658:            case "BlueValues":                                                                                                                                                  
                             659:                font.blueValues = arrayToNumbers(value);                                                                                                                        
                             660:                break;                                                                                                                                                          
                             661:            case "OtherBlues":                                                                                                                                                  
                             662:                font.otherBlues = arrayToNumbers(value);                                                                                                                        
                             663:                break;                                                                                                                                                          
                             664:            case "FamilyBlues":                                                                                                                                                 
                             665:                font.familyBlues = arrayToNumbers(value);                                                                                                                       
                             666:                break;                                                                                                                                                          
                             667:            case "FamilyOtherBlues":                                                                                                                                            
                             668:                font.familyOtherBlues = arrayToNumbers(value);                                                                                                                  
                             669:                break;                                                                                                                                                          
                             670:            case "BlueScale":                                                                                                                                                   
                             671:                font.blueScale = value.get(0).floatValue();                                                                                                                     
                             672:                break;                                                                                                                                                          
                             673:            case "BlueShift":                                                                                                                                                   
                             674:                font.blueShift = value.get(0).intValue();                                                                                                                       
                             675:                break;                                                                                                                                                          
                             676:            case "BlueFuzz":                                                                                                                                                    
                             677:                font.blueFuzz = value.get(0).intValue();                                                                                                                        
                             678:                break;                                                                                                                                                          
                             679:            case "StdHW":                                                                                                                                                       
                             680:                font.stdHW = arrayToNumbers(value);                                                                                                                             
                             681:                break;                                                                                                                                                          
                             682:            case "StdVW":                                                                                                                                                       
                             683:                font.stdVW = arrayToNumbers(value);                                                                                                                             
                             684:                break;                                                                                                                                                          
                             685:            case "StemSnapH":                                                                                                                                                   
                             686:                font.stemSnapH = arrayToNumbers(value);                                                                                                                         
                             687:                break;                                                                                                                                                          
                             688:            case "StemSnapV":                                                                                                                                                   
                             689:                font.stemSnapV = arrayToNumbers(value);                                                                                                                         
                             690:                break;                                                                                                                                                          
                             691:            case "ForceBold":                                                                                                                                                   
                             692:                font.forceBold = value.get(0).booleanValue();                                                                                                                   
                             693:                break;                                                                                                                                                          
                             694:            case "LanguageGroup":                                                                                                                                               
                             695:                font.languageGroup = value.get(0).intValue();                                                                                                                   
                             696:                break;                                                                                                                                                          
                             697:            default:                                                                                                                                                            
                             698:                break;                                                                                                                                                          
                             699:        }                                                                                                                                                                       
                             700:    }                                                                                                                                                                           
                             701:                                                                                                                                                                                
                             702:    /**                                                                                                                                                                         
                             703:     * Reads the /Subrs array.                                                                                                                                                  
                             704:     * @param lenIV The number of random bytes used in charstring encryption.                                                                                                   
                             705:     */                                                                                                                                                                         
                             706:    private void readSubrs(int lenIV) throws IOException                                                                                                                        
                             707:    {                                                                                                                                                                           
                             708:        // allocate size (array indexes may not be in-order)                                                                                                                    
                             709:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             710:        for (int i = 0; i < length; i++)                                                                                                                                        
                             711:        {                                                                                                                                                                       
                             712:            font.subrs.add(null);                                                                                                                                               
                             713:        }                                                                                                                                                                       
                             714:        read(Token.NAME, "array");                                                                                                                                              
                             715:                                                                                                                                                                                
                             716:        for (int i = 0; i < length; i++)                                                                                                                                        
                             717:        {                                                                                                                                                                       
                             718:            // premature end                                                                                                                                                    
                             719:            if (lexer.peekToken() == null)                                                                                                                                      
                             720:            {                                                                                                                                                                   
                             721:                break;                                                                                                                                                          
                             722:            }                                                                                                                                                                   
                             723:            if (!(lexer.peekKind(Token.NAME) &&                                                                                                                                 
                             724:                  lexer.peekToken().getText().equals("dup")))                                                                                                                   
                             725:            {                                                                                                                                                                   
                             726:                break;                                                                                                                                                          
                             727:            }                                                                                                                                                                   
                             728:                                                                                                                                                                                
                             729:            read(Token.NAME, "dup");                                                                                                                                            
                             730:            Token index = read(Token.INTEGER);                                                                                                                                  
                             731:            read(Token.INTEGER);                                                                                                                                                
                             732:                                                                                                                                                                                
                             733:            // RD                                                                                                                                                               
                             734:            Token charstring = read(Token.CHARSTRING);                                                                                                                          
                             735:            int j = index.intValue();                                                                                                                                           
                             736:            if (j < font.subrs.size())                                                                                                                                          
                             737:            {                                                                                                                                                                   
                             738:                font.subrs.set(j, decrypt(charstring.getData(), CHARSTRING_KEY, lenIV));                                                                                        
                             739:            }                                                                                                                                                                   
                             740:            readPut();                                                                                                                                                          
                             741:        }                                                                                                                                                                       
                             742:        readDef();                                                                                                                                                              
                             743:    }                                                                                                                                                                           
                             744:                                                                                                                                                                                
                             745:    // OtherSubrs are embedded PostScript procedures which we can safely ignore                                                                                                 
                             746:    private void readOtherSubrs() throws IOException                                                                                                                            
                             747:    {                                                                                                                                                                           
                             748:        if (lexer.peekToken() == null)                                                                                                                                          
                             749:        {                                                                                                                                                                       
                             750:            throw new IOException("Missing start token of OtherSubrs procedure");                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:592-600                                                                                                             
                             ```                                                                                                                                                                                 
                             592:            switch (key)                                                                                                                                                        
                             593:            {                                                                                                                                                                   
                             594:                case "Subrs":                                                                                                                                                   
                             595:                    readSubrs(lenIV);                                                                                                                                           
                             596:                    break;                                                                                                                                                      
                             597:                case "OtherSubrs":                                                                                                                                              
                             598:                    readOtherSubrs();                                                                                                                                           
                             599:                    break;                                                                                                                                                      
                             600:                case "lenIV":                                                                                                                                                   
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java:502-515                                                                                                              
                             ```                                                                                                                                                                                 
                             502:    private Token readCharString(int length) throws IOException                                                                                                                 
                             503:    {                                                                                                                                                                           
                             504:        try                                                                                                                                                                     
                             505:        {                                                                                                                                                                       
                             506:            buffer.get(); // space                                                                                                                                              
                             507:            byte[] data = new byte[length];                                                                                                                                     
                             508:            buffer.get(data);                                                                                                                                                   
                             509:            return new Token(data, Token.CHARSTRING);                                                                                                                           
                             510:        }                                                                                                                                                                       
                             511:        catch (BufferUnderflowException exception)                                                                                                                              
                             512:        {                                                                                                                                                                       
                             513:            throw new IOException("Premature end of buffer reached");                                                                                                           
                             514:        }                                                                                                                                                                       
                             515:    }                                                                                                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:777-805                                                                                                             
                             ```                                                                                                                                                                                 
                             777:    private void readCharStrings(int lenIV) throws IOException                                                                                                                  
                             778:    {                                                                                                                                                                           
                             779:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             780:        read(Token.NAME, "dict");                                                                                                                                               
                             781:        // could actually be a sequence ending in "CharStrings begin", too                                                                                                      
                             782:        // instead of the "dup begin"                                                                                                                                           
                             783:        read(Token.NAME, "dup");                                                                                                                                                
                             784:        read(Token.NAME, "begin");                                                                                                                                              
                             785:                                                                                                                                                                                
                             786:        for (int i = 0; i < length; i++)                                                                                                                                        
                             787:        {                                                                                                                                                                       
                             788:            // premature end                                                                                                                                                    
                             789:            if (lexer.peekToken() == null)                                                                                                                                      
                             790:            {                                                                                                                                                                   
                             791:                break;                                                                                                                                                          
                             792:            }                                                                                                                                                                   
                             793:            if (lexer.peekKind(Token.NAME) &&                                                                                                                                   
                             794:                lexer.peekToken().getText().equals("end"))                                                                                                                      
                             795:            {                                                                                                                                                                   
                             796:                break;                                                                                                                                                          
                             797:            }                                                                                                                                                                   
                             798:            // key/value                                                                                                                                                        
                             799:            String name = read(Token.LITERAL).getText();                                                                                                                        
                             800:                                                                                                                                                                                
                             801:            // RD                                                                                                                                                               
                             802:            read(Token.INTEGER);                                                                                                                                                
                             803:            Token charstring = read(Token.CHARSTRING);                                                                                                                          
                             804:            font.charstrings.put(name, decrypt(charstring.getData(), CHARSTRING_KEY, lenIV));                                                                                   
                             805:            readDef();                                                                                                                                                          
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:706-743                                                                                                             
                             ```                                                                                                                                                                                 
                             706:    private void readSubrs(int lenIV) throws IOException                                                                                                                        
                             707:    {                                                                                                                                                                           
                             708:        // allocate size (array indexes may not be in-order)                                                                                                                    
                             709:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             710:        for (int i = 0; i < length; i++)                                                                                                                                        
                             711:        {                                                                                                                                                                       
                             712:            font.subrs.add(null);                                                                                                                                               
                             713:        }                                                                                                                                                                       
                             714:        read(Token.NAME, "array");                                                                                                                                              
                             715:                                                                                                                                                                                
                             716:        for (int i = 0; i < length; i++)                                                                                                                                        
                             717:        {                                                                                                                                                                       
                             718:            // premature end                                                                                                                                                    
                             719:            if (lexer.peekToken() == null)                                                                                                                                      
                             720:            {                                                                                                                                                                   
                             721:                break;                                                                                                                                                          
                             722:            }                                                                                                                                                                   
                             723:            if (!(lexer.peekKind(Token.NAME) &&                                                                                                                                 
                             724:                  lexer.peekToken().getText().equals("dup")))                                                                                                                   
                             725:            {                                                                                                                                                                   
                             726:                break;                                                                                                                                                          
                             727:            }                                                                                                                                                                   
                             728:                                                                                                                                                                                
                             729:            read(Token.NAME, "dup");                                                                                                                                            
                             730:            Token index = read(Token.INTEGER);                                                                                                                                  
                             731:            read(Token.INTEGER);                                                                                                                                                
                             732:                                                                                                                                                                                
                             733:            // RD                                                                                                                                                               
                             734:            Token charstring = read(Token.CHARSTRING);                                                                                                                          
                             735:            int j = index.intValue();                                                                                                                                           
                             736:            if (j < font.subrs.size())                                                                                                                                          
                             737:            {                                                                                                                                                                   
                             738:                font.subrs.set(j, decrypt(charstring.getData(), CHARSTRING_KEY, lenIV));                                                                                        
                             739:            }                                                                                                                                                                   
                             740:            readPut();                                                                                                                                                          
                             741:        }                                                                                                                                                                       
                             742:        readDef();                                                                                                                                                              
                             743:    }                                                                                                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             </code_snippets>                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Fix Strategy                                                                                                                                                                     
                             <fix_strategy>                                                                                                                                                                      
                                                                                                                                                                                                                 
                             </fix_strategy>                                                                                                                                                                     
                             ===Tests Result===                                                                                                                                                                  
                             No tests found                                                                                                                                                                      
                             ===Evaluation End===                                                                                                                                                                
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                                                      __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                                                       
                    INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmprvn4wj39                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/pdfbox_pdfbox-full-01_vuln_5/agent-output-1761597933.659234                                                                         
                             - Detection toml file: /tasks_new/pdfbox_pdfbox-full-01/detection/pdfbox_pdfbox-full-01_vuln_5.toml                                                                                 
                             - Challenge project directory: /tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox                                                                                                 
                                                                                                                                                                                                                 
