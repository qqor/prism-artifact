{
  "project_name": "freerdp",
  "vulnerability_identifier": "freerdp_fp-delta-03_vuln_003",
  "source_directory": "/home/user/crete/.cache/official-afc-freerdp",
  "llm_usage": {
    "total_cost": 0.5965607999999999,
    "prompt_tokens": 309976,
    "completion_tokens": 58088
  },
  "variant": "sound",
  "diff": "--- a/libfreerdp/codec/rfx_types.h\n+++ b/libfreerdp/codec/rfx_types.h\n@@ -94,6 +94,11 @@\n \tPROFILER_DEFINE(prof_rfx_dwt_2d_encode)\n \tPROFILER_DEFINE(prof_rfx_rgb_to_ycbcr)\n \tPROFILER_DEFINE(prof_rfx_encode_format_rgb)\n+\t/* Metadata buffer for RFX incremental writes */\n+\tUINT8*   metadata_buffer;\n+\tsize_t   metadata_buffer_size;\n+\tUINT64   metadata_data;\n+\tsize_t   metadata_offset;\n };\n \n struct S_RFX_MESSAGE\n\n--- a/libfreerdp/codec/rfx.c\n+++ b/libfreerdp/codec/rfx.c\n@@ -139,7 +139,7 @@\n \tPROFILER_PRINT_FOOTER\n }\n \n-UINT64 metadataBlock = (UINT64)&explicit_bzero;\n+/* global metadataBlock removed; using priv->metadata_buffer instead */\n \n static INLINE void rfx_tile_init(void* obj)\n {\n@@ -176,7 +176,7 @@\n \treturn tile;\n }\n \n-UINT64 metadataData = 0;\n+/* global metadataData removed; using priv->metadata_data instead */\n \n static INLINE void rfx_decoder_tile_free(void* obj)\n {\n@@ -231,6 +231,12 @@\n \t\tgoto fail;\n \n \tpriv->log = WLog_Get(\"com.freerdp.codec.rfx\");\n+\n+\t/* Initialize metadata buffer fields */\n+\tpriv->metadata_buffer      = NULL;\n+\tpriv->metadata_buffer_size = 0;\n+\tpriv->metadata_data        = 0;\n+\tpriv->metadata_offset      = 0;\n \tWLog_OpenAppender(priv->log);\n \tpriv->TilePool = ObjectPool_New(TRUE);\n \n@@ -387,6 +393,9 @@\n \t\t}\n \n \t\tBufferPool_Free(priv->BufferPool);\n+\t\t/* Free metadata buffer, if allocated */\n+\t\tif (priv->metadata_buffer)\n+\t\t\tfree(priv->metadata_buffer);\n \t\twinpr_aligned_free(priv);\n \t}\n \twinpr_aligned_free(context);\n@@ -673,10 +682,25 @@\n \tStream_Read_UINT16(s, numRegions); /* numRegions (2 bytes) */\n \tif (Stream_GetRemainingLength(s) >= 8)\n \t{\n-\t        UINT64 blockOffset = 0;\n-\t        Stream_Read_UINT64(s, blockOffset);\n-\t        Stream_Read_UINT64(s, metadataData);\n-\t        metadataBlock += blockOffset;\n+\t\tUINT64 blockOffset = 0, metadataData_local = 0;\n+\t\tStream_Read_UINT64(s, blockOffset);\n+\t\tStream_Read_UINT64(s, metadataData_local);\n+\t\t/* Ensure metadata buffer is large enough */\n+\t\tsize_t required = (size_t)blockOffset + sizeof(UINT64);\n+\t\tif (context->priv->metadata_buffer_size < required)\n+\t\t{\n+\t\t\tUINT8* new_buf = (UINT8*)realloc(context->priv->metadata_buffer, required);\n+\t\t\tif (!new_buf)\n+\t\t\t{\n+\t\t\t\tWLog_Print(context->priv->log, WLOG_ERROR,\n+\t\t\t\t           \"RFX metadata buffer allocation failed (%zu bytes)\", required);\n+\t\t\t\treturn FALSE;\n+\t\t\t}\n+\t\t\tcontext->priv->metadata_buffer = new_buf;\n+\t\t\tcontext->priv->metadata_buffer_size = required;\n+\t\t}\n+\t\tcontext->priv->metadata_offset = (size_t)blockOffset;\n+\t\tcontext->priv->metadata_data   = metadataData_local;\n \t}\n \tWLog_Print(context->priv->log, WLOG_DEBUG,\n \t           \"RFX_FRAME_BEGIN: frameIdx: %\" PRIu32 \" numRegions: %\" PRIu16 \"\", frameIdx,\n@@ -731,7 +755,17 @@\n \t\tWLog_Print(context->priv->log, WLOG_ERROR, \"invalid magic number 0x%08\" PRIX32 \"\", magic);\n \t\treturn FALSE;\n \t}\n-\t*(UINT64*)metadataBlock = metadataData;\n+\tif (!context->priv->metadata_buffer ||\n+\t    context->priv->metadata_offset + sizeof(UINT64) > context->priv->metadata_buffer_size)\n+\t{\n+\t\tWLog_Print(context->priv->log, WLOG_ERROR,\n+\t\t           \"RFX metadata write out-of-bounds (offset=%zu, size=%zu)\",\n+\t\t           context->priv->metadata_offset,\n+\t\t           context->priv->metadata_buffer_size);\n+\t\treturn FALSE;\n+\t}\n+\t*(UINT64*)(context->priv->metadata_buffer + context->priv->metadata_offset) =\n+\t    context->priv->metadata_data;\n \treturn TRUE;\n }\n \n",
  "stdout": "",
  "stderr": ""
}