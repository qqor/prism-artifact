[10/26/25 19:50:53] INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmprwwih4mx                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/pdfbox_pdfbox-full-01_vuln_5/agent-output-1761508253.3643866                                                                        
                             - Detection toml file: /tasks_new/pdfbox_pdfbox-full-01/detection/pdfbox_pdfbox-full-01_vuln_5.toml                                                                                 
                             - Challenge project directory: /tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox                                                                                                 
                                                                                                                                                                                                                 
                    INFO     [logging_performance](pdfbox Building Cached for CLEAN environment) Started...                                                                                 context_managers.py:9
[10/26/25 19:52:09] INFO     [logging_performance](pdfbox Building Cached for CLEAN environment) Took 76.12 seconds; exception=False                                                       context_managers.py:23
                    INFO     [logging_performance](pdfbox Running tests for Cached for CLEAN environment) Started...                                                                        context_managers.py:9
                    INFO     [logging_performance](pdfbox Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                                               context_managers.py:23
                    INFO     Setting timeouts                                                                                                                                                       default.py:85
                               - build: 600 (original: 76)                                                                                                                                                       
                               - run tests: 600 (original: 0)                                                                                                                                                    
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:52:10] INFO     [logging_performance](pdfbox Setting owner) Took 0.95 seconds; exception=False                                                                                context_managers.py:23
[10/26/25 19:52:11] INFO     Successfully created Cached for CLEAN environment                                                                                                                    oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                                                            oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                                                 
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:52:12] INFO     [logging_performance](pdfbox Setting owner) Took 1.29 seconds; exception=False                                                                                context_managers.py:23
[10/26/25 19:52:13] INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:52:14] INFO     [logging_performance](pdfbox Setting owner) Took 0.95 seconds; exception=False                                                                                context_managers.py:23
[10/26/25 19:52:20] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                                                              
                             ===Evaluator Diff===                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd400.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbcc00.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd400.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbcc00.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                                                                                                                                                                                                                 
                             ===Analysis Report===                                                                                                                                                               
                                                                                                                                                                                                                 
                             ===Evaluation End===                                                                                                                                                                
[10/26/25 19:52:27] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                                                  __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/26/25 19:54:22] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                                                     __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/26/25 19:54:49] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:54:50] INFO     [logging_performance](pdfbox Setting owner) Took 1.01 seconds; exception=False                                                                                context_managers.py:23
[10/26/25 19:54:51] INFO     [logging_performance](pdfbox Patching) Started...                                                                                                              context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmpx8t3ha_s                                                                                                                                 default.py:173
[10/26/25 19:55:50] INFO     [logging_performance](pdfbox Patching) Took 59.06 seconds; exception=False                                                                                    context_managers.py:23
                    INFO     [logging_performance](pdfbox Checking build) Started...                                                                                                        context_managers.py:9
[10/26/25 19:56:04] INFO     [logging_performance](pdfbox Checking build) Took 14.64 seconds; exception=False                                                                              context_managers.py:23
                    INFO     [logging_performance](pdfbox Running PoV) Started...                                                                                                           context_managers.py:9
[10/26/25 19:56:11] INFO     [logging_performance](pdfbox Running PoV) Took 6.23 seconds; exception=False                                                                                  context_managers.py:23
                    INFO     [logging_performance](pdfbox Testing) Started...                                                                                                               context_managers.py:9
                    INFO     [logging_performance](pdfbox Testing) Took 0.00 seconds; exception=False                                                                                      context_managers.py:23
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:56:12] INFO     [logging_performance](pdfbox Setting owner) Took 1.02 seconds; exception=False                                                                                context_managers.py:23
                    INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:56:13] INFO     [logging_performance](pdfbox Setting owner) Took 0.97 seconds; exception=False                                                                                context_managers.py:23
[10/26/25 19:56:14] INFO     [logging_performance](pdfbox Setting owner) Started...                                                                                                         context_managers.py:9
[10/26/25 19:56:15] INFO     [logging_performance](pdfbox Setting owner) Took 0.98 seconds; exception=False                                                                                context_managers.py:23
                    INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                                                   
                             ===Evaluator Diff===                                                                                                                                                                
                             --- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java                                                                                                                
                             +++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java                                                                                                                
                             @@ -501,6 +501,19 @@                                                                                                                                                                
                                   */                                                                                                                                                                            
                                  private Token readCharString(int length) throws IOException                                                                                                                    
                                  {                                                                                                                                                                              
                             +        // sanity check on length                                                                                                                                                  
                             +        if (length < 0) {                                                                                                                                                          
                             +            throw new IOException("Invalid CharString length: " + length);                                                                                                         
                             +        }                                                                                                                                                                          
                             +        // enforce a per-CharString cap (20 MB)                                                                                                                                    
                             +        final int MAX_CHARSTRING_LENGTH = 20 * 1024 * 1024;                                                                                                                        
                             +        if (length > MAX_CHARSTRING_LENGTH) {                                                                                                                                      
                             +            throw new IOException("CharString length too large: " + length);                                                                                                       
                             +        }                                                                                                                                                                          
                             +        // ensure buffer has at least (length + 1) bytes (for the space + data)                                                                                                    
                             +        if (buffer.remaining() < length + 1) {                                                                                                                                     
                             +            throw new IOException("Premature end of buffer for CharString (expected " + length + " bytes)");                                                                       
                             +        }                                                                                                                                                                          
                                      try                                                                                                                                                                        
                                      {                                                                                                                                                                          
                                          buffer.get(); // space                                                                                                                                                 
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd400.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbcc00.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             ===Evaluation Report===                                                                                                                                                             
                             # Evaluation Report                                                                                                                                                                 
                                                                                                                                                                                                                 
                             ## Summary                                                                                                                                                                          
                                                                                                                                                                                                                 
                             A fuzzing run with Jazzer triggered a low-severity security issue in Apache PDFBox’s font handling code. Specifically, during Type 1 font parsing, the application                  
                             ran out of memory and threw a java.lang.OutOfMemoryError (“Requested array size exceeds VM limit”). The failure occurred in                                                         
                             org.apache.fontbox.type1.Type1Lexer.readCharString and propagated up through the PDFTextStripper logic invoked by a fuzzing harness.                                                
                                                                                                                                                                                                                 
                             ## Description                                                                                                                                                                      
                                                                                                                                                                                                                 
                             - Issue                                                                                                                                                                             
                               A FuzzerSecurityIssueLow was reported: an OutOfMemoryError during PDF text extraction. The error message indicates that an attempted array allocation exceeded                    
                             the Java VM’s allowed size. No further speculation on root cause is made in the report.                                                                                             
                                                                                                                                                                                                                 
                             - Vulnerability Type                                                                                                                                                                
                               This is a memory exhaustion condition arising from unbounded or unchecked allocation requests, leading to an OutOfMemoryError.                                                    
                                                                                                                                                                                                                 
                             - Key Observations                                                                                                                                                                  
                               • The crash stack trace begins in Type1Lexer.readCharString (FontBox).                                                                                                            
                               • Tokenization and parsing steps in Type1Lexer and Type1Parser are involved.                                                                                                      
                               • The flow continues through PDFBox’s Type1Font creation, PDType1Font initialization, and PDFontFactory font retrieval.                                                           
                               • The error surfaces during content-stream processing in PDFStreamEngine and ultimately in PDFTextStripper.getText.                                                               
                               • The fuzzing harness (PDFExtractTextFuzzer) simply feeds inputs to PDFTextStripper; it is not the direct cause of the allocation failure.                                        
                                                                                                                                                                                                                 
                             - Code Areas for Investigation                                                                                                                                                      
                               1. org.apache.fontbox.type1.Type1Lexer.readCharString (around line 507) – logic for reading and sizing charstrings.                                                               
                               2. org.apache.fontbox.type1.Type1Lexer.readToken / nextToken – token parsing that may influence buffer sizes.                                                                     
                               3. org.apache.fontbox.type1.Type1Parser.parseASCII / parse – ASCII parsing routines in Type1Parser.                                                                               
                               4. org.apache.fontbox.type1.Type1Font.createWithPFB – creation of font objects from PFB streams.                                                                                  
                               5. PDFBox font-loading and resource resolution code paths: PDType1Font, PDFontFactory, PDResources.                                                                               
                               6. PDFStreamEngine and PDFTextStripper text extraction routines for how parsed font data is used.                                                                                 
                                                                                                                                                                                                                 
                             Examining these components will provide a holistic view of how untrusted input can drive oversized memory allocations in the Type 1 font parsing pipeline.                          
                                                                                                                                                                                                                 
                             ## Initial Issue Log                                                                                                                                                                
                             Here is the initial issue log of the codebase:                                                                                                                                      
                             <issue>                                                                                                                                                                             
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueLow: Out of memory (use '-Xmx1710m' to reproduce)                                                            
                             Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit                                                                                                        
                                     at org.apache.fontbox.type1.Type1Lexer.readCharString(Type1Lexer.java:507)                                                                                                  
                                     at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:232)                                                                                                       
                                     at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75)                                                                                                        
                                     at org.apache.fontbox.type1.Type1Parser.read(Type1Parser.java:877)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Parser.parseASCII(Type1Parser.java:109)                                                                                                    
                                     at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:63)                                                                                                          
                                     at org.apache.fontbox.type1.Type1Font.createWithPFB(Type1Font.java:71)                                                                                                      
                                     at org.apache.pdfbox.pdmodel.font.PDType1Font.<init>(PDType1Font.java:227)                                                                                                  
                                     at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:140)                                                                                          
                                     at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:170)                                                                                                      
                                     at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:72)                                                                             
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:924)                                                                                
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:557)                                                                         
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:515)                                                                                  
                                     at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:158)                                                                                    
                                     at org.apache.pdfbox.text.LegacyPDFStreamEngine.processPage(LegacyPDFStreamEngine.java:153)                                                                                 
                                     at org.apache.pdfbox.text.PDFTextStripper.processPage(PDFTextStripper.java:378)                                                                                             
                                     at org.apache.pdfbox.text.PDFTextStripper.processPages(PDFTextStripper.java:303)                                                                                            
                                     at org.apache.pdfbox.text.PDFTextStripper.writeText(PDFTextStripper.java:251)                                                                                               
                                     at org.apache.pdfbox.text.PDFTextStripper.getText(PDFTextStripper.java:218)                                                                                                 
                                     at com.example.PDFExtractTextFuzzer.fuzzerTestOneInput(PDFExtractTextFuzzer.java:41)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$DMH/0x0000000800cbc000.invokeStaticInit(LambdaForm$DMH)                                                                            
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbd400.invoke(LambdaForm$MH)                                                                                        
                                     at java.base/java.lang.invoke.LambdaForm$MH/0x0000000800cbcc00.invoke_MT(LambdaForm$MH)                                                                                     
                             DEDUP_TOKEN: 0d88e419df5aef8d                                                                                                                                                       
                             == libFuzzer crashing input ==                                                                                                                                                      
                             </issue>                                                                                                                                                                            
                             ===Analysis Report===                                                                                                                                                               
                             # Analysis Report                                                                                                                                                                   
                                                                                                                                                                                                                 
                             ## Relevant Code Snippets                                                                                                                                                           
                             <code_snippets>                                                                                                                                                                     
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java:68-76                                                                                                                   
                             ```                                                                                                                                                                                 
                             68:    /**                                                                                                                                                                          
                             69:     * Heuristically chosen max length to buffer a Type1 font                                                                                                                    
                             70:     */                                                                                                                                                                          
                             71:    private static final long MAX_LENGTH = 100_000_000;                                                                                                                          
                             72:                                                                                                                                                                                 
                             73:    /**                                                                                                                                                                          
                             74:     * the parsed pfb-data.                                                                                                                                                      
                             75:     */                                                                                                                                                                          
                             76:    private byte[] pfbdata;                                                                                                                                                      
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java:155-164                                                                                                                 
                             ```                                                                                                                                                                                 
                             155:                                                                                                                                                                                
                             156:            int size = in.read();                                                                                                                                               
                             157:            size += in.read() << 8;                                                                                                                                             
                             158:            size += in.read() << 16;                                                                                                                                            
                             159:            size += in.read() << 24;                                                                                                                                            
                             160:            LOG.debug("record type: {}, segment size: {}", recordType, size);                                                                                                   
                             161:            long newTotal = total + size;                                                                                                                                       
                             162:            if (newTotal > MAX_LENGTH) {                                                                                                                                        
                             163:                throw new IOException("record size would be too large: " + newTotal);                                                                                           
                             164:            }                                                                                                                                                                   
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java:225-243                                                                                                              
                             ```                                                                                                                                                                                 
                             225:                        }                                                                                                                                                       
                             226:                                                                                                                                                                                
                             227:                        if (name.equals("RD") || name.equals("-|"))                                                                                                             
                             228:                        {                                                                                                                                                       
                             229:                            // return the next CharString instead                                                                                                               
                             230:                            if (prevToken != null && prevToken.getKind() == Token.INTEGER)                                                                                      
                             231:                            {                                                                                                                                                   
                             232:                                return readCharString(prevToken.intValue());                                                                                                    
                             233:                            }                                                                                                                                                   
                             234:                            else                                                                                                                                                
                             235:                            {                                                                                                                                                   
                             236:                                throw new IOException("expected INTEGER before -| or RD");                                                                                      
                             237:                            }                                                                                                                                                   
                             238:                        }                                                                                                                                                       
                             239:                        else                                                                                                                                                    
                             240:                        {                                                                                                                                                       
                             241:                            return new Token(name, Token.NAME);                                                                                                                 
                             242:                        }                                                                                                                                                       
                             243:                    }                                                                                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java:500-508                                                                                                              
                             ```                                                                                                                                                                                 
                             500:     * Reads a binary CharString.                                                                                                                                               
                             501:     */                                                                                                                                                                         
                             502:    private Token readCharString(int length) throws IOException                                                                                                                 
                             503:    {                                                                                                                                                                           
                             504:        try                                                                                                                                                                     
                             505:        {                                                                                                                                                                       
                             506:            buffer.get(); // space                                                                                                                                              
                             507:            byte[] data = new byte[length];                                                                                                                                     
                             508:            buffer.get(data);                                                                                                                                                   
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:106-115                                                                                                             
                             ```                                                                                                                                                                                 
                             106:        }                                                                                                                                                                       
                             107:                                                                                                                                                                                
                             108:        // font dict                                                                                                                                                            
                             109:        int length = read(Token.INTEGER).intValue();                                                                                                                            
                             110:        read(Token.NAME, "dict");                                                                                                                                               
                             111:        // found in some TeX fonts                                                                                                                                              
                             112:        readMaybe(Token.NAME, "dup");                                                                                                                                           
                             113:        // if present, the "currentdict" is not required                                                                                                                        
                             114:        read(Token.NAME, "begin");                                                                                                                                              
                             115:                                                                                                                                                                                
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java:151-155                                                                                                             
                             ```                                                                                                                                                                                 
                             151:        read(Token.NAME, "end");                                                                                                                                                
                             152:                                                                                                                                                                                
                             153:        read(Token.NAME, "currentfile");                                                                                                                                        
                             154:        read(Token.NAME, "eexec");                                                                                                                                              
                             155:    }                                                                                                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java:499-516                                                                                                              
                             ```                                                                                                                                                                                 
                             499:    /**                                                                                                                                                                         
                             500:     * Reads a binary CharString.                                                                                                                                               
                             501:     */                                                                                                                                                                         
                             502:    private Token readCharString(int length) throws IOException                                                                                                                 
                             503:    {                                                                                                                                                                           
                             504:        try                                                                                                                                                                     
                             505:        {                                                                                                                                                                       
                             506:            buffer.get(); // space                                                                                                                                              
                             507:            byte[] data = new byte[length];                                                                                                                                     
                             508:            buffer.get(data);                                                                                                                                                   
                             509:            return new Token(data, Token.CHARSTRING);                                                                                                                           
                             510:        }                                                                                                                                                                       
                             511:        catch (BufferUnderflowException exception)                                                                                                                              
                             512:        {                                                                                                                                                                       
                             513:            throw new IOException("Premature end of buffer reached");                                                                                                           
                             514:        }                                                                                                                                                                       
                             515:    }                                                                                                                                                                           
                             516:}                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             </code_snippets>                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Fix Strategy                                                                                                                                                                     
                             <fix_strategy>                                                                                                                                                                      
                                                                                                                                                                                                                 
                             1. Root Cause Analysis                                                                                                                                                              
                                - In Type1Lexer.readCharString(int length), the code allocates a byte array of size `length` without validating that `length` is non-negative or reasonably                      
                             bounded. A malicious or malformed font can supply an excessively large integer before the ‘RD’ or ‘-|’ operator, causing the JVM to attempt to allocate an array                    
                             larger than VM limits and throw an OutOfMemoryError.                                                                                                                                
                                - PfbParser caps aggregate PFB file size to 100 MB, but does not restrict individual charstring lengths; furthermore, ASCII (PFA) fonts bypass PfbParser                         
                             entirely and have no global size cap.                                                                                                                                               
                                - The unvalidated `length` directly leads to uncontrolled heap allocation in readCharString, breaking the security and stability guarantees of the parser.                       
                                                                                                                                                                                                                 
                             2. Proposed Fix                                                                                                                                                                     
                                - In Type1Lexer.java, add pre‐allocation validation to readCharString():                                                                                                         
                                  a. Check that `length` is non-negative.                                                                                                                                        
                                  b. Check that `length + 1` does not exceed the buffer’s remaining bytes, avoiding both BufferUnderflowException and OOM from reading past available data.                      
                                  c. (Optional but recommended) Enforce a sane per-charstring maximum, e.g. 20 MB, to mitigate memory exhaustion attacks even when buffer.remaining() is large.                  
                                - If any check fails, throw a descriptive IOException to abort parsing cleanly, preserving existing error‐handling semantics and upstream code paths in                          
                             Type1Parser and PDFBox’s font loader.                                                                                                                                               
                                                                                                                                                                                                                 
                             3. Detailed Steps                                                                                                                                                                   
                                1. In `org.apache.fontbox.type1.Type1Lexer`, introduce a new private constant, e.g.:                                                                                             
                                     ```java                                                                                                                                                                     
                                     // in Type1Lexer class body                                                                                                                                                 
                                     private static final int MAX_CHARSTRING_LENGTH = 20 * 1024 * 1024; // 20 MB                                                                                                 
                                     ```                                                                                                                                                                         
                                2. Modify `readCharString(int length)` to the following logic:                                                                                                                   
                                     ```java                                                                                                                                                                     
                                     private Token readCharString(int length) throws IOException {                                                                                                               
                                         // 1. Sanity check on length                                                                                                                                            
                                         if (length < 0) {                                                                                                                                                       
                                             throw new IOException("Invalid CharString length: " + length);                                                                                                      
                                         }                                                                                                                                                                       
                                         // 2. Enforce a per-CharString cap                                                                                                                                      
                                         if (length > MAX_CHARSTRING_LENGTH) {                                                                                                                                   
                                             throw new IOException("CharString length too large: " + length);                                                                                                    
                                         }                                                                                                                                                                       
                                         // 3. Ensure buffer has at least (length + 1) bytes (for the space + data)                                                                                              
                                         if (buffer.remaining() < length + 1) {                                                                                                                                  
                                             throw new IOException("Premature end of buffer for CharString (expected " + length + " bytes)");                                                                    
                                         }                                                                                                                                                                       
                                         // 4. Proceed as before                                                                                                                                                 
                                         buffer.get(); // consume the space                                                                                                                                      
                                         byte[] data = new byte[length];                                                                                                                                         
                                         buffer.get(data);                                                                                                                                                       
                                         return new Token(data, Token.CHARSTRING);                                                                                                                               
                                     }                                                                                                                                                                           
                                     ```                                                                                                                                                                         
                                3. Remove or repurpose the existing catch for BufferUnderflowException, as the explicit remaining‐bytes check will prevent it; wrap any unexpected                               
                             BufferUnderflowException in an IOException if still desired.                                                                                                                        
                                                                                                                                                                                                                 
                             4. Justification                                                                                                                                                                    
                                - This validation prevents unbounded or attacker-controlled allocation sizes, eliminating the path to OutOfMemoryError while parsing corrupt or malicious Type 1                 
                             fonts.                                                                                                                                                                              
                                - Legitimate fonts almost always have charstring segments far below the 20 MB threshold; the chosen cap balances security against interoperability.                              
                                - Upstream callers (Type1Parser, Type1Font, PDType1Font, PDFontFactory, PDFStreamEngine, PDFTextStripper) already treat IOExceptions as parse failures; no                       
                             higher-level logic changes are required.                                                                                                                                            
                                - Tests and existing functionality remain intact—valid fonts will still parse and yield text; malformed or oversized charstring data will now fail gracefully.                   
                                                                                                                                                                                                                 
                             5. Potential Side Effects and Mitigations                                                                                                                                           
                                - Very large but legitimate charstring segments (>20 MB) would now be rejected. If this becomes an issue, the constant `MAX_CHARSTRING_LENGTH` can be increased                  
                             or made configurable.                                                                                                                                                               
                                - The thrown IOException messages are descriptive; ensure any logging or error‐reporting mechanisms in PDFBox surface them clearly for debugging.                                
                                                                                                                                                                                                                 
                             6. No Harness or External Changes                                                                                                                                                   
                                - This patch only touches internal fontbox parsing code.                                                                                                                         
                                - The fuzzing harness, PDFTextStripper, and any external test or build scripts remain unchanged, preserving all existing tests and integration points.                           
                                                                                                                                                                                                                 
                                                                                                                                                                                                                 
                             </fix_strategy>                                                                                                                                                                     
                             ===Tests Result===                                                                                                                                                                  
                             No tests found                                                                                                                                                                      
                             ===Evaluation End===                                                                                                                                                                
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                                                      __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                                                       
                    INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmprwwih4mx                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/pdfbox_pdfbox-full-01_vuln_5/agent-output-1761508575.7177956                                                                        
                             - Detection toml file: /tasks_new/pdfbox_pdfbox-full-01/detection/pdfbox_pdfbox-full-01_vuln_5.toml                                                                                 
                             - Challenge project directory: /tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox                                                                                                 
                                                                                                                                                                                                                 
