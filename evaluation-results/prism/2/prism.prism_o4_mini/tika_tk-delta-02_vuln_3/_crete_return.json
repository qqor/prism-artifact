{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-02_vuln_3",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.8948907000000001,
    "prompt_tokens": 566421,
    "completion_tokens": 61779
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/m3/M3U8Parser.java\n@@ -40,6 +40,7 @@\n import org.apache.tika.metadata.XMPDM;\n import org.apache.tika.mime.MediaType;\n import org.apache.tika.parser.ParseContext;\n+import org.apache.tika.parser.m3.M3U8ParserConfig;\n import org.apache.tika.parser.Parser;\n import org.apache.tika.sax.BodyContentHandler;\n import org.apache.tika.sax.EmbeddedContentHandler;\n@@ -161,7 +162,12 @@\n         // split on , then the first value is the length (can be -1),\n         // the last value is the title; intermediate values are key=value format\n         metadata.add(PLAY_LIST_LINK, nextLine);\n-        if (! nextLine.startsWith(\"http\")) {\n+        if (!nextLine.startsWith(\"http\")) {\n+            return;\n+        }\n+        // Guard against SSRF: only fetch external links if explicitly allowed\n+        M3U8ParserConfig cfg = M3U8ParserConfig.from(context);\n+        if (!cfg.isExternalLinksAllowed()) {\n             return;\n         }\n         EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n@@ -198,3 +204,24 @@\n         metadata.set(XMPDM.DURATION, df.format(durationInSeconds));\n     }\n }\n+class M3U8ParserConfig implements java.io.Serializable {\n+    private static final long serialVersionUID = 1L;\n+    private boolean externalLinksAllowed = false;\n+\n+    public boolean isExternalLinksAllowed() {\n+        return externalLinksAllowed;\n+    }\n+\n+    public void setExternalLinksAllowed(boolean externalLinksAllowed) {\n+        this.externalLinksAllowed = externalLinksAllowed;\n+    }\n+\n+    public static M3U8ParserConfig from(ParseContext context) {\n+        M3U8ParserConfig cfg = context.get(M3U8ParserConfig.class);\n+        if (cfg == null) {\n+            cfg = new M3U8ParserConfig();\n+            context.set(M3U8ParserConfig.class, cfg);\n+        }\n+        return cfg;\n+    }\n+}\n",
  "stdout": "",
  "stderr": ""
}