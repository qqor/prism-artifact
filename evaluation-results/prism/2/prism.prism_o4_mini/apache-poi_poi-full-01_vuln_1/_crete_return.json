{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_1",
  "source_directory": "/tasks_new/apache-poi_poi-full-01/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.6108542,
    "prompt_tokens": 294646,
    "completion_tokens": 65169
  },
  "variant": "sound",
  "diff": "--- a/poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java\n+++ b/poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java\n@@ -40,10 +40,12 @@\n  */\n public class MAPIAttribute {\n \n-   //arbitrarily selected; may need to increase\n    private static final int DEFAULT_MAX_RECORD_LENGTH = 1_000_000;\n-   private static int MAX_RECORD_LENGTH = 1_000_000;\n+   private static int MAX_RECORD_LENGTH = DEFAULT_MAX_RECORD_LENGTH;\n    private static int MAX_RECORD_COUNT = 10_000;\n+   // maximum number of MAPI values to guard against OOM via multi-valued attributes\n+   private static final int MAX_MAPI_VALUES = 1024;\n+   private static final int HEADER_SIZE = 8;\n \n    private final MAPIProperty property;\n    private final int type;\n@@ -118,10 +120,13 @@\n       }\n       try(UnsynchronizedByteArrayInputStream inp = UnsynchronizedByteArrayInputStream.builder().setByteArray(parent.getData()).get()) {\n          // First up, get the number of attributes\n-         int count = LittleEndian.readInt(inp);\n-         List<MAPIAttribute> attrs = new ArrayList<>();\n-\n-         // Now, read each one in in turn\n+        int count = LittleEndian.readInt(inp);\n+        if (count < 0 || count > MAX_RECORD_COUNT) {\n+            throw new IOException(\"Corrupt TNEF: unreasonable MAPI attribute count: \" + count);\n+        }\n+        List<MAPIAttribute> attrs = new ArrayList<>();\n+        \n+        // Now, read each one in in turn\n          for(int i=0; i<count; i++) {\n             int typeAndMV = LittleEndian.readUShort(inp);\n             int id = LittleEndian.readUShort(inp);\n@@ -165,10 +170,11 @@\n                } else {\n                   // Custom name was stored\n                   int mplen = LittleEndian.readInt(inp);\n-                  if (mplen < 0) {\n-                     throw new IOException(\"Did not expect negative value: \" + mplen);\n+                  if (mplen < 0 || mplen > MAX_RECORD_LENGTH) {\n+                     throw new IOException(\"Corrupt TNEF: attribute name length \" + mplen +\n+                                           \" out of bounds (0–\" + MAX_RECORD_LENGTH + \")\");\n                   }\n-                  byte[] mpdata = new byte[mplen];\n+                  byte[] mpdata = IOUtils.safelyAllocate(mplen, MAX_RECORD_LENGTH);\n                   if (IOUtils.readFully(inp, mpdata) < 0) {\n                      throw new IOException(\"Not enough data to read \" + mplen + \" bytes for attribute name\");\n                   }\n@@ -187,6 +193,9 @@\n             int values = 1;\n             if(isMV || isVL) {\n                values = LittleEndian.readInt(inp);\n+               if (values < 0 || values > MAX_MAPI_VALUES) {\n+                  throw new IOException(\"Corrupt TNEF: unreasonable MAPI value count: \" + values);\n+               }\n             }\n \n             if (type == Types.NULL && values > 1) {\n@@ -228,7 +237,12 @@\n           type == Types.DIRECTORY ||\n           type == Types.BINARY) {\n             // Need to read the length, as it varies\n-            return LittleEndian.readInt(inp);\n+            int len = LittleEndian.readInt(inp);\n+            if (len < 0 || len > MAX_RECORD_LENGTH) {\n+                throw new IOException(\"Corrupt TNEF: declared length \" + len +\n+                                      \" out of bounds (0–\" + MAX_RECORD_LENGTH + \")\");\n+            }\n+            return len;\n       } else {\n             throw new IllegalArgumentException(\"Unknown type \" + type);\n       }\n",
  "stdout": "",
  "stderr": ""
}