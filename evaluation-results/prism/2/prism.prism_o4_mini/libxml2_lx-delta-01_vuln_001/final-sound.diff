--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3571,11 +3571,11 @@
             repl = htmlCodePointToUtf8(cp, utf8Char, &replSize);
         }
 
-        chunkSize = in - chunk;
-        extraSize = chunkSize + replSize;
-
-        if (extraSize > buffer_size) {
-            size_t newSize = (used + extraSize) * 2;
+                chunkSize = in - chunk;
+                extraSize = chunkSize + replSize;
+
+                if ((used + extraSize + 1) > buffer_size) {
+                    size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
             if (tmp == NULL) {
