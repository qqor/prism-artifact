[10/26/25 21:54:28] INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmpslyuqmk6                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/freerdp_fp-full-01_vuln_004/agent-output-1761515668.7262816                                                                         
                             - Detection toml file: /tasks_new/freerdp_fp-full-01/detection/freerdp_fp-full-01_vuln_004.toml                                                                                     
                             - Challenge project directory: /tasks_new/freerdp_fp-full-01/official-afc-freerdp                                                                                                   
                                                                                                                                                                                                                 
                    INFO     [logging_performance](freerdp Building Cached for CLEAN environment) Started...                                                                                context_managers.py:9
('/tasks_new/freerdp_fp-full-01/fuzz-tooling/infra/helper.py build_fuzzers freerdp /tasks_new/freerdp_fp-full-01/official-afc-freerdp --sanitizer address -e CCACHE_DIR="/work/ccache/cache" -e CC="/work/ccache/clang" -e CXX="/work/ccache/clang++"', PosixPath('/tasks_new/freerdp_fp-full-01/official-afc-freerdp'))
[10/26/25 21:55:00] INFO     [logging_performance](freerdp Building Cached for CLEAN environment) Took 31.47 seconds; exception=False                                                      context_managers.py:23
                    INFO     [logging_performance](freerdp Running tests for Cached for CLEAN environment) Started...                                                                       context_managers.py:9
                    INFO     [logging_performance](freerdp Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                                              context_managers.py:23
                    INFO     Setting timeouts                                                                                                                                                       default.py:85
                               - build: 600 (original: 31)                                                                                                                                                       
                               - run tests: 600 (original: 0)                                                                                                                                                    
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 21:55:01] INFO     [logging_performance](freerdp Setting owner) Took 0.96 seconds; exception=False                                                                               context_managers.py:23
[10/26/25 21:55:02] INFO     Successfully created Cached for CLEAN environment                                                                                                                    oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                                                            oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                                                 
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 21:55:03] INFO     [logging_performance](freerdp Setting owner) Took 0.98 seconds; exception=False                                                                               context_managers.py:23
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 21:55:04] INFO     [logging_performance](freerdp Setting owner) Took 0.82 seconds; exception=False                                                                               context_managers.py:23
[10/26/25 21:55:06] INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                                                              
                             ===Evaluator Diff===                                                                                                                                                                
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                             =================================================================                                                                                                                   
                             ==18==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x519000001d60 at pc 0x563dda356d91 bp 0x7ffd89a394d0 sp 0x7ffd89a394c8                                              
                             WRITE of size 8 at 0x519000001d60 thread T0                                                                                                                                         
                             SCARINESS: 42 (8-byte-write-heap-buffer-overflow)                                                                                                                                   
                                 #0 0x563dda356d90 in Stream_Read /src/FreeRDP/winpr/include/winpr/stream.h:703:3                                                                                                
                                 #1 0x563dda356d90 in gcc_read_client_network_data /src/FreeRDP/libfreerdp/core/gcc.c:1875:3                                                                                     
                                 #2 0x563dda356d90 in gcc_read_client_data_blocks /src/FreeRDP/libfreerdp/core/gcc.c:617:10                                                                                      
                                 #3 0x563dda35100b in gcc_read_conference_create_request /src/FreeRDP/libfreerdp/core/gcc.c:414:7                                                                                
                                 #4 0x563dda2992ff in mcs_recv_connect_initial /src/FreeRDP/libfreerdp/core/mcs.c:700:7                                                                                          
                                 #5 0x563dda070efb in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1441:16                                                                         
                                 #6 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #7 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #8 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #9 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #10 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                         
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #11 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                        
                                 #12 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                           
                                 #13 0x563dd9e9255d in _start (/out/TestFuzzCoreServer+0x3d655d)                                                                                                                 
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: Stream_Read--gcc_read_client_network_data--gcc_read_client_data_blocks                                                                                                 
                             0x519000001d60 is located 0 bytes after 992-byte region [0x519000001980,0x519000001d60)                                                                                             
                             allocated by thread T0 here:                                                                                                                                                        
                                 #0 0x563dd9fbb099 in calloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:75:3                                                                                   
                                 #1 0x563dda29e9b6 in mcs_new /src/FreeRDP/libfreerdp/core/mcs.c:1446:34                                                                                                         
                                 #2 0x563dda070ee4 in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1438:16                                                                         
                                 #3 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #4 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #5 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #6 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #7 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #8 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                         
                                 #9 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                            
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: __interceptor_calloc--mcs_new--freerdp_is_valid_mcs_create_request                                                                                                     
                             SUMMARY: AddressSanitizer: heap-buffer-overflow /src/FreeRDP/winpr/include/winpr/stream.h:703:3 in Stream_Read                                                                      
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             =================================================================                                                                                                                   
                             ==18==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x519000001d60 at pc 0x563dda356d91 bp 0x7ffd89a394d0 sp 0x7ffd89a394c8                                              
                             WRITE of size 8 at 0x519000001d60 thread T0                                                                                                                                         
                             SCARINESS: 42 (8-byte-write-heap-buffer-overflow)                                                                                                                                   
                                 #0 0x563dda356d90 in Stream_Read /src/FreeRDP/winpr/include/winpr/stream.h:703:3                                                                                                
                                 #1 0x563dda356d90 in gcc_read_client_network_data /src/FreeRDP/libfreerdp/core/gcc.c:1875:3                                                                                     
                                 #2 0x563dda356d90 in gcc_read_client_data_blocks /src/FreeRDP/libfreerdp/core/gcc.c:617:10                                                                                      
                                 #3 0x563dda35100b in gcc_read_conference_create_request /src/FreeRDP/libfreerdp/core/gcc.c:414:7                                                                                
                                 #4 0x563dda2992ff in mcs_recv_connect_initial /src/FreeRDP/libfreerdp/core/mcs.c:700:7                                                                                          
                                 #5 0x563dda070efb in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1441:16                                                                         
                                 #6 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #7 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #8 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #9 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #10 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                         
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #11 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                        
                                 #12 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                           
                                 #13 0x563dd9e9255d in _start (/out/TestFuzzCoreServer+0x3d655d)                                                                                                                 
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: Stream_Read--gcc_read_client_network_data--gcc_read_client_data_blocks                                                                                                 
                             0x519000001d60 is located 0 bytes after 992-byte region [0x519000001980,0x519000001d60)                                                                                             
                             allocated by thread T0 here:                                                                                                                                                        
                                 #0 0x563dd9fbb099 in calloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:75:3                                                                                   
                                 #1 0x563dda29e9b6 in mcs_new /src/FreeRDP/libfreerdp/core/mcs.c:1446:34                                                                                                         
                                 #2 0x563dda070ee4 in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1438:16                                                                         
                                 #3 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #4 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #5 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #6 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #7 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #8 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                         
                                 #9 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                            
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: __interceptor_calloc--mcs_new--freerdp_is_valid_mcs_create_request                                                                                                     
                             SUMMARY: AddressSanitizer: heap-buffer-overflow /src/FreeRDP/winpr/include/winpr/stream.h:703:3 in Stream_Read                                                                      
                                                                                                                                                                                                                 
                             ===Evaluation Report===                                                                                                                                                             
                                                                                                                                                                                                                 
                             ===Analysis Report===                                                                                                                                                               
                                                                                                                                                                                                                 
                             ===Evaluation End===                                                                                                                                                                
[10/26/25 21:55:16] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                                                  __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/26/25 21:57:25] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                                                     __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
[10/26/25 22:02:25] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                                                  
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 22:02:26] INFO     [logging_performance](freerdp Setting owner) Took 0.87 seconds; exception=False                                                                               context_managers.py:23
                    INFO     [logging_performance](freerdp Patching) Started...                                                                                                             context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmpdw4tmq6_                                                                                                                                 default.py:173
('/tasks_new/freerdp_fp-full-01/fuzz-tooling/infra/helper.py build_fuzzers freerdp /tasks_new/freerdp_fp-full-01/official-afc-freerdp --sanitizer address -e CCACHE_DIR="/work/ccache/cache" -e CC="/work/ccache/clang" -e CXX="/work/ccache/clang++"', PosixPath('/tasks_new/freerdp_fp-full-01/official-afc-freerdp'))
[10/26/25 22:02:49] INFO     [logging_performance](freerdp Patching) Took 23.00 seconds; exception=False                                                                                   context_managers.py:23
                    INFO     [logging_performance](freerdp Checking build) Started...                                                                                                       context_managers.py:9
[10/26/25 22:03:02] INFO     [logging_performance](freerdp Checking build) Took 12.73 seconds; exception=False                                                                             context_managers.py:23
                    INFO     [logging_performance](freerdp Running PoV) Started...                                                                                                          context_managers.py:9
[10/26/25 22:03:05] INFO     [logging_performance](freerdp Running PoV) Took 3.74 seconds; exception=False                                                                                 context_managers.py:23
                    INFO     [logging_performance](freerdp Testing) Started...                                                                                                              context_managers.py:9
                    INFO     [logging_performance](freerdp Testing) Took 0.00 seconds; exception=False                                                                                     context_managers.py:23
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 22:03:06] INFO     [logging_performance](freerdp Setting owner) Took 0.89 seconds; exception=False                                                                               context_managers.py:23
[10/26/25 22:03:07] INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 22:03:08] INFO     [logging_performance](freerdp Setting owner) Took 0.89 seconds; exception=False                                                                               context_managers.py:23
                    INFO     [logging_performance](freerdp Setting owner) Started...                                                                                                        context_managers.py:9
[10/26/25 22:03:09] INFO     [logging_performance](freerdp Setting owner) Took 0.85 seconds; exception=False                                                                               context_managers.py:23
                    INFO     ===Evaluator Result===                                                                                                                                              evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                                                   
                             ===Evaluator Diff===                                                                                                                                                                
                             --- a/libfreerdp/core/gcc.c                                                                                                                                                         
                             +++ b/libfreerdp/core/gcc.c                                                                                                                                                         
                             @@ -1851,16 +1851,20 @@                                                                                                                                                             
                                     WINPR_ASSERT(mcs);                                                                                                                                                          
                                                                                                                                                                                                                 
                                     const size_t blockLength = Stream_GetRemainingLength(s);                                                                                                                    
                             -       if (blockLength < 4)                                                                                                                                                        
                             -               return FALSE;                                                                                                                                                       
                             -                                                                                                                                                                                   
                             -       Stream_Read_UINT8(s, mcs->channelCount); /* channelCount */                                                                                                                 
                             -                                                                                                                                                                                   
                             -       if (blockLength < 4 + (UINT8)mcs->channelCount * 12)                                                                                                                        
                             -               return FALSE;                                                                                                                                                       
                             -                                                                                                                                                                                   
                             -       if (mcs->channelCount > CHANNEL_MAX_COUNT)                                                                                                                                  
                             -               return FALSE;                                                                                                                                                       
                             +       if (blockLength < 1)                                                                                                                                                        
                             +               return FALSE;                                                                                                                                                       
                             +                                                                                                                                                                                   
                             +       UINT8 count = 0;                                                                                                                                                            
                             +       Stream_Read_UINT8(s, count); /* channelCount */                                                                                                                             
                             +                                                                                                                                                                                   
                             +       if (count > CHANNEL_MAX_COUNT)                                                                                                                                              
                             +               return FALSE;                                                                                                                                                       
                             +                                                                                                                                                                                   
                             +       /* name (CHANNEL_NAME_LEN+1) + options (4 bytes) per channel */                                                                                                             
                             +       if ((blockLength - 1) < (size_t)count * (CHANNEL_NAME_LEN + 1 + 4))                                                                                                         
                             +               return FALSE;                                                                                                                                                       
                             +                                                                                                                                                                                   
                             +       mcs->channelCount = count;                                                                                                                                                  
                                                                                                                                                                                                                 
                                     /* channelDefArray */                                                                                                                                                       
                                     for (UINT32 i = 0; i < mcs->channelCount; i++)                                                                                                                              
                                                                                                                                                                                                                 
                             ===Patch Result===                                                                                                                                                                  
                                                                                                                                                                                                                 
                             ===Issue===                                                                                                                                                                         
                             =================================================================                                                                                                                   
                             ==18==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x519000001d60 at pc 0x563dda356d91 bp 0x7ffd89a394d0 sp 0x7ffd89a394c8                                              
                             WRITE of size 8 at 0x519000001d60 thread T0                                                                                                                                         
                             SCARINESS: 42 (8-byte-write-heap-buffer-overflow)                                                                                                                                   
                                 #0 0x563dda356d90 in Stream_Read /src/FreeRDP/winpr/include/winpr/stream.h:703:3                                                                                                
                                 #1 0x563dda356d90 in gcc_read_client_network_data /src/FreeRDP/libfreerdp/core/gcc.c:1875:3                                                                                     
                                 #2 0x563dda356d90 in gcc_read_client_data_blocks /src/FreeRDP/libfreerdp/core/gcc.c:617:10                                                                                      
                                 #3 0x563dda35100b in gcc_read_conference_create_request /src/FreeRDP/libfreerdp/core/gcc.c:414:7                                                                                
                                 #4 0x563dda2992ff in mcs_recv_connect_initial /src/FreeRDP/libfreerdp/core/mcs.c:700:7                                                                                          
                                 #5 0x563dda070efb in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1441:16                                                                         
                                 #6 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #7 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #8 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #9 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #10 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                         
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #11 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                        
                                 #12 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                           
                                 #13 0x563dd9e9255d in _start (/out/TestFuzzCoreServer+0x3d655d)                                                                                                                 
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: Stream_Read--gcc_read_client_network_data--gcc_read_client_data_blocks                                                                                                 
                             0x519000001d60 is located 0 bytes after 992-byte region [0x519000001980,0x519000001d60)                                                                                             
                             allocated by thread T0 here:                                                                                                                                                        
                                 #0 0x563dd9fbb099 in calloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:75:3                                                                                   
                                 #1 0x563dda29e9b6 in mcs_new /src/FreeRDP/libfreerdp/core/mcs.c:1446:34                                                                                                         
                                 #2 0x563dda070ee4 in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1438:16                                                                         
                                 #3 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #4 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #5 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #6 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #7 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #8 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                         
                                 #9 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                            
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: __interceptor_calloc--mcs_new--freerdp_is_valid_mcs_create_request                                                                                                     
                             SUMMARY: AddressSanitizer: heap-buffer-overflow /src/FreeRDP/winpr/include/winpr/stream.h:703:3 in Stream_Read                                                                      
                                                                                                                                                                                                                 
                             ===Evaluation Report===                                                                                                                                                             
                             # Evaluation Report                                                                                                                                                                 
                                                                                                                                                                                                                 
                             ## Summary                                                                                                                                                                          
                                                                                                                                                                                                                 
                             An AddressSanitizer run detected a heap-buffer-overflow in FreeRDP’s server-side connection handling code. The overflow occurs during an 8-byte write in                            
                             Stream_Read (winpr/stream.h:703) when processing a Client MCS (Multipoint Communication Service) Create Request. The buffer was allocated via mcs_new with a size                   
                             of 992 bytes, but the code attempts to read beyond its end.                                                                                                                         
                                                                                                                                                                                                                 
                             ## Description                                                                                                                                                                      
                                                                                                                                                                                                                 
                             - Issue type                                                                                                                                                                        
                               The error is reported as a heap-buffer-overflow (writing 8 bytes past the allocated buffer).                                                                                      
                                                                                                                                                                                                                 
                             - Observations                                                                                                                                                                      
                               • The overflow is triggered in Stream_Read while reading client network data blocks.                                                                                              
                               • Call sequence:                                                                                                                                                                  
                                 1. Stream_Read → winpr/stream.h:703                                                                                                                                             
                                 2. gcc_read_client_network_data → libfreerdp/core/gcc.c:1875                                                                                                                    
                                 3. gcc_read_client_data_blocks → libfreerdp/core/gcc.c:617                                                                                                                      
                                 4. gcc_read_conference_create_request → libfreerdp/core/gcc.c:414                                                                                                               
                                 5. mcs_recv_connect_initial → libfreerdp/core/mcs.c:700                                                                                                                         
                                 6. freerdp_is_valid_mcs_create_request → libfreerdp/core/freerdp.c:1441                                                                                                         
                                 7. Test harness entry via LLVMFuzzerTestOneInput                                                                                                                                
                                                                                                                                                                                                                 
                               • The buffer in question is allocated by mcs_new (libfreerdp/core/mcs.c:1446) via calloc for MCS channel structures and is exactly 992 bytes in size.                             
                               • The overflow write occurs at the byte immediately following the allocated region (offset 992), indicating a missing or incorrect bounds check before reading                    
                             data.                                                                                                                                                                               
                               • The test harness (TestFuzzCoreServer) simply feeds raw input to freerdp_is_valid_mcs_create_request; it is not the root cause but the trigger for the overflow.                 
                                                                                                                                                                                                                 
                             - Code areas to investigate                                                                                                                                                         
                               1. Stream_Read implementation (winpr/include/winpr/stream.h:~703) – verify length checks before reads.                                                                            
                               2. Network data parsing routines in libfreerdp/core/gcc.c:                                                                                                                        
                                  – gcc_read_client_network_data                                                                                                                                                 
                                  – gcc_read_client_data_blocks                                                                                                                                                  
                                  – gcc_read_conference_create_request                                                                                                                                           
                               3. MCS initialization and buffer allocation in libfreerdp/core/mcs.c (mcs_new, mcs_recv_connect_initial).                                                                         
                               4. High-level validation entry freerdp_is_valid_mcs_create_request in libfreerdp/core/freerdp.c to ensure proper size and boundary checks prior to parsing.                       
                                                                                                                                                                                                                 
                             Investigating these areas will give a holistic view of how data lengths are determined, how buffers are allocated, and where bounds verification may be missing or                  
                             incorrect.                                                                                                                                                                          
                                                                                                                                                                                                                 
                             ## Initial Issue Log                                                                                                                                                                
                             Here is the initial issue log of the codebase:                                                                                                                                      
                             <issue>                                                                                                                                                                             
                             =================================================================                                                                                                                   
                             ==18==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x519000001d60 at pc 0x563dda356d91 bp 0x7ffd89a394d0 sp 0x7ffd89a394c8                                              
                             WRITE of size 8 at 0x519000001d60 thread T0                                                                                                                                         
                             SCARINESS: 42 (8-byte-write-heap-buffer-overflow)                                                                                                                                   
                                 #0 0x563dda356d90 in Stream_Read /src/FreeRDP/winpr/include/winpr/stream.h:703:3                                                                                                
                                 #1 0x563dda356d90 in gcc_read_client_network_data /src/FreeRDP/libfreerdp/core/gcc.c:1875:3                                                                                     
                                 #2 0x563dda356d90 in gcc_read_client_data_blocks /src/FreeRDP/libfreerdp/core/gcc.c:617:10                                                                                      
                                 #3 0x563dda35100b in gcc_read_conference_create_request /src/FreeRDP/libfreerdp/core/gcc.c:414:7                                                                                
                                 #4 0x563dda2992ff in mcs_recv_connect_initial /src/FreeRDP/libfreerdp/core/mcs.c:700:7                                                                                          
                                 #5 0x563dda070efb in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1441:16                                                                         
                                 #6 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #7 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #8 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #9 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #10 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                         
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #11 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                        
                                 #12 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                           
                                 #13 0x563dd9e9255d in _start (/out/TestFuzzCoreServer+0x3d655d)                                                                                                                 
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: Stream_Read--gcc_read_client_network_data--gcc_read_client_data_blocks                                                                                                 
                             0x519000001d60 is located 0 bytes after 992-byte region [0x519000001980,0x519000001d60)                                                                                             
                             allocated by thread T0 here:                                                                                                                                                        
                                 #0 0x563dd9fbb099 in calloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:75:3                                                                                   
                                 #1 0x563dda29e9b6 in mcs_new /src/FreeRDP/libfreerdp/core/mcs.c:1446:34                                                                                                         
                                 #2 0x563dda070ee4 in freerdp_is_valid_mcs_create_request /src/FreeRDP/libfreerdp/core/freerdp.c:1438:16                                                                         
                                 #3 0x563dd9ff8785 in test_server /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:82:3                                                                                    
                                 #4 0x563dd9ff8785 in LLVMFuzzerTestOneInput /src/FreeRDP/libfreerdp/core/test/TestFuzzCoreServer.c:106:2                                                                        
                                 #5 0x563dd9eaf100 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                        
                                 #6 0x563dd9e9a375 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                            
                                 #7 0x563dd9e9fe0f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                                                     
                                 #8 0x563dd9ecb0b2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                                                         
                                 #9 0x7f4cb2668082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 5792732f783158c66fb4f3756458ca24e46e827d)                                            
                                                                                                                                                                                                                 
                             DEDUP_TOKEN: __interceptor_calloc--mcs_new--freerdp_is_valid_mcs_create_request                                                                                                     
                             SUMMARY: AddressSanitizer: heap-buffer-overflow /src/FreeRDP/winpr/include/winpr/stream.h:703:3 in Stream_Read                                                                      
                                                                                                                                                                                                                 
                             </issue>                                                                                                                                                                            
                             ===Analysis Report===                                                                                                                                                               
                             # Analysis Report                                                                                                                                                                   
                                                                                                                                                                                                                 
                             ## Relevant Code Snippets                                                                                                                                                           
                             <code_snippets>                                                                                                                                                                     
                             <code>                                                                                                                                                                              
                             winpr/include/winpr/stream.h:650-740                                                                                                                                                
                             ```                                                                                                                                                                                 
                             650:#define Stream_Read_UINT32(_s, _v)         \                                                                                                                                    
                             651:    do                                     \                                                                                                                                    
                             652:    {                                      \                                                                                                                                    
                             653:            _v = stream_read_u32_le(_s, TRUE); \                                                                                                                                
                             654:    } while (0)                                                                                                                                                                 
                             655:                                                                                                                                                                                
                             656:#define Stream_Read_INT32(_s, _v)          \                                                                                                                                    
                             657:    do                                     \                                                                                                                                    
                             658:    {                                      \                                                                                                                                    
                             659:            _v = stream_read_i32_le(_s, TRUE); \                                                                                                                                
                             660:    } while (0)                                                                                                                                                                 
                             661:                                                                                                                                                                                
                             662:#define Stream_Read_UINT32_BE(_s, _v)      \                                                                                                                                    
                             663:    do                                     \                                                                                                                                    
                             664:    {                                      \                                                                                                                                    
                             665:            _v = stream_read_u32_be(_s, TRUE); \                                                                                                                                
                             666:    } while (0)                                                                                                                                                                 
                             667:                                                                                                                                                                                
                             668:#define Stream_Read_INT32_BE(_s, _v)       \                                                                                                                                    
                             669:    do                                     \                                                                                                                                    
                             670:    {                                      \                                                                                                                                    
                             671:            _v = stream_read_i32_be(_s, TRUE); \                                                                                                                                
                             672:    } while (0)                                                                                                                                                                 
                             673:                                                                                                                                                                                
                             674:#define Stream_Read_UINT64(_s, _v)         \                                                                                                                                    
                             675:    do                                     \                                                                                                                                    
                             676:    {                                      \                                                                                                                                    
                             677:            _v = stream_read_u64_le(_s, TRUE); \                                                                                                                                
                             678:    } while (0)                                                                                                                                                                 
                             679:                                                                                                                                                                                
                             680:#define Stream_Read_INT64(_s, _v)          \                                                                                                                                    
                             681:    do                                     \                                                                                                                                    
                             682:    {                                      \                                                                                                                                    
                             683:            _v = stream_read_i64_le(_s, TRUE); \                                                                                                                                
                             684:    } while (0)                                                                                                                                                                 
                             685:                                                                                                                                                                                
                             686:#define Stream_Read_UINT64_BE(_s, _v)      \                                                                                                                                    
                             687:    do                                     \                                                                                                                                    
                             688:    {                                      \                                                                                                                                    
                             689:            _v = stream_read_u64_be(_s, TRUE); \                                                                                                                                
                             690:    } while (0)                                                                                                                                                                 
                             691:                                                                                                                                                                                
                             692:#define Stream_Read_INT64_BE(_s, _v)       \                                                                                                                                    
                             693:    do                                     \                                                                                                                                    
                             694:    {                                      \                                                                                                                                    
                             695:            _v = stream_read_i64_be(_s, TRUE); \                                                                                                                                
                             696:    } while (0)                                                                                                                                                                 
                             697:                                                                                                                                                                                
                             698:    static INLINE void Stream_Read(wStream* _s, void* _b, size_t _n)                                                                                                            
                             699:    {                                                                                                                                                                           
                             700:            WINPR_ASSERT(_s);                                                                                                                                                   
                             701:            WINPR_ASSERT(_b || (_n == 0));                                                                                                                                      
                             702:            WINPR_ASSERT(Stream_GetRemainingCapacity(_s) >= _n);                                                                                                                
                             703:            memcpy(_b, (_s->pointer), (_n));                                                                                                                                    
                             704:            Stream_Seek(_s, _n);                                                                                                                                                
                             705:    }                                                                                                                                                                           
                             706:                                                                                                                                                                                
                             707:#define Stream_Peek_UINT8(_s, _v)       \                                                                                                                                       
                             708:    do                                  \                                                                                                                                       
                             709:    {                                   \                                                                                                                                       
                             710:            _v = stream_read_u8(_s, FALSE); \                                                                                                                                   
                             711:    } while (0)                                                                                                                                                                 
                             712:                                                                                                                                                                                
                             713:#define Stream_Peek_INT8(_s, _v)        \                                                                                                                                       
                             714:    do                                  \                                                                                                                                       
                             715:    {                                   \                                                                                                                                       
                             716:            _v = stream_read_i8(_s, FALSE); \                                                                                                                                   
                             717:    } while (0)                                                                                                                                                                 
                             718:                                                                                                                                                                                
                             719:#define Stream_Peek_UINT16(_s, _v)          \                                                                                                                                   
                             720:    do                                      \                                                                                                                                   
                             721:    {                                       \                                                                                                                                   
                             722:            _v = stream_read_u16_le(_s, FALSE); \                                                                                                                               
                             723:    } while (0)                                                                                                                                                                 
                             724:                                                                                                                                                                                
                             725:#define Stream_Peek_INT16(_s, _v)           \                                                                                                                                   
                             726:    do                                      \                                                                                                                                   
                             727:    {                                       \                                                                                                                                   
                             728:            _v = stream_read_i16_le(_s, FALSE); \                                                                                                                               
                             729:    } while (0)                                                                                                                                                                 
                             730:                                                                                                                                                                                
                             731:#define Stream_Peek_UINT16_BE(_s, _v)       \                                                                                                                                   
                             732:    do                                      \                                                                                                                                   
                             733:    {                                       \                                                                                                                                   
                             734:            _v = stream_read_u16_be(_s, FALSE); \                                                                                                                               
                             735:    } while (0)                                                                                                                                                                 
                             736:                                                                                                                                                                                
                             737:#define Stream_Peek_INT16_BE(_s, _v)        \                                                                                                                                   
                             738:    do                                      \                                                                                                                                   
                             739:    {                                       \                                                                                                                                   
                             740:            _v = stream_read_i16_be(_s, FALSE); \                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.c:1420-1497                                                                                                                                                     
                             ```                                                                                                                                                                                 
                             1420:                                                                                                                                                                               
                             1421:   return TRUE;                                                                                                                                                                
                             1422:}                                                                                                                                                                              
                             1423:                                                                                                                                                                               
                             1424:/**                                                                                                                                                                            
                             1425: * Instantiate new MCS module.                                                                                                                                                 
                             1426: * @param transport transport                                                                                                                                                  
                             1427: * @return new MCS module                                                                                                                                                      
                             1428: */                                                                                                                                                                            
                             1429:                                                                                                                                                                               
                             1430:rdpMcs* mcs_new(rdpTransport* transport)                                                                                                                                       
                             1431:{                                                                                                                                                                              
                             1432:   rdpMcs* mcs = NULL;                                                                                                                                                         
                             1433:                                                                                                                                                                               
                             1434:   mcs = (rdpMcs*)calloc(1, sizeof(rdpMcs));                                                                                                                                   
                             1435:                                                                                                                                                                               
                             1436:   if (!mcs)                                                                                                                                                                   
                             1437:           return NULL;                                                                                                                                                        
                             1438:                                                                                                                                                                               
                             1439:   mcs->transport = transport;                                                                                                                                                 
                             1440:   mcs_init_domain_parameters(&mcs->targetParameters, 34, 2, 0, 0xFFFF);                                                                                                       
                             1441:   mcs_init_domain_parameters(&mcs->minimumParameters, 1, 1, 1, 0x420);                                                                                                        
                             1442:   mcs_init_domain_parameters(&mcs->maximumParameters, 0xFFFF, 0xFC17, 0xFFFF, 0xFFFF);                                                                                        
                             1443:   mcs_init_domain_parameters(&mcs->domainParameters, 0, 0, 0, 0xFFFF);                                                                                                        
                             1444:   mcs->channelCount = 0;                                                                                                                                                      
                             1445:   mcs->baseChannelId = MCS_GLOBAL_CHANNEL_ID + 1;                                                                                                                             
                             1446:   mcs->channels = (rdpMcsChannel*)calloc(CHANNEL_MAX_COUNT, sizeof(rdpMcsChannel));                                                                                           
                             1447:                                                                                                                                                                               
                             1448:   if (!mcs->channels)                                                                                                                                                         
                             1449:           goto out_free;                                                                                                                                                      
                             1450:                                                                                                                                                                               
                             1451:   return mcs;                                                                                                                                                                 
                             1452:out_free:                                                                                                                                                                      
                             1453:   free(mcs);                                                                                                                                                                  
                             1454:   return NULL;                                                                                                                                                                
                             1455:}                                                                                                                                                                              
                             1456:                                                                                                                                                                               
                             1457:/**                                                                                                                                                                            
                             1458: * Free MCS module.                                                                                                                                                            
                             1459: * @param mcs MCS module to be freed                                                                                                                                           
                             1460: */                                                                                                                                                                            
                             1461:                                                                                                                                                                               
                             1462:void mcs_free(rdpMcs* mcs)                                                                                                                                                     
                             1463:{                                                                                                                                                                              
                             1464:   if (mcs)                                                                                                                                                                    
                             1465:   {                                                                                                                                                                           
                             1466:           free(mcs->channels);                                                                                                                                                
                             1467:           free(mcs);                                                                                                                                                          
                             1468:   }                                                                                                                                                                           
                             1469:}                                                                                                                                                                              
                             1470:                                                                                                                                                                               
                             1471:BOOL mcs_server_apply_to_settings(const rdpMcs* mcs, rdpSettings* settings)                                                                                                    
                             1472:{                                                                                                                                                                              
                             1473:   BOOL rc = FALSE;                                                                                                                                                            
                             1474:                                                                                                                                                                               
                             1475:   WINPR_ASSERT(mcs);                                                                                                                                                          
                             1476:   WINPR_ASSERT(settings);                                                                                                                                                     
                             1477:                                                                                                                                                                               
                             1478:   if (!freerdp_settings_set_uint32(settings, FreeRDP_ChannelCount, mcs->channelCount))                                                                                        
                             1479:           goto fail;                                                                                                                                                          
                             1480:                                                                                                                                                                               
                             1481:   for (UINT32 x = 0; x < mcs->channelCount; x++)                                                                                                                              
                             1482:   {                                                                                                                                                                           
                             1483:           const rdpMcsChannel* current = &mcs->channels[x];                                                                                                                   
                             1484:           CHANNEL_DEF def = { 0 };                                                                                                                                            
                             1485:           def.options = current->options;                                                                                                                                     
                             1486:           memcpy(def.name, current->Name, sizeof(def.name));                                                                                                                  
                             1487:           if (!freerdp_settings_set_pointer_array(settings, FreeRDP_ChannelDefArray, x, &def))                                                                                
                             1488:                   goto fail;                                                                                                                                                  
                             1489:   }                                                                                                                                                                           
                             1490:                                                                                                                                                                               
                             1491:   rc = TRUE;                                                                                                                                                                  
                             1492:fail:                                                                                                                                                                          
                             1493:   if (!rc)                                                                                                                                                                    
                             1494:           WLog_WARN(TAG, "failed to apply settings");                                                                                                                         
                             1495:                                                                                                                                                                               
                             1496:   return rc;                                                                                                                                                                  
                             1497:}                                                                                                                                                                              
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.c:680-740                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             680:    /* upwardFlag (BOOLEAN) */                                                                                                                                                  
                             681:    if (!ber_read_BOOL(s, &upwardFlag))                                                                                                                                         
                             682:            return FALSE;                                                                                                                                                       
                             683:                                                                                                                                                                                
                             684:    /* targetParameters (DomainParameters) */                                                                                                                                   
                             685:    if (!mcs_read_domain_parameters(s, &mcs->targetParameters))                                                                                                                 
                             686:            return FALSE;                                                                                                                                                       
                             687:                                                                                                                                                                                
                             688:    /* minimumParameters (DomainParameters) */                                                                                                                                  
                             689:    if (!mcs_read_domain_parameters(s, &mcs->minimumParameters))                                                                                                                
                             690:            return FALSE;                                                                                                                                                       
                             691:                                                                                                                                                                                
                             692:    /* maximumParameters (DomainParameters) */                                                                                                                                  
                             693:    if (!mcs_read_domain_parameters(s, &mcs->maximumParameters))                                                                                                                
                             694:            return FALSE;                                                                                                                                                       
                             695:                                                                                                                                                                                
                             696:    if (!ber_read_octet_string_tag(s, &length) ||                                                                                                                               
                             697:        (!Stream_CheckAndLogRequiredLength(TAG, s, length)))                                                                                                                    
                             698:            return FALSE;                                                                                                                                                       
                             699:                                                                                                                                                                                
                             700:    if (!gcc_read_conference_create_request(s, mcs))                                                                                                                            
                             701:            return FALSE;                                                                                                                                                       
                             702:                                                                                                                                                                                
                             703:    if (!mcs_merge_domain_parameters(&mcs->targetParameters, &mcs->minimumParameters,                                                                                           
                             704:                                     &mcs->maximumParameters, &mcs->domainParameters))                                                                                          
                             705:            return FALSE;                                                                                                                                                       
                             706:                                                                                                                                                                                
                             707:    return tpkt_ensure_stream_consumed(s, tlength);                                                                                                                             
                             708:}                                                                                                                                                                               
                             709:                                                                                                                                                                                
                             710:/**                                                                                                                                                                             
                             711: * Write an MCS Connect Initial PDU.                                                                                                                                            
                             712: * msdn{cc240508}                                                                                                                                                               
                             713: * @param s stream                                                                                                                                                              
                             714: * @param mcs MCS module                                                                                                                                                        
                             715: * @param userData GCC Conference Create Request                                                                                                                                
                             716: */                                                                                                                                                                             
                             717:                                                                                                                                                                                
                             718:BOOL mcs_write_connect_initial(wStream* s, rdpMcs* mcs, wStream* userData)                                                                                                      
                             719:{                                                                                                                                                                               
                             720:    size_t length = 0;                                                                                                                                                          
                             721:    wStream* tmps = NULL;                                                                                                                                                       
                             722:    BOOL ret = FALSE;                                                                                                                                                           
                             723:                                                                                                                                                                                
                             724:    if (!s || !mcs || !userData)                                                                                                                                                
                             725:            return FALSE;                                                                                                                                                       
                             726:                                                                                                                                                                                
                             727:    tmps = Stream_New(NULL, Stream_Capacity(s));                                                                                                                                
                             728:                                                                                                                                                                                
                             729:    if (!tmps)                                                                                                                                                                  
                             730:    {                                                                                                                                                                           
                             731:            WLog_ERR(TAG, "Stream_New failed!");                                                                                                                                
                             732:            return FALSE;                                                                                                                                                       
                             733:    }                                                                                                                                                                           
                             734:                                                                                                                                                                                
                             735:    /* callingDomainSelector (OCTET_STRING) */                                                                                                                                  
                             736:    ber_write_octet_string(tmps, callingDomainSelector, sizeof(callingDomainSelector));                                                                                         
                             737:    /* calledDomainSelector (OCTET_STRING) */                                                                                                                                   
                             738:    ber_write_octet_string(tmps, calledDomainSelector, sizeof(calledDomainSelector));                                                                                           
                             739:    /* upwardFlag (BOOLEAN) */                                                                                                                                                  
                             740:    ber_write_BOOL(tmps, TRUE);                                                                                                                                                 
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.c:380-460                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             380:    /* ConnectGCCPDU */                                                                                                                                                         
                             381:    if (!per_read_choice(s, &choice))                                                                                                                                           
                             382:            return FALSE;                                                                                                                                                       
                             383:                                                                                                                                                                                
                             384:    if (!per_read_selection(s, &selection))                                                                                                                                     
                             385:            return FALSE;                                                                                                                                                       
                             386:                                                                                                                                                                                
                             387:    /* ConferenceCreateRequest::conferenceName */                                                                                                                               
                             388:    if (!per_read_numeric_string(s, 1)) /* ConferenceName::numeric */                                                                                                           
                             389:            return FALSE;                                                                                                                                                       
                             390:                                                                                                                                                                                
                             391:    if (!per_read_padding(s, 1)) /* padding */                                                                                                                                  
                             392:            return FALSE;                                                                                                                                                       
                             393:                                                                                                                                                                                
                             394:    /* UserData (SET OF SEQUENCE) */                                                                                                                                            
                             395:    if (!per_read_number_of_sets(s, &number) || number != 1) /* one set of UserData */                                                                                          
                             396:            return FALSE;                                                                                                                                                       
                             397:                                                                                                                                                                                
                             398:    if (!per_read_choice(s, &choice) ||                                                                                                                                         
                             399:        choice != 0xC0) /* UserData::value present + select h221NonStandard (1) */                                                                                              
                             400:            return FALSE;                                                                                                                                                       
                             401:                                                                                                                                                                                
                             402:    /* h221NonStandard */                                                                                                                                                       
                             403:    if (!per_read_octet_string(s, h221_cs_key, 4,                                                                                                                               
                             404:                               4)) /* h221NonStandard, client-to-server H.221 key, "Duca" */                                                                                    
                             405:            return FALSE;                                                                                                                                                       
                             406:                                                                                                                                                                                
                             407:    /* userData::value (OCTET_STRING) */                                                                                                                                        
                             408:    if (!per_read_length(s, &length))                                                                                                                                           
                             409:            return FALSE;                                                                                                                                                       
                             410:                                                                                                                                                                                
                             411:    if (!Stream_CheckAndLogRequiredLength(TAG, s, length))                                                                                                                      
                             412:            return FALSE;                                                                                                                                                       
                             413:                                                                                                                                                                                
                             414:    if (!gcc_read_client_data_blocks(s, mcs, length))                                                                                                                           
                             415:            return FALSE;                                                                                                                                                       
                             416:                                                                                                                                                                                
                             417:    return TRUE;                                                                                                                                                                
                             418:}                                                                                                                                                                               
                             419:                                                                                                                                                                                
                             420:/**                                                                                                                                                                             
                             421: * Write a GCC Conference Create Request.                                                                                                                                       
                             422: * msdn{cc240836}                                                                                                                                                               
                             423: *                                                                                                                                                                              
                             424: * @param s stream                                                                                                                                                              
                             425: * @param userData client data blocks                                                                                                                                           
                             426: *                                                                                                                                                                              
                             427: * @return \b TRUE for success, \b FALSE otherwise                                                                                                                              
                             428: */                                                                                                                                                                             
                             429:                                                                                                                                                                                
                             430:BOOL gcc_write_conference_create_request(wStream* s, wStream* userData)                                                                                                         
                             431:{                                                                                                                                                                               
                             432:    WINPR_ASSERT(s);                                                                                                                                                            
                             433:    WINPR_ASSERT(userData);                                                                                                                                                     
                             434:    /* ConnectData */                                                                                                                                                           
                             435:    if (!per_write_choice(s, 0)) /* From Key select object (0) of type OBJECT_IDENTIFIER */                                                                                     
                             436:            return FALSE;                                                                                                                                                       
                             437:    if (!per_write_object_identifier(s, t124_02_98_oid)) /* ITU-T T.124 (02/98) OBJECT_IDENTIFIER */                                                                            
                             438:            return FALSE;                                                                                                                                                       
                             439:    /* ConnectData::connectPDU (OCTET_STRING) */                                                                                                                                
                             440:    const size_t pos = Stream_GetPosition(userData);                                                                                                                            
                             441:    WINPR_ASSERT(pos <= UINT16_MAX - 14);                                                                                                                                       
                             442:    if (!per_write_length(s, (UINT16)pos + 14)) /* connectPDU length */                                                                                                         
                             443:            return FALSE;                                                                                                                                                       
                             444:    /* ConnectGCCPDU */                                                                                                                                                         
                             445:    if (!per_write_choice(s, 0)) /* From ConnectGCCPDU select conferenceCreateRequest (0) of type                                                                               
                             446:                                     ConferenceCreateRequest */                                                                                                                 
                             447:            return FALSE;                                                                                                                                                       
                             448:    if (!per_write_selection(s, 0x08)) /* select optional userData from ConferenceCreateRequest */                                                                              
                             449:            return FALSE;                                                                                                                                                       
                             450:    /* ConferenceCreateRequest::conferenceName */                                                                                                                               
                             451:    if (!per_write_numeric_string(s, (BYTE*)"1", 1, 1)) /* ConferenceName::numeric */                                                                                           
                             452:            return FALSE;                                                                                                                                                       
                             453:    if (!per_write_padding(s, 1)) /* padding */                                                                                                                                 
                             454:            return FALSE;                                                                                                                                                       
                             455:    /* UserData (SET OF SEQUENCE) */                                                                                                                                            
                             456:    if (!per_write_number_of_sets(s, 1)) /* one set of UserData */                                                                                                              
                             457:            return FALSE;                                                                                                                                                       
                             458:    if (!per_write_choice(s, 0xC0)) /* UserData::value present + select h221NonStandard (1) */                                                                                  
                             459:            return FALSE;                                                                                                                                                       
                             460:    /* h221NonStandard */                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.c:600-680                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             600:            Stream_Seek(s, blockLength - 4);                                                                                                                                    
                             601:                                                                                                                                                                                
                             602:            switch (type)                                                                                                                                                       
                             603:            {                                                                                                                                                                   
                             604:                    case CS_CORE:                                                                                                                                               
                             605:                            if (!gcc_read_client_core_data(sub, mcs))                                                                                                           
                             606:                                    return FALSE;                                                                                                                               
                             607:                                                                                                                                                                                
                             608:                            break;                                                                                                                                              
                             609:                                                                                                                                                                                
                             610:                    case CS_SECURITY:                                                                                                                                           
                             611:                            if (!gcc_read_client_security_data(sub, mcs))                                                                                                       
                             612:                                    return FALSE;                                                                                                                               
                             613:                                                                                                                                                                                
                             614:                            break;                                                                                                                                              
                             615:                                                                                                                                                                                
                             616:                    case CS_NET:                                                                                                                                                
                             617:                            if (!gcc_read_client_network_data(sub, mcs))                                                                                                        
                             618:                                    return FALSE;                                                                                                                               
                             619:                                                                                                                                                                                
                             620:                            break;                                                                                                                                              
                             621:                                                                                                                                                                                
                             622:                    case CS_CLUSTER:                                                                                                                                            
                             623:                            if (!gcc_read_client_cluster_data(sub, mcs))                                                                                                        
                             624:                                    return FALSE;                                                                                                                               
                             625:                                                                                                                                                                                
                             626:                            break;                                                                                                                                              
                             627:                                                                                                                                                                                
                             628:                    case CS_MONITOR:                                                                                                                                            
                             629:                            if (!gcc_read_client_monitor_data(sub, mcs))                                                                                                        
                             630:                                    return FALSE;                                                                                                                               
                             631:                                                                                                                                                                                
                             632:                            break;                                                                                                                                              
                             633:                                                                                                                                                                                
                             634:                    case CS_MCS_MSGCHANNEL:                                                                                                                                     
                             635:                            if (!gcc_read_client_message_channel_data(sub, mcs))                                                                                                
                             636:                                    return FALSE;                                                                                                                               
                             637:                                                                                                                                                                                
                             638:                            break;                                                                                                                                              
                             639:                                                                                                                                                                                
                             640:                    case CS_MONITOR_EX:                                                                                                                                         
                             641:                            if (!gcc_read_client_monitor_extended_data(sub, mcs))                                                                                               
                             642:                                    return FALSE;                                                                                                                               
                             643:                                                                                                                                                                                
                             644:                            break;                                                                                                                                              
                             645:                                                                                                                                                                                
                             646:                    case CS_UNUSED1:                                                                                                                                            
                             647:                            if (!gcc_read_client_unused1_data(sub))                                                                                                             
                             648:                                    return FALSE;                                                                                                                               
                             649:                                                                                                                                                                                
                             650:                            break;                                                                                                                                              
                             651:                                                                                                                                                                                
                             652:                    case 0xC009:                                                                                                                                                
                             653:                    case CS_MULTITRANSPORT:                                                                                                                                     
                             654:                            gotMultitransport = TRUE;                                                                                                                           
                             655:                            if (!gcc_read_client_multitransport_channel_data(sub, mcs))                                                                                         
                             656:                                    return FALSE;                                                                                                                               
                             657:                                                                                                                                                                                
                             658:                            break;                                                                                                                                              
                             659:                                                                                                                                                                                
                             660:                    default:                                                                                                                                                    
                             661:                            WLog_ERR(TAG, "Unknown GCC client data block: 0x%04" PRIX16 "", type);                                                                              
                             662:                            winpr_HexDump(TAG, WLOG_TRACE, Stream_Pointer(sub), Stream_GetRemainingLength(sub));                                                                
                             663:                            break;                                                                                                                                              
                             664:            }                                                                                                                                                                   
                             665:                                                                                                                                                                                
                             666:            const size_t rem = Stream_GetRemainingLength(sub);                                                                                                                  
                             667:            if (rem > 0)                                                                                                                                                        
                             668:            {                                                                                                                                                                   
                             669:                    char buffer[128] = { 0 };                                                                                                                                   
                             670:                    const size_t total = Stream_Length(sub);                                                                                                                    
                             671:                    WLog_ERR(TAG,                                                                                                                                               
                             672:                             "Error parsing GCC client data block %s: Actual Offset: %" PRIuz                                                                                   
                             673:                             " Expected Offset: %" PRIuz,                                                                                                                       
                             674:                             gcc_block_type_string(type, buffer, sizeof(buffer)), total - rem, total);                                                                          
                             675:            }                                                                                                                                                                   
                             676:                                                                                                                                                                                
                             677:            if (blockLength > length)                                                                                                                                           
                             678:            {                                                                                                                                                                   
                             679:                    char buffer[128] = { 0 };                                                                                                                                   
                             680:                    WLog_ERR(TAG,                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.c:1840-1900                                                                                                                                                     
                             ```                                                                                                                                                                                 
                             1840: * msdn{cc240512}                                                                                                                                                              
                             1841: *                                                                                                                                                                             
                             1842: * @param s stream                                                                                                                                                             
                             1843: * @param mcs The MCS instance                                                                                                                                                 
                             1844: *                                                                                                                                                                             
                             1845: * @return \b TRUE for success, \b FALSE otherwise                                                                                                                             
                             1846: */                                                                                                                                                                            
                             1847:                                                                                                                                                                               
                             1848:BOOL gcc_read_client_network_data(wStream* s, rdpMcs* mcs)                                                                                                                     
                             1849:{                                                                                                                                                                              
                             1850:   WINPR_ASSERT(s);                                                                                                                                                            
                             1851:   WINPR_ASSERT(mcs);                                                                                                                                                          
                             1852:                                                                                                                                                                               
                             1853:   const size_t blockLength = Stream_GetRemainingLength(s);                                                                                                                    
                             1854:   if (blockLength < 4)                                                                                                                                                        
                             1855:           return FALSE;                                                                                                                                                       
                             1856:                                                                                                                                                                               
                             1857:   Stream_Read_UINT8(s, mcs->channelCount); /* channelCount */                                                                                                                 
                             1858:                                                                                                                                                                               
                             1859:   if (blockLength < 4 + (UINT8)mcs->channelCount * 12)                                                                                                                        
                             1860:           return FALSE;                                                                                                                                                       
                             1861:                                                                                                                                                                               
                             1862:   if (mcs->channelCount > CHANNEL_MAX_COUNT)                                                                                                                                  
                             1863:           return FALSE;                                                                                                                                                       
                             1864:                                                                                                                                                                               
                             1865:   /* channelDefArray */                                                                                                                                                       
                             1866:   for (UINT32 i = 0; i < mcs->channelCount; i++)                                                                                                                              
                             1867:   {                                                                                                                                                                           
                             1868:           /**                                                                                                                                                                 
                             1869:            * CHANNEL_DEF                                                                                                                                                      
                             1870:            * - name: an 8-byte array containing a null-terminated collection                                                                                                  
                             1871:            *   of seven ANSI characters that uniquely identify the channel.                                                                                                   
                             1872:            * - options: a 32-bit, unsigned integer. Channel option flags                                                                                                      
                             1873:            */                                                                                                                                                                 
                             1874:           rdpMcsChannel* channel = &mcs->channels[i];                                                                                                                         
                             1875:           Stream_Read(s, channel->Name, CHANNEL_NAME_LEN + 1); /* name (8 bytes) */                                                                                           
                             1876:                                                                                                                                                                               
                             1877:           if (!memchr(channel->Name, 0, CHANNEL_NAME_LEN + 1))                                                                                                                
                             1878:           {                                                                                                                                                                   
                             1879:                   WLog_ERR(                                                                                                                                                   
                             1880:                       TAG,                                                                                                                                                    
                             1881:                       "protocol violation: received a static channel name with missing null-termination");                                                                    
                             1882:                   return FALSE;                                                                                                                                               
                             1883:           }                                                                                                                                                                   
                             1884:                                                                                                                                                                               
                             1885:           Stream_Read_UINT32(s, channel->options); /* options (4 bytes) */                                                                                                    
                             1886:           channel->ChannelId = mcs->baseChannelId++;                                                                                                                          
                             1887:   }                                                                                                                                                                           
                             1888:                                                                                                                                                                               
                             1889:   return TRUE;                                                                                                                                                                
                             1890:}                                                                                                                                                                              
                             1891:                                                                                                                                                                               
                             1892:/**                                                                                                                                                                            
                             1893: * Write a client network data block (TS_UD_CS_NET).                                                                                                                           
                             1894: * msdn{cc240512}                                                                                                                                                              
                             1895: * @param s stream                                                                                                                                                             
                             1896: * @param mcs The MCS to use                                                                                                                                                   
                             1897: *                                                                                                                                                                             
                             1898: * @return \b TRUE for success, \b FALSE otherwise                                                                                                                             
                             1899: */                                                                                                                                                                            
                             1900:                                                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             winpr/include/winpr/stream.h:600-650                                                                                                                                                
                             ```                                                                                                                                                                                 
                             600:            return stream_read_u64_be(_s, FALSE);                                                                                                                               
                             601:    }                                                                                                                                                                           
                             602:                                                                                                                                                                                
                             603:    /**                                                                                                                                                                         
                             604:     * @brief Read a INT64 big endian from the stream, do not increment stream position                                                                                         
                             605:     * @param _s The stream to read from                                                                                                                                        
                             606:     * @return an integer                                                                                                                                                       
                             607:     * @since version 3.9.0                                                                                                                                                     
                             608:     */                                                                                                                                                                         
                             609:    static INLINE INT64 Stream_Peek_Get_INT64_BE(wStream* _s)                                                                                                                   
                             610:    {                                                                                                                                                                           
                             611:            return stream_read_i64_be(_s, FALSE);                                                                                                                               
                             612:    }                                                                                                                                                                           
                             613:                                                                                                                                                                                
                             614:#define Stream_Read_UINT8(_s, _v)      \                                                                                                                                        
                             615:    do                                 \                                                                                                                                        
                             616:    {                                  \                                                                                                                                        
                             617:            _v = stream_read_u8(_s, TRUE); \                                                                                                                                    
                             618:    } while (0)                                                                                                                                                                 
                             619:                                                                                                                                                                                
                             620:#define Stream_Read_INT8(_s, _v)       \                                                                                                                                        
                             621:    do                                 \                                                                                                                                        
                             622:    {                                  \                                                                                                                                        
                             623:            _v = stream_read_i8(_s, TRUE); \                                                                                                                                    
                             624:    } while (0)                                                                                                                                                                 
                             625:                                                                                                                                                                                
                             626:#define Stream_Read_UINT16(_s, _v)         \                                                                                                                                    
                             627:    do                                     \                                                                                                                                    
                             628:    {                                      \                                                                                                                                    
                             629:            _v = stream_read_u16_le(_s, TRUE); \                                                                                                                                
                             630:    } while (0)                                                                                                                                                                 
                             631:                                                                                                                                                                                
                             632:#define Stream_Read_INT16(_s, _v)          \                                                                                                                                    
                             633:    do                                     \                                                                                                                                    
                             634:    {                                      \                                                                                                                                    
                             635:            _v = stream_read_i16_le(_s, TRUE); \                                                                                                                                
                             636:    } while (0)                                                                                                                                                                 
                             637:                                                                                                                                                                                
                             638:#define Stream_Read_UINT16_BE(_s, _v)      \                                                                                                                                    
                             639:    do                                     \                                                                                                                                    
                             640:    {                                      \                                                                                                                                    
                             641:            _v = stream_read_u16_be(_s, TRUE); \                                                                                                                                
                             642:    } while (0)                                                                                                                                                                 
                             643:                                                                                                                                                                                
                             644:#define Stream_Read_INT16_BE(_s, _v)       \                                                                                                                                    
                             645:    do                                     \                                                                                                                                    
                             646:    {                                      \                                                                                                                                    
                             647:            _v = stream_read_i16_be(_s, TRUE); \                                                                                                                                
                             648:    } while (0)                                                                                                                                                                 
                             649:                                                                                                                                                                                
                             650:#define Stream_Read_UINT32(_s, _v)         \                                                                                                                                    
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.h:1-100                                                                                                                                                         
                             ```                                                                                                                                                                                 
                             1:/**                                                                                                                                                                               
                             2: * FreeRDP: A Remote Desktop Protocol Implementation                                                                                                                              
                             3: * T.125 Multipoint Communication Service (MCS) Protocol                                                                                                                          
                             4: *                                                                                                                                                                                
                             5: * Copyright 2011 Marc-Andre Moreau <marcandre.moreau@gmail.com>                                                                                                                  
                             6: * Copyright 2015 Thincast Technologies GmbH                                                                                                                                      
                             7: * Copyright 2015 DI (FH) Martin Haimberger <martin.haimberger@thincast.com>                                                                                                      
                             8: *                                                                                                                                                                                
                             9: * Licensed under the Apache License, Version 2.0 (the "License");                                                                                                                
                             10: * you may not use this file except in compliance with the License.                                                                                                              
                             11: * You may obtain a copy of the License at                                                                                                                                       
                             12: *                                                                                                                                                                               
                             13: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             14: *                                                                                                                                                                               
                             15: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             16: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             17: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             18: * See the License for the specific language governing permissions and                                                                                                           
                             19: * limitations under the License.                                                                                                                                                
                             20: */                                                                                                                                                                              
                             21:                                                                                                                                                                                 
                             22:#ifndef FREERDP_LIB_CORE_MCS_H                                                                                                                                                   
                             23:#define FREERDP_LIB_CORE_MCS_H                                                                                                                                                   
                             24:                                                                                                                                                                                 
                             25:typedef struct rdp_mcs rdpMcs;                                                                                                                                                   
                             26:                                                                                                                                                                                 
                             27:#include "transport.h"                                                                                                                                                           
                             28:                                                                                                                                                                                 
                             29:#include <freerdp/crypto/ber.h>                                                                                                                                                  
                             30:#include <freerdp/api.h>                                                                                                                                                         
                             31:#include <freerdp/types.h>                                                                                                                                                       
                             32:                                                                                                                                                                                 
                             33:#include <winpr/stream.h>                                                                                                                                                        
                             34:#include <winpr/wtsapi.h>                                                                                                                                                        
                             35:                                                                                                                                                                                 
                             36:enum MCS_Result                                                                                                                                                                  
                             37:{                                                                                                                                                                                
                             38:     MCS_Result_successful = 0,                                                                                                                                                  
                             39:     MCS_Result_domain_merging = 1,                                                                                                                                              
                             40:     MCS_Result_domain_not_hierarchical = 2,                                                                                                                                     
                             41:     MCS_Result_no_such_channel = 3,                                                                                                                                             
                             42:     MCS_Result_no_such_domain = 4,                                                                                                                                              
                             43:     MCS_Result_no_such_user = 5,                                                                                                                                                
                             44:     MCS_Result_not_admitted = 6,                                                                                                                                                
                             45:     MCS_Result_other_user_id = 7,                                                                                                                                               
                             46:     MCS_Result_parameters_unacceptable = 8,                                                                                                                                     
                             47:     MCS_Result_token_not_available = 9,                                                                                                                                         
                             48:     MCS_Result_token_not_possessed = 10,                                                                                                                                        
                             49:     MCS_Result_too_many_channels = 11,                                                                                                                                          
                             50:     MCS_Result_too_many_tokens = 12,                                                                                                                                            
                             51:     MCS_Result_too_many_users = 13,                                                                                                                                             
                             52:     MCS_Result_unspecified_failure = 14,                                                                                                                                        
                             53:     MCS_Result_user_rejected = 15,                                                                                                                                              
                             54:     MCS_Result_enum_length = 16                                                                                                                                                 
                             55:};                                                                                                                                                                               
                             56:                                                                                                                                                                                 
                             57:typedef enum                                                                                                                                                                     
                             58:{                                                                                                                                                                                
                             59:     DomainMCSPDU_invalid = -1,                                                                                                                                                  
                             60:     DomainMCSPDU_PlumbDomainIndication = 0,                                                                                                                                     
                             61:     DomainMCSPDU_ErectDomainRequest = 1,                                                                                                                                        
                             62:     DomainMCSPDU_MergeChannelsRequest = 2,                                                                                                                                      
                             63:     DomainMCSPDU_MergeChannelsConfirm = 3,                                                                                                                                      
                             64:     DomainMCSPDU_PurgeChannelsIndication = 4,                                                                                                                                   
                             65:     DomainMCSPDU_MergeTokensRequest = 5,                                                                                                                                        
                             66:     DomainMCSPDU_MergeTokensConfirm = 6,                                                                                                                                        
                             67:     DomainMCSPDU_PurgeTokensIndication = 7,                                                                                                                                     
                             68:     DomainMCSPDU_DisconnectProviderUltimatum = 8,                                                                                                                               
                             69:     DomainMCSPDU_RejectMCSPDUUltimatum = 9,                                                                                                                                     
                             70:     DomainMCSPDU_AttachUserRequest = 10,                                                                                                                                        
                             71:     DomainMCSPDU_AttachUserConfirm = 11,                                                                                                                                        
                             72:     DomainMCSPDU_DetachUserRequest = 12,                                                                                                                                        
                             73:     DomainMCSPDU_DetachUserIndication = 13,                                                                                                                                     
                             74:     DomainMCSPDU_ChannelJoinRequest = 14,                                                                                                                                       
                             75:     DomainMCSPDU_ChannelJoinConfirm = 15,                                                                                                                                       
                             76:     DomainMCSPDU_ChannelLeaveRequest = 16,                                                                                                                                      
                             77:     DomainMCSPDU_ChannelConveneRequest = 17,                                                                                                                                    
                             78:     DomainMCSPDU_ChannelConveneConfirm = 18,                                                                                                                                    
                             79:     DomainMCSPDU_ChannelDisbandRequest = 19,                                                                                                                                    
                             80:     DomainMCSPDU_ChannelDisbandIndication = 20,                                                                                                                                 
                             81:     DomainMCSPDU_ChannelAdmitRequest = 21,                                                                                                                                      
                             82:     DomainMCSPDU_ChannelAdmitIndication = 22,                                                                                                                                   
                             83:     DomainMCSPDU_ChannelExpelRequest = 23,                                                                                                                                      
                             84:     DomainMCSPDU_ChannelExpelIndication = 24,                                                                                                                                   
                             85:     DomainMCSPDU_SendDataRequest = 25,                                                                                                                                          
                             86:     DomainMCSPDU_SendDataIndication = 26,                                                                                                                                       
                             87:     DomainMCSPDU_UniformSendDataRequest = 27,                                                                                                                                   
                             88:     DomainMCSPDU_UniformSendDataIndication = 28,                                                                                                                                
                             89:     DomainMCSPDU_TokenGrabRequest = 29,                                                                                                                                         
                             90:     DomainMCSPDU_TokenGrabConfirm = 30,                                                                                                                                         
                             91:     DomainMCSPDU_TokenInhibitRequest = 31,                                                                                                                                      
                             92:     DomainMCSPDU_TokenInhibitConfirm = 32,                                                                                                                                      
                             93:     DomainMCSPDU_TokenGiveRequest = 33,                                                                                                                                         
                             94:     DomainMCSPDU_TokenGiveIndication = 34,                                                                                                                                      
                             95:     DomainMCSPDU_TokenGiveResponse = 35,                                                                                                                                        
                             96:     DomainMCSPDU_TokenGiveConfirm = 36,                                                                                                                                         
                             97:     DomainMCSPDU_TokenPleaseRequest = 37,                                                                                                                                       
                             98:     DomainMCSPDU_TokenPleaseConfirm = 38,                                                                                                                                       
                             99:     DomainMCSPDU_TokenReleaseRequest = 39,                                                                                                                                      
                             100:    DomainMCSPDU_TokenReleaseConfirm = 40,                                                                                                                                      
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.h:118-125                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             118:struct rdp_mcs_channel                                                                                                                                                          
                             119:{                                                                                                                                                                               
                             120:    char Name[CHANNEL_NAME_LEN + 1];                                                                                                                                            
                             121:    UINT32 options;                                                                                                                                                             
                             122:    UINT16 ChannelId;                                                                                                                                                           
                             123:    BOOL joined;                                                                                                                                                                
                             124:    void* handle;                                                                                                                                                               
                             125:};                                                                                                                                                                              
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.c:1855-1865                                                                                                                                                     
                             ```                                                                                                                                                                                 
                             1855:           return FALSE;                                                                                                                                                       
                             1856:                                                                                                                                                                               
                             1857:   Stream_Read_UINT8(s, mcs->channelCount); /* channelCount */                                                                                                                 
                             1858:                                                                                                                                                                               
                             1859:   if (blockLength < 4 + (UINT8)mcs->channelCount * 12)                                                                                                                        
                             1860:           return FALSE;                                                                                                                                                       
                             1861:                                                                                                                                                                               
                             1862:   if (mcs->channelCount > CHANNEL_MAX_COUNT)                                                                                                                                  
                             1863:           return FALSE;                                                                                                                                                       
                             1864:                                                                                                                                                                               
                             1865:   /* channelDefArray */                                                                                                                                                       
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/freerdp.c:1420-1469                                                                                                                                                 
                             ```                                                                                                                                                                                 
                             1420:                                                                                                                                                                               
                             1421:fail:                                                                                                                                                                          
                             1422:   transport_free(transport);                                                                                                                                                  
                             1423:   free(context);                                                                                                                                                              
                             1424:   freerdp_settings_free(settings);                                                                                                                                            
                             1425:                                                                                                                                                                               
                             1426:   return NULL;                                                                                                                                                                
                             1427:}                                                                                                                                                                              
                             1428:                                                                                                                                                                               
                             1429:BOOL freerdp_is_valid_mcs_create_request(const BYTE* data, size_t size)                                                                                                        
                             1430:{                                                                                                                                                                              
                             1431:                                                                                                                                                                               
                             1432:   wStream sbuffer = { 0 };                                                                                                                                                    
                             1433:   wStream* s = Stream_StaticConstInit(&sbuffer, data, size);                                                                                                                  
                             1434:                                                                                                                                                                               
                             1435:   WINPR_ASSERT(data || (size == 0));                                                                                                                                          
                             1436:   WINPR_ASSERT(s);                                                                                                                                                            
                             1437:                                                                                                                                                                               
                             1438:   rdpMcs* mcs = test_mcs_new();                                                                                                                                               
                             1439:   WINPR_ASSERT(mcs);                                                                                                                                                          
                             1440:                                                                                                                                                                               
                             1441:   BOOL result = mcs_recv_connect_initial(mcs, s);                                                                                                                             
                             1442:   test_mcs_free(mcs);                                                                                                                                                         
                             1443:   return result;                                                                                                                                                              
                             1444:}                                                                                                                                                                              
                             1445:                                                                                                                                                                               
                             1446:BOOL freerdp_is_valid_mcs_create_response(const BYTE* data, size_t size)                                                                                                       
                             1447:{                                                                                                                                                                              
                             1448:                                                                                                                                                                               
                             1449:   wStream sbuffer = { 0 };                                                                                                                                                    
                             1450:   wStream* s = Stream_StaticConstInit(&sbuffer, data, size);                                                                                                                  
                             1451:                                                                                                                                                                               
                             1452:   WINPR_ASSERT(data || (size == 0));                                                                                                                                          
                             1453:   WINPR_ASSERT(s);                                                                                                                                                            
                             1454:                                                                                                                                                                               
                             1455:   rdpMcs* mcs = test_mcs_new();                                                                                                                                               
                             1456:   WINPR_ASSERT(mcs);                                                                                                                                                          
                             1457:                                                                                                                                                                               
                             1458:   BOOL result = mcs_recv_connect_response(mcs, s);                                                                                                                            
                             1459:   test_mcs_free(mcs);                                                                                                                                                         
                             1460:   return result;                                                                                                                                                              
                             1461:}                                                                                                                                                                              
                             1462:                                                                                                                                                                               
                             1463:BOOL freerdp_persist_credentials(rdpContext* context)                                                                                                                          
                             1464:{                                                                                                                                                                              
                             1465:   if (!context)                                                                                                                                                               
                             1466:           return FALSE;                                                                                                                                                       
                             1467:   WINPR_ASSERT(context->rdp);                                                                                                                                                 
                             1468:   return utils_persist_credentials(context->rdp->originalSettings, context->rdp->settings);                                                                                   
                             1469:}                                                                                                                                                                              
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.c:1430-1446                                                                                                                                                     
                             ```                                                                                                                                                                                 
                             1430:rdpMcs* mcs_new(rdpTransport* transport)                                                                                                                                       
                             1431:{                                                                                                                                                                              
                             1432:   rdpMcs* mcs = NULL;                                                                                                                                                         
                             1433:                                                                                                                                                                               
                             1434:   mcs = (rdpMcs*)calloc(1, sizeof(rdpMcs));                                                                                                                                   
                             1435:                                                                                                                                                                               
                             1436:   if (!mcs)                                                                                                                                                                   
                             1437:           return NULL;                                                                                                                                                        
                             1438:                                                                                                                                                                               
                             1439:   mcs->transport = transport;                                                                                                                                                 
                             1440:   mcs_init_domain_parameters(&mcs->targetParameters, 34, 2, 0, 0xFFFF);                                                                                                       
                             1441:   mcs_init_domain_parameters(&mcs->minimumParameters, 1, 1, 1, 0x420);                                                                                                        
                             1442:   mcs_init_domain_parameters(&mcs->maximumParameters, 0xFFFF, 0xFC17, 0xFFFF, 0xFFFF);                                                                                        
                             1443:   mcs_init_domain_parameters(&mcs->domainParameters, 0, 0, 0, 0xFFFF);                                                                                                        
                             1444:   mcs->channelCount = 0;                                                                                                                                                      
                             1445:   mcs->baseChannelId = MCS_GLOBAL_CHANNEL_ID + 1;                                                                                                                             
                             1446:   mcs->channels = (rdpMcsChannel*)calloc(CHANNEL_MAX_COUNT, sizeof(rdpMcsChannel));                                                                                           
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.c:1-60                                                                                                                                                          
                             ```                                                                                                                                                                                 
                             1:/**                                                                                                                                                                               
                             2: * FreeRDP: A Remote Desktop Protocol Implementation                                                                                                                              
                             3: * T.124 Generic Conference Control (GCC)                                                                                                                                         
                             4: *                                                                                                                                                                                
                             5: * Copyright 2011 Marc-Andre Moreau <marcandre.moreau@gmail.com>                                                                                                                  
                             6: * Copyright 2014 Norbert Federa <norbert.federa@thincast.com>                                                                                                                    
                             7: * Copyright 2014 DI (FH) Martin Haimberger <martin.haimberger@thincast.com>                                                                                                      
                             8: * Copyright 2023 Armin Novak <anovak@thincast.com>                                                                                                                               
                             9: * Copyright 2023 Thincast Technologies GmbH                                                                                                                                      
                             10: *                                                                                                                                                                               
                             11: * Licensed under the Apache License, Version 2.0 (the "License");                                                                                                               
                             12: * you may not use this file except in compliance with the License.                                                                                                              
                             13: * You may obtain a copy of the License at                                                                                                                                       
                             14: *                                                                                                                                                                               
                             15: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             16: *                                                                                                                                                                               
                             17: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             18: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             19: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             20: * See the License for the specific language governing permissions and                                                                                                           
                             21: * limitations under the License.                                                                                                                                                
                             22: */                                                                                                                                                                              
                             23:                                                                                                                                                                                 
                             24:#include <freerdp/config.h>                                                                                                                                                      
                             25:                                                                                                                                                                                 
                             26:#include "settings.h"                                                                                                                                                            
                             27:                                                                                                                                                                                 
                             28:#include <winpr/crt.h>                                                                                                                                                           
                             29:#include <winpr/crypto.h>                                                                                                                                                        
                             30:#include <winpr/assert.h>                                                                                                                                                        
                             31:#include <winpr/cast.h>                                                                                                                                                          
                             32:                                                                                                                                                                                 
                             33:#include <freerdp/log.h>                                                                                                                                                         
                             34:#include <freerdp/utils/string.h>                                                                                                                                                
                             35:#include <freerdp/crypto/certificate.h>                                                                                                                                          
                             36:                                                                                                                                                                                 
                             37:#include "utils.h"                                                                                                                                                               
                             38:#include "gcc.h"                                                                                                                                                                 
                             39:#include "nego.h"                                                                                                                                                                
                             40:                                                                                                                                                                                 
                             41:#include "../crypto/certificate.h"                                                                                                                                               
                             42:                                                                                                                                                                                 
                             43:#define TAG FREERDP_TAG("core.gcc")                                                                                                                                              
                             44:                                                                                                                                                                                 
                             45:typedef enum                                                                                                                                                                     
                             46:{                                                                                                                                                                                
                             47:     HIGH_COLOR_4BPP = 0x04,                                                                                                                                                     
                             48:     HIGH_COLOR_8BPP = 0x08,                                                                                                                                                     
                             49:     HIGH_COLOR_15BPP = 0x0F,                                                                                                                                                    
                             50:     HIGH_COLOR_16BPP = 0x10,                                                                                                                                                    
                             51:     HIGH_COLOR_24BPP = 0x18,                                                                                                                                                    
                             52:} HIGH_COLOR_DEPTH;                                                                                                                                                              
                             53:                                                                                                                                                                                 
                             54:static const char* HighColorToString(HIGH_COLOR_DEPTH color)                                                                                                                     
                             55:{                                                                                                                                                                                
                             56:     switch (color)                                                                                                                                                              
                             57:     {                                                                                                                                                                           
                             58:             case HIGH_COLOR_4BPP:                                                                                                                                               
                             59:                     return "HIGH_COLOR_4BPP";                                                                                                                                   
                             60:             case HIGH_COLOR_8BPP:                                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/mcs.c:1-50                                                                                                                                                          
                             ```                                                                                                                                                                                 
                             1:/**                                                                                                                                                                               
                             2: * FreeRDP: A Remote Desktop Protocol Implementation                                                                                                                              
                             3: * T.125 Multipoint Communication Service (MCS) Protocol                                                                                                                          
                             4: *                                                                                                                                                                                
                             5: * Copyright 2011 Marc-Andre Moreau <marcandre.moreau@gmail.com>                                                                                                                  
                             6: * Copyright 2015 Thincast Technologies GmbH                                                                                                                                      
                             7: * Copyright 2015 DI (FH) Martin Haimberger <martin.haimberger@thincast.com>                                                                                                      
                             8: * Copyright 2017 Armin Novak <armin.novak@thincast.com>                                                                                                                          
                             9: * Copyright 2017 Thincast Technologies GmbH                                                                                                                                      
                             10: *                                                                                                                                                                               
                             11: * Licensed under the Apache License, Version 2.0 (the "License");                                                                                                               
                             12: * you may not use this file except in compliance with the License.                                                                                                              
                             13: * You may obtain a copy of the License at                                                                                                                                       
                             14: *                                                                                                                                                                               
                             15: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             16: *                                                                                                                                                                               
                             17: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             18: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             19: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             20: * See the License for the specific language governing permissions and                                                                                                           
                             21: * limitations under the License.                                                                                                                                                
                             22: */                                                                                                                                                                              
                             23:                                                                                                                                                                                 
                             24:#include <freerdp/config.h>                                                                                                                                                      
                             25:                                                                                                                                                                                 
                             26:#include <winpr/crt.h>                                                                                                                                                           
                             27:#include <winpr/assert.h>                                                                                                                                                        
                             28:#include <freerdp/log.h>                                                                                                                                                         
                             29:                                                                                                                                                                                 
                             30:#include "gcc.h"                                                                                                                                                                 
                             31:                                                                                                                                                                                 
                             32:#include "mcs.h"                                                                                                                                                                 
                             33:#include "tpdu.h"                                                                                                                                                                
                             34:#include "tpkt.h"                                                                                                                                                                
                             35:#include "client.h"                                                                                                                                                              
                             36:#include "connection.h"                                                                                                                                                          
                             37:                                                                                                                                                                                 
                             38:#define TAG FREERDP_TAG("core")                                                                                                                                                  
                             39:                                                                                                                                                                                 
                             40:/**                                                                                                                                                                              
                             41: * T.125 MCS is defined in:                                                                                                                                                      
                             42: *                                                                                                                                                                               
                             43: * http://www.itu.int/rec/T-REC-T.125-199802-I/                                                                                                                                  
                             44: * ITU-T T.125 Multipoint Communication Service Protocol Specification                                                                                                           
                             45: */                                                                                                                                                                              
                             46:                                                                                                                                                                                 
                             47:/**                                                                                                                                                                              
                             48: * Connect-Initial ::= [APPLICATION 101] IMPLICIT SEQUENCE                                                                                                                       
                             49: * {                                                                                                                                                                             
                             50: *   callingDomainSelector           OCTET_STRING,                                                                                                                               
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             <code>                                                                                                                                                                              
                             libfreerdp/core/gcc.h:1-40                                                                                                                                                          
                             ```                                                                                                                                                                                 
                             1:/**                                                                                                                                                                               
                             2: * FreeRDP: A Remote Desktop Protocol Implementation                                                                                                                              
                             3: * T.124 Generic Conference Control (GCC)                                                                                                                                         
                             4: *                                                                                                                                                                                
                             5: * Copyright 2011 Marc-Andre Moreau <marcandre.moreau@gmail.com>                                                                                                                  
                             6: *                                                                                                                                                                                
                             7: * Licensed under the Apache License, Version 2.0 (the "License");                                                                                                                
                             8: * you may not use this file except in compliance with the License.                                                                                                               
                             9: * You may obtain a copy of the License at                                                                                                                                        
                             10: *                                                                                                                                                                               
                             11: *     http://www.apache.org/licenses/LICENSE-2.0                                                                                                                                
                             12: *                                                                                                                                                                               
                             13: * Unless required by applicable law or agreed to in writing, software                                                                                                           
                             14: * distributed under the License is distributed on an "AS IS" BASIS,                                                                                                             
                             15: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                                                      
                             16: * See the License for the specific language governing permissions and                                                                                                           
                             17: * limitations under the License.                                                                                                                                                
                             18: */                                                                                                                                                                              
                             19:                                                                                                                                                                                 
                             20:#ifndef FREERDP_LIB_CORE_GCC_H                                                                                                                                                   
                             21:#define FREERDP_LIB_CORE_GCC_H                                                                                                                                                   
                             22:                                                                                                                                                                                 
                             23:#include "mcs.h"                                                                                                                                                                 
                             24:                                                                                                                                                                                 
                             25:#include <freerdp/crypto/per.h>                                                                                                                                                  
                             26:                                                                                                                                                                                 
                             27:#include <freerdp/freerdp.h>                                                                                                                                                     
                             28:#include <freerdp/settings.h>                                                                                                                                                    
                             29:#include <freerdp/api.h>                                                                                                                                                         
                             30:                                                                                                                                                                                 
                             31:#include <winpr/stream.h>                                                                                                                                                        
                             32:#include <sys/mman.h>                                                                                                                                                            
                             33:FREERDP_LOCAL BOOL gcc_read_conference_create_request(wStream* s, rdpMcs* mcs);                                                                                                  
                             34:FREERDP_LOCAL BOOL gcc_write_conference_create_request(wStream* s, wStream* userData);                                                                                           
                             35:FREERDP_LOCAL BOOL gcc_read_conference_create_response(wStream* s, rdpMcs* mcs);                                                                                                 
                             36:FREERDP_LOCAL BOOL gcc_write_conference_create_response(wStream* s, wStream* userData);                                                                                          
                             37:FREERDP_LOCAL BOOL gcc_write_client_data_blocks(wStream* s, const rdpMcs* mcs);                                                                                                  
                             38:FREERDP_LOCAL BOOL gcc_write_server_data_blocks(wStream* s, rdpMcs* mcs);                                                                                                        
                             39:                                                                                                                                                                                 
                             40:#endif /* FREERDP_LIB_CORE_GCC_H */                                                                                                                                              
                             ```                                                                                                                                                                                 
                             </code>                                                                                                                                                                             
                             </code_snippets>                                                                                                                                                                    
                                                                                                                                                                                                                 
                             ## Fix Strategy                                                                                                                                                                     
                             <fix_strategy>                                                                                                                                                                      
                                                                                                                                                                                                                 
                             </fix_strategy>                                                                                                                                                                     
                             ===Tests Result===                                                                                                                                                                  
                             No tests found                                                                                                                                                                      
                             ===Evaluation End===                                                                                                                                                                
[10/26/25 22:03:10] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                                                      __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                                                       
                    INFO     Building environment                                                                                                                                                 __init__.py:132
                             - Cache directory: /tmp/tmpslyuqmk6                                                                                                                                                 
                             - Max timeout: 1800                                                                                                                                                                 
                             - Output directory: reports/prism.prism_o4_mini/freerdp_fp-full-01_vuln_004/agent-output-1761516190.118865                                                                          
                             - Detection toml file: /tasks_new/freerdp_fp-full-01/detection/freerdp_fp-full-01_vuln_004.toml                                                                                     
                             - Challenge project directory: /tasks_new/freerdp_fp-full-01/official-afc-freerdp                                                                                                   
                                                                                                                                                                                                                 
