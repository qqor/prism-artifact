{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/tasks_new/apache-poi_poi-full-01/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.2871253,
    "prompt_tokens": 98671,
    "completion_tokens": 40588
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,6 +22,7 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n \n@@ -42,6 +43,18 @@\n public final class POIFSDump {\n \n     private POIFSDump() {}\n+\n+    private static Path resolveAndCheck(Path baseDir, String entryName) throws IOException {\n+        if (entryName == null || entryName.trim().isEmpty()) {\n+            throw new IOException(\"Invalid entry name: \" + entryName);\n+        }\n+        Path normalizedBase = baseDir.toAbsolutePath().normalize();\n+        Path candidate = normalizedBase.resolve(entryName.trim()).normalize();\n+        if (!candidate.startsWith(normalizedBase)) {\n+            throw new IOException(\"Path traversal detected for entry: \" + entryName);\n+        }\n+        return candidate;\n+    }\n \n     public static void main(String[] args) throws IOException {\n         if (args.length == 0) {\n@@ -76,9 +89,9 @@\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n-    \n+\n                 dump(root, file);\n-    \n+\n                 if (dumpProps) {\n                     HeaderBlock header = fs.getHeaderBlock();\n                     dump(fs, header.getPropertyStart(), \"properties\", file);\n@@ -97,35 +110,34 @@\n     }\n     \n     public static void dump(DirectoryEntry root, File parent) throws IOException {\n-        for(Iterator<Entry> it = root.getEntries(); it.hasNext();){\n+        for (Iterator<Entry> it = root.getEntries(); it.hasNext();) {\n             Entry entry = it.next();\n-            if(entry instanceof DocumentNode){\n-                final DocumentNode node = (DocumentNode) entry;\n-                final byte[] bytes;\n+            if (entry instanceof DocumentNode) {\n+                DocumentNode node = (DocumentNode) entry;\n+                byte[] bytes;\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n-                   bytes = IOUtils.toByteArray(is);\n+                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                Path target = resolveAndCheck(parent.toPath(), node.getName());\n+                Files.createDirectories(target.getParent());\n+                try (OutputStream out = Files.newOutputStream(target)) {\n                     out.write(bytes);\n                 }\n-            } else if (entry instanceof DirectoryEntry){\n-                DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n-                if(!file.exists() && !file.mkdirs()) {\n-                    throw new IOException(\"Could not create directory \" + file);\n-                }\n-                dump(dir, file);\n+            } else if (entry instanceof DirectoryEntry) {\n+                DirectoryEntry dir = (DirectoryEntry) entry;\n+                Path dirPath = resolveAndCheck(parent.toPath(), entry.getName());\n+                Files.createDirectories(dirPath);\n+                dump(dir, dirPath.toFile());\n             } else {\n                 System.err.println(\"Skipping unsupported POIFS entry: \" + entry);\n             }\n         }\n     }\n+\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n-        if (! Files.isDirectory(file.toPath().getParent())) {\n-            Files.createDirectories(file.toPath().getParent());\n-        }\n-        try (OutputStream out = Files.newOutputStream(file.toPath())) {\n+        Path target = resolveAndCheck(parent.toPath(), name);\n+        Files.createDirectories(target.getParent());\n+        try (OutputStream out = Files.newOutputStream(target)) {\n             POIFSStream stream = new POIFSStream(fs, startBlock);\n \n             byte[] b = IOUtils.safelyAllocate(fs.getBigBlockSize(), POIFSFileSystem.getMaxRecordLength());\n",
  "stdout": "",
  "stderr": ""
}