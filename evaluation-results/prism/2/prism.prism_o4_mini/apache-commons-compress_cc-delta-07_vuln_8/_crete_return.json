{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-07_vuln_8",
  "source_directory": "/home/qqor/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 0.5239486999999999,
    "prompt_tokens": 248417,
    "completion_tokens": 56975
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n@@ -69,17 +69,24 @@\n             throws IOException {\n         final boolean nullTarget = targetDirectory == null;\n         final Path targetDirPath = nullTarget ? null : targetDirectory.normalize();\n+        final Path safeBase = nullTarget ? null : targetDirectory.toAbsolutePath().normalize();\n         T nextEntry = supplier.get();\n         while (nextEntry != null) {\n-            final Path targetPath = nullTarget ? null : nextEntry.resolveIn(targetDirPath);\n+            final Path targetPath;\n+            if (nullTarget) {\n+                targetPath = null;\n+            } else {\n+                targetPath = safeResolve(safeBase, nextEntry.getName());\n+            }\n             if (nextEntry.isDirectory()) {\n-                if (!nullTarget && !Files.isDirectory(targetPath) && Files.createDirectories(targetPath) == null) {\n-                    throw new IOException(\"Failed to create directory \" + targetPath);\n+                if (!nullTarget && !Files.isDirectory(targetPath)) {\n+                    if (Files.createDirectories(targetPath) == null) {\n+                        throw new IOException(\"Failed to create directory \" + targetPath);\n+                    }\n                 }\n             } else {\n-                final Path parent = nullTarget ? null : targetPath.getParent();\n-                if (!nullTarget && !Files.isDirectory(parent) && Files.createDirectories(parent) == null) {\n-                    throw new IOException(\"Failed to create directory \" + parent);\n+                if (!nullTarget) {\n+                    createParentDirectorySafe(safeBase, targetPath);\n                 }\n                 if (nullTarget) {\n                     writer.accept(nextEntry, NullOutputStream.INSTANCE);\n@@ -468,36 +475,31 @@\n      * @since 1.22\n      */\n     public void expand(final ZipFile archive, final Path targetDirectory) throws IOException {\n-        if (! Files.isDirectory(targetDirectory)) {\n+        if (!Files.isDirectory(targetDirectory)) {\n             Files.createDirectories(targetDirectory);\n         }\n+        final Path safeBase = targetDirectory.toAbsolutePath().normalize();\n         final Enumeration<ZipArchiveEntry> entries = archive.getEntries();\n         while (entries.hasMoreElements()) {\n             ZipArchiveEntry zae = entries.nextElement();\n             if (zae.isUnixSymlink()) {\n                 String targetName = IOUtils.toString(archive.getInputStream(zae),\n                         StandardCharsets.UTF_8);\n-                Path link = targetDirectory.resolve(zae.getName());\n-                Path target = targetDirectory.resolve(targetName);\n-                Path parent = createParentDirectory(targetDirectory, link);\n-\n+                Path link = safeResolve(safeBase, zae.getName());\n+                if (targetName.startsWith(\"/\") || targetName.contains(\"..\")) {\n+                    throw new IOException(String.format(\"Invalid symlink target: '%s'\", targetName));\n+                }\n+                Path parent = createParentDirectorySafe(safeBase, link);\n                 if (!Files.isSameFile(link.getParent(), parent)) {\n-                    link = parent.relativize(link.getFileName()).normalize();\n+                    link = parent.resolve(link.getFileName()).normalize();\n                 }\n                 if (!Files.isRegularFile(link) && !Files.isSymbolicLink(link)) {\n+                    Path target = safeBase.getFileSystem().getPath(targetName);\n                     Files.createSymbolicLink(link, target);\n                 }\n-            } else if (! zae.isDirectory()) {\n-                Path target = targetDirectory.resolve(zae.getName()).normalize();\n-                if (!target.startsWith(targetDirectory)) {\n-                    throw new IOException(String.format(\"Zip slip '%s' + '%s' -> '%s'\",\n-                            targetDirectory, zae.getName(), target));\n-                }\n-                Path parent = createParentDirectory(targetDirectory, target);\n-                if (! target.getParent().toAbsolutePath().normalize().equals(\n-                        parent.toAbsolutePath().normalize())) {\n-                    target = parent.normalize().resolve(target.getFileName());\n-                }\n+            } else if (!zae.isDirectory()) {\n+                Path target = safeResolve(safeBase, zae.getName());\n+                createParentDirectorySafe(safeBase, target);\n                 try (InputStream is = archive.getInputStream(zae)) {\n                     Files.copy(is, target);\n                 }\n@@ -505,22 +507,33 @@\n         }\n     }\n \n-    private static Path createParentDirectory(Path root, Path target) throws IOException {\n-        Path relative =\n-                root.relativize(target.getParent());\n-        Path current = root.toAbsolutePath();\n-\n+    private static Path safeResolve(Path safeBase, String entryName) throws IOException {\n+        Path resolved = safeBase.resolve(entryName).toAbsolutePath().normalize();\n+        if (!resolved.startsWith(safeBase)) {\n+            throw new IOException(String.format(\"File path traversal: '%s' -> '%s'\",\n+                                                entryName, resolved));\n+        }\n+        return resolved;\n+    }\n+\n+    private static Path createParentDirectorySafe(Path safeBase, Path target) throws IOException {\n+        Path relative = safeBase.relativize(target.getParent());\n+        Path current = safeBase;\n         for (Path p : relative) {\n             current = current.resolve(p);\n             if (Files.isSymbolicLink(current)) {\n-                current = Files.readSymbolicLink(current);\n-            }\n-            if (! Files.isDirectory(current)) {\n+                Path linkTarget = Files.readSymbolicLink(current);\n+                current = current.getParent().resolve(linkTarget).toAbsolutePath().normalize();\n+            }\n+            if (!current.normalize().startsWith(safeBase)) {\n+                throw new IOException(String.format(\"File path traversal: '%s' -> '%s'\",\n+                                                    safeBase, current));\n+            }\n+            if (!Files.isDirectory(current)) {\n                 Files.createDirectory(current);\n             }\n         }\n         return current;\n-\n     }\n \n \n",
  "stdout": "",
  "stderr": ""
}