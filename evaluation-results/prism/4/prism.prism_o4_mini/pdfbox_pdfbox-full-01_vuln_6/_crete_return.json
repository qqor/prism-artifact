{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_6",
  "source_directory": "/tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 0.9142111,
    "prompt_tokens": 392833,
    "completion_tokens": 109567
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/pfb/PfbParser.java\n@@ -17,6 +17,7 @@\n package org.apache.fontbox.pfb;\n \n import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n import java.io.EOFException;\n import java.io.IOException;\n import java.io.InputStream;\n@@ -70,6 +71,8 @@\n      */\n     private static final long MAX_LENGTH = 100_000_000;\n \n+    /** Maximum allowable PFB input size (total file length), to prevent OOME. */\n+    private static final long MAX_PFB_BYTES = 200_000_000L;\n     /**\n      * the parsed pfb-data.\n      */\n@@ -92,7 +95,7 @@\n      */\n     public PfbParser(final String filename) throws IOException \n     {\n-        this(Files.readAllBytes(Paths.get(filename)));\n+        this(Files.newInputStream(Paths.get(filename)));\n     }\n \n     /**\n@@ -102,8 +105,18 @@\n      */\n     public PfbParser(final InputStream in) throws IOException \n     {\n-        byte[] pfb = in.readAllBytes();\n-        parsePfb(pfb);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        byte[] buffer = new byte[8192];\n+        int bytesRead;\n+        long total = 0;\n+        while ((bytesRead = in.read(buffer)) != -1) {\n+            total += bytesRead;\n+            if (total > MAX_PFB_BYTES) {\n+                throw new IOException(\"PFB data too large: \" + total + \" bytes\");\n+            }\n+            baos.write(buffer, 0, bytesRead);\n+        }\n+        parsePfb(baos.toByteArray());\n     }\n \n     /**\n@@ -123,6 +136,10 @@\n      */\n     private void parsePfb(final byte[] pfb) throws IOException \n     {\n+        if (pfb.length > MAX_PFB_BYTES)\n+        {\n+            throw new IOException(\"PFB data too large: \" + pfb.length + \" bytes\");\n+        }\n         if (pfb.length < PFB_HEADER_LENGTH)\n         {\n             throw new IOException(\"PFB header missing\");\n@@ -158,12 +175,22 @@\n             size += in.read() << 16;\n             size += in.read() << 24;\n             LOG.debug(\"record type: {}, segment size: {}\", recordType, size);\n+            if (size < 0 || size > MAX_PFB_BYTES) {\n+                throw new IOException(\"Segment size too large: \" + size + \" bytes\");\n+            }\n             long newTotal = total + size;\n-            if (newTotal > MAX_LENGTH) {\n-                throw new IOException(\"record size would be too large: \" + newTotal);\n-            }\n-\n-            byte[] ar = new byte[size];\n+            if (newTotal > MAX_PFB_BYTES) {\n+                throw new IOException(\"record size would be too large: \" + newTotal + \" bytes\");\n+            }\n+            if (size > Integer.MAX_VALUE) {\n+                throw new IOException(\"Segment size too large to allocate: \" + size + \" bytes\");\n+            }\n+            byte[] ar;\n+            try {\n+                ar = new byte[(int) size];\n+            } catch (OutOfMemoryError e) {\n+                throw new IOException(\"Segment too large: \" + size + \" bytes\", e);\n+            }\n             int got = in.read(ar);\n             if (got != size)\n             {\n@@ -179,7 +206,19 @@\n         // come first, then the binary segments, then the last ASCII segment if it is\n         // 0000... cleartomark\n         \n-        pfbdata = new byte[total];\n+        if (total < 0 || total > MAX_PFB_BYTES) {\n+            throw new IOException(\"PFB data too large: \" + total + \" bytes\");\n+        }\n+        if (total > Integer.MAX_VALUE) {\n+            throw new IOException(\"PFB data too large to allocate: \" + total + \" bytes\");\n+        }\n+        byte[] tempData;\n+        try {\n+            tempData = new byte[(int) total];\n+        } catch (OutOfMemoryError e) {\n+            throw new IOException(\"PFB data too large: \" + total + \" bytes\", e);\n+        }\n+        pfbdata = tempData;\n         byte[] cleartomarkSegment = null;\n         int dstPos = 0;\n         \n",
  "stdout": "",
  "stderr": ""
}