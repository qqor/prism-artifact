--- a/encoding.c
+++ b/encoding.c
@@ -2865,15 +2865,33 @@
         c = b0 | b1 | b2 | b3;
 
         if (c < 0x80) {
+            size_t written = out - outstart;
+            if (written + 1 > (size_t)*outlen) {
+                *outlen = written;
+                *inlen  = in - instart;
+                return XML_ENC_ERR_SPACE;
+            }
             out[0] = c;
             in += 4;
             out += 1;
         } else if (c < 0x800) {
+            size_t written = out - outstart;
+            if (written + 2 > (size_t)*outlen) {
+                *outlen = written;
+                *inlen  = in - instart;
+                return XML_ENC_ERR_SPACE;
+            }
             out[0] = (c >> 6)   | 0xC0;
             out[1] = (c & 0x3F) | 0x80;
             in += 4;
             out += 2;
         } else if ((c & 0xF800) != 0xD800) {
+            size_t written = out - outstart;
+            if (written + 3 > (size_t)*outlen) {
+                *outlen = written;
+                *inlen  = in - instart;
+                return XML_ENC_ERR_SPACE;
+            }
             out[0] =  (c >> 12)         | 0xE0;
             out[1] = ((c >>  6) & 0x3F) | 0x80;
             out[2] =  (c        & 0x3F) | 0x80;
@@ -2901,6 +2919,14 @@
                 out[2] = ((c >>  6) & 0x3F) | 0x80;
                 out[3] =  (c        & 0x3F) | 0x80;
             */
+            {
+                size_t written = out - outstart;
+                if (written + 4 > (size_t)*outlen) {
+                    *outlen = written;
+                    *inlen  = in - instart;
+                    return XML_ENC_ERR_SPACE;
+                }
+            }
             out[0] = c & 0xff;
             out[1] = (c >> 8) & 0xff;
             out[2] = (c >> 0x10) & 0xff;
