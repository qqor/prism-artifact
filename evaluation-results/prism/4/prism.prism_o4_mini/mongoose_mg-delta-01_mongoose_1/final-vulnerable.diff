--- a/src/fmt.c
+++ b/src/fmt.c
@@ -1,6 +1,7 @@
 #include "fmt.h"
 #include "printf.h"
 #include "util.h"
+#include <stdio.h>
 
 static bool is_digit(int c) {
   return c >= '0' && c <= '9';
@@ -315,15 +316,25 @@
         for (j = 0; minus && pr < w && j + pr < w; j++)
           n += scpy(out, param, &pad, 1);
       } else if (c == 'e' || c == 'E') {
-		  char tmp[8];
+          char tmp[40];
           double d = va_arg(*ap, double);
+          if (pr == ~0U) pr = 6;
           int64_t exponent = (int64_t)log10(my_fabs(d));
           double mantissa = d / power(10, exponent);
-          k = mg_dtoa(tmp, 10, mantissa, 8, c == 'e');
+          k = mg_dtoa(tmp, sizeof(tmp), mantissa, (int)pr, true);
           n += scpy(out, param, tmp, k);
           out(c, param);
           n++;
-		  k = mg_lld(tmp, exponent, 1, 0);
+          {
+              int kk = snprintf(tmp, sizeof(tmp), "%+lld", (long long)exponent);
+              if (kk < 0) {
+                  k = 0;
+              } else if ((size_t)kk >= sizeof(tmp)) {
+                  k = sizeof(tmp) - 1;
+              } else {
+                  k = (size_t)kk;
+              }
+          }
           n += scpy(out, param, tmp, k);
 	  } else if (c == '%') {
         out('%', param);
