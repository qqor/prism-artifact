[11/03/25 16:07:26] INFO     Building environment                       __init__.py:132
                             - Cache directory: /tmp/tmpo4vm71_w                       
                             - Max timeout: 1800                                       
                             - Output directory:                                       
                             reports/prism.prism_o4_mini/apache-poi_poi                
                             -full-01_vuln_1/agent-output-1762186046.16                
                             34097                                                     
                             - Detection toml file:                                    
                             /tasks_new/apache-poi_poi-full-01/detectio                
                             n/apache-poi_poi-full-01_vuln_1.toml                      
                             - Challenge project directory:                            
                             /tasks_new/apache-poi_poi-full-01/official                
                             -afc-poi                                                  
                                                                                       
                    INFO     Setting timeouts                             default.py:83
                               - build: 600 (original: 145)                            
                               - run tests: 600 (original: 0)                          
                    INFO     Successfully created Cached for CLEAN      oss_fuzz.py:256
                             environment                                               
                    INFO     Current environments: ['CLEAN -> Cached']  oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START __init__.py:160
                             -> TeamStatus.EVALUATE                                    
                             (n evals: 0, patch status:                                
                             PatchStatus.INITIALIZED)                                  
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:07:27] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 1.01 seconds;                         
                             exception=False                                           
[11/03/25 16:07:28] INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:07:29] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 0.95 seconds;                         
                             exception=False                                           
[11/03/25 16:07:35] INFO     ===Evaluator Result===                    evaluator.py:204
                             PatchStatus.VULNERABLE                                    
                             ===Evaluator Diff===                                      
                                                                                       
                             ===Patch Result===                                        
                             == Java Exception:                                        
                             com.code_intelligence.jazzer.api.FuzzerSe                 
                             curityIssueLow: Out of memory (use                        
                             '-Xmx921m' to reproduce)                                  
                             Caused by: java.lang.OutOfMemoryError:                    
                             Java heap space                                           
                                     at                                                
                             java.base/java.lang.String.<init>(String.                 
                             java:657)                                                 
                                     at                                                
                             org.apache.poi.util.StringUtil.getFromUni                 
                             codeLE(StringUtil.java:94)                                
                                     at                                                
                             org.apache.poi.hmef.attribute.MAPIAttribu                 
                             te.create(MAPIAttribute.java:175)                         
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFMAPIAtt                 
                             ribute.<init>(TNEFMAPIAttribute.java:41)                  
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFAttribu                 
                             te.create(TNEFAttribute.java:86)                          
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.processMe                 
                             ssage(HMEFMessage.java:105)                               
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.process(H                 
                             MEFMessage.java:87)                                       
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.<init>(HM                 
                             EFMessage.java:72)                                        
                                     at                                                
                             org.apache.poi.POIHMEFFuzzer.fuzzerTestOn                 
                             eInput(POIHMEFFuzzer.java:32)                             
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$DMH                 
                             /0x0000000800cb8c00.invokeStaticInit(Lamb                 
                             daForm$DMH)                                               
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04800.invoke(LambdaForm$MH)                  
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04000.invoke_MT(LambdaForm$M                 
                             H)                                                        
                             DEDUP_TOKEN: a36f54a5f0a295bd                             
                             == libFuzzer crashing input ==                            
                             ===Issue===                                               
                             == Java Exception:                                        
                             com.code_intelligence.jazzer.api.FuzzerSe                 
                             curityIssueLow: Out of memory (use                        
                             '-Xmx921m' to reproduce)                                  
                             Caused by: java.lang.OutOfMemoryError:                    
                             Java heap space                                           
                                     at                                                
                             java.base/java.lang.String.<init>(String.                 
                             java:657)                                                 
                                     at                                                
                             org.apache.poi.util.StringUtil.getFromUni                 
                             codeLE(StringUtil.java:94)                                
                                     at                                                
                             org.apache.poi.hmef.attribute.MAPIAttribu                 
                             te.create(MAPIAttribute.java:175)                         
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFMAPIAtt                 
                             ribute.<init>(TNEFMAPIAttribute.java:41)                  
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFAttribu                 
                             te.create(TNEFAttribute.java:86)                          
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.processMe                 
                             ssage(HMEFMessage.java:105)                               
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.process(H                 
                             MEFMessage.java:87)                                       
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.<init>(HM                 
                             EFMessage.java:72)                                        
                                     at                                                
                             org.apache.poi.POIHMEFFuzzer.fuzzerTestOn                 
                             eInput(POIHMEFFuzzer.java:32)                             
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$DMH                 
                             /0x0000000800cb8c00.invokeStaticInit(Lamb                 
                             daForm$DMH)                                               
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04800.invoke(LambdaForm$MH)                  
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04000.invoke_MT(LambdaForm$M                 
                             H)                                                        
                             DEDUP_TOKEN: a36f54a5f0a295bd                             
                             == libFuzzer crashing input ==                            
                             ===Evaluation Report===                                   
                                                                                       
                             ===Analysis Report===                                     
                                                                                       
                             ===Evaluation End===                                      
[11/03/25 16:07:46] INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.EVALUATE -> TeamStatus.ANALYZE                 
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
[11/03/25 16:10:07] INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.ANALYZE -> TeamStatus.PATCH                    
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
[11/03/25 16:11:15] INFO     Prism Supervisor Routing: TeamStatus.PATCH __init__.py:160
                             -> TeamStatus.EVALUATE                                    
                             (n evals: 1, patch status:                                
                             PatchStatus.VULNERABLE)                                   
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:11:16] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 0.89 seconds;                         
                             exception=False                                           
[11/03/25 16:11:17] INFO     [logging_performance](apache-poi     context_managers.py:9
                             Patching) Started...                                      
                    INFO     Checking valid diff: /tmp/tmpf8u5lner       default.py:171
[11/03/25 16:13:15] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Patching) Took 118.97 seconds;                            
                             exception=False                                           
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Checking build) Started...                                
[11/03/25 16:13:52] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Checking build) Took 36.44 seconds;                       
                             exception=False                                           
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Running PoV) Started...                                   
[11/03/25 16:13:57] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Running PoV) Took 5.49 seconds;                           
                             exception=False                                           
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Testing) Started...                                       
                    INFO     [logging_performance](apache-poi    context_managers.py:23
                             Testing) Took 0.00 seconds;                               
                             exception=False                                           
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:13:58] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 0.86 seconds;                         
                             exception=False                                           
[11/03/25 16:13:59] INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:14:00] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 0.80 seconds;                         
                             exception=False                                           
                    INFO     [logging_performance](apache-poi     context_managers.py:9
                             Setting owner) Started...                                 
[11/03/25 16:14:01] INFO     [logging_performance](apache-poi    context_managers.py:23
                             Setting owner) Took 0.87 seconds;                         
                             exception=False                                           
[11/03/25 16:14:02] INFO     ===Evaluator Result===                    evaluator.py:204
                             PatchStatus.SOUND                                         
                             ===Evaluator Diff===                                      
                             ---                                                       
                             a/poi-scratchpad/src/main/java/org/apache                 
                             /poi/hmef/attribute/MAPIAttribute.java                    
                             +++                                                       
                             b/poi-scratchpad/src/main/java/org/apache                 
                             /poi/hmef/attribute/MAPIAttribute.java                    
                             @@ -168,14 +168,13 @@                                     
                                                if (mplen < 0) {                       
                                                   throw new                           
                             IOException("Did not expect negative                      
                             value: " + mplen);                                        
                                                }                                      
                             -                  byte[] mpdata = new                    
                             byte[mplen];                                              
                             +                  byte[] mpdata =                        
                             IOUtils.safelyAllocate(mplen,                             
                             MAX_RECORD_LENGTH);                                       
                                                if                                     
                             (IOUtils.readFully(inp, mpdata) < 0) {                    
                                                   throw new                           
                             IOException("Not enough data to read " +                  
                             mplen + " bytes for attribute name");                     
                                                }                                      
                                                name =                                 
                             StringUtil.getFromUnicodeLE(mpdata, 0,                    
                             (mplen/2)-1);                                             
                                                skipToBoundary(mplen,                  
                             inp);                                                     
                                             }                                         
                             -                                                         
                                             // Now create                             
                                             prop =                                    
                             MAPIProperty.createCustom(id, type,                       
                             name);                                                    
                                          }                                            
                                                                                       
                             ---                                                       
                             a/poi-scratchpad/src/main/java/org/apache                 
                             /poi/hmef/attribute/TNEFStringAttribute.j                 
                             ava                                                       
                             +++                                                       
                             b/poi-scratchpad/src/main/java/org/apache                 
                             /poi/hmef/attribute/TNEFStringAttribute.j                 
                             ava                                                       
                             @@ -44,6 +44,9 @@                                         
                                    String tmpData = null;                             
                                    byte[] data = getData();                           
                                    if(getType() ==                                    
                             TNEFProperty.TYPE_TEXT) {                                 
                             +         if (data.length > 1_048_576) {                  
                             +             throw new                                   
                             IllegalArgumentException("TNEF text                       
                             attribute exceeds allowed size: " +                       
                             data.length + " bytes");                                  
                             +         }                                               
                                       tmpData =                                       
                             StringUtil.getFromUnicodeLE(data);                        
                                    } else {                                           
                                       tmpData =                                       
                             StringUtil.getFromCompressedUnicode(                      
                                                                                       
                             ===Patch Result===                                        
                                                                                       
                             ===Issue===                                               
                             == Java Exception:                                        
                             com.code_intelligence.jazzer.api.FuzzerSe                 
                             curityIssueLow: Out of memory (use                        
                             '-Xmx921m' to reproduce)                                  
                             Caused by: java.lang.OutOfMemoryError:                    
                             Java heap space                                           
                                     at                                                
                             java.base/java.lang.String.<init>(String.                 
                             java:657)                                                 
                                     at                                                
                             org.apache.poi.util.StringUtil.getFromUni                 
                             codeLE(StringUtil.java:94)                                
                                     at                                                
                             org.apache.poi.hmef.attribute.MAPIAttribu                 
                             te.create(MAPIAttribute.java:175)                         
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFMAPIAtt                 
                             ribute.<init>(TNEFMAPIAttribute.java:41)                  
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFAttribu                 
                             te.create(TNEFAttribute.java:86)                          
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.processMe                 
                             ssage(HMEFMessage.java:105)                               
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.process(H                 
                             MEFMessage.java:87)                                       
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.<init>(HM                 
                             EFMessage.java:72)                                        
                                     at                                                
                             org.apache.poi.POIHMEFFuzzer.fuzzerTestOn                 
                             eInput(POIHMEFFuzzer.java:32)                             
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$DMH                 
                             /0x0000000800cb8c00.invokeStaticInit(Lamb                 
                             daForm$DMH)                                               
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04800.invoke(LambdaForm$MH)                  
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04000.invoke_MT(LambdaForm$M                 
                             H)                                                        
                             DEDUP_TOKEN: a36f54a5f0a295bd                             
                             == libFuzzer crashing input ==                            
                             ===Evaluation Report===                                   
                             # Evaluation Report                                       
                                                                                       
                             ## Summary                                                
                                                                                       
                             A Java out-of-memory error was triggered                  
                             during fuzz testing of Apache POI’s HMEF                  
                             (TNEF) message parser. The fuzzer harness                 
                             (`POIHMEFFuzzer`) invoked `HMEFMessage`                   
                             processing on input data that led to                      
                             excessive memory allocation in string                     
                             conversion routines. The crash is                         
                             classified as a FuzzerSecurityIssueLow                    
                             indicating a resource exhaustion                          
                             vulnerability.                                            
                                                                                       
                             ## Description                                            
                                                                                       
                             - Issue                                                   
                               A `java.lang.OutOfMemoryError: Java                     
                             heap space` was thrown and reported by                    
                             Jazzer as `FuzzerSecurityIssueLow: Out of                 
                             memory (use '-Xmx921m' to reproduce)`.                    
                             The exception occurred during fuzzing of                  
                             Apache POI’s HMEF message handling code.                  
                                                                                       
                             - Vulnerability Type                                      
                               Resource exhaustion (Denial of Service)                 
                             via uncontrolled memory allocation in                     
                             string processing.                                        
                                                                                       
                             - Stack Trace Highlights                                  
                               • `String.<init>(String.java:657)`                      
                               •                                                       
                             `org.apache.poi.util.StringUtil.getFromUn                 
                             icodeLE(StringUtil.java:94)`                              
                               •                                                       
                             `org.apache.poi.hmef.attribute.MAPIAttrib                 
                             ute.create(MAPIAttribute.java:175)`                       
                               •                                                       
                             `org.apache.poi.hmef.attribute.TNEFMAPIAt                 
                             tribute.<init>(TNEFMAPIAttribute.java:41)                 
                             `                                                         
                               • Further propagation through                           
                             `TNEFAttribute.create`,                                   
                             `HMEFMessage.processMessage`, and the                     
                             fuzzer entry point                                        
                             `POIHMEFFuzzer.fuzzerTestOneInput`.                       
                                                                                       
                             - Important Observations                                  
                               • The error arises while converting raw                 
                             bytes to Java `String` in Unicode                         
                             little-endian mode.                                       
                               • Fuzzed input data triggers unbounded                  
                             or very large string allocations.                         
                               • The issue does not indicate memory                    
                             leaks but rather unthrottled                              
                             buffer-to-string conversions.                             
                               • The fuzzer harness is only an entry                   
                             point; the memory allocation occurs                       
                             entirely within POI’s HMEF parsing code.                  
                                                                                       
                             - Areas for Investigation                                 
                               1.                                                      
                             `org.apache.poi.util.StringUtil.getFromUn                 
                             icodeLE` – how input length is computed                   
                             and validated before string construction.                 
                               2.                                                      
                             `org.apache.poi.hmef.attribute.MAPIAttrib                 
                             ute.create` and related attribute parsing                 
                             logic – handling of length fields and                     
                             byte arrays.                                              
                               3. `TNEFMAPIAttribute` and                              
                             `TNEFAttribute` constructors – boundary                   
                             checks on attribute data sizes.                           
                               4. `HMEFMessage` initialization and                     
                             message processing routines – overall                     
                             input validation and defensiveness                        
                             against oversize fields.                                  
                               5. Integration of the fuzzer harness                    
                             (`POIHMEFFuzzer`) to identify whether it                  
                             exercises any unchecked parsing paths.                    
                                                                                       
                             ## Initial Issue Log                                      
                             Here is the initial issue log of the                      
                             codebase:                                                 
                             <issue>                                                   
                             == Java Exception:                                        
                             com.code_intelligence.jazzer.api.FuzzerSe                 
                             curityIssueLow: Out of memory (use                        
                             '-Xmx921m' to reproduce)                                  
                             Caused by: java.lang.OutOfMemoryError:                    
                             Java heap space                                           
                                     at                                                
                             java.base/java.lang.String.<init>(String.                 
                             java:657)                                                 
                                     at                                                
                             org.apache.poi.util.StringUtil.getFromUni                 
                             codeLE(StringUtil.java:94)                                
                                     at                                                
                             org.apache.poi.hmef.attribute.MAPIAttribu                 
                             te.create(MAPIAttribute.java:175)                         
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFMAPIAtt                 
                             ribute.<init>(TNEFMAPIAttribute.java:41)                  
                                     at                                                
                             org.apache.poi.hmef.attribute.TNEFAttribu                 
                             te.create(TNEFAttribute.java:86)                          
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.processMe                 
                             ssage(HMEFMessage.java:105)                               
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.process(H                 
                             MEFMessage.java:87)                                       
                                     at                                                
                             org.apache.poi.hmef.HMEFMessage.<init>(HM                 
                             EFMessage.java:72)                                        
                                     at                                                
                             org.apache.poi.POIHMEFFuzzer.fuzzerTestOn                 
                             eInput(POIHMEFFuzzer.java:32)                             
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$DMH                 
                             /0x0000000800cb8c00.invokeStaticInit(Lamb                 
                             daForm$DMH)                                               
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04800.invoke(LambdaForm$MH)                  
                                     at                                                
                             java.base/java.lang.invoke.LambdaForm$MH/                 
                             0x0000000800d04000.invoke_MT(LambdaForm$M                 
                             H)                                                        
                             DEDUP_TOKEN: a36f54a5f0a295bd                             
                             == libFuzzer crashing input ==                            
                             </issue>                                                  
                             ===Analysis Report===                                     
                             # Analysis Report                                         
                                                                                       
                             ## Relevant Code Snippets                                 
                             <code_snippets>                                           
                             <code>                                                    
                             poi/src/main/java/org/apache/poi/util/Str                 
                             ingUtil.java:79-95                                        
                             ```                                                       
                             79:    public static String                               
                             getFromUnicodeLE(                                         
                             80:            final byte[] string,                       
                             81:            final int offset,                          
                             82:            final int len)                             
                             83:            throws                                     
                             ArrayIndexOutOfBoundsException,                           
                             IllegalArgumentException {                                
                             84:        if (len == 0) {                                
                             85:            return "";                                 
                             86:        }                                              
                             87:        if ((offset < 0) || (offset >=                 
                             string.length)) {                                         
                             88:            throw new                                  
                             ArrayIndexOutOfBoundsException("Illegal                   
                             offset " + offset + " (String data is of                  
                             length " + string.length + ")");                          
                             89:        }                                              
                             90:        if ((len < 0) ||                               
                             (((string.length - offset) / 2) < len)) {                 
                             91:            throw new                                  
                             IllegalArgumentException("Illegal length                  
                             " + len);                                                 
                             92:        }                                              
                             93:                                                       
                             94:        return new String(string,                      
                             offset, len * 2, UTF16LE);                                
                             95:    }                                                  
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             poi-scratchpad/src/main/java/org/apache/p                 
                             oi/hmef/attribute/TNEFStringAttribute.jav                 
                             a:44-52                                                   
                             ```                                                       
                             44:      String tmpData = null;                           
                             45:      byte[] data = getData();                         
                             46:      if(getType() ==                                  
                             TNEFProperty.TYPE_TEXT) {                                 
                             47:         tmpData =                                     
                             StringUtil.getFromUnicodeLE(data);                        
                             48:      } else {                                         
                             49:         tmpData =                                     
                             StringUtil.getFromCompressedUnicode(                      
                             50:              data, 0, data.length                     
                             51:         );                                            
                             52:      }                                                
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             poi-scratchpad/src/main/java/org/apache/p                 
                             oi/hmef/attribute/TNEFAttribute.java:64-7                 
                             4                                                         
                             ```                                                       
                             64:   protected TNEFAttribute(int id, int                 
                             type, InputStream inp) throws IOException                 
                             {                                                         
                             65:      this.type = type;                                
                             66:      int length =                                     
                             LittleEndian.readInt(inp);                                
                             67:                                                       
                             68:      property =                                       
                             TNEFProperty.getBest(id, type);                           
                             69:      data =                                           
                             IOUtils.safelyAllocate(length,                            
                             MAX_RECORD_LENGTH);                                       
                             70:      IOUtils.readFully(inp, data);                    
                             71:                                                       
                             72:      checksum =                                       
                             LittleEndian.readUShort(inp);                             
                             73:   }                                                   
                             74:                                                       
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             poi-scratchpad/src/main/java/org/apache/p                 
                             oi/hmef/attribute/MAPIAttribute.java:119-                 
                             126                                                       
                             ```                                                       
                             119:                                                      
                             try(UnsynchronizedByteArrayInputStream                    
                             inp =                                                     
                             UnsynchronizedByteArrayInputStream.builde                 
                             r().setByteArray(parent.getData()).get())                 
                              {                                                        
                             120:         // First up, get the number                  
                             of attributes                                             
                             121:         int count =                                  
                             LittleEndian.readInt(inp);                                
                             122:         List<MAPIAttribute> attrs =                  
                             new ArrayList<>();                                        
                             123:                                                      
                             124:         // Now, read each one in in                  
                             turn                                                      
                             125:         for(int i=0; i<count; i++) {                 
                             126:            int typeAndMV =                           
                             LittleEndian.readUShort(inp);                             
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             poi-scratchpad/src/main/java/org/apache/p                 
                             oi/hmef/attribute/MAPIAttribute.java:137-                 
                             145                                                       
                             ```                                                       
                             137:            if(typeId ==                              
                             Types.ASCII_STRING.getId() || typeId ==                   
                             Types.UNICODE_STRING.getId() ||                           
                             138:                    typeId ==                         
                             Types.BINARY.getId() || typeId ==                         
                             Types.DIRECTORY.getId()) {                                
                             139:               isVL = true;                           
                             140:            }                                         
                             141:                                                      
                             142:            // Turn the type ID into                  
                             a strongly typed thing                                    
                             143:            MAPIType type =                           
                             Types.getById(typeId);                                    
                             144:            if (type == null) {                       
                             145:               type =                                 
                             Types.createCustom(typeId);                               
                             ```                                                       
                             </code>                                                   
                             <code>                                                    
                             poi-scratchpad/src/main/java/org/apache/p                 
                             oi/hmef/attribute/MAPIAttribute.java:171-                 
                             178                                                       
                             ```                                                       
                             171:                  byte[] mpdata = new                 
                             byte[mplen];                                              
                             172:                  if                                  
                             (IOUtils.readFully(inp, mpdata) < 0) {                    
                             173:                     throw new                        
                             IOException("Not enough data to read " +                  
                             mplen + " bytes for attribute name");                     
                             174:                  }                                   
                             175:                  name =                              
                             StringUtil.getFromUnicodeLE(mpdata, 0,                    
                             (mplen/2)-1);                                             
                             176:                                                      
                             skipToBoundary(mplen, inp);                               
                             177:               }                                      
                             178:                                                      
                             ```                                                       
                             </code>                                                   
                             </code_snippets>                                          
                                                                                       
                             ## Fix Strategy                                           
                             <fix_strategy>                                            
                                                                                       
                             1. Core Issue Analysis                                    
                                - The OOM arises when converting large                 
                             byte arrays to Java Strings in two                        
                             places:                                                   
                                  a) **Custom property names** in                      
                             `MAPIAttribute`:                                          
                                     Unchecked allocation `new                         
                             byte[mplen]` with `mplen` from input →                    
                             potentially huge byte array → huge                        
                             `StringUtil.getFromUnicodeLE` conversion.                 
                                  b) **TNEF text attributes** in                       
                             `TNEFStringAttribute`:                                    
                                     Calls                                             
                             `StringUtil.getFromUnicodeLE(data)` on                    
                             the full `data` array (subject only to                    
                             the 20 MB TNEF record cap), resulting in                  
                             up to ~10 M characters (~20 MB) per                       
                             string conversion.                                        
                                - The existing cap in `TNEFAttribute`                  
                             (20 MB) and in `MAPIAttribute` value data                 
                             (1 MB) does not protect these two code                    
                             paths:                                                    
                                  - The direct `new byte[mplen]`                       
                             bypasses safe allocation.                                 
                                  - The full-length string conversion                  
                             bypasses any smaller “string‐safe” cap.                   
                                                                                       
                             2. Patch Plan                                             
                                A. **Secure byte-array allocation in                   
                             MAPIAttribute**                                           
                                   - Replace uncontrolled `new                         
                             byte[mplen]` with a call to                               
                             `IOUtils.safelyAllocate(mplen,                            
                             MAX_RECORD_LENGTH_MAPI)` (where                           
                             `MAX_RECORD_LENGTH_MAPI` is already 1                     
                             MB).                                                      
                                   - This prevents adversarial `mplen`                 
                             exceeding the intended 1 MB cap for MAPI                  
                             property names.                                           
                                B. **Impose a reasonable maximum on                    
                             text string conversions in                                
                             TNEFStringAttribute**                                     
                                   - Introduce a constant, e.g.                        
                                      `private static final int                        
                             MAX_TNEF_STRING_BYTES = 1_048_576; // 1                   
                             MB`                                                       
                                   - Before calling                                    
                             `StringUtil.getFromUnicodeLE(data, 0,                     
                             data.length/2)`, check:                                   
                                      ```java                                          
                                      if (data.length >                                
                             MAX_TNEF_STRING_BYTES) {                                  
                                          throw new                                    
                             IllegalArgumentException(                                 
                                              "TNEF string data too                    
                             large: " + data.length + " bytes"                         
                                          );                                           
                                      }                                                
                                      ```                                              
                                   - This bounds the worst‐case `len`                  
                             to ≤ 524 288 characters, limiting memory                  
                             spikes.                                                   
                                C. **Optional: Centralize                              
                             “string‐safe” cap**                                       
                                   - For maintainability, consider                     
                             adding an overload in `StringUtil` that                   
                             enforces a global max‐char‐count (e.g. 1                  
                             M chars). Call this new helper from TNEF‐                 
                             and MAPI‐specific code paths instead of                   
                             the public raw API.                                       
                                   - This avoids scattering magic                      
                             numbers and preserves existing                            
                             `StringUtil.getFromUnicodeLE` semantics                   
                             for other modules.                                        
                             3. Step-by-Step Implementation                            
                                1. In `MAPIAttribute.java` (around                     
                             lines 171–178):                                           
                                   – Change                                            
                                      ```java                                          
                                      byte[] mpdata = new byte[mplen];                 
                                      ```                                              
                                     to                                                
                                      ```java                                          
                                      byte[] mpdata =                                  
                             IOUtils.safelyAllocate(mplen,                             
                             MAX_RECORD_LENGTH);                                       
                                      ```                                              
                                     (Reuse existing                                   
                             `MAX_RECORD_LENGTH` = 1 MB.)                              
                                   – Leave the subsequent `readFully`                  
                             and `getFromUnicodeLE` calls unchanged.                   
                                2. In `TNEFStringAttribute.java`                       
                             (around lines 44–52):                                     
                                   – Add at the top:                                   
                                      ```java                                          
                                      private static final int                         
                             MAX_TNEF_STRING_BYTES = 1_048_576;                        
                                      ```                                              
                                   – Before calling                                    
                             `StringUtil.getFromUnicodeLE(data…)`,                     
                             insert:                                                   
                                      ```java                                          
                                      if (data.length >                                
                             MAX_TNEF_STRING_BYTES) {                                  
                                          throw new                                    
                             IllegalArgumentException(                                 
                                              "TNEF text attribute                     
                             exceeds allowed size: " + data.length                     
                                          );                                           
                                      }                                                
                                      ```                                              
                                3. (Optional) In `StringUtil.java`,                    
                             add:                                                      
                                   ```java                                             
                                   public static String                                
                             getFromUnicodeLESafe(byte[] string, int                   
                             offset, int len, int maxChars) {                          
                                       if (len > maxChars) {                           
                                           throw new                                   
                             IllegalArgumentException("Requested                       
                             UnicodeLE string length too large: " +                    
                             len);                                                     
                                       }                                               
                                       return getFromUnicodeLE(string,                 
                             offset, len);                                             
                                   }                                                   
                                   ```                                                 
                                   – Update callers in TNEF and MAPI                   
                             to use `getFromUnicodeLESafe` with their                  
                             own maxChars.                                             
                             4. Preservation of Functionality                          
                                - All existing parsing logic, boundary                 
                             checks, and type workflows remain                         
                             untouched.                                                
                                - Only overly‐large inputs are now                     
                             rejected with an                                          
                             `IllegalArgumentException` rather than                    
                             exhausting the JVM heap.                                  
                                - The TNEF and MAPI record‐size caps                   
                             (20 MB and 1 MB respectively) are                         
                             preserved or tightened only for string                    
                             conversion.                                               
                                - Other consumers of                                   
                             `StringUtil.getFromUnicodeLE` remain                      
                             unaffected.                                               
                             5. Side Effects & Mitigations                             
                                - **Side Effect**: Legitimate very                     
                             large strings (exceeding 1 MB) in TNEF                    
                             may now be rejected.                                      
                                  **Mitigation**: Document the new                     
                             limit in release notes or allow                           
                             configuration via a system property or                    
                             POI registry if larger payloads must be                   
                             supported.                                                
                                - **Side Effect**: Slight code churn                   
                             in `MAPIAttribute`.                                       
                                  **Mitigation**: All existing unit                    
                             tests for MAPI property parsing should                    
                             still pass; new tests can verify                          
                             rejection of oversized names.                             
                             6. Testing Recommendations                                
                                - Add a fuzz harness test where a                      
                             custom MAPI property name length field >1                 
                             MB is fed; assert that an                                 
                             `IllegalArgumentException` is thrown                      
                             quickly (no OOM).                                         
                                - Add a unit test for                                  
                             `TNEFStringAttribute` with a data array                   
                             longer than `MAX_TNEF_STRING_BYTES` to                    
                             confirm immediate failure.                                
                                - Run full POI test suite and HMEF                     
                             fuzzer suite to ensure no regressions.                    
                             7. No Harness or External Library Changes                 
                                - All modifications are confined to                    
                             POI’s HMEF parsing classes and utility                    
                             classes.                                                  
                                - Fuzzing entry‐point                                  
                             (`POIHMEFFuzzer`) and IOUtils definitions                 
                             remain untouched.                                         
                                                                                       
                             </fix_strategy>                                           
                             ===Tests Result===                                        
                             No tests found                                            
                             ===Evaluation End===                                      
                    INFO     Prism Supervisor Routing:                  __init__.py:160
                             TeamStatus.EVALUATE -> TeamStatus.END                     
                             (n evals: 2, patch status:                                
                             PatchStatus.SOUND)                                        
                    INFO     Building environment                       __init__.py:132
                             - Cache directory: /tmp/tmpo4vm71_w                       
                             - Max timeout: 1800                                       
                             - Output directory:                                       
                             reports/prism.prism_o4_mini/apache-poi_poi                
                             -full-01_vuln_1/agent-output-1762186442.25                
                             66333                                                     
                             - Detection toml file:                                    
                             /tasks_new/apache-poi_poi-full-01/detectio                
                             n/apache-poi_poi-full-01_vuln_1.toml                      
                             - Challenge project directory:                            
                             /tasks_new/apache-poi_poi-full-01/official                
                             -afc-poi                                                  
                                                                                       
