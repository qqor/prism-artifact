{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_7",
  "source_directory": "/tasks_new/pdfbox_pdfbox-full-01/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 1.6349146000000003,
    "prompt_tokens": 871654,
    "completion_tokens": 153658
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BaseParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BaseParser.java\n@@ -338,8 +338,10 @@\n      */\n     private boolean readUntilEndOfCOSDictionary() throws IOException\n     {\n+        long maxDictScan = Long.getLong(\"pdfbox.parser.maxCOSDictBytes\", 1024 * 1024);\n+        long dictScanned = 0;\n         int c = source.read();\n-        while (c != -1 && c != '/' && c != '>')\n+        while (c != -1 && c != '/' && c != '>' && dictScanned++ < maxDictScan)\n         {\n             // in addition to stopping when we find / or >, we also want\n             // to stop when we find endstream or endobj.\n@@ -365,6 +367,12 @@\n                 }\n             }\n             c = source.read();\n+        }\n+        if (dictScanned >= maxDictScan)\n+        {\n+            LOG.warn(\"readUntilEndOfCOSDictionary exceeded {} bytes at offset {}, aborting recovery\",\n+                     maxDictScan, source.getPosition());\n+            return true;\n         }\n         if (c == -1)\n         {\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -180,9 +180,12 @@\n     private final class PageIterator implements Iterator<PDPage>\n     {\n         private final Queue<COSDictionary> queue = new ArrayDeque<>();\n+        private final Set<COSDictionary> visited = new HashSet<>();\n \n         private PageIterator(COSDictionary node)\n         {\n+            // Initialize cycle detection\n+            visited.clear();\n             List<COSDictionary> kids = enqueueKids(node);\n             while (!kids.isEmpty())\n             {\n@@ -205,13 +208,26 @@\n          */\n         private List<COSDictionary> enqueueKids(COSDictionary node)\n         {\n+            if (node == null || !visited.add(node))\n+            {\n+                return Collections.emptyList();\n+            }\n             if (isPageTreeNode(node))\n             {\n-                return getKids(node);\n+                List<COSDictionary> kids = getKids(node);\n+                List<COSDictionary> filtered = new ArrayList<>();\n+                for (COSDictionary kid : kids)\n+                {\n+                    if (visited.add(kid))\n+                    {\n+                        filtered.add(kid);\n+                    }\n+                }\n+                return filtered;\n             }\n             else\n             {\n-                if (node != null && COSName.PAGE.equals(node.getCOSName(COSName.TYPE)))\n+                if (COSName.PAGE.equals(node.getCOSName(COSName.TYPE)))\n                 {\n                     queue.add(node);\n                 }\n@@ -221,7 +237,7 @@\n                             () -> (node == null ? \"(null)\" : node.getCOSName(COSName.TYPE)));\n                 }\n             }\n-            return Collections.EMPTY_LIST;\n+            return Collections.emptyList();\n         }\n \n         @Override\n",
  "stdout": "",
  "stderr": ""
}