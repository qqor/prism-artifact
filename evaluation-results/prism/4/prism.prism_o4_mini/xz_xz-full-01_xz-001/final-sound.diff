--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -63,9 +63,10 @@
 }
 
 // Walk the tree to calculate the e37vk checksum
-static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
+static uint32_t
+compute_tree_checksum(TreeNode *node, unsigned int depth)
 {
-  // Skip if already hashed
+  // Skip if null or already fully hashed
   if (!node || node->state == STATE_HASHED) {
     return 0;
   }
@@ -73,7 +74,7 @@
   // Compute initial checksum from depth and value
   uint32_t sum = node->value * (depth + 1);
 
-  // Traverse the child nodes if not already visited
+  // Only traverse and free on first visit
   if (node->state == STATE_CLEAR) {
     node->state = STATE_VISITED;
     for (size_t i = 0; i < node->edge_count; ++i) {
@@ -83,11 +84,11 @@
       }
     }
     node->state = STATE_HASHED;
+
+    // Free memory exactly once
+    free(node->edges);
+    free(node);
   }
-
-  // Free the node and edges
-  free(node->edges);
-  free(node);
 
   return sum;
 }
