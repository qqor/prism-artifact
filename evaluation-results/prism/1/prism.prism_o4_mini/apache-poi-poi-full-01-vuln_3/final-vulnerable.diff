--- a/poi/src/main/java/org/apache/poi/hssf/record/RecordFactoryInputStream.java
+++ b/poi/src/main/java/org/apache/poi/hssf/record/RecordFactoryInputStream.java
@@ -54,6 +54,10 @@
 
         public StreamEncryptionInfo(RecordInputStream rs, List<org.apache.poi.hssf.record.Record> outputRecs) {
             Record rec;
+            if (!rs.hasNextRecord()) {
+                throw new RecordFormatException(
+                    "Unexpected end of record stream during StreamEncryptionInfo initialization (no first record)");
+            }
             rs.nextRecord();
             int recSize = 4 + rs.remaining();
             rec = RecordFactory.createSingleRecord(rs);
@@ -64,32 +68,38 @@
                 
                 // Fetch the next record, and see if it indicates whether
                 //  the document is encrypted or not
-                if (rs.hasNextRecord()) {
+                if (!rs.hasNextRecord()) {
+                    throw new RecordFormatException(
+                        "Unexpected end of record stream after BOFRecord");
+                }
+                rs.nextRecord();
+                rec = RecordFactory.createSingleRecord(rs);
+                recSize += rec.getRecordSize();
+                outputRecs.add(rec);
+                
+                // Encrypted is normally BOF then FILEPASS
+                // May sometimes be BOF, WRITEPROTECT, FILEPASS
+                if (rec instanceof WriteProtectRecord) {
+                    if (!rs.hasNextRecord()) {
+                        throw new RecordFormatException(
+                            "Unexpected end of record stream after WriteProtectRecord");
+                    }
                     rs.nextRecord();
                     rec = RecordFactory.createSingleRecord(rs);
                     recSize += rec.getRecordSize();
                     outputRecs.add(rec);
-                    
-                    // Encrypted is normally BOF then FILEPASS
-                    // May sometimes be BOF, WRITEPROTECT, FILEPASS
-                    if (rec instanceof WriteProtectRecord && rs.hasNextRecord()) {
-                   rs.nextRecord();
-                   rec = RecordFactory.createSingleRecord(rs);
-                   recSize += rec.getRecordSize();
-                   outputRecs.add(rec);
-                    }
-                    
-                    // If it's a FILEPASS, track it specifically
-                    if (rec instanceof FilePassRecord) {
-                        fpr = (FilePassRecord) rec;
-                    }
-
-                    // workbook not encrypted (typical case)
-                    if (rec instanceof EOFRecord) {
-                        // A workbook stream is never empty, so crash instead
-                        // of trying to keep track of nesting level
-                        throw new IllegalStateException("Nothing between BOF and EOF");
-                    }
+                }
+                
+                // If it's a FILEPASS, track it specifically
+                if (rec instanceof FilePassRecord) {
+                    fpr = (FilePassRecord) rec;
+                }
+                
+                // workbook not encrypted (typical case)
+                if (rec instanceof EOFRecord) {
+                    // A workbook stream is never empty, so crash instead
+                    // of trying to keep track of nesting level
+                    throw new IllegalStateException("Nothing between BOF and EOF");
                 }
             } else {
                 // Invalid in a normal workbook stream.
