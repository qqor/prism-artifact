[10/09/25 09:34:41] INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmptcpj67xz                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/wireshark-ws-full-01-vuln_002/agent-output-1760002481.9175584                                      
                             - Detection toml file: /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/detection/wireshark-ws-full-01-vuln_002.toml                                    
                             - Challenge project directory: /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/official-afc-wireshark                                                  
                                                                                                                                                                                
                    INFO     [logging_performance](wireshark Building Cached for CLEAN environment) Started...                                             context_managers.py:9
[10/09/25 09:41:46] INFO     [logging_performance](wireshark Building Cached for CLEAN environment) Took 424.30 seconds; exception=False                  context_managers.py:23
                    INFO     [logging_performance](wireshark Running tests for Cached for CLEAN environment) Started...                                    context_managers.py:9
                    INFO     [logging_performance](wireshark Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False           context_managers.py:23
                    INFO     Setting timeouts                                                                                                                      default.py:85
                               - build: 878 (original: 424)                                                                                                                     
                               - run tests: 600 (original: 0)                                                                                                                   
                    INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:41:47] INFO     [logging_performance](wireshark Setting owner) Took 0.96 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:42:35] INFO     Successfully created Cached for CLEAN environment                                                                                   oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                           oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                
                    INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:42:43] INFO     [logging_performance](wireshark Setting owner) Took 8.53 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:42:44] INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:42:45] INFO     [logging_performance](wireshark Setting owner) Took 1.00 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:42:48] INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                             
                             ===Evaluator Diff===                                                                                                                               
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                             + FUZZER=handler_telnet                                                                                                                            
                             + shift                                                                                                                                            
                             + '[' '!' -v TESTCASE ']'                                                                                                                          
                             + TESTCASE=/testcase                                                                                                                               
                             + '[' '!' -f /testcase ']'                                                                                                                         
                             + export RUN_FUZZER_MODE=interactive                                                                                                               
                             + RUN_FUZZER_MODE=interactive                                                                                                                      
                             + export FUZZING_ENGINE=libfuzzer                                                                                                                  
                             + FUZZING_ENGINE=libfuzzer                                                                                                                         
                             + export SKIP_SEED_CORPUS=1                                                                                                                        
                             + SKIP_SEED_CORPUS=1                                                                                                                               
                             + run_fuzzer handler_telnet -runs=100 /testcase                                                                                                    
                             vm.mmap_rnd_bits = 28                                                                                                                              
                             /out/handler_telnet -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -max_len=1024 -timeout_exitcode=0 < /dev/null                               
                             oss-fuzzshark: disabling: ip                                                                                                                       
                             oss-fuzzshark: disabling: udp                                                                                                                      
                             oss-fuzzshark: disabling: udplite                                                                                                                  
                             oss-fuzzshark: disabling: ospf                                                                                                                     
                             oss-fuzzshark: disabling: bgp                                                                                                                      
                             oss-fuzzshark: disabling: dhcp                                                                                                                     
                             oss-fuzzshark: disabling: json                                                                                                                     
                             oss-fuzzshark: disabling: snort                                                                                                                    
                             oss-fuzzshark: configured for dissector: telnet                                                                                                    
                             INFO: Running with entropic power schedule (0xFF, 100).                                                                                            
                             INFO: Seed: 2679179743                                                                                                                             
                             INFO: Loaded 1 modules   (420518 inline 8-bit counters): 420518 [0xa9f6a00, 0xaa5d4a6),                                                            
                             INFO: Loaded 1 PC tables (420518 PCs): 420518 [0xaa5d4a8,0xb0c7f08),                                                                               
                             /out/handler_telnet: Running 1 inputs 100 time(s) each.                                                                                            
                             Running: /testcase                                                                                                                                 
                             =================================================================                                                                                  
                             ==18==ERROR: AddressSanitizer: heap-use-after-free on address 0x51c000000880 at pc 0x0000050713e4 bp 0x7ffdcd958580 sp                             
                             0x7ffdcd957d40                                                                                                                                     
                             WRITE of size 4 at 0x51c000000880 thread T0                                                                                                        
                             SCARINESS: 46 (4-byte-write-heap-use-after-free)                                                                                                   
                                 #0 0x50713e3 in __asan_memcpy /src/llvm-project/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:63:3                                  
                                 #1 0x79837ca in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10                                                             
                                 #2 0x79837ca in tvb_memcpy /src/wireshark/epan/tvbuff.c:945:10                                                                                 
                                 #3 0x79930ae in _tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4047:3                                                              
                                 #4 0x79930ae in tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4073:8                                                               
                                 #5 0x76374d5 in telnet_add_text /src/wireshark/epan/dissectors/packet-telnet.c:2211:5                                                          
                                 #6 0x7636e20 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2337:9                                                           
                                 #7 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #8 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #9 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #10 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                   
                                 #11 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #12 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #13 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #14 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #15 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #16 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #17 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #18 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #19 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #20 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #21 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #22 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #23 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                 #24 0x4f49cad in _start (/out/handler_telnet+0x4f49cad)                                                                                        
                                                                                                                                                                                
                             DEDUP_TOKEN: __asan_memcpy--memcpy--tvb_memcpy                                                                                                     
                             0x51c000000880 is located 0 bytes inside of 1920-byte region [0x51c000000880,0x51c000001000)                                                       
                             freed by thread T0 here:                                                                                                                           
                                 #0 0x50731c6 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:52:3                                                         
                                 #1 0x7a1cb28 in wmem_simple_free /src/wireshark/wsutil/wmem/wmem_allocator_simple.c:54:5                                                       
                                 #2 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #3 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #4 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #5 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #6 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #7 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #8 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #9 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                             
                                 #10 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #11 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #12 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #13 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #14 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #15 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #16 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #17 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #18 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #19 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #20 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #21 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_free--wmem_simple_free--telnet_sub_option                                                                               
                             previously allocated by thread T0 here:                                                                                                            
                                 #0 0x507345f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3                                                       
                                 #1 0x7b083d8 in g_malloc (/out/handler_telnet+0x7b083d8)                                                                                       
                                 #2 0x763824e in dissect_naws_subopt /src/wireshark/epan/dissectors/packet-telnet.c:652:29                                                      
                                 #3 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #4 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #5 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #6 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #7 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #8 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #9 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #10 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #11 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #12 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #13 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #14 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #15 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #16 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #17 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #18 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #19 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #20 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #21 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #22 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_malloc--g_malloc--dissect_naws_subopt                                                                                   
                             SUMMARY: AddressSanitizer: heap-use-after-free /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10 in memcpy                               
                             Shadow bytes around the buggy address:                                                                                                             
                               0x51c000000600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa fa                                                                                  
                               0x51c000000800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa                                                                                  
                             =>0x51c000000880:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000900: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000980: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000b00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                             Shadow byte legend (one shadow byte represents 8 application bytes):                                                                               
                               Addressable:           00                                                                                                                        
                               Partially addressable: 01 02 03 04 05 06 07                                                                                                      
                               Heap left redzone:       fa                                                                                                                      
                               Freed heap region:       fd                                                                                                                      
                               Stack left redzone:      f1                                                                                                                      
                               Stack mid redzone:       f2                                                                                                                      
                               Stack right redzone:     f3                                                                                                                      
                               Stack after return:      f5                                                                                                                      
                               Stack use after scope:   f8                                                                                                                      
                               Global redzone:          f9                                                                                                                      
                               Global init order:       f6                                                                                                                      
                               Poisoned by user:        f7                                                                                                                      
                               Container overflow:      fc                                                                                                                      
                               Array cookie:            ac                                                                                                                      
                               Intra object redzone:    bb                                                                                                                      
                               ASan internal:           fe                                                                                                                      
                               Left alloca redzone:     ca                                                                                                                      
                               Right alloca redzone:    cb                                                                                                                      
                             ==18==ABORTING                                                                                                                                     
                             MS: 0 ; base unit: 0000000000000000000000000000000000000000                                                                                        
                             0xff,0xfa,0x1f,0x0,0x50,0x0,0x18,0xff,0xf0,0xff,0xfa,0x22,0x1,0x1,0xff,0xf0,0x61,0x61,0x61,0x61,                                                   
                             \377\372\037\000P\000\030\377\360\377\372\"\001\001\377\360aaaa                                                                                    
                             subprocess command returned a non-zero exit status: 1                                                                                              
                             INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64                  
                             -v /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/fuzz-tooling/build/out/wireshark:/out -v /tmp/tmphuzkv_0s:/testcase -t                              
                             ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce handler_telnet -runs=100.                                                                        
                                                                                                                                                                                
                             ===Issue===                                                                                                                                        
                             + FUZZER=handler_telnet                                                                                                                            
                             + shift                                                                                                                                            
                             + '[' '!' -v TESTCASE ']'                                                                                                                          
                             + TESTCASE=/testcase                                                                                                                               
                             + '[' '!' -f /testcase ']'                                                                                                                         
                             + export RUN_FUZZER_MODE=interactive                                                                                                               
                             + RUN_FUZZER_MODE=interactive                                                                                                                      
                             + export FUZZING_ENGINE=libfuzzer                                                                                                                  
                             + FUZZING_ENGINE=libfuzzer                                                                                                                         
                             + export SKIP_SEED_CORPUS=1                                                                                                                        
                             + SKIP_SEED_CORPUS=1                                                                                                                               
                             + run_fuzzer handler_telnet -runs=100 /testcase                                                                                                    
                             vm.mmap_rnd_bits = 28                                                                                                                              
                             /out/handler_telnet -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -max_len=1024 -timeout_exitcode=0 < /dev/null                               
                             oss-fuzzshark: disabling: ip                                                                                                                       
                             oss-fuzzshark: disabling: udp                                                                                                                      
                             oss-fuzzshark: disabling: udplite                                                                                                                  
                             oss-fuzzshark: disabling: ospf                                                                                                                     
                             oss-fuzzshark: disabling: bgp                                                                                                                      
                             oss-fuzzshark: disabling: dhcp                                                                                                                     
                             oss-fuzzshark: disabling: json                                                                                                                     
                             oss-fuzzshark: disabling: snort                                                                                                                    
                             oss-fuzzshark: configured for dissector: telnet                                                                                                    
                             INFO: Running with entropic power schedule (0xFF, 100).                                                                                            
                             INFO: Seed: 2679179743                                                                                                                             
                             INFO: Loaded 1 modules   (420518 inline 8-bit counters): 420518 [0xa9f6a00, 0xaa5d4a6),                                                            
                             INFO: Loaded 1 PC tables (420518 PCs): 420518 [0xaa5d4a8,0xb0c7f08),                                                                               
                             /out/handler_telnet: Running 1 inputs 100 time(s) each.                                                                                            
                             Running: /testcase                                                                                                                                 
                             =================================================================                                                                                  
                             ==18==ERROR: AddressSanitizer: heap-use-after-free on address 0x51c000000880 at pc 0x0000050713e4 bp 0x7ffdcd958580 sp                             
                             0x7ffdcd957d40                                                                                                                                     
                             WRITE of size 4 at 0x51c000000880 thread T0                                                                                                        
                             SCARINESS: 46 (4-byte-write-heap-use-after-free)                                                                                                   
                                 #0 0x50713e3 in __asan_memcpy /src/llvm-project/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:63:3                                  
                                 #1 0x79837ca in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10                                                             
                                 #2 0x79837ca in tvb_memcpy /src/wireshark/epan/tvbuff.c:945:10                                                                                 
                                 #3 0x79930ae in _tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4047:3                                                              
                                 #4 0x79930ae in tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4073:8                                                               
                                 #5 0x76374d5 in telnet_add_text /src/wireshark/epan/dissectors/packet-telnet.c:2211:5                                                          
                                 #6 0x7636e20 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2337:9                                                           
                                 #7 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #8 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #9 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #10 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                   
                                 #11 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #12 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #13 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #14 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #15 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #16 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #17 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #18 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #19 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #20 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #21 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #22 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #23 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                 #24 0x4f49cad in _start (/out/handler_telnet+0x4f49cad)                                                                                        
                                                                                                                                                                                
                             DEDUP_TOKEN: __asan_memcpy--memcpy--tvb_memcpy                                                                                                     
                             0x51c000000880 is located 0 bytes inside of 1920-byte region [0x51c000000880,0x51c000001000)                                                       
                             freed by thread T0 here:                                                                                                                           
                                 #0 0x50731c6 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:52:3                                                         
                                 #1 0x7a1cb28 in wmem_simple_free /src/wireshark/wsutil/wmem/wmem_allocator_simple.c:54:5                                                       
                                 #2 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #3 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #4 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #5 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #6 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #7 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #8 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #9 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                             
                                 #10 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #11 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #12 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #13 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #14 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #15 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #16 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #17 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #18 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #19 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #20 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #21 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_free--wmem_simple_free--telnet_sub_option                                                                               
                             previously allocated by thread T0 here:                                                                                                            
                                 #0 0x507345f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3                                                       
                                 #1 0x7b083d8 in g_malloc (/out/handler_telnet+0x7b083d8)                                                                                       
                                 #2 0x763824e in dissect_naws_subopt /src/wireshark/epan/dissectors/packet-telnet.c:652:29                                                      
                                 #3 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #4 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #5 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #6 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #7 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #8 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #9 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #10 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #11 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #12 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #13 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #14 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #15 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #16 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #17 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #18 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #19 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #20 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #21 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #22 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_malloc--g_malloc--dissect_naws_subopt                                                                                   
                             SUMMARY: AddressSanitizer: heap-use-after-free /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10 in memcpy                               
                             Shadow bytes around the buggy address:                                                                                                             
                               0x51c000000600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa fa                                                                                  
                               0x51c000000800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa                                                                                  
                             =>0x51c000000880:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000900: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000980: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000b00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                             Shadow byte legend (one shadow byte represents 8 application bytes):                                                                               
                               Addressable:           00                                                                                                                        
                               Partially addressable: 01 02 03 04 05 06 07                                                                                                      
                               Heap left redzone:       fa                                                                                                                      
                               Freed heap region:       fd                                                                                                                      
                               Stack left redzone:      f1                                                                                                                      
                               Stack mid redzone:       f2                                                                                                                      
                               Stack right redzone:     f3                                                                                                                      
                               Stack after return:      f5                                                                                                                      
                               Stack use after scope:   f8                                                                                                                      
                               Global redzone:          f9                                                                                                                      
                               Global init order:       f6                                                                                                                      
                               Poisoned by user:        f7                                                                                                                      
                               Container overflow:      fc                                                                                                                      
                               Array cookie:            ac                                                                                                                      
                               Intra object redzone:    bb                                                                                                                      
                               ASan internal:           fe                                                                                                                      
                               Left alloca redzone:     ca                                                                                                                      
                               Right alloca redzone:    cb                                                                                                                      
                             ==18==ABORTING                                                                                                                                     
                             MS: 0 ; base unit: 0000000000000000000000000000000000000000                                                                                        
                             0xff,0xfa,0x1f,0x0,0x50,0x0,0x18,0xff,0xf0,0xff,0xfa,0x22,0x1,0x1,0xff,0xf0,0x61,0x61,0x61,0x61,                                                   
                             \377\372\037\000P\000\030\377\360\377\372\"\001\001\377\360aaaa                                                                                    
                             subprocess command returned a non-zero exit status: 1                                                                                              
                             INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64                  
                             -v /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/fuzz-tooling/build/out/wireshark:/out -v /tmp/tmphuzkv_0s:/testcase -t                              
                             ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce handler_telnet -runs=100.                                                                        
                                                                                                                                                                                
                             ===Evaluation Report===                                                                                                                            
                                                                                                                                                                                
                             ===Analysis Report===                                                                                                                              
                                                                                                                                                                                
                             ===Evaluation End===                                                                                                                               
[10/09/25 09:43:00] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                 __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/09/25 09:44:34] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/09/25 09:45:40] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
                    INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:45:41] INFO     [logging_performance](wireshark Setting owner) Took 0.97 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:45:42] INFO     [logging_performance](wireshark Patching) Started...                                                                          context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmpog13hc5i                                                                                                default.py:173
[10/09/25 09:50:54] INFO     [logging_performance](wireshark Patching) Took 312.24 seconds; exception=False                                               context_managers.py:23
                    INFO     [logging_performance](wireshark Checking build) Started...                                                                    context_managers.py:9
[10/09/25 09:55:22] INFO     [logging_performance](wireshark Checking build) Took 268.31 seconds; exception=False                                         context_managers.py:23
                    INFO     [logging_performance](wireshark Running PoV) Started...                                                                       context_managers.py:9
[10/09/25 09:55:25] INFO     [logging_performance](wireshark Running PoV) Took 2.66 seconds; exception=False                                              context_managers.py:23
                    INFO     [logging_performance](wireshark Testing) Started...                                                                           context_managers.py:9
                    INFO     [logging_performance](wireshark Testing) Took 0.00 seconds; exception=False                                                  context_managers.py:23
                    INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:55:26] INFO     [logging_performance](wireshark Setting owner) Took 0.95 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:56:36] INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:56:37] INFO     [logging_performance](wireshark Setting owner) Took 1.03 seconds; exception=False                                            context_managers.py:23
[10/09/25 09:56:38] INFO     [logging_performance](wireshark Setting owner) Started...                                                                     context_managers.py:9
[10/09/25 09:56:39] INFO     [logging_performance](wireshark Setting owner) Took 1.02 seconds; exception=False                                            context_managers.py:23
                    INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                  
                             ===Evaluator Diff===                                                                                                                               
                             --- a/epan/dissectors/packet-telnet.c                                                                                                              
                             +++ b/epan/dissectors/packet-telnet.c                                                                                                              
                             @@ -636,8 +636,13 @@                                                                                                                               
                              dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,                                           
                                                  int len _U_, proto_tree *tree _U_, proto_item *item _U_)                                                                      
                              {                                                                                                                                                 
                             -  if ( hf_telnet_naws_subopt_set )                                                                                                                
                             +  if (hf_telnet_naws_subopt_set) {                                                                                                                
                                  wmem_free(pinfo->pool, hf_naws_data);                                                                                                         
                             +    /* Clear NAWS mode and reset state to prevent use-after-free */                                                                               
                             +    hf_telnet_naws_subopt_set = 0;                                                                                                                
                             +    hf_naws_data = NULL;                                                                                                                          
                             +    hf_telnet_line = 0;                                                                                                                           
                             +  }                                                                                                                                               
                                                                                                                                                                                
                                return;                                                                                                                                         
                              }                                                                                                                                                 
                             @@ -646,11 +651,17 @@                                                                                                                              
                              dissect_naws_subopt(packet_info *pinfo _U_, const char *optname _U_, tvbuff_t *tvb, int offset,                                                   
                                                  int len _U_, proto_tree *tree, proto_item *item _U_)                                                                          
                              {                                                                                                                                                 
                             +  if (hf_telnet_naws_subopt_set) {                                                                                                                
                             +    wmem_free(pinfo->pool, hf_naws_data);                                                                                                         
                             +    hf_telnet_naws_subopt_set = 0;                                                                                                                
                             +    hf_naws_data = NULL;                                                                                                                          
                             +    hf_telnet_line = 0;                                                                                                                           
                             +  }                                                                                                                                               
                             +                                                                                                                                                  
                                hf_telnet_width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);                                                                                  
                                hf_telnet_height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);                                                                             
                                                                                                                                                                                
                                hf_naws_data = (uint8_t *)wmem_alloc(pinfo->pool, hf_telnet_width * hf_telnet_height);                                                          
                             -                                                                                                                                                  
                                if ( hf_naws_data )                                                                                                                             
                                  hf_telnet_naws_subopt_set = 1;                                                                                                                
                                else                                                                                                                                            
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                                                                                                                                                                                
                             ===Issue===                                                                                                                                        
                             + FUZZER=handler_telnet                                                                                                                            
                             + shift                                                                                                                                            
                             + '[' '!' -v TESTCASE ']'                                                                                                                          
                             + TESTCASE=/testcase                                                                                                                               
                             + '[' '!' -f /testcase ']'                                                                                                                         
                             + export RUN_FUZZER_MODE=interactive                                                                                                               
                             + RUN_FUZZER_MODE=interactive                                                                                                                      
                             + export FUZZING_ENGINE=libfuzzer                                                                                                                  
                             + FUZZING_ENGINE=libfuzzer                                                                                                                         
                             + export SKIP_SEED_CORPUS=1                                                                                                                        
                             + SKIP_SEED_CORPUS=1                                                                                                                               
                             + run_fuzzer handler_telnet -runs=100 /testcase                                                                                                    
                             vm.mmap_rnd_bits = 28                                                                                                                              
                             /out/handler_telnet -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -max_len=1024 -timeout_exitcode=0 < /dev/null                               
                             oss-fuzzshark: disabling: ip                                                                                                                       
                             oss-fuzzshark: disabling: udp                                                                                                                      
                             oss-fuzzshark: disabling: udplite                                                                                                                  
                             oss-fuzzshark: disabling: ospf                                                                                                                     
                             oss-fuzzshark: disabling: bgp                                                                                                                      
                             oss-fuzzshark: disabling: dhcp                                                                                                                     
                             oss-fuzzshark: disabling: json                                                                                                                     
                             oss-fuzzshark: disabling: snort                                                                                                                    
                             oss-fuzzshark: configured for dissector: telnet                                                                                                    
                             INFO: Running with entropic power schedule (0xFF, 100).                                                                                            
                             INFO: Seed: 2679179743                                                                                                                             
                             INFO: Loaded 1 modules   (420518 inline 8-bit counters): 420518 [0xa9f6a00, 0xaa5d4a6),                                                            
                             INFO: Loaded 1 PC tables (420518 PCs): 420518 [0xaa5d4a8,0xb0c7f08),                                                                               
                             /out/handler_telnet: Running 1 inputs 100 time(s) each.                                                                                            
                             Running: /testcase                                                                                                                                 
                             =================================================================                                                                                  
                             ==18==ERROR: AddressSanitizer: heap-use-after-free on address 0x51c000000880 at pc 0x0000050713e4 bp 0x7ffdcd958580 sp                             
                             0x7ffdcd957d40                                                                                                                                     
                             WRITE of size 4 at 0x51c000000880 thread T0                                                                                                        
                             SCARINESS: 46 (4-byte-write-heap-use-after-free)                                                                                                   
                                 #0 0x50713e3 in __asan_memcpy /src/llvm-project/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:63:3                                  
                                 #1 0x79837ca in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10                                                             
                                 #2 0x79837ca in tvb_memcpy /src/wireshark/epan/tvbuff.c:945:10                                                                                 
                                 #3 0x79930ae in _tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4047:3                                                              
                                 #4 0x79930ae in tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4073:8                                                               
                                 #5 0x76374d5 in telnet_add_text /src/wireshark/epan/dissectors/packet-telnet.c:2211:5                                                          
                                 #6 0x7636e20 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2337:9                                                           
                                 #7 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #8 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #9 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #10 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                   
                                 #11 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #12 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #13 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #14 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #15 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #16 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #17 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #18 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #19 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #20 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #21 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #22 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #23 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                 #24 0x4f49cad in _start (/out/handler_telnet+0x4f49cad)                                                                                        
                                                                                                                                                                                
                             DEDUP_TOKEN: __asan_memcpy--memcpy--tvb_memcpy                                                                                                     
                             0x51c000000880 is located 0 bytes inside of 1920-byte region [0x51c000000880,0x51c000001000)                                                       
                             freed by thread T0 here:                                                                                                                           
                                 #0 0x50731c6 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:52:3                                                         
                                 #1 0x7a1cb28 in wmem_simple_free /src/wireshark/wsutil/wmem/wmem_allocator_simple.c:54:5                                                       
                                 #2 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #3 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #4 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #5 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #6 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #7 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #8 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #9 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                             
                                 #10 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #11 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #12 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #13 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #14 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #15 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #16 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #17 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #18 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #19 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #20 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #21 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_free--wmem_simple_free--telnet_sub_option                                                                               
                             previously allocated by thread T0 here:                                                                                                            
                                 #0 0x507345f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3                                                       
                                 #1 0x7b083d8 in g_malloc (/out/handler_telnet+0x7b083d8)                                                                                       
                                 #2 0x763824e in dissect_naws_subopt /src/wireshark/epan/dissectors/packet-telnet.c:652:29                                                      
                                 #3 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #4 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #5 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #6 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #7 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #8 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #9 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #10 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #11 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #12 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #13 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #14 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #15 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #16 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #17 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #18 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #19 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #20 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #21 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #22 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_malloc--g_malloc--dissect_naws_subopt                                                                                   
                             SUMMARY: AddressSanitizer: heap-use-after-free /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10 in memcpy                               
                             Shadow bytes around the buggy address:                                                                                                             
                               0x51c000000600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa fa                                                                                  
                               0x51c000000800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa                                                                                  
                             =>0x51c000000880:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000900: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000980: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000b00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                             Shadow byte legend (one shadow byte represents 8 application bytes):                                                                               
                               Addressable:           00                                                                                                                        
                               Partially addressable: 01 02 03 04 05 06 07                                                                                                      
                               Heap left redzone:       fa                                                                                                                      
                               Freed heap region:       fd                                                                                                                      
                               Stack left redzone:      f1                                                                                                                      
                               Stack mid redzone:       f2                                                                                                                      
                               Stack right redzone:     f3                                                                                                                      
                               Stack after return:      f5                                                                                                                      
                               Stack use after scope:   f8                                                                                                                      
                               Global redzone:          f9                                                                                                                      
                               Global init order:       f6                                                                                                                      
                               Poisoned by user:        f7                                                                                                                      
                               Container overflow:      fc                                                                                                                      
                               Array cookie:            ac                                                                                                                      
                               Intra object redzone:    bb                                                                                                                      
                               ASan internal:           fe                                                                                                                      
                               Left alloca redzone:     ca                                                                                                                      
                               Right alloca redzone:    cb                                                                                                                      
                             ==18==ABORTING                                                                                                                                     
                             MS: 0 ; base unit: 0000000000000000000000000000000000000000                                                                                        
                             0xff,0xfa,0x1f,0x0,0x50,0x0,0x18,0xff,0xf0,0xff,0xfa,0x22,0x1,0x1,0xff,0xf0,0x61,0x61,0x61,0x61,                                                   
                             \377\372\037\000P\000\030\377\360\377\372\"\001\001\377\360aaaa                                                                                    
                             subprocess command returned a non-zero exit status: 1                                                                                              
                             INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64                  
                             -v /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/fuzz-tooling/build/out/wireshark:/out -v /tmp/tmphuzkv_0s:/testcase -t                              
                             ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce handler_telnet -runs=100.                                                                        
                                                                                                                                                                                
                             ===Evaluation Report===                                                                                                                            
                             # Evaluation Report                                                                                                                                
                                                                                                                                                                                
                             ## Summary                                                                                                                                         
                                                                                                                                                                                
                             A fuzzing run against the Wireshark Telnet dissector (`handler_telnet`) triggered an AddressSanitizer error indicating a                           
                             heap-use-after-free. The bug manifests as a 4-byte write via `memcpy` (`tvb_memcpy`) into memory that was previously freed in the                  
                             Telnet sub-option handling code. The crash occurs in `telnet_add_text` while processing Telnet data.                                               
                                                                                                                                                                                
                             ## Description                                                                                                                                     
                                                                                                                                                                                
                             Issue type                                                                                                                                         
                              A classic heap-use-after-free vulnerability detected by AddressSanitizer during fuzz testing.                                                    
                                                                                                                                                                                
                             Observed behavior                                                                                                                                  
                              The fuzzer (`handler_telnet` with libFuzzer) runs the Telnet dissector on crafted input.                                                         
                              During one test iteration, `tvb_memcpy` (intercepted via `__asan_memcpy`) attempts to write into a region that AddressSanitizer                  
                             marks as freed.                                                                                                                                    
                              The invalid write happens at packet-telnet.c:2211 inside `telnet_add_text`.                                                                      
                                                                                                                                                                                
                             Key stack trace frames                                                                                                                             
                             1. __asan_memcpy  memcpy                                                                                                                          
                             2. tvb_memcpy (epan/tvbuff.c:945)                                                                                                                  
                             3. tvb_get_raw_bytes_as_stringz (epan/tvbuff.c:4073)                                                                                               
                             4. telnet_add_text (epan/dissectors/packet-telnet.c:2211)                                                                                          
                             5. dissect_telnet  telnet_command  telnet_sub_option                                                                                             
                             6. malloc in dissect_naws_subopt (packet-telnet.c:652)                                                                                             
                             7. free in wmem_simple_free called by telnet_sub_option (packet-telnet.c:2099)                                                                     
                                                                                                                                                                                
                             Memory lifetime                                                                                                                                    
                              Allocation: `g_malloc` in `dissect_naws_subopt` reserves a buffer for Telnet NAWS sub-option data.                                               
                              Free: that same buffer is released in `telnet_sub_option`.                                                                                       
                              Use-after-free: later, `telnet_add_text` copies data from the freed buffer, triggering the crash.                                                
                                                                                                                                                                                
                             Areas to investigate                                                                                                                               
                              Telnet sub-option parsing and memory management in packet-telnet.c, especially:                                                                  
                                `dissect_naws_subopt`                                                                                                                          
                                `telnet_sub_option` / `telnet_command`                                                                                                         
                                `telnet_add_text`                                                                                                                              
                              The TVBuff API in epan/tvbuff.c (`tvb_memcpy`, `tvb_get_raw_bytes_as_stringz`) to understand buffer ownership and lifetime                       
                             expectations.                                                                                                                                      
                              Registration and lifecycle of per-packet memory pools (wmem) to see how allocations and frees interact across the dissector.                     
                                                                                                                                                                                
                             Important observations                                                                                                                             
                              The harness merely invokes `LLVMFuzzerTestOneInput` on the Telnet dissector; it is not the root cause.                                           
                              AddressSanitizer redzones confirm that writes occur to an entirely freed heap block (shadow bytes fd).                                         
                              The bug is deterministic given the fuzzers generated input; the crash reproduces reliably under ASan.                                           
                                                                                                                                                                                
                             ## Initial Issue Log                                                                                                                               
                             Here is the initial issue log of the codebase:                                                                                                     
                             <issue>                                                                                                                                            
                             + FUZZER=handler_telnet                                                                                                                            
                             + shift                                                                                                                                            
                             + '[' '!' -v TESTCASE ']'                                                                                                                          
                             + TESTCASE=/testcase                                                                                                                               
                             + '[' '!' -f /testcase ']'                                                                                                                         
                             + export RUN_FUZZER_MODE=interactive                                                                                                               
                             + RUN_FUZZER_MODE=interactive                                                                                                                      
                             + export FUZZING_ENGINE=libfuzzer                                                                                                                  
                             + FUZZING_ENGINE=libfuzzer                                                                                                                         
                             + export SKIP_SEED_CORPUS=1                                                                                                                        
                             + SKIP_SEED_CORPUS=1                                                                                                                               
                             + run_fuzzer handler_telnet -runs=100 /testcase                                                                                                    
                             vm.mmap_rnd_bits = 28                                                                                                                              
                             /out/handler_telnet -rss_limit_mb=2560 -timeout=25 -runs=100 /testcase -max_len=1024 -timeout_exitcode=0 < /dev/null                               
                             oss-fuzzshark: disabling: ip                                                                                                                       
                             oss-fuzzshark: disabling: udp                                                                                                                      
                             oss-fuzzshark: disabling: udplite                                                                                                                  
                             oss-fuzzshark: disabling: ospf                                                                                                                     
                             oss-fuzzshark: disabling: bgp                                                                                                                      
                             oss-fuzzshark: disabling: dhcp                                                                                                                     
                             oss-fuzzshark: disabling: json                                                                                                                     
                             oss-fuzzshark: disabling: snort                                                                                                                    
                             oss-fuzzshark: configured for dissector: telnet                                                                                                    
                             INFO: Running with entropic power schedule (0xFF, 100).                                                                                            
                             INFO: Seed: 2679179743                                                                                                                             
                             INFO: Loaded 1 modules   (420518 inline 8-bit counters): 420518 [0xa9f6a00, 0xaa5d4a6),                                                            
                             INFO: Loaded 1 PC tables (420518 PCs): 420518 [0xaa5d4a8,0xb0c7f08),                                                                               
                             /out/handler_telnet: Running 1 inputs 100 time(s) each.                                                                                            
                             Running: /testcase                                                                                                                                 
                             =================================================================                                                                                  
                             ==18==ERROR: AddressSanitizer: heap-use-after-free on address 0x51c000000880 at pc 0x0000050713e4 bp 0x7ffdcd958580 sp                             
                             0x7ffdcd957d40                                                                                                                                     
                             WRITE of size 4 at 0x51c000000880 thread T0                                                                                                        
                             SCARINESS: 46 (4-byte-write-heap-use-after-free)                                                                                                   
                                 #0 0x50713e3 in __asan_memcpy /src/llvm-project/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:63:3                                  
                                 #1 0x79837ca in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10                                                             
                                 #2 0x79837ca in tvb_memcpy /src/wireshark/epan/tvbuff.c:945:10                                                                                 
                                 #3 0x79930ae in _tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4047:3                                                              
                                 #4 0x79930ae in tvb_get_raw_bytes_as_stringz /src/wireshark/epan/tvbuff.c:4073:8                                                               
                                 #5 0x76374d5 in telnet_add_text /src/wireshark/epan/dissectors/packet-telnet.c:2211:5                                                          
                                 #6 0x7636e20 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2337:9                                                           
                                 #7 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #8 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #9 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #10 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                   
                                 #11 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #12 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #13 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #14 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #15 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #16 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #17 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #18 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #19 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #20 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #21 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #22 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #23 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                 #24 0x4f49cad in _start (/out/handler_telnet+0x4f49cad)                                                                                        
                                                                                                                                                                                
                             DEDUP_TOKEN: __asan_memcpy--memcpy--tvb_memcpy                                                                                                     
                             0x51c000000880 is located 0 bytes inside of 1920-byte region [0x51c000000880,0x51c000001000)                                                       
                             freed by thread T0 here:                                                                                                                           
                                 #0 0x50731c6 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:52:3                                                         
                                 #1 0x7a1cb28 in wmem_simple_free /src/wireshark/wsutil/wmem/wmem_allocator_simple.c:54:5                                                       
                                 #2 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #3 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #4 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #5 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #6 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #7 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #8 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #9 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                             
                                 #10 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #11 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #12 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #13 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #14 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #15 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #16 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #17 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #18 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #19 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #20 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #21 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_free--wmem_simple_free--telnet_sub_option                                                                               
                             previously allocated by thread T0 here:                                                                                                            
                                 #0 0x507345f in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:68:3                                                       
                                 #1 0x7b083d8 in g_malloc (/out/handler_telnet+0x7b083d8)                                                                                       
                                 #2 0x763824e in dissect_naws_subopt /src/wireshark/epan/dissectors/packet-telnet.c:652:29                                                      
                                 #3 0x7636bf2 in telnet_sub_option /src/wireshark/epan/dissectors/packet-telnet.c:2099:9                                                        
                                 #4 0x7636bf2 in telnet_command /src/wireshark/epan/dissectors/packet-telnet.c:2182:14                                                          
                                 #5 0x7636bf2 in dissect_telnet /src/wireshark/epan/dissectors/packet-telnet.c:2322:16                                                          
                                 #6 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                               
                                 #7 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                         
                                 #8 0x5b90394 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                        
                                 #9 0x5b90394 in call_all_postdissectors /src/wireshark/epan/packet.c:4166:3                                                                    
                                 #10 0x544b347 in dissect_frame /src/wireshark/epan/dissectors/packet-frame.c:1438:5                                                            
                                 #11 0x5b8573d in call_dissector_through_handle /src/wireshark/epan/packet.c:887:9                                                              
                                 #12 0x5b8573d in call_dissector_work /src/wireshark/epan/packet.c:975:9                                                                        
                                 #13 0x5b81237 in call_dissector_only /src/wireshark/epan/packet.c:3621:8                                                                       
                                 #14 0x5b81237 in call_dissector_with_data /src/wireshark/epan/packet.c:3634:8                                                                  
                                 #15 0x5b81237 in dissect_record /src/wireshark/epan/packet.c:687:3                                                                             
                                 #16 0x52bddb0 in epan_dissect_run /src/wireshark/epan/epan.c:666:2                                                                             
                                 #17 0x50b47c8 in LLVMFuzzerTestOneInput /src/wireshark/fuzz/fuzzshark.c:359:2                                                                  
                                 #18 0x4f674a0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long)                                                          
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13                                                                                     
                                 #19 0x4f51ac5 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long)                                                               
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6                                                                                    
                                 #20 0x4f5755f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long))                                             
                             /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9                                                                                    
                                 #21 0x4f83452 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10                                                            
                                 #22 0x7f42bf039082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId:                                                    
                             5792732f783158c66fb4f3756458ca24e46e827d)                                                                                                          
                                                                                                                                                                                
                             DEDUP_TOKEN: __interceptor_malloc--g_malloc--dissect_naws_subopt                                                                                   
                             SUMMARY: AddressSanitizer: heap-use-after-free /usr/include/x86_64-linux-gnu/bits/string_fortified.h:34:10 in memcpy                               
                             Shadow bytes around the buggy address:                                                                                                             
                               0x51c000000600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                                                                  
                               0x51c000000780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa fa                                                                                  
                               0x51c000000800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa                                                                                  
                             =>0x51c000000880:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000900: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000980: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000a80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                               0x51c000000b00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd                                                                                  
                             Shadow byte legend (one shadow byte represents 8 application bytes):                                                                               
                               Addressable:           00                                                                                                                        
                               Partially addressable: 01 02 03 04 05 06 07                                                                                                      
                               Heap left redzone:       fa                                                                                                                      
                               Freed heap region:       fd                                                                                                                      
                               Stack left redzone:      f1                                                                                                                      
                               Stack mid redzone:       f2                                                                                                                      
                               Stack right redzone:     f3                                                                                                                      
                               Stack after return:      f5                                                                                                                      
                               Stack use after scope:   f8                                                                                                                      
                               Global redzone:          f9                                                                                                                      
                               Global init order:       f6                                                                                                                      
                               Poisoned by user:        f7                                                                                                                      
                               Container overflow:      fc                                                                                                                      
                               Array cookie:            ac                                                                                                                      
                               Intra object redzone:    bb                                                                                                                      
                               ASan internal:           fe                                                                                                                      
                               Left alloca redzone:     ca                                                                                                                      
                               Right alloca redzone:    cb                                                                                                                      
                             ==18==ABORTING                                                                                                                                     
                             MS: 0 ; base unit: 0000000000000000000000000000000000000000                                                                                        
                             0xff,0xfa,0x1f,0x0,0x50,0x0,0x18,0xff,0xf0,0xff,0xfa,0x22,0x1,0x1,0xff,0xf0,0x61,0x61,0x61,0x61,                                                   
                             \377\372\037\000P\000\030\377\360\377\372\"\001\001\377\360aaaa                                                                                    
                             subprocess command returned a non-zero exit status: 1                                                                                              
                             INFO:__main__:Running: docker run --privileged --shm-size=2g --platform linux/amd64 --rm -i -e HELPER=True -e ARCHITECTURE=x86_64                  
                             -v /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/fuzz-tooling/build/out/wireshark:/out -v /tmp/tmphuzkv_0s:/testcase -t                              
                             ghcr.io/aixcc-finals/base-runner:v1.3.0 reproduce handler_telnet -runs=100.                                                                        
                                                                                                                                                                                
                             </issue>                                                                                                                                           
                             ===Analysis Report===                                                                                                                              
                             # Analysis Report                                                                                                                                  
                                                                                                                                                                                
                             ## Relevant Code Snippets                                                                                                                          
                             <code_snippets>                                                                                                                                    
                             <code>                                                                                                                                             
                             epan/dissectors/packet-telnet.c:620-760                                                                                                            
                             ```                                                                                                                                                
                             620:    case 254:                                                                                                                                  
                             621:      proto_tree_add_uint_format(tree, hf_telnet_tabstop, tvb, offset, 1,                                                                      
                             622:                          tabval, "Invalid value: %u", tabval);                                                                                
                             623:      break;                                                                                                                                   
                             624:                                                                                                                                               
                             625:    case 255:                                                                                                                                  
                             626:      proto_tree_add_uint_format(tree, hf_telnet_tabstop, tvb, offset, 1,                                                                      
                             627:                          tabval, "Sender wants receiver to handle tab stops");                                                                
                             628:      break;                                                                                                                                   
                             629:    }                                                                                                                                          
                             630:    offset++;                                                                                                                                  
                             631:    len--;                                                                                                                                     
                             632:  }                                                                                                                                            
                             633:}                                                                                                                                              
                             634:                                                                                                                                               
                             635:static void                                                                                                                                    
                             636:dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,                                        
                             637:                    int len _U_, proto_tree *tree _U_, proto_item *item _U_)                                                                   
                             638:{                                                                                                                                              
                             639:  if ( hf_telnet_naws_subopt_set )                                                                                                             
                             640:    wmem_free(pinfo->pool, hf_naws_data);                                                                                                      
                             641:                                                                                                                                               
                             642:  return;                                                                                                                                      
                             643:}                                                                                                                                              
                             644:                                                                                                                                               
                             645:static void                                                                                                                                    
                             646:dissect_naws_subopt(packet_info *pinfo _U_, const char *optname _U_, tvbuff_t *tvb, int offset,                                                
                             647:                    int len _U_, proto_tree *tree, proto_item *item _U_)                                                                       
                             648:{                                                                                                                                              
                             649:  hf_telnet_width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);                                                                               
                             650:  hf_telnet_height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);                                                                          
                             651:                                                                                                                                               
                             652:  hf_naws_data = (uint8_t *)wmem_alloc(pinfo->pool, hf_telnet_width * hf_telnet_height);                                                       
                             653:                                                                                                                                               
                             654:  if ( hf_naws_data )                                                                                                                          
                             655:    hf_telnet_naws_subopt_set = 1;                                                                                                             
                             656:  else                                                                                                                                         
                             657:    hf_telnet_naws_subopt_set = 0;                                                                                                             
                             658:                                                                                                                                               
                             659:  proto_tree_add_item(tree, hf_telnet_naws_subopt_width, tvb, offset, 2, ENC_BIG_ENDIAN);                                                      
                             660:  offset += 2;                                                                                                                                 
                             661:  proto_tree_add_item(tree, hf_telnet_naws_subopt_height, tvb, offset, 2, ENC_BIG_ENDIAN);                                                     
                             662:}                                                                                                                                              
                             663:                                                                                                                                               
                             664:/* BEGIN RFC-2217 (COM Port Control) Definitions */                                                                                            
                             665:                                                                                                                                               
                             666:#define TNCOMPORT_SIGNATURE             0                                                                                                      
                             667:#define TNCOMPORT_SETBAUDRATE           1                                                                                                      
                             668:#define TNCOMPORT_SETDATASIZE           2                                                                                                      
                             669:#define TNCOMPORT_SETPARITY             3                                                                                                      
                             670:#define TNCOMPORT_SETSTOPSIZE           4                                                                                                      
                             671:#define TNCOMPORT_SETCONTROL            5                                                                                                      
                             672:#define TNCOMPORT_NOTIFYLINESTATE       6                                                                                                      
                             673:#define TNCOMPORT_NOTIFYMODEMSTATE      7                                                                                                      
                             674:#define TNCOMPORT_FLOWCONTROLSUSPEND    8                                                                                                      
                             675:#define TNCOMPORT_FLOWCONTROLRESUME      9                                                                                                     
                             676:#define TNCOMPORT_SETLINESTATEMASK      10                                                                                                     
                             677:#define TNCOMPORT_SETMODEMSTATEMASK     11                                                                                                     
                             678:#define TNCOMPORT_PURGEDATA             12                                                                                                     
                             679:                                                                                                                                               
                             680:/* END RFC-2217 (COM Port Control) Definitions */                                                                                              
                             681:                                                                                                                                               
                             682:static void                                                                                                                                    
                             683:dissect_comport_subopt(packet_info *pinfo, const char *optname, tvbuff_t *tvb, int offset, int len,                                            
                             684:                       proto_tree *tree, proto_item *item)                                                                                     
                             685:{                                                                                                                                              
                             686:  static const char *datasizes[] = {                                                                                                           
                             687:    "Request",                                                                                                                                 
                             688:    "<invalid>",                                                                                                                               
                             689:    "<invalid>",                                                                                                                               
                             690:    "<invalid>",                                                                                                                               
                             691:    "<invalid>",                                                                                                                               
                             692:    "5",                                                                                                                                       
                             693:    "6",                                                                                                                                       
                             694:    "7",                                                                                                                                       
                             695:    "8"                                                                                                                                        
                             696:  };                                                                                                                                           
                             697:  static const char *parities[] = {                                                                                                            
                             698:    "Request",                                                                                                                                 
                             699:    "None",                                                                                                                                    
                             700:    "Odd",                                                                                                                                     
                             701:    "Even",                                                                                                                                    
                             702:    "Mark",                                                                                                                                    
                             703:    "Space"                                                                                                                                    
                             704:  };                                                                                                                                           
                             705:  static const char *stops[] = {                                                                                                               
                             706:    "Request",                                                                                                                                 
                             707:    "1",                                                                                                                                       
                             708:    "2",                                                                                                                                       
                             709:    "1.5"                                                                                                                                      
                             710:  };                                                                                                                                           
                             711:  static const char *control[] = {                                                                                                             
                             712:    "Output Flow Control Request",                                                                                                             
                             713:    "Output Flow: None",                                                                                                                       
                             714:    "Output Flow: XON/XOFF",                                                                                                                   
                             715:    "Output Flow: CTS/RTS",                                                                                                                    
                             716:    "Break Request",                                                                                                                           
                             717:    "Break: ON",                                                                                                                               
                             718:    "Break: OFF",                                                                                                                              
                             719:    "DTR Request",                                                                                                                             
                             720:    "DTR: ON",                                                                                                                                 
                             721:    "DTR: OFF",                                                                                                                                
                             722:    "RTS Request",                                                                                                                             
                             723:    "RTS: ON",                                                                                                                                 
                             724:    "RTS: OFF",                                                                                                                                
                             725:    "Input Flow Control Request",                                                                                                              
                             726:    "Input Flow: None",                                                                                                                        
                             727:    "Input Flow: XON/XOFF",                                                                                                                    
                             728:    "Input Flow: CTS/RTS",                                                                                                                     
                             729:    "Output Flow: DCD",                                                                                                                        
                             730:    "Input Flow: DTR",                                                                                                                         
                             731:    "Output Flow: DSR"                                                                                                                         
                             732:  };                                                                                                                                           
                             733:  static const char *linestate_bits[] = {                                                                                                      
                             734:    "Data Ready",                                                                                                                              
                             735:    "Overrun Error",                                                                                                                           
                             736:    "Parity Error",                                                                                                                            
                             737:    "Framing Error",                                                                                                                           
                             738:    "Break Detected",                                                                                                                          
                             739:    "Transfer Holding Register Empty",                                                                                                         
                             740:    "Transfer Shift Register Empty",                                                                                                           
                             741:    "Timeout Error"                                                                                                                            
                             742:  };                                                                                                                                           
                             743:  static const char *modemstate_bits[] = {                                                                                                     
                             744:    "DCTS",                                                                                                                                    
                             745:    "DDSR",                                                                                                                                    
                             746:    "TERI",                                                                                                                                    
                             747:    "DDCD",                                                                                                                                    
                             748:    "CTS",                                                                                                                                     
                             749:    "DSR",                                                                                                                                     
                             750:    "RI",                                                                                                                                      
                             751:    "DCD"                                                                                                                                      
                             752:  };                                                                                                                                           
                             753:  static const char *purges[] = {                                                                                                              
                             754:    "Purge None",                                                                                                                              
                             755:    "Purge RX",                                                                                                                                
                             756:    "Purge TX",                                                                                                                                
                             757:    "Purge RX/TX"                                                                                                                              
                             758:  };                                                                                                                                           
                             759:                                                                                                                                               
                             760:  uint8_t cmd;                                                                                                                                 
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             epan/dissectors/packet-telnet.c:2050-2220                                                                                                          
                             ```                                                                                                                                                
                             2050:         */                                                                                                                                   
                             2051:        iac_found = false;                                                                                                                    
                             2052:        cur_offset = iac_offset + 2;                                                                                                          
                             2053:        iac_data += 1;                                                                                                                        
                             2054:      }                                                                                                                                       
                             2055:    }                                                                                                                                         
                             2056:                                                                                                                                              
                             2057:  } while (!iac_found);                                                                                                                       
                             2058:                                                                                                                                              
                             2059:  subneg_len = offset - start_offset;                                                                                                         
                             2060:                                                                                                                                              
                             2061:  start_offset += 3;    /* skip IAC, SB, and option code */                                                                                   
                             2062:  subneg_len -= 3;                                                                                                                            
                             2063:                                                                                                                                              
                             2064:  if (subneg_len > 0) {                                                                                                                       
                             2065:                                                                                                                                              
                             2066:    /* Now dissect the suboption parameters. */                                                                                               
                             2067:    if (opt->dissect != NULL) {                                                                                                               
                             2068:                                                                                                                                              
                             2069:      switch (opt->len_type) {                                                                                                                
                             2070:                                                                                                                                              
                             2071:      case NO_LENGTH:                                                                                                                         
                             2072:        /* There isn't supposed to *be* sub-option negotiation for this. */                                                                   
                             2073:        expert_add_info_format(pinfo, option_item, &ei_telnet_suboption_length, "Bogus suboption data");                                      
                             2074:        return offset;                                                                                                                        
                             2075:                                                                                                                                              
                             2076:      case FIXED_LENGTH:                                                                                                                      
                             2077:        /* Make sure the length is what it's supposed to be. */                                                                               
                             2078:        if (subneg_len - iac_data != opt->optlen) {                                                                                           
                             2079:          expert_add_info_format(pinfo, option_item, &ei_telnet_suboption_length, "Suboption parameter length is %d, should                   
                             be %d", subneg_len, opt->optlen);                                                                                                                  
                             2080:          return offset;                                                                                                                      
                             2081:        }                                                                                                                                     
                             2082:        break;                                                                                                                                
                             2083:                                                                                                                                              
                             2084:      case VARIABLE_LENGTH:                                                                                                                   
                             2085:        /* Make sure the length is greater than the minimum. */                                                                               
                             2086:        if (subneg_len - iac_data < opt->optlen) {                                                                                            
                             2087:          expert_add_info_format(pinfo, option_item, &ei_telnet_suboption_length, "Suboption parameter length is %d, should                   
                             be at least %d", subneg_len, opt->optlen);                                                                                                         
                             2088:          return offset;                                                                                                                      
                             2089:        }                                                                                                                                     
                             2090:        break;                                                                                                                                
                             2091:      }                                                                                                                                       
                             2092:                                                                                                                                              
                             2093:      /* We have a dissector for this suboption's parameters; call it. */                                                                     
                             2094:      if (iac_data > 0) {                                                                                                                     
                             2095:        /* Data is escaped, we have to unescape it. */                                                                                        
                             2096:        unescaped_tvb = unescape_and_tvbuffify_telnet_option(pinfo, tvb, start_offset, subneg_len);                                           
                             2097:        (*opt->dissect)(pinfo, opt->name, unescaped_tvb, 0, subneg_len - iac_data, option_tree, option_item);                                 
                             2098:      } else {                                                                                                                                
                             2099:        (*opt->dissect)(pinfo, opt->name, tvb, start_offset, subneg_len, option_tree, option_item);                                           
                             2100:      }                                                                                                                                       
                             2101:    } else {                                                                                                                                  
                             2102:      /* We don't have a dissector for them; just show them as data. */                                                                       
                             2103:      if (iac_data > 0) {                                                                                                                     
                             2104:        /* Data is escaped, we have to unescape it. */                                                                                        
                             2105:        unescaped_tvb = unescape_and_tvbuffify_telnet_option(pinfo, tvb, start_offset, subneg_len);                                           
                             2106:        proto_tree_add_item(option_tree, hf_telnet_option_data, unescaped_tvb, 0, subneg_len - iac_data, ENC_NA);                             
                             2107:      } else {                                                                                                                                
                             2108:        proto_tree_add_item(option_tree, hf_telnet_option_data, tvb, start_offset, subneg_len, ENC_NA);                                       
                             2109:      }                                                                                                                                       
                             2110:    }                                                                                                                                         
                             2111:  }                                                                                                                                           
                             2112:  return offset;                                                                                                                              
                             2113:}                                                                                                                                             
                             2114:                                                                                                                                              
                             2115:static void                                                                                                                                   
                             2116:telnet_suboption_name(proto_tree *tree, packet_info *pinfo, tvbuff_t *tvb, int* offset, const char** optname,                                 
                             2117:                      proto_tree **opt_tree, proto_item **opt_item, const char *type)                                                         
                             2118:{                                                                                                                                             
                             2119:  uint8_t       opt_byte;                                                                                                                     
                             2120:  const tn_opt *opt;                                                                                                                          
                             2121:  int           ett = ett_telnet_subopt;                                                                                                      
                             2122:                                                                                                                                              
                             2123:  opt_byte = tvb_get_uint8(tvb, *offset);                                                                                                     
                             2124:  opt = telnet_find_option(opt_byte);                                                                                                         
                             2125:  if (opt->subtree_index != NULL)                                                                                                             
                             2126:    ett = *(opt->subtree_index);                                                                                                              
                             2127:  *opt_item = proto_tree_add_uint_format_value(tree, hf_telnet_subcmd, tvb, *offset, 1, opt_byte, "%s", opt->name);                           
                             2128:  *opt_tree = proto_item_add_subtree(*opt_item, ett);                                                                                         
                             2129:                                                                                                                                              
                             2130:  (*offset)++;                                                                                                                                
                             2131:  (*optname) = wmem_strdup_printf(pinfo->pool, "%s %s", type, opt->name);                                                                     
                             2132:}                                                                                                                                             
                             2133:                                                                                                                                              
                             2134:static int                                                                                                                                    
                             2135:telnet_command(packet_info *pinfo, proto_tree *telnet_tree, tvbuff_t *tvb, int start_offset, unsigned *num_info_items)                        
                             2136:{                                                                                                                                             
                             2137:  int    offset = start_offset;                                                                                                               
                             2138:  unsigned char optcode;                                                                                                                      
                             2139:  const char* optname;                                                                                                                        
                             2140:  proto_item *cmd_item, *subopt_item = NULL;                                                                                                  
                             2141:  proto_tree *cmd_tree, *subopt_tree = NULL;                                                                                                  
                             2142:                                                                                                                                              
                             2143:  offset += 1;  /* skip IAC */                                                                                                                
                             2144:  optcode = tvb_get_uint8(tvb, offset);                                                                                                       
                             2145:                                                                                                                                              
                             2146:  cmd_tree = proto_tree_add_subtree(telnet_tree, tvb, start_offset, 2, ett_telnet_cmd, &cmd_item, "Command header");                          
                             2147:  proto_tree_add_item(cmd_tree, hf_telnet_cmd, tvb, offset, 1, ENC_BIG_ENDIAN);                                                               
                             2148:  offset++;                                                                                                                                   
                             2149:                                                                                                                                              
                             2150:  switch(optcode) {                                                                                                                           
                             2151:  case TN_WILL:                                                                                                                               
                             2152:    telnet_suboption_name(cmd_tree, pinfo, tvb, &offset, &optname, &subopt_tree, &subopt_item, "Will");                                       
                             2153:    break;                                                                                                                                    
                             2154:                                                                                                                                              
                             2155:  case TN_WONT:                                                                                                                               
                             2156:    telnet_suboption_name(cmd_tree, pinfo, tvb, &offset, &optname, &subopt_tree, &subopt_item, "Won't");                                      
                             2157:    break;                                                                                                                                    
                             2158:                                                                                                                                              
                             2159:  case TN_DO:                                                                                                                                 
                             2160:    telnet_suboption_name(cmd_tree, pinfo, tvb, &offset, &optname, &subopt_tree, &subopt_item, "Do");                                         
                             2161:    break;                                                                                                                                    
                             2162:                                                                                                                                              
                             2163:  case TN_DONT:                                                                                                                               
                             2164:    telnet_suboption_name(cmd_tree, pinfo, tvb, &offset, &optname, &subopt_tree, &subopt_item, "Don't");                                      
                             2165:    break;                                                                                                                                    
                             2166:                                                                                                                                              
                             2167:  case TN_SB:                                                                                                                                 
                             2168:    telnet_suboption_name(cmd_tree, pinfo, tvb, &offset, &optname, &subopt_tree, &subopt_item, "Suboption");                                  
                             2169:    break;                                                                                                                                    
                             2170:                                                                                                                                              
                             2171:  default:                                                                                                                                    
                             2172:    optname = val_to_str_const(optcode, cmd_vals, "<unknown option>");                                                                        
                             2173:    break;                                                                                                                                    
                             2174:  }                                                                                                                                           
                             2175:                                                                                                                                              
                             2176:  proto_item_set_text(cmd_item, "%s", optname);                                                                                               
                             2177:  if (optcode != TN_SE) {                                                                                                                     
                             2178:    add_telnet_info_str(pinfo, num_info_items, optname);                                                                                      
                             2179:  }                                                                                                                                           
                             2180:                                                                                                                                              
                             2181:  if (optcode == TN_SB) {                                                                                                                     
                             2182:    offset = telnet_sub_option(pinfo, subopt_tree, subopt_item, tvb, start_offset);                                                           
                             2183:  }                                                                                                                                           
                             2184:                                                                                                                                              
                             2185:  proto_item_set_len(cmd_item, offset-start_offset);                                                                                          
                             2186:                                                                                                                                              
                             2187:  return offset;                                                                                                                              
                             2188:}                                                                                                                                             
                             2189:                                                                                                                                              
                             2190:static void                                                                                                                                   
                             2191:telnet_add_text(proto_tree *tree, tvbuff_t *tvb, int offset, int len)                                                                         
                             2192:{                                                                                                                                             
                             2193:  int      next_offset;                                                                                                                       
                             2194:  int      linelen;                                                                                                                           
                             2195:  uint8_t  c;                                                                                                                                 
                             2196:  bool last_char_was_cr;                                                                                                                      
                             2197:                                                                                                                                              
                             2198:  while (len != 0 && tvb_offset_exists(tvb, offset)) {                                                                                        
                             2199:    /*                                                                                                                                        
                             2200:     * Find the end of the line.                                                                                                              
                             2201:     */                                                                                                                                       
                             2202:    linelen = tvb_find_line_end(tvb, offset, len, &next_offset, false);                                                                       
                             2203:    len -= next_offset - offset;        /* subtract out the line's characters */                                                              
                             2204:                                                                                                                                              
                             2205:    /* Telnet RFC 1184 allows for specifying window size via columns and height.                                                              
                             2206:       If this subopt is set then a method for storing the data in a given window                                                             
                             2207:       is necessary.                                                                                                                          
                             2208:    */                                                                                                                                        
                             2209:   if ( hf_telnet_naws_subopt_set ) {                                                                                                         
                             2210:    int start_offset = hf_telnet_width * hf_telnet_line;                                                                                      
                             2211:    tvb_get_raw_bytes_as_stringz(tvb, offset, (linelen < hf_telnet_width) ? linelen : hf_telnet_width, hf_naws_data +                         
                             start_offset);                                                                                                                                     
                             2212:    hf_telnet_line = (hf_telnet_line + 1) % hf_telnet_height;                                                                                 
                             2213:  }                                                                                                                                           
                             2214:                                                                                                                                              
                             2215:    /*                                                                                                                                        
                             2216:     * In Telnet, CR NUL is the way you send a CR by itself in the                                                                            
                             2217:     * default ASCII mode; don't treat CR by itself as a line ending,                                                                         
                             2218:     * treat only CR NUL, CR LF, or LF by itself as a line ending.                                                                            
                             2219:     */                                                                                                                                       
                             2220:    if (next_offset == offset + linelen + 1 && len >= 1) {                                                                                    
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             epan/tvbuff.c:900-1050                                                                                                                             
                             ```                                                                                                                                                
                             900:                                                                                                                                               
                             901:    u_offset = offset;                                                                                                                         
                             902:    end_offset = u_offset + length;                                                                                                            
                             903:                                                                                                                                               
                             904:    if (G_LIKELY(end_offset <= tvb->length)) {                                                                                                 
                             905:            return tvb->real_data + u_offset;                                                                                                  
                             906:    } else if (end_offset <= tvb->contained_length) {                                                                                          
                             907:            THROW(BoundsError);                                                                                                                
                             908:    } else if (tvb->flags & TVBUFF_FRAGMENT) {                                                                                                 
                             909:            THROW(FragmentBoundsError);                                                                                                        
                             910:    } else if (end_offset <= tvb->reported_length) {                                                                                           
                             911:            THROW(ContainedBoundsError);                                                                                                       
                             912:    } else {                                                                                                                                   
                             913:            THROW(ReportedBoundsError);                                                                                                        
                             914:    }                                                                                                                                          
                             915:    /* not reached */                                                                                                                          
                             916:    return NULL;                                                                                                                               
                             917:}                                                                                                                                              
                             918:                                                                                                                                               
                             919:                                                                                                                                               
                             920:                                                                                                                                               
                             921:/************** ACCESSORS **************/                                                                                                      
                             922:                                                                                                                                               
                             923:void *                                                                                                                                         
                             924:tvb_memcpy(tvbuff_t *tvb, void *target, const int offset, size_t length)                                                                       
                             925:{                                                                                                                                              
                             926:    unsigned        abs_offset = 0, abs_length = 0;                                                                                            
                             927:                                                                                                                                               
                             928:    DISSECTOR_ASSERT(tvb && tvb->initialized);                                                                                                 
                             929:                                                                                                                                               
                             930:    /*                                                                                                                                         
                             931:     * XXX - we should eliminate the "length = -1 means 'to the end                                                                            
                             932:     * of the tvbuff'" convention, and use other means to achieve                                                                              
                             933:     * that; this would let us eliminate a bunch of checks for                                                                                 
                             934:     * negative lengths in cases where the protocol has a 32-bit                                                                               
                             935:     * length field.                                                                                                                           
                             936:     *                                                                                                                                         
                             937:     * Allowing -1 but throwing an assertion on other negative                                                                                 
                             938:     * lengths is a bit more work with the length being a size_t;                                                                              
                             939:     * instead, we check for a length <= 2^31-1.                                                                                               
                             940:     */                                                                                                                                        
                             941:    DISSECTOR_ASSERT(length <= 0x7FFFFFFF);                                                                                                    
                             942:    check_offset_length(tvb, offset, (int) length, &abs_offset, &abs_length);                                                                  
                             943:                                                                                                                                               
                             944:    if (target && tvb->real_data) {                                                                                                            
                             945:            return memcpy(target, tvb->real_data + abs_offset, abs_length);                                                                    
                             946:    }                                                                                                                                          
                             947:                                                                                                                                               
                             948:    if (target && tvb->ops->tvb_memcpy)                                                                                                        
                             949:            return tvb->ops->tvb_memcpy(tvb, target, abs_offset, abs_length);                                                                  
                             950:                                                                                                                                               
                             951:    /*                                                                                                                                         
                             952:     * If the length is 0, there's nothing to do.                                                                                              
                             953:     * (tvb->real_data could be null if it's allocated with                                                                                    
                             954:     * a size of length.)                                                                                                                      
                             955:     */                                                                                                                                        
                             956:    if (length != 0) {                                                                                                                         
                             957:            /*                                                                                                                                 
                             958:             * XXX, fallback to slower method                                                                                                  
                             959:             */                                                                                                                                
                             960:            DISSECTOR_ASSERT_NOT_REACHED();                                                                                                    
                             961:    }                                                                                                                                          
                             962:    return NULL;                                                                                                                               
                             963:}                                                                                                                                              
                             964:                                                                                                                                               
                             965:                                                                                                                                               
                             966:/*                                                                                                                                             
                             967: * XXX - this doesn't treat a length of -1 as an error.                                                                                        
                             968: * If it did, this could replace some code that calls                                                                                          
                             969: * "tvb_ensure_bytes_exist()" and then allocates a buffer and copies                                                                           
                             970: * data to it.                                                                                                                                 
                             971: *                                                                                                                                             
                             972: * "composite_get_ptr()" depends on -1 not being                                                                                               
                             973: * an error; does anything else depend on this routine treating -1 as                                                                          
                             974: * meaning "to the end of the buffer"?                                                                                                         
                             975: *                                                                                                                                             
                             976: * If scope is NULL, memory is allocated with g_malloc() and user must                                                                         
                             977: * explicitly free it with g_free().                                                                                                           
                             978: * If scope is not NULL, memory is allocated with the corresponding pool                                                                       
                             979: * lifetime.                                                                                                                                   
                             980: */                                                                                                                                            
                             981:void *                                                                                                                                         
                             982:tvb_memdup(wmem_allocator_t *scope, tvbuff_t *tvb, const int offset, size_t length)                                                            
                             983:{                                                                                                                                              
                             984:    unsigned  abs_offset = 0, abs_length = 0;                                                                                                  
                             985:    void  *duped;                                                                                                                              
                             986:                                                                                                                                               
                             987:    DISSECTOR_ASSERT(tvb && tvb->initialized);                                                                                                 
                             988:                                                                                                                                               
                             989:    check_offset_length(tvb, offset, (int) length, &abs_offset, &abs_length);                                                                  
                             990:                                                                                                                                               
                             991:    if (abs_length == 0)                                                                                                                       
                             992:            return NULL;                                                                                                                       
                             993:                                                                                                                                               
                             994:    duped = wmem_alloc(scope, abs_length);                                                                                                     
                             995:    return tvb_memcpy(tvb, duped, abs_offset, abs_length);                                                                                     
                             996:}                                                                                                                                              
                             997:                                                                                                                                               
                             998:                                                                                                                                               
                             999:                                                                                                                                               
                             1000:const uint8_t*                                                                                                                                
                             1001:tvb_get_ptr(tvbuff_t *tvb, const int offset, const int length)                                                                                
                             1002:{                                                                                                                                             
                             1003:   return ensure_contiguous(tvb, offset, length);                                                                                             
                             1004:}                                                                                                                                             
                             1005:                                                                                                                                              
                             1006:/* ---------------- */                                                                                                                        
                             1007:uint8_t                                                                                                                                       
                             1008:tvb_get_uint8(tvbuff_t *tvb, const int offset)                                                                                                
                             1009:{                                                                                                                                             
                             1010:   const uint8_t *ptr;                                                                                                                        
                             1011:                                                                                                                                              
                             1012:   ptr = fast_ensure_contiguous(tvb, offset, 1);                                                                                              
                             1013:   return *ptr;                                                                                                                               
                             1014:}                                                                                                                                             
                             1015:                                                                                                                                              
                             1016:int8_t                                                                                                                                        
                             1017:tvb_get_int8(tvbuff_t *tvb, const int offset)                                                                                                 
                             1018:{                                                                                                                                             
                             1019:   const uint8_t *ptr;                                                                                                                        
                             1020:                                                                                                                                              
                             1021:   ptr = fast_ensure_contiguous(tvb, offset, 1);                                                                                              
                             1022:   return *ptr;                                                                                                                               
                             1023:}                                                                                                                                             
                             1024:                                                                                                                                              
                             1025:uint16_t                                                                                                                                      
                             1026:tvb_get_ntohs(tvbuff_t *tvb, const int offset)                                                                                                
                             1027:{                                                                                                                                             
                             1028:   const uint8_t *ptr;                                                                                                                        
                             1029:                                                                                                                                              
                             1030:   ptr = fast_ensure_contiguous(tvb, offset, 2);                                                                                              
                             1031:   return pntoh16(ptr);                                                                                                                       
                             1032:}                                                                                                                                             
                             1033:                                                                                                                                              
                             1034:int16_t                                                                                                                                       
                             1035:tvb_get_ntohis(tvbuff_t *tvb, const int offset)                                                                                               
                             1036:{                                                                                                                                             
                             1037:   const uint8_t *ptr;                                                                                                                        
                             1038:                                                                                                                                              
                             1039:   ptr = fast_ensure_contiguous(tvb, offset, 2);                                                                                              
                             1040:   return pntoh16(ptr);                                                                                                                       
                             1041:}                                                                                                                                             
                             1042:                                                                                                                                              
                             1043:uint32_t                                                                                                                                      
                             1044:tvb_get_ntoh24(tvbuff_t *tvb, const int offset)                                                                                               
                             1045:{                                                                                                                                             
                             1046:   const uint8_t *ptr;                                                                                                                        
                             1047:                                                                                                                                              
                             1048:   ptr = fast_ensure_contiguous(tvb, offset, 3);                                                                                              
                             1049:   return pntoh24(ptr);                                                                                                                       
                             1050:}                                                                                                                                             
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             epan/tvbuff.c:4000-4100                                                                                                                            
                             ```                                                                                                                                                
                             4000:{                                                                                                                                             
                             4001:   int      stringlen;                                                                                                                        
                             4002:   unsigned abs_offset = 0;                                                                                                                   
                             4003:   int      limit, len = 0;                                                                                                                   
                             4004:   bool     decreased_max = false;                                                                                                            
                             4005:                                                                                                                                              
                             4006:   /* Only read to end of tvbuff, w/o throwing exception. */                                                                                  
                             4007:   check_offset_length(tvb, offset, -1, &abs_offset, &len);                                                                                   
                             4008:                                                                                                                                              
                             4009:   /* There must at least be room for the terminating NUL. */                                                                                 
                             4010:   DISSECTOR_ASSERT(bufsize != 0);                                                                                                            
                             4011:                                                                                                                                              
                             4012:   /* If there's no room for anything else, just return the NUL. */                                                                           
                             4013:   if (bufsize == 1) {                                                                                                                        
                             4014:           buffer[0] = 0;                                                                                                                     
                             4015:           *bytes_copied = 1;                                                                                                                 
                             4016:           return 0;                                                                                                                          
                             4017:   }                                                                                                                                          
                             4018:                                                                                                                                              
                             4019:   /* check_offset_length() won't throw an exception if we're                                                                                 
                             4020:    * looking at the byte immediately after the end of the tvbuff. */                                                                         
                             4021:   if (len == 0) {                                                                                                                            
                             4022:           THROW(ReportedBoundsError);                                                                                                        
                             4023:   }                                                                                                                                          
                             4024:                                                                                                                                              
                             4025:   /* This should not happen because check_offset_length() would                                                                              
                             4026:    * have already thrown an exception if 'offset' were out-of-bounds.                                                                        
                             4027:    */                                                                                                                                        
                             4028:   DISSECTOR_ASSERT(len != -1);                                                                                                               
                             4029:                                                                                                                                              
                             4030:   /*                                                                                                                                         
                             4031:    * If we've been passed a negative number, bufsize will                                                                                    
                             4032:    * be huge.                                                                                                                                
                             4033:    */                                                                                                                                        
                             4034:   DISSECTOR_ASSERT(bufsize <= INT_MAX);                                                                                                      
                             4035:                                                                                                                                              
                             4036:   if ((unsigned)len < bufsize) {                                                                                                             
                             4037:           limit = len;                                                                                                                       
                             4038:           decreased_max = true;                                                                                                              
                             4039:   }                                                                                                                                          
                             4040:   else {                                                                                                                                     
                             4041:           limit = bufsize;                                                                                                                   
                             4042:   }                                                                                                                                          
                             4043:                                                                                                                                              
                             4044:   stringlen = tvb_strnlen(tvb, abs_offset, limit - 1);                                                                                       
                             4045:   /* If NUL wasn't found, copy the data and return -1 */                                                                                     
                             4046:   if (stringlen == -1) {                                                                                                                     
                             4047:           tvb_memcpy(tvb, buffer, abs_offset, limit);                                                                                        
                             4048:           if (decreased_max) {                                                                                                               
                             4049:                   buffer[limit] = 0;                                                                                                         
                             4050:                   /* Add 1 for the extra NUL that we set at buffer[limit],                                                                   
                             4051:                    * pretending that it was copied as part of the string. */                                                                 
                             4052:                   *bytes_copied = limit + 1;                                                                                                 
                             4053:           }                                                                                                                                  
                             4054:           else {                                                                                                                             
                             4055:                   *bytes_copied = limit;                                                                                                     
                             4056:           }                                                                                                                                  
                             4057:           return -1;                                                                                                                         
                             4058:   }                                                                                                                                          
                             4059:                                                                                                                                              
                             4060:   /* Copy the string to buffer */                                                                                                            
                             4061:   tvb_memcpy(tvb, buffer, abs_offset, stringlen + 1);                                                                                        
                             4062:   *bytes_copied = stringlen + 1;                                                                                                             
                             4063:   return stringlen;                                                                                                                          
                             4064:}                                                                                                                                             
                             4065:                                                                                                                                              
                             4066:int                                                                                                                                           
                             4067:tvb_get_raw_bytes_as_stringz(tvbuff_t *tvb, const int offset, const unsigned bufsize, uint8_t* buffer)                                        
                             4068:{                                                                                                                                             
                             4069:   int     len, bytes_copied;                                                                                                                 
                             4070:                                                                                                                                              
                             4071:   DISSECTOR_ASSERT(tvb && tvb->initialized);                                                                                                 
                             4072:                                                                                                                                              
                             4073:   len = _tvb_get_raw_bytes_as_stringz(tvb, offset, bufsize, buffer, &bytes_copied);                                                          
                             4074:                                                                                                                                              
                             4075:   if (len == -1) {                                                                                                                           
                             4076:           buffer[bufsize - 1] = 0;                                                                                                           
                             4077:           return bytes_copied - 1;                                                                                                           
                             4078:   }                                                                                                                                          
                             4079:   else {                                                                                                                                     
                             4080:           return len;                                                                                                                        
                             4081:   }                                                                                                                                          
                             4082:}                                                                                                                                             
                             4083:                                                                                                                                              
                             4084:/*                                                                                                                                            
                             4085: * Given a tvbuff, an offset into the tvbuff, a buffer, and a buffer size,                                                                    
                             4086: * extract as many raw bytes from the tvbuff, starting at the offset,                                                                         
                             4087: * as 1) are available in the tvbuff and 2) will fit in the buffer, leaving                                                                   
                             4088: * room for a terminating NUL.                                                                                                                
                             4089: */                                                                                                                                           
                             4090:int                                                                                                                                           
                             4091:tvb_get_raw_bytes_as_string(tvbuff_t *tvb, const int offset, char *buffer, size_t bufsize)                                                    
                             4092:{                                                                                                                                             
                             4093:   int      len = 0;                                                                                                                          
                             4094:                                                                                                                                              
                             4095:   DISSECTOR_ASSERT(tvb && tvb->initialized);                                                                                                 
                             4096:                                                                                                                                              
                             4097:   /* There must be room for the string and the terminating NUL. */                                                                           
                             4098:   DISSECTOR_ASSERT(bufsize > 0);                                                                                                             
                             4099:                                                                                                                                              
                             4100:   DISSECTOR_ASSERT(bufsize - 1 < INT_MAX);                                                                                                   
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             wsutil/wmem/wmem_allocator_simple.c:1-120                                                                                                          
                             ```                                                                                                                                                
                             1:/* wmem_allocator_simple.c                                                                                                                       
                             2: * Wireshark Memory Manager Simple Allocator                                                                                                     
                             3: * Copyright 2012, Evan Huus <eapache@gmail.com>                                                                                                 
                             4: *                                                                                                                                               
                             5: * Wireshark - Network traffic analyzer                                                                                                          
                             6: * By Gerald Combs <gerald@wireshark.org>                                                                                                        
                             7: * Copyright 1998 Gerald Combs                                                                                                                   
                             8: *                                                                                                                                               
                             9: * SPDX-License-Identifier: GPL-2.0-or-later                                                                                                     
                             10: */                                                                                                                                             
                             11:                                                                                                                                                
                             12:#include "config.h"                                                                                                                             
                             13:                                                                                                                                                
                             14:#include <string.h>                                                                                                                             
                             15:                                                                                                                                                
                             16:#include <glib.h>                                                                                                                               
                             17:                                                                                                                                                
                             18:#include "wmem_core.h"                                                                                                                          
                             19:#include "wmem_allocator.h"                                                                                                                     
                             20:#include "wmem_allocator_simple.h"                                                                                                              
                             21:                                                                                                                                                
                             22:#define DEFAULT_ALLOCS 8192                                                                                                                     
                             23:                                                                                                                                                
                             24:typedef struct _wmem_simple_allocator_t {                                                                                                       
                             25:    int size;                                                                                                                                   
                             26:    int count;                                                                                                                                  
                             27:    void **ptrs;                                                                                                                                
                             28:} wmem_simple_allocator_t;                                                                                                                      
                             29:                                                                                                                                                
                             30:static void *                                                                                                                                   
                             31:wmem_simple_alloc(void *private_data, const size_t size)                                                                                        
                             32:{                                                                                                                                               
                             33:    wmem_simple_allocator_t *allocator;                                                                                                         
                             34:                                                                                                                                                
                             35:    allocator = (wmem_simple_allocator_t*) private_data;                                                                                        
                             36:                                                                                                                                                
                             37:    if (G_UNLIKELY(allocator->count == allocator->size)) {                                                                                      
                             38:        allocator->size *= 2;                                                                                                                   
                             39:        allocator->ptrs = (void**)wmem_realloc(NULL, allocator->ptrs,                                                                           
                             40:                sizeof(void*) * allocator->size);                                                                                               
                             41:    }                                                                                                                                           
                             42:                                                                                                                                                
                             43:    return allocator->ptrs[allocator->count++] = wmem_alloc(NULL, size);                                                                        
                             44:}                                                                                                                                               
                             45:                                                                                                                                                
                             46:static void                                                                                                                                     
                             47:wmem_simple_free(void *private_data, void *ptr)                                                                                                 
                             48:{                                                                                                                                               
                             49:    int                      i;                                                                                                                 
                             50:    wmem_simple_allocator_t *allocator;                                                                                                         
                             51:                                                                                                                                                
                             52:    allocator = (wmem_simple_allocator_t*) private_data;                                                                                        
                             53:                                                                                                                                                
                             54:    wmem_free(NULL, ptr);                                                                                                                       
                             55:    allocator->count--;                                                                                                                         
                             56:                                                                                                                                                
                             57:    for (i=allocator->count; i>=0; i--) {                                                                                                       
                             58:        if (ptr == allocator->ptrs[i]) {                                                                                                        
                             59:            if (i < allocator->count) {                                                                                                         
                             60:                allocator->ptrs[i] = allocator->ptrs[allocator->count];                                                                         
                             61:            }                                                                                                                                   
                             62:            return;                                                                                                                             
                             63:        }                                                                                                                                       
                             64:    }                                                                                                                                           
                             65:                                                                                                                                                
                             66:    g_assert_not_reached();                                                                                                                     
                             67:}                                                                                                                                               
                             68:                                                                                                                                                
                             69:static void *                                                                                                                                   
                             70:wmem_simple_realloc(void *private_data, void *ptr, const size_t size)                                                                           
                             71:{                                                                                                                                               
                             72:    int                      i;                                                                                                                 
                             73:    wmem_simple_allocator_t *allocator;                                                                                                         
                             74:                                                                                                                                                
                             75:    allocator = (wmem_simple_allocator_t*) private_data;                                                                                        
                             76:                                                                                                                                                
                             77:    for (i=allocator->count-1; i>=0; i--) {                                                                                                     
                             78:        if (ptr == allocator->ptrs[i]) {                                                                                                        
                             79:            return allocator->ptrs[i] = wmem_realloc(NULL, allocator->ptrs[i], size);                                                           
                             80:        }                                                                                                                                       
                             81:    }                                                                                                                                           
                             82:                                                                                                                                                
                             83:    g_assert_not_reached();                                                                                                                     
                             84:    /* not reached */                                                                                                                           
                             85:    return NULL;                                                                                                                                
                             86:}                                                                                                                                               
                             87:                                                                                                                                                
                             88:static void                                                                                                                                     
                             89:wmem_simple_free_all(void *private_data)                                                                                                        
                             90:{                                                                                                                                               
                             91:    wmem_simple_allocator_t *allocator;                                                                                                         
                             92:    int i;                                                                                                                                      
                             93:                                                                                                                                                
                             94:    allocator = (wmem_simple_allocator_t*) private_data;                                                                                        
                             95:                                                                                                                                                
                             96:    for (i = 0; i<allocator->count; i++) {                                                                                                      
                             97:        wmem_free(NULL, allocator->ptrs[i]);                                                                                                    
                             98:    }                                                                                                                                           
                             99:    allocator->count = 0;                                                                                                                       
                             100:}                                                                                                                                              
                             101:                                                                                                                                               
                             102:static void                                                                                                                                    
                             103:wmem_simple_gc(void *private_data _U_)                                                                                                         
                             104:{                                                                                                                                              
                             105:    /* In this simple allocator, there is nothing to garbage-collect */                                                                        
                             106:}                                                                                                                                              
                             107:                                                                                                                                               
                             108:static void                                                                                                                                    
                             109:wmem_simple_allocator_cleanup(void *private_data)                                                                                              
                             110:{                                                                                                                                              
                             111:    wmem_simple_allocator_t *allocator;                                                                                                        
                             112:                                                                                                                                               
                             113:    allocator = (wmem_simple_allocator_t*) private_data;                                                                                       
                             114:                                                                                                                                               
                             115:    wmem_free(NULL, allocator->ptrs);                                                                                                          
                             116:    wmem_free(NULL, allocator);                                                                                                                
                             117:}                                                                                                                                              
                             118:                                                                                                                                               
                             119:void                                                                                                                                           
                             120:wmem_simple_allocator_init(wmem_allocator_t *allocator)                                                                                        
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             epan/dissectors/packet-telnet.c:634-643                                                                                                            
                             ```                                                                                                                                                
                             634:                                                                                                                                               
                             635:static void                                                                                                                                    
                             636:dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,                                        
                             637:                    int len _U_, proto_tree *tree _U_, proto_item *item _U_)                                                                   
                             638:{                                                                                                                                              
                             639:  if ( hf_telnet_naws_subopt_set )                                                                                                             
                             640:    wmem_free(pinfo->pool, hf_naws_data);                                                                                                      
                             641:                                                                                                                                               
                             642:  return;                                                                                                                                      
                             643:}                                                                                                                                              
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             </code_snippets>                                                                                                                                   
                                                                                                                                                                                
                             ## Fix Strategy                                                                                                                                    
                             <fix_strategy>                                                                                                                                     
                                                                                                                                                                                
                             1. Root Cause Analysis                                                                                                                             
                                - The heap-use-after-free originates from a stale flag (`hf_telnet_naws_subopt_set`) that remains set after the NAWS data                       
                             buffer (`hf_naws_data`) has been freed by the Linemode sub-option handler (`dissect_linemode_subopt`).                                             
                                - Subsequently, `telnet_add_text` checks the flag and writes into the freed buffer via `tvb_get_raw_bytes_as_stringz`,                          
                             triggering the AddressSanitizer error.                                                                                                             
                                                                                                                                                                                
                             2. Patch Outline                                                                                                                                   
                                A. In `dissect_linemode_subopt` (packet-telnet.c):                                                                                              
                                   - After calling `wmem_free(pinfo->pool, hf_naws_data)`, clear the NAWSmode flag and reset related state:                                    
                                       Set `hf_telnet_naws_subopt_set = 0`                                                                                                     
                                       Set `hf_naws_data = NULL`                                                                                                               
                                       Reset `hf_telnet_line = 0`  (so future text processing starts from line 0 if re-enabled)                                                
                                   - This change ensures that once the NAWS buffer is freed, `telnet_add_text` will skip the NAWSmode branch, preventing                       
                             use-after-free.                                                                                                                                    
                                                                                                                                                                                
                                B. (Optional but recommended) In `dissect_naws_subopt` (packet-telnet.c):                                                                       
                                   - At the beginning of `dissect_naws_subopt`, check if a previous NAWS buffer exists (`hf_telnet_naws_subopt_set`) and free                   
                             it/reset state before allocating a new one.                                                                                                        
                                   - This prevents memory leaks and ensures a single consistent NAWS buffer per session:                                                        
                                       If `hf_telnet_naws_subopt_set` is true, call `wmem_free(...)`, clear the flag, nullout the pointer, and reset line                     
                             count.                                                                                                                                             
                                                                                                                                                                                
                             3. Detailed Steps                                                                                                                                  
                                1. Open `epan/dissectors/packet-telnet.c`.                                                                                                      
                                2. Locate the function `dissect_linemode_subopt` (around line 636).                                                                             
                                3. Change from:                                                                                                                                 
                                     ```                                                                                                                                        
                                     static void                                                                                                                                
                                     dissect_linemode_subopt(...)                                                                                                               
                                     {                                                                                                                                          
                                       if (hf_telnet_naws_subopt_set)                                                                                                           
                                         wmem_free(pinfo->pool, hf_naws_data);                                                                                                  
                                       return;                                                                                                                                  
                                     }                                                                                                                                          
                                     ```                                                                                                                                        
                                   to:                                                                                                                                          
                                     ```                                                                                                                                        
                                     static void                                                                                                                                
                                     dissect_linemode_subopt(packet_info *pinfo _U_,                                                                                            
                                                             const char *optname _U_,                                                                                           
                                                             tvbuff_t *tvb _U_,                                                                                                 
                                                             int offset _U_,                                                                                                    
                                                             int len _U_,                                                                                                       
                                                             proto_tree *tree _U_,                                                                                              
                                                             proto_item *item _U_)                                                                                              
                                     {                                                                                                                                          
                                       if (hf_telnet_naws_subopt_set) {                                                                                                         
                                         wmem_free(pinfo->pool, hf_naws_data);                                                                                                  
                                         /* Clear NAWS mode and reset state to prevent use-after-free */                                                                        
                                         hf_telnet_naws_subopt_set = 0;                                                                                                         
                                         hf_naws_data            = NULL;                                                                                                        
                                         hf_telnet_line          = 0;                                                                                                           
                                       }                                                                                                                                        
                                       return;                                                                                                                                  
                                     }                                                                                                                                          
                                     ```                                                                                                                                        
                                4. (Optional) Locate `dissect_naws_subopt` (around line 645). Insert at top:                                                                    
                                     ```                                                                                                                                        
                                     if (hf_telnet_naws_subopt_set) {                                                                                                           
                                       wmem_free(pinfo->pool, hf_naws_data);                                                                                                    
                                       hf_telnet_naws_subopt_set = 0;                                                                                                           
                                       hf_naws_data            = NULL;                                                                                                          
                                       hf_telnet_line          = 0;                                                                                                             
                                     }                                                                                                                                          
                                     ```                                                                                                                                        
                                   then proceed with the existing width/height allocation logic.                                                                                
                                                                                                                                                                                
                             4. Justification                                                                                                                                   
                                - By clearing `hf_telnet_naws_subopt_set`, we prevent `telnet_add_text` from entering the NAWSmode path when no valid buffer                   
                             is present.                                                                                                                                        
                                - Nullifying `hf_naws_data` and resetting `hf_telnet_line` avoid any accidental writes or staleindex calculations.                             
                                - These changes preserve existing functionality:                                                                                                
                                   NAWS buffering still works when the sub-option is active.                                                                                   
                                   Linemode sub-option still deactivates and frees the buffer.                                                                                 
                                   There is no change to the fuzzing harness, TVBuff API, or other dissectors.                                                                 
                                - The patch is minimal, avoids catching broader exceptions, and retains all existing test and harness code.                                     
                                                                                                                                                                                
                             5. Potential Side Effects and Mitigation                                                                                                           
                                - Subsequent Telnet text following a Linemode sub-option will no longer be stored in the NAWS bufferthis is intended behavior,                 
                             matching the semantics of exiting NAWS mode.                                                                                                       
                                - Resetting `hf_telnet_line` ensures that if NAWS mode is later re-enabled, buffer writes start at line 0, avoiding                             
                             out-of-bounds indexing.                                                                                                                            
                                - No other code paths reference `hf_telnet_naws_subopt_set`; tests covering Telnet dissector behavior under valid NAWS use will                 
                             continue to pass.                                                                                                                                  
                                                                                                                                                                                
                             6. References to Similar Patterns                                                                                                                  
                                - Other dissectors that allocate per-packet state use a flag + pointer pattern (e.g., COM-Port control) and clear their flags                   
                             when disabling a feature. This patch aligns Telnets NAWS logic with those existing patterns.                                                      
                                                                                                                                                                                
                             </fix_strategy>                                                                                                                                    
                             ===Tests Result===                                                                                                                                 
                             No tests found                                                                                                                                     
                             ===Evaluation End===                                                                                                                               
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                     __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                      
                    INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmptcpj67xz                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/wireshark-ws-full-01-vuln_002/agent-output-1760003799.9780123                                      
                             - Detection toml file: /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/detection/wireshark-ws-full-01-vuln_002.toml                                    
                             - Challenge project directory: /tasks/e9b4dbe8-f3f6-4680-b8e2-363ef3b18918/official-afc-wireshark                                                  
                                                                                                                                                                                
