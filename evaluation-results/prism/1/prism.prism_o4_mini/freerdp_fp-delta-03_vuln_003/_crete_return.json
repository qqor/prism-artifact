{
  "project_name": "freerdp",
  "vulnerability_identifier": "freerdp_fp-delta-03_vuln_003",
  "source_directory": "/home/qqor/crete/.cache/official-afc-freerdp",
  "llm_usage": {
    "total_cost": 0.5364062,
    "prompt_tokens": 265458,
    "completion_tokens": 55546
  },
  "variant": "sound",
  "diff": "--- a/libfreerdp/codec/rfx.c\n+++ b/libfreerdp/codec/rfx.c\n@@ -139,8 +139,9 @@\n \tPROFILER_PRINT_FOOTER\n }\n \n-UINT64 metadataBlock = (UINT64)&explicit_bzero;\n-\n+#ifndef MAX_METADATA_SIZE\n+#define MAX_METADATA_SIZE (1U << 20) /* 1 MiB cap on metadata */\n+#endif\n static INLINE void rfx_tile_init(void* obj)\n {\n \tRFX_TILE* tile = (RFX_TILE*)obj;\n@@ -176,8 +177,7 @@\n \treturn tile;\n }\n \n-UINT64 metadataData = 0;\n-\n+/* metadataData removed */\n static INLINE void rfx_decoder_tile_free(void* obj)\n {\n \tRFX_TILE* tile = (RFX_TILE*)obj;\n@@ -671,68 +671,107 @@\n \tStream_Read_UINT32(\n \t    s, frameIdx); /* frameIdx (4 bytes), if codec is in video mode, must be ignored */\n \tStream_Read_UINT16(s, numRegions); /* numRegions (2 bytes) */\n-\tif (Stream_GetRemainingLength(s) >= 8)\n-\t{\n-\t        UINT64 blockOffset = 0;\n-\t        Stream_Read_UINT64(s, blockOffset);\n-\t        Stream_Read_UINT64(s, metadataData);\n-\t        metadataBlock += blockOffset;\n-\t}\n-\tWLog_Print(context->priv->log, WLOG_DEBUG,\n-\t           \"RFX_FRAME_BEGIN: frameIdx: %\" PRIu32 \" numRegions: %\" PRIu16 \"\", frameIdx,\n-\t           numRegions);\n-\treturn TRUE;\n-}\n-\n+    /* metadata block handling removed */\n+}\n static INLINE BOOL rfx_process_message_frame_end(RFX_CONTEXT* WINPR_RESTRICT context,\n                                                  RFX_MESSAGE* WINPR_RESTRICT message,\n                                                  wStream* WINPR_RESTRICT s,\n                                                  UINT16* WINPR_RESTRICT pExpectedBlockType)\n {\n-\tWINPR_ASSERT(context);\n-\tWINPR_ASSERT(context->priv);\n-\tWINPR_ASSERT(message);\n-\tWINPR_ASSERT(s);\n-\tWINPR_ASSERT(pExpectedBlockType);\n-\n-\tif (*pExpectedBlockType != WBT_FRAME_END)\n-\t{\n-\t\tWLog_Print(context->priv->log, WLOG_ERROR, \"message unexpected, wants WBT_FRAME_END\");\n-\t\treturn FALSE;\n-\t}\n-\n-\t*pExpectedBlockType = WBT_FRAME_BEGIN;\n-\tWLog_Print(context->priv->log, WLOG_DEBUG, \"RFX_FRAME_END\");\n-\treturn TRUE;\n+    WINPR_ASSERT(context);\n+    WINPR_ASSERT(context->priv);\n+    WINPR_ASSERT(message);\n+    WINPR_ASSERT(s);\n+    WINPR_ASSERT(pExpectedBlockType);\n+\n+    if (*pExpectedBlockType != WBT_FRAME_END)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"message unexpected, wants WBT_FRAME_END\");\n+        return FALSE;\n+    }\n+\n+    *pExpectedBlockType = WBT_FRAME_BEGIN;\n+    WLog_Print(context->priv->log, WLOG_DEBUG, \"RFX_FRAME_END\");\n+    return TRUE;\n }\n \n static INLINE BOOL rfx_process_message_metadata(RFX_CONTEXT* WINPR_RESTRICT context,\n-\t\t\t\t\t\t\t\t\t\t\t\tRFX_MESSAGE* WINPR_RESTRICT message,\n-\t\t\t\t\t\t\t\t\t\t\t\twStream* WINPR_RESTRICT s,\n-\t\t\t\t\t\t\t\t\t\t\t\tUINT16* WINPR_RESTRICT pExpectedBlockType)\n-{\n-\tUINT32 magic = 0;\n-\n-\tWINPR_ASSERT(context);\n-\tWINPR_ASSERT(context->priv);\n-\tWINPR_ASSERT(message);\n-\tWINPR_ASSERT(s);\n-\tWINPR_ASSERT(pExpectedBlockType);\n-\n-\tif (*pExpectedBlockType != WBT_FRAME_END)\n-\t{\n-\t\tWLog_Print(context->priv->log, WLOG_ERROR, \"message unexpected wants WBT_FRAME_END (0x%x)\", *pExpectedBlockType);\n-\t\treturn FALSE;\n-\t}\n-\n-\tStream_Read_UINT32(s, magic); /* magic (4 bytes), 0xCACCACCA */\n-\tif (magic != WF_MAGIC)\n-\t{\n-\t\tWLog_Print(context->priv->log, WLOG_ERROR, \"invalid magic number 0x%08\" PRIX32 \"\", magic);\n-\t\treturn FALSE;\n-\t}\n-\t*(UINT64*)metadataBlock = metadataData;\n-\treturn TRUE;\n+                                                RFX_MESSAGE* WINPR_RESTRICT message,\n+                                                wStream* WINPR_RESTRICT s,\n+                                                UINT16* WINPR_RESTRICT pExpectedBlockType)\n+{\n+    UINT32 magic;\n+    UINT16 regionType;\n+    UINT16 numTileSets;\n+\n+    WINPR_ASSERT(context);\n+    WINPR_ASSERT(context->priv);\n+    WINPR_ASSERT(message);\n+    WINPR_ASSERT(s);\n+    WINPR_ASSERT(pExpectedBlockType);\n+\n+    if (*pExpectedBlockType != WBT_FRAME_END)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"message unexpected, wants WBT_FRAME_END (0x%x)\", *pExpectedBlockType);\n+        return FALSE;\n+    }\n+\n+    /* Read total metadata size */\n+    if (!Stream_CheckAndLogRequiredLengthWLog(context->priv->log, s, 4))\n+        return FALSE;\n+\n+    UINT32 totalMetadataSize = 0;\n+    Stream_Read_UINT32(s, totalMetadataSize);\n+    if (totalMetadataSize > MAX_METADATA_SIZE)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"metadata size too large: %\" PRIu32 \"\", totalMetadataSize);\n+        return FALSE;\n+    }\n+\n+    /* Allocate and read metadata blob */\n+    BYTE* metadata_buffer = calloc(1, totalMetadataSize);\n+    if (!metadata_buffer)\n+        return FALSE;\n+    if (!Stream_CheckAndLogRequiredLengthWLog(context->priv->log, s, totalMetadataSize))\n+    {\n+        free(metadata_buffer);\n+        return FALSE;\n+    }\n+    Stream_Read(s, metadata_buffer, totalMetadataSize);\n+\n+    /* Parse metadata blob */\n+    wStream* ms = Stream_New(metadata_buffer, totalMetadataSize);\n+    if (!ms)\n+    {\n+        free(metadata_buffer);\n+        return FALSE;\n+    }\n+    Stream_Read_UINT32(ms, magic);\n+    if (magic != WF_MAGIC)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"invalid magic number 0x%08\" PRIX32 \"\", magic);\n+        Stream_Free(ms, FALSE);\n+        free(metadata_buffer);\n+        return FALSE;\n+    }\n+    Stream_Read_UINT16(ms, regionType);\n+    Stream_Read_UINT16(ms, numTileSets);\n+    Stream_Free(ms, FALSE);\n+    free(metadata_buffer);\n+\n+    if (regionType != CBT_REGION)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"invalid region type 0x%04\" PRIX16 \"\", regionType);\n+        return FALSE;\n+    }\n+    if (numTileSets != 0x0001)\n+    {\n+        WLog_Print(context->priv->log, WLOG_ERROR, \"invalid number of tilesets (%\" PRIu16 \")\", numTileSets);\n+        return FALSE;\n+    }\n+\n+    *pExpectedBlockType = WBT_FRAME_END;\n+    return TRUE;\n }\n \n static INLINE BOOL rfx_resize_rects(RFX_MESSAGE* WINPR_RESTRICT message)\n",
  "stdout": "",
  "stderr": ""
}