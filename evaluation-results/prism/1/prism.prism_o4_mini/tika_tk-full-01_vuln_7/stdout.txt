[10/08/25 11:23:10] INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmpijae2o5y                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/tika-tk-full-01-vuln_7/agent-output-1759922590.6541488                                             
                             - Detection toml file: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/detection/tika-tk-full-01-vuln_7.toml                                           
                             - Challenge project directory: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/official-afc-tika                                                       
                                                                                                                                                                                
                    INFO     [logging_performance](tika Building Cached for CLEAN environment) Started...                                                  context_managers.py:9
[10/08/25 11:25:00] INFO     [logging_performance](tika Building Cached for CLEAN environment) Took 110.00 seconds; exception=False                       context_managers.py:23
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Started...                                         context_managers.py:9
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                context_managers.py:23
                    INFO     Setting timeouts                                                                                                                      default.py:85
                               - build: 600 (original: 110)                                                                                                                     
                               - run tests: 600 (original: 0)                                                                                                                   
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:25:01] INFO     [logging_performance](tika Setting owner) Took 0.88 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:25:03] INFO     Successfully created Cached for CLEAN environment                                                                                   oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                           oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:25:04] INFO     [logging_performance](tika Setting owner) Took 1.24 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:25:05] INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
                    INFO     [logging_performance](tika Setting owner) Took 0.91 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:25:15] INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                             
                             ===Evaluator Diff===                                                                                                                               
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueMedium: Server Side Request Forgery (SSRF)                                  
                             Attempted connection to: jazzer.com:443                                                                                                            
                             Requests to destinations based on untrusted data could lead to exfiltration of sensitive data or exposure of internal services.                    
                                                                                                                                                                                
                                                                                                                                                                                
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrf(ServerSideRequestForgery.java:127)                           
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrfSocket(ServerSideRequestForgery.java:71)                      
                                     at java.base/java.net.Socket.connect(Socket.java:633)                                                                                      
                                     at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:299)                                                                
                                     at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178)                                                                       
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:498)                                                                   
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:603)                                                                   
                                     at java.base/sun.net.www.protocol.https.HttpsClient.<init>(HttpsClient.java:266)                                                           
                                     at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380)                                                              
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:1                 
                             89)                                                                                                                                                
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242)                                        
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128)                                         
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:175)                       
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1665)                                      
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1589)                                       
                                     at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getInputStream(HttpsURLConnectionImpl.java:224)                             
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processURL(TextAndCSVParser.java:278)                                                       
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processCell(TextAndCSVParser.java:261)                                                      
                                     at org.apache.tika.parser.csv.TextAndCSVParser.parse(TextAndCSVParser.java:211)                                                            
                                     at com.example.TextAndCSVParserFuzzer.parseOne(TextAndCSVParserFuzzer.java:57)                                                             
                                     at com.example.TextAndCSVParserFuzzer.fuzzerTestOneInput(TextAndCSVParserFuzzer.java:41)                                                   
                             DEDUP_TOKEN: 092377579d0e2656                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Issue===                                                                                                                                        
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueMedium: Server Side Request Forgery (SSRF)                                  
                             Attempted connection to: jazzer.com:443                                                                                                            
                             Requests to destinations based on untrusted data could lead to exfiltration of sensitive data or exposure of internal services.                    
                                                                                                                                                                                
                                                                                                                                                                                
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrf(ServerSideRequestForgery.java:127)                           
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrfSocket(ServerSideRequestForgery.java:71)                      
                                     at java.base/java.net.Socket.connect(Socket.java:633)                                                                                      
                                     at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:299)                                                                
                                     at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178)                                                                       
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:498)                                                                   
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:603)                                                                   
                                     at java.base/sun.net.www.protocol.https.HttpsClient.<init>(HttpsClient.java:266)                                                           
                                     at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380)                                                              
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:1                 
                             89)                                                                                                                                                
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242)                                        
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128)                                         
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:175)                       
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1665)                                      
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1589)                                       
                                     at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getInputStream(HttpsURLConnectionImpl.java:224)                             
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processURL(TextAndCSVParser.java:278)                                                       
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processCell(TextAndCSVParser.java:261)                                                      
                                     at org.apache.tika.parser.csv.TextAndCSVParser.parse(TextAndCSVParser.java:211)                                                            
                                     at com.example.TextAndCSVParserFuzzer.parseOne(TextAndCSVParserFuzzer.java:57)                                                             
                                     at com.example.TextAndCSVParserFuzzer.fuzzerTestOneInput(TextAndCSVParserFuzzer.java:41)                                                   
                             DEDUP_TOKEN: 092377579d0e2656                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Evaluation Report===                                                                                                                            
                                                                                                                                                                                
                             ===Analysis Report===                                                                                                                              
                                                                                                                                                                                
                             ===Evaluation End===                                                                                                                               
[10/08/25 11:25:25] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                 __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/08/25 11:27:10] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/08/25 11:29:54] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:29:55] INFO     [logging_performance](tika Setting owner) Took 0.90 seconds; exception=False                                                 context_managers.py:23
                    INFO     [logging_performance](tika Patching) Started...                                                                               context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmp9e7pw5q6                                                                                                default.py:173
[10/08/25 11:31:20] INFO     [logging_performance](tika Patching) Took 84.68 seconds; exception=False                                                     context_managers.py:23
                    INFO     [logging_performance](tika Checking build) Started...                                                                         context_managers.py:9
[10/08/25 11:31:53] INFO     [logging_performance](tika Checking build) Took 32.99 seconds; exception=False                                               context_managers.py:23
                    INFO     [logging_performance](tika Running PoV) Started...                                                                            context_managers.py:9
[10/08/25 11:32:02] INFO     [logging_performance](tika Running PoV) Took 8.82 seconds; exception=False                                                   context_managers.py:23
                    INFO     [logging_performance](tika Testing) Started...                                                                                context_managers.py:9
                    INFO     [logging_performance](tika Testing) Took 0.00 seconds; exception=False                                                       context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:32:03] INFO     [logging_performance](tika Setting owner) Took 0.92 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:32:04] INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:32:05] INFO     [logging_performance](tika Setting owner) Took 0.96 seconds; exception=False                                                 context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:32:06] INFO     [logging_performance](tika Setting owner) Took 0.90 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:32:07] INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                  
                             ===Evaluator Diff===                                                                                                                               
                             ---                                                                                                                                                
                             a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/cs                 
                             v/TextAndCSVConfig.java                                                                                                                            
                             +++                                                                                                                                                
                             b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/cs                 
                             v/TextAndCSVConfig.java                                                                                                                            
                             @@ -19,7 +19,7 @@                                                                                                                                  
                              import java.io.Serializable;                                                                                                                      
                              import java.util.HashMap;                                                                                                                         
                              import java.util.Map;                                                                                                                             
                             -                                                                                                                                                  
                             +import org.apache.tika.config.Field;                                                                                                              
                              public class TextAndCSVConfig implements Serializable {                                                                                           
                                                                                                                                                                                
                                  private static final Map<Character, String> DELIMITER_TO_NAME_MAP = new HashMap<>();                                                          
                             @@ -40,6 +40,16 @@                                                                                                                                 
                                                                                                                                                                                
                                  private Map<String, Character> nameToDelimiterMap = NAME_TO_DELIMITER_MAP;                                                                    
                                  private Map<Character, String> delimiterToNameMap = DELIMITER_TO_NAME_MAP;                                                                    
                             +    private boolean followHyperlinks = false;                                                                                                     
                             +                                                                                                                                                  
                             +    public boolean isFollowHyperlinks() {                                                                                                         
                             +        return followHyperlinks;                                                                                                                  
                             +    }                                                                                                                                             
                             +                                                                                                                                                  
                             +    @Field                                                                                                                                        
                             +    public void setFollowHyperlinks(boolean followHyperlinks) {                                                                                   
                             +        this.followHyperlinks = followHyperlinks;                                                                                                 
                             +    }                                                                                                                                             
                                                                                                                                                                                
                                  public Map<String, Character> getNameToDelimiterMap() {                                                                                       
                                      return nameToDelimiterMap;                                                                                                                
                                                                                                                                                                                
                             ---                                                                                                                                                
                             a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/cs                 
                             v/TextAndCSVParser.java                                                                                                                            
                             +++                                                                                                                                                
                             b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/cs                 
                             v/TextAndCSVParser.java                                                                                                                            
                             @@ -248,6 +248,7 @@                                                                                                                                
                                                           Metadata metadata,                                                                                                   
                                                           ParseContext context) throws IOException, SAXException {                                                             
                                      xhtml.startElement(TD);                                                                                                                   
                             +        TextAndCSVConfig config = context.get(TextAndCSVConfig.class, defaultTextAndCSVConfig);                                                   
                                      Matcher m = HYPERLINK_PATTERN.matcher(cellContent);                                                                                       
                                      if (m.find()) {                                                                                                                           
                                          String url = m.group(1);                                                                                                              
                             @@ -258,7 +259,9 @@                                                                                                                                
                                          xhtml.startElement("a", "href", url);                                                                                                 
                                          xhtml.characters(name);                                                                                                               
                                          xhtml.endElement("a");                                                                                                                
                             -            processURL(url, name, xhtml, metadata, context);                                                                                      
                             +            if (config.isFollowHyperlinks()) {                                                                                                    
                             +                processURL(url, name, xhtml, metadata, context);                                                                                  
                             +            }                                                                                                                                     
                                      } else {                                                                                                                                  
                                          xhtml.characters(cellContent);                                                                                                        
                                      }                                                                                                                                         
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                                                                                                                                                                                
                             ===Issue===                                                                                                                                        
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueMedium: Server Side Request Forgery (SSRF)                                  
                             Attempted connection to: jazzer.com:443                                                                                                            
                             Requests to destinations based on untrusted data could lead to exfiltration of sensitive data or exposure of internal services.                    
                                                                                                                                                                                
                                                                                                                                                                                
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrf(ServerSideRequestForgery.java:127)                           
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrfSocket(ServerSideRequestForgery.java:71)                      
                                     at java.base/java.net.Socket.connect(Socket.java:633)                                                                                      
                                     at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:299)                                                                
                                     at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178)                                                                       
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:498)                                                                   
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:603)                                                                   
                                     at java.base/sun.net.www.protocol.https.HttpsClient.<init>(HttpsClient.java:266)                                                           
                                     at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380)                                                              
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:1                 
                             89)                                                                                                                                                
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242)                                        
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128)                                         
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:175)                       
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1665)                                      
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1589)                                       
                                     at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getInputStream(HttpsURLConnectionImpl.java:224)                             
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processURL(TextAndCSVParser.java:278)                                                       
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processCell(TextAndCSVParser.java:261)                                                      
                                     at org.apache.tika.parser.csv.TextAndCSVParser.parse(TextAndCSVParser.java:211)                                                            
                                     at com.example.TextAndCSVParserFuzzer.parseOne(TextAndCSVParserFuzzer.java:57)                                                             
                                     at com.example.TextAndCSVParserFuzzer.fuzzerTestOneInput(TextAndCSVParserFuzzer.java:41)                                                   
                             DEDUP_TOKEN: 092377579d0e2656                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Evaluation Report===                                                                                                                            
                             # Evaluation Report                                                                                                                                
                                                                                                                                                                                
                             ## Summary                                                                                                                                         
                                                                                                                                                                                
                             A Jazzer fuzzing run triggered a `FuzzerSecurityIssueMedium` exception indicating a Server Side Request Forgery (SSRF) attempt.                    
                             The sanitizer detected an attempted outbound connection to `jazzer.com:443` when parsing CSV input via Apache Tika’s                               
                             `TextAndCSVParser`. The exception halted execution, flagging untrusted data being used to initiate a network request.                              
                                                                                                                                                                                
                             ## Description                                                                                                                                     
                                                                                                                                                                                
                             - Issue                                                                                                                                            
                               During fuzz testing, the code attempted to open a TCP/SSL socket to an external host (`jazzer.com:443`). Jazzer’s SSRF sanitizer                 
                             (`ServerSideRequestForgery.checkSsrf`) intercepted and blocked the connection, raising a `FuzzerSecurityIssueMedium` error.                        
                                                                                                                                                                                
                             - Vulnerability Type                                                                                                                               
                               The issue is classified as Server Side Request Forgery (SSRF). SSFR occurs when an attacker-controlled input is used to make                     
                             unintended network requests, potentially exposing internal services or sensitive data.                                                             
                                                                                                                                                                                
                             - Important Observations                                                                                                                           
                               • The sanitizer stack trace shows the SSRF check in `ServerSideRequestForgery.checkSsrf` and `checkSsrfSocket`.                                  
                               • The network attempt originates in the JDK networking libraries (`Socket.connect`, `SSLSocketImpl.connect`,                                     
                             `HttpClient.openServer`, etc.).                                                                                                                    
                               • The immediate caller is Apache Tika’s `TextAndCSVParser.processURL` (line 278), invoked during CSV parsing at `processCell`                    
                             (line 261) and `parse` (line 211).                                                                                                                 
                               • The fuzzer harness (`TextAndCSVParserFuzzer.parseOne` at line 57 and `fuzzerTestOneInput` at line 41) feeds crafted inputs                     
                             into Tika, triggering the URL processing path.                                                                                                     
                                                                                                                                                                                
                             - Code Areas for Investigation                                                                                                                     
                               1. Apache Tika’s CSV parser (org.apache.tika.parser.csv.TextAndCSVParser), specifically the `processURL` method and its URL                      
                             resolution logic.                                                                                                                                  
                               2. The interaction between parsed cell values and external resource loading—how untrusted data may be treated as a URL.                          
                               3. Jazzer’s SSRF sanitizer implementation (com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery) to understand                       
                             detection boundaries.                                                                                                                              
                               4. The fuzzer harness in `com.example.TextAndCSVParserFuzzer`, which drives the parser and exposes the parsing code to arbitrary                 
                             input.                                                                                                                                             
                                                                                                                                                                                
                             Investigating these components will give a holistic view of how untrusted data leads to outbound connections and where controls                    
                             are enforced.                                                                                                                                      
                                                                                                                                                                                
                             ## Initial Issue Log                                                                                                                               
                             Here is the initial issue log of the codebase:                                                                                                     
                             <issue>                                                                                                                                            
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueMedium: Server Side Request Forgery (SSRF)                                  
                             Attempted connection to: jazzer.com:443                                                                                                            
                             Requests to destinations based on untrusted data could lead to exfiltration of sensitive data or exposure of internal services.                    
                                                                                                                                                                                
                                                                                                                                                                                
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrf(ServerSideRequestForgery.java:127)                           
                                     at com.code_intelligence.jazzer.sanitizers.ServerSideRequestForgery.checkSsrfSocket(ServerSideRequestForgery.java:71)                      
                                     at java.base/java.net.Socket.connect(Socket.java:633)                                                                                      
                                     at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:299)                                                                
                                     at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178)                                                                       
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:498)                                                                   
                                     at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:603)                                                                   
                                     at java.base/sun.net.www.protocol.https.HttpsClient.<init>(HttpsClient.java:266)                                                           
                                     at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380)                                                              
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:1                 
                             89)                                                                                                                                                
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242)                                        
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128)                                         
                                     at                                                                                                                                         
                             java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:175)                       
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1665)                                      
                                     at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1589)                                       
                                     at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getInputStream(HttpsURLConnectionImpl.java:224)                             
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processURL(TextAndCSVParser.java:278)                                                       
                                     at org.apache.tika.parser.csv.TextAndCSVParser.processCell(TextAndCSVParser.java:261)                                                      
                                     at org.apache.tika.parser.csv.TextAndCSVParser.parse(TextAndCSVParser.java:211)                                                            
                                     at com.example.TextAndCSVParserFuzzer.parseOne(TextAndCSVParserFuzzer.java:57)                                                             
                                     at com.example.TextAndCSVParserFuzzer.fuzzerTestOneInput(TextAndCSVParserFuzzer.java:41)                                                   
                             DEDUP_TOKEN: 092377579d0e2656                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             </issue>                                                                                                                                           
                             ===Analysis Report===                                                                                                                              
                             # Analysis Report                                                                                                                                  
                                                                                                                                                                                
                             ## Relevant Code Snippets                                                                                                                          
                             <code_snippets>                                                                                                                                    
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:1-120                                                                                                                        
                             ```                                                                                                                                                
                             1:/*                                                                                                                                               
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                            
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                         
                             4: * this work for additional information regarding copyright ownership.                                                                           
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                       
                             6: * (the "License"); you may not use this file except in compliance with                                                                          
                             7: * the License.  You may obtain a copy of the License at                                                                                         
                             8: *                                                                                                                                               
                             9: *      http://www.apache.org/licenses/LICENSE-2.0                                                                                               
                             10: *                                                                                                                                              
                             11: * Unless required by applicable law or agreed to in writing, software                                                                          
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                            
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                     
                             14: * See the License for the specific language governing permissions and                                                                          
                             15: * limitations under the License.                                                                                                               
                             16: */                                                                                                                                             
                             17:package org.apache.tika.parser.csv;                                                                                                             
                             18:                                                                                                                                                
                             19:import java.io.BufferedReader;                                                                                                                  
                             20:import java.io.IOException;                                                                                                                     
                             21:import java.io.InputStream;                                                                                                                     
                             22:import java.io.InputStreamReader;                                                                                                               
                             23:import java.io.Reader;                                                                                                                          
                             24:import java.io.UncheckedIOException;                                                                                                            
                             25:import java.net.URL;                                                                                                                            
                             26:import java.net.URLConnection;                                                                                                                  
                             27:import java.nio.charset.Charset;                                                                                                                
                             28:import java.nio.charset.UnsupportedCharsetException;                                                                                            
                             29:import java.util.Arrays;                                                                                                                        
                             30:import java.util.Collections;                                                                                                                   
                             31:import java.util.HashMap;                                                                                                                       
                             32:import java.util.HashSet;                                                                                                                       
                             33:import java.util.Map;                                                                                                                           
                             34:import java.util.Set;                                                                                                                           
                             35:import java.util.regex.Matcher;                                                                                                                 
                             36:import java.util.regex.Pattern;                                                                                                                 
                             37:                                                                                                                                                
                             38:import org.apache.commons.csv.CSVFormat;                                                                                                        
                             39:import org.apache.commons.csv.CSVParser;                                                                                                        
                             40:import org.apache.commons.csv.CSVRecord;                                                                                                        
                             41:import org.apache.commons.io.input.CloseShieldInputStream;                                                                                      
                             42:import org.xml.sax.ContentHandler;                                                                                                              
                             43:import org.xml.sax.SAXException;                                                                                                                
                             44:                                                                                                                                                
                             45:import org.apache.tika.config.Field;                                                                                                            
                             46:import org.apache.tika.detect.AutoDetectReader;                                                                                                 
                             47:import org.apache.tika.detect.EncodingDetector;                                                                                                 
                             48:import org.apache.tika.exception.TikaConfigException;                                                                                           
                             49:import org.apache.tika.exception.TikaException;                                                                                                 
                             50:import org.apache.tika.extractor.EmbeddedDocumentExtractor;                                                                                     
                             51:import org.apache.tika.extractor.EmbeddedDocumentUtil;                                                                                          
                             52:import org.apache.tika.io.TikaInputStream;                                                                                                      
                             53:import org.apache.tika.metadata.Metadata;                                                                                                       
                             54:import org.apache.tika.metadata.Property;                                                                                                       
                             55:import org.apache.tika.metadata.TikaCoreProperties;                                                                                             
                             56:import org.apache.tika.mime.MediaType;                                                                                                          
                             57:import org.apache.tika.parser.AbstractEncodingDetectorParser;                                                                                   
                             58:import org.apache.tika.parser.ParseContext;                                                                                                     
                             59:import org.apache.tika.sax.XHTMLContentHandler;                                                                                                 
                             60:import org.apache.tika.utils.ExceptionUtils;                                                                                                    
                             61:import org.apache.tika.utils.StringUtils;                                                                                                       
                             62:                                                                                                                                                
                             63:/**                                                                                                                                             
                             64: * Unless the {@link TikaCoreProperties#CONTENT_TYPE_USER_OVERRIDE} is set,                                                                     
                             65: * this parser tries to assess whether the file is a text file, csv or tsv.                                                                     
                             66: * If the detector detects regularity in column numbers and/or encapsulated cells,                                                              
                             67: * this parser will apply the {@link org.apache.commons.csv.CSVParser};                                                                         
                             68: * otherwise, it will treat the contents as text.                                                                                               
                             69: * <p>                                                                                                                                          
                             70: * If there is a csv parse exception during detection, the parser sets                                                                          
                             71: * the {@link Metadata#CONTENT_TYPE} to {@link MediaType#TEXT_PLAIN}                                                                            
                             72: * and treats the file as {@link MediaType#TEXT_PLAIN}.                                                                                         
                             73: * </p>                                                                                                                                         
                             74: * <p>                                                                                                                                          
                             75: * If there is a csv parse exception during the parse, the parser                                                                               
                             76: * writes what's left of the stream as if it were text and then throws                                                                          
                             77: * an exception.  As of this writing, the content that was buffered by the underlying                                                           
                             78: * {@link org.apache.commons.csv.CSVParser} is lost.                                                                                            
                             79: * </p>                                                                                                                                         
                             80: */                                                                                                                                             
                             81:public class TextAndCSVParser extends AbstractEncodingDetectorParser {                                                                          
                             82:                                                                                                                                                
                             83:    static final MediaType CSV = MediaType.text("csv");                                                                                         
                             84:    static final MediaType TSV = MediaType.text("tsv");                                                                                         
                             85:    private static final String CSV_PREFIX = "csv";                                                                                             
                             86:    private static final String CHARSET = "charset";                                                                                            
                             87:    private static final String DELIMITER = "delimiter";                                                                                        
                             88:    public static final Property DELIMITER_PROPERTY = Property.externalText(                                                                    
                             89:            CSV_PREFIX + TikaCoreProperties.NAMESPACE_PREFIX_DELIMITER + DELIMITER);                                                            
                             90:                                                                                                                                                
                             91:    /**                                                                                                                                         
                             92:     * If the file is detected as a csv/tsv, this is the number of columns in the first row.                                                    
                             93:     */                                                                                                                                         
                             94:    public static final Property NUM_COLUMNS = Property.externalInteger(                                                                        
                             95:            CSV_PREFIX + TikaCoreProperties.NAMESPACE_PREFIX_DELIMITER + "num_columns");                                                        
                             96:                                                                                                                                                
                             97:    /**                                                                                                                                         
                             98:     * If the file is detected as a csv/tsv, this is the number of rows if the file                                                             
                             99:     * is successfully read (e.g. no encapsulation exceptions, etc).                                                                            
                             100:     */                                                                                                                                        
                             101:    public static final Property NUM_ROWS = Property.externalInteger(                                                                          
                             102:            CSV_PREFIX + TikaCoreProperties.NAMESPACE_PREFIX_DELIMITER + "num_rows");                                                          
                             103:                                                                                                                                               
                             104:    private static final Pattern HYPERLINK_PATTERN =                                                                                           
                             105:            Pattern.compile("(?i)[\"]*=HYPERLINK\\([\"]+([^\"]+)(?:[\" ]+,[ \"]+([^\"]+))?");                                                  
                             106:                                                                                                                                               
                             107:    private static final String TD = "td";                                                                                                     
                             108:    private static final String TR = "tr";                                                                                                     
                             109:    private static final String TABLE = "table";                                                                                               
                             110:    private static final int DEFAULT_MARK_LIMIT = 20000;                                                                                       
                             111:                                                                                                                                               
                             112:    private static final Set<MediaType> SUPPORTED_TYPES = Collections                                                                          
                             113:            .unmodifiableSet(new HashSet<>(Arrays.asList(CSV, TSV, MediaType.TEXT_PLAIN)));                                                    
                             114:                                                                                                                                               
                             115:    /**                                                                                                                                        
                             116:     * This is the mark limit in characters (not bytes) to                                                                                     
                             117:     * read from the stream when classifying the stream as                                                                                     
                             118:     * csv, tsv or txt.                                                                                                                        
                             119:     */                                                                                                                                        
                             120:    @Field                                                                                                                                     
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:245-280                                                                                                                      
                             ```                                                                                                                                                
                             245:    }                                                                                                                                          
                             246:                                                                                                                                               
                             247:    private void processCell(String cellContent, XHTMLContentHandler xhtml,                                                                    
                             248:                             Metadata metadata,                                                                                                
                             249:                             ParseContext context) throws IOException, SAXException {                                                          
                             250:        xhtml.startElement(TD);                                                                                                                
                             251:        Matcher m = HYPERLINK_PATTERN.matcher(cellContent);                                                                                    
                             252:        if (m.find()) {                                                                                                                        
                             253:            String url = m.group(1);                                                                                                           
                             254:            String name = m.group(2);                                                                                                          
                             255:            if (StringUtils.isBlank(name)) {                                                                                                   
                             256:                name = url;                                                                                                                    
                             257:            }                                                                                                                                  
                             258:            xhtml.startElement("a", "href", url);                                                                                              
                             259:            xhtml.characters(name);                                                                                                            
                             260:            xhtml.endElement("a");                                                                                                             
                             261:            processURL(url, name, xhtml, metadata, context);                                                                                   
                             262:        } else {                                                                                                                               
                             263:            xhtml.characters(cellContent);                                                                                                     
                             264:        }                                                                                                                                      
                             265:        xhtml.endElement(TD);                                                                                                                  
                             266:    }                                                                                                                                          
                             267:                                                                                                                                               
                             268:    private void processURL(String urlString, String name, XHTMLContentHandler xhtml,                                                          
                             269:                            Metadata parentMetadata,                                                                                           
                             270:                            ParseContext context) throws IOException, SAXException {                                                           
                             271:        EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);                                             
                             272:        Metadata metadata = new Metadata();                                                                                                    
                             273:        metadata.set(TikaCoreProperties.RESOURCE_NAME_KEY, name);                                                                              
                             274:        try {                                                                                                                                  
                             275:            URL url = new URL(urlString);                                                                                                      
                             276:            URLConnection connection = url.openConnection();                                                                                   
                             277:            connection.setConnectTimeout(5000);                                                                                                
                             278:            try (TikaInputStream tis = TikaInputStream.get(connection.getInputStream())) {                                                     
                             279:                ex.parseEmbedded(tis, xhtml, metadata, false);                                                                                 
                             280:            }                                                                                                                                  
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVConfig.java:1-58                                                                                                                         
                             ```                                                                                                                                                
                             1:/*                                                                                                                                               
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                            
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                         
                             4: * this work for additional information regarding copyright ownership.                                                                           
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                       
                             6: * (the "License"); you may not use this file except in compliance with                                                                          
                             7: * the License.  You may obtain a copy of the License at                                                                                         
                             8: *                                                                                                                                               
                             9: *      http://www.apache.org/licenses/LICENSE-2.0                                                                                               
                             10: *                                                                                                                                              
                             11: * Unless required by applicable law or agreed to in writing, software                                                                          
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                            
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                     
                             14: * See the License for the specific language governing permissions and                                                                          
                             15: * limitations under the License.                                                                                                               
                             16: */                                                                                                                                             
                             17:package org.apache.tika.parser.csv;                                                                                                             
                             18:                                                                                                                                                
                             19:import java.io.Serializable;                                                                                                                    
                             20:import java.util.HashMap;                                                                                                                       
                             21:import java.util.Map;                                                                                                                           
                             22:                                                                                                                                                
                             23:public class TextAndCSVConfig implements Serializable {                                                                                         
                             24:                                                                                                                                                
                             25:    private static final Map<Character, String> DELIMITER_TO_NAME_MAP = new HashMap<>();                                                        
                             26:    private static final Map<String, Character> NAME_TO_DELIMITER_MAP = new HashMap<>();                                                        
                             27:                                                                                                                                                
                             28:    static {                                                                                                                                    
                             29:        DELIMITER_TO_NAME_MAP.put(',', "comma");                                                                                                
                             30:        DELIMITER_TO_NAME_MAP.put('\t', "tab");                                                                                                 
                             31:        DELIMITER_TO_NAME_MAP.put('|', "pipe");                                                                                                 
                             32:        DELIMITER_TO_NAME_MAP.put(';', "semicolon");                                                                                            
                             33:    }                                                                                                                                           
                             34:                                                                                                                                                
                             35:    static {                                                                                                                                    
                             36:        for (Map.Entry<Character, String> e : DELIMITER_TO_NAME_MAP.entrySet()) {                                                               
                             37:            NAME_TO_DELIMITER_MAP.put(e.getValue(), e.getKey());                                                                                
                             38:        }                                                                                                                                       
                             39:    }                                                                                                                                           
                             40:                                                                                                                                                
                             41:    private Map<String, Character> nameToDelimiterMap = NAME_TO_DELIMITER_MAP;                                                                  
                             42:    private Map<Character, String> delimiterToNameMap = DELIMITER_TO_NAME_MAP;                                                                  
                             43:                                                                                                                                                
                             44:    public Map<String, Character> getNameToDelimiterMap() {                                                                                     
                             45:        return nameToDelimiterMap;                                                                                                              
                             46:    }                                                                                                                                           
                             47:                                                                                                                                                
                             48:    public Map<Character, String> getDelimiterToNameMap() {                                                                                     
                             49:        return delimiterToNameMap;                                                                                                              
                             50:    }                                                                                                                                           
                             51:                                                                                                                                                
                             52:    public void setNameToDelimiterMap(Map<String, Character> nameToDelimiterMap) {                                                              
                             53:        this.nameToDelimiterMap = new HashMap<>(nameToDelimiterMap);                                                                            
                             54:        this.delimiterToNameMap = new HashMap<>();                                                                                              
                             55:        nameToDelimiterMap.entrySet()                                                                                                           
                             56:                          .forEach(e -> delimiterToNameMap.put(e.getValue(), e.getKey()));                                                      
                             57:    }                                                                                                                                           
                             58:}                                                                                                                                               
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVConfig.java:40-50                                                                                                                        
                             ```                                                                                                                                                
                             40:                                                                                                                                                
                             41:    private Map<String, Character> nameToDelimiterMap = NAME_TO_DELIMITER_MAP;                                                                  
                             42:    private Map<Character, String> delimiterToNameMap = DELIMITER_TO_NAME_MAP;                                                                  
                             43:                                                                                                                                                
                             44:    public Map<String, Character> getNameToDelimiterMap() {                                                                                     
                             45:        return nameToDelimiterMap;                                                                                                              
                             46:    }                                                                                                                                           
                             47:                                                                                                                                                
                             48:    public Map<Character, String> getDelimiterToNameMap() {                                                                                     
                             49:        return delimiterToNameMap;                                                                                                              
                             50:    }                                                                                                                                           
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVConfig.java:50-58                                                                                                                        
                             ```                                                                                                                                                
                             50:    }                                                                                                                                           
                             51:                                                                                                                                                
                             52:    public void setNameToDelimiterMap(Map<String, Character> nameToDelimiterMap) {                                                              
                             53:        this.nameToDelimiterMap = new HashMap<>(nameToDelimiterMap);                                                                            
                             54:        this.delimiterToNameMap = new HashMap<>();                                                                                              
                             55:        nameToDelimiterMap.entrySet()                                                                                                           
                             56:                          .forEach(e -> delimiterToNameMap.put(e.getValue(), e.getKey()));                                                      
                             57:    }                                                                                                                                           
                             58:}                                                                                                                                               
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:156-165                                                                                                                      
                             ```                                                                                                                                                
                             156:    }                                                                                                                                          
                             157:                                                                                                                                               
                             158:    private final TextAndCSVConfig defaultTextAndCSVConfig = new TextAndCSVConfig();                                                           
                             159:    @Override                                                                                                                                  
                             160:    public Set<MediaType> getSupportedTypes(ParseContext context) {                                                                            
                             161:        return SUPPORTED_TYPES;                                                                                                                
                             162:    }                                                                                                                                          
                             163:                                                                                                                                               
                             164:    @Override                                                                                                                                  
                             165:    public void parse(InputStream stream, ContentHandler handler, Metadata metadata,                                                           
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:245-266                                                                                                                      
                             ```                                                                                                                                                
                             245:    }                                                                                                                                          
                             246:                                                                                                                                               
                             247:    private void processCell(String cellContent, XHTMLContentHandler xhtml,                                                                    
                             248:                             Metadata metadata,                                                                                                
                             249:                             ParseContext context) throws IOException, SAXException {                                                          
                             250:        xhtml.startElement(TD);                                                                                                                
                             251:        Matcher m = HYPERLINK_PATTERN.matcher(cellContent);                                                                                    
                             252:        if (m.find()) {                                                                                                                        
                             253:            String url = m.group(1);                                                                                                           
                             254:            String name = m.group(2);                                                                                                          
                             255:            if (StringUtils.isBlank(name)) {                                                                                                   
                             256:                name = url;                                                                                                                    
                             257:            }                                                                                                                                  
                             258:            xhtml.startElement("a", "href", url);                                                                                              
                             259:            xhtml.characters(name);                                                                                                            
                             260:            xhtml.endElement("a");                                                                                                             
                             261:            processURL(url, name, xhtml, metadata, context);                                                                                   
                             262:        } else {                                                                                                                               
                             263:            xhtml.characters(cellContent);                                                                                                     
                             264:        }                                                                                                                                      
                             265:        xhtml.endElement(TD);                                                                                                                  
                             266:    }                                                                                                                                          
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVConfig.java:41-58                                                                                                                        
                             ```                                                                                                                                                
                             41:    private Map<String, Character> nameToDelimiterMap = NAME_TO_DELIMITER_MAP;                                                                  
                             42:    private Map<Character, String> delimiterToNameMap = DELIMITER_TO_NAME_MAP;                                                                  
                             43:                                                                                                                                                
                             44:    public Map<String, Character> getNameToDelimiterMap() {                                                                                     
                             45:        return nameToDelimiterMap;                                                                                                              
                             46:    }                                                                                                                                           
                             47:                                                                                                                                                
                             48:    public Map<Character, String> getDelimiterToNameMap() {                                                                                     
                             49:        return delimiterToNameMap;                                                                                                              
                             50:    }                                                                                                                                           
                             51:                                                                                                                                                
                             52:    public void setNameToDelimiterMap(Map<String, Character> nameToDelimiterMap) {                                                              
                             53:        this.nameToDelimiterMap = new HashMap<>(nameToDelimiterMap);                                                                            
                             54:        this.delimiterToNameMap = new HashMap<>();                                                                                              
                             55:        nameToDelimiterMap.entrySet()                                                                                                           
                             56:                          .forEach(e -> delimiterToNameMap.put(e.getValue(), e.getKey()));                                                      
                             57:    }                                                                                                                                           
                             58:}                                                                                                                                               
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:150-170                                                                                                                      
                             ```                                                                                                                                                
                             150:                                                                                                                                               
                             151:    static boolean isCSVOrTSV(MediaType mediaType) {                                                                                           
                             152:        if (mediaType == null) {                                                                                                               
                             153:            return false;                                                                                                                      
                             154:        }                                                                                                                                      
                             155:        return mediaType.getBaseType().equals(TSV) || mediaType.getBaseType().equals(CSV);                                                     
                             156:    }                                                                                                                                          
                             157:                                                                                                                                               
                             158:    private final TextAndCSVConfig defaultTextAndCSVConfig = new TextAndCSVConfig();                                                           
                             159:    @Override                                                                                                                                  
                             160:    public Set<MediaType> getSupportedTypes(ParseContext context) {                                                                            
                             161:        return SUPPORTED_TYPES;                                                                                                                
                             162:    }                                                                                                                                          
                             163:                                                                                                                                               
                             164:    @Override                                                                                                                                  
                             165:    public void parse(InputStream stream, ContentHandler handler, Metadata metadata,                                                           
                             166:                      ParseContext context) throws IOException, SAXException, TikaException {                                                  
                             167:        TextAndCSVConfig textAndCSVConfig = context.get(TextAndCSVConfig.class, defaultTextAndCSVConfig);                                      
                             168:                                                                                                                                               
                             169:        CSVParams params = getOverride(metadata, textAndCSVConfig);                                                                            
                             170:        Reader reader;                                                                                                                         
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/                 
                             TextAndCSVParser.java:245-266                                                                                                                      
                             ```                                                                                                                                                
                             245:    }                                                                                                                                          
                             246:                                                                                                                                               
                             247:    private void processCell(String cellContent, XHTMLContentHandler xhtml,                                                                    
                             248:                             Metadata metadata,                                                                                                
                             249:                             ParseContext context) throws IOException, SAXException {                                                          
                             250:        xhtml.startElement(TD);                                                                                                                
                             251:        Matcher m = HYPERLINK_PATTERN.matcher(cellContent);                                                                                    
                             252:        if (m.find()) {                                                                                                                        
                             253:            String url = m.group(1);                                                                                                           
                             254:            String name = m.group(2);                                                                                                          
                             255:            if (StringUtils.isBlank(name)) {                                                                                                   
                             256:                name = url;                                                                                                                    
                             257:            }                                                                                                                                  
                             258:            xhtml.startElement("a", "href", url);                                                                                              
                             259:            xhtml.characters(name);                                                                                                            
                             260:            xhtml.endElement("a");                                                                                                             
                             261:            processURL(url, name, xhtml, metadata, context);                                                                                   
                             262:        } else {                                                                                                                               
                             263:            xhtml.characters(cellContent);                                                                                                     
                             264:        }                                                                                                                                      
                             265:        xhtml.endElement(TD);                                                                                                                  
                             266:    }                                                                                                                                          
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             </code_snippets>                                                                                                                                   
                                                                                                                                                                                
                             ## Fix Strategy                                                                                                                                    
                             <fix_strategy>                                                                                                                                     
                                                                                                                                                                                
                             1. Introduce an explicit “opt‐in” toggle in the CSV parser configuration to disable HTTP(S) fetches by default.                                    
                                a. In TextAndCSVConfig, add:                                                                                                                    
                                   - private boolean followHyperlinks = false;                                                                                                  
                                   - public boolean isFollowHyperlinks() { return followHyperlinks; }                                                                           
                                   - @Field public void setFollowHyperlinks(boolean followHyperlinks) { this.followHyperlinks = followHyperlinks; }                             
                                b. Default remains false, so existing code will no longer automatically follow any hyperlinks.                                                  
                                                                                                                                                                                
                             2. Wire the new config into the parser without touching harness or test code:                                                                      
                                a. In TextAndCSVParser.parse(...):                                                                                                              
                                   ```java                                                                                                                                      
                                   // at the start of parse()                                                                                                                   
                                   TextAndCSVConfig config =                                                                                                                    
                                       context.get(TextAndCSVConfig.class, defaultTextAndCSVConfig);                                                                            
                                   ```                                                                                                                                          
                                b. Pass this config down to cell‐processing, or let processCell pull it from the same context.                                                  
                                                                                                                                                                                
                             3. In processCell, guard outbound fetches:                                                                                                         
                                ```java                                                                                                                                         
                                private void processCell(..., ParseContext context) {                                                                                           
                                  TextAndCSVConfig config =                                                                                                                     
                                      context.get(TextAndCSVConfig.class, defaultTextAndCSVConfig);                                                                             
                                  Matcher m = HYPERLINK_PATTERN.matcher(cellContent);                                                                                           
                                  if (m.find()) {                                                                                                                               
                                    // render <a href="...">...                                                                                                                 
                                    if (config.isFollowHyperlinks()) {                                                                                                          
                                      processURL(url, name, xhtml, metadata, context);                                                                                          
                                    }                                                                                                                                           
                                    // else: skip processURL, preventing network calls                                                                                          
                                  } else {                                                                                                                                      
                                    xhtml.characters(cellContent);                                                                                                              
                                  }                                                                                                                                             
                                }                                                                                                                                               
                                ```                                                                                                                                             
                                - This preserves anchor markup (so no test breakage) but stops any URLConnection when followHyperlinks is false.                                
                                - No changes to harness or fuzzing logic; the SSRF sanitizer will no longer see outbound HTTP(S) connections.                                   
                                                                                                                                                                                
                             4. (Optional Security Hardening) Further restrict by protocol:                                                                                     
                                - Inside the `if (config.isFollowHyperlinks())` block, you may add:                                                                             
                                  ```java                                                                                                                                       
                                  String protocol = url.getProtocol().toLowerCase(Locale.ROOT);                                                                                 
                                  if ("http".equals(protocol) || "https".equals(protocol)) {                                                                                    
                                    // proceed                                                                                                                                  
                                  } else if ("file".equals(protocol) || "data".equals(protocol)) {                                                                              
                                    // always allow safe protocols even if followHyperlinks=false                                                                               
                                  } else {                                                                                                                                      
                                    // skip unknown protocols                                                                                                                   
                                  }                                                                                                                                             
                                  ```                                                                                                                                           
                                - This ensures that local file embeds or data URIs still work, while untrusted HTTP(S) remains disabled by default.                             
                                                                                                                                                                                
                             5. Documentation & Backwards Compatibility:                                                                                                        
                                - Update parser JavaDoc to mention the new `followHyperlinks` toggle, its default (false), and how to enable it via Tika                        
                             configuration.                                                                                                                                     
                                - No existing tests need to be changed since default behavior no longer makes any network calls; embedded‐resource tests will                   
                             continue using the same local fixtures.                                                                                                            
                                                                                                                                                                                
                             Justification:                                                                                                                                     
                             - SSRF arises because arbitrary CSV cells matching the HYPERLINK pattern invoke URLConnection without validation.                                  
                             - By disabling network fetches by default and requiring explicit opt-in, we eliminate attacker-controlled SSRF.                                    
                             - Existing functionality remains intact for environments that configure `followHyperlinks=true`.                                                   
                             - We avoid broad exception catches, harness modifications, or changes to external libraries. All changes are confined to the                       
                             parser and its config, preserving the existing API and test suites.                                                                                
                                                                                                                                                                                
                             Potential Side Effects & Mitigations:                                                                                                              
                             - Consumers who relied on automatic hyperlink following will notice that embedded content no longer loads unless they explicitly                   
                             enable it. Mitigate by documenting the new toggle.                                                                                                 
                             - Skipping processURL still emits `<a>` tags, ensuring the parser output remains structurally identical.                                           
                             - No new security risks are introduced; the optional protocol whitelist further tightens controls.                                                 
                                                                                                                                                                                
                             Relevant Code Ranges:                                                                                                                              
                             <code_range>tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVConfig.java:41-58</code_range>                              
                             <code_range>tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java:150-170</code_range>                            
                             <code_range>tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java:245-266</code_range>                            
                                                                                                                                                                                
                             </fix_strategy>                                                                                                                                    
                             ===Tests Result===                                                                                                                                 
                             No tests found                                                                                                                                     
                             ===Evaluation End===                                                                                                                               
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                     __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                      
                    INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmpijae2o5y                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/tika-tk-full-01-vuln_7/agent-output-1759923127.451582                                              
                             - Detection toml file: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/detection/tika-tk-full-01-vuln_7.toml                                           
                             - Challenge project directory: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/official-afc-tika                                                       
                                                                                                                                                                                
