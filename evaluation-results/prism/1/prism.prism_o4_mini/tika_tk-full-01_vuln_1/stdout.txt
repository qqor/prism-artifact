[10/08/25 11:04:05] INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmp0s_07v71                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/tika-tk-full-01-vuln_1/agent-output-1759921445.5618246                                             
                             - Detection toml file: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/detection/tika-tk-full-01-vuln_1.toml                                           
                             - Challenge project directory: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/official-afc-tika                                                       
                                                                                                                                                                                
                    INFO     [logging_performance](tika Building Cached for CLEAN environment) Started...                                                  context_managers.py:9
[10/08/25 11:05:52] INFO     [logging_performance](tika Building Cached for CLEAN environment) Took 107.01 seconds; exception=False                       context_managers.py:23
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Started...                                         context_managers.py:9
                    INFO     [logging_performance](tika Running tests for Cached for CLEAN environment) Took 0.00 seconds; exception=False                context_managers.py:23
                    INFO     Setting timeouts                                                                                                                      default.py:85
                               - build: 600 (original: 107)                                                                                                                     
                               - run tests: 600 (original: 0)                                                                                                                   
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:05:53] INFO     [logging_performance](tika Setting owner) Took 0.93 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:05:55] INFO     Successfully created Cached for CLEAN environment                                                                                   oss_fuzz.py:256
                    INFO     Current environments: ['CLEAN -> Cached']                                                                                           oss_fuzz.py:265
                    INFO     Prism Supervisor Routing: TeamStatus.START -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 0, patch status: PatchStatus.INITIALIZED)                                                                                                
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:05:56] INFO     [logging_performance](tika Setting owner) Took 1.22 seconds; exception=False                                                 context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:05:57] INFO     [logging_performance](tika Setting owner) Took 0.86 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:06:07] INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.VULNERABLE                                                                                                                             
                             ===Evaluator Diff===                                                                                                                               
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueHigh: Remote Code Execution                                                 
                             Unrestricted class/object creation based on externally controlled data may allow                                                                   
                             remote code execution depending on available classes on the classpath.                                                                             
                                     at jaz.Zer.reportFinding(Zer.java:110)                                                                                                     
                                     at jaz.Zer.reportFindingIfEnabled(Zer.java:105)                                                                                            
                                     at jaz.Zer.readObject(Zer.java:377)                                                                                                        
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                          
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)                                        
                                     at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                
                                     at java.base/java.lang.reflect.Method.invoke(Method.java:568)                                                                              
                                     at java.base/java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1231)                                                       
                                     at java.base/java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2434)                                                         
                                     at java.base/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2268)                                                     
                                     at java.base/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1744)                                                            
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:514)                                                              
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:472)                                                              
                                     at org.apache.tika.parser.microsoft.rtf.RTFEmbObjHandler.handleCompletedObject(RTFEmbObjHandler.java:217)                                  
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.processGroupEnd(TextExtractor.java:1475)                                             
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:482)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:466)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parseInline(RTFParser.java:96)                                                           
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parse(RTFParser.java:70)                                                                 
                                     at com.example.RTFParserFuzzer.parseOne(RTFParserFuzzer.java:53)                                                                           
                                     at com.example.RTFParserFuzzer.fuzzerTestOneInput(RTFParserFuzzer.java:40)                                                                 
                             DEDUP_TOKEN: aa5f725795b842b8                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Issue===                                                                                                                                        
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueHigh: Remote Code Execution                                                 
                             Unrestricted class/object creation based on externally controlled data may allow                                                                   
                             remote code execution depending on available classes on the classpath.                                                                             
                                     at jaz.Zer.reportFinding(Zer.java:110)                                                                                                     
                                     at jaz.Zer.reportFindingIfEnabled(Zer.java:105)                                                                                            
                                     at jaz.Zer.readObject(Zer.java:377)                                                                                                        
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                          
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)                                        
                                     at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                
                                     at java.base/java.lang.reflect.Method.invoke(Method.java:568)                                                                              
                                     at java.base/java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1231)                                                       
                                     at java.base/java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2434)                                                         
                                     at java.base/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2268)                                                     
                                     at java.base/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1744)                                                            
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:514)                                                              
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:472)                                                              
                                     at org.apache.tika.parser.microsoft.rtf.RTFEmbObjHandler.handleCompletedObject(RTFEmbObjHandler.java:217)                                  
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.processGroupEnd(TextExtractor.java:1475)                                             
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:482)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:466)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parseInline(RTFParser.java:96)                                                           
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parse(RTFParser.java:70)                                                                 
                                     at com.example.RTFParserFuzzer.parseOne(RTFParserFuzzer.java:53)                                                                           
                                     at com.example.RTFParserFuzzer.fuzzerTestOneInput(RTFParserFuzzer.java:40)                                                                 
                             DEDUP_TOKEN: aa5f725795b842b8                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Evaluation Report===                                                                                                                            
                                                                                                                                                                                
                             ===Analysis Report===                                                                                                                              
                                                                                                                                                                                
                             ===Evaluation End===                                                                                                                               
[10/08/25 11:06:20] INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.ANALYZE                                                                 __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/08/25 11:07:50] INFO     Prism Supervisor Routing: TeamStatus.ANALYZE -> TeamStatus.PATCH                                                                    __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
[10/08/25 11:09:27] INFO     Prism Supervisor Routing: TeamStatus.PATCH -> TeamStatus.EVALUATE                                                                   __init__.py:160
                             (n evals: 1, patch status: PatchStatus.VULNERABLE)                                                                                                 
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:09:28] INFO     [logging_performance](tika Setting owner) Took 0.92 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:09:29] INFO     [logging_performance](tika Patching) Started...                                                                               context_managers.py:9
                    INFO     Checking valid diff: /tmp/tmprb1hqrl_                                                                                                default.py:173
[10/08/25 11:10:51] INFO     [logging_performance](tika Patching) Took 82.83 seconds; exception=False                                                     context_managers.py:23
                    INFO     [logging_performance](tika Checking build) Started...                                                                         context_managers.py:9
[10/08/25 11:11:23] INFO     [logging_performance](tika Checking build) Took 31.93 seconds; exception=False                                               context_managers.py:23
                    INFO     [logging_performance](tika Running PoV) Started...                                                                            context_managers.py:9
[10/08/25 11:11:32] INFO     [logging_performance](tika Running PoV) Took 8.61 seconds; exception=False                                                   context_managers.py:23
                    INFO     [logging_performance](tika Testing) Started...                                                                                context_managers.py:9
                    INFO     [logging_performance](tika Testing) Took 0.00 seconds; exception=False                                                       context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:11:33] INFO     [logging_performance](tika Setting owner) Took 0.87 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:11:34] INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:11:35] INFO     [logging_performance](tika Setting owner) Took 0.98 seconds; exception=False                                                 context_managers.py:23
                    INFO     [logging_performance](tika Setting owner) Started...                                                                          context_managers.py:9
[10/08/25 11:11:36] INFO     [logging_performance](tika Setting owner) Took 0.92 seconds; exception=False                                                 context_managers.py:23
[10/08/25 11:11:37] INFO     ===Evaluator Result===                                                                                                             evaluator.py:204
                             PatchStatus.SOUND                                                                                                                                  
                             ===Evaluator Diff===                                                                                                                               
                             ---                                                                                                                                                
                             a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/pars                 
                             er/microsoft/rtf/RTFEmbObjHandler.java                                                                                                             
                             +++                                                                                                                                                
                             b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/pars                 
                             er/microsoft/rtf/RTFEmbObjHandler.java                                                                                                             
                             @@ -19,7 +19,10 @@                                                                                                                                 
                              import java.io.IOException;                                                                                                                       
                              import java.io.InputStream;                                                                                                                       
                              import java.io.ObjectInputStream;                                                                                                                 
                             +import java.io.InvalidClassException;                                                                                                             
                             +import java.io.ObjectStreamClass;                                                                                                                 
                              import java.nio.charset.StandardCharsets;                                                                                                         
                             +import java.util.Set;                                                                                                                             
                              import java.util.concurrent.atomic.AtomicInteger;                                                                                                 
                                                                                                                                                                                
                              import org.apache.commons.io.FilenameUtils;                                                                                                       
                             @@ -81,6 +84,28 @@                                                                                                                                 
                                  private Metadata metadata;                                                                                                                    
                                  private EMB_STATE state = EMB_STATE.NADA;                                                                                                     
                                                                                                                                                                                
                             +    /**                                                                                                                                           
                             +     * SafeObjectInputStream restricts deserialization to a whitelist of classes.                                                                 
                             +     */                                                                                                                                           
                             +    private static class SafeObjectInputStream extends ObjectInputStream {                                                                        
                             +        private static final Set<String> ALLOWED_CLASSES = Set.of(                                                                                
                             +            "java.lang.String"                                                                                                                    
                             +        );                                                                                                                                        
                             +                                                                                                                                                  
                             +        protected SafeObjectInputStream(InputStream in) throws IOException {                                                                      
                             +            super(in);                                                                                                                            
                             +        }                                                                                                                                         
                             +                                                                                                                                                  
                             +        @Override                                                                                                                                 
                             +        protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {                                      
                             +            String name = desc.getName();                                                                                                         
                             +            if (!ALLOWED_CLASSES.contains(name)) {                                                                                                
                             +                throw new InvalidClassException("Unauthorized deserialization of " + name);                                                       
                             +            }                                                                                                                                     
                             +            return super.resolveClass(desc);                                                                                                      
                             +        }                                                                                                                                         
                             +    }                                                                                                                                             
                             +                                                                                                                                                  
                                  protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,                                                   
                                                             int memoryLimitInKb) {                                                                                             
                                      this.handler = handler;                                                                                                                   
                             @@ -211,16 +236,17 @@                                                                                                                              
                                          extractObj(bytes, handler, metadata);                                                                                                 
                                                                                                                                                                                
                                      } else if (state == EMB_STATE.JAVA_OBJDATA) {                                                                                             
                             -            try {                                                                                                                                 
                             -                Object obj = new ObjectInputStream(                                                                                               
                             -                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)                                                          
                             -                                .get()).readObject();                                                                                             
                             +            try (SafeObjectInputStream ois = new SafeObjectInputStream(                                                                           
                             +                    UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes).get())) {                                                    
                             +                Object obj = ois.readObject();                                                                                                    
                                              metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());                                                                    
                                              metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,                                                                     
                                                      MediaType.text("plain").toString());                                                                                      
                                              extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);                                                   
                                          } catch (ClassNotFoundException e) {                                                                                                  
                                              throw new TikaException("Not found", e);                                                                                          
                             +            } catch (IOException e) {                                                                                                             
                             +                EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);                                                                  
                                          }                                                                                                                                     
                                      } else if (state == EMB_STATE.NADA) {                                                                                                     
                                          //swallow...no start for pict or embed?!                                                                                              
                                                                                                                                                                                
                             ===Patch Result===                                                                                                                                 
                                                                                                                                                                                
                             ===Issue===                                                                                                                                        
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueHigh: Remote Code Execution                                                 
                             Unrestricted class/object creation based on externally controlled data may allow                                                                   
                             remote code execution depending on available classes on the classpath.                                                                             
                                     at jaz.Zer.reportFinding(Zer.java:110)                                                                                                     
                                     at jaz.Zer.reportFindingIfEnabled(Zer.java:105)                                                                                            
                                     at jaz.Zer.readObject(Zer.java:377)                                                                                                        
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                          
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)                                        
                                     at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                
                                     at java.base/java.lang.reflect.Method.invoke(Method.java:568)                                                                              
                                     at java.base/java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1231)                                                       
                                     at java.base/java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2434)                                                         
                                     at java.base/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2268)                                                     
                                     at java.base/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1744)                                                            
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:514)                                                              
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:472)                                                              
                                     at org.apache.tika.parser.microsoft.rtf.RTFEmbObjHandler.handleCompletedObject(RTFEmbObjHandler.java:217)                                  
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.processGroupEnd(TextExtractor.java:1475)                                             
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:482)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:466)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parseInline(RTFParser.java:96)                                                           
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parse(RTFParser.java:70)                                                                 
                                     at com.example.RTFParserFuzzer.parseOne(RTFParserFuzzer.java:53)                                                                           
                                     at com.example.RTFParserFuzzer.fuzzerTestOneInput(RTFParserFuzzer.java:40)                                                                 
                             DEDUP_TOKEN: aa5f725795b842b8                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             ===Evaluation Report===                                                                                                                            
                             # Evaluation Report                                                                                                                                
                                                                                                                                                                                
                             ## Summary                                                                                                                                         
                                                                                                                                                                                
                             A Jazzer fuzzing run against an RTF parsing component triggered a high-severity security finding (`FuzzerSecurityIssueHigh: Remote                 
                             Code Execution`). The fuzzer detected “Unrestricted class/object creation based on externally controlled data,” indicating that                    
                             malicious RTF input could lead to arbitrary class instantiation and potential remote code execution depending on available classes                 
                             on the classpath.                                                                                                                                  
                                                                                                                                                                                
                             ## Description                                                                                                                                     
                                                                                                                                                                                
                             - Issue Manifestation                                                                                                                              
                               During deserialization of embedded objects in an RTF document, the Jazzer security monitor (`Zer.reportFinding`) raised a                        
                             “Remote Code Execution” alert. The exception originates from `jaz.Zer.readObject`, which delegates to the standard Java                            
                             serialization mechanism (`java.io.ObjectInputStream.readObject`). The parsing flow passes through:                                                 
                                 • `RTFEmbObjHandler.handleCompletedObject`                                                                                                     
                                 • `TextExtractor.processGroupEnd`                                                                                                              
                                 • `TextExtractor.extract`                                                                                                                      
                                 • `RTFParser.parseInline` / `parse`                                                                                                            
                                 • User-supplied harness (`RTFParserFuzzer`)                                                                                                    
                                                                                                                                                                                
                             - Vulnerability Type                                                                                                                               
                               The issue is identified as potential remote code execution via untrusted deserialization or unrestricted class/object creation                   
                             based on externally controlled data.                                                                                                               
                                                                                                                                                                                
                             - Key Observations                                                                                                                                 
                               • The Jazzer monitor flagged the vulnerability at the point where an object is being reconstructed by `ObjectInputStream`.                       
                               • The stack trace shows that deserialization occurs as part of handling embedded OLE/RTF objects (`RTFEmbObjHandler`).                           
                               • The harness (`RTFParserFuzzer`) is the fuzzing entry point and not the root cause; it simply feeds potentially malicious RTF                   
                             data into the parser.                                                                                                                              
                                                                                                                                                                                
                             - Components for Investigation                                                                                                                     
                               To obtain a holistic view of the issue, review the following areas of the codebase:                                                              
                               1. **RTFEmbObjHandler.handleCompletedObject** – logic that invokes `ObjectInputStream.readObject` on embedded data.                              
                               2. **Serialization usage** – any direct calls to `ObjectInputStream` or related serialization APIs in the RTF parser.                            
                               3. **TextExtractor and RTFParser classes** – the flow leading up to object deserialization and how embedded data is extracted                    
                             and passed to the deserializer.                                                                                                                    
                               4. **Classpath review** – classes available at runtime which could be instantiated during deserialization, expanding the attack                  
                             surface.                                                                                                                                           
                                                                                                                                                                                
                             ## Initial Issue Log                                                                                                                               
                             Here is the initial issue log of the codebase:                                                                                                     
                             <issue>                                                                                                                                            
                             == Java Exception: com.code_intelligence.jazzer.api.FuzzerSecurityIssueHigh: Remote Code Execution                                                 
                             Unrestricted class/object creation based on externally controlled data may allow                                                                   
                             remote code execution depending on available classes on the classpath.                                                                             
                                     at jaz.Zer.reportFinding(Zer.java:110)                                                                                                     
                                     at jaz.Zer.reportFindingIfEnabled(Zer.java:105)                                                                                            
                                     at jaz.Zer.readObject(Zer.java:377)                                                                                                        
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                          
                                     at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)                                        
                                     at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                
                                     at java.base/java.lang.reflect.Method.invoke(Method.java:568)                                                                              
                                     at java.base/java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1231)                                                       
                                     at java.base/java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2434)                                                         
                                     at java.base/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2268)                                                     
                                     at java.base/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1744)                                                            
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:514)                                                              
                                     at java.base/java.io.ObjectInputStream.readObject(ObjectInputStream.java:472)                                                              
                                     at org.apache.tika.parser.microsoft.rtf.RTFEmbObjHandler.handleCompletedObject(RTFEmbObjHandler.java:217)                                  
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.processGroupEnd(TextExtractor.java:1475)                                             
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:482)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.TextExtractor.extract(TextExtractor.java:466)                                                      
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parseInline(RTFParser.java:96)                                                           
                                     at org.apache.tika.parser.microsoft.rtf.RTFParser.parse(RTFParser.java:70)                                                                 
                                     at com.example.RTFParserFuzzer.parseOne(RTFParserFuzzer.java:53)                                                                           
                                     at com.example.RTFParserFuzzer.fuzzerTestOneInput(RTFParserFuzzer.java:40)                                                                 
                             DEDUP_TOKEN: aa5f725795b842b8                                                                                                                      
                             == libFuzzer crashing input ==                                                                                                                     
                             </issue>                                                                                                                                           
                             ===Analysis Report===                                                                                                                              
                             # Analysis Report                                                                                                                                  
                                                                                                                                                                                
                             ## Relevant Code Snippets                                                                                                                          
                             <code_snippets>                                                                                                                                    
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFEmbObjHandler.java:1-130                                                                                                         
                             ```                                                                                                                                                
                             1:/*                                                                                                                                               
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                            
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                         
                             4: * this work for additional information regarding copyright ownership.                                                                           
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                       
                             6: * (the "License"); you may not use this file except in compliance with                                                                          
                             7: * the License.  You may obtain a copy of the License at                                                                                         
                             8: *                                                                                                                                               
                             9: * http://www.apache.org/licenses/LICENSE-2.0                                                                                                    
                             10: *                                                                                                                                              
                             11: * Unless required by applicable law or agreed to in writing, software                                                                          
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                            
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                     
                             14: * See the License for the specific language governing permissions and                                                                          
                             15: * limitations under the License.                                                                                                               
                             16: */                                                                                                                                             
                             17:package org.apache.tika.parser.microsoft.rtf;                                                                                                   
                             18:                                                                                                                                                
                             19:import java.io.IOException;                                                                                                                     
                             20:import java.io.InputStream;                                                                                                                     
                             21:import java.io.ObjectInputStream;                                                                                                               
                             22:import java.nio.charset.StandardCharsets;                                                                                                       
                             23:import java.util.concurrent.atomic.AtomicInteger;                                                                                               
                             24:                                                                                                                                                
                             25:import org.apache.commons.io.FilenameUtils;                                                                                                     
                             26:import org.apache.commons.io.IOUtils;                                                                                                           
                             27:import org.apache.commons.io.input.UnsynchronizedByteArrayInputStream;                                                                          
                             28:import org.apache.commons.io.output.UnsynchronizedByteArrayOutputStream;                                                                        
                             29:import org.xml.sax.ContentHandler;                                                                                                              
                             30:import org.xml.sax.SAXException;                                                                                                                
                             31:                                                                                                                                                
                             32:import org.apache.tika.exception.TikaException;                                                                                                 
                             33:import org.apache.tika.exception.TikaMemoryLimitException;                                                                                      
                             34:import org.apache.tika.extractor.EmbeddedDocumentUtil;                                                                                          
                             35:import org.apache.tika.io.TikaInputStream;                                                                                                      
                             36:import org.apache.tika.metadata.Metadata;                                                                                                       
                             37:import org.apache.tika.metadata.RTFMetadata;                                                                                                    
                             38:import org.apache.tika.metadata.TikaCoreProperties;                                                                                             
                             39:import org.apache.tika.mime.MediaType;                                                                                                          
                             40:import org.apache.tika.parser.ParseContext;                                                                                                     
                             41:import org.apache.tika.sax.EmbeddedContentHandler;                                                                                              
                             42:                                                                                                                                                
                             43:/**                                                                                                                                             
                             44: * This class buffers data from embedded objects and pictures.                                                                                  
                             45: * <p/>                                                                                                                                         
                             46: * <p/>                                                                                                                                         
                             47: * <p/>                                                                                                                                         
                             48: * When the parser has finished an object or picture and called                                                                                 
                             49: * {@link #handleCompletedObject()}, this will write the object                                                                                 
                             50: * to the {@link #handler}.                                                                                                                     
                             51: * <p/>                                                                                                                                         
                             52: * <p/>                                                                                                                                         
                             53: * <p/>                                                                                                                                         
                             54: * This (in combination with TextExtractor) expects basically a flat parse.  It will pull out                                                   
                             55: * all pict whether they are tied to objdata or are intended                                                                                    
                             56: * to be standalone.                                                                                                                            
                             57: * <p/>                                                                                                                                         
                             58: * <p/>                                                                                                                                         
                             59: * This tries to pull metadata around a pict that is encoded                                                                                    
                             60: * with {sp {sn} {sv}} types of data.  This information                                                                                         
                             61: * sometimes contains the name and even full file path of the original file.                                                                    
                             62: */                                                                                                                                             
                             63:class RTFEmbObjHandler {                                                                                                                        
                             64:                                                                                                                                                
                             65:    private static final String EMPTY_STRING = "";                                                                                              
                             66:    private final ContentHandler handler;                                                                                                       
                             67:    private final EmbeddedDocumentUtil embeddedDocumentUtil;                                                                                    
                             68:    private final UnsynchronizedByteArrayOutputStream os;                                                                                       
                             69:    private final int memoryLimitInKb;                                                                                                          
                             70:                                                                                                                                                
                             71:    private boolean isPictBitmap = false;                                                                                                       
                             72:    //high hex cached for writing hexpair chars (data)                                                                                          
                             73:    private int hi = -1;                                                                                                                        
                             74:    private int thumbCount = 0;                                                                                                                 
                             75:    //don't need atomic, do need mutable                                                                                                        
                             76:    private AtomicInteger unknownFilenameCount = new AtomicInteger();                                                                           
                             77:    private boolean inObject = false;                                                                                                           
                             78:    private String sv = EMPTY_STRING;                                                                                                           
                             79:    private String sn = EMPTY_STRING;                                                                                                           
                             80:    private StringBuilder sb = new StringBuilder();                                                                                             
                             81:    private Metadata metadata;                                                                                                                  
                             82:    private EMB_STATE state = EMB_STATE.NADA;                                                                                                   
                             83:                                                                                                                                                
                             84:    protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,                                                 
                             85:                               int memoryLimitInKb) {                                                                                           
                             86:        this.handler = handler;                                                                                                                 
                             87:        this.embeddedDocumentUtil = new EmbeddedDocumentUtil(context);                                                                          
                             88:        os = UnsynchronizedByteArrayOutputStream.builder().get();                                                                               
                             89:        this.memoryLimitInKb = memoryLimitInKb;                                                                                                 
                             90:    }                                                                                                                                           
                             91:                                                                                                                                                
                             92:    protected void startPict() {                                                                                                                
                             93:        state = EMB_STATE.PICT;                                                                                                                 
                             94:        metadata = new Metadata();                                                                                                              
                             95:    }                                                                                                                                           
                             96:                                                                                                                                                
                             97:    protected void startObjData() {                                                                                                             
                             98:        state = EMB_STATE.OBJDATA;                                                                                                              
                             99:        metadata = new Metadata();                                                                                                              
                             100:    }                                                                                                                                          
                             101:                                                                                                                                               
                             102:    protected void startJavaObjData() {                                                                                                        
                             103:        state = EMB_STATE.JAVA_OBJDATA;                                                                                                        
                             104:        metadata = new Metadata();                                                                                                             
                             105:    }                                                                                                                                          
                             106:                                                                                                                                               
                             107:    protected void startSN() {                                                                                                                 
                             108:        sb.setLength(0);                                                                                                                       
                             109:        sb.append(RTFMetadata.RTF_PICT_META_PREFIX);                                                                                           
                             110:    }                                                                                                                                          
                             111:                                                                                                                                               
                             112:    protected void endSN() {                                                                                                                   
                             113:        sn = sb.toString();                                                                                                                    
                             114:    }                                                                                                                                          
                             115:                                                                                                                                               
                             116:    protected void startSV() {                                                                                                                 
                             117:        sb.setLength(0);                                                                                                                       
                             118:    }                                                                                                                                          
                             119:                                                                                                                                               
                             120:    protected void endSV() {                                                                                                                   
                             121:        sv = sb.toString();                                                                                                                    
                             122:    }                                                                                                                                          
                             123:                                                                                                                                               
                             124:    //end metadata pair                                                                                                                        
                             125:    protected void endSP() {                                                                                                                   
                             126:        metadata.add(sn, sv);                                                                                                                  
                             127:    }                                                                                                                                          
                             128:                                                                                                                                               
                             129:    protected boolean getInObject() {                                                                                                          
                             130:        return inObject;                                                                                                                       
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFObjDataParser.java:1-200                                                                                                         
                             ```                                                                                                                                                
                             1:/*                                                                                                                                               
                             2: * Licensed to the Apache Software Foundation (ASF) under one or more                                                                            
                             3: * contributor license agreements.  See the NOTICE file distributed with                                                                         
                             4: * this work for additional information regarding copyright ownership.                                                                           
                             5: * The ASF licenses this file to You under the Apache License, Version 2.0                                                                       
                             6: * (the "License"); you may not use this file except in compliance with                                                                          
                             7: * the License.  You may obtain a copy of the License at                                                                                         
                             8: *                                                                                                                                               
                             9: * http://www.apache.org/licenses/LICENSE-2.0                                                                                                    
                             10: *                                                                                                                                              
                             11: * Unless required by applicable law or agreed to in writing, software                                                                          
                             12: * distributed under the License is distributed on an "AS IS" BASIS,                                                                            
                             13: * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.                                                                     
                             14: * See the License for the specific language governing permissions and                                                                          
                             15: * limitations under the License.                                                                                                               
                             16: */                                                                                                                                             
                             17:                                                                                                                                                
                             18:                                                                                                                                                
                             19:package org.apache.tika.parser.microsoft.rtf;                                                                                                   
                             20:                                                                                                                                                
                             21:import java.io.FileNotFoundException;                                                                                                           
                             22:import java.io.IOException;                                                                                                                     
                             23:import java.io.InputStream;                                                                                                                     
                             24:import java.io.UnsupportedEncodingException;                                                                                                    
                             25:import java.util.Locale;                                                                                                                        
                             26:import java.util.concurrent.atomic.AtomicInteger;                                                                                               
                             27:                                                                                                                                                
                             28:import org.apache.commons.io.FilenameUtils;                                                                                                     
                             29:import org.apache.commons.io.IOUtils;                                                                                                           
                             30:import org.apache.commons.io.input.UnsynchronizedByteArrayInputStream;                                                                          
                             31:import org.apache.commons.io.output.UnsynchronizedByteArrayOutputStream;                                                                        
                             32:import org.apache.poi.poifs.filesystem.DirectoryNode;                                                                                           
                             33:import org.apache.poi.poifs.filesystem.DocumentEntry;                                                                                           
                             34:import org.apache.poi.poifs.filesystem.DocumentInputStream;                                                                                     
                             35:import org.apache.poi.poifs.filesystem.Entry;                                                                                                   
                             36:import org.apache.poi.poifs.filesystem.FileMagic;                                                                                               
                             37:import org.apache.poi.poifs.filesystem.Ole10Native;                                                                                             
                             38:import org.apache.poi.poifs.filesystem.Ole10NativeException;                                                                                    
                             39:import org.apache.poi.poifs.filesystem.POIFSFileSystem;                                                                                         
                             40:                                                                                                                                                
                             41:import org.apache.tika.exception.TikaException;                                                                                                 
                             42:import org.apache.tika.exception.TikaMemoryLimitException;                                                                                      
                             43:import org.apache.tika.extractor.EmbeddedDocumentUtil;                                                                                          
                             44:import org.apache.tika.io.BoundedInputStream;                                                                                                   
                             45:import org.apache.tika.io.EndianUtils;                                                                                                          
                             46:import org.apache.tika.metadata.Metadata;                                                                                                       
                             47:import org.apache.tika.metadata.RTFMetadata;                                                                                                    
                             48:import org.apache.tika.metadata.TikaCoreProperties;                                                                                             
                             49:import org.apache.tika.parser.microsoft.OfficeParser.POIFSDocumentType;                                                                         
                             50:                                                                                                                                                
                             51:/**                                                                                                                                             
                             52: * Many thanks to Simon Mourier for:                                                                                                            
                             53: * http://stackoverflow.com/questions/14779647/extract-embedded-image-object-in-rtf                                                             
                             54: * and for granting permission to use his code in Tika.                                                                                         
                             55: */                                                                                                                                             
                             56:class RTFObjDataParser {                                                                                                                        
                             57:                                                                                                                                                
                             58:    private final static String WIN_ASCII = "WINDOWS-1252";                                                                                     
                             59:    private final int memoryLimitInKb;                                                                                                          
                             60:                                                                                                                                                
                             61:    RTFObjDataParser(int memoryLimitInKb) {                                                                                                     
                             62:        this.memoryLimitInKb = memoryLimitInKb;                                                                                                 
                             63:    }                                                                                                                                           
                             64:                                                                                                                                                
                             65:    /**                                                                                                                                         
                             66:     * Parses the embedded object/pict string                                                                                                   
                             67:     *                                                                                                                                          
                             68:     * @param is actual bytes (already converted from the                                                                                       
                             69:     *              hex pair string stored in the embedded object data into actual bytes or read                                                
                             70:     *              as raw binary bytes)                                                                                                        
                             71:     * @return a SimpleRTFEmbObj or null                                                                                                        
                             72:     * @throws IOException if there are any surprise surprises during parsing                                                                   
                             73:     */                                                                                                                                         
                             74:                                                                                                                                                
                             75:    private static boolean hasPOIFSHeader(InputStream is) throws IOException {                                                                  
                             76:        return FileMagic.valueOf(is) == FileMagic.OLE2;                                                                                         
                             77:    }                                                                                                                                           
                             78:                                                                                                                                                
                             79:    /**                                                                                                                                         
                             80:     * @param bytes                                                                                                                             
                             81:     * @param metadata             incoming metadata                                                                                            
                             82:     * @param unknownFilenameCount                                                                                                              
                             83:     * @return byte[] for contents of obj data                                                                                                  
                             84:     * @throws IOException                                                                                                                      
                             85:     */                                                                                                                                         
                             86:    protected byte[] parse(byte[] bytes, Metadata metadata, AtomicInteger unknownFilenameCount)                                                 
                             87:            throws IOException, TikaException {                                                                                                 
                             88:        UnsynchronizedByteArrayInputStream is = UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes).get();                         
                             89:        long version = readUInt(is);                                                                                                            
                             90:        metadata.add(RTFMetadata.EMB_APP_VERSION, Long.toString(version));                                                                      
                             91:                                                                                                                                                
                             92:        long formatId = readUInt(is);                                                                                                           
                             93:        //2 is an embedded object. 1 is a link.                                                                                                 
                             94:        if (formatId != 2L) {                                                                                                                   
                             95:            return null;                                                                                                                        
                             96:        }                                                                                                                                       
                             97:        String className = readLengthPrefixedAnsiString(is).trim();                                                                             
                             98:        String topicName = readLengthPrefixedAnsiString(is).trim();                                                                             
                             99:        String itemName = readLengthPrefixedAnsiString(is).trim();                                                                              
                             100:                                                                                                                                               
                             101:        if (className.length() > 0) {                                                                                                          
                             102:            metadata.add(RTFMetadata.EMB_CLASS, className);                                                                                    
                             103:        }                                                                                                                                      
                             104:        if (topicName.length() > 0) {                                                                                                          
                             105:            metadata.add(RTFMetadata.EMB_TOPIC, topicName);                                                                                    
                             106:        }                                                                                                                                      
                             107:        if (itemName.length() > 0) {                                                                                                           
                             108:            metadata.add(RTFMetadata.EMB_ITEM, itemName);                                                                                      
                             109:        }                                                                                                                                      
                             110:                                                                                                                                               
                             111:        long dataSz = readUInt(is);                                                                                                            
                             112:                                                                                                                                               
                             113:        //readBytes tests for reading too many bytes                                                                                           
                             114:        byte[] embObjBytes = readBytes(is, dataSz);                                                                                            
                             115:                                                                                                                                               
                             116:        if (className.toLowerCase(Locale.ROOT).equals("package")) {                                                                            
                             117:            return handlePackage(embObjBytes, metadata);                                                                                       
                             118:        } else if (className.toLowerCase(Locale.ROOT).equals("pbrush")) {                                                                      
                             119:            //simple bitmap bytes                                                                                                              
                             120:            return embObjBytes;                                                                                                                
                             121:        } else {                                                                                                                               
                             122:            UnsynchronizedByteArrayInputStream embIs =                                                                                         
                             UnsynchronizedByteArrayInputStream.builder().setByteArray(embObjBytes).get();                                                                      
                             123:            boolean hasPoifs;                                                                                                                  
                             124:            try {                                                                                                                              
                             125:                hasPoifs = hasPOIFSHeader(embIs);                                                                                              
                             126:            } catch (IOException e) {                                                                                                          
                             127:                EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);                                                               
                             128:                return embObjBytes;                                                                                                            
                             129:            }                                                                                                                                  
                             130:            if (hasPoifs) {                                                                                                                    
                             131:                try {                                                                                                                          
                             132:                    return handleEmbeddedPOIFS(embIs, metadata, unknownFilenameCount);                                                         
                             133:                } catch (Exception e) {                                                                                                        
                             134:                    EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);                                                           
                             135:                }                                                                                                                              
                             136:            }                                                                                                                                  
                             137:        }                                                                                                                                      
                             138:        return embObjBytes;                                                                                                                    
                             139:    }                                                                                                                                          
                             140:                                                                                                                                               
                             141:    //will throw IOException if not actually POIFS                                                                                             
                             142:    //can return null byte[]                                                                                                                   
                             143:    private byte[] handleEmbeddedPOIFS(InputStream is, Metadata metadata,                                                                      
                             144:                                       AtomicInteger unknownFilenameCount)                                                                     
                             145:            throws TikaException, IOException {                                                                                                
                             146:                                                                                                                                               
                             147:        byte[] ret = null;                                                                                                                     
                             148:        try (POIFSFileSystem fs = new POIFSFileSystem(is)) {                                                                                   
                             149:                                                                                                                                               
                             150:            DirectoryNode root = fs.getRoot();                                                                                                 
                             151:                                                                                                                                               
                             152:            if (root == null) {                                                                                                                
                             153:                return ret;                                                                                                                    
                             154:            }                                                                                                                                  
                             155:                                                                                                                                               
                             156:            if (root.hasEntry("Package")) {                                                                                                    
                             157:                Entry ooxml = root.getEntry("Package");                                                                                        
                             158:                UnsynchronizedByteArrayOutputStream out = UnsynchronizedByteArrayOutputStream.builder().get();                                 
                             159:                try (BoundedInputStream bis = new BoundedInputStream(memoryLimitInKb * 1024,                                                   
                             160:                        new DocumentInputStream((DocumentEntry) ooxml))) {                                                                     
                             161:                    IOUtils.copy(bis, out);                                                                                                    
                             162:                    if (bis.hasHitBound()) {                                                                                                   
                             163:                        throw new TikaMemoryLimitException((memoryLimitInKb * 1024 + 1),                                                       
                             164:                                (memoryLimitInKb * 1024));                                                                                     
                             165:                    }                                                                                                                          
                             166:                }                                                                                                                              
                             167:                ret = out.toByteArray();                                                                                                       
                             168:            } else {                                                                                                                           
                             169:                //try poifs                                                                                                                    
                             170:                POIFSDocumentType type = POIFSDocumentType.detectType(root);                                                                   
                             171:                if (type == POIFSDocumentType.OLE10_NATIVE) {                                                                                  
                             172:                    try {                                                                                                                      
                             173:                        // Try to un-wrap the OLE10Native record:                                                                              
                             174:                        Ole10Native ole = Ole10Native.createFromEmbeddedOleObject(root);                                                       
                             175:                        ret = ole.getDataBuffer();                                                                                             
                             176:                    } catch (Ole10NativeException ex) {                                                                                        
                             177:                        // Not a valid OLE10Native record, skip it                                                                             
                             178:                    }                                                                                                                          
                             179:                } else if (type == POIFSDocumentType.COMP_OBJ) {                                                                               
                             180:                                                                                                                                               
                             181:                    DocumentEntry contentsEntry;                                                                                               
                             182:                    try {                                                                                                                      
                             183:                        contentsEntry = (DocumentEntry) root.getEntry("CONTENTS");                                                             
                             184:                    } catch (FileNotFoundException ioe) {                                                                                      
                             185:                        contentsEntry = (DocumentEntry) root.getEntry("Contents");                                                             
                             186:                    }                                                                                                                          
                             187:                                                                                                                                               
                             188:                    try (DocumentInputStream inp = new DocumentInputStream(contentsEntry)) {                                                   
                             189:                        ret = new byte[contentsEntry.getSize()];                                                                               
                             190:                        inp.readFully(ret);                                                                                                    
                             191:                    }                                                                                                                          
                             192:                } else {                                                                                                                       
                             193:                                                                                                                                               
                             194:                    UnsynchronizedByteArrayOutputStream out = UnsynchronizedByteArrayOutputStream.builder().get();                             
                             195:                    is.reset();                                                                                                                
                             196:                    BoundedInputStream bis = new BoundedInputStream(memoryLimitInKb * 1024, is);                                               
                             197:                    IOUtils.copy(is, out);                                                                                                     
                             198:                    if (bis.hasHitBound()) {                                                                                                   
                             199:                        throw new TikaMemoryLimitException(memoryLimitInKb * 1024 + 1,                                                         
                             200:                                memoryLimitInKb * 1024);                                                                                       
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFEmbObjHandler.java:80-105                                                                                                        
                             ```                                                                                                                                                
                             80:    private StringBuilder sb = new StringBuilder();                                                                                             
                             81:    private Metadata metadata;                                                                                                                  
                             82:    private EMB_STATE state = EMB_STATE.NADA;                                                                                                   
                             83:                                                                                                                                                
                             84:    protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,                                                 
                             85:                               int memoryLimitInKb) {                                                                                           
                             86:        this.handler = handler;                                                                                                                 
                             87:        this.embeddedDocumentUtil = new EmbeddedDocumentUtil(context);                                                                          
                             88:        os = UnsynchronizedByteArrayOutputStream.builder().get();                                                                               
                             89:        this.memoryLimitInKb = memoryLimitInKb;                                                                                                 
                             90:    }                                                                                                                                           
                             91:                                                                                                                                                
                             92:    protected void startPict() {                                                                                                                
                             93:        state = EMB_STATE.PICT;                                                                                                                 
                             94:        metadata = new Metadata();                                                                                                              
                             95:    }                                                                                                                                           
                             96:                                                                                                                                                
                             97:    protected void startObjData() {                                                                                                             
                             98:        state = EMB_STATE.OBJDATA;                                                                                                              
                             99:        metadata = new Metadata();                                                                                                              
                             100:    }                                                                                                                                          
                             101:                                                                                                                                               
                             102:    protected void startJavaObjData() {                                                                                                        
                             103:        state = EMB_STATE.JAVA_OBJDATA;                                                                                                        
                             104:        metadata = new Metadata();                                                                                                             
                             105:    }                                                                                                                                          
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFObjDataParser.java:60-140                                                                                                        
                             ```                                                                                                                                                
                             60:                                                                                                                                                
                             61:    RTFObjDataParser(int memoryLimitInKb) {                                                                                                     
                             62:        this.memoryLimitInKb = memoryLimitInKb;                                                                                                 
                             63:    }                                                                                                                                           
                             64:                                                                                                                                                
                             65:    /**                                                                                                                                         
                             66:     * Parses the embedded object/pict string                                                                                                   
                             67:     *                                                                                                                                          
                             68:     * @param is actual bytes (already converted from the                                                                                       
                             69:     *              hex pair string stored in the embedded object data into actual bytes or read                                                
                             70:     *              as raw binary bytes)                                                                                                        
                             71:     * @return a SimpleRTFEmbObj or null                                                                                                        
                             72:     * @throws IOException if there are any surprise surprises during parsing                                                                   
                             73:     */                                                                                                                                         
                             74:                                                                                                                                                
                             75:    private static boolean hasPOIFSHeader(InputStream is) throws IOException {                                                                  
                             76:        return FileMagic.valueOf(is) == FileMagic.OLE2;                                                                                         
                             77:    }                                                                                                                                           
                             78:                                                                                                                                                
                             79:    /**                                                                                                                                         
                             80:     * @param bytes                                                                                                                             
                             81:     * @param metadata             incoming metadata                                                                                            
                             82:     * @param unknownFilenameCount                                                                                                              
                             83:     * @return byte[] for contents of obj data                                                                                                  
                             84:     * @throws IOException                                                                                                                      
                             85:     */                                                                                                                                         
                             86:    protected byte[] parse(byte[] bytes, Metadata metadata, AtomicInteger unknownFilenameCount)                                                 
                             87:            throws IOException, TikaException {                                                                                                 
                             88:        UnsynchronizedByteArrayInputStream is = UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes).get();                         
                             89:        long version = readUInt(is);                                                                                                            
                             90:        metadata.add(RTFMetadata.EMB_APP_VERSION, Long.toString(version));                                                                      
                             91:                                                                                                                                                
                             92:        long formatId = readUInt(is);                                                                                                           
                             93:        //2 is an embedded object. 1 is a link.                                                                                                 
                             94:        if (formatId != 2L) {                                                                                                                   
                             95:            return null;                                                                                                                        
                             96:        }                                                                                                                                       
                             97:        String className = readLengthPrefixedAnsiString(is).trim();                                                                             
                             98:        String topicName = readLengthPrefixedAnsiString(is).trim();                                                                             
                             99:        String itemName = readLengthPrefixedAnsiString(is).trim();                                                                              
                             100:                                                                                                                                               
                             101:        if (className.length() > 0) {                                                                                                          
                             102:            metadata.add(RTFMetadata.EMB_CLASS, className);                                                                                    
                             103:        }                                                                                                                                      
                             104:        if (topicName.length() > 0) {                                                                                                          
                             105:            metadata.add(RTFMetadata.EMB_TOPIC, topicName);                                                                                    
                             106:        }                                                                                                                                      
                             107:        if (itemName.length() > 0) {                                                                                                           
                             108:            metadata.add(RTFMetadata.EMB_ITEM, itemName);                                                                                      
                             109:        }                                                                                                                                      
                             110:                                                                                                                                               
                             111:        long dataSz = readUInt(is);                                                                                                            
                             112:                                                                                                                                               
                             113:        //readBytes tests for reading too many bytes                                                                                           
                             114:        byte[] embObjBytes = readBytes(is, dataSz);                                                                                            
                             115:                                                                                                                                               
                             116:        if (className.toLowerCase(Locale.ROOT).equals("package")) {                                                                            
                             117:            return handlePackage(embObjBytes, metadata);                                                                                       
                             118:        } else if (className.toLowerCase(Locale.ROOT).equals("pbrush")) {                                                                      
                             119:            //simple bitmap bytes                                                                                                              
                             120:            return embObjBytes;                                                                                                                
                             121:        } else {                                                                                                                               
                             122:            UnsynchronizedByteArrayInputStream embIs =                                                                                         
                             UnsynchronizedByteArrayInputStream.builder().setByteArray(embObjBytes).get();                                                                      
                             123:            boolean hasPoifs;                                                                                                                  
                             124:            try {                                                                                                                              
                             125:                hasPoifs = hasPOIFSHeader(embIs);                                                                                              
                             126:            } catch (IOException e) {                                                                                                          
                             127:                EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);                                                               
                             128:                return embObjBytes;                                                                                                            
                             129:            }                                                                                                                                  
                             130:            if (hasPoifs) {                                                                                                                    
                             131:                try {                                                                                                                          
                             132:                    return handleEmbeddedPOIFS(embIs, metadata, unknownFilenameCount);                                                         
                             133:                } catch (Exception e) {                                                                                                        
                             134:                    EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);                                                           
                             135:                }                                                                                                                              
                             136:            }                                                                                                                                  
                             137:        }                                                                                                                                      
                             138:        return embObjBytes;                                                                                                                    
                             139:    }                                                                                                                                          
                             140:                                                                                                                                               
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/TextExtractor.java:1440-1500                                                                                                        
                             ```                                                                                                                                                
                             1440:        }                                                                                                                                     
                             1441:        in.unread(b2);                                                                                                                        
                             1442:    }                                                                                                                                         
                             1443:                                                                                                                                              
                             1444:    // Pop current GroupState                                                                                                                 
                             1445:    private void processGroupEnd() throws IOException, SAXException, TikaException {                                                          
                             1446:        if (inHeader) {                                                                                                                       
                             1447:            if (nextMetaData != null) {                                                                                                       
                             1448:                if (nextMetaData == TikaCoreProperties.CREATED) {                                                                             
                             1449:                    Calendar cal = Calendar.getInstance(TimeZone.getDefault(), Locale.ROOT);                                                  
                             1450:                    cal.set(year, month - 1, day, hour, minute, 0);                                                                           
                             1451:                    metadata.set(nextMetaData, cal.getTime());                                                                                
                             1452:                } else if (nextMetaData.isMultiValuePermitted()) {                                                                            
                             1453:                    metadata.add(nextMetaData, pendingBuffer.toString());                                                                     
                             1454:                } else {                                                                                                                      
                             1455:                    metadata.set(nextMetaData, pendingBuffer.toString());                                                                     
                             1456:                }                                                                                                                             
                             1457:                nextMetaData = null;                                                                                                          
                             1458:            }                                                                                                                                 
                             1459:            pendingBuffer.setLength(0);                                                                                                       
                             1460:        }                                                                                                                                     
                             1461:                                                                                                                                              
                             1462:        assert groupState.depth > 0;                                                                                                          
                             1463:        ansiSkip = 0;                                                                                                                         
                             1464:                                                                                                                                              
                             1465:        if (groupState.objdata == true) {                                                                                                     
                             1466:            try {                                                                                                                             
                             1467:                embObjHandler.handleCompletedObject();                                                                                        
                             1468:            } catch (TikaException | IOException e) {                                                                                         
                             1469:                EmbeddedDocumentUtil.recordException(e, metadata);                                                                            
                             1470:            }                                                                                                                                 
                             1471:            groupState.objdata = false;                                                                                                       
                             1472:                                                                                                                                              
                             1473:        } else if (groupState.javaobjdata == true) {                                                                                          
                             1474:            try {                                                                                                                             
                             1475:                embObjHandler.handleCompletedObject();                                                                                        
                             1476:            } catch (TikaException | IOException e) {                                                                                         
                             1477:                EmbeddedDocumentUtil.recordException(e, metadata);                                                                            
                             1478:            }                                                                                                                                 
                             1479:            groupState.javaobjdata = false;                                                                                                   
                             1480:        } else if (groupState.pictDepth > 0) {                                                                                                
                             1481:            if (groupState.sn == true) {                                                                                                      
                             1482:                embObjHandler.endSN();                                                                                                        
                             1483:            } else if (groupState.sv == true) {                                                                                               
                             1484:                embObjHandler.endSV();                                                                                                        
                             1485:            } else if (groupState.sp == true) {                                                                                               
                             1486:                embObjHandler.endSP();                                                                                                        
                             1487:            } else if (groupState.pictDepth == 1) {                                                                                           
                             1488:                embObjHandler.handleCompletedObject();                                                                                        
                             1489:            }                                                                                                                                 
                             1490:        }                                                                                                                                     
                             1491:        if (groupState.annotation == true) {                                                                                                  
                             1492:            addOutputChar(SPACE);                                                                                                             
                             1493:        }                                                                                                                                     
                             1494:        if (groupState.object == true) {                                                                                                      
                             1495:            embObjHandler.setInObject(false);                                                                                                 
                             1496:        }                                                                                                                                     
                             1497:                                                                                                                                              
                             1498:        // Be robust if RTF doc is corrupt (has too many                                                                                      
                             1499:        // closing }s):                                                                                                                       
                             1500:        // TODO: log a warning?                                                                                                               
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/TextExtractor.java:1462-1473                                                                                                        
                             ```                                                                                                                                                
                             1462:        assert groupState.depth > 0;                                                                                                          
                             1463:        ansiSkip = 0;                                                                                                                         
                             1464:                                                                                                                                              
                             1465:        if (groupState.objdata == true) {                                                                                                     
                             1466:            try {                                                                                                                             
                             1467:                embObjHandler.handleCompletedObject();                                                                                        
                             1468:            } catch (TikaException | IOException e) {                                                                                         
                             1469:                EmbeddedDocumentUtil.recordException(e, metadata);                                                                            
                             1470:            }                                                                                                                                 
                             1471:            groupState.objdata = false;                                                                                                       
                             1472:                                                                                                                                              
                             1473:        } else if (groupState.javaobjdata == true) {                                                                                          
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFEmbObjHandler.java:213-221                                                                                                       
                             ```                                                                                                                                                
                             213:        } else if (state == EMB_STATE.JAVA_OBJDATA) {                                                                                          
                             214:            try {                                                                                                                              
                             215:                Object obj = new ObjectInputStream(                                                                                            
                             216:                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)                                                       
                             217:                                .get()).readObject();                                                                                          
                             218:                metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());                                                                 
                             219:                metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,                                                                  
                             220:                        MediaType.text("plain").toString());                                                                                   
                             221:                extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);                                                
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             <code>                                                                                                                                             
                             tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser                 
                             /microsoft/rtf/RTFEmbObjHandler.java:205-225                                                                                                       
                             ```                                                                                                                                                
                             205:            }                                                                                                                                  
                             206:            metadata.set(RTFMetadata.THUMBNAIL, Boolean.toString(inObject));                                                                   
                             207:            if (isPictBitmap) {                                                                                                                
                             208:                metadata.set(                                                                                                                  
                             209:                        TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE, "image/x-rtf-raw-bitmap");                                            
                             210:            }                                                                                                                                  
                             211:            extractObj(bytes, handler, metadata);                                                                                              
                             212:                                                                                                                                               
                             213:        } else if (state == EMB_STATE.JAVA_OBJDATA) {                                                                                          
                             214:            try {                                                                                                                              
                             215:                Object obj = new ObjectInputStream(                                                                                            
                             216:                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)                                                       
                             217:                                .get()).readObject();                                                                                          
                             218:                metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());                                                                 
                             219:                metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,                                                                  
                             220:                        MediaType.text("plain").toString());                                                                                   
                             221:                extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);                                                
                             222:            } catch (ClassNotFoundException e) {                                                                                               
                             223:                throw new TikaException("Not found", e);                                                                                       
                             224:            }                                                                                                                                  
                             225:        } else if (state == EMB_STATE.NADA) {                                                                                                  
                             ```                                                                                                                                                
                             </code>                                                                                                                                            
                             </code_snippets>                                                                                                                                   
                                                                                                                                                                                
                             ## Fix Strategy                                                                                                                                    
                             <fix_strategy>                                                                                                                                     
                                                                                                                                                                                
                             1. Issue Analysis and Root Cause                                                                                                                   
                                From the evaluation report and code snippets, the critical vulnerability lies in RTFEmbObjHandler.handleCompletedObject()                       
                             (lines 213–221). When the parser enters the JAVA_OBJDATA state, it blindly calls:                                                                  
                                  Object obj = new ObjectInputStream(...).readObject();                                                                                         
                                This allows an attacker to craft a serialized Java payload that instantiates arbitrary classes (and executes their code) during                 
                             deserialization, leading to remote code execution.                                                                                                 
                                                                                                                                                                                
                             2. Critical Logic to Preserve                                                                                                                      
                                • The handler must still recognize and process embedded Java-object data.                                                                       
                                • The metadata-setting and extractObj(...) call (to turn the deserialized object’s toString() into handler output) should                       
                             remain, where safe.                                                                                                                                
                                • The existing memory-limit checks, exception recording, and overall RTF parsing flow must be untouched.                                        
                                                                                                                                                                                
                             3. Proposed Secure Deserialization Approach                                                                                                        
                                A. Introduce a restricted ObjectInputStream subclass (e.g., SafeObjectInputStream) in the RTF module that enforces a strict                     
                             whitelist of permitted classes (at minimum `java.lang.String`, and any other intentionally supported types).                                       
                                   • Override `resolveClass(ObjectStreamClass desc)` to allow only classes in the whitelist; for others, immediately throw                      
                             `InvalidClassException`.                                                                                                                           
                                   • Reuse existing engine code (java.io.ObjectStreamClass) for legitimate classes once validated.                                              
                                B. In handleCompletedObject()’s JAVA_OBJDATA branch, replace the call to `new ObjectInputStream(...).readObject()` with `new                    
                             SafeObjectInputStream(...).readObject()`.                                                                                                          
                                   • Wrap the instantiation in a try-with-resources block to ensure the stream is closed.                                                       
                                C. (Optional) For Java 9+ runtimes, additionally configure an `ObjectInputFilter` on SafeObjectInputStream to enforce the same                  
                             whitelist at the native filter layer.                                                                                                              
                                                                                                                                                                                
                             4. Step-by-Step Patch Plan                                                                                                                         
                                1. Define SafeObjectInputStream:                                                                                                                
                                   • Place under `org.apache.tika.parser.microsoft.rtf` (e.g., `SafeObjectInputStream.java`).                                                   
                                   • Whitelist entries: “java.lang.String” (and any other minimal set).                                                                         
                                   • Override `resolveClass` to check `desc.getName()` against the whitelist, throwing `InvalidClassException` if not allowed.                  
                                2. Modify `RTFEmbObjHandler.handleCompletedObject()` in the JAVA_OBJDATA block:                                                                 
                                   • Change                                                                                                                                     
                                        `Object obj = new ObjectInputStream(...).readObject();`                                                                                 
                                      to                                                                                                                                        
                                        `try (SafeObjectInputStream ois = new SafeObjectInputStream(...)) {                                                                     
                                             Object obj = ois.readObject();                                                                                                     
                                             …                                                                                                                                  
                                        }`                                                                                                                                      
                                   • Preserve metadata updates and `extractObj(...)`.                                                                                           
                                3. Add unit tests in the RTF parser module:                                                                                                     
                                   • A benign serialized String should still deserialize and produce the expected text.                                                         
                                   • A malicious payload targeting non-whitelisted classes (e.g., `javax.naming.InitialContext`) should trigger                                 
                             `InvalidClassException` and be caught by the existing exception recording, without invoking `Zer.reportFinding`.                                   
                                4. Update module documentation (CHANGELOG) to note that Java deserialization is now restricted by default.                                      
                                                                                                                                                                                
                             5. Justification and Benefits                                                                                                                      
                                – By introducing a whitelist, we eliminate the risk of instantiating arbitrary classes, blocking RCE gadgets.                                   
                                – Existing tests and harness code remain unchanged. We do not modify any fuzzing harness, external libraries, or utility                        
                             functions outside of the RTF module.                                                                                                               
                                – Clients who genuinely rely on embedding Java objects can request whitelisting additional classes, but the default remains                     
                             secure.                                                                                                                                            
                                – The approach uses a narrowly scoped change (one new class and one updated method) and preserves the RTF parsing pipeline,                     
                             memory limits, and embedded-object extraction logic.                                                                                               
                                                                                                                                                                                
                             6. Side-Effects and Mitigation                                                                                                                     
                                • Legitimate RTFs with custom serialized objects of non-String types will now be rejected. To mitigate, clients can supply an                   
                             explicit whitelist via ParseContext or configuration.                                                                                              
                                • Performance overhead of class-name checking is negligible compared to IO and parsing cost.                                                    
                                • No external dependencies or harness code changes—fuzzing behavior is fully supported as before.                                               
                                                                                                                                                                                
                             7. Reference to Similar Patterns                                                                                                                   
                                – Apache POI’s `ValidatingObjectInputStream` in other modules uses the same override-resolveClass pattern.                                      
                                – Tika’s own use of `EmbeddedDocumentUtil.recordEmbeddedStreamException` ensures safe recording of any `InvalidClassException`                  
                             thrown during deserialization.                                                                                                                     
                                                                                                                                                                                
                             File Ranges for Patch Context:                                                                                                                     
                             <code_range>.../RTFEmbObjHandler.java:205-225</code_range>                                                                                         
                             <code_range>.../SafeObjectInputStream.java:1-100</code_range>                                                                                      
                                                                                                                                                                                
                             </fix_strategy>                                                                                                                                    
                             ===Tests Result===                                                                                                                                 
                             No tests found                                                                                                                                     
                             ===Evaluation End===                                                                                                                               
                    INFO     Prism Supervisor Routing: TeamStatus.EVALUATE -> TeamStatus.END                                                                     __init__.py:160
                             (n evals: 2, patch status: PatchStatus.SOUND)                                                                                                      
                    INFO     Building environment                                                                                                                __init__.py:132
                             - Cache directory: /tmp/tmp0s_07v71                                                                                                                
                             - Max timeout: 1800                                                                                                                                
                             - Output directory: reports/prism.prism_o4_mini/tika-tk-full-01-vuln_1/agent-output-1759921897.4740124                                             
                             - Detection toml file: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/detection/tika-tk-full-01-vuln_1.toml                                           
                             - Challenge project directory: /tasks/9e83d8ad-2b84-413b-b4e0-880916279678/official-afc-tika                                                       
                                                                                                                                                                                
