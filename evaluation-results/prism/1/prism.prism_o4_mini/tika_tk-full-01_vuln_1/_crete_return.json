{
  "project_name": "tika",
  "vulnerability_identifier": "tika-tk-full-01-vuln_1",
  "source_directory": "/tasks/9e83d8ad-2b84-413b-b4e0-880916279678/official-afc-tika",
  "llm_usage": {
    "total_cost": 0.14691490000000001,
    "prompt_tokens": 72855,
    "completion_tokens": 15176
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n@@ -19,7 +19,10 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.io.ObjectInputStream;\n+import java.io.InvalidClassException;\n+import java.io.ObjectStreamClass;\n import java.nio.charset.StandardCharsets;\n+import java.util.Set;\n import java.util.concurrent.atomic.AtomicInteger;\n \n import org.apache.commons.io.FilenameUtils;\n@@ -81,6 +84,28 @@\n     private Metadata metadata;\n     private EMB_STATE state = EMB_STATE.NADA;\n \n+    /**\n+     * SafeObjectInputStream restricts deserialization to a whitelist of classes.\n+     */\n+    private static class SafeObjectInputStream extends ObjectInputStream {\n+        private static final Set<String> ALLOWED_CLASSES = Set.of(\n+            \"java.lang.String\"\n+        );\n+\n+        protected SafeObjectInputStream(InputStream in) throws IOException {\n+            super(in);\n+        }\n+\n+        @Override\n+        protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {\n+            String name = desc.getName();\n+            if (!ALLOWED_CLASSES.contains(name)) {\n+                throw new InvalidClassException(\"Unauthorized deserialization of \" + name);\n+            }\n+            return super.resolveClass(desc);\n+        }\n+    }\n+\n     protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,\n                                int memoryLimitInKb) {\n         this.handler = handler;\n@@ -211,16 +236,17 @@\n             extractObj(bytes, handler, metadata);\n \n         } else if (state == EMB_STATE.JAVA_OBJDATA) {\n-            try {\n-                Object obj = new ObjectInputStream(\n-                        UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n-                                .get()).readObject();\n+            try (SafeObjectInputStream ois = new SafeObjectInputStream(\n+                    UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes).get())) {\n+                Object obj = ois.readObject();\n                 metadata.set(RTFMetadata.EMB_CLASS, obj.getClass().getName());\n                 metadata.set(TikaCoreProperties.CONTENT_TYPE_PARSER_OVERRIDE,\n                         MediaType.text(\"plain\").toString());\n                 extractObj(obj.toString().getBytes(StandardCharsets.UTF_8), handler, metadata);\n             } catch (ClassNotFoundException e) {\n                 throw new TikaException(\"Not found\", e);\n+            } catch (IOException e) {\n+                EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);\n             }\n         } else if (state == EMB_STATE.NADA) {\n             //swallow...no start for pict or embed?!\n",
  "stdout": "",
  "stderr": ""
}