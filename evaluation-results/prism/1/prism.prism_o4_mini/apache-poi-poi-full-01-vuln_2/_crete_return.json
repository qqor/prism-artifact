{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi-poi-full-01-vuln_2",
  "source_directory": "/tasks/9f4f673a-9570-46d1-bfb2-cafe4625487b/official-afc-poi",
  "llm_usage": {
    "total_cost": 0.36622630000000006,
    "prompt_tokens": 180953,
    "completion_tokens": 37995
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -22,6 +22,7 @@\n import java.io.OutputStream;\n import java.nio.ByteBuffer;\n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n \n@@ -72,11 +73,23 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                String rawRootName = root.getName();\n+                String safeRootName = rawRootName == null ? \"_\" :\n+                        rawRootName.replaceAll(\"[/\\\\\\\\]+\", \"_\")\n+                                   .replaceAll(\"\\\\.\\\\.+\", \"_\")\n+                                   .replaceAll(\"[:*?\\\"<>|]\", \"_\")\n+                                   .trim();\n+                if (safeRootName.isEmpty()) {\n+                    safeRootName = \"_\";\n+                }\n+                Path rootPath = dumpDir.toPath().resolve(safeRootName).normalize();\n+                if (!rootPath.startsWith(dumpDir.toPath())) {\n+                    throw new IOException(\"Invalid POIFS root name: \" + rawRootName);\n+                }\n+                File file = rootPath.toFile();\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n-    \n                 dump(root, file);\n     \n                 if (dumpProps) {\n@@ -105,12 +118,36 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                String rawName = node.getName().trim();\n+                String safeName = rawName.replaceAll(\"[/\\\\\\\\]+\", \"_\")\n+                                           .replaceAll(\"\\\\.\\\\.+\", \"_\")\n+                                           .replaceAll(\"[:*?\\\"<>|]\", \"_\")\n+                                           .trim();\n+                if (safeName.isEmpty()) {\n+                    safeName = \"_\";\n+                }\n+                Path outPath = parent.toPath().resolve(safeName).normalize();\n+                if (!outPath.startsWith(parent.toPath())) {\n+                    throw new IOException(\"Invalid entry name: \" + rawName);\n+                }\n+                try (OutputStream out = Files.newOutputStream(outPath)) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                String rawName = entry.getName();\n+                String safeName = rawName.replaceAll(\"[/\\\\\\\\]+\", \"_\")\n+                                           .replaceAll(\"\\\\.\\\\.+\", \"_\")\n+                                           .replaceAll(\"[:*?\\\"<>|]\", \"_\")\n+                                           .trim();\n+                if (safeName.isEmpty()) {\n+                    safeName = \"_\";\n+                }\n+                Path dirPath = parent.toPath().resolve(safeName).normalize();\n+                if (!dirPath.startsWith(parent.toPath())) {\n+                    throw new IOException(\"Invalid entry name: \" + rawName);\n+                }\n+                File file = dirPath.toFile();\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -121,11 +158,22 @@\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n-        if (! Files.isDirectory(file.toPath().getParent())) {\n-            Files.createDirectories(file.toPath().getParent());\n+        String safeName = name == null ? \"_\" :\n+                name.replaceAll(\"[/\\\\\\\\]+\", \"_\")\n+                    .replaceAll(\"\\\\.\\\\.+\", \"_\")\n+                    .replaceAll(\"[:*?\\\"<>|]\", \"_\")\n+                    .trim();\n+        if (safeName.isEmpty()) {\n+            safeName = \"_\";\n         }\n-        try (OutputStream out = Files.newOutputStream(file.toPath())) {\n+        Path filePath = parent.toPath().resolve(safeName).normalize();\n+        if (!filePath.startsWith(parent.toPath())) {\n+            throw new IOException(\"Invalid entry name: \" + name);\n+        }\n+        if (!Files.isDirectory(filePath.getParent())) {\n+            Files.createDirectories(filePath.getParent());\n+        }\n+        try (OutputStream out = Files.newOutputStream(filePath)) {\n             POIFSStream stream = new POIFSStream(fs, startBlock);\n \n             byte[] b = IOUtils.safelyAllocate(fs.getBigBlockSize(), POIFSFileSystem.getMaxRecordLength());\n",
  "stdout": "",
  "stderr": ""
}