{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_8",
  "source_directory": "/home/qqor/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 2.9720100000000005,
    "prompt_tokens": 889360,
    "completion_tokens": 20262
  },
  "variant": "sound",
  "diff": "--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n@@ -219,7 +219,9 @@\n                             || lexer.peekToken().getText().equals(\"readonly\")\n                             || lexer.peekToken().getText().equals(\"def\"))))\n             {\n-                lexer.nextToken();\n+                if (lexer.nextToken() == null) {\n+                    throw new IOException(\"Should have found dup, readonly or def?! EOF?\");\n+                }\n             }\n             \n             Map<Integer, String> codeToName = new HashMap<>();\n@@ -640,7 +642,9 @@\n         while (!(lexer.peekKind(Token.LITERAL)\n                 && lexer.peekToken().getText().equals(\"CharStrings\")))\n         {\n-            lexer.nextToken();\n+            if (lexer.nextToken() == null) {\n+                throw new IOException(\"EOF? Should have found CharStrings\");\n+            }\n         }\n \n         // CharStrings dict\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -180,6 +180,7 @@\n     private final class PageIterator implements Iterator<PDPage>\n     {\n         private final Queue<COSDictionary> queue = new ArrayDeque<>();\n+        private Set<COSDictionary> seen = new HashSet<>();\n \n         private PageIterator(COSDictionary node)\n         {\n@@ -205,6 +206,11 @@\n          */\n         private List<COSDictionary> enqueueKids(COSDictionary node)\n         {\n+            if (seen.contains(node)) {\n+                LOG.warn(\"Found an infinite loop in the page tree\");\n+                return Collections.EMPTY_LIST;\n+            }\n+            seen.add(node);\n             if (isPageTreeNode(node))\n             {\n                 return getKids(node);\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/XrefParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/XrefParser.java\n@@ -23,6 +23,7 @@\n import java.util.Map;\n import java.util.Optional;\n import java.util.Map.Entry;\n+import java.util.Set;\n \n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n@@ -98,17 +99,19 @@\n         }\n         document.setStartXref(startXrefOffset);\n         long prev = startXrefOffset;\n-        //lastPrev prevents potential infinite loops in crafted files\n-        long lastPrev = -1;\n         // ---- parse whole chain of xref tables/object streams using PREV reference\n+        Set<Long> prevSet = new HashSet<>();\n         COSDictionary trailer = null;\n-        while (prev > 0 && prev != lastPrev)\n-        {\n-            lastPrev = prev;\n+        while (prev > 0)\n+        {\n+            // save expected position for loop detection\n+            prevSet.add(prev);\n             // seek to xref table\n             source.seek(prev);\n             // skip white spaces\n             parser.skipSpaces();\n+            // save current position as well due to skipped spaces\n+            prevSet.add(source.getPosition());\n             // -- parse xref\n             if (source.peek() == X)\n             {\n@@ -170,7 +173,7 @@\n                     trailer.setLong(COSName.PREV, prev);\n                 }\n             }\n-            if (prev == lastPrev)\n+            if (prevSet.contains(prev))\n             {\n                 throw new IOException(\"/Prev loop at offset \" + prev);\n             }\n",
  "stdout": "",
  "stderr": ""
}