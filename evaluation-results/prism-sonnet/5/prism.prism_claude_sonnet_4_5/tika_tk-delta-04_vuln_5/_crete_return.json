{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-04_vuln_5",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 1.279995,
    "prompt_tokens": 348245,
    "completion_tokens": 15684
  },
  "variant": "sound",
  "diff": "--- a/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n+++ b/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n@@ -146,6 +146,22 @@\n     public void emit(String path, InputStream inputStream, Metadata userMetadata, ParseContext parseContext) throws IOException, TikaEmitterException {\n         Path target = basePath.resolve(path);\n \n+        try {\n+            if (!target.toRealPath().startsWith(basePath.toRealPath())) {\n+                throw new TikaEmitterException(\n+                    \"Path traversal detected: resolved path must be a descendant of the base path. \" +\n+                    \"Attempted path: \" + path);\n+            }\n+        } catch (IOException e) {\n+            Path normalizedTarget = target.toAbsolutePath().normalize();\n+            Path normalizedBase = basePath.toAbsolutePath().normalize();\n+            if (!normalizedTarget.startsWith(normalizedBase)) {\n+                throw new TikaEmitterException(\n+                    \"Path traversal detected: resolved path must be a descendant of the base path. \" +\n+                    \"Attempted path: \" + path);\n+            }\n+        }\n+\n         if (!Files.isDirectory(target.getParent())) {\n             Files.createDirectories(target.getParent());\n         }\n\n--- a/tika-core/src/main/java/org/apache/tika/extractor/AbstractEmbeddedDocumentBytesHandler.java\n+++ b/tika-core/src/main/java/org/apache/tika/extractor/AbstractEmbeddedDocumentBytesHandler.java\n@@ -19,6 +19,8 @@\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Locale;\n@@ -92,26 +94,32 @@\n \n     private String addSubDirs(String embeddedPath) {\n         StringBuilder sb = new StringBuilder();\n-        //for safety\n-        File cwd = new File(\".\");\n-        File f = new File(cwd, embeddedPath);\n-        String relPath = cwd.toPath().relativize(f.toPath()).toString();\n-        if (relPath.startsWith(\"/\")) {\n-            relPath = relPath.substring(1);\n-        }\n-        relPath = relPath.replaceAll(\"\\\\.\\\\./\", \"/\");\n-        relPath = relPath.replaceAll(\"/+\", \"/\");\n-\n-        String[] parts = relPath.split(\"[/\\\\\\\\]\");\n-        for (int i = 0; i < parts.length - 1; i++) {\n-            //confirm there's a file name\n-            if (containsAlphaNumeric(parts[i])) {\n-                sb.append(parts[i] + \"/attach/\");\n+        \n+        Path normalizedPath = Paths.get(embeddedPath).normalize();\n+        \n+        int nameCount = normalizedPath.getNameCount();\n+        for (int i = 0; i < nameCount - 1; i++) {\n+            String part = normalizedPath.getName(i).toString();\n+            if (part.equals(\".\") || part.equals(\"..\")) {\n+                continue;\n+            }\n+            if (containsAlphaNumeric(part)) {\n+                sb.append(part).append(\"/attach/\");\n             } else {\n-                sb.append(parts[i] + \"/\");\n+                sb.append(part).append(\"/\");\n             }\n         }\n-        sb.append(parts[parts.length - 1]);\n+        \n+        if (nameCount > 0) {\n+            String fileName = normalizedPath.getName(nameCount - 1).toString();\n+            fileName = FilenameUtils.getName(fileName);\n+            if (!fileName.isEmpty() && !fileName.equals(\".\") && !fileName.equals(\"..\")) {\n+                sb.append(fileName);\n+            } else {\n+                sb.append(\"extracted-\").append(System.currentTimeMillis());\n+            }\n+        }\n+        \n         return sb.toString();\n     }\n \n",
  "stdout": "",
  "stderr": ""
}