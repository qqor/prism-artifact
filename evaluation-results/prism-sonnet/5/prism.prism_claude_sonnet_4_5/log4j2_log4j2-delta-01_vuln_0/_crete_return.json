{
  "project_name": "log4j2",
  "vulnerability_identifier": "log4j2_log4j2-delta-01_vuln_0",
  "source_directory": "/home/user/crete/.cache/official-afc-logging-log4j2",
  "llm_usage": {
    "total_cost": 1.9994070000000002,
    "prompt_tokens": 572079,
    "completion_tokens": 18878
  },
  "variant": "sound",
  "diff": "--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n@@ -19,8 +19,11 @@\n import javax.naming.InitialContext;\n import javax.naming.NamingException;\n \n+import org.apache.logging.log4j.Logger;\n import org.apache.logging.log4j.core.LogEvent;\n import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.status.StatusLogger;\n+import org.apache.logging.log4j.util.PropertiesUtil;\n \n /**\n  * Looks up keys from JNDI resources.\n@@ -28,10 +31,21 @@\n @Plugin(name = \"jndi\", category = \"Lookup\")\n public class JndiLookup implements StrLookup {\n \n-    private static boolean ENABLE_JNDI = true;\n+    private static final Logger LOGGER = StatusLogger.getLogger();\n+    private static final boolean ENABLE_JNDI;\n \n     /** JNDI resourcce path prefix used in a J2EE container */\n     static final String CONTAINER_JNDI_RESOURCE_PATH_PREFIX = \"java:comp/env/\";\n+\n+    static {\n+        final PropertiesUtil props = PropertiesUtil.getProperties();\n+        ENABLE_JNDI = props.getBooleanProperty(\"log4j2.enableJndi\", false);\n+        if (ENABLE_JNDI) {\n+            LOGGER.warn(\"JNDI lookup is enabled. This poses a security risk. Please ensure this is intentional.\");\n+        } else {\n+            LOGGER.info(\"JNDI lookup is disabled by default for security. Set log4j2.enableJndi=true to enable.\");\n+        }\n+    }\n \n     /**\n      * Get the value of the JNDI resource.\n@@ -55,12 +69,62 @@\n             return null;\n         }\n \n+        if (!isValidJndiName(key)) {\n+            LOGGER.warn(\"Rejecting JNDI lookup for key '{}' due to security restrictions. \" +\n+                       \"Only local JNDI resources (java: protocol) are allowed.\", key);\n+            return null;\n+        }\n+\n         try {\n             InitialContext ctx = new InitialContext();\n             return (String) ctx.lookup(convertJndiName(key));\n         } catch (NamingException e) {\n             return null;\n         }\n+    }\n+\n+    /**\n+     * Validates whether a JNDI name is safe to lookup.\n+     * Only local JNDI resources with java: protocol are allowed.\n+     * Remote protocols like ldap://, rmi://, dns:// are blocked.\n+     * \n+     * @param jndiName The name to validate.\n+     * @return true if the name is safe to lookup, false otherwise.\n+     */\n+    private boolean isValidJndiName(final String jndiName) {\n+        if (jndiName == null) {\n+            return false;\n+        }\n+\n+        // Convert the name first to get the actual lookup name\n+        final String convertedName = convertJndiName(jndiName);\n+\n+        // Only allow 'java:' protocol for local JNDI resources\n+        if (convertedName.startsWith(\"java:\")) {\n+            return true;\n+        }\n+\n+        // Check for dangerous remote protocols\n+        final String lowerName = convertedName.toLowerCase();\n+        final String[] dangerousProtocols = {\n+            \"ldap://\", \"ldaps://\", \"rmi://\", \"dns://\",\n+            \"iiop://\", \"corba://\", \"nis://\", \"nds://\"\n+        };\n+        \n+        for (final String protocol : dangerousProtocols) {\n+            if (lowerName.startsWith(protocol)) {\n+                return false;\n+            }\n+        }\n+\n+        // If the original name has a colon but doesn't start with java:, reject it\n+        // This prevents bypasses with other protocols\n+        if (jndiName.indexOf(':') != -1 && !jndiName.startsWith(\"java:\")) {\n+            return false;\n+        }\n+\n+        // If no colon, it will be converted to java:comp/env/ prefix (safe)\n+        return true;\n     }\n \n     /**\n@@ -78,10 +142,6 @@\n         return jndiName;\n     }\n \n-    public static void setEnableJndi(boolean enableJndi) {\n-        ENABLE_JNDI = enableJndi;\n-    }\n-\n     public static boolean isEnableJndi() {\n         return ENABLE_JNDI;\n     }\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n@@ -41,6 +41,11 @@\n     public static final String JNDI_CONTEXT_NAME = \"java:comp/env/log4j/context-name\";\n \n     /**\n+     * Name of the system property to enable/disable JNDI lookups.\n+     */\n+    public static final String LOG4J_ENABLE_JNDI = \"log4j2.enableJndi\";\n+\n+    /**\n      * Line separator.\n      */\n     public static final String LINE_SEP = PropertiesUtil.getProperties().getStringProperty(\"line.separator\", \"\\n\");\n",
  "stdout": "",
  "stderr": ""
}