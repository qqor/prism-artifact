{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_7",
  "source_directory": "/home/user/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 1.896525,
    "prompt_tokens": 543985,
    "completion_tokens": 17638
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -18,6 +18,7 @@\n \n import java.util.ArrayDeque;\n import java.util.Collections;\n+import java.util.IdentityHashMap;\n import java.util.Iterator;\n import java.util.Queue;\n import org.apache.pdfbox.cos.COSArray;\n@@ -180,9 +181,15 @@\n     private final class PageIterator implements Iterator<PDPage>\n     {\n         private final Queue<COSDictionary> queue = new ArrayDeque<>();\n+        \n+        // PDFBOX-5044: to prevent circular references causing infinite loops\n+        // must be COSDictionary and not PDPage, because PDPage is newly created each time\n+        private final Set<COSDictionary> visitedNodes = \n+            Collections.newSetFromMap(new IdentityHashMap<>());\n \n         private PageIterator(COSDictionary node)\n         {\n+            visitedNodes.add(node);\n             List<COSDictionary> kids = enqueueKids(node);\n             while (!kids.isEmpty())\n             {\n@@ -190,7 +197,15 @@\n \n                 for (COSDictionary kid : kids)\n                 {\n-                    newKids.addAll(enqueueKids(kid));\n+                    if (visitedNodes.contains(kid))\n+                    {\n+                        LOG.warn(\"Circular reference detected in page tree, skipping already visited node\");\n+                    }\n+                    else\n+                    {\n+                        visitedNodes.add(kid);\n+                        newKids.addAll(enqueueKids(kid));\n+                    }\n                 }\n                 kids = newKids;\n             }\n",
  "stdout": "",
  "stderr": ""
}