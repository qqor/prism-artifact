--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -65,8 +65,8 @@
 // Walk the tree to calculate the e37vk checksum
 static uint32_t compute_tree_checksum(TreeNode *node, unsigned int depth)
 {
-  // Skip if already hashed
-  if (!node || node->state == STATE_HASHED) {
+  // Skip if already hashed or currently being visited
+  if (!node || node->state == STATE_VISITED || node->state == STATE_HASHED) {
     return 0;
   }
 
