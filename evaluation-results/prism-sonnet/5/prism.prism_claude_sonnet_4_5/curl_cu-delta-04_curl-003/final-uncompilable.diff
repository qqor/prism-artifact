--- a/lib/doh.c
+++ b/lib/doh.c
@@ -224,6 +224,10 @@
   }
   else {
     struct doh_probes *dohp = data->req.doh;
+    if(!dohp) {
+      /* Parent's DOH structure is already cleaned up or being cleaned up */
+      return 0;
+    }
     /* one of the DoH request done for the 'data' transfer is now complete! */
     dohp->pending--;
     infof(doh, "a DoH request is completed, %u to go", dohp->pending);
@@ -1402,28 +1406,32 @@
 void Curl_doh_close(struct Curl_easy *data)
 {
   struct doh_probes *doh = data->req.doh;
-  if(doh && data->multi) {
+  if(doh) {
+    struct Curl_multi *multi = data->multi;
     struct Curl_easy *probe_data;
     curl_off_t mid;
     size_t slot;
+    
+    /* Set to NULL early to prevent use-after-free in doh_done callback */
+    data->req.doh = NULL;
+    
     for(slot = 0; slot < DOH_SLOT_COUNT; slot++) {
       mid = doh->probe[slot].easy_mid;
       if(mid < 0)
         continue;
       doh->probe[slot].easy_mid = -1;
-      /* should have been called before data is removed from multi handle */
-      DEBUGASSERT(data->multi);
-      probe_data = data->multi ? Curl_multi_get_handle(data->multi, mid) :
-        NULL;
-      if(!probe_data) {
-        DEBUGF(infof(data, "Curl_doh_close: xfer for mid=%"
-                     FMT_OFF_T " not found!",
-                     doh->probe[slot].easy_mid));
-        continue;
+      
+      /* Try to get and remove the probe handle if multi is still valid */
+      if(multi) {
+        probe_data = Curl_multi_get_handle(multi, mid);
+        if(!probe_data) {
+          DEBUGF(infof(data, "Curl_doh_close: xfer for mid=%"
+                       FMT_OFF_T " not found!", mid));
+          continue;
+        }
+        curl_multi_remove_handle(multi, probe_data);
+        Curl_close(&probe_data);
       }
-      /* data->multi might already be reset at this time */
-      curl_multi_remove_handle(data->multi, probe_data);
-      Curl_close(&probe_data);
     }
   }
 }
@@ -1433,9 +1441,10 @@
   struct doh_probes *doh = data->req.doh;
   if(doh) {
     Curl_doh_close(data);
+    /* Note: Curl_doh_close sets data->req.doh to NULL, so use local doh */
     curl_slist_free_all(doh->req_hds);
-    data->req.doh->req_hds = NULL;
-    Curl_safefree(data->req.doh);
+    doh->req_hds = NULL;
+    Curl_safefree(doh);
   }
 }
 

--- a/lib/multi.c
+++ b/lib/multi.c
@@ -897,6 +897,13 @@
       break;
     }
   }
+
+#ifndef CURL_DISABLE_DOH
+  /* Clean up DOH probes before clearing data->multi to ensure probes can be
+     properly removed from the multi handle. This is crucial when data->conn
+     is NULL (e.g., during DNS resolution) and multi_done() was skipped. */
+  Curl_doh_close(data);
+#endif
 
   data->multi = NULL; /* clear the association to this multi handle */
   data->mid = -1;
