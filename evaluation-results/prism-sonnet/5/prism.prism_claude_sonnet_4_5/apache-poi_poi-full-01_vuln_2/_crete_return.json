{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 2.6054399999999993,
    "prompt_tokens": 793460,
    "completion_tokens": 15004
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -42,6 +42,57 @@\n public final class POIFSDump {\n \n     private POIFSDump() {}\n+\n+    /**\n+     * Sanitizes an entry name to prevent path traversal attacks.\n+     * Removes or replaces characters that could allow escaping the intended directory structure.\n+     *\n+     * @param entryName the entry name from POIFS file\n+     * @return sanitized name safe for filesystem operations\n+     */\n+    private static String sanitizeEntryName(String entryName) {\n+        if (entryName == null || entryName.trim().isEmpty()) {\n+            return \"unnamed_entry\";\n+        }\n+        \n+        String sanitized = entryName.trim();\n+        \n+        // Replace path separators\n+        sanitized = sanitized.replaceAll(\"[/\\\\\\\\]\", \"_\");\n+        \n+        // Replace relative path components (., .., etc)\n+        sanitized = sanitized.replaceAll(\"^\\\\.+$|^\\\\.+(?=[^.])|(?<=[^.])\\\\.+$\", \"_\");\n+        \n+        // Replace problematic filesystem characters\n+        sanitized = sanitized.replaceAll(\"[:\\\\*\\\"?|<>]\", \"_\");\n+        \n+        // Replace control characters\n+        sanitized = sanitized.replaceAll(\"[\\\\p{Cntrl}]\", \"_\");\n+        \n+        // If after sanitization the name is empty, use default\n+        if (sanitized.isEmpty()) {\n+            return \"unnamed_entry\";\n+        }\n+        \n+        return sanitized;\n+    }\n+\n+    /**\n+     * Validates that a file path stays within the intended parent directory.\n+     *\n+     * @param file the file to validate\n+     * @param parent the expected parent directory\n+     * @throws IOException if the file would be outside the parent directory\n+     */\n+    private static void validatePath(File file, File parent) throws IOException {\n+        String canonicalFilePath = file.getCanonicalPath();\n+        String canonicalParentPath = parent.getCanonicalPath();\n+        \n+        if (!canonicalFilePath.startsWith(canonicalParentPath + File.separator) && \n+            !canonicalFilePath.equals(canonicalParentPath)) {\n+            throw new IOException(\"Security violation: Entry would create path outside intended directory structure\");\n+        }\n+    }\n \n     public static void main(String[] args) throws IOException {\n         if (args.length == 0) {\n@@ -105,12 +156,17 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                String safeName = sanitizeEntryName(node.getName());\n+                File outputFile = new File(parent, safeName);\n+                validatePath(outputFile, parent);\n+                try (OutputStream out = Files.newOutputStream(outputFile.toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                String safeName = sanitizeEntryName(entry.getName());\n+                File file = new File(parent, safeName);\n+                validatePath(file, parent);\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n",
  "stdout": "",
  "stderr": ""
}