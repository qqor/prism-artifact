{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-01_vuln_9",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 8.246049,
    "prompt_tokens": 2330743,
    "completion_tokens": 83588
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n+++ b/tika-core/src/main/java/org/apache/tika/parser/external/ExternalParser.java\n@@ -158,7 +158,8 @@\n \n         Process process = null;\n         try {\n-            process = Runtime.getRuntime().exec(checkCmd);\n+            ProcessBuilder pb = new ProcessBuilder(checkCmd);\n+            process = pb.start();\n             Thread stdErrSuckerThread = ignoreStream(process.getErrorStream(), false);\n             Thread stdOutSuckerThread = ignoreStream(process.getInputStream(), false);\n             stdErrSuckerThread.join();\n@@ -285,14 +286,9 @@\n \n         File output = null;\n \n-        // Build our command\n-        String[] cmd;\n-        if (command.length == 1) {\n-            cmd = command[0].split(\" \");\n-        } else {\n-            cmd = new String[command.length];\n-            System.arraycopy(command, 0, cmd, 0, command.length);\n-        }\n+        // Build our command - use command array directly without string splitting\n+        String[] cmd = new String[command.length];\n+        System.arraycopy(command, 0, cmd, 0, command.length);\n         for (int i = 0; i < cmd.length; i++) {\n             if (cmd[i].contains(INPUT_FILE_TOKEN)) {\n                 cmd[i] = cmd[i].replace(INPUT_FILE_TOKEN, stream.getFile().getPath());\n@@ -305,14 +301,11 @@\n             }\n         }\n \n-        // Execute\n+        // Execute using ProcessBuilder to avoid shell injection\n         Process process = null;\n         try {\n-            if (cmd.length == 1) {\n-                process = Runtime.getRuntime().exec(cmd[0]);\n-            } else {\n-                process = Runtime.getRuntime().exec(cmd);\n-            }\n+            ProcessBuilder pb = new ProcessBuilder(cmd);\n+            process = pb.start();\n         } catch (Exception e) {\n             LOG.warn(\"problem with process exec\", e);\n         }\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n@@ -35,6 +35,7 @@\n import org.xml.sax.SAXException;\n import org.xml.sax.helpers.AttributesImpl;\n \n+import org.apache.tika.config.TikaConfig;\n import org.apache.tika.extractor.EmbeddedDocumentExtractor;\n import org.apache.tika.extractor.EmbeddedDocumentUtil;\n import org.apache.tika.io.TikaInputStream;\n@@ -44,6 +45,8 @@\n import org.apache.tika.metadata.Property;\n import org.apache.tika.metadata.TikaCoreProperties;\n import org.apache.tika.mime.MediaType;\n+import org.apache.tika.mime.MediaTypeRegistry;\n+import org.apache.tika.parser.CompositeParser;\n import org.apache.tika.parser.ParseContext;\n import org.apache.tika.parser.Parser;\n import org.apache.tika.parser.external.CompositeExternalParser;\n@@ -370,8 +373,36 @@\n         if (dataURIScheme.getMediaType() != null) {\n             m.set(Metadata.CONTENT_TYPE, dataURIScheme.getMediaType().toString());\n         }\n+        \n+        // Create a restricted context that excludes external parsers for data URI security\n+        ParseContext restrictedContext = new ParseContext();\n+        \n+        // Get the current parser and create a restricted version\n+        Parser originalParser = context.get(Parser.class);\n+        if (originalParser instanceof CompositeParser) {\n+            CompositeParser cp = (CompositeParser) originalParser;\n+            List<Parser> parsers = cp.getAllComponentParsers();\n+            MediaTypeRegistry registry = cp.getMediaTypeRegistry();\n+            \n+            // Exclude external parsers to prevent command injection\n+            Set<Class<? extends Parser>> excludeParsers = new HashSet<>();\n+            excludeParsers.add(ExternalParser.class);\n+            excludeParsers.add(CompositeExternalParser.class);\n+            \n+            Parser restrictedParser = new CompositeParser(registry, parsers, excludeParsers);\n+            restrictedContext.set(Parser.class, restrictedParser);\n+        } else if (originalParser != null) {\n+            restrictedContext.set(Parser.class, originalParser);\n+        }\n+        \n+        // Copy TikaConfig if present\n+        TikaConfig tikaConfig = context.get(TikaConfig.class);\n+        if (tikaConfig != null) {\n+            restrictedContext.set(TikaConfig.class, tikaConfig);\n+        }\n+        \n         EmbeddedDocumentExtractor embeddedDocumentExtractor =\n-                EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n+                EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(restrictedContext);\n         if (embeddedDocumentExtractor.shouldParseEmbedded(m)) {\n             try (TikaInputStream stream = TikaInputStream.get(dataURIScheme.getInputStream())) {\n                 embeddedDocumentExtractor.parseEmbedded(stream, xhtml, m, true);\n",
  "stdout": "",
  "stderr": ""
}