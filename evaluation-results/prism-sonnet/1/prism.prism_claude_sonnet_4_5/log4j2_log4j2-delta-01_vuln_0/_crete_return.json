{
  "project_name": "log4j2",
  "vulnerability_identifier": "log4j2_log4j2-delta-01_vuln_0",
  "source_directory": "/home/user/crete/.cache/official-afc-logging-log4j2",
  "llm_usage": {
    "total_cost": 3.4045319999999997,
    "prompt_tokens": 947864,
    "completion_tokens": 37396
  },
  "variant": "sound",
  "diff": "--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n@@ -19,8 +19,11 @@\n import javax.naming.InitialContext;\n import javax.naming.NamingException;\n \n+import org.apache.logging.log4j.Logger;\n import org.apache.logging.log4j.core.LogEvent;\n import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.status.StatusLogger;\n+import org.apache.logging.log4j.util.PropertiesUtil;\n \n /**\n  * Looks up keys from JNDI resources.\n@@ -28,7 +31,15 @@\n @Plugin(name = \"jndi\", category = \"Lookup\")\n public class JndiLookup implements StrLookup {\n \n-    private static boolean ENABLE_JNDI = true;\n+    private static final Logger LOGGER = StatusLogger.getLogger();\n+    private static boolean ENABLE_JNDI;\n+\n+    static {\n+        ENABLE_JNDI = PropertiesUtil.getProperties().getBooleanProperty(\"log4j2.enableJndiLookup\", false);\n+        if (ENABLE_JNDI) {\n+            LOGGER.warn(\"JNDI lookup is enabled. This can pose a security risk. Set log4j2.enableJndiLookup=false to disable.\");\n+        }\n+    }\n \n     /** JNDI resourcce path prefix used in a J2EE container */\n     static final String CONTAINER_JNDI_RESOURCE_PATH_PREFIX = \"java:comp/env/\";\n@@ -55,12 +66,49 @@\n             return null;\n         }\n \n+        if (!isAllowedJndiProtocol(key)) {\n+            LOGGER.warn(\"Rejected JNDI lookup with potentially unsafe protocol: {}\", key);\n+            return null;\n+        }\n+\n         try {\n             InitialContext ctx = new InitialContext();\n             return (String) ctx.lookup(convertJndiName(key));\n         } catch (NamingException e) {\n             return null;\n         }\n+    }\n+\n+    /**\n+     * Validates that the JNDI name uses only allowed protocols (local java: scheme).\n+     * Rejects remote protocols like ldap://, ldaps://, rmi://, dns://, iiop://, corba://.\n+     * \n+     * @param jndiName The JNDI name to validate\n+     * @return true if the protocol is allowed, false otherwise\n+     */\n+    private boolean isAllowedJndiProtocol(final String jndiName) {\n+        if (jndiName == null) {\n+            return false;\n+        }\n+\n+        final String lowerName = jndiName.toLowerCase();\n+        \n+        if (lowerName.contains(\"://\")) {\n+            final int protoIndex = lowerName.indexOf(\"://\");\n+            final String protocol = lowerName.substring(0, protoIndex);\n+            \n+            if (!protocol.equals(\"java\")) {\n+                return false;\n+            }\n+        }\n+        \n+        if (lowerName.startsWith(\"ldap:\") || lowerName.startsWith(\"ldaps:\") ||\n+            lowerName.startsWith(\"rmi:\") || lowerName.startsWith(\"dns:\") ||\n+            lowerName.startsWith(\"iiop:\") || lowerName.startsWith(\"corba:\")) {\n+            return false;\n+        }\n+\n+        return true;\n     }\n \n     /**\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/pattern/MessagePatternConverter.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/pattern/MessagePatternConverter.java\n@@ -21,6 +21,7 @@\n import org.apache.logging.log4j.core.config.plugins.Plugin;\n import org.apache.logging.log4j.message.Message;\n import org.apache.logging.log4j.message.MultiformatMessage;\n+import org.apache.logging.log4j.util.PropertiesUtil;\n \n /**\n  * Returns the event's rendered message in a StringBuilder.\n@@ -29,8 +30,10 @@\n @ConverterKeys({\"m\", \"msg\", \"message\" })\n public final class MessagePatternConverter extends LogEventPatternConverter {\n \n+    private static final boolean FORMAT_MESSAGES_NO_LOOKUPS = \n+        PropertiesUtil.getProperties().getBooleanProperty(\"log4j2.formatMsgNoLookups\", false);\n+\n     private final String[] formats;\n-\n     private final Configuration config;\n \n     /**\n@@ -68,7 +71,7 @@\n                 result = msg.getFormattedMessage();\n             }\n             if (result != null) {\n-                toAppendTo.append(config != null && result.contains(\"${\") ?\n+                toAppendTo.append(config != null && !FORMAT_MESSAGES_NO_LOOKUPS && result.contains(\"${\") ?\n                     config.getSubst().replace(event, result) : result);\n             } else {\n                 toAppendTo.append(\"null\");\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n@@ -41,6 +41,16 @@\n     public static final String JNDI_CONTEXT_NAME = \"java:comp/env/log4j/context-name\";\n \n     /**\n+     * System property to disable JNDI lookups for security.\n+     */\n+    public static final String LOG4J_ENABLE_JNDI_LOOKUP = \"log4j2.enableJndiLookup\";\n+\n+    /**\n+     * System property to disable message pattern lookups for security.\n+     */\n+    public static final String LOG4J_FORMAT_MSG_NO_LOOKUPS = \"log4j2.formatMsgNoLookups\";\n+\n+    /**\n      * Line separator.\n      */\n     public static final String LINE_SEP = PropertiesUtil.getProperties().getStringProperty(\"line.separator\", \"\\n\");\n",
  "stdout": "",
  "stderr": ""
}