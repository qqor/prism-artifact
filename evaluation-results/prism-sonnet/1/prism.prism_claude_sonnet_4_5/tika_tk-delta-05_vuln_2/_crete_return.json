{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 3.2403059999999995,
    "prompt_tokens": 927387,
    "completion_tokens": 30543
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -1125,7 +1125,7 @@\n             }\n         }\n \n-        private File getOutputFile(String name, Metadata metadata, MediaType contentType) {\n+        private File getOutputFile(String name, Metadata metadata, MediaType contentType) throws IOException {\n             String ext = getExtension(contentType);\n             if (name.indexOf('.') == -1 && contentType != null) {\n                 name += ext;\n@@ -1158,12 +1158,26 @@\n                 LOG.warn(\"couldn't url decode name {}\", normalizedName);\n             }\n             File outputFile = new File(extractDir, normalizedName);\n+            \n+            // Validate that the resolved path is within the extraction directory to prevent path traversal\n+            Path outputPath = outputFile.toPath().toAbsolutePath().normalize();\n+            Path extractPath = extractDir.toPath().toAbsolutePath().normalize();\n+            if (!outputPath.startsWith(extractPath)) {\n+                throw new IOException(\"Path traversal detected in embedded resource: \" + name);\n+            }\n+            \n             //if file already exists, prepend uuid\n             if (outputFile.exists()) {\n                 String fileName = FilenameUtils.getName(normalizedName);\n                 outputFile = new File(extractDir, UUID\n                         .randomUUID()\n                         .toString() + \"-\" + fileName);\n+                \n+                // Revalidate the path after prepending UUID\n+                outputPath = outputFile.toPath().toAbsolutePath().normalize();\n+                if (!outputPath.startsWith(extractPath)) {\n+                    throw new IOException(\"Path traversal detected in embedded resource after UUID prepend: \" + name);\n+                }\n             }\n             return outputFile;\n         }\n\n--- a/tika-example/src/main/java/org/apache/tika/example/ExtractEmbeddedFiles.java\n+++ b/tika-example/src/main/java/org/apache/tika/example/ExtractEmbeddedFiles.java\n@@ -108,10 +108,24 @@\n             }\n \n             Path outputFile = outputDir.resolve(name);\n+            \n+            // Validate that the resolved path is within the output directory to prevent path traversal\n+            Path normalizedOutput = outputFile.toAbsolutePath().normalize();\n+            Path normalizedOutputDir = outputDir.toAbsolutePath().normalize();\n+            if (!normalizedOutput.startsWith(normalizedOutputDir)) {\n+                throw new IOException(\"Path traversal detected in embedded resource: \" + name);\n+            }\n+            \n             if (Files.exists(outputFile)) {\n                 outputFile = outputDir.resolve(UUID\n                         .randomUUID()\n                         .toString() + \"-\" + name);\n+                \n+                // Revalidate the path after prepending UUID\n+                normalizedOutput = outputFile.toAbsolutePath().normalize();\n+                if (!normalizedOutput.startsWith(normalizedOutputDir)) {\n+                    throw new IOException(\"Path traversal detected in embedded resource after UUID prepend: \" + name);\n+                }\n             }\n             Files.createDirectories(outputFile.getParent());\n             Files.copy(stream, outputFile);\n",
  "stdout": "",
  "stderr": ""
}