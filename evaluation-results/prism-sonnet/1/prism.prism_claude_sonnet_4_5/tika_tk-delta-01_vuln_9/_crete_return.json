{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-01_vuln_9",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 3.623511,
    "prompt_tokens": 976672,
    "completion_tokens": 46233
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-html-module/src/main/java/org/apache/tika/parser/html/HtmlHandler.java\n@@ -30,6 +30,8 @@\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.xml.sax.Attributes;\n import org.xml.sax.ContentHandler;\n import org.xml.sax.SAXException;\n@@ -54,6 +56,8 @@\n \n class HtmlHandler extends TextContentHandler {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(HtmlHandler.class);\n+\n     // List of attributes that need to be resolved.\n     private static final Set<String> URI_ATTRIBUTES =\n             new HashSet<>(Arrays.asList(\"src\", \"href\", \"longdesc\", \"cite\"));\n@@ -62,6 +66,9 @@\n \n     private static final Map<String, Property> META_HEADER_MAPPINGS = new HashMap<>();\n     private static final MediaType JPEG = MediaType.image(\"jpeg\");\n+    private static final Set<String> DANGEROUS_METADATA_KEYS = new HashSet<>(Arrays.asList(\n+        \"exiftool_path\", \"command\", \"parser_command\", \"external_command\", \"exec\", \"shell\"\n+    ));\n     static {\n         META_HEADER_MAPPINGS.put(\"author\", TikaCoreProperties.CREATOR);\n         META_HEADER_MAPPINGS.put(\"title\", TikaCoreProperties.TITLE);\n@@ -195,6 +202,12 @@\n             return;\n         }\n \n+        // Security: Reject metadata keys that could influence parser configuration\n+        if (isDangerousMetadataKey(name)) {\n+            LOG.warn(\"Rejected potentially dangerous HTML metadata key: {}\", name);\n+            return;\n+        }\n+\n         if (name.equalsIgnoreCase(\"ICBM\")) {\n             Matcher m = ICBM.matcher(value);\n             if (m.matches()) {\n@@ -233,6 +246,18 @@\n         } else {\n             metadata.add(HTML.PREFIX_HTML_META + name, value);\n         }\n+    }\n+\n+    private boolean isDangerousMetadataKey(String name) {\n+        String lcName = name.toLowerCase(Locale.US);\n+        // Check exact matches\n+        if (DANGEROUS_METADATA_KEYS.contains(lcName)) {\n+            return true;\n+        }\n+        // Check for patterns that suggest command configuration\n+        return lcName.contains(\"command\") || \n+               lcName.contains(\"exec\") || \n+               (lcName.contains(\"path\") && (lcName.contains(\"tool\") || lcName.contains(\"parser\")));\n     }\n \n     private void startElementWithSafeAttributes(String name, Attributes atts) throws SAXException {\n@@ -359,10 +384,6 @@\n             //swallow\n             return;\n         }\n-        int added = 0;\n-        if (metadata.get(\"html_meta:exiftool_path\") != null) {\n-            added = configureExifTool(metadata.get(\"html_meta:exiftool_path\"));\n-        }\n         //do anything with attrs?\n         Metadata m = new Metadata();\n         m.set(TikaCoreProperties.EMBEDDED_RESOURCE_TYPE,\n@@ -377,97 +398,8 @@\n                 embeddedDocumentExtractor.parseEmbedded(stream, xhtml, m, true);\n             } catch (IOException e) {\n                 EmbeddedDocumentUtil.recordEmbeddedStreamException(e, metadata);\n-            } finally {\n-                resetExifTool(added);\n-            }\n-        }\n-    }\n-\n-    private int configureExifTool(String path) {\n-        ExternalParser exifToolParser = getExistingExifToolParser();\n-        int retVal = 0;\n-        if (exifToolParser == null) {\n-            CompositeExternalParser exParser =\n-                    (CompositeExternalParser) EmbeddedDocumentUtil.tryToFindExistingLeafParser(CompositeExternalParser.class,\n-                            context);\n-            if (exParser == null) {\n-                //lasciate ogne speranza\n-                return 2;\n-            }\n-            exifToolParser = new ExternalParser();\n-            retVal = 1;\n-            Map<MediaType, Parser> parsers = exParser.getParsers(context);\n-            parsers.put(JPEG, exifToolParser);\n-            exParser.setParsers(parsers);\n-        }\n-        Set<MediaType> supported = new HashSet<>(exifToolParser.getSupportedTypes(context));\n-        supported.add(JPEG);\n-        exifToolParser.setCommand(path, \"${INPUT}\");\n-        exifToolParser.setSupportedTypes(supported);\n-        return retVal;\n-    }\n-\n-    private void resetExifTool(int added) {\n-        if (added == 2) {\n-            return;\n-        }\n-        CompositeExternalParser exParser =\n-                (CompositeExternalParser) EmbeddedDocumentUtil.tryToFindExistingLeafParser(CompositeExternalParser.class,\n-                        context);\n-        if (exParser == null) {\n-            return;\n-        }\n-        if (added == 1) {\n-            Map<MediaType, Parser> parsers = exParser.getParsers();\n-            parsers.remove(JPEG);\n-            return;\n-        }\n-        ExternalParser exifToolParser = getExistingExifToolParser();\n-        if (exifToolParser == null) {\n-            return;\n-        }\n-        Set<MediaType> supported = new HashSet<>(exifToolParser.getSupportedTypes(context));\n-        Set<MediaType> newSupported = new HashSet<>();\n-        for (MediaType m : supported) {\n-            if (!m.getSubtype().equals(\"jpeg\")) {\n-                newSupported.add(m);\n-            }\n-        }\n-        exifToolParser.setCommand(\"exiftool\", \"${INPUT}\");\n-        exifToolParser.setSupportedTypes(newSupported);\n-        metadata.remove(\"exiftool_path\");\n-        Map<MediaType, Parser> updated = new HashMap<>();\n-        for (Map.Entry<MediaType, Parser> e : exParser.getParsers().entrySet()) {\n-            if (e.getValue() instanceof ExternalParser) {\n-                ExternalParser p = (ExternalParser) e.getValue();\n-                if (ExternalParser.check(p.getCommand())) {\n-                    for (MediaType mediaType : p.getSupportedTypes()) {\n-                        updated.put(mediaType, p);\n-                    }\n-                }\n-            }\n-        }\n-        exParser.setParsers(updated);\n-    }\n-\n-    private ExternalParser getExistingExifToolParser() {\n-        CompositeExternalParser exParser =\n-                (CompositeExternalParser) EmbeddedDocumentUtil.tryToFindExistingLeafParser(CompositeExternalParser.class,\n-                        context);\n-        if (exParser == null) {\n-            return null;\n-        }\n-        for (Parser p : exParser.getAllComponentParsers()) {\n-            if (p instanceof ExternalParser) {\n-                String[] args = (((ExternalParser) p).getCommand());\n-                for (int i = 0; i < args.length; i++) {\n-                    if (args[i].contains(\"exiftool\")) {\n-                        return (ExternalParser) p;\n-                    }\n-                }\n-            }\n-        }\n-        return null;\n+            }\n+        }\n     }\n \n \n",
  "stdout": "",
  "stderr": ""
}