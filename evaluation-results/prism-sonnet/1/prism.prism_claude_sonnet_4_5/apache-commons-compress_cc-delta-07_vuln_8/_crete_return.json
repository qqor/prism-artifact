{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-07_vuln_8",
  "source_directory": "/home/qqor/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 2.5323509999999994,
    "prompt_tokens": 750522,
    "completion_tokens": 18719
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/examples/Expander.java\n@@ -471,6 +471,7 @@\n         if (! Files.isDirectory(targetDirectory)) {\n             Files.createDirectories(targetDirectory);\n         }\n+        final Path normalizedTargetDirectory = targetDirectory.toAbsolutePath().normalize();\n         final Enumeration<ZipArchiveEntry> entries = archive.getEntries();\n         while (entries.hasMoreElements()) {\n             ZipArchiveEntry zae = entries.nextElement();\n@@ -478,8 +479,18 @@\n                 String targetName = IOUtils.toString(archive.getInputStream(zae),\n                         StandardCharsets.UTF_8);\n                 Path link = targetDirectory.resolve(zae.getName());\n-                Path target = targetDirectory.resolve(targetName);\n+                Path target = targetDirectory.resolve(targetName).normalize();\n+                // Validate symlink target is within bounds\n+                final Path normalizedTarget = target.toAbsolutePath().normalize();\n+                if (!normalizedTarget.startsWith(normalizedTargetDirectory)) {\n+                    throw new IOException(String.format(\"Zip slip via symlink target: '%s' + '%s' -> '%s'\", targetDirectory, targetName, target));\n+                }\n                 Path parent = createParentDirectory(targetDirectory, link);\n+                // Validate that createParentDirectory didn't escape via symlinks\n+                final Path normalizedParent = parent.toAbsolutePath().normalize();\n+                if (!normalizedParent.startsWith(normalizedTargetDirectory)) {\n+                    throw new IOException(String.format(\"Zip slip via parent directory: '%s' -> '%s'\", targetDirectory, parent));\n+                }\n \n                 if (!Files.isSameFile(link.getParent(), parent)) {\n                     link = parent.relativize(link.getFileName()).normalize();\n@@ -494,9 +505,19 @@\n                             targetDirectory, zae.getName(), target));\n                 }\n                 Path parent = createParentDirectory(targetDirectory, target);\n+                // Validate that createParentDirectory didn't escape via symlinks\n+                final Path normalizedParent = parent.toAbsolutePath().normalize();\n+                if (!normalizedParent.startsWith(normalizedTargetDirectory)) {\n+                    throw new IOException(String.format(\"Zip slip via parent directory: '%s' -> '%s'\", targetDirectory, parent));\n+                }\n                 if (! target.getParent().toAbsolutePath().normalize().equals(\n                         parent.toAbsolutePath().normalize())) {\n                     target = parent.normalize().resolve(target.getFileName());\n+                    // Re-validate the reconstructed target path\n+                    final Path normalizedTarget = target.toAbsolutePath().normalize();\n+                    if (!normalizedTarget.startsWith(normalizedTargetDirectory)) {\n+                        throw new IOException(String.format(\"Zip slip via reconstructed path: '%s' -> '%s'\", targetDirectory, target));\n+                    }\n                 }\n                 try (InputStream is = archive.getInputStream(zae)) {\n                     Files.copy(is, target);\n@@ -509,11 +530,17 @@\n         Path relative =\n                 root.relativize(target.getParent());\n         Path current = root.toAbsolutePath();\n+        final Path normalizedRoot = root.toAbsolutePath().normalize();\n \n         for (Path p : relative) {\n             current = current.resolve(p);\n             if (Files.isSymbolicLink(current)) {\n                 current = Files.readSymbolicLink(current);\n+                // Validate that the symlink target is within root bounds\n+                final Path normalizedCurrent = current.toAbsolutePath().normalize();\n+                if (!normalizedCurrent.startsWith(normalizedRoot)) {\n+                    throw new IOException(String.format(\"Symlink points outside target directory: '%s' -> '%s'\", root, current));\n+                }\n             }\n             if (! Files.isDirectory(current)) {\n                 Files.createDirectory(current);\n",
  "stdout": "",
  "stderr": ""
}