{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-full-01_vuln_4",
  "source_directory": "/home/user/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 5.348892,
    "prompt_tokens": 1484314,
    "completion_tokens": 59730
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/XrefParser.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/XrefParser.java\n@@ -22,6 +22,7 @@\n import java.util.HashSet;\n import java.util.Map;\n import java.util.Optional;\n+import java.util.Set;\n import java.util.Map.Entry;\n \n import org.apache.logging.log4j.LogManager;\n@@ -98,13 +99,13 @@\n         }\n         document.setStartXref(startXrefOffset);\n         long prev = startXrefOffset;\n-        //lastPrev prevents potential infinite loops in crafted files\n-        long lastPrev = -1;\n+        // Track all visited offsets to prevent infinite loops in crafted files\n+        Set<Long> visitedOffsets = new HashSet<>();\n+        visitedOffsets.add(prev);\n         // ---- parse whole chain of xref tables/object streams using PREV reference\n         COSDictionary trailer = null;\n-        while (prev > 0 && prev != lastPrev)\n-        {\n-            lastPrev = prev;\n+        while (prev > 0)\n+        {\n             // seek to xref table\n             source.seek(prev);\n             // skip white spaces\n@@ -169,10 +170,11 @@\n                     prev = fixedOffset;\n                     trailer.setLong(COSName.PREV, prev);\n                 }\n-            }\n-            if (prev == lastPrev)\n-            {\n-                throw new IOException(\"/Prev loop at offset \" + prev);\n+                \n+                if (!visitedOffsets.add(prev))\n+                {\n+                    throw new IOException(\"/Prev loop detected at offset \" + prev);\n+                }\n             }\n         }\n         // ---- build valid xrefs out of the xref chain\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Parser.java\n@@ -23,8 +23,10 @@\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n \n /**\n  * Parses an Adobe Type 1 (.pfb) font. It is used exclusively by Type1Font.\n@@ -219,7 +221,10 @@\n                             || lexer.peekToken().getText().equals(\"readonly\")\n                             || lexer.peekToken().getText().equals(\"def\"))))\n             {\n-                lexer.nextToken();\n+                if (lexer.nextToken() == null)\n+                {\n+                    throw new IOException(\"Unexpected end of file while reading encoding\");\n+                }\n             }\n             \n             Map<Integer, String> codeToName = new HashMap<>();\n@@ -640,7 +645,10 @@\n         while (!(lexer.peekKind(Token.LITERAL)\n                 && lexer.peekToken().getText().equals(\"CharStrings\")))\n         {\n-            lexer.nextToken();\n+            if (lexer.nextToken() == null)\n+            {\n+                throw new IOException(\"Unexpected end of file while searching for CharStrings\");\n+            }\n         }\n \n         // CharStrings dict\n\n--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDPageTree.java\n@@ -183,14 +183,21 @@\n \n         private PageIterator(COSDictionary node)\n         {\n+            Set<COSDictionary> visited = new HashSet<>();\n             List<COSDictionary> kids = enqueueKids(node);\n+            visited.add(node);\n+            \n             while (!kids.isEmpty())\n             {\n                 List<COSDictionary> newKids = new ArrayList<>();\n \n                 for (COSDictionary kid : kids)\n                 {\n-                    newKids.addAll(enqueueKids(kid));\n+                    if (kid != null && !visited.contains(kid))\n+                    {\n+                        visited.add(kid);\n+                        newKids.addAll(enqueueKids(kid));\n+                    }\n                 }\n                 kids = newKids;\n             }\n\n--- a/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n+++ b/fontbox/src/main/java/org/apache/fontbox/type1/Type1Lexer.java\n@@ -22,6 +22,7 @@\n import java.io.IOException;\n import java.nio.BufferUnderflowException;\n import java.nio.ByteBuffer;\n+import org.apache.fontbox.type1.DamagedFontException;\n import org.apache.logging.log4j.Logger;\n import org.apache.logging.log4j.LogManager;\n /**\n@@ -48,6 +49,11 @@\n      * Log instance.\n      */\n     private static final Logger LOG = LogManager.getLogger(Type1Lexer.class);\n+    \n+    /**\n+     * Maximum size for a single CharString in bytes (1 MB).\n+     */\n+    private static final int MAX_CHAR_STRING_SIZE = 1_000_000;\n     \n     private final ByteBuffer buffer;\n     private Token aheadToken;\n",
  "stdout": "",
  "stderr": ""
}