{
  "project_name": "pdfbox",
  "vulnerability_identifier": "pdfbox_pdfbox-delta-01_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-pdfbox",
  "llm_usage": {
    "total_cost": 1.282536,
    "prompt_tokens": 344022,
    "completion_tokens": 16698
  },
  "variant": "sound",
  "diff": "--- a/pdfbox/src/main/java/org/apache/pdfbox/ocr/OCRStreamEngine.java\n+++ b/pdfbox/src/main/java/org/apache/pdfbox/ocr/OCRStreamEngine.java\n@@ -11,6 +11,7 @@\n import java.io.Writer;\n import java.nio.file.FileVisitResult;\n import java.nio.file.Files;\n+import java.nio.file.InvalidPathException;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.nio.file.SimpleFileVisitor;\n@@ -22,6 +23,9 @@\n \n import javax.imageio.ImageIO;\n \n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n+\n import org.apache.pdfbox.pdmodel.PDDocument;\n import org.apache.pdfbox.pdmodel.PDPageTree;\n import org.apache.pdfbox.rendering.PDFRenderer;\n@@ -33,6 +37,7 @@\n  */\n public class OCRStreamEngine {\n \n+    private static final Logger LOG = LogManager.getLogger(OCRStreamEngine.class);\n     private static final String TESSERACT_PATH_KEY = \"tesseract-path\";\n     private PDFRenderer pdfRenderer = null;\n     private String tesseractPath = \"tesseract\";\n@@ -112,7 +117,30 @@\n                 }\n             });\n         } catch (IOException e) {\n-            //log\n+            LOG.warn(\"Failed to delete temporary OCR directory: {}\", tmpDir, e);\n+        }\n+    }\n+\n+    /**\n+     * Validates that the given path points to an executable file.\n+     * This prevents OS command injection through PDF metadata.\n+     *\n+     * @param path the path to validate\n+     * @return true if the path is valid and executable, false otherwise\n+     */\n+    private boolean isValidTesseractPath(String path) {\n+        if (path == null || path.isEmpty()) {\n+            return false;\n+        }\n+        try {\n+            Path tessPath = Paths.get(path);\n+            // Must exist, be a regular file (not directory), and be executable\n+            return Files.exists(tessPath) && \n+                   Files.isRegularFile(tessPath) && \n+                   Files.isExecutable(tessPath);\n+        } catch (InvalidPathException e) {\n+            LOG.warn(\"Invalid path syntax for tesseract: {}\", path);\n+            return false;\n         }\n     }\n \n@@ -155,10 +183,38 @@\n     }\n \n     private String runTesseract(Path image) throws IOException {\n-        String actualTessPath = pdDocument.getDocumentInformation()\n-                .getCustomMetadataValue(TESSERACT_PATH_KEY);\n-        if (actualTessPath == null || actualTessPath.isEmpty()) {\n-            actualTessPath = tesseractPath;\n+        // Start with programmatic/default configuration (application-controlled)\n+        String actualTessPath = tesseractPath;\n+        \n+        // Check if metadata override is explicitly enabled via system property\n+        // This provides defense-in-depth while maintaining backward compatibility\n+        if (Boolean.getBoolean(\"pdfbox.ocr.allow-metadata-override\")) {\n+            String metadataPath = pdDocument.getDocumentInformation()\n+                    .getCustomMetadataValue(TESSERACT_PATH_KEY);\n+            \n+            if (metadataPath != null && !metadataPath.isEmpty()) {\n+                // Validate metadata path before using it\n+                if (isValidTesseractPath(metadataPath)) {\n+                    LOG.info(\"Using tesseract path from PDF metadata: {}\", metadataPath);\n+                    actualTessPath = metadataPath;\n+                } else {\n+                    LOG.warn(\"Invalid tesseract path from PDF metadata (not executable): {}, using default\", \n+                            metadataPath);\n+                }\n+            }\n+        } else {\n+            // Log if metadata is present but override is disabled\n+            String metadataPath = pdDocument.getDocumentInformation()\n+                    .getCustomMetadataValue(TESSERACT_PATH_KEY);\n+            if (metadataPath != null && !metadataPath.isEmpty()) {\n+                LOG.debug(\"Ignoring tesseract path from PDF metadata (override disabled): {}\", metadataPath);\n+            }\n+        }\n+        \n+        // Final validation of the path to be used (whether from metadata, config, or default)\n+        if (!isValidTesseractPath(actualTessPath)) {\n+            throw new IOException(\"Tesseract executable not found or not executable: \" + actualTessPath + \n+                                \". Please ensure Tesseract OCR is installed and the path is correct.\");\n         }\n \n         Path txt = Paths.get(image.toAbsolutePath().toString());\n",
  "stdout": "",
  "stderr": ""
}