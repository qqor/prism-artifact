--- a/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java
@@ -36,6 +36,7 @@
     private static final int MAGIC_2 = 0x9d;
     private static final int BLOCK_MODE_MASK = 0x80;
     private static final int MAX_CODE_SIZE_MASK = 0x1f;
+    private static final int MAX_CODE_SIZE = 16;
 
     /**
      * Checks if the signature matches what is expected for a Unix compress file.
@@ -80,6 +81,10 @@
         }
         blockMode = (thirdByte & BLOCK_MODE_MASK) != 0;
         maxCodeSize = thirdByte & MAX_CODE_SIZE_MASK;
+        if (maxCodeSize < DEFAULT_CODE_SIZE || maxCodeSize > MAX_CODE_SIZE) {
+            throw new IOException("Invalid maxCodeSize " + maxCodeSize + " in .Z header (valid range: " 
+                + DEFAULT_CODE_SIZE + "-" + MAX_CODE_SIZE + ")");
+        }
         if (blockMode) {
             setClearCode(DEFAULT_CODE_SIZE);
         }

--- a/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java
@@ -176,9 +176,9 @@
      * @throws IllegalArgumentException if {@code maxCodeSize} is out of bounds for {@code prefixes} and {@code characters}.
      */
     protected void initializeTables(final int maxCodeSize) {
-        // maxCodeSize shifted cannot be less than 256, otherwise the loop in initializeTables() will throw an ArrayIndexOutOfBoundsException
+        // maxCodeSize must be in valid range [8, 30] to prevent array allocation issues and integer overflow
         // maxCodeSize cannot be smaller than getCodeSize(), otherwise addEntry() will throw an ArrayIndexOutOfBoundsException
-        if (1 << maxCodeSize < 256 || getCodeSize() > maxCodeSize) {
+        if (maxCodeSize < 8 || maxCodeSize > 30 || getCodeSize() > maxCodeSize) {
             // TODO test against prefixes.length and characters.length?
             throw new IllegalArgumentException("maxCodeSize " + maxCodeSize + " is out of bounds.");
         }
