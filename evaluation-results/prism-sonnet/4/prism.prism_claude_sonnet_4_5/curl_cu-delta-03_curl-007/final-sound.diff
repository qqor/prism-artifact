--- a/lib/alliswellprotocoll.c
+++ b/lib/alliswellprotocoll.c
@@ -114,8 +114,19 @@
   PINGPONG_SETUP(pp, alliswellprotocoll_sm, vnormal_endofresp);
   Curl_pp_init(pp);
   vnormal->state1 = calloc(1, 128);
+  if(!vnormal->state1)
+    return CURLE_OUT_OF_MEMORY;
   vnormal->state2 = calloc(1, 128);
+  if(!vnormal->state2) {
+    free(vnormal->state1);
+    return CURLE_OUT_OF_MEMORY;
+  }
   vnormal->state3 = calloc(1, 128);
+  if(!vnormal->state3) {
+    free(vnormal->state1);
+    free(vnormal->state2);
+    return CURLE_OUT_OF_MEMORY;
+  }
   return Curl_pp_statemach(data, pp, FALSE, FALSE);
 }
 
@@ -250,7 +261,7 @@
       if(memcmp(response, vnormal->state3, 128) == 0) {
         vnstate(data, ALLISWELLPROTOCOLL_STOP);
         Curl_pp_sendf(data, &conn->proto.vnormal.pp, "%s", "OK\r\n");
-        *(unsigned int *)result = CURLE_OK;
+        result = CURLE_OK;
       }
       else if(strcasecmp("complete\r\n", response) == 0) {
         Curl_pp_sendf(data, &conn->proto.vnormal.pp, "%s", "OK\r\n");
