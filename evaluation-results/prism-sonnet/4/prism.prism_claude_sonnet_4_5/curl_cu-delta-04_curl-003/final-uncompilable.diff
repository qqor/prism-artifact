--- a/lib/doh.h
+++ b/lib/doh.h
@@ -94,6 +94,7 @@
   unsigned int pending; /* still outstanding probes */
   int port;
   const char *host;
+  CURLM *multi;  /* multi handle for cleanup */
 };
 
 /*

--- a/lib/doh.c
+++ b/lib/doh.c
@@ -224,6 +224,10 @@
   }
   else {
     struct doh_probes *dohp = data->req.doh;
+    if(!dohp) {
+      /* DoH was already cleaned up, probe completed after parent cleanup started */
+      return 0;
+    }
     /* one of the DoH request done for the 'data' transfer is now complete! */
     dohp->pending--;
     infof(doh, "a DoH request is completed, %u to go", dohp->pending);
@@ -427,6 +431,8 @@
   dohp = data->req.doh = calloc(1, sizeof(struct doh_probes));
   if(!dohp)
     return NULL;
+
+  dohp->multi = data->multi;
 
   for(i = 0; i < DOH_SLOT_COUNT; ++i) {
     dohp->probe[i].easy_mid = -1;
@@ -1402,7 +1408,7 @@
 void Curl_doh_close(struct Curl_easy *data)
 {
   struct doh_probes *doh = data->req.doh;
-  if(doh && data->multi) {
+  if(doh && doh->multi) {
     struct Curl_easy *probe_data;
     curl_off_t mid;
     size_t slot;
@@ -1411,18 +1417,14 @@
       if(mid < 0)
         continue;
       doh->probe[slot].easy_mid = -1;
-      /* should have been called before data is removed from multi handle */
-      DEBUGASSERT(data->multi);
-      probe_data = data->multi ? Curl_multi_get_handle(data->multi, mid) :
-        NULL;
+      probe_data = Curl_multi_get_handle(doh->multi, mid);
       if(!probe_data) {
         DEBUGF(infof(data, "Curl_doh_close: xfer for mid=%"
                      FMT_OFF_T " not found!",
                      doh->probe[slot].easy_mid));
         continue;
       }
-      /* data->multi might already be reset at this time */
-      curl_multi_remove_handle(data->multi, probe_data);
+      curl_multi_remove_handle(doh->multi, probe_data);
       Curl_close(&probe_data);
     }
   }
@@ -1432,10 +1434,11 @@
 {
   struct doh_probes *doh = data->req.doh;
   if(doh) {
+    data->req.doh = NULL;
     Curl_doh_close(data);
     curl_slist_free_all(doh->req_hds);
-    data->req.doh->req_hds = NULL;
-    Curl_safefree(data->req.doh);
+    doh->req_hds = NULL;
+    free(doh);
   }
 }
 
