{
  "project_name": "log4j2",
  "vulnerability_identifier": "log4j2_log4j2-delta-01_vuln_0",
  "source_directory": "/home/qqor/crete/.cache/official-afc-logging-log4j2",
  "llm_usage": {
    "total_cost": 1.7326020000000002,
    "prompt_tokens": 460299,
    "completion_tokens": 23447
  },
  "variant": "sound",
  "diff": "--- a/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/helpers/Constants.java\n@@ -36,6 +36,11 @@\n     public static final String LOG4J_DEFAULT_STATUS_LEVEL = \"Log4jDefaultStatusLevel\";\n \n     /**\n+     * Name of the system property to use to enable JNDI lookups.\n+     */\n+    public static final String LOG4J_ENABLE_JNDI_LOOKUP = \"log4j2.enableJndiLookup\";\n+\n+    /**\n      * JNDI context name string literal.\n      */\n     public static final String JNDI_CONTEXT_NAME = \"java:comp/env/log4j/context-name\";\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n@@ -19,8 +19,12 @@\n import javax.naming.InitialContext;\n import javax.naming.NamingException;\n \n+import org.apache.logging.log4j.Logger;\n import org.apache.logging.log4j.core.LogEvent;\n import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.core.helpers.Constants;\n+import org.apache.logging.log4j.status.StatusLogger;\n+import org.apache.logging.log4j.util.PropertiesUtil;\n \n /**\n  * Looks up keys from JNDI resources.\n@@ -28,7 +32,10 @@\n @Plugin(name = \"jndi\", category = \"Lookup\")\n public class JndiLookup implements StrLookup {\n \n-    private static boolean ENABLE_JNDI = true;\n+    private static final Logger LOGGER = StatusLogger.getLogger();\n+\n+    private static volatile boolean ENABLE_JNDI = PropertiesUtil.getProperties()\n+            .getBooleanProperty(Constants.LOG4J_ENABLE_JNDI_LOOKUP, false);\n \n     /** JNDI resourcce path prefix used in a J2EE container */\n     static final String CONTAINER_JNDI_RESOURCE_PATH_PREFIX = \"java:comp/env/\";\n@@ -53,6 +60,14 @@\n     public String lookup(final LogEvent event, final String key) {\n         if (key == null || ! ENABLE_JNDI) {\n             return null;\n+        }\n+\n+        // Only allow local java: scheme for security\n+        if (key.contains(\":\")) {\n+            if (!key.startsWith(\"java:\")) {\n+                LOGGER.warn(\"For security reasons, only java: scheme is allowed in JNDI lookups. Blocked lookup: {}\", key);\n+                return null;\n+            }\n         }\n \n         try {\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/Interpolator.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/Interpolator.java\n@@ -63,7 +63,9 @@\n         this.defaultLookup = new MapLookup(new HashMap<String, String>());\n         lookups.put(\"sys\", new SystemPropertiesLookup());\n         lookups.put(\"env\", new EnvironmentLookup());\n-        lookups.put(\"jndi\", new JndiLookup());\n+        if (JndiLookup.isEnableJndi()) {\n+            lookups.put(\"jndi\", new JndiLookup());\n+        }\n     }\n \n      /**\n",
  "stdout": "",
  "stderr": ""
}