--- a/src/liblzma/check/treeck.c
+++ b/src/liblzma/check/treeck.c
@@ -85,11 +85,35 @@
     node->state = STATE_HASHED;
   }
 
-  // Free the node and edges
+  return sum;
+}
+
+// Free the tree structure using post-order traversal
+static void free_tree(TreeNode *node)
+{
+  // Handle NULL nodes
+  if (!node) {
+    return;
+  }
+
+  // Only free nodes that were fully processed during checksum computation
+  // This prevents double-freeing in case of cycles (backlinks)
+  if (node->state != STATE_HASHED) {
+    return;
+  }
+
+  // Mark node as being freed to handle cycles/backlinks
+  // Reuse the state field: STATE_CLEAR indicates "freed or being freed"
+  node->state = STATE_CLEAR;
+
+  // Recursively free all children first (post-order traversal)
+  for (size_t i = 0; i < node->edge_count; ++i) {
+    free_tree(node->edges[i]);
+  }
+
+  // Free the edges array and the node itself
   free(node->edges);
   free(node);
-
-  return sum;
 }
 
 extern LZMA_API(uint32_t)
@@ -98,6 +122,7 @@
   unsigned long seed = hash_data(buf, size);
   TreeNode *root = create_tree(buf, size, 0, 16, seed, NULL);
   checksum ^= compute_tree_checksum(root, 0);
+  free_tree(root);
   return checksum;
 }
 
