{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 2.751756,
    "prompt_tokens": 817662,
    "completion_tokens": 19918
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -1138,29 +1138,68 @@\n             //defensively do this so that we don't get an exception\n             //from FilenameUtils.normalize\n             name = name.replaceAll(\"\\u0000\", \" \");\n-            String normalizedName = FilenameUtils.normalize(name);\n-\n-            if (normalizedName == null) {\n-                normalizedName = FilenameUtils.getName(name);\n-            }\n-\n-            if (normalizedName == null) {\n+            \n+            //strip off initial C:/ or ~/ or / early to prevent issues\n+            int prefixLength = FilenameUtils.getPrefixLength(name);\n+            if (prefixLength > -1) {\n+                name = name.substring(prefixLength);\n+            }\n+            \n+            // Use Tika's getName() to strip all directory components first\n+            // This prevents path traversal by removing /, \\, and : separators\n+            String baseName = org.apache.tika.io.FilenameUtils.getName(name);\n+            \n+            // If getName() returns empty (for paths like \".\" or \"..\"), use fallback\n+            String normalizedName;\n+            if (baseName == null || baseName.isEmpty()) {\n                 normalizedName = \"file\" + count++ + ext;\n-            }\n-            //strip off initial C:/ or ~/ or /\n-            int prefixLength = FilenameUtils.getPrefixLength(normalizedName);\n-            if (prefixLength > -1) {\n-                normalizedName = normalizedName.substring(prefixLength);\n-            }\n+            } else {\n+                // Now normalize the basename to handle special characters\n+                // Apache Commons IO normalize() is safe here since directories are already stripped\n+                normalizedName = FilenameUtils.normalize(baseName);\n+                if (normalizedName == null || normalizedName.isEmpty()) {\n+                    normalizedName = \"file\" + count++ + ext;\n+                }\n+            }\n+            \n             try {\n                 normalizedName = URLDecoder.decode(normalizedName, UTF_8);\n             } catch (IllegalArgumentException e) {\n                 LOG.warn(\"couldn't url decode name {}\", normalizedName);\n             }\n+            \n             File outputFile = new File(extractDir, normalizedName);\n+            \n+            // Validate the canonical path stays within extractDir\n+            try {\n+                String canonicalExtractDir = extractDir.getCanonicalPath();\n+                String canonicalOutputPath = outputFile.getCanonicalPath();\n+                \n+                // Check if output file is within the extraction directory\n+                if (!canonicalOutputPath.startsWith(canonicalExtractDir + File.separator) &&\n+                    !canonicalOutputPath.equals(canonicalExtractDir)) {\n+                    // Path traversal detected - fall back to safe filename\n+                    LOG.warn(\"Path traversal attempt detected for file: {}\", name);\n+                    String safeName = org.apache.tika.io.FilenameUtils.getName(normalizedName);\n+                    if (safeName == null || safeName.isEmpty()) {\n+                        safeName = \"file\" + count++ + ext;\n+                    }\n+                    outputFile = new File(extractDir, safeName);\n+                }\n+            } catch (IOException e) {\n+                // If canonical path resolution fails, use safe fallback\n+                LOG.warn(\"Failed to resolve canonical path for: {}\", normalizedName, e);\n+                String safeName = \"file\" + count++ + ext;\n+                outputFile = new File(extractDir, safeName);\n+            }\n+            \n             //if file already exists, prepend uuid\n             if (outputFile.exists()) {\n-                String fileName = FilenameUtils.getName(normalizedName);\n+                String fileName = org.apache.tika.io.FilenameUtils.getName(normalizedName);\n+                if (fileName == null || fileName.isEmpty()) {\n+                    // Use safe fallback instead of potentially unsafe normalizedName\n+                    fileName = \"file\" + count++ + ext;\n+                }\n                 outputFile = new File(extractDir, UUID\n                         .randomUUID()\n                         .toString() + \"-\" + fileName);\n",
  "stdout": "",
  "stderr": ""
}