--- a/epan/dissectors/packet-telnet.c
+++ b/epan/dissectors/packet-telnet.c
@@ -233,6 +233,11 @@
   uint32_t  starttls_requested_in;  /* Frame of first sender of START_TLS FOLLOWS */
   uint32_t  starttls_port;          /* Source port for first sender */
   ssize_t   vmotion_sequence_len;   /* Length of "sequence" field for VMware vSPC vMotion. */
+  uint16_t  naws_width;             /* Terminal width in columns */
+  uint16_t  naws_height;            /* Terminal height in rows */
+  uint16_t  naws_line;              /* Current line number for wrapping */
+  uint8_t  *naws_data;              /* Window buffer data */
+  bool      naws_enabled;           /* Whether NAWS is currently active */
 } telnet_conv_info_t;
 
 static void
@@ -282,6 +287,11 @@
   if (!telnet_info) {
     telnet_info = wmem_new0(wmem_file_scope(), telnet_conv_info_t);
     telnet_info->vmotion_sequence_len = -1;
+    telnet_info->naws_data = NULL;
+    telnet_info->naws_enabled = false;
+    telnet_info->naws_width = 0;
+    telnet_info->naws_height = 0;
+    telnet_info->naws_line = 0;
     conversation_add_proto_data(conversation, proto_telnet, telnet_info);
   }
   return telnet_info;
@@ -636,29 +646,55 @@
 dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,
                     int len _U_, proto_tree *tree _U_, proto_item *item _U_)
 {
-  if ( hf_telnet_naws_subopt_set )
-    wmem_free(pinfo->pool, hf_naws_data);
+  telnet_conv_info_t *telnet_info = telnet_get_session(pinfo);
+  
+  if (telnet_info->naws_data) {
+    wmem_free(wmem_file_scope(), telnet_info->naws_data);
+    telnet_info->naws_data = NULL;
+  }
+  telnet_info->naws_enabled = false;
+  telnet_info->naws_width = 0;
+  telnet_info->naws_height = 0;
+  telnet_info->naws_line = 0;
 
   return;
 }
 
 static void
-dissect_naws_subopt(packet_info *pinfo _U_, const char *optname _U_, tvbuff_t *tvb, int offset,
+dissect_naws_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb, int offset,
                     int len _U_, proto_tree *tree, proto_item *item _U_)
 {
-  hf_telnet_width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);
-  hf_telnet_height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);
-
-  hf_naws_data = (uint8_t *)wmem_alloc(pinfo->pool, hf_telnet_width * hf_telnet_height);
-
-  if ( hf_naws_data )
-    hf_telnet_naws_subopt_set = 1;
-  else
-    hf_telnet_naws_subopt_set = 0;
-
+  telnet_conv_info_t *telnet_info = telnet_get_session(pinfo);
+  
+  uint16_t width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);
+  uint16_t height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);
+  
   proto_tree_add_item(tree, hf_telnet_naws_subopt_width, tvb, offset, 2, ENC_BIG_ENDIAN);
   offset += 2;
   proto_tree_add_item(tree, hf_telnet_naws_subopt_height, tvb, offset, 2, ENC_BIG_ENDIAN);
+  
+  if (!telnet_info->naws_data || 
+      telnet_info->naws_width != width || 
+      telnet_info->naws_height != height) {
+    
+    if (telnet_info->naws_data) {
+      wmem_free(wmem_file_scope(), telnet_info->naws_data);
+      telnet_info->naws_data = NULL;
+    }
+    
+    if (width > 0 && height > 0 && width <= 1024 && height <= 1024) {
+      telnet_info->naws_data = (uint8_t *)wmem_alloc0(wmem_file_scope(), 
+                                                       (size_t)width * height);
+      telnet_info->naws_width = width;
+      telnet_info->naws_height = height;
+      telnet_info->naws_line = 0;
+      telnet_info->naws_enabled = (telnet_info->naws_data != NULL);
+    } else {
+      telnet_info->naws_enabled = false;
+      telnet_info->naws_width = 0;
+      telnet_info->naws_height = 0;
+    }
+  }
 }
 
 /* BEGIN RFC-2217 (COM Port Control) Definitions */
