{
  "project_name": "wireshark",
  "vulnerability_identifier": "wireshark_ws-full-01_vuln_002",
  "source_directory": "/home/user/crete/.cache/official-afc-wireshark",
  "llm_usage": {
    "total_cost": 2.4001680000000003,
    "prompt_tokens": 638676,
    "completion_tokens": 32276
  },
  "variant": "sound",
  "diff": "--- a/epan/dissectors/packet-telnet.c\n+++ b/epan/dissectors/packet-telnet.c\n@@ -233,6 +233,11 @@\n   uint32_t  starttls_requested_in;  /* Frame of first sender of START_TLS FOLLOWS */\n   uint32_t  starttls_port;          /* Source port for first sender */\n   ssize_t   vmotion_sequence_len;   /* Length of \"sequence\" field for VMware vSPC vMotion. */\n+  uint16_t  naws_width;             /* Terminal width in columns */\n+  uint16_t  naws_height;            /* Terminal height in rows */\n+  uint16_t  naws_line;              /* Current line number for wrapping */\n+  uint8_t  *naws_data;              /* Window buffer data */\n+  bool      naws_enabled;           /* Whether NAWS is currently active */\n } telnet_conv_info_t;\n \n static void\n@@ -282,6 +287,11 @@\n   if (!telnet_info) {\n     telnet_info = wmem_new0(wmem_file_scope(), telnet_conv_info_t);\n     telnet_info->vmotion_sequence_len = -1;\n+    telnet_info->naws_data = NULL;\n+    telnet_info->naws_enabled = false;\n+    telnet_info->naws_width = 0;\n+    telnet_info->naws_height = 0;\n+    telnet_info->naws_line = 0;\n     conversation_add_proto_data(conversation, proto_telnet, telnet_info);\n   }\n   return telnet_info;\n@@ -636,29 +646,55 @@\n dissect_linemode_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb _U_, int offset _U_,\n                     int len _U_, proto_tree *tree _U_, proto_item *item _U_)\n {\n-  if ( hf_telnet_naws_subopt_set )\n-    wmem_free(pinfo->pool, hf_naws_data);\n+  telnet_conv_info_t *telnet_info = telnet_get_session(pinfo);\n+  \n+  if (telnet_info->naws_data) {\n+    wmem_free(wmem_file_scope(), telnet_info->naws_data);\n+    telnet_info->naws_data = NULL;\n+  }\n+  telnet_info->naws_enabled = false;\n+  telnet_info->naws_width = 0;\n+  telnet_info->naws_height = 0;\n+  telnet_info->naws_line = 0;\n \n   return;\n }\n \n static void\n-dissect_naws_subopt(packet_info *pinfo _U_, const char *optname _U_, tvbuff_t *tvb, int offset,\n+dissect_naws_subopt(packet_info *pinfo, const char *optname _U_, tvbuff_t *tvb, int offset,\n                     int len _U_, proto_tree *tree, proto_item *item _U_)\n {\n-  hf_telnet_width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);\n-  hf_telnet_height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);\n-\n-  hf_naws_data = (uint8_t *)wmem_alloc(pinfo->pool, hf_telnet_width * hf_telnet_height);\n-\n-  if ( hf_naws_data )\n-    hf_telnet_naws_subopt_set = 1;\n-  else\n-    hf_telnet_naws_subopt_set = 0;\n-\n+  telnet_conv_info_t *telnet_info = telnet_get_session(pinfo);\n+  \n+  uint16_t width = tvb_get_uint16(tvb, offset, ENC_BIG_ENDIAN);\n+  uint16_t height = tvb_get_uint16(tvb, offset + 2, ENC_BIG_ENDIAN);\n+  \n   proto_tree_add_item(tree, hf_telnet_naws_subopt_width, tvb, offset, 2, ENC_BIG_ENDIAN);\n   offset += 2;\n   proto_tree_add_item(tree, hf_telnet_naws_subopt_height, tvb, offset, 2, ENC_BIG_ENDIAN);\n+  \n+  if (!telnet_info->naws_data || \n+      telnet_info->naws_width != width || \n+      telnet_info->naws_height != height) {\n+    \n+    if (telnet_info->naws_data) {\n+      wmem_free(wmem_file_scope(), telnet_info->naws_data);\n+      telnet_info->naws_data = NULL;\n+    }\n+    \n+    if (width > 0 && height > 0 && width <= 1024 && height <= 1024) {\n+      telnet_info->naws_data = (uint8_t *)wmem_alloc0(wmem_file_scope(), \n+                                                       (size_t)width * height);\n+      telnet_info->naws_width = width;\n+      telnet_info->naws_height = height;\n+      telnet_info->naws_line = 0;\n+      telnet_info->naws_enabled = (telnet_info->naws_data != NULL);\n+    } else {\n+      telnet_info->naws_enabled = false;\n+      telnet_info->naws_width = 0;\n+      telnet_info->naws_height = 0;\n+    }\n+  }\n }\n \n /* BEGIN RFC-2217 (COM Port Control) Definitions */\n",
  "stdout": "",
  "stderr": ""
}