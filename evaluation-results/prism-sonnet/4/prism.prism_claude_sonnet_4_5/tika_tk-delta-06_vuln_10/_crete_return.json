{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-06_vuln_10",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 12.941691000000004,
    "prompt_tokens": 3625827,
    "completion_tokens": 137614
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pkg-module/src/main/java/org/apache/tika/parser/pkg/PackageParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pkg-module/src/main/java/org/apache/tika/parser/pkg/PackageParser.java\n@@ -109,6 +109,11 @@\n     private static final int MARK_LIMIT = 100 * 1024 * 1024; // 100M\n     // The number of bytes of entry name to detect charset properly\n     private static final int MIN_BYTES_FOR_DETECTING_CHARSET = 100;\n+    /**\n+     * Maximum number of archive entries to process to prevent denial-of-service\n+     * attacks from archives with excessive entry counts.\n+     */\n+    private static final int MAX_ARCHIVE_ENTRIES = 100000;\n \n \n     static final Set<MediaType> loadPackageSpecializations() {\n@@ -393,6 +398,13 @@\n                     entryCnt.incrementAndGet();\n                 }\n \n+                // Check for excessive entries to prevent DoS attacks\n+                if (entryCnt.get() >= MAX_ARCHIVE_ENTRIES) {\n+                    throw new TikaException(\"Archive exceeds maximum allowed entries (\" + \n+                        MAX_ARCHIVE_ENTRIES + \"). This may indicate a malformed or \" +\n+                        \"malicious archive designed for denial-of-service.\");\n+                }\n+\n                 entry = ais.getNextEntry();\n             }\n         } catch (UnsupportedZipFeatureException zfe) {\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DefaultZipContainerDetector.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DefaultZipContainerDetector.java\n@@ -61,6 +61,12 @@\n     private static final long serialVersionUID = 2891763938430295453L;\n \n     private static final Logger LOG = LoggerFactory.getLogger(DefaultZipContainerDetector.class);\n+\n+    /**\n+     * Maximum number of entries to check during zip detection to prevent timeouts\n+     * from archives with excessive entries.\n+     */\n+    private static final int MAX_ARCHIVE_ENTRY_DETECTION = 10000;\n \n     static {\n         TIFF_SIGNATURES[0] = new byte[]{'M', 'M', 0x00, 0x2a};\n@@ -283,10 +289,15 @@\n     MediaType detectStreaming(InputStream input, Metadata metadata, boolean allowStoredEntries)\n             throws IOException {\n         StreamingDetectContext detectContext = new StreamingDetectContext();\n+        int entryCount = 0;\n         try (ZipArchiveInputStream zis = new ZipArchiveInputStream(\n                 CloseShieldInputStream.wrap(input), \"UTF8\", false, allowStoredEntries)) {\n             ZipArchiveEntry zae = zis.getNextEntry();\n             while (zae != null) {\n+                entryCount++;\n+                if (entryCount >= MAX_ARCHIVE_ENTRY_DETECTION) {\n+                    break;\n+                }\n                 MediaType mt = detect(zae, zis, detectContext);\n                 if (mt != null) {\n                     return mt;\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DeprecatedStreamingZipContainerDetector.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DeprecatedStreamingZipContainerDetector.java\n@@ -27,6 +27,10 @@\n \n     private static final int MAX_MIME_TYPE = 1024;\n     private static final int MAX_MANIFEST = 20 * 1024 * 1024;\n+    /**\n+     * Maximum number of entries to check during zip detection to prevent timeouts.\n+     */\n+    private static final int MAX_ARCHIVE_ENTRY_DETECTION = 10000;\n     /*\n      */\n \n@@ -43,10 +47,15 @@\n /*\n         Set<String> fileNames = new HashSet<>();\n         Set<String> directoryNames = new HashSet<>();\n+        int entryCount = 0;\n         try (ZipArchiveInputStream zipArchiveInputStream =\n                      new ZipArchiveInputStream(CloseShieldInputStream.wrap(is))) {\n             ZipArchiveEntry zae = zipArchiveInputStream.getNextZipEntry();\n             while (zae != null) {\n+                entryCount++;\n+                if (entryCount >= MAX_ARCHIVE_ENTRY_DETECTION) {\n+                    break;\n+                }\n                 String name = zae.getName();\n                 if (zae.isDirectory()) {\n                     directoryNames.add(name);\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-apple-module/src/main/java/org/apache/tika/parser/iwork/IWorkPackageParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-apple-module/src/main/java/org/apache/tika/parser/iwork/IWorkPackageParser.java\n@@ -72,6 +72,10 @@\n     private static final long serialVersionUID = -2160322853809682372L;\n     private static final int MARK_LIMIT = 1096;\n     /**\n+     * Maximum number of entries to process in an iWork package to prevent DoS attacks.\n+     */\n+    private static final int MAX_ARCHIVE_ENTRIES = 10000;\n+    /**\n      * This parser handles all iWorks formats.\n      */\n     private final static Set<MediaType> supportedTypes = Collections.unmodifiableSet(\n@@ -87,8 +91,15 @@\n                       ParseContext context) throws IOException, SAXException, TikaException {\n         ZipArchiveInputStream zip = new ZipArchiveInputStream(stream);\n         ZipArchiveEntry entry = zip.getNextEntry();\n+        int entryCount = 0;\n \n         while (entry != null) {\n+            entryCount++;\n+            if (entryCount >= MAX_ARCHIVE_ENTRIES) {\n+                throw new TikaException(\"Archive exceeds maximum allowed entries (\" + \n+                    MAX_ARCHIVE_ENTRIES + \"). This may indicate a malformed or \" +\n+                    \"malicious archive.\");\n+            }\n             if (!IWORK_CONTENT_ENTRIES.contains(entry.getName())) {\n                 entry = zip.getNextEntry();\n                 continue;\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/CellFormatter.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/CellFormatter.java\n@@ -36,6 +36,13 @@\n             Pattern.compile(\"([+-])?(\\\\d{0,20}(?:\\\\.\\\\d{0,20})?) \" +\n             \"&fraction_format=\\\"(?:(#{1,20}) )?(#{1,20})/(#{1,20})\\\"\");\n \n+    /**\n+     * Maximum denominator format length to prevent excessive computation.\n+     * With MAX_DENOM_LENGTH=3, the nested loops will have at most ~1,000,000 iterations,\n+     * which completes in milliseconds. Larger values cause timeouts during fuzzing.\n+     */\n+    private static final int MAX_DENOM_LENGTH = 3;\n+\n     private final Matcher fractionFormatMatcher = FRACTION_FORMAT.matcher(\"\");\n     String format(String cell) {\n         if (cell == null) {\n@@ -60,6 +67,11 @@\n         double wholePart = Math.floor(Math.abs(val));\n         double decPart = Math.abs(val) - wholePart;\n         int denomLength = denomFormat.length();\n+\n+        // Cap denomLength to prevent exponential computation in nested loops\n+        if (denomLength > MAX_DENOM_LENGTH) {\n+            return cell;\n+        }\n \n         double minVal = 1.0;\n         double currDenom = Math.pow(10, denomLength) - 1d;\n",
  "stdout": "",
  "stderr": ""
}