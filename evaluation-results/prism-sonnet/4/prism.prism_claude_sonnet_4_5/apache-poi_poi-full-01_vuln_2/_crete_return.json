{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 1.7922390000000001,
    "prompt_tokens": 528383,
    "completion_tokens": 13806
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -24,6 +24,7 @@\n import java.nio.file.Files;\n import java.nio.file.Paths;\n import java.util.Iterator;\n+import java.util.regex.Pattern;\n \n import org.apache.poi.poifs.common.POIFSConstants;\n import org.apache.poi.poifs.filesystem.DirectoryEntry;\n@@ -72,7 +73,7 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                File file = validateAndCreateFile(dumpDir.getCanonicalFile(), root.getName());\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -105,12 +106,13 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                File safeFile = validateAndCreateFile(parent, node.getName().trim());\n+                try (OutputStream out = Files.newOutputStream(safeFile.toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                File file = validateAndCreateFile(parent, entry.getName());\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -121,7 +123,7 @@\n         }\n     }\n     public static void dump(POIFSFileSystem fs, int startBlock, String name, File parent) throws IOException {\n-        File file = new File(parent, name);\n+        File file = validateAndCreateFile(parent, name);\n         if (! Files.isDirectory(file.toPath().getParent())) {\n             Files.createDirectories(file.toPath().getParent());\n         }\n@@ -136,4 +138,42 @@\n             }\n         }\n     }\n+\n+    private static final Pattern PATH_TRAVERSAL_PATTERN = Pattern.compile(\"\\\\.\\\\.[\\\\\\\\/]|[\\\\\\\\/]\\\\.\\\\.|^\\\\.\\\\.$\");\n+\n+    /**\n+     * Validates and creates a File object, preventing path traversal attacks.\n+     * \n+     * @param parent the parent directory\n+     * @param childName the name of the child file or directory from POIFS entry\n+     * @return a validated File object\n+     * @throws IOException if path traversal is detected or validation fails\n+     */\n+    private static File validateAndCreateFile(File parent, String childName) throws IOException {\n+        if (childName == null || childName.isEmpty()) {\n+            throw new IOException(\"Child name cannot be null or empty\");\n+        }\n+\n+        String sanitizedName = childName;\n+        sanitizedName = sanitizedName.replace(\"..\", \"_\");\n+        sanitizedName = sanitizedName.replace('/', '_');\n+        sanitizedName = sanitizedName.replace('\\\\', '_');\n+\n+        if (PATH_TRAVERSAL_PATTERN.matcher(childName).find()) {\n+            throw new IOException(\"Path traversal detected in entry name: \" + childName);\n+        }\n+\n+        File candidate = new File(parent, sanitizedName);\n+\n+        String parentCanonical = parent.getCanonicalPath();\n+        String candidateCanonical = candidate.getCanonicalPath();\n+\n+        if (!candidateCanonical.startsWith(parentCanonical + File.separator) && \n+            !candidateCanonical.equals(parentCanonical)) {\n+            throw new IOException(\"Path traversal detected: entry '\" + childName + \n+                                \"' would create file outside parent directory: \" + candidateCanonical);\n+        }\n+\n+        return candidate;\n+    }\n }\n",
  "stdout": "",
  "stderr": ""
}