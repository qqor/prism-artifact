{
  "project_name": "apache-commons-compress",
  "vulnerability_identifier": "apache-commons-compress_cc-delta-02_vuln_9",
  "source_directory": "/home/user/crete/.cache/official-afc-commons-compress",
  "llm_usage": {
    "total_cost": 3.471732,
    "prompt_tokens": 981074,
    "completion_tokens": 35234
  },
  "variant": "sound",
  "diff": "--- a/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n+++ b/src/main/java/org/apache/commons/compress/compressors/z/ZCompressorInputStream.java\n@@ -80,6 +80,10 @@\n         }\n         blockMode = (thirdByte & BLOCK_MODE_MASK) != 0;\n         maxCodeSize = thirdByte & MAX_CODE_SIZE_MASK;\n+        if (maxCodeSize < 9 || maxCodeSize > 16) {\n+            throw new IllegalArgumentException(\"Invalid maxCodeSize of \" + maxCodeSize + \n+                \". Values must be in the range [9, 16] for .Z format.\");\n+        }\n         if (blockMode) {\n             setClearCode(DEFAULT_CODE_SIZE);\n         }\n\n--- a/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java\n+++ b/src/main/java/org/apache/commons/compress/compressors/lzw/LZWInputStream.java\n@@ -178,9 +178,9 @@\n     protected void initializeTables(final int maxCodeSize) {\n         // maxCodeSize shifted cannot be less than 256, otherwise the loop in initializeTables() will throw an ArrayIndexOutOfBoundsException\n         // maxCodeSize cannot be smaller than getCodeSize(), otherwise addEntry() will throw an ArrayIndexOutOfBoundsException\n-        if (1 << maxCodeSize < 256 || getCodeSize() > maxCodeSize) {\n-            // TODO test against prefixes.length and characters.length?\n-            throw new IllegalArgumentException(\"maxCodeSize \" + maxCodeSize + \" is out of bounds.\");\n+        if (maxCodeSize < 8 || maxCodeSize > 31 || getCodeSize() > maxCodeSize) {\n+            throw new IllegalArgumentException(\"maxCodeSize \" + maxCodeSize + \n+                \" is out of bounds. Valid range is [8, 31] and must be >= current code size.\");\n         }\n         final int maxTableSize = 1 << maxCodeSize;\n         prefixes = new int[maxTableSize];\n@@ -207,16 +207,27 @@\n             throw new IllegalArgumentException(\"maxCodeSize is \" + maxCodeSize + \", must be bigger than 0\");\n         }\n \n-        if (memoryLimiKiB > -1) {\n-            final int maxTableSize = 1 << maxCodeSize;\n-            // account for potential overflow\n-            final long memoryUsageBytes = (long) maxTableSize * 6; // (4 (prefixes) + 1 (characters) +1 (outputStack))\n-            final long memoryUsageKiB = memoryUsageBytes >> 10;\n-\n-            if (memoryUsageKiB > memoryLimiKiB) {\n-                throw new MemoryLimitException(memoryUsageKiB, memoryLimiKiB);\n-            }\n-        }\n+        // Define a reasonable default memory limit: 100 MB\n+        // This allows maxCodeSize up to ~16-17, which is sufficient for most legitimate files\n+        final int DEFAULT_MEMORY_LIMIT_KIB = 102400; // 100 MB\n+        \n+        // Use the default limit when no limit is specified\n+        final int effectiveMemoryLimit = (memoryLimiKiB == -1) ? DEFAULT_MEMORY_LIMIT_KIB : memoryLimiKiB;\n+        \n+        // Prevent overflow in calculation by using long\n+        if (maxCodeSize > 31) {\n+            throw new IllegalArgumentException(\"maxCodeSize \" + maxCodeSize + \n+                \" is too large and would cause overflow. Maximum allowed is 31.\");\n+        }\n+        \n+        final long maxTableSize = 1L << maxCodeSize;\n+        final long memoryUsageBytes = maxTableSize * 6; // (4 for prefixes + 1 for characters + 1 for outputStack)\n+        final long memoryUsageKiB = memoryUsageBytes >> 10;\n+\n+        if (memoryUsageKiB > effectiveMemoryLimit) {\n+            throw new MemoryLimitException(memoryUsageKiB, effectiveMemoryLimit);\n+        }\n+        \n         initializeTables(maxCodeSize);\n     }\n \n",
  "stdout": "",
  "stderr": ""
}