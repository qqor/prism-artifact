{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_0",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 1.738671,
    "prompt_tokens": 488762,
    "completion_tokens": 18159
  },
  "variant": "sound",
  "diff": "--- a/poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java\n+++ b/poi-scratchpad/src/main/java/org/apache/poi/hmef/attribute/MAPIAttribute.java\n@@ -165,10 +165,8 @@\n                } else {\n                   // Custom name was stored\n                   int mplen = LittleEndian.readInt(inp);\n-                  if (mplen < 0) {\n-                     throw new IOException(\"Did not expect negative value: \" + mplen);\n-                  }\n-                  byte[] mpdata = new byte[mplen];\n+\n+                  byte[] mpdata = IOUtils.safelyAllocate(mplen, MAX_RECORD_LENGTH);\n                   if (IOUtils.readFully(inp, mpdata) < 0) {\n                      throw new IOException(\"Not enough data to read \" + mplen + \" bytes for attribute name\");\n                   }\n@@ -187,6 +185,7 @@\n             int values = 1;\n             if(isMV || isVL) {\n                values = LittleEndian.readInt(inp);\n+               IOUtils.safelyAllocateCheck(values, MAX_RECORD_COUNT);\n             }\n \n             if (type == Types.NULL && values > 1) {\n@@ -196,7 +195,9 @@\n             for(int j=0; j<values; j++) {\n                int len = getLength(type, inp);\n                byte[] data = IOUtils.safelyAllocate(len, MAX_RECORD_LENGTH);\n-               inp.read(data);\n+               if (IOUtils.readFully(inp, data) < 0) {\n+                  throw new IOException(\"Not enough data to read \" + len + \" bytes of attribute value\");\n+               }\n                skipToBoundary(len, inp);\n \n                // Create\n@@ -237,7 +238,10 @@\n       // Data is always padded out to a 4 byte boundary\n       if(length % 4 != 0) {\n          int toSkip = 4 - (length % 4);\n-         inp.skip(toSkip);\n+         long skipped = IOUtils.skipFully(inp, toSkip);\n+         if (skipped != toSkip) {\n+            throw new IOException(\"tried to skip \"+toSkip +\" but only skipped:\"+skipped);\n+         }\n       }\n    }\n }\n",
  "stdout": "",
  "stderr": ""
}