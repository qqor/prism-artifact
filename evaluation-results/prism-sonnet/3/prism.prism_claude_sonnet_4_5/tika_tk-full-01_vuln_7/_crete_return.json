{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_7",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 4.457669999999999,
    "prompt_tokens": 1221800,
    "completion_tokens": 52818
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVConfig.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVConfig.java\n@@ -41,6 +41,38 @@\n     private Map<String, Character> nameToDelimiterMap = NAME_TO_DELIMITER_MAP;\n     private Map<Character, String> delimiterToNameMap = DELIMITER_TO_NAME_MAP;\n \n+    /**\n+     * If <code>false</code> (the default), hyperlink URLs found in HYPERLINK formulas\n+     * will be extracted and rendered as HTML anchor tags, but the actual URL content\n+     * will NOT be fetched or parsed.\n+     * <p/>\n+     * If <code>true</code>, the parser will attempt to fetch and parse the content\n+     * from URLs found in HYPERLINK formulas. Even when enabled, only HTTP and HTTPS\n+     * protocols are permitted for security reasons.\n+     * <p/>\n+     * <b>SECURITY WARNING:</b> Setting this to <code>true</code> can expose your\n+     * application to Server Side Request Forgery (SSRF) attacks. Malicious CSV files\n+     * could contain URLs that:\n+     * <ul>\n+     * <li>Access internal network resources (e.g., http://localhost/admin)</li>\n+     * <li>Exfiltrate data to external servers</li>\n+     * <li>Scan internal ports and services</li>\n+     * <li>Exploit internal services via crafted requests</li>\n+     * </ul>\n+     * <p/>\n+     * Set to <code>true</code> only with the greatest caution and only when:\n+     * <ul>\n+     * <li>You trust the source of all CSV files being processed</li>\n+     * <li>You have implemented additional security controls (URL allowlists, network isolation, etc.)</li>\n+     * <li>You understand and accept the SSRF risks</li>\n+     * </ul>\n+     * <p/>\n+     * The default is <code>false</code>.\n+     * \n+     * @since Apache Tika 4.0\n+     */\n+    private boolean fetchHyperlinkContent = false;\n+\n     public Map<String, Character> getNameToDelimiterMap() {\n         return nameToDelimiterMap;\n     }\n@@ -55,4 +87,27 @@\n         nameToDelimiterMap.entrySet()\n                           .forEach(e -> delimiterToNameMap.put(e.getValue(), e.getKey()));\n     }\n+\n+    /**\n+     * @see #setFetchHyperlinkContent(boolean)\n+     */\n+    public boolean isFetchHyperlinkContent() {\n+        return fetchHyperlinkContent;\n+    }\n+\n+    /**\n+     * Controls whether URLs in HYPERLINK formulas should be fetched and parsed.\n+     * <p/>\n+     * <b>SECURITY WARNING:</b> Setting this to <code>true</code> exposes your\n+     * application to Server Side Request Forgery (SSRF) attacks. See field\n+     * documentation for full security implications.\n+     * <p/>\n+     * The default is <code>false</code>.\n+     * \n+     * @param fetchHyperlinkContent whether to fetch and parse hyperlink URLs\n+     * @see #isFetchHyperlinkContent()\n+     */\n+    public void setFetchHyperlinkContent(boolean fetchHyperlinkContent) {\n+        this.fetchHyperlinkContent = fetchHyperlinkContent;\n+    }\n }\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java\n@@ -39,6 +39,8 @@\n import org.apache.commons.csv.CSVParser;\n import org.apache.commons.csv.CSVRecord;\n import org.apache.commons.io.input.CloseShieldInputStream;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.xml.sax.ContentHandler;\n import org.xml.sax.SAXException;\n \n@@ -79,6 +81,8 @@\n  * </p>\n  */\n public class TextAndCSVParser extends AbstractEncodingDetectorParser {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(TextAndCSVParser.class);\n \n     static final MediaType CSV = MediaType.text(\"csv\");\n     static final MediaType TSV = MediaType.text(\"tsv\");\n@@ -258,7 +262,20 @@\n             xhtml.startElement(\"a\", \"href\", url);\n             xhtml.characters(name);\n             xhtml.endElement(\"a\");\n-            processURL(url, name, xhtml, metadata, context);\n+            \n+            // Retrieve configuration to check if URL fetching is enabled\n+            TextAndCSVConfig config = context.get(TextAndCSVConfig.class, new TextAndCSVConfig());\n+            \n+            // Only fetch URL content if explicitly configured AND allowed by embedded document extractor\n+            if (config.isFetchHyperlinkContent()) {\n+                EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n+                Metadata hyperlinkMetadata = new Metadata();\n+                hyperlinkMetadata.set(TikaCoreProperties.RESOURCE_NAME_KEY, name);\n+                \n+                if (ex.shouldParseEmbedded(hyperlinkMetadata)) {\n+                    processURL(url, name, xhtml, metadata, context);\n+                }\n+            }\n         } else {\n             xhtml.characters(cellContent);\n         }\n@@ -271,8 +288,21 @@\n         EmbeddedDocumentExtractor ex = EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n         Metadata metadata = new Metadata();\n         metadata.set(TikaCoreProperties.RESOURCE_NAME_KEY, name);\n+        \n         try {\n             URL url = new URL(urlString);\n+            \n+            // Validate URL scheme to prevent SSRF attacks - only allow HTTP/HTTPS\n+            String protocol = url.getProtocol();\n+            if (!\"http\".equalsIgnoreCase(protocol) && !\"https\".equalsIgnoreCase(protocol)) {\n+                LOG.warn(\"Blocked attempt to fetch content from non-HTTP(S) URL in HYPERLINK formula. \" +\n+                         \"Protocol '{}' is not allowed. URL: {}\", protocol, urlString);\n+                parentMetadata.set(TikaCoreProperties.EMBEDDED_EXCEPTION,\n+                        \"URL protocol '\" + protocol + \"' is not allowed for security reasons. \" +\n+                        \"Only HTTP and HTTPS protocols are permitted.\");\n+                return;\n+            }\n+            \n             URLConnection connection = url.openConnection();\n             connection.setConnectTimeout(5000);\n             try (TikaInputStream tis = TikaInputStream.get(connection.getInputStream())) {\n",
  "stdout": "",
  "stderr": ""
}