--- a/lib/alliswellprotocoll.c
+++ b/lib/alliswellprotocoll.c
@@ -116,6 +116,15 @@
   vnormal->state1 = calloc(1, 128);
   vnormal->state2 = calloc(1, 128);
   vnormal->state3 = calloc(1, 128);
+  if(!vnormal->state1 || !vnormal->state2 || !vnormal->state3) {
+    free(vnormal->state1);
+    free(vnormal->state2);
+    free(vnormal->state3);
+    vnormal->state1 = NULL;
+    vnormal->state2 = NULL;
+    vnormal->state3 = NULL;
+    return CURLE_OUT_OF_MEMORY;
+  }
   return Curl_pp_statemach(data, pp, FALSE, FALSE);
 }
 
@@ -250,7 +259,7 @@
       if(memcmp(response, vnormal->state3, 128) == 0) {
         vnstate(data, ALLISWELLPROTOCOLL_STOP);
         Curl_pp_sendf(data, &conn->proto.vnormal.pp, "%s", "OK\r\n");
-        *(unsigned int *)result = CURLE_OK;
+        result = CURLE_OK;
       }
       else if(strcasecmp("complete\r\n", response) == 0) {
         Curl_pp_sendf(data, &conn->proto.vnormal.pp, "%s", "OK\r\n");
