{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-04_vuln_5",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 3.1601909999999998,
    "prompt_tokens": 866752,
    "completion_tokens": 37329
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pkg-module/src/main/java/org/apache/tika/parser/pkg/PackageParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pkg-module/src/main/java/org/apache/tika/parser/pkg/PackageParser.java\n@@ -65,6 +65,7 @@\n import org.apache.tika.exception.TikaException;\n import org.apache.tika.extractor.EmbeddedDocumentExtractor;\n import org.apache.tika.extractor.EmbeddedDocumentUtil;\n+import org.apache.tika.io.FilenameUtils;\n import org.apache.tika.io.TemporaryResources;\n import org.apache.tika.io.TikaInputStream;\n import org.apache.tika.metadata.Metadata;\n@@ -219,15 +220,23 @@\n             entrydata.set(Metadata.CONTENT_LENGTH, Long.toString(size));\n         }\n         if (name != null && name.length() > 0) {\n-            name = name.replace(\"\\\\\", \"/\");\n-            entrydata.set(TikaCoreProperties.RESOURCE_NAME_KEY, name);\n+            String originalName = name.replace(\"\\\\\", \"/\");\n+            String sanitizedName = FilenameUtils.getName(originalName);\n+            \n+            if (sanitizedName == null || sanitizedName.isEmpty()) {\n+                sanitizedName = \"file\";\n+            }\n+            \n+            entrydata.set(TikaCoreProperties.RESOURCE_NAME_KEY, sanitizedName);\n+            entrydata.set(TikaCoreProperties.ORIGINAL_RESOURCE_NAME, originalName);\n+            \n             AttributesImpl attributes = new AttributesImpl();\n             attributes.addAttribute(\"\", \"class\", \"class\", \"CDATA\", \"embedded\");\n-            attributes.addAttribute(\"\", \"id\", \"id\", \"CDATA\", name);\n+            attributes.addAttribute(\"\", \"id\", \"id\", \"CDATA\", sanitizedName);\n             xhtml.startElement(\"div\", attributes);\n             xhtml.endElement(\"div\");\n \n-            entrydata.set(TikaCoreProperties.EMBEDDED_RELATIONSHIP_ID, name);\n+            entrydata.set(TikaCoreProperties.EMBEDDED_RELATIONSHIP_ID, sanitizedName);\n         }\n         return entrydata;\n     }\n\n--- a/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n+++ b/tika-pipes/tika-emitters/tika-emitter-fs/src/main/java/org/apache/tika/pipes/emitter/fs/FileSystemEmitter.java\n@@ -85,6 +85,22 @@\n         }\n         if (basePath != null) {\n             output = basePath.resolve(emitKey);\n+            \n+            try {\n+                Path realOutput = output.toRealPath();\n+                Path realBase = basePath.toRealPath();\n+                if (!realOutput.startsWith(realBase)) {\n+                    throw new TikaEmitterException(\n+                        \"Path escapes base directory. EmitKey: \" + emitKey);\n+                }\n+            } catch (IOException e) {\n+                Path normalizedOutput = output.normalize().toAbsolutePath();\n+                Path normalizedBase = basePath.normalize().toAbsolutePath();\n+                if (!normalizedOutput.startsWith(normalizedBase)) {\n+                    throw new TikaEmitterException(\n+                        \"Path escapes base directory. EmitKey: \" + emitKey);\n+                }\n+            }\n         } else {\n             output = Paths.get(emitKey);\n         }\n",
  "stdout": "",
  "stderr": ""
}