{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_8",
  "source_directory": "/home/user/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 3.3608249999999993,
    "prompt_tokens": 951700,
    "completion_tokens": 33715
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java\n+++ b/tika-core/src/main/java/org/apache/tika/detect/ShellCodeDetector.java\n@@ -41,7 +41,30 @@\n import org.apache.tika.utils.StringUtils;\n \n /**\n- * Simple detector to determine if a shell script is no-arg shell script.\n+ * Simple detector to determine if a shell script is a no-arg shell script.\n+ * \n+ * <p><strong>SECURITY WARNING - DISABLED BY DEFAULT:</strong> This detector executes shell \n+ * scripts to test if they can run without arguments. This poses a <strong>CRITICAL SECURITY \n+ * RISK</strong> when processing untrusted input, as it can lead to <strong>REMOTE CODE \n+ * EXECUTION</strong>.</p>\n+ * \n+ * <p>By default, this detector operates in <strong>safe mode</strong>, which only detects \n+ * shell scripts by filename extension (.sh, .bash) and shebang patterns (#!/...), but does \n+ * NOT execute them. This provides shell script detection without security risks.</p>\n+ * \n+ * <p>To enable <strong>full mode</strong> with execution (for TRUSTED content ONLY):</p>\n+ * <ol>\n+ *   <li>Set the system property: <code>-Dtika.detector.shell.enable=true</code></li>\n+ *   <li>Only process files from <strong>TRUSTED SOURCES</strong></li>\n+ * </ol>\n+ * \n+ * <p><strong>DO NOT ENABLE FULL MODE</strong> when processing files from untrusted sources \n+ * such as user uploads, email attachments, or downloaded files.</p>\n+ * \n+ * <p><strong>Safe Mode Capabilities:</strong> Detects shell scripts and returns \n+ * MediaType.application(\"x-sh\")</p>\n+ * <p><strong>Full Mode Additions:</strong> Executes scripts to determine if they run without \n+ * arguments and sets the SHELL_NO_ARGS metadata property</p>\n  */\n public class ShellCodeDetector implements Detector {\n \n@@ -84,6 +107,16 @@\n         if (StringUtils.isBlank(fileName)) {\n             return isShell(isShell);\n         }\n+        \n+        // Security guard: Disable execution by default due to critical security risk\n+        // This detector executes shell scripts to test if they run without arguments,\n+        // which allows remote code execution when processing untrusted files.\n+        // Set -Dtika.detector.shell.enable=true to enable execution for TRUSTED content only.\n+        if (!Boolean.getBoolean(\"tika.detector.shell.enable\")) {\n+            // Return SHELL_SCRIPT to preserve detection capability while skipping execution\n+            return SHELL_SCRIPT;\n+        }\n+        \n         //now test for no-arg shell script\n         TikaInputStream tis = TikaInputStream.get(CloseShieldInputStream.wrap(input));\n         fileName = FilenameUtils.getName(fileName);\n",
  "stdout": "",
  "stderr": ""
}