{
  "project_name": "apache-poi",
  "vulnerability_identifier": "apache-poi_poi-full-01_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-poi",
  "llm_usage": {
    "total_cost": 2.262045,
    "prompt_tokens": 633275,
    "completion_tokens": 24148
  },
  "variant": "sound",
  "diff": "--- a/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n+++ b/poi/src/main/java/org/apache/poi/poifs/dev/POIFSDump.java\n@@ -72,7 +72,7 @@\n                 File dumpDir =\n                         Paths.get(filename).getParent()\n                                 .resolve(filenameWithoutPath + \"_dump\").toFile();\n-                File file = new File(dumpDir, root.getName());\n+                File file = new File(dumpDir, sanitizeEntryName(root.getName()));\n                 if (!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n@@ -95,6 +95,48 @@\n             }\n         }\n     }\n+    /**\n+     * Sanitizes an entry name to prevent path traversal attacks.\n+     * Removes or replaces path separators, parent directory references,\n+     * and other potentially dangerous characters.\n+     * \n+     * @param name the entry name to sanitize\n+     * @return a safe filename that cannot escape the parent directory\n+     */\n+    private static String sanitizeEntryName(String name) {\n+        if (name == null || name.isEmpty()) {\n+            return \"unnamed\";\n+        }\n+        \n+        name = name.trim();\n+        \n+        if (name.isEmpty()) {\n+            return \"unnamed\";\n+        }\n+        \n+        StringBuilder result = new StringBuilder();\n+        for (int i = 0; i < name.length(); i++) {\n+            char ch = name.charAt(i);\n+            if (ch == '/' || ch == '\\\\' || ch == ':' || ch < 32 || ch == 127) {\n+                result.append('_');\n+            } else {\n+                result.append(ch);\n+            }\n+        }\n+        \n+        String sanitized = result.toString();\n+        \n+        while (sanitized.contains(\"..\")) {\n+            sanitized = sanitized.replace(\"..\", \"__\");\n+        }\n+        \n+        sanitized = sanitized.trim();\n+        if (sanitized.isEmpty()) {\n+            return \"unnamed\";\n+        }\n+        \n+        return sanitized;\n+    }\n     \n     public static void dump(DirectoryEntry root, File parent) throws IOException {\n         for(Iterator<Entry> it = root.getEntries(); it.hasNext();){\n@@ -105,12 +147,12 @@\n                 try (DocumentInputStream is = new DocumentInputStream(node)) {\n                    bytes = IOUtils.toByteArray(is);\n                 }\n-                try (OutputStream out = Files.newOutputStream(new File(parent, node.getName().trim()).toPath())) {\n+                try (OutputStream out = Files.newOutputStream(new File(parent, sanitizeEntryName(node.getName())).toPath())) {\n                     out.write(bytes);\n                 }\n             } else if (entry instanceof DirectoryEntry){\n                 DirectoryEntry dir = (DirectoryEntry)entry;\n-                File file = new File(parent, entry.getName());\n+                File file = new File(parent, sanitizeEntryName(entry.getName()));\n                 if(!file.exists() && !file.mkdirs()) {\n                     throw new IOException(\"Could not create directory \" + file);\n                 }\n",
  "stdout": "",
  "stderr": ""
}