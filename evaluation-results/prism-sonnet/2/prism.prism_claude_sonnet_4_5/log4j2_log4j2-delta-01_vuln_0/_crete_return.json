{
  "project_name": "log4j2",
  "vulnerability_identifier": "log4j2_log4j2-delta-01_vuln_0",
  "source_directory": "/home/user/crete/.cache/official-afc-logging-log4j2",
  "llm_usage": {
    "total_cost": 1.7992800000000002,
    "prompt_tokens": 483725,
    "completion_tokens": 23207
  },
  "variant": "sound",
  "diff": "--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java\n@@ -19,8 +19,11 @@\n import javax.naming.InitialContext;\n import javax.naming.NamingException;\n \n+import org.apache.logging.log4j.Logger;\n import org.apache.logging.log4j.core.LogEvent;\n import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.status.StatusLogger;\n+import org.apache.logging.log4j.util.PropertiesUtil;\n \n /**\n  * Looks up keys from JNDI resources.\n@@ -28,7 +31,10 @@\n @Plugin(name = \"jndi\", category = \"Lookup\")\n public class JndiLookup implements StrLookup {\n \n-    private static boolean ENABLE_JNDI = true;\n+    private static final Logger LOGGER = StatusLogger.getLogger();\n+\n+    private static final boolean ENABLE_JNDI = PropertiesUtil.getProperties()\n+        .getBooleanProperty(\"log4j2.enableJndi\", false);\n \n     /** JNDI resourcce path prefix used in a J2EE container */\n     static final String CONTAINER_JNDI_RESOURCE_PATH_PREFIX = \"java:comp/env/\";\n@@ -51,7 +57,12 @@\n      */\n     @Override\n     public String lookup(final LogEvent event, final String key) {\n-        if (key == null || ! ENABLE_JNDI) {\n+        if (key == null || !ENABLE_JNDI) {\n+            return null;\n+        }\n+\n+        if (!isAllowedJndiUrl(key)) {\n+            LOGGER.warn(\"Invalid JNDI URI - {}\", key);\n             return null;\n         }\n \n@@ -64,6 +75,23 @@\n     }\n \n     /**\n+     * Validates that the JNDI name is allowed for lookup.\n+     * Only allows local Java JNDI resources, blocks remote URLs.\n+     * \n+     * @param jndiName The JNDI name to validate\n+     * @return true if the JNDI name is allowed, false otherwise\n+     */\n+    private boolean isAllowedJndiUrl(String jndiName) {\n+        if (jndiName.contains(\"://\")) {\n+            return false;\n+        }\n+        if (jndiName.contains(\":\") && !jndiName.startsWith(\"java:\")) {\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    /**\n      * Convert the given JNDI name to the actual JNDI name to use.\n      * Default implementation applies the \"java:comp/env/\" prefix\n      * unless other scheme like \"java:\" is given.\n@@ -71,7 +99,8 @@\n      * @return The fully qualified name to look up.\n      */\n     private String convertJndiName(String jndiName) {\n-        if (!jndiName.startsWith(CONTAINER_JNDI_RESOURCE_PATH_PREFIX) && jndiName.indexOf(':') == -1) {\n+        if (!jndiName.startsWith(CONTAINER_JNDI_RESOURCE_PATH_PREFIX) && \n+            !jndiName.startsWith(\"java:\")) {\n             jndiName = CONTAINER_JNDI_RESOURCE_PATH_PREFIX + jndiName;\n         }\n \n@@ -79,7 +108,6 @@\n     }\n \n     public static void setEnableJndi(boolean enableJndi) {\n-        ENABLE_JNDI = enableJndi;\n     }\n \n     public static boolean isEnableJndi() {\n\n--- a/core/src/main/java/org/apache/logging/log4j/core/lookup/Interpolator.java\n+++ b/core/src/main/java/org/apache/logging/log4j/core/lookup/Interpolator.java\n@@ -63,7 +63,6 @@\n         this.defaultLookup = new MapLookup(new HashMap<String, String>());\n         lookups.put(\"sys\", new SystemPropertiesLookup());\n         lookups.put(\"env\", new EnvironmentLookup());\n-        lookups.put(\"jndi\", new JndiLookup());\n     }\n \n      /**\n",
  "stdout": "",
  "stderr": ""
}