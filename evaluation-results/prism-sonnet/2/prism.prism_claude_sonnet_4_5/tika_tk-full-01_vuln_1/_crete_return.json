{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-full-01_vuln_1",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 4.506624000000001,
    "prompt_tokens": 1250728,
    "completion_tokens": 50296
  },
  "variant": "sound",
  "diff": "--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFParser.java\n@@ -55,6 +55,8 @@\n     private int memoryLimitInKb = EMB_OBJ_MAX_BYTES / 1024;\n     @Field\n     private boolean ignoreListMarkup = false;\n+    @Field\n+    private boolean allowJavaSerializedObjects = false;\n \n     public Set<MediaType> getSupportedTypes(ParseContext context) {\n         return SUPPORTED_TYPES;\n@@ -90,7 +92,7 @@\n     public void parseInline(InputStream is, ContentHandler handler, Metadata metadata, ParseContext context)\n             throws TikaException, IOException, SAXException {\n         RTFEmbObjHandler embObjHandler =\n-                new RTFEmbObjHandler(handler, metadata, context, getMemoryLimitInKb());\n+                new RTFEmbObjHandler(handler, metadata, context, getMemoryLimitInKb(), allowJavaSerializedObjects);\n         final TextExtractor ert = new TextExtractor(handler, metadata, embObjHandler);\n         ert.setIgnoreListMarkup(ignoreListMarkup);\n         ert.extract(is);\n@@ -112,4 +114,13 @@\n         this.memoryLimitInKb = memoryLimitInKb;\n         USE_STATIC = false;\n     }\n+\n+    public boolean isAllowJavaSerializedObjects() {\n+        return allowJavaSerializedObjects;\n+    }\n+\n+    @Field\n+    public void setAllowJavaSerializedObjects(boolean allowJavaSerializedObjects) {\n+        this.allowJavaSerializedObjects = allowJavaSerializedObjects;\n+    }\n }\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/parser/microsoft/rtf/RTFEmbObjHandler.java\n@@ -67,6 +67,7 @@\n     private final EmbeddedDocumentUtil embeddedDocumentUtil;\n     private final UnsynchronizedByteArrayOutputStream os;\n     private final int memoryLimitInKb;\n+    private final boolean allowJavaSerializedObjects;\n \n     private boolean isPictBitmap = false;\n     //high hex cached for writing hexpair chars (data)\n@@ -82,11 +83,12 @@\n     private EMB_STATE state = EMB_STATE.NADA;\n \n     protected RTFEmbObjHandler(ContentHandler handler, Metadata metadata, ParseContext context,\n-                               int memoryLimitInKb) {\n+                               int memoryLimitInKb, boolean allowJavaSerializedObjects) {\n         this.handler = handler;\n         this.embeddedDocumentUtil = new EmbeddedDocumentUtil(context);\n         os = UnsynchronizedByteArrayOutputStream.builder().get();\n         this.memoryLimitInKb = memoryLimitInKb;\n+        this.allowJavaSerializedObjects = allowJavaSerializedObjects;\n     }\n \n     protected void startPict() {\n@@ -211,6 +213,12 @@\n             extractObj(bytes, handler, metadata);\n \n         } else if (state == EMB_STATE.JAVA_OBJDATA) {\n+            if (!allowJavaSerializedObjects) {\n+                throw new TikaException(\n+                        \"Java object deserialization is disabled for security reasons. \" +\n+                        \"Deserializing untrusted data may enable remote code execution. \" +\n+                        \"Set allowJavaSerializedObjects=true in RTFParser configuration to enable this feature.\");\n+            }\n             try {\n                 Object obj = new ObjectInputStream(\n                         UnsynchronizedByteArrayInputStream.builder().setByteArray(bytes)\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/test/java/org/apache/tika/parser/microsoft/rtf/RTFParserTest.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/test/java/org/apache/tika/parser/microsoft/rtf/RTFParserTest.java\n@@ -515,13 +515,17 @@\n \n     @Test\n     public void testJavaObj(@TempDir Path tmpDir) throws Exception {\n+        RTFParser parser = new RTFParser();\n+        parser.setAllowJavaSerializedObjects(true);\n+        \n         String rtf = IOUtils.resourceToString(\"/test-documents/rtf/rtfJavaObjTemplate.rtf\",\n                 StandardCharsets.UTF_8);\n         String s = new String(\"the quick brown fox\");\n         rtf = writeObject(s, rtf);\n         Path p = tmpDir.resolve(\"test.rtf\");\n         Files.write(p, rtf.getBytes(StandardCharsets.UTF_8));\n-        List<Metadata> metadata = getRecursiveMetadata(p);\n+        \n+        List<Metadata> metadata = getRecursiveMetadata(p, parser, false);\n         assertEquals(2, metadata.size());\n         assertEquals(\"java.lang.String\", metadata.get(1).get(RTFMetadata.EMB_CLASS));\n         assertContains(\"the quick brown fox\", metadata.get(1).get(TikaCoreProperties.TIKA_CONTENT));\n",
  "stdout": "",
  "stderr": ""
}