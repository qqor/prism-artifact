{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-05_vuln_2",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 1.9829820000000002,
    "prompt_tokens": 568529,
    "completion_tokens": 18493
  },
  "variant": "sound",
  "diff": "--- a/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n+++ b/tika-app/src/main/java/org/apache/tika/cli/TikaCLI.java\n@@ -1136,34 +1136,66 @@\n                 name = relID + \"_\" + name;\n             }\n             //defensively do this so that we don't get an exception\n-            //from FilenameUtils.normalize\n+            //from normalize and to prevent null bytes\n             name = name.replaceAll(\"\\u0000\", \" \");\n-            String normalizedName = FilenameUtils.normalize(name);\n-\n-            if (normalizedName == null) {\n-                normalizedName = FilenameUtils.getName(name);\n-            }\n-\n-            if (normalizedName == null) {\n+            \n+            // First, extract only the filename to prevent path traversal attacks\n+            // This removes all directory path components including \"..\" sequences\n+            String normalizedName = org.apache.tika.io.FilenameUtils.getName(name);\n+            \n+            // Then normalize the filename to handle reserved characters\n+            if (normalizedName != null && !normalizedName.isEmpty()) {\n+                normalizedName = org.apache.tika.io.FilenameUtils.normalize(normalizedName);\n+            }\n+\n+            if (normalizedName == null || normalizedName.isEmpty()) {\n                 normalizedName = \"file\" + count++ + ext;\n             }\n-            //strip off initial C:/ or ~/ or /\n-            int prefixLength = FilenameUtils.getPrefixLength(normalizedName);\n-            if (prefixLength > -1) {\n-                normalizedName = normalizedName.substring(prefixLength);\n-            }\n+            \n             try {\n                 normalizedName = URLDecoder.decode(normalizedName, UTF_8);\n             } catch (IllegalArgumentException e) {\n                 LOG.warn(\"couldn't url decode name {}\", normalizedName);\n             }\n+            \n             File outputFile = new File(extractDir, normalizedName);\n+            \n+            // Validate that the output file is within the extract directory\n+            // This prevents path traversal attacks even if getName() has edge cases\n+            try {\n+                File canonicalOutputFile = outputFile.getCanonicalFile();\n+                File canonicalExtractDir = extractDir.getCanonicalFile();\n+                if (!canonicalOutputFile.toPath().normalize().startsWith(canonicalExtractDir.toPath().normalize())) {\n+                    throw new IOException(\"Security violation: attempted path traversal detected. \" +\n+                            \"Output file must be within extract directory. File: \" + normalizedName);\n+                }\n+            } catch (IOException e) {\n+                LOG.error(\"Path traversal validation failed for file: {}\", normalizedName, e);\n+                throw new RuntimeException(\"Security violation: path traversal detected\", e);\n+            }\n+            \n             //if file already exists, prepend uuid\n             if (outputFile.exists()) {\n-                String fileName = FilenameUtils.getName(normalizedName);\n+                String fileName = org.apache.tika.io.FilenameUtils.getName(normalizedName);\n+                if (fileName == null || fileName.isEmpty()) {\n+                    fileName = normalizedName;\n+                }\n                 outputFile = new File(extractDir, UUID\n                         .randomUUID()\n                         .toString() + \"-\" + fileName);\n+                \n+                // Validate the UUID-prefixed file as well\n+                try {\n+                    File canonicalOutputFile = outputFile.getCanonicalFile();\n+                    File canonicalExtractDir = extractDir.getCanonicalFile();\n+                    if (!canonicalOutputFile.toPath().normalize().startsWith(canonicalExtractDir.toPath().normalize())) {\n+                        throw new IOException(\"Security violation: attempted path traversal detected. \" +\n+                                \"Output file must be within extract directory. File: \" + outputFile.getName());\n+                    }\n+                } catch (IOException e) {\n+                    LOG.error(\"Path traversal validation failed for UUID-prefixed file: {}\", outputFile.getName(), e);\n+                    throw new RuntimeException(\"Security violation: path traversal detected\", e);\n+                }\n             }\n             return outputFile;\n         }\n",
  "stdout": "",
  "stderr": ""
}