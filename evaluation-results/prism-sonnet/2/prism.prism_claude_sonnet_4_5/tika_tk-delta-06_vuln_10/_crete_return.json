{
  "project_name": "tika",
  "vulnerability_identifier": "tika_tk-delta-06_vuln_10",
  "source_directory": "/home/qqor/crete/.cache/official-afc-tika",
  "llm_usage": {
    "total_cost": 8.299497,
    "prompt_tokens": 2545919,
    "completion_tokens": 44116
  },
  "variant": "sound",
  "diff": "--- a/tika-core/src/main/java/org/apache/tika/parser/ParseRecord.java\n+++ b/tika-core/src/main/java/org/apache/tika/parser/ParseRecord.java\n@@ -21,6 +21,7 @@\n import java.util.List;\n import java.util.Set;\n \n+import org.apache.tika.exception.TikaException;\n import org.apache.tika.metadata.Metadata;\n \n /**\n@@ -33,6 +34,12 @@\n     //hard limits so that specially crafted files\n     //don't cause an OOM\n     private static int MAX_PARSERS = 100;\n+    \n+    /**\n+     * Maximum recursion depth to prevent infinite recursion in nested archives.\n+     * This limit helps prevent timeout issues from zip bombs or excessively nested structures.\n+     */\n+    public static final int MAX_RECURSION_DEPTH = 20;\n \n     private static final int MAX_EXCEPTIONS = 100;\n \n@@ -51,8 +58,18 @@\n \n     private boolean writeLimitReached = false;\n \n-    void beforeParse() {\n+    /**\n+     * Increments the parse depth counter and validates against the maximum recursion depth.\n+     * \n+     * @throws TikaException if the maximum recursion depth is exceeded\n+     */\n+    void beforeParse() throws TikaException {\n         depth++;\n+        if (depth > MAX_RECURSION_DEPTH) {\n+            throw new TikaException(\"Maximum recursion depth reached: \" + depth + \n+                \" (limit: \" + MAX_RECURSION_DEPTH + \"). \" +\n+                \"This may indicate a zip bomb or excessively nested archive structure.\");\n+        }\n     }\n \n     void afterParse() {\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVConfig.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVConfig.java\n@@ -24,6 +24,13 @@\n \n     private static final Map<Character, String> DELIMITER_TO_NAME_MAP = new HashMap<>();\n     private static final Map<String, Character> NAME_TO_DELIMITER_MAP = new HashMap<>();\n+    \n+    /**\n+     * Maximum length for fraction denominator formats to prevent exponential\n+     * computational complexity in cell formatting. Default is 5 which limits\n+     * nested loop iterations to a manageable level while supporting common use cases.\n+     */\n+    private int maxFractionDenomLength = 5;\n \n     static {\n         DELIMITER_TO_NAME_MAP.put(',', \"comma\");\n@@ -55,4 +62,23 @@\n         nameToDelimiterMap.entrySet()\n                           .forEach(e -> delimiterToNameMap.put(e.getValue(), e.getKey()));\n     }\n+    \n+    /**\n+     * Gets the maximum length for fraction denominator formats.\n+     * \n+     * @return maximum fraction denominator length\n+     */\n+    public int getMaxFractionDenomLength() {\n+        return maxFractionDenomLength;\n+    }\n+    \n+    /**\n+     * Sets the maximum length for fraction denominator formats to prevent\n+     * exponential computational complexity.\n+     * \n+     * @param maxFractionDenomLength maximum fraction denominator length\n+     */\n+    public void setMaxFractionDenomLength(int maxFractionDenomLength) {\n+        this.maxFractionDenomLength = maxFractionDenomLength;\n+    }\n }\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/CellFormatter.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/CellFormatter.java\n@@ -37,6 +37,24 @@\n             \"&fraction_format=\\\"(?:(#{1,20}) )?(#{1,20})/(#{1,20})\\\"\");\n \n     private final Matcher fractionFormatMatcher = FRACTION_FORMAT.matcher(\"\");\n+    private final int maxFractionDenomLength;\n+    \n+    /**\n+     * Creates a CellFormatter with the specified maximum fraction denominator length.\n+     * \n+     * @param maxFractionDenomLength maximum allowed length for fraction denominators\n+     */\n+    CellFormatter(int maxFractionDenomLength) {\n+        this.maxFractionDenomLength = maxFractionDenomLength;\n+    }\n+    \n+    /**\n+     * Creates a CellFormatter with default maximum fraction denominator length of 5.\n+     */\n+    CellFormatter() {\n+        this(5);\n+    }\n+    \n     String format(String cell) {\n         if (cell == null) {\n             cell = \"\";\n@@ -60,6 +78,11 @@\n         double wholePart = Math.floor(Math.abs(val));\n         double decPart = Math.abs(val) - wholePart;\n         int denomLength = denomFormat.length();\n+        \n+        // Prevent exponential computational complexity from large denominator lengths\n+        if (denomLength > maxFractionDenomLength) {\n+            return cell;\n+        }\n \n         double minVal = 1.0;\n         double currDenom = Math.pow(10, denomLength) - 1d;\n\n--- a/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java\n+++ b/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-text-module/src/main/java/org/apache/tika/parser/csv/TextAndCSVParser.java\n@@ -189,7 +189,7 @@\n             xhtmlContentHandler.startDocument();\n             xhtmlContentHandler.startElement(TABLE);\n             int firstRowColCount = 0;\n-            CellFormatter cellFormatter = new CellFormatter();\n+            CellFormatter cellFormatter = new CellFormatter(textAndCSVConfig.getMaxFractionDenomLength());\n             try {\n                 for (CSVRecord row : commonsParser) {\n                     xhtmlContentHandler.startElement(TR);\n@@ -378,5 +378,16 @@\n         }\n         defaultTextAndCSVConfig.setNameToDelimiterMap(m);\n     }\n+    \n+    /**\n+     * Sets the maximum length for fraction denominator formats to prevent\n+     * exponential computational complexity in cell formatting. Default is 5.\n+     * \n+     * @param maxFractionDenomLength maximum fraction denominator length\n+     */\n+    @Field\n+    public void setMaxFractionDenomLength(int maxFractionDenomLength) {\n+        defaultTextAndCSVConfig.setMaxFractionDenomLength(maxFractionDenomLength);\n+    }\n \n }\n",
  "stdout": "",
  "stderr": ""
}