diff --git a/HTMLparser.c b/HTMLparser.c
index 9c34e9e..39849c2 100644
--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -3573,8 +3573,8 @@ next_chunk:
 
         chunkSize = in - chunk;
         extraSize = chunkSize + replSize;
-
-        if (extraSize > buffer_size) {
+        /* Grow buffer to accommodate existing and new data */
+        if (used + extraSize > buffer_size) {
             size_t newSize = (used + extraSize) * 2;
             xmlChar *tmp = (xmlChar *) xmlRealloc(buffer, newSize + 1);
 
@@ -3584,6 +3584,7 @@ next_chunk:
             }
             buffer = tmp;
             buffer_size = newSize;
+            buffer_size = newSize;
         }
 
         if (chunkSize > 0) {
