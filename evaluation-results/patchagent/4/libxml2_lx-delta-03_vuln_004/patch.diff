diff --git a/encoding.c b/encoding.c
index adecdcc..96a74ec 100644
--- a/encoding.c
+++ b/encoding.c
@@ -2846,6 +2846,8 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
     const unsigned char *instart = in;
     const unsigned char *inend = in + (*inlen & ~1);
     unsigned char *outstart = out;
+    /* track output buffer end to prevent overflow */
+    int maxout = *outlen;
     unsigned long int b0, b1, b2, b3, c, d;
     int ret = XML_ENC_ERR_SPACE;
 
@@ -2865,15 +2867,24 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
         c = b0 | b1 | b2 | b3;
 
         if (c < 0x80) {
+            /* need 1 byte */
+            if (out + 1 > outstart + maxout)
+                break;
             out[0] = c;
             in += 4;
             out += 1;
         } else if (c < 0x800) {
+            /* need 2 bytes */
+            if (out + 2 > outstart + maxout)
+                break;
             out[0] = (c >> 6)   | 0xC0;
             out[1] = (c & 0x3F) | 0x80;
             in += 4;
             out += 2;
         } else if ((c & 0xF800) != 0xD800) {
+            /* need 3 bytes */
+            if (out + 3 > outstart + maxout)
+                break;
             out[0] =  (c >> 12)         | 0xE0;
             out[1] = ((c >>  6) & 0x3F) | 0x80;
             out[2] =  (c        & 0x3F) | 0x80;
@@ -2885,6 +2896,10 @@ UTF32ToUTF8(unsigned char *out, int *outlen,
                 ret = XML_ERR_INTERNAL_ERROR;
                 break;
             }
+            /* need 4 bytes */
+            if (out + 4 > outstart + maxout)
+                break;
+            
 	        if (inend - in < 4)
 		        break;
             d = in[2] | (in[3] << 8);
